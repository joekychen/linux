<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › meye.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>meye.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Motion Eye video4linux driver for Sony Vaio PictureBook</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001-2004 Stelian Pop &lt;stelian@popies.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001-2002 Alcôve &lt;www.alcove.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000 Andrew Tridgell &lt;tridge@valinux.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Earlier work by Werner Almesberger, Paul `Rusty&#39; Russell and Paul Mackerras.</span>
<span class="cm"> *</span>
<span class="cm"> * Some parts borrowed from various video4linux drivers, especially</span>
<span class="cm"> * bttv-driver.c and zoran.c, see original files for credits.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="cp">#include &quot;meye.h&quot;</span>
<span class="cp">#include &lt;linux/meye.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Stelian Pop &lt;stelian@popies.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;v4l2 driver for the MotionEye camera&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">MEYE_DRIVER_VERSION</span><span class="p">);</span>

<span class="cm">/* number of grab buffers */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gbuffers</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">gbuffers</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">gbuffers</span><span class="p">,</span> <span class="s">&quot;number of capture buffers, default is 2 (32 max)&quot;</span><span class="p">);</span>

<span class="cm">/* size of a grab buffer */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gbufsize</span> <span class="o">=</span> <span class="n">MEYE_MAX_BUFSIZE</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">gbufsize</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">gbufsize</span><span class="p">,</span> <span class="s">&quot;size of the capture buffers, default is 614400&quot;</span>
		 <span class="s">&quot; (will be rounded up to a page multiple)&quot;</span><span class="p">);</span>

<span class="cm">/* /dev/videoX registration number */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">video_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="s">&quot;video device to register (0=/dev/video0, etc)&quot;</span><span class="p">);</span>

<span class="cm">/* driver structure - only one possible */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">meye</span> <span class="n">meye</span><span class="p">;</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* Memory allocation routines (stolen from bttv-driver.c)                   */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">rvmalloc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adr</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">mem</span> <span class="o">=</span> <span class="n">vmalloc_32</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">adr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SetPageReserved</span><span class="p">(</span><span class="n">vmalloc_to_page</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">adr</span><span class="p">));</span>
			<span class="n">adr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">mem</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rvfree</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">mem</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ClearPageReserved</span><span class="p">(</span><span class="n">vmalloc_to_page</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">adr</span><span class="p">));</span>
			<span class="n">adr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return a page table pointing to N pages of locked memory</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: The meye device expects DMA addresses on 32 bits, we build</span>
<span class="cm"> * a table of 1024 entries = 4 bytes * 1024 = 4096 bytes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ptable_alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable</span><span class="p">));</span>

	<span class="cm">/* give only 32 bit DMA addresses */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_set_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable_toc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">PAGE_SIZE</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dmahandle</span><span class="p">,</span>
						   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable_toc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">mchip_dmahandle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pt</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable_toc</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MCHIP_NB_PAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							  <span class="n">PAGE_SIZE</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">dma</span><span class="p">,</span>
							  <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">pt</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable_toc</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
				<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">PAGE_SIZE</span><span class="p">,</span>
						  <span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dma</span><span class="p">);</span>
				<span class="n">pt</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">PAGE_SIZE</span><span class="p">,</span>
					  <span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable_toc</span><span class="p">,</span>
					  <span class="n">meye</span><span class="p">.</span><span class="n">mchip_dmahandle</span><span class="p">);</span>
			<span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable_toc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">meye</span><span class="p">.</span><span class="n">mchip_dmahandle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dma</span><span class="p">;</span>
		<span class="n">pt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ptable_free</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pt</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable_toc</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MCHIP_NB_PAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">PAGE_SIZE</span><span class="p">,</span>
					  <span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dma</span><span class="p">);</span>
		<span class="n">pt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable_toc</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">PAGE_SIZE</span><span class="p">,</span>
				  <span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable_toc</span><span class="p">,</span>
				  <span class="n">meye</span><span class="p">.</span><span class="n">mchip_dmahandle</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable</span><span class="p">));</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable_toc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">mchip_dmahandle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* copy data from ptable into buf */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ptable_copy</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pt_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable</span><span class="p">[</span><span class="n">start</span><span class="o">++</span><span class="p">],</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">pt_pages</span><span class="p">)</span>
			<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">meye</span><span class="p">.</span><span class="n">mchip_ptable</span><span class="p">[</span><span class="n">start</span><span class="p">],</span> <span class="n">size</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* JPEG tables at different qualities to load into the VRJ chip             */</span>
<span class="cm">/****************************************************************************/</span>

<span class="cm">/* return a set of quantisation tables based on a quality from 1 to 10 */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="o">*</span><span class="nf">jpeg_quantisation_tables</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">quality</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u16</span> <span class="n">jpeg_tables</span><span class="p">[][</span><span class="mi">70</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0xff00</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0xff01</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x3c37</span><span class="p">,</span> <span class="mh">0x3c46</span><span class="p">,</span> <span class="mh">0x5032</span><span class="p">,</span> <span class="mh">0x4146</span><span class="p">,</span> <span class="mh">0x5a46</span><span class="p">,</span>
		<span class="mh">0x5055</span><span class="p">,</span> <span class="mh">0x785f</span><span class="p">,</span> <span class="mh">0x82c8</span><span class="p">,</span> <span class="mh">0x6e78</span><span class="p">,</span> <span class="mh">0x786e</span><span class="p">,</span> <span class="mh">0xaff5</span><span class="p">,</span> <span class="mh">0x91b9</span><span class="p">,</span> <span class="mh">0xffc8</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x5501</span><span class="p">,</span> <span class="mh">0x5a5a</span><span class="p">,</span> <span class="mh">0x6978</span><span class="p">,</span> <span class="mh">0xeb78</span><span class="p">,</span> <span class="mh">0x8282</span><span class="p">,</span> <span class="mh">0xffeb</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x2800</span><span class="p">,</span> <span class="mh">0x1e1c</span><span class="p">,</span> <span class="mh">0x1e23</span><span class="p">,</span> <span class="mh">0x2819</span><span class="p">,</span> <span class="mh">0x2123</span><span class="p">,</span> <span class="mh">0x2d23</span><span class="p">,</span>
		<span class="mh">0x282b</span><span class="p">,</span> <span class="mh">0x3c30</span><span class="p">,</span> <span class="mh">0x4164</span><span class="p">,</span> <span class="mh">0x373c</span><span class="p">,</span> <span class="mh">0x3c37</span><span class="p">,</span> <span class="mh">0x587b</span><span class="p">,</span> <span class="mh">0x495d</span><span class="p">,</span> <span class="mh">0x9164</span><span class="p">,</span>
		<span class="mh">0x9980</span><span class="p">,</span> <span class="mh">0x8f96</span><span class="p">,</span> <span class="mh">0x8c80</span><span class="p">,</span> <span class="mh">0xa08a</span><span class="p">,</span> <span class="mh">0xe6b4</span><span class="p">,</span> <span class="mh">0xa0c3</span><span class="p">,</span> <span class="mh">0xdaaa</span><span class="p">,</span> <span class="mh">0x8aad</span><span class="p">,</span>
		<span class="mh">0xc88c</span><span class="p">,</span> <span class="mh">0xcbff</span><span class="p">,</span> <span class="mh">0xeeda</span><span class="p">,</span> <span class="mh">0xfff5</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xc19b</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xfaff</span><span class="p">,</span>
		<span class="mh">0xe6ff</span><span class="p">,</span> <span class="mh">0xfffd</span><span class="p">,</span> <span class="mh">0xfff8</span><span class="p">,</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x2b01</span><span class="p">,</span> <span class="mh">0x2d2d</span><span class="p">,</span> <span class="mh">0x353c</span><span class="p">,</span> <span class="mh">0x763c</span><span class="p">,</span> <span class="mh">0x4141</span><span class="p">,</span> <span class="mh">0xf876</span><span class="p">,</span>
		<span class="mh">0x8ca5</span><span class="p">,</span> <span class="mh">0xf8a5</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span>
		<span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span>
		<span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span>
		<span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xf8f8</span><span class="p">,</span> <span class="mh">0xfff8</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x1b00</span><span class="p">,</span> <span class="mh">0x1412</span><span class="p">,</span> <span class="mh">0x1417</span><span class="p">,</span> <span class="mh">0x1b11</span><span class="p">,</span> <span class="mh">0x1617</span><span class="p">,</span> <span class="mh">0x1e17</span><span class="p">,</span>
		<span class="mh">0x1b1c</span><span class="p">,</span> <span class="mh">0x2820</span><span class="p">,</span> <span class="mh">0x2b42</span><span class="p">,</span> <span class="mh">0x2528</span><span class="p">,</span> <span class="mh">0x2825</span><span class="p">,</span> <span class="mh">0x3a51</span><span class="p">,</span> <span class="mh">0x303d</span><span class="p">,</span> <span class="mh">0x6042</span><span class="p">,</span>
		<span class="mh">0x6555</span><span class="p">,</span> <span class="mh">0x5f64</span><span class="p">,</span> <span class="mh">0x5d55</span><span class="p">,</span> <span class="mh">0x6a5b</span><span class="p">,</span> <span class="mh">0x9978</span><span class="p">,</span> <span class="mh">0x6a81</span><span class="p">,</span> <span class="mh">0x9071</span><span class="p">,</span> <span class="mh">0x5b73</span><span class="p">,</span>
		<span class="mh">0x855d</span><span class="p">,</span> <span class="mh">0x86b5</span><span class="p">,</span> <span class="mh">0x9e90</span><span class="p">,</span> <span class="mh">0xaba3</span><span class="p">,</span> <span class="mh">0xabad</span><span class="p">,</span> <span class="mh">0x8067</span><span class="p">,</span> <span class="mh">0xc9bc</span><span class="p">,</span> <span class="mh">0xa6ba</span><span class="p">,</span>
		<span class="mh">0x99c7</span><span class="p">,</span> <span class="mh">0xaba8</span><span class="p">,</span> <span class="mh">0xffa4</span><span class="p">,</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x1c01</span><span class="p">,</span> <span class="mh">0x1e1e</span><span class="p">,</span> <span class="mh">0x2328</span><span class="p">,</span> <span class="mh">0x4e28</span><span class="p">,</span> <span class="mh">0x2b2b</span><span class="p">,</span> <span class="mh">0xa44e</span><span class="p">,</span>
		<span class="mh">0x5d6e</span><span class="p">,</span> <span class="mh">0xa46e</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span>
		<span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span>
		<span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span>
		<span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xa4a4</span><span class="p">,</span> <span class="mh">0xffa4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x1400</span><span class="p">,</span> <span class="mh">0x0f0e</span><span class="p">,</span> <span class="mh">0x0f12</span><span class="p">,</span> <span class="mh">0x140d</span><span class="p">,</span> <span class="mh">0x1012</span><span class="p">,</span> <span class="mh">0x1712</span><span class="p">,</span>
		<span class="mh">0x1415</span><span class="p">,</span> <span class="mh">0x1e18</span><span class="p">,</span> <span class="mh">0x2132</span><span class="p">,</span> <span class="mh">0x1c1e</span><span class="p">,</span> <span class="mh">0x1e1c</span><span class="p">,</span> <span class="mh">0x2c3d</span><span class="p">,</span> <span class="mh">0x242e</span><span class="p">,</span> <span class="mh">0x4932</span><span class="p">,</span>
		<span class="mh">0x4c40</span><span class="p">,</span> <span class="mh">0x474b</span><span class="p">,</span> <span class="mh">0x4640</span><span class="p">,</span> <span class="mh">0x5045</span><span class="p">,</span> <span class="mh">0x735a</span><span class="p">,</span> <span class="mh">0x5062</span><span class="p">,</span> <span class="mh">0x6d55</span><span class="p">,</span> <span class="mh">0x4556</span><span class="p">,</span>
		<span class="mh">0x6446</span><span class="p">,</span> <span class="mh">0x6588</span><span class="p">,</span> <span class="mh">0x776d</span><span class="p">,</span> <span class="mh">0x817b</span><span class="p">,</span> <span class="mh">0x8182</span><span class="p">,</span> <span class="mh">0x604e</span><span class="p">,</span> <span class="mh">0x978d</span><span class="p">,</span> <span class="mh">0x7d8c</span><span class="p">,</span>
		<span class="mh">0x7396</span><span class="p">,</span> <span class="mh">0x817e</span><span class="p">,</span> <span class="mh">0xff7c</span><span class="p">,</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x1501</span><span class="p">,</span> <span class="mh">0x1717</span><span class="p">,</span> <span class="mh">0x1a1e</span><span class="p">,</span> <span class="mh">0x3b1e</span><span class="p">,</span> <span class="mh">0x2121</span><span class="p">,</span> <span class="mh">0x7c3b</span><span class="p">,</span>
		<span class="mh">0x4653</span><span class="p">,</span> <span class="mh">0x7c53</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span>
		<span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span>
		<span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span>
		<span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0x7c7c</span><span class="p">,</span> <span class="mh">0xff7c</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x0c0b</span><span class="p">,</span> <span class="mh">0x0c0e</span><span class="p">,</span> <span class="mh">0x100a</span><span class="p">,</span> <span class="mh">0x0d0e</span><span class="p">,</span> <span class="mh">0x120e</span><span class="p">,</span>
		<span class="mh">0x1011</span><span class="p">,</span> <span class="mh">0x1813</span><span class="p">,</span> <span class="mh">0x1a28</span><span class="p">,</span> <span class="mh">0x1618</span><span class="p">,</span> <span class="mh">0x1816</span><span class="p">,</span> <span class="mh">0x2331</span><span class="p">,</span> <span class="mh">0x1d25</span><span class="p">,</span> <span class="mh">0x3a28</span><span class="p">,</span>
		<span class="mh">0x3d33</span><span class="p">,</span> <span class="mh">0x393c</span><span class="p">,</span> <span class="mh">0x3833</span><span class="p">,</span> <span class="mh">0x4037</span><span class="p">,</span> <span class="mh">0x5c48</span><span class="p">,</span> <span class="mh">0x404e</span><span class="p">,</span> <span class="mh">0x5744</span><span class="p">,</span> <span class="mh">0x3745</span><span class="p">,</span>
		<span class="mh">0x5038</span><span class="p">,</span> <span class="mh">0x516d</span><span class="p">,</span> <span class="mh">0x5f57</span><span class="p">,</span> <span class="mh">0x6762</span><span class="p">,</span> <span class="mh">0x6768</span><span class="p">,</span> <span class="mh">0x4d3e</span><span class="p">,</span> <span class="mh">0x7971</span><span class="p">,</span> <span class="mh">0x6470</span><span class="p">,</span>
		<span class="mh">0x5c78</span><span class="p">,</span> <span class="mh">0x6765</span><span class="p">,</span> <span class="mh">0xff63</span><span class="p">,</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x1101</span><span class="p">,</span> <span class="mh">0x1212</span><span class="p">,</span> <span class="mh">0x1518</span><span class="p">,</span> <span class="mh">0x2f18</span><span class="p">,</span> <span class="mh">0x1a1a</span><span class="p">,</span> <span class="mh">0x632f</span><span class="p">,</span>
		<span class="mh">0x3842</span><span class="p">,</span> <span class="mh">0x6342</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span>
		<span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span>
		<span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span>
		<span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0x6363</span><span class="p">,</span> <span class="mh">0xff63</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x0d00</span><span class="p">,</span> <span class="mh">0x0a09</span><span class="p">,</span> <span class="mh">0x0a0b</span><span class="p">,</span> <span class="mh">0x0d08</span><span class="p">,</span> <span class="mh">0x0a0b</span><span class="p">,</span> <span class="mh">0x0e0b</span><span class="p">,</span>
		<span class="mh">0x0d0e</span><span class="p">,</span> <span class="mh">0x130f</span><span class="p">,</span> <span class="mh">0x1520</span><span class="p">,</span> <span class="mh">0x1213</span><span class="p">,</span> <span class="mh">0x1312</span><span class="p">,</span> <span class="mh">0x1c27</span><span class="p">,</span> <span class="mh">0x171e</span><span class="p">,</span> <span class="mh">0x2e20</span><span class="p">,</span>
		<span class="mh">0x3129</span><span class="p">,</span> <span class="mh">0x2e30</span><span class="p">,</span> <span class="mh">0x2d29</span><span class="p">,</span> <span class="mh">0x332c</span><span class="p">,</span> <span class="mh">0x4a3a</span><span class="p">,</span> <span class="mh">0x333e</span><span class="p">,</span> <span class="mh">0x4636</span><span class="p">,</span> <span class="mh">0x2c37</span><span class="p">,</span>
		<span class="mh">0x402d</span><span class="p">,</span> <span class="mh">0x4157</span><span class="p">,</span> <span class="mh">0x4c46</span><span class="p">,</span> <span class="mh">0x524e</span><span class="p">,</span> <span class="mh">0x5253</span><span class="p">,</span> <span class="mh">0x3e32</span><span class="p">,</span> <span class="mh">0x615a</span><span class="p">,</span> <span class="mh">0x505a</span><span class="p">,</span>
		<span class="mh">0x4a60</span><span class="p">,</span> <span class="mh">0x5251</span><span class="p">,</span> <span class="mh">0xff4f</span><span class="p">,</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x0e01</span><span class="p">,</span> <span class="mh">0x0e0e</span><span class="p">,</span> <span class="mh">0x1113</span><span class="p">,</span> <span class="mh">0x2613</span><span class="p">,</span> <span class="mh">0x1515</span><span class="p">,</span> <span class="mh">0x4f26</span><span class="p">,</span>
		<span class="mh">0x2d35</span><span class="p">,</span> <span class="mh">0x4f35</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span>
		<span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span>
		<span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span>
		<span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0x4f4f</span><span class="p">,</span> <span class="mh">0xff4f</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x0a00</span><span class="p">,</span> <span class="mh">0x0707</span><span class="p">,</span> <span class="mh">0x0708</span><span class="p">,</span> <span class="mh">0x0a06</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">,</span> <span class="mh">0x0b08</span><span class="p">,</span>
		<span class="mh">0x0a0a</span><span class="p">,</span> <span class="mh">0x0e0b</span><span class="p">,</span> <span class="mh">0x1018</span><span class="p">,</span> <span class="mh">0x0d0e</span><span class="p">,</span> <span class="mh">0x0e0d</span><span class="p">,</span> <span class="mh">0x151d</span><span class="p">,</span> <span class="mh">0x1116</span><span class="p">,</span> <span class="mh">0x2318</span><span class="p">,</span>
		<span class="mh">0x251f</span><span class="p">,</span> <span class="mh">0x2224</span><span class="p">,</span> <span class="mh">0x221f</span><span class="p">,</span> <span class="mh">0x2621</span><span class="p">,</span> <span class="mh">0x372b</span><span class="p">,</span> <span class="mh">0x262f</span><span class="p">,</span> <span class="mh">0x3429</span><span class="p">,</span> <span class="mh">0x2129</span><span class="p">,</span>
		<span class="mh">0x3022</span><span class="p">,</span> <span class="mh">0x3141</span><span class="p">,</span> <span class="mh">0x3934</span><span class="p">,</span> <span class="mh">0x3e3b</span><span class="p">,</span> <span class="mh">0x3e3e</span><span class="p">,</span> <span class="mh">0x2e25</span><span class="p">,</span> <span class="mh">0x4944</span><span class="p">,</span> <span class="mh">0x3c43</span><span class="p">,</span>
		<span class="mh">0x3748</span><span class="p">,</span> <span class="mh">0x3e3d</span><span class="p">,</span> <span class="mh">0xff3b</span><span class="p">,</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x0a01</span><span class="p">,</span> <span class="mh">0x0b0b</span><span class="p">,</span> <span class="mh">0x0d0e</span><span class="p">,</span> <span class="mh">0x1c0e</span><span class="p">,</span> <span class="mh">0x1010</span><span class="p">,</span> <span class="mh">0x3b1c</span><span class="p">,</span>
		<span class="mh">0x2228</span><span class="p">,</span> <span class="mh">0x3b28</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span>
		<span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span>
		<span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span>
		<span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0x3b3b</span><span class="p">,</span> <span class="mh">0xff3b</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x0600</span><span class="p">,</span> <span class="mh">0x0504</span><span class="p">,</span> <span class="mh">0x0506</span><span class="p">,</span> <span class="mh">0x0604</span><span class="p">,</span> <span class="mh">0x0506</span><span class="p">,</span> <span class="mh">0x0706</span><span class="p">,</span>
		<span class="mh">0x0607</span><span class="p">,</span> <span class="mh">0x0a08</span><span class="p">,</span> <span class="mh">0x0a10</span><span class="p">,</span> <span class="mh">0x090a</span><span class="p">,</span> <span class="mh">0x0a09</span><span class="p">,</span> <span class="mh">0x0e14</span><span class="p">,</span> <span class="mh">0x0c0f</span><span class="p">,</span> <span class="mh">0x1710</span><span class="p">,</span>
		<span class="mh">0x1814</span><span class="p">,</span> <span class="mh">0x1718</span><span class="p">,</span> <span class="mh">0x1614</span><span class="p">,</span> <span class="mh">0x1a16</span><span class="p">,</span> <span class="mh">0x251d</span><span class="p">,</span> <span class="mh">0x1a1f</span><span class="p">,</span> <span class="mh">0x231b</span><span class="p">,</span> <span class="mh">0x161c</span><span class="p">,</span>
		<span class="mh">0x2016</span><span class="p">,</span> <span class="mh">0x202c</span><span class="p">,</span> <span class="mh">0x2623</span><span class="p">,</span> <span class="mh">0x2927</span><span class="p">,</span> <span class="mh">0x292a</span><span class="p">,</span> <span class="mh">0x1f19</span><span class="p">,</span> <span class="mh">0x302d</span><span class="p">,</span> <span class="mh">0x282d</span><span class="p">,</span>
		<span class="mh">0x2530</span><span class="p">,</span> <span class="mh">0x2928</span><span class="p">,</span> <span class="mh">0xff28</span><span class="p">,</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x0701</span><span class="p">,</span> <span class="mh">0x0707</span><span class="p">,</span> <span class="mh">0x080a</span><span class="p">,</span> <span class="mh">0x130a</span><span class="p">,</span> <span class="mh">0x0a0a</span><span class="p">,</span> <span class="mh">0x2813</span><span class="p">,</span>
		<span class="mh">0x161a</span><span class="p">,</span> <span class="mh">0x281a</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span>
		<span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span>
		<span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span>
		<span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0xff28</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x0300</span><span class="p">,</span> <span class="mh">0x0202</span><span class="p">,</span> <span class="mh">0x0203</span><span class="p">,</span> <span class="mh">0x0302</span><span class="p">,</span> <span class="mh">0x0303</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">,</span>
		<span class="mh">0x0303</span><span class="p">,</span> <span class="mh">0x0504</span><span class="p">,</span> <span class="mh">0x0508</span><span class="p">,</span> <span class="mh">0x0405</span><span class="p">,</span> <span class="mh">0x0504</span><span class="p">,</span> <span class="mh">0x070a</span><span class="p">,</span> <span class="mh">0x0607</span><span class="p">,</span> <span class="mh">0x0c08</span><span class="p">,</span>
		<span class="mh">0x0c0a</span><span class="p">,</span> <span class="mh">0x0b0c</span><span class="p">,</span> <span class="mh">0x0b0a</span><span class="p">,</span> <span class="mh">0x0d0b</span><span class="p">,</span> <span class="mh">0x120e</span><span class="p">,</span> <span class="mh">0x0d10</span><span class="p">,</span> <span class="mh">0x110e</span><span class="p">,</span> <span class="mh">0x0b0e</span><span class="p">,</span>
		<span class="mh">0x100b</span><span class="p">,</span> <span class="mh">0x1016</span><span class="p">,</span> <span class="mh">0x1311</span><span class="p">,</span> <span class="mh">0x1514</span><span class="p">,</span> <span class="mh">0x1515</span><span class="p">,</span> <span class="mh">0x0f0c</span><span class="p">,</span> <span class="mh">0x1817</span><span class="p">,</span> <span class="mh">0x1416</span><span class="p">,</span>
		<span class="mh">0x1218</span><span class="p">,</span> <span class="mh">0x1514</span><span class="p">,</span> <span class="mh">0xff14</span><span class="p">,</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x0301</span><span class="p">,</span> <span class="mh">0x0404</span><span class="p">,</span> <span class="mh">0x0405</span><span class="p">,</span> <span class="mh">0x0905</span><span class="p">,</span> <span class="mh">0x0505</span><span class="p">,</span> <span class="mh">0x1409</span><span class="p">,</span>
		<span class="mh">0x0b0d</span><span class="p">,</span> <span class="mh">0x140d</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span>
		<span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span>
		<span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span>
		<span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0x1414</span><span class="p">,</span> <span class="mh">0xff14</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span>
		<span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span>
		<span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span>
		<span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span>
		<span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0xff01</span><span class="p">,</span>
		<span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x4300</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span>
		<span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span>
		<span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span>
		<span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span>
		<span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0xff01</span><span class="p">,</span>
	<span class="p">}</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">quality</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">quality</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;meye: invalid quality level %d - using 8</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">quality</span><span class="p">);</span>
		<span class="n">quality</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">jpeg_tables</span><span class="p">[</span><span class="n">quality</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">jpeg_tables</span><span class="p">[</span><span class="n">quality</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* return a generic set of huffman tables */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="o">*</span><span class="nf">jpeg_huffman_tables</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u16</span> <span class="n">tables</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xC4FF</span><span class="p">,</span> <span class="mh">0xB500</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x0102</span><span class="p">,</span> <span class="mh">0x0303</span><span class="p">,</span> <span class="mh">0x0402</span><span class="p">,</span> <span class="mh">0x0503</span><span class="p">,</span> <span class="mh">0x0405</span><span class="p">,</span>
		<span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x017D</span><span class="p">,</span> <span class="mh">0x0302</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">,</span> <span class="mh">0x0511</span><span class="p">,</span> <span class="mh">0x2112</span><span class="p">,</span> <span class="mh">0x4131</span><span class="p">,</span>
		<span class="mh">0x1306</span><span class="p">,</span> <span class="mh">0x6151</span><span class="p">,</span> <span class="mh">0x2207</span><span class="p">,</span> <span class="mh">0x1471</span><span class="p">,</span> <span class="mh">0x8132</span><span class="p">,</span> <span class="mh">0xA191</span><span class="p">,</span> <span class="mh">0x2308</span><span class="p">,</span> <span class="mh">0xB142</span><span class="p">,</span>
		<span class="mh">0x15C1</span><span class="p">,</span> <span class="mh">0xD152</span><span class="p">,</span> <span class="mh">0x24F0</span><span class="p">,</span> <span class="mh">0x6233</span><span class="p">,</span> <span class="mh">0x8272</span><span class="p">,</span> <span class="mh">0x0A09</span><span class="p">,</span> <span class="mh">0x1716</span><span class="p">,</span> <span class="mh">0x1918</span><span class="p">,</span>
		<span class="mh">0x251A</span><span class="p">,</span> <span class="mh">0x2726</span><span class="p">,</span> <span class="mh">0x2928</span><span class="p">,</span> <span class="mh">0x342A</span><span class="p">,</span> <span class="mh">0x3635</span><span class="p">,</span> <span class="mh">0x3837</span><span class="p">,</span> <span class="mh">0x3A39</span><span class="p">,</span> <span class="mh">0x4443</span><span class="p">,</span>
		<span class="mh">0x4645</span><span class="p">,</span> <span class="mh">0x4847</span><span class="p">,</span> <span class="mh">0x4A49</span><span class="p">,</span> <span class="mh">0x5453</span><span class="p">,</span> <span class="mh">0x5655</span><span class="p">,</span> <span class="mh">0x5857</span><span class="p">,</span> <span class="mh">0x5A59</span><span class="p">,</span> <span class="mh">0x6463</span><span class="p">,</span>
		<span class="mh">0x6665</span><span class="p">,</span> <span class="mh">0x6867</span><span class="p">,</span> <span class="mh">0x6A69</span><span class="p">,</span> <span class="mh">0x7473</span><span class="p">,</span> <span class="mh">0x7675</span><span class="p">,</span> <span class="mh">0x7877</span><span class="p">,</span> <span class="mh">0x7A79</span><span class="p">,</span> <span class="mh">0x8483</span><span class="p">,</span>
		<span class="mh">0x8685</span><span class="p">,</span> <span class="mh">0x8887</span><span class="p">,</span> <span class="mh">0x8A89</span><span class="p">,</span> <span class="mh">0x9392</span><span class="p">,</span> <span class="mh">0x9594</span><span class="p">,</span> <span class="mh">0x9796</span><span class="p">,</span> <span class="mh">0x9998</span><span class="p">,</span> <span class="mh">0xA29A</span><span class="p">,</span>
		<span class="mh">0xA4A3</span><span class="p">,</span> <span class="mh">0xA6A5</span><span class="p">,</span> <span class="mh">0xA8A7</span><span class="p">,</span> <span class="mh">0xAAA9</span><span class="p">,</span> <span class="mh">0xB3B2</span><span class="p">,</span> <span class="mh">0xB5B4</span><span class="p">,</span> <span class="mh">0xB7B6</span><span class="p">,</span> <span class="mh">0xB9B8</span><span class="p">,</span>
		<span class="mh">0xC2BA</span><span class="p">,</span> <span class="mh">0xC4C3</span><span class="p">,</span> <span class="mh">0xC6C5</span><span class="p">,</span> <span class="mh">0xC8C7</span><span class="p">,</span> <span class="mh">0xCAC9</span><span class="p">,</span> <span class="mh">0xD3D2</span><span class="p">,</span> <span class="mh">0xD5D4</span><span class="p">,</span> <span class="mh">0xD7D6</span><span class="p">,</span>
		<span class="mh">0xD9D8</span><span class="p">,</span> <span class="mh">0xE1DA</span><span class="p">,</span> <span class="mh">0xE3E2</span><span class="p">,</span> <span class="mh">0xE5E4</span><span class="p">,</span> <span class="mh">0xE7E6</span><span class="p">,</span> <span class="mh">0xE9E8</span><span class="p">,</span> <span class="mh">0xF1EA</span><span class="p">,</span> <span class="mh">0xF3F2</span><span class="p">,</span>
		<span class="mh">0xF5F4</span><span class="p">,</span> <span class="mh">0xF7F6</span><span class="p">,</span> <span class="mh">0xF9F8</span><span class="p">,</span> <span class="mh">0xFFFA</span><span class="p">,</span>
		<span class="mh">0xC4FF</span><span class="p">,</span> <span class="mh">0xB500</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0102</span><span class="p">,</span> <span class="mh">0x0402</span><span class="p">,</span> <span class="mh">0x0304</span><span class="p">,</span> <span class="mh">0x0704</span><span class="p">,</span> <span class="mh">0x0405</span><span class="p">,</span>
		<span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0201</span><span class="p">,</span> <span class="mh">0x0077</span><span class="p">,</span> <span class="mh">0x0201</span><span class="p">,</span> <span class="mh">0x1103</span><span class="p">,</span> <span class="mh">0x0504</span><span class="p">,</span> <span class="mh">0x3121</span><span class="p">,</span> <span class="mh">0x1206</span><span class="p">,</span>
		<span class="mh">0x5141</span><span class="p">,</span> <span class="mh">0x6107</span><span class="p">,</span> <span class="mh">0x1371</span><span class="p">,</span> <span class="mh">0x3222</span><span class="p">,</span> <span class="mh">0x0881</span><span class="p">,</span> <span class="mh">0x4214</span><span class="p">,</span> <span class="mh">0xA191</span><span class="p">,</span> <span class="mh">0xC1B1</span><span class="p">,</span>
		<span class="mh">0x2309</span><span class="p">,</span> <span class="mh">0x5233</span><span class="p">,</span> <span class="mh">0x15F0</span><span class="p">,</span> <span class="mh">0x7262</span><span class="p">,</span> <span class="mh">0x0AD1</span><span class="p">,</span> <span class="mh">0x2416</span><span class="p">,</span> <span class="mh">0xE134</span><span class="p">,</span> <span class="mh">0xF125</span><span class="p">,</span>
		<span class="mh">0x1817</span><span class="p">,</span> <span class="mh">0x1A19</span><span class="p">,</span> <span class="mh">0x2726</span><span class="p">,</span> <span class="mh">0x2928</span><span class="p">,</span> <span class="mh">0x352A</span><span class="p">,</span> <span class="mh">0x3736</span><span class="p">,</span> <span class="mh">0x3938</span><span class="p">,</span> <span class="mh">0x433A</span><span class="p">,</span>
		<span class="mh">0x4544</span><span class="p">,</span> <span class="mh">0x4746</span><span class="p">,</span> <span class="mh">0x4948</span><span class="p">,</span> <span class="mh">0x534A</span><span class="p">,</span> <span class="mh">0x5554</span><span class="p">,</span> <span class="mh">0x5756</span><span class="p">,</span> <span class="mh">0x5958</span><span class="p">,</span> <span class="mh">0x635A</span><span class="p">,</span>
		<span class="mh">0x6564</span><span class="p">,</span> <span class="mh">0x6766</span><span class="p">,</span> <span class="mh">0x6968</span><span class="p">,</span> <span class="mh">0x736A</span><span class="p">,</span> <span class="mh">0x7574</span><span class="p">,</span> <span class="mh">0x7776</span><span class="p">,</span> <span class="mh">0x7978</span><span class="p">,</span> <span class="mh">0x827A</span><span class="p">,</span>
		<span class="mh">0x8483</span><span class="p">,</span> <span class="mh">0x8685</span><span class="p">,</span> <span class="mh">0x8887</span><span class="p">,</span> <span class="mh">0x8A89</span><span class="p">,</span> <span class="mh">0x9392</span><span class="p">,</span> <span class="mh">0x9594</span><span class="p">,</span> <span class="mh">0x9796</span><span class="p">,</span> <span class="mh">0x9998</span><span class="p">,</span>
		<span class="mh">0xA29A</span><span class="p">,</span> <span class="mh">0xA4A3</span><span class="p">,</span> <span class="mh">0xA6A5</span><span class="p">,</span> <span class="mh">0xA8A7</span><span class="p">,</span> <span class="mh">0xAAA9</span><span class="p">,</span> <span class="mh">0xB3B2</span><span class="p">,</span> <span class="mh">0xB5B4</span><span class="p">,</span> <span class="mh">0xB7B6</span><span class="p">,</span>
		<span class="mh">0xB9B8</span><span class="p">,</span> <span class="mh">0xC2BA</span><span class="p">,</span> <span class="mh">0xC4C3</span><span class="p">,</span> <span class="mh">0xC6C5</span><span class="p">,</span> <span class="mh">0xC8C7</span><span class="p">,</span> <span class="mh">0xCAC9</span><span class="p">,</span> <span class="mh">0xD3D2</span><span class="p">,</span> <span class="mh">0xD5D4</span><span class="p">,</span>
		<span class="mh">0xD7D6</span><span class="p">,</span> <span class="mh">0xD9D8</span><span class="p">,</span> <span class="mh">0xE2DA</span><span class="p">,</span> <span class="mh">0xE4E3</span><span class="p">,</span> <span class="mh">0xE6E5</span><span class="p">,</span> <span class="mh">0xE8E7</span><span class="p">,</span> <span class="mh">0xEAE9</span><span class="p">,</span> <span class="mh">0xF3F2</span><span class="p">,</span>
		<span class="mh">0xF5F4</span><span class="p">,</span> <span class="mh">0xF7F6</span><span class="p">,</span> <span class="mh">0xF9F8</span><span class="p">,</span> <span class="mh">0xFFFA</span><span class="p">,</span>
		<span class="mh">0xC4FF</span><span class="p">,</span> <span class="mh">0x1F00</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0501</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
		<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0201</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">,</span> <span class="mh">0x0605</span><span class="p">,</span> <span class="mh">0x0807</span><span class="p">,</span> <span class="mh">0x0A09</span><span class="p">,</span>
		<span class="mh">0xFF0B</span><span class="p">,</span>
		<span class="mh">0xC4FF</span><span class="p">,</span> <span class="mh">0x1F00</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0103</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span>
		<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0201</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">,</span> <span class="mh">0x0605</span><span class="p">,</span> <span class="mh">0x0807</span><span class="p">,</span> <span class="mh">0x0A09</span><span class="p">,</span>
		<span class="mh">0xFF0B</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tables</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tables</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* MCHIP low-level functions                                                */</span>
<span class="cm">/****************************************************************************/</span>

<span class="cm">/* returns the horizontal capture size */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mchip_hsize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">subsample</span> <span class="o">?</span> <span class="mi">320</span> <span class="o">:</span> <span class="mi">640</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns the vertical capture size */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mchip_vsize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">subsample</span> <span class="o">?</span> <span class="mi">240</span> <span class="o">:</span> <span class="mi">480</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* waits for a register to be available */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_sync</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">MCHIP_MM_FIFO_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MCHIP_REG_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_mmregs</span> <span class="o">+</span>
				       <span class="n">MCHIP_MM_FIFO_STATUS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MCHIP_MM_FIFO_WAIT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;meye: fifo not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MCHIP_MM_FIFO_READY</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">?</span> <span class="n">MCHIP_HIC_STATUS_MCC_RDY</span>
					 <span class="o">:</span> <span class="n">MCHIP_HIC_STATUS_VRJ_RDY</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MCHIP_REG_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_mmregs</span> <span class="o">+</span> <span class="n">MCHIP_HIC_STATUS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
	       <span class="s">&quot;meye: mchip_sync() timeout on reg 0x%x status=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">reg</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sets a value into the register */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mchip_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mchip_sync</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">meye</span><span class="p">.</span><span class="n">mchip_mmregs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* get the register value */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">mchip_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mchip_sync</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_mmregs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* wait for a register to become a particular value */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mchip_delay</span><span class="p">(</span><span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="n">mchip_read</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* setup subsampling */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_subsample</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MCC_R_SAMPLING</span><span class="p">,</span> <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">subsample</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MCC_R_XRANGE</span><span class="p">,</span> <span class="n">mchip_hsize</span><span class="p">());</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MCC_R_YRANGE</span><span class="p">,</span> <span class="n">mchip_vsize</span><span class="p">());</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MCC_B_XRANGE</span><span class="p">,</span> <span class="n">mchip_hsize</span><span class="p">());</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MCC_B_YRANGE</span><span class="p">,</span> <span class="n">mchip_vsize</span><span class="p">());</span>
	<span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_STATUS</span><span class="p">,</span> <span class="n">MCHIP_HIC_STATUS_IDLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* set the framerate into the mchip */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_set_framerate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_HIC_S_RATE</span><span class="p">,</span> <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">framerate</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* load some huffman and quantisation tables into the VRJ chip ready</span>
<span class="cm">   for JPEG compression */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_load_tables</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">tables</span><span class="p">;</span>

	<span class="n">tables</span> <span class="o">=</span> <span class="n">jpeg_huffman_tables</span><span class="p">(</span><span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">meye</span><span class="p">.</span><span class="n">mchip_mmregs</span> <span class="o">+</span> <span class="n">MCHIP_VRJ_TABLE_DATA</span><span class="p">);</span>

	<span class="n">tables</span> <span class="o">=</span> <span class="n">jpeg_quantisation_tables</span><span class="p">(</span><span class="o">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">quality</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">meye</span><span class="p">.</span><span class="n">mchip_mmregs</span> <span class="o">+</span> <span class="n">MCHIP_VRJ_TABLE_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* setup the VRJ parameters in the chip */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_vrj_setup</span><span class="p">(</span><span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_BUS_MODE</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_SIGNAL_ACTIVE_LEVEL</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_PDAT_USE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_IRQ_FLAG</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_MODE_SPECIFY</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_NUM_LINES</span><span class="p">,</span> <span class="n">mchip_vsize</span><span class="p">());</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_NUM_PIXELS</span><span class="p">,</span> <span class="n">mchip_hsize</span><span class="p">());</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_NUM_COMPONENTS</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_LIMIT_COMPRESSED_LO</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_LIMIT_COMPRESSED_HI</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_COMP_DATA_FORMAT</span><span class="p">,</span> <span class="mh">0xC</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_RESTART_INTERVAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_SOF1</span><span class="p">,</span> <span class="mh">0x601</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_SOF2</span><span class="p">,</span> <span class="mh">0x1502</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_SOF3</span><span class="p">,</span> <span class="mh">0x1503</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_SOF4</span><span class="p">,</span> <span class="mh">0x1596</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_SOS</span><span class="p">,</span> <span class="mh">0x0ed0</span><span class="p">);</span>

	<span class="n">mchip_load_tables</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* sets the DMA parameters into the chip */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_dma_setup</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MM_PT_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MM_FIR</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">mchip_fnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* setup for DMA transfers - also zeros the framebuffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mchip_dma_alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dmahandle</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptable_alloc</span><span class="p">())</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* frees the DMA buffer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_dma_free</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dmahandle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mchip_dma_setup</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ptable_free</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* stop any existing HIC action and wait for any dma to complete then</span>
<span class="cm">   reset the dma engine */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_hic_stop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">meye</span><span class="p">.</span><span class="n">mchip_mode</span> <span class="o">=</span> <span class="n">MCHIP_HIC_MODE_NOOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mchip_read</span><span class="p">(</span><span class="n">MCHIP_HIC_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MCHIP_HIC_STATUS_BUSY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="n">MCHIP_HIC_CMD_STOP</span><span class="p">);</span>
		<span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_STATUS</span><span class="p">,</span>
					<span class="n">MCHIP_HIC_STATUS_IDLE</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;meye: need to reset HIC!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_HIC_CTL</span><span class="p">,</span> <span class="n">MCHIP_HIC_CTL_SOFT_RESET</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;meye: resetting HIC hanged!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* MCHIP frame processing functions                                         */</span>
<span class="cm">/****************************************************************************/</span>

<span class="cm">/* get the next ready frame from the dma engine */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">mchip_get_frame</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">mchip_read</span><span class="p">(</span><span class="n">MCHIP_MM_FIR</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_fnum</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* frees the current frame from the dma engine */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_free_frame</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MM_FIR</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_fnum</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">mchip_fnum</span><span class="o">++</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">mchip_fnum</span> <span class="o">%=</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* read one frame from the framebuffer assuming it was captured using</span>
<span class="cm">   a uncompressed transfer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_cont_read_frame</span><span class="p">(</span><span class="n">u32</span> <span class="n">v</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pt_id</span><span class="p">;</span>

	<span class="n">pt_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>

	<span class="n">ptable_copy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pt_id</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">MCHIP_NB_PAGES</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* read a compressed frame from the framebuffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mchip_comp_read_frame</span><span class="p">(</span><span class="n">u32</span> <span class="n">v</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pt_start</span><span class="p">,</span> <span class="n">pt_end</span><span class="p">,</span> <span class="n">trailer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">pt_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">trailer</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pt_end</span> <span class="o">&lt;</span> <span class="n">pt_start</span><span class="p">)</span>
		<span class="n">fsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCHIP_NB_PAGES_MJPEG</span> <span class="o">-</span> <span class="n">pt_start</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span>
			<span class="n">pt_end</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="n">trailer</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt_end</span> <span class="o">-</span> <span class="n">pt_start</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="n">trailer</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsize</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;meye: oversized compressed frame %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fsize</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ptable_copy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pt_start</span><span class="p">,</span> <span class="n">fsize</span><span class="p">,</span> <span class="n">MCHIP_NB_PAGES_MJPEG</span><span class="p">);</span>

<span class="cp">#ifdef MEYE_JPEG_CORRECTION</span>

	<span class="cm">/* Some mchip generated jpeg frames are incorrect. In most</span>
<span class="cm">	 * (all ?) of those cases, the final EOI (0xff 0xd9) marker</span>
<span class="cm">	 * is not present at the end of the frame.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Since adding the final marker is not enough to restore</span>
<span class="cm">	 * the jpeg integrity, we drop the frame.</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">fsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xd9</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">fsize</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* take a picture into SDRAM */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_take_picture</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mchip_hic_stop</span><span class="p">();</span>
	<span class="n">mchip_subsample</span><span class="p">();</span>
	<span class="n">mchip_dma_setup</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dmahandle</span><span class="p">);</span>

	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_HIC_MODE</span><span class="p">,</span> <span class="n">MCHIP_HIC_MODE_STILL_CAP</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="n">MCHIP_HIC_CMD_START</span><span class="p">);</span>

	<span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_STATUS</span><span class="p">,</span> <span class="n">MCHIP_HIC_STATUS_IDLE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* dma a previously taken picture into a buffer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_get_picture</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_HIC_MODE</span><span class="p">,</span> <span class="n">MCHIP_HIC_MODE_STILL_OUT</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="n">MCHIP_HIC_CMD_START</span><span class="p">);</span>

	<span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_STATUS</span><span class="p">,</span> <span class="n">MCHIP_HIC_STATUS_IDLE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">mchip_get_frame</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">MCHIP_MM_FIR_RDY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mchip_cont_read_frame</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mchip_free_frame</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* start continuous dma capture */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_continuous_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mchip_hic_stop</span><span class="p">();</span>
	<span class="n">mchip_subsample</span><span class="p">();</span>
	<span class="n">mchip_set_framerate</span><span class="p">();</span>
	<span class="n">mchip_dma_setup</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dmahandle</span><span class="p">);</span>

	<span class="n">meye</span><span class="p">.</span><span class="n">mchip_mode</span> <span class="o">=</span> <span class="n">MCHIP_HIC_MODE_CONT_OUT</span><span class="p">;</span>

	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_HIC_MODE</span><span class="p">,</span> <span class="n">MCHIP_HIC_MODE_CONT_OUT</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="n">MCHIP_HIC_CMD_START</span><span class="p">);</span>

	<span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* compress one frame into a buffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mchip_compress_frame</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mchip_vrj_setup</span><span class="p">(</span><span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_HIC_MODE</span><span class="p">,</span> <span class="n">MCHIP_HIC_MODE_STILL_COMP</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="n">MCHIP_HIC_CMD_START</span><span class="p">);</span>

	<span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_STATUS</span><span class="p">,</span> <span class="n">MCHIP_HIC_STATUS_IDLE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">mchip_get_frame</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">MCHIP_MM_FIR_RDY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">mchip_comp_read_frame</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mchip_free_frame</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* uncompress one image into a buffer */</span>
<span class="c">static int mchip_uncompress_frame(u8 *img, int imgsize, u8 *buf, int bufsize)</span>
<span class="c">{</span>
<span class="c">	mchip_vrj_setup(0x3f);</span>
<span class="c">	udelay(50);</span>

<span class="c">	mchip_set(MCHIP_HIC_MODE, MCHIP_HIC_MODE_STILL_DECOMP);</span>
<span class="c">	mchip_set(MCHIP_HIC_CMD, MCHIP_HIC_CMD_START);</span>

<span class="c">	mchip_delay(MCHIP_HIC_CMD, 0);</span>

<span class="c">	return mchip_comp_read_frame(buf, bufsize);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* start continuous compressed capture */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mchip_cont_compression_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mchip_hic_stop</span><span class="p">();</span>
	<span class="n">mchip_vrj_setup</span><span class="p">(</span><span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">mchip_subsample</span><span class="p">();</span>
	<span class="n">mchip_set_framerate</span><span class="p">();</span>
	<span class="n">mchip_dma_setup</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dmahandle</span><span class="p">);</span>

	<span class="n">meye</span><span class="p">.</span><span class="n">mchip_mode</span> <span class="o">=</span> <span class="n">MCHIP_HIC_MODE_CONT_COMP</span><span class="p">;</span>

	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_HIC_MODE</span><span class="p">,</span> <span class="n">MCHIP_HIC_MODE_CONT_COMP</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="n">MCHIP_HIC_CMD_START</span><span class="p">);</span>

	<span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* Interrupt handling                                                       */</span>
<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">meye_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reqnr</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">sequence</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">mchip_read</span><span class="p">(</span><span class="n">MCHIP_MM_INTA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_mode</span> <span class="o">!=</span> <span class="n">MCHIP_HIC_MODE_CONT_OUT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">meye</span><span class="p">.</span><span class="n">mchip_mode</span> <span class="o">!=</span> <span class="n">MCHIP_HIC_MODE_CONT_COMP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

<span class="nl">again:</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">mchip_get_frame</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">MCHIP_MM_FIR_RDY</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_mode</span> <span class="o">==</span> <span class="n">MCHIP_HIC_MODE_CONT_OUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_out_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reqnr</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq_lock</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mchip_free_frame</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mchip_cont_read_frame</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span> <span class="o">+</span> <span class="n">gbufsize</span> <span class="o">*</span> <span class="n">reqnr</span><span class="p">,</span>
				      <span class="n">mchip_hsize</span><span class="p">()</span> <span class="o">*</span> <span class="n">mchip_vsize</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">reqnr</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">mchip_hsize</span><span class="p">()</span> <span class="o">*</span> <span class="n">mchip_vsize</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">reqnr</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">MEYE_BUF_DONE</span><span class="p">;</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">reqnr</span><span class="p">].</span><span class="n">timestamp</span><span class="p">);</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">reqnr</span><span class="p">].</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">++</span><span class="p">;</span>
		<span class="n">kfifo_in_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reqnr</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq_lock</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">proc_list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">mchip_comp_read_frame</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">meye</span><span class="p">.</span><span class="n">grab_temp</span><span class="p">,</span> <span class="n">gbufsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mchip_free_frame</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_out_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reqnr</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq_lock</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mchip_free_frame</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span> <span class="o">+</span> <span class="n">gbufsize</span> <span class="o">*</span> <span class="n">reqnr</span><span class="p">,</span> <span class="n">meye</span><span class="p">.</span><span class="n">grab_temp</span><span class="p">,</span>
		       <span class="n">size</span><span class="p">);</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">reqnr</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">reqnr</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">MEYE_BUF_DONE</span><span class="p">;</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">reqnr</span><span class="p">].</span><span class="n">timestamp</span><span class="p">);</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">reqnr</span><span class="p">].</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">++</span><span class="p">;</span>
		<span class="n">kfifo_in_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reqnr</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq_lock</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">proc_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mchip_free_frame</span><span class="p">();</span>
	<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* video4linux integration                                                  */</span>
<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meye_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">in_use</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mchip_hic_stop</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mchip_dma_alloc</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;meye: mchip framebuffer allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">in_use</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MEYE_MAX_BUFNBRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">MEYE_BUF_UNUSED</span><span class="p">;</span>
	<span class="n">kfifo_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq</span><span class="p">);</span>
	<span class="n">kfifo_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meye_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mchip_hic_stop</span><span class="p">();</span>
	<span class="n">mchip_dma_free</span><span class="p">();</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">in_use</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meyeioc_g_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">meye_params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meyeioc_s_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">meye_params</span> <span class="o">*</span><span class="n">jp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jp</span><span class="o">-&gt;</span><span class="n">subsample</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jp</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jp</span><span class="o">-&gt;</span><span class="n">sharpness</span> <span class="o">&gt;</span> <span class="mi">63</span> <span class="o">||</span> <span class="n">jp</span><span class="o">-&gt;</span><span class="n">agc</span> <span class="o">&gt;</span> <span class="mi">63</span> <span class="o">||</span> <span class="n">jp</span><span class="o">-&gt;</span><span class="n">picture</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jp</span><span class="o">-&gt;</span><span class="n">framerate</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">subsample</span> <span class="o">!=</span> <span class="n">jp</span><span class="o">-&gt;</span><span class="n">subsample</span> <span class="o">||</span>
	    <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">quality</span> <span class="o">!=</span> <span class="n">jp</span><span class="o">-&gt;</span><span class="n">quality</span><span class="p">)</span>
		<span class="n">mchip_hic_stop</span><span class="p">();</span>	<span class="cm">/* need restart */</span>

	<span class="n">meye</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="o">*</span><span class="n">jp</span><span class="p">;</span>
	<span class="n">sony_pic_camera_command</span><span class="p">(</span><span class="n">SONY_PIC_COMMAND_SETCAMERASHARPNESS</span><span class="p">,</span>
			      <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">sharpness</span><span class="p">);</span>
	<span class="n">sony_pic_camera_command</span><span class="p">(</span><span class="n">SONY_PIC_COMMAND_SETCAMERAAGC</span><span class="p">,</span>
			      <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">agc</span><span class="p">);</span>
	<span class="n">sony_pic_camera_command</span><span class="p">(</span><span class="n">SONY_PIC_COMMAND_SETCAMERAPICTURE</span><span class="p">,</span>
			      <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">picture</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meyeioc_qbuf_capt</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nb</span> <span class="o">&gt;=</span> <span class="n">gbuffers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nb</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* stop capture */</span>
		<span class="n">mchip_hic_stop</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="o">*</span><span class="n">nb</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">MEYE_BUF_UNUSED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_mode</span> <span class="o">!=</span> <span class="n">MCHIP_HIC_MODE_CONT_COMP</span><span class="p">)</span>
		<span class="n">mchip_cont_compression_start</span><span class="p">();</span>

	<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="o">*</span><span class="n">nb</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">MEYE_BUF_USING</span><span class="p">;</span>
	<span class="n">kfifo_in_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">nb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
			 <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meyeioc_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">unused</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">gbuffers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="o">*</span><span class="n">i</span><span class="p">].</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">MEYE_BUF_UNUSED</span>:
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEYE_BUF_USING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">proc_list</span><span class="p">,</span>
			<span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="o">*</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">MEYE_BUF_USING</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">MEYE_BUF_DONE</span>:
		<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="o">*</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">MEYE_BUF_UNUSED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_out_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unused</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq_lock</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="o">*</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meyeioc_stillcapt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">MEYE_BUF_UNUSED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">MEYE_BUF_USING</span><span class="p">;</span>
	<span class="n">mchip_take_picture</span><span class="p">();</span>

	<span class="n">mchip_get_picture</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span><span class="p">,</span>
			<span class="n">mchip_hsize</span><span class="p">()</span> <span class="o">*</span> <span class="n">mchip_vsize</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">MEYE_BUF_DONE</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meyeioc_stilljcapt</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">MEYE_BUF_UNUSED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">MEYE_BUF_USING</span><span class="p">;</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mchip_take_picture</span><span class="p">();</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">mchip_compress_frame</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span><span class="p">,</span> <span class="n">gbufsize</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">MEYE_BUF_DONE</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;meye&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;meye&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;PCI:%s&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">));</span>

	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">MEYE_DRIVER_MAJORVERSION</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
		       <span class="n">MEYE_DRIVER_MINORVERSION</span><span class="p">;</span>

	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span>
			    <span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Camera&quot;</span><span class="p">);</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Brightness&quot;</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Hue&quot;</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Contrast&quot;</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Saturation&quot;</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AGC</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Agc&quot;</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MEYE_SHARPNESS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_SHARPNESS</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Sharpness&quot;</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

		<span class="cm">/* Continue to report legacy private SHARPNESS ctrl but</span>
<span class="cm">		 * say it is disabled in preference to ctrl in the spec</span>
<span class="cm">		 */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">V4L2_CID_SHARPNESS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
						<span class="n">V4L2_CTRL_FLAG_DISABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PICTURE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Picture&quot;</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_JPEGQUAL</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;JPEG quality&quot;</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FRAMERATE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Framerate&quot;</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">sony_pic_camera_command</span><span class="p">(</span>
			<span class="n">SONY_PIC_COMMAND_SETCAMERABRIGHTNESS</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">sony_pic_camera_command</span><span class="p">(</span>
			<span class="n">SONY_PIC_COMMAND_SETCAMERAHUE</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">hue</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">sony_pic_camera_command</span><span class="p">(</span>
			<span class="n">SONY_PIC_COMMAND_SETCAMERACONTRAST</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">contrast</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">sony_pic_camera_command</span><span class="p">(</span>
			<span class="n">SONY_PIC_COMMAND_SETCAMERACOLOR</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">colour</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AGC</span>:
		<span class="n">sony_pic_camera_command</span><span class="p">(</span>
			<span class="n">SONY_PIC_COMMAND_SETCAMERAAGC</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">agc</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SHARPNESS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MEYE_SHARPNESS</span>:
		<span class="n">sony_pic_camera_command</span><span class="p">(</span>
			<span class="n">SONY_PIC_COMMAND_SETCAMERASHARPNESS</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">sharpness</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PICTURE</span>:
		<span class="n">sony_pic_camera_command</span><span class="p">(</span>
			<span class="n">SONY_PIC_COMMAND_SETCAMERAPICTURE</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">picture</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_JPEGQUAL</span>:
		<span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">quality</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FRAMERATE</span>:
		<span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">framerate</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">brightness</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">hue</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">contrast</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">colour</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AGC</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">agc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SHARPNESS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MEYE_SHARPNESS</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">sharpness</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PICTURE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">picture</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_JPEGQUAL</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">quality</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FRAMERATE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">framerate</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* standard YUV 422 capture */</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="s">&quot;YUV422&quot;</span><span class="p">);</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* compressed MJPEG capture */</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_FMT_FLAG_COMPRESSED</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="s">&quot;MJPEG&quot;</span><span class="p">);</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_YUYV</span> <span class="o">&amp;&amp;</span>
	    <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">!=</span> <span class="n">V4L2_FIELD_ANY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">!=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">320</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span>
			       <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MCHIP_HIC_MODE_CONT_OUT</span>:
	<span class="nl">default:</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHIP_HIC_MODE_CONT_COMP</span>:
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">mchip_hsize</span><span class="p">();</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">mchip_vsize</span><span class="p">();</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span>
			       <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_YUYV</span> <span class="o">&amp;&amp;</span>
	    <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">!=</span> <span class="n">V4L2_FIELD_ANY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">!=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">320</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">subsample</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">subsample</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_YUYV</span>:
		<span class="n">meye</span><span class="p">.</span><span class="n">mchip_mode</span> <span class="o">=</span> <span class="n">MCHIP_HIC_MODE_CONT_OUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_MJPEG</span>:
		<span class="n">meye</span><span class="p">.</span><span class="n">mchip_mode</span> <span class="o">=</span> <span class="n">MCHIP_HIC_MODE_CONT_COMP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span>
			       <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="n">gbuffers</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* already allocated, no modifications */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gbuffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">vma_use_count</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">rvfree</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span><span class="p">,</span> <span class="n">gbuffers</span> <span class="o">*</span> <span class="n">gbufsize</span><span class="p">);</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gbuffers</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">MEYE_MAX_BUFNBRS</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">gbuffers</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span> <span class="o">=</span> <span class="n">rvmalloc</span><span class="p">(</span><span class="n">gbuffers</span> <span class="o">*</span> <span class="n">gbufsize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;meye: v4l framebuffer allocation&quot;</span>
				<span class="s">&quot; failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gbuffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">vma_use_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">gbuffers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_BUF_FLAG_MAPPED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">MEYE_BUF_USING</span><span class="p">)</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_QUEUED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">MEYE_BUF_DONE</span><span class="p">)</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">;</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">timestamp</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">sequence</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">index</span> <span class="o">*</span> <span class="n">gbufsize</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">gbufsize</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">gbuffers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">MEYE_BUF_UNUSED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_QUEUED</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">MEYE_BUF_USING</span><span class="p">;</span>
	<span class="n">kfifo_in_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reqnr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">proc_list</span><span class="p">,</span>
				     <span class="n">kfifo_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kfifo_out_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reqnr</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">reqnr</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">MEYE_BUF_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">reqnr</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">reqnr</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_BUF_FLAG_MAPPED</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">reqnr</span><span class="p">].</span><span class="n">timestamp</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">reqnr</span><span class="p">].</span><span class="n">sequence</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">reqnr</span> <span class="o">*</span> <span class="n">gbufsize</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">gbufsize</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">reqnr</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">MEYE_BUF_UNUSED</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MCHIP_HIC_MODE_CONT_OUT</span>:
		<span class="n">mchip_continuous_start</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHIP_HIC_MODE_CONT_COMP</span>:
		<span class="n">mchip_cont_compression_start</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mchip_hic_stop</span><span class="p">();</span>
	<span class="n">kfifo_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq</span><span class="p">);</span>
	<span class="n">kfifo_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MEYE_MAX_BUFNBRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">grab_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">MEYE_BUF_UNUSED</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">vidioc_default</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="n">bool</span> <span class="n">valid_prio</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MEYEIOC_G_PARAMS</span>:
		<span class="k">return</span> <span class="n">meyeioc_g_params</span><span class="p">((</span><span class="k">struct</span> <span class="n">meye_params</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">MEYEIOC_S_PARAMS</span>:
		<span class="k">return</span> <span class="n">meyeioc_s_params</span><span class="p">((</span><span class="k">struct</span> <span class="n">meye_params</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">MEYEIOC_QBUF_CAPT</span>:
		<span class="k">return</span> <span class="n">meyeioc_qbuf_capt</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">MEYEIOC_SYNC</span>:
		<span class="k">return</span> <span class="n">meyeioc_sync</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">MEYEIOC_STILLCAPT</span>:
		<span class="k">return</span> <span class="n">meyeioc_stillcapt</span><span class="p">();</span>

	<span class="k">case</span> <span class="n">MEYEIOC_STILLJCAPT</span>:
		<span class="k">return</span> <span class="n">meyeioc_stilljcapt</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">meye_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">proc_list</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq</span><span class="p">))</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">meye_vm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">vma_use_count</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">meye_vm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">vma_use_count</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="n">meye_vm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">meye_vm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span> <span class="n">meye_vm_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meye_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">gbuffers</span> <span class="o">*</span> <span class="n">gbufsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* lazy allocation */</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span> <span class="o">=</span> <span class="n">rvmalloc</span><span class="p">(</span><span class="n">gbuffers</span><span class="o">*</span><span class="n">gbufsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;meye: v4l framebuffer allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gbuffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">meye</span><span class="p">.</span><span class="n">vma_use_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">vmalloc_to_pfn</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PAGE_SHARED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">meye_vm_ops</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VM_IO</span><span class="p">;</span>	<span class="cm">/* not I/O memory */</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_RESERVED</span><span class="p">;</span>	<span class="cm">/* avoid to swap out this VMA */</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="n">gbufsize</span><span class="p">);</span>
	<span class="n">meye_vm_open</span><span class="p">(</span><span class="n">vma</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">meye_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">meye_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">meye_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">meye_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">meye_poll</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">meye_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>	<span class="o">=</span> <span class="n">vidioc_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>	<span class="o">=</span> <span class="n">vidioc_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>		<span class="o">=</span> <span class="n">vidioc_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>		<span class="o">=</span> <span class="n">vidioc_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span>	<span class="o">=</span> <span class="n">vidioc_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span>		<span class="o">=</span> <span class="n">vidioc_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span>		<span class="o">=</span> <span class="n">vidioc_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span> <span class="o">=</span> <span class="n">vidioc_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span>	<span class="o">=</span> <span class="n">vidioc_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span>	<span class="o">=</span> <span class="n">vidioc_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span>	<span class="o">=</span> <span class="n">vidioc_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span>		<span class="o">=</span> <span class="n">vidioc_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span>	<span class="o">=</span> <span class="n">vidioc_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span>		<span class="o">=</span> <span class="n">vidioc_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span>		<span class="o">=</span> <span class="n">vidioc_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span>	<span class="o">=</span> <span class="n">vidioc_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span>	<span class="o">=</span> <span class="n">vidioc_streamoff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_default</span>		<span class="o">=</span> <span class="n">vidioc_default</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">meye_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;meye&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">meye_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span> 	<span class="o">=</span> <span class="o">&amp;</span><span class="n">meye_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">video_device_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">meye_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">pm_mchip_mode</span> <span class="o">=</span> <span class="n">meye</span><span class="p">.</span><span class="n">mchip_mode</span><span class="p">;</span>
	<span class="n">mchip_hic_stop</span><span class="p">();</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MM_INTA</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">meye_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">,</span> <span class="n">MCHIP_PCI_SOFTRESET_SET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_STATUS</span><span class="p">,</span> <span class="n">MCHIP_HIC_STATUS_IDLE</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_SOFT_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MM_PCI_MODE</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MM_INTA</span><span class="p">,</span> <span class="n">MCHIP_MM_INTA_HIC_1_MASK</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">pm_mchip_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MCHIP_HIC_MODE_CONT_OUT</span>:
		<span class="n">mchip_continuous_start</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHIP_HIC_MODE_CONT_COMP</span>:
		<span class="n">mchip_cont_compression_start</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">meye_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mchip_adr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;meye: only one device allowed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outnotdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Could not register v4l2_device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span> <span class="o">=</span> <span class="n">pcidev</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meye</span><span class="p">.</span><span class="n">vdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;video_device_alloc() failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outnotdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">meye</span><span class="p">.</span><span class="n">grab_temp</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">MCHIP_NB_PAGES_MJPEG</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;grab buffer allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outvmalloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">MEYE_MAX_BUFNBRS</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;fifo allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outkfifoalloc1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">MEYE_MAX_BUFNBRS</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;fifo allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outkfifoalloc2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meye_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">meye_template</span><span class="p">));</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sony_pic_camera_command</span><span class="p">(</span><span class="n">SONY_PIC_COMMAND_SETCAMERA</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;meye: unable to power on the camera</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;meye: did you enable the camera in &quot;</span>
				<span class="s">&quot;sonypi using the module options ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outsonypienable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;meye: pci_enable_device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outenabledev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mchip_adr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mchip_adr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;meye: mchip has no device base address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outregions</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="s">&quot;meye&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;meye: request_mem_region failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outregions</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">mchip_mmregs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mchip_adr</span><span class="p">,</span> <span class="n">MCHIP_MM_REGS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_mmregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;meye: ioremap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">meye</span><span class="p">.</span><span class="n">mchip_irq</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_irq</span><span class="p">,</span> <span class="n">meye_irq</span><span class="p">,</span>
			<span class="n">IRQF_DISABLED</span> <span class="o">|</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;meye&quot;</span><span class="p">,</span> <span class="n">meye_irq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;request_irq failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outreqirq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">);</span>

	<span class="cm">/* Ask the camera to perform a soft reset. */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">,</span> <span class="n">MCHIP_PCI_SOFTRESET_SET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mchip_delay</span><span class="p">(</span><span class="n">MCHIP_HIC_STATUS</span><span class="p">,</span> <span class="n">MCHIP_HIC_STATUS_IDLE</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_VRJ_SOFT_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MM_PCI_MODE</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MM_INTA</span><span class="p">,</span> <span class="n">MCHIP_MM_INTA_HIC_1_MASK</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">proc_list</span><span class="p">);</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">hue</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">colour</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">contrast</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">subsample</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">quality</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">sharpness</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">agc</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">picture</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">meye</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">framerate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sony_pic_camera_command</span><span class="p">(</span><span class="n">SONY_PIC_COMMAND_SETCAMERABRIGHTNESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">sony_pic_camera_command</span><span class="p">(</span><span class="n">SONY_PIC_COMMAND_SETCAMERAHUE</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">sony_pic_camera_command</span><span class="p">(</span><span class="n">SONY_PIC_COMMAND_SETCAMERACOLOR</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">sony_pic_camera_command</span><span class="p">(</span><span class="n">SONY_PIC_COMMAND_SETCAMERACONTRAST</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">sony_pic_camera_command</span><span class="p">(</span><span class="n">SONY_PIC_COMMAND_SETCAMERASHARPNESS</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">sony_pic_camera_command</span><span class="p">(</span><span class="n">SONY_PIC_COMMAND_SETCAMERAPICTURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sony_pic_camera_command</span><span class="p">(</span><span class="n">SONY_PIC_COMMAND_SETCAMERAAGC</span><span class="p">,</span> <span class="mi">48</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">video_register_device</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span>
				  <span class="n">video_nr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;video_register_device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outvideoreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Motion Eye Camera Driver v%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">MEYE_DRIVER_VERSION</span><span class="p">);</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;mchip KL5A72002 rev. %d, base %lx, irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">mchip_adr</span><span class="p">,</span> <span class="n">meye</span><span class="p">.</span><span class="n">mchip_irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">outvideoreg:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_irq</span><span class="p">,</span> <span class="n">meye_irq</span><span class="p">);</span>
<span class="nl">outreqirq:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_mmregs</span><span class="p">);</span>
<span class="nl">outremap:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="nl">outregions:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">);</span>
<span class="nl">outenabledev:</span>
	<span class="n">sony_pic_camera_command</span><span class="p">(</span><span class="n">SONY_PIC_COMMAND_SETCAMERA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">outsonypienable:</span>
	<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq</span><span class="p">);</span>
<span class="nl">outkfifoalloc2:</span>
	<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq</span><span class="p">);</span>
<span class="nl">outkfifoalloc1:</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_temp</span><span class="p">);</span>
<span class="nl">outvmalloc:</span>
	<span class="n">video_device_release</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">vdev</span><span class="p">);</span>
<span class="nl">outnotdev:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">meye_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">mchip_hic_stop</span><span class="p">();</span>

	<span class="n">mchip_dma_free</span><span class="p">();</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="n">mchip_set</span><span class="p">(</span><span class="n">MCHIP_MM_INTA</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_irq</span><span class="p">,</span> <span class="n">meye_irq</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_mmregs</span><span class="p">);</span>

	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">mchip_dev</span><span class="p">);</span>

	<span class="n">sony_pic_camera_command</span><span class="p">(</span><span class="n">SONY_PIC_COMMAND_SETCAMERA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">doneq</span><span class="p">);</span>
	<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye</span><span class="p">.</span><span class="n">grabq</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_temp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rvfree</span><span class="p">(</span><span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span><span class="p">,</span> <span class="n">gbuffers</span><span class="o">*</span><span class="n">gbufsize</span><span class="p">);</span>
		<span class="n">meye</span><span class="p">.</span><span class="n">grab_fbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;meye: removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">meye_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">KAWASAKI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MCHIP_KL5A72002</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">meye_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">meye_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;meye&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">meye_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">meye_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">meye_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">meye_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">meye_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">meye_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gbuffers</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">gbuffers</span><span class="p">,</span> <span class="n">MEYE_MAX_BUFNBRS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gbufsize</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">gbufsize</span> <span class="o">&gt;</span> <span class="n">MEYE_MAX_BUFSIZE</span><span class="p">)</span>
		<span class="n">gbufsize</span> <span class="o">=</span> <span class="n">MEYE_MAX_BUFSIZE</span><span class="p">;</span>
	<span class="n">gbufsize</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">gbufsize</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;meye: using %d buffers with %dk (%dk total) &quot;</span>
			 <span class="s">&quot;for capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">gbuffers</span><span class="p">,</span>
			 <span class="n">gbufsize</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">gbuffers</span> <span class="o">*</span> <span class="n">gbufsize</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">meye_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meye_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">meye_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">meye_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
