<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › m5mols › m5mols_controls.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>m5mols_controls.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Controls for M-5MOLS 8M Pixel camera sensor with ISP</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Samsung Electronics Co., Ltd.</span>
<span class="cm"> * Author: HeungJun Kim &lt;riverful.kim@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Samsung Electronics Co., Ltd.</span>
<span class="cm"> * Author: Dongsoo Nathaniel Kim &lt;dongsoo45.kim@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>

<span class="cp">#include &quot;m5mols.h&quot;</span>
<span class="cp">#include &quot;m5mols_reg.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">m5mols_scenemode</span> <span class="n">m5mols_default_scenemode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">REG_SCENE_NORMAL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_CENTER</span><span class="p">,</span> <span class="n">REG_AE_INDEX_00</span><span class="p">,</span> <span class="n">REG_AWB_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="n">REG_AF_NORMAL</span><span class="p">,</span> <span class="n">REG_FD_OFF</span><span class="p">,</span>
		<span class="n">REG_MCC_NORMAL</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">5</span><span class="p">,</span> <span class="n">REG_ISO_AUTO</span><span class="p">,</span> <span class="n">REG_CAP_NONE</span><span class="p">,</span> <span class="n">REG_WDR_OFF</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REG_SCENE_PORTRAIT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_CENTER</span><span class="p">,</span> <span class="n">REG_AE_INDEX_00</span><span class="p">,</span> <span class="n">REG_AWB_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		<span class="n">REG_AF_NORMAL</span><span class="p">,</span> <span class="n">BIT_FD_EN</span> <span class="o">|</span> <span class="n">BIT_FD_DRAW_FACE_FRAME</span><span class="p">,</span>
		<span class="n">REG_MCC_OFF</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="n">REG_ISO_AUTO</span><span class="p">,</span> <span class="n">REG_CAP_NONE</span><span class="p">,</span> <span class="n">REG_WDR_OFF</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REG_SCENE_LANDSCAPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_ALL</span><span class="p">,</span> <span class="n">REG_AE_INDEX_00</span><span class="p">,</span> <span class="n">REG_AWB_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
		<span class="n">REG_AF_NORMAL</span><span class="p">,</span> <span class="n">REG_FD_OFF</span><span class="p">,</span>
		<span class="n">REG_MCC_OFF</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="n">REG_ISO_AUTO</span><span class="p">,</span> <span class="n">REG_CAP_NONE</span><span class="p">,</span> <span class="n">REG_WDR_OFF</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REG_SCENE_SPORTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_CENTER</span><span class="p">,</span> <span class="n">REG_AE_INDEX_00</span><span class="p">,</span> <span class="n">REG_AWB_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="n">REG_AF_NORMAL</span><span class="p">,</span> <span class="n">REG_FD_OFF</span><span class="p">,</span>
		<span class="n">REG_MCC_OFF</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="n">REG_ISO_AUTO</span><span class="p">,</span> <span class="n">REG_CAP_NONE</span><span class="p">,</span> <span class="n">REG_WDR_OFF</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REG_SCENE_PARTY_INDOOR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_CENTER</span><span class="p">,</span> <span class="n">REG_AE_INDEX_00</span><span class="p">,</span> <span class="n">REG_AWB_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="n">REG_AF_NORMAL</span><span class="p">,</span> <span class="n">REG_FD_OFF</span><span class="p">,</span>
		<span class="n">REG_MCC_OFF</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="n">REG_ISO_200</span><span class="p">,</span> <span class="n">REG_CAP_NONE</span><span class="p">,</span> <span class="n">REG_WDR_OFF</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REG_SCENE_BEACH_SNOW</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_CENTER</span><span class="p">,</span> <span class="n">REG_AE_INDEX_10_POS</span><span class="p">,</span> <span class="n">REG_AWB_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="n">REG_AF_NORMAL</span><span class="p">,</span> <span class="n">REG_FD_OFF</span><span class="p">,</span>
		<span class="n">REG_MCC_OFF</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="n">REG_ISO_50</span><span class="p">,</span> <span class="n">REG_CAP_NONE</span><span class="p">,</span> <span class="n">REG_WDR_OFF</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REG_SCENE_SUNSET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_CENTER</span><span class="p">,</span> <span class="n">REG_AE_INDEX_00</span><span class="p">,</span> <span class="n">REG_AWB_PRESET</span><span class="p">,</span>
		<span class="n">REG_AWB_DAYLIGHT</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="n">REG_AF_NORMAL</span><span class="p">,</span> <span class="n">REG_FD_OFF</span><span class="p">,</span>
		<span class="n">REG_MCC_OFF</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="n">REG_ISO_AUTO</span><span class="p">,</span> <span class="n">REG_CAP_NONE</span><span class="p">,</span> <span class="n">REG_WDR_OFF</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REG_SCENE_DAWN_DUSK</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_CENTER</span><span class="p">,</span> <span class="n">REG_AE_INDEX_00</span><span class="p">,</span> <span class="n">REG_AWB_PRESET</span><span class="p">,</span>
		<span class="n">REG_AWB_FLUORESCENT_1</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="n">REG_AF_NORMAL</span><span class="p">,</span> <span class="n">REG_FD_OFF</span><span class="p">,</span>
		<span class="n">REG_MCC_OFF</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="n">REG_ISO_AUTO</span><span class="p">,</span> <span class="n">REG_CAP_NONE</span><span class="p">,</span> <span class="n">REG_WDR_OFF</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REG_SCENE_FALL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_CENTER</span><span class="p">,</span> <span class="n">REG_AE_INDEX_00</span><span class="p">,</span> <span class="n">REG_AWB_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="n">REG_AF_NORMAL</span><span class="p">,</span> <span class="n">REG_FD_OFF</span><span class="p">,</span>
		<span class="n">REG_MCC_OFF</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="n">REG_ISO_AUTO</span><span class="p">,</span> <span class="n">REG_CAP_NONE</span><span class="p">,</span> <span class="n">REG_WDR_OFF</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REG_SCENE_NIGHT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_CENTER</span><span class="p">,</span> <span class="n">REG_AE_INDEX_00</span><span class="p">,</span> <span class="n">REG_AWB_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="n">REG_AF_NORMAL</span><span class="p">,</span> <span class="n">REG_FD_OFF</span><span class="p">,</span>
		<span class="n">REG_MCC_OFF</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="n">REG_ISO_AUTO</span><span class="p">,</span> <span class="n">REG_CAP_NONE</span><span class="p">,</span> <span class="n">REG_WDR_OFF</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REG_SCENE_AGAINST_LIGHT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_CENTER</span><span class="p">,</span> <span class="n">REG_AE_INDEX_00</span><span class="p">,</span> <span class="n">REG_AWB_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="n">REG_AF_NORMAL</span><span class="p">,</span> <span class="n">REG_FD_OFF</span><span class="p">,</span>
		<span class="n">REG_MCC_OFF</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="n">REG_ISO_AUTO</span><span class="p">,</span> <span class="n">REG_CAP_NONE</span><span class="p">,</span> <span class="n">REG_WDR_OFF</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REG_SCENE_FIRE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_CENTER</span><span class="p">,</span> <span class="n">REG_AE_INDEX_00</span><span class="p">,</span> <span class="n">REG_AWB_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="n">REG_AF_NORMAL</span><span class="p">,</span> <span class="n">REG_FD_OFF</span><span class="p">,</span>
		<span class="n">REG_MCC_OFF</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="n">REG_ISO_50</span><span class="p">,</span> <span class="n">REG_CAP_NONE</span><span class="p">,</span> <span class="n">REG_WDR_OFF</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REG_SCENE_TEXT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_CENTER</span><span class="p">,</span> <span class="n">REG_AE_INDEX_00</span><span class="p">,</span> <span class="n">REG_AWB_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
		<span class="n">REG_AF_MACRO</span><span class="p">,</span> <span class="n">REG_FD_OFF</span><span class="p">,</span>
		<span class="n">REG_MCC_OFF</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="n">REG_ISO_AUTO</span><span class="p">,</span> <span class="n">REG_CAP_ANTI_SHAKE</span><span class="p">,</span> <span class="n">REG_WDR_ON</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REG_SCENE_CANDLE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REG_AE_CENTER</span><span class="p">,</span> <span class="n">REG_AE_INDEX_00</span><span class="p">,</span> <span class="n">REG_AWB_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">REG_CHROMA_ON</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">REG_EDGE_ON</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="n">REG_AF_NORMAL</span><span class="p">,</span> <span class="n">REG_FD_OFF</span><span class="p">,</span>
		<span class="n">REG_MCC_OFF</span><span class="p">,</span> <span class="n">REG_LIGHT_OFF</span><span class="p">,</span> <span class="n">REG_FLASH_OFF</span><span class="p">,</span>
		<span class="mi">6</span><span class="p">,</span> <span class="n">REG_ISO_AUTO</span><span class="p">,</span> <span class="n">REG_CAP_NONE</span><span class="p">,</span> <span class="n">REG_WDR_OFF</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * m5mols_do_scenemode() - Change current scenemode</span>
<span class="cm"> * @mode:	Desired mode of the scenemode</span>
<span class="cm"> *</span>
<span class="cm"> * WARNING: The execution order is important. Do not change the order.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">m5mols_do_scenemode</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m5mols_scenemode</span> <span class="n">scenemode</span> <span class="o">=</span> <span class="n">m5mols_default_scenemode</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;</span> <span class="n">REG_SCENE_CANDLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_ctrl_s_ctrl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock_3a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_EV_PRESET_MONITOR</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_EV_PRESET_CAPTURE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_MODE</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">metering</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_INDEX</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">ev_bias</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AWB_MODE</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">wb_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AWB_MANUAL</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">wb_preset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">MON_CHROMA_EN</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">chroma_en</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">MON_CHROMA_LVL</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">chroma_lvl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">MON_EDGE_EN</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">edge_en</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">MON_EDGE_LVL</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">edge_lvl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">is_available_af</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AF_MODE</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">af_range</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">is_available_af</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">FD_CTL</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">fd_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">MON_TONE_CTL</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">tone</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_ISO</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">iso</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_mode</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">REG_CAPTURE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">CAPP_WDR_EN</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">wdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">CAPP_MCC_MODE</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">mcc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">CAPP_LIGHT_CTRL</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">light</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">CAPP_FLASH_CTRL</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">flash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">CAPC_MODE</span><span class="p">,</span> <span class="n">scenemode</span><span class="p">.</span><span class="n">capt_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_mode</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">REG_MONITOR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_3a_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">af_lock</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">V4L2_LOCK_FOCUS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">^</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V4L2_LOCK_EXPOSURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">ae_lock</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">V4L2_LOCK_EXPOSURE</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_LOCK</span><span class="p">,</span> <span class="n">ae_lock</span> <span class="o">?</span>
				   <span class="n">REG_AE_LOCK</span> <span class="o">:</span> <span class="n">REG_AE_UNLOCK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">^</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V4L2_LOCK_WHITE_BALANCE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">auto_wb</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">awb_lock</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">V4L2_LOCK_WHITE_BALANCE</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">AWB_LOCK</span><span class="p">,</span> <span class="n">awb_lock</span> <span class="o">?</span>
				   <span class="n">REG_AWB_LOCK</span> <span class="o">:</span> <span class="n">REG_AWB_UNLOCK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ver</span><span class="p">.</span><span class="n">af</span> <span class="o">||</span> <span class="o">!</span><span class="n">af_lock</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">^</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V4L2_LOCK_FOCUS</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">AF_EXECUTE</span><span class="p">,</span> <span class="n">REG_AF_STOP</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_set_metering_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">metering</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_EXPOSURE_METERING_CENTER_WEIGHTED</span>:
		<span class="n">metering</span> <span class="o">=</span> <span class="n">REG_AE_CENTER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_EXPOSURE_METERING_SPOT</span>:
		<span class="n">metering</span> <span class="o">=</span> <span class="n">REG_AE_SPOT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">metering</span> <span class="o">=</span> <span class="n">REG_AE_ALL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_MODE</span><span class="p">,</span> <span class="n">metering</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_set_exposure</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exposure</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">exposure</span> <span class="o">==</span> <span class="n">V4L2_EXPOSURE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Unlock auto exposure */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">lock_3a</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_LOCK_EXPOSURE</span><span class="p">;</span>
		<span class="n">m5mols_3a_lock</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">lock_3a</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_metering_mode</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">metering</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m5mols_debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span>
			 <span class="s">&quot;%s: exposure bias: %#x, metering: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">exposure_bias</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span>
			 <span class="n">info</span><span class="o">-&gt;</span><span class="n">metering</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_INDEX</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">exposure_bias</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">exposure</span> <span class="o">==</span> <span class="n">V4L2_EXPOSURE_MANUAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_MODE</span><span class="p">,</span> <span class="n">REG_AE_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_MAN_GAIN_MON</span><span class="p">,</span>
					   <span class="n">info</span><span class="o">-&gt;</span><span class="n">exposure</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_MAN_GAIN_CAP</span><span class="p">,</span>
					   <span class="n">info</span><span class="o">-&gt;</span><span class="n">exposure</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m5mols_debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;%s: exposure: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">exposure</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_set_white_balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wb</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">V4L2_WHITE_BALANCE_INCANDESCENT</span><span class="p">,</span>  <span class="n">REG_AWB_INCANDESCENT</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">V4L2_WHITE_BALANCE_FLUORESCENT</span><span class="p">,</span>   <span class="n">REG_AWB_FLUORESCENT_1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">V4L2_WHITE_BALANCE_FLUORESCENT_H</span><span class="p">,</span> <span class="n">REG_AWB_FLUORESCENT_2</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">V4L2_WHITE_BALANCE_HORIZON</span><span class="p">,</span>       <span class="n">REG_AWB_HORIZON</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">V4L2_WHITE_BALANCE_DAYLIGHT</span><span class="p">,</span>      <span class="n">REG_AWB_DAYLIGHT</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">V4L2_WHITE_BALANCE_FLASH</span><span class="p">,</span>         <span class="n">REG_AWB_LEDLIGHT</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">V4L2_WHITE_BALANCE_CLOUDY</span><span class="p">,</span>        <span class="n">REG_AWB_CLOUDY</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">V4L2_WHITE_BALANCE_SHADE</span><span class="p">,</span>         <span class="n">REG_AWB_SHADE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">V4L2_WHITE_BALANCE_AUTO</span><span class="p">,</span>          <span class="n">REG_AWB_AUTO</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wb</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">awb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wb</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m5mols_debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span>
			 <span class="s">&quot;Setting white balance to: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wb</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">awb</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">V4L2_WHITE_BALANCE_AUTO</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AWB_MODE</span><span class="p">,</span> <span class="n">awb</span> <span class="o">?</span> <span class="n">REG_AWB_AUTO</span> <span class="o">:</span>
						 <span class="n">REG_AWB_PRESET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">awb</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AWB_MANUAL</span><span class="p">,</span> <span class="n">wb</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_set_saturation</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">MON_CHROMA_LVL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">MON_CHROMA_EN</span><span class="p">,</span> <span class="n">REG_CHROMA_ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_set_color_effect</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m_effect</span> <span class="o">=</span> <span class="n">REG_COLOR_EFFECT_OFF</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p_effect</span> <span class="o">=</span> <span class="n">REG_EFFECT_OFF</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfix_r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cfix_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_COLORFX_BW</span>:
		<span class="n">m_effect</span> <span class="o">=</span> <span class="n">REG_COLOR_EFFECT_ON</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_COLORFX_NEGATIVE</span>:
		<span class="n">p_effect</span> <span class="o">=</span> <span class="n">REG_EFFECT_NEGA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_COLORFX_EMBOSS</span>:
		<span class="n">p_effect</span> <span class="o">=</span> <span class="n">REG_EFFECT_EMBOSS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_COLORFX_SEPIA</span>:
		<span class="n">m_effect</span> <span class="o">=</span> <span class="n">REG_COLOR_EFFECT_ON</span><span class="p">;</span>
		<span class="n">cfix_r</span> <span class="o">=</span> <span class="n">REG_CFIXR_SEPIA</span><span class="p">;</span>
		<span class="n">cfix_b</span> <span class="o">=</span> <span class="n">REG_CFIXB_SEPIA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PARM_EFFECT</span><span class="p">,</span> <span class="n">p_effect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">MON_EFFECT</span><span class="p">,</span> <span class="n">m_effect</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">m_effect</span> <span class="o">==</span> <span class="n">REG_COLOR_EFFECT_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">MON_CFIXR</span><span class="p">,</span> <span class="n">cfix_r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">MON_CFIXB</span><span class="p">,</span> <span class="n">cfix_b</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m5mols_debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span>
		 <span class="s">&quot;p_effect: %#x, m_effect: %#x, r: %#x, b: %#x (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">p_effect</span><span class="p">,</span> <span class="n">m_effect</span><span class="p">,</span> <span class="n">cfix_r</span><span class="p">,</span> <span class="n">cfix_b</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_set_iso</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">auto_iso</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">iso</span> <span class="o">=</span> <span class="n">auto_iso</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">iso</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_ISO</span><span class="p">,</span> <span class="n">iso</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_set_wdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">MON_TONE_CTL</span><span class="p">,</span> <span class="n">wdr</span> <span class="o">?</span> <span class="mi">9</span> <span class="o">:</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_mode</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">REG_CAPTURE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">CAPP_WDR_EN</span><span class="p">,</span> <span class="n">wdr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_set_stabilization</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">evp</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="mh">0xe</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_EV_PRESET_MONITOR</span><span class="p">,</span> <span class="n">evp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_EV_PRESET_CAPTURE</span><span class="p">,</span> <span class="n">evp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_g_volatile_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">to_sd</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m5mols_debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;%s: ctrl: %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isp_ready</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isp_ready</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ISO_SENSITIVITY_AUTO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u8</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_ISO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="o">!</span><span class="n">status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">REG_ISO_AUTO</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">iso</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">status</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_3A_LOCK</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u8</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">lock_3a</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">|=</span> <span class="n">V4L2_LOCK_EXPOSURE</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u8</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AWB_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">lock_3a</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">|=</span> <span class="n">V4L2_LOCK_EXPOSURE</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u8</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AF_EXECUTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">lock_3a</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">|=</span> <span class="n">V4L2_LOCK_EXPOSURE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl_mode</span> <span class="o">=</span> <span class="n">m5mols_get_ctrl_mode</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">to_sd</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">last_mode</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If needed, defer restoring the controls until</span>
<span class="cm">	 * the device is fully initialized.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isp_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ctrl_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m5mols_debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;%s: %s, val: %d, priv: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl_mode</span> <span class="o">&amp;&amp;</span> <span class="n">ctrl_mode</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_mode</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ctrl_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_3A_LOCK</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_3a_lock</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_ZOOM_ABSOLUTE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">MON_ZOOM</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_EXPOSURE_AUTO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_exposure</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_ISO_SENSITIVITY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_iso</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_N_PRESET_WHITE_BALANCE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_white_balance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_saturation</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_COLORFX</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_color_effect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_WIDE_DYNAMIC_RANGE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_wdr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_IMAGE_STABILIZATION</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_stabilization</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_JPEG_COMPRESSION_QUALITY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">CAPP_JPEG_RATIO</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">last_mode</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_mode</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">last_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">m5mols_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_volatile_ctrl</span>	<span class="o">=</span> <span class="n">m5mols_g_volatile_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ctrl</span>			<span class="o">=</span> <span class="n">m5mols_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Supported manual ISO values */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">s64</span> <span class="n">iso_qmenu</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* AE_ISO: 0x01...0x07 */</span>
	<span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">3200</span>
<span class="p">};</span>

<span class="cm">/* Supported Exposure Bias values, -2.0EV...+2.0EV */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">s64</span> <span class="n">ev_bias_qmenu</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* AE_INDEX: 0x00...0x08 */</span>
	<span class="o">-</span><span class="mi">2000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1500</span><span class="p">,</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">2000</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">m5mols_init_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">exposure_max</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">zoom_step</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Determine the firmware dependant control range and step values */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u16</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AE_MAX_GAIN_MON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exposure_max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">zoom_step</span> <span class="o">=</span> <span class="n">is_manufacturer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">REG_SAMSUNG_OPTICS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">31</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">auto_wb</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std_menu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span> <span class="n">V4L2_CID_AUTO_N_PRESET_WHITE_BALANCE</span><span class="p">,</span>
			<span class="mi">9</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x3fe</span><span class="p">,</span> <span class="n">V4L2_WHITE_BALANCE_AUTO</span><span class="p">);</span>

	<span class="cm">/* Exposure control cluster */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">auto_exposure</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std_menu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span> <span class="n">V4L2_CID_EXPOSURE_AUTO</span><span class="p">,</span>
			<span class="mi">1</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">V4L2_EXPOSURE_AUTO</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">exposure</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span> <span class="n">V4L2_CID_EXPOSURE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">exposure_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">exposure_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">exposure_bias</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_int_menu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span> <span class="n">V4L2_CID_AUTO_EXPOSURE_BIAS</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ev_bias_qmenu</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ev_bias_qmenu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">ev_bias_qmenu</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">metering</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std_menu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span> <span class="n">V4L2_CID_EXPOSURE_METERING</span><span class="p">,</span>
			<span class="mi">2</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">,</span> <span class="n">V4L2_EXPOSURE_METERING_AVERAGE</span><span class="p">);</span>

	<span class="cm">/* ISO control cluster */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">auto_iso</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std_menu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_ISO_SENSITIVITY_AUTO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">iso</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_int_menu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_ISO_SENSITIVITY</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">iso_qmenu</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">iso_qmenu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iso_qmenu</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">saturation</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_SATURATION</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">zoom</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_ZOOM_ABSOLUTE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="n">zoom_step</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">colorfx</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std_menu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_COLORFX</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_COLORFX_NONE</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">wdr</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_WIDE_DYNAMIC_RANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stabilization</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_IMAGE_STABILIZATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">jpeg_quality</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_JPEG_COMPRESSION_QUALITY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">lock_3a</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m5mols_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_3A_LOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Failed to initialize controls: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_ctrl_auto_cluster</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">auto_exposure</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">auto_iso</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_VOLATILE</span> <span class="o">|</span>
				<span class="n">V4L2_CTRL_FLAG_UPDATE</span><span class="p">;</span>
	<span class="n">v4l2_ctrl_auto_cluster</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">auto_iso</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">lock_3a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_VOLATILE</span><span class="p">;</span>

	<span class="n">m5mols_set_ctrl_mode</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">auto_exposure</span><span class="p">,</span> <span class="n">REG_PARAMETER</span><span class="p">);</span>
	<span class="n">m5mols_set_ctrl_mode</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">auto_wb</span><span class="p">,</span> <span class="n">REG_PARAMETER</span><span class="p">);</span>
	<span class="n">m5mols_set_ctrl_mode</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">colorfx</span><span class="p">,</span> <span class="n">REG_MONITOR</span><span class="p">);</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
