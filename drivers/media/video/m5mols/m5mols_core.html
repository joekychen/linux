<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › m5mols › m5mols_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>m5mols_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for M-5MOLS 8M Pixel camera sensor with ISP</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Samsung Electronics Co., Ltd.</span>
<span class="cm"> * Author: HeungJun Kim &lt;riverful.kim@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Samsung Electronics Co., Ltd.</span>
<span class="cm"> * Author: Dongsoo Nathaniel Kim &lt;dongsoo45.kim@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-subdev.h&gt;</span>
<span class="cp">#include &lt;media/m5mols.h&gt;</span>

<span class="cp">#include &quot;m5mols.h&quot;</span>
<span class="cp">#include &quot;m5mols_reg.h&quot;</span>

<span class="kt">int</span> <span class="n">m5mols_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">m5mols_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cp">#define MODULE_NAME		&quot;M5MOLS&quot;</span>
<span class="cp">#define M5MOLS_I2C_CHECK_RETRY	500</span>

<span class="cm">/* The regulator consumer names for external voltage regulators */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_bulk_data</span> <span class="n">supplies</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;core&quot;</span><span class="p">,</span>	<span class="cm">/* ARM core power, 1.2V */</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span>	<span class="o">=</span> <span class="s">&quot;dig_18&quot;</span><span class="p">,</span>	<span class="cm">/* digital power 1, 1.8V */</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span>	<span class="o">=</span> <span class="s">&quot;d_sensor&quot;</span><span class="p">,</span>	<span class="cm">/* sensor power 1, 1.8V */</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span>	<span class="o">=</span> <span class="s">&quot;dig_28&quot;</span><span class="p">,</span>	<span class="cm">/* digital power 2, 2.8V */</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span>	<span class="o">=</span> <span class="s">&quot;a_sensor&quot;</span><span class="p">,</span>	<span class="cm">/* analog power */</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span>	<span class="o">=</span> <span class="s">&quot;dig_12&quot;</span><span class="p">,</span>	<span class="cm">/* digital power 3, 1.2V */</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">m5mols_default_ffmt</span><span class="p">[</span><span class="n">M5MOLS_RESTYPE_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="mi">1920</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="mi">1080</span><span class="p">,</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">V4L2_MBUS_FMT_VYUY8_2X8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">field</span>		<span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="mi">1920</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="mi">1080</span><span class="p">,</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">V4L2_MBUS_FMT_JPEG_1X8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">field</span>		<span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="cp">#define SIZE_DEFAULT_FFMT	ARRAY_SIZE(m5mols_default_ffmt)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">m5mols_resolution</span> <span class="n">m5mols_reg_res</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">96</span> <span class="p">},</span>	<span class="cm">/* SUB-QCIF */</span>
	<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">120</span> <span class="p">},</span>	<span class="cm">/* QQVGA */</span>
	<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">144</span> <span class="p">},</span>	<span class="cm">/* QCIF */</span>
	<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">176</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">320</span> <span class="p">},</span>	<span class="cm">/* QVGA */</span>
	<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">240</span> <span class="p">},</span>	<span class="cm">/* QVGA */</span>
	<span class="p">{</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">400</span> <span class="p">},</span>	<span class="cm">/* WQVGA */</span>
	<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">240</span> <span class="p">},</span>	<span class="cm">/* WQVGA */</span>
	<span class="p">{</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">352</span><span class="p">,</span> <span class="mi">288</span> <span class="p">},</span>	<span class="cm">/* CIF */</span>
	<span class="p">{</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">360</span> <span class="p">},</span>	<span class="cm">/* qHD */</span>
	<span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span> <span class="p">},</span>	<span class="cm">/* VGA */</span>
	<span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">480</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">480</span> <span class="p">},</span>	<span class="cm">/* WVGA */</span>
	<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">600</span> <span class="p">},</span>	<span class="cm">/* SVGA */</span>
	<span class="p">{</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span> <span class="p">},</span>	<span class="cm">/* HD */</span>
	<span class="p">{</span> <span class="mh">0x25</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span> <span class="p">},</span>	<span class="cm">/* 1080p */</span>
	<span class="p">{</span> <span class="mh">0x29</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">3264</span><span class="p">,</span> <span class="mi">2448</span> <span class="p">},</span>	<span class="cm">/* 2.63fps 8M */</span>
	<span class="p">{</span> <span class="mh">0x39</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">602</span> <span class="p">},</span>	<span class="cm">/* AHS_MON debug */</span>

	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">240</span> <span class="p">},</span>	<span class="cm">/* QVGA */</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">240</span> <span class="p">},</span>	<span class="cm">/* WQVGA */</span>
	<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">360</span> <span class="p">},</span>	<span class="cm">/* qHD */</span>
	<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span> <span class="p">},</span>	<span class="cm">/* VGA */</span>
	<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">480</span> <span class="p">},</span>	<span class="cm">/* WVGA */</span>
	<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span> <span class="p">},</span>	<span class="cm">/* HD */</span>
	<span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">960</span> <span class="p">},</span>	<span class="cm">/* 1M */</span>
	<span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">1200</span> <span class="p">},</span>	<span class="cm">/* 2M */</span>
	<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span> <span class="p">},</span>	<span class="cm">/* Full-HD */</span>
	<span class="p">{</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">1152</span> <span class="p">},</span>	<span class="cm">/* 3Mega */</span>
	<span class="p">{</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">1536</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">2560</span><span class="p">,</span> <span class="mi">1440</span> <span class="p">},</span>	<span class="cm">/* 4Mega */</span>
	<span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">2560</span><span class="p">,</span> <span class="mi">1536</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">2560</span><span class="p">,</span> <span class="mi">1920</span> <span class="p">},</span>	<span class="cm">/* 5Mega */</span>
	<span class="p">{</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">3264</span><span class="p">,</span> <span class="mi">1836</span> <span class="p">},</span>	<span class="cm">/* 6Mega */</span>
	<span class="p">{</span> <span class="mh">0x22</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">3264</span><span class="p">,</span> <span class="mi">1960</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x25</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">,</span> <span class="mi">3264</span><span class="p">,</span> <span class="mi">2448</span> <span class="p">},</span>	<span class="cm">/* 8Mega */</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * m5mols_swap_byte - an byte array to integer conversion function</span>
<span class="cm"> * @size: size in bytes of I2C packet defined in the M-5MOLS datasheet</span>
<span class="cm"> *</span>
<span class="cm"> * Convert I2C data byte array with performing any required byte</span>
<span class="cm"> * reordering to assure proper values for each data type, regardless</span>
<span class="cm"> * of the architecture endianness.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">m5mols_swap_byte</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * m5mols_read -  I2C read function</span>
<span class="cm"> * @reg: combination of size, category and command for the I2C packet</span>
<span class="cm"> * @size: desired size of I2C packet</span>
<span class="cm"> * @val: read value</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, or else negative errno.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">rbuf</span><span class="p">[</span><span class="n">M5MOLS_I2C_MAX_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">category</span> <span class="o">=</span> <span class="n">I2C_CATEGORY</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">I2C_COMMAND</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">wbuf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">wbuf</span><span class="p">;</span>
	<span class="n">wbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">wbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">M5MOLS_BYTE_READ</span><span class="p">;</span>
	<span class="n">wbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">category</span><span class="p">;</span>
	<span class="n">wbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">wbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">rbuf</span><span class="p">;</span>

	<span class="cm">/* minimum stabilization time */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">m5mols_swap_byte</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isp_ready</span><span class="p">)</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;read failed: size:%d cat:%02x cmd:%02x. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">size</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">m5mols_read_u8</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val_32</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I2C_SIZE</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Wrong data size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">I2C_SIZE</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val_32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">val_32</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">m5mols_read_u16</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val_32</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I2C_SIZE</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Wrong data size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">I2C_SIZE</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val_32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">val_32</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">m5mols_read_u32</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I2C_SIZE</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Wrong data size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">m5mols_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">I2C_SIZE</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * m5mols_write - I2C command write function</span>
<span class="cm"> * @reg: combination of size, category and command for the I2C packet</span>
<span class="cm"> * @val: value to write</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, or else negative errno.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">m5mols_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">wbuf</span><span class="p">[</span><span class="n">M5MOLS_I2C_MAX_SIZE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">category</span> <span class="o">=</span> <span class="n">I2C_CATEGORY</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">I2C_COMMAND</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">size</span>	<span class="o">=</span> <span class="n">I2C_SIZE</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Wrong data size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">size</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">wbuf</span><span class="p">;</span>
	<span class="n">wbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">wbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">M5MOLS_BYTE_WRITE</span><span class="p">;</span>
	<span class="n">wbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">category</span><span class="p">;</span>
	<span class="n">wbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">m5mols_swap_byte</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isp_ready</span><span class="p">)</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;write failed: cat:%02x cmd:%02x ret:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">category</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * m5mols_busy_wait - Busy waiting with I2C register polling</span>
<span class="cm"> * @reg: the I2C_REG() address of an 8-bit status register to check</span>
<span class="cm"> * @value: expected status register value</span>
<span class="cm"> * @mask: bit mask for the read status register value</span>
<span class="cm"> * @timeout: timeout in miliseconds, or -1 for default timeout</span>
<span class="cm"> *</span>
<span class="cm"> * The @reg register value is ORed with @mask before comparing with @value.</span>
<span class="cm"> *</span>
<span class="cm"> * Return: 0 if the requested condition became true within less than</span>
<span class="cm"> *         @timeout ms, or else negative errno.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">m5mols_busy_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ms</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">M5MOLS_BUSY_WAIT_DEF_TIMEOUT</span> <span class="o">:</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u8</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">M5MOLS_I2C_RDY_WAIT_FL</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ms</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">time_is_after_jiffies</span><span class="p">(</span><span class="n">end</span><span class="p">));</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * m5mols_enable_interrupt - Clear interrupt pending bits and unmask interrupts</span>
<span class="cm"> *</span>
<span class="cm"> * Before writing desired interrupt value the INT_FACTOR register should</span>
<span class="cm"> * be read to clear pending interrupts.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">m5mols_enable_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">is_available_af</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">?</span> <span class="n">REG_INT_AF</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u8</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_INT_FACTOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_INT_ENABLE</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">m5mols_wait_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_waitq</span><span class="p">,</span>
				<span class="n">atomic_add_unless</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_done</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">m5mols_busy_wait</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_INT_FACTOR</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">,</span>
				<span class="n">M5MOLS_I2C_RDY_WAIT_FL</span> <span class="o">|</span> <span class="n">irq_mask</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * m5mols_reg_mode - Write the mode and check busy status</span>
<span class="cm"> *</span>
<span class="cm"> * It always accompanies a little delay changing the M-5MOLS mode, so it is</span>
<span class="cm"> * needed checking current busy status to guarantee right mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_reg_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_SYSMODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">m5mols_busy_wait</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_SYSMODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
				<span class="n">M5MOLS_MODE_CHANGE_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * m5mols_set_mode - set the M-5MOLS controller mode</span>
<span class="cm"> * @mode: the required operation mode</span>
<span class="cm"> *</span>
<span class="cm"> * The commands of M-5MOLS are grouped into specific modes. Each functionality</span>
<span class="cm"> * can be guaranteed only when the sensor is operating in mode which a command</span>
<span class="cm"> * belongs to.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">m5mols_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="n">REG_PARAMETER</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">&gt;</span> <span class="n">REG_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u8</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_SYSMODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">REG_PARAMETER</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_reg_mode</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">REG_MONITOR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">REG_MONITOR</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_reg_mode</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">REG_CAPTURE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">REG_MONITOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">REG_PARAMETER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_reg_mode</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">REG_PARAMETER</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_reg_mode</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">REG_CAPTURE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">REG_CAPTURE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_reg_mode</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">REG_MONITOR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">REG_MONITOR</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_reg_mode</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">REG_PARAMETER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Wrong mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * m5mols_get_version - retrieve full revisions information of M-5MOLS</span>
<span class="cm"> *</span>
<span class="cm"> * The version information includes revisions of hardware and firmware,</span>
<span class="cm"> * AutoFocus alghorithm version and the version string.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_get_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">m5mols_version</span> <span class="o">*</span><span class="n">ver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ver</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">ver</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u8</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_VER_CUSTOMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">customer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u8</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_VER_PROJECT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">project</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u16</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_VER_FIRMWARE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u16</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_VER_HARDWARE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u16</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_VER_PARAMETER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u16</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_VER_AWB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">awb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u8</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AF_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">af</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VERSION_STRING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_read_u8</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_VER_STRING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ver</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">);</span>
	<span class="n">ver</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">ver</span><span class="o">-&gt;</span><span class="n">param</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
	<span class="n">ver</span><span class="o">-&gt;</span><span class="n">awb</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">awb</span><span class="p">);</span>

	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Manufacturer</span><span class="se">\t</span><span class="s">[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">is_manufacturer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">REG_SAMSUNG_ELECTRO</span><span class="p">)</span> <span class="o">?</span>
			<span class="s">&quot;Samsung Electro-Machanics&quot;</span> <span class="o">:</span>
			<span class="n">is_manufacturer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">REG_SAMSUNG_OPTICS</span><span class="p">)</span> <span class="o">?</span>
			<span class="s">&quot;Samsung Fiber-Optics&quot;</span> <span class="o">:</span>
			<span class="n">is_manufacturer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">REG_SAMSUNG_TECHWIN</span><span class="p">)</span> <span class="o">?</span>
			<span class="s">&quot;Samsung Techwin&quot;</span> <span class="o">:</span> <span class="s">&quot;None&quot;</span><span class="p">);</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Customer/Project</span><span class="se">\t</span><span class="s">[0x%02x/0x%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ver</span><span class="p">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ver</span><span class="p">.</span><span class="n">project</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_available_af</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;No support Auto Focus on this firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __find_restype - Lookup M-5MOLS resolution type according to pixel code</span>
<span class="cm"> * @code: pixel code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">m5mols_restype</span> <span class="nf">__find_restype</span><span class="p">(</span><span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">m5mols_restype</span> <span class="n">type</span> <span class="o">=</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">m5mols_default_ffmt</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">code</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">type</span><span class="o">++</span> <span class="o">!=</span> <span class="n">SIZE_DEFAULT_FFMT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __find_resolution - Lookup preset and type of M-5MOLS&#39;s resolution</span>
<span class="cm"> * @mf: pixel format to find/negotiate the resolution preset for</span>
<span class="cm"> * @type: M-5MOLS resolution type</span>
<span class="cm"> * @resolution:	M-5MOLS resolution preset register value</span>
<span class="cm"> *</span>
<span class="cm"> * Find nearest resolution matching resolution preset and adjust mf</span>
<span class="cm"> * to supported values.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__find_resolution</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">m5mols_restype</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="o">*</span><span class="n">resolution</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">m5mols_resolution</span> <span class="o">*</span><span class="n">fsize</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m5mols_reg_res</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">m5mols_resolution</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">m5mols_restype</span> <span class="n">stype</span> <span class="o">=</span> <span class="n">__find_restype</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">m5mols_reg_res</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_err</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stype</span> <span class="o">==</span> <span class="n">fsize</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">fsize</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">abs</span><span class="p">(</span><span class="n">fsize</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="n">min_err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">min_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">match</span> <span class="o">=</span> <span class="n">fsize</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">fsize</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>  <span class="o">=</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="o">*</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">stype</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="nf">__find_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">v4l2_subdev_format_whence</span> <span class="n">which</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">m5mols_restype</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fh</span> <span class="o">?</span> <span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ffmt</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_get_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">__find_format</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">format</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_set_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">sfmt</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">m5mols_restype</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">resolution</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__find_resolution</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resolution</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sfmt</span> <span class="o">=</span> <span class="n">__find_format</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">m5mols_default_ffmt</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
	<span class="n">format</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">;</span>
	<span class="n">format</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">sfmt</span> <span class="o">=</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_enum_mbus_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_subdev_mbus_code_enum</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">code</span> <span class="o">||</span> <span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">SIZE_DEFAULT_FFMT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">m5mols_default_ffmt</span><span class="p">[</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_pad_ops</span> <span class="n">m5mols_pad_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enum_mbus_code</span>	<span class="o">=</span> <span class="n">m5mols_enum_mbus_code</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fmt</span>	<span class="o">=</span> <span class="n">m5mols_get_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>	<span class="o">=</span> <span class="n">m5mols_set_fmt</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * m5mols_restore_controls - Apply current control values to the registers</span>
<span class="cm"> *</span>
<span class="cm"> * m5mols_do_scenemode() handles all parameters for which there is yet no</span>
<span class="cm"> * individual control. It should be replaced at some point by setting each</span>
<span class="cm"> * control individually, in required register set up order.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">m5mols_restore_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ctrl_sync</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_do_scenemode</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">REG_SCENE_NORMAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ctrl_sync</span> <span class="o">=</span> <span class="o">!</span><span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * m5mols_start_monitor - Start the monitor mode</span>
<span class="cm"> *</span>
<span class="cm"> * Before applying the controls setup the resolution and frame rate</span>
<span class="cm"> * in PARAMETER mode, and then switch over to MONITOR mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_start_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_mode</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">REG_PARAMETER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PARM_MON_SIZE</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">resolution</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PARM_MON_FPS</span><span class="p">,</span> <span class="n">REG_FPS_30</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_mode</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">REG_MONITOR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_restore_controls</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_s_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">code</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ffmt</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">res_type</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_start_monitor</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">M5MOLS_RESTYPE_CAPTURE</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_start_capture</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">m5mols_set_mode</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">REG_PARAMETER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">m5mols_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_stream</span>	<span class="o">=</span> <span class="n">m5mols_s_stream</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_sensor_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">m5mols_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">==</span> <span class="n">enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_bulk_enable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">supplies</span><span class="p">),</span> <span class="n">supplies</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">,</span> <span class="o">!</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">reset_polarity</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_bulk_disable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">supplies</span><span class="p">),</span> <span class="n">supplies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">reset_polarity</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">isp_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* m5mols_update_fw - optional firmware update routine */</span>
<span class="kt">int</span> <span class="nf">__attribute__</span> <span class="p">((</span><span class="n">weak</span><span class="p">))</span> <span class="n">m5mols_update_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_power</span><span class="p">)(</span><span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="p">,</span> <span class="n">bool</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * m5mols_fw_start - M-5MOLS internal ARM controller initialization</span>
<span class="cm"> *</span>
<span class="cm"> * Execute the M-5MOLS internal ARM controller initialization sequence.</span>
<span class="cm"> * This function should be called after the supply voltage has been</span>
<span class="cm"> * applied and before any requests to the device are made.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_fw_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_done</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Wait until I2C slave is initialized in Flash Writer mode */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_busy_wait</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">FLASH_CAM_START</span><span class="p">,</span> <span class="n">REG_IN_FLASH_MODE</span><span class="p">,</span>
			       <span class="n">M5MOLS_I2C_RDY_WAIT_FL</span> <span class="o">|</span> <span class="mh">0xff</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">FLASH_CAM_START</span><span class="p">,</span> <span class="n">REG_START_ARM_BOOT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_wait_interrupt</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">REG_INT_MODE</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">isp_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_get_version</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_update_fw</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">m5mols_sensor_power</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m5mols_debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Success ARM Booting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">PARM_INTERFACE</span><span class="p">,</span> <span class="n">REG_INTERFACE_MIPI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_enable_interrupt</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span>
				<span class="n">REG_INT_AF</span> <span class="o">|</span> <span class="n">REG_INT_CAPTURE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * m5mols_s_power - Main sensor power control function</span>
<span class="cm"> *</span>
<span class="cm"> * To prevent breaking the lens when the sensor is powered off the Soft-Landing</span>
<span class="cm"> * algorithm is called where available. The Soft-Landing algorithm availability</span>
<span class="cm"> * dependends on the firmware provider.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_s_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_sensor_power</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_fw_start</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_manufacturer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">REG_SAMSUNG_TECHWIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_set_mode</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">REG_MONITOR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AF_EXECUTE</span><span class="p">,</span> <span class="n">REG_AF_STOP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">AF_MODE</span><span class="p">,</span> <span class="n">REG_AF_POWEROFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_busy_wait</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">SYSTEM_STATUS</span><span class="p">,</span> <span class="n">REG_AF_IDLE</span><span class="p">,</span>
					       <span class="mh">0xff</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">v4l2_warn</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Soft landing lens failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_sensor_power</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ctrl_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_log_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">v4l2_ctrl_handler_log_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">m5mols_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_power</span>	<span class="o">=</span> <span class="n">m5mols_s_power</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_ctrl</span>		<span class="o">=</span> <span class="n">v4l2_subdev_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ctrl</span>		<span class="o">=</span> <span class="n">v4l2_subdev_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queryctrl</span>	<span class="o">=</span> <span class="n">v4l2_subdev_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">querymenu</span>	<span class="o">=</span> <span class="n">v4l2_subdev_querymenu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_ext_ctrls</span>	<span class="o">=</span> <span class="n">v4l2_subdev_g_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_ext_ctrls</span>	<span class="o">=</span> <span class="n">v4l2_subdev_try_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ext_ctrls</span>	<span class="o">=</span> <span class="n">v4l2_subdev_s_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">log_status</span>	<span class="o">=</span> <span class="n">m5mols_log_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * V4L2 subdev internal operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m5mols_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="n">m5mols_default_ffmt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_internal_ops</span> <span class="n">m5mols_subdev_internal_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">m5mols_open</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">m5mols_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">m5mols_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pad</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">m5mols_pad_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">m5mols_video_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">m5mols_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_done</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_waitq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">m5mols_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">m5mols_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No valid RESET GPIO specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Interrupt not assigned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">m5mols_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">set_power</span>	<span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">,</span> <span class="s">&quot;M5MOLS_NRST&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to request gpio: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">reset_polarity</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_bulk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">supplies</span><span class="p">),</span> <span class="n">supplies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get regulators: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_gpio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m5mols_ops</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">MODULE_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_SUBDEV_FL_HAS_DEVNODE</span><span class="p">;</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">internal_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m5mols_subdev_internal_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SOURCE</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_reg</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV_SENSOR</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_waitq</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">m5mols_irq_handler</span><span class="p">,</span>
			  <span class="n">IRQF_TRIGGER_RISING</span><span class="p">,</span> <span class="n">MODULE_NAME</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Interrupt request failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_me</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">M5MOLS_RESTYPE_MONITOR</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ffmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">m5mols_default_ffmt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ffmt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>	<span class="n">m5mols_default_ffmt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_sensor_power</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_me</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_fw_start</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">m5mols_init_controls</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">m5mols_sensor_power</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_me:</span>
	<span class="n">media_entity_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>
<span class="nl">out_reg:</span>
	<span class="n">regulator_bulk_free</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">supplies</span><span class="p">),</span> <span class="n">supplies</span><span class="p">);</span>
<span class="nl">out_gpio:</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">m5mols_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">m5mols_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">to_m5mols</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>

	<span class="n">regulator_bulk_free</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">supplies</span><span class="p">),</span> <span class="n">supplies</span><span class="p">);</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">);</span>
	<span class="n">media_entity_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">m5mols_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">MODULE_NAME</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">m5mols_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">m5mols_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">m5mols_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">m5mols_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">m5mols_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">m5mols_i2c_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;HeungJun Kim &lt;riverful.kim@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Dongsoo Kim &lt;dongsoo45.kim@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Fujitsu M-5MOLS 8M Pixel camera driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
