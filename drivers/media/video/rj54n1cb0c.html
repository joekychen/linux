<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › rj54n1cb0c.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rj54n1cb0c.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for RJ54N1CB0C CMOS Image Sensor from Sharp</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009, Guennadi Liakhovetski &lt;g.liakhovetski@gmx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/v4l2-mediabus.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;media/rj54n1cb0c.h&gt;</span>
<span class="cp">#include &lt;media/soc_camera.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-subdev.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>

<span class="cp">#define RJ54N1_DEV_CODE			0x0400</span>
<span class="cp">#define RJ54N1_DEV_CODE2		0x0401</span>
<span class="cp">#define RJ54N1_OUT_SEL			0x0403</span>
<span class="cp">#define RJ54N1_XY_OUTPUT_SIZE_S_H	0x0404</span>
<span class="cp">#define RJ54N1_X_OUTPUT_SIZE_S_L	0x0405</span>
<span class="cp">#define RJ54N1_Y_OUTPUT_SIZE_S_L	0x0406</span>
<span class="cp">#define RJ54N1_XY_OUTPUT_SIZE_P_H	0x0407</span>
<span class="cp">#define RJ54N1_X_OUTPUT_SIZE_P_L	0x0408</span>
<span class="cp">#define RJ54N1_Y_OUTPUT_SIZE_P_L	0x0409</span>
<span class="cp">#define RJ54N1_LINE_LENGTH_PCK_S_H	0x040a</span>
<span class="cp">#define RJ54N1_LINE_LENGTH_PCK_S_L	0x040b</span>
<span class="cp">#define RJ54N1_LINE_LENGTH_PCK_P_H	0x040c</span>
<span class="cp">#define RJ54N1_LINE_LENGTH_PCK_P_L	0x040d</span>
<span class="cp">#define RJ54N1_RESIZE_N			0x040e</span>
<span class="cp">#define RJ54N1_RESIZE_N_STEP		0x040f</span>
<span class="cp">#define RJ54N1_RESIZE_STEP		0x0410</span>
<span class="cp">#define RJ54N1_RESIZE_HOLD_H		0x0411</span>
<span class="cp">#define RJ54N1_RESIZE_HOLD_L		0x0412</span>
<span class="cp">#define RJ54N1_H_OBEN_OFS		0x0413</span>
<span class="cp">#define RJ54N1_V_OBEN_OFS		0x0414</span>
<span class="cp">#define RJ54N1_RESIZE_CONTROL		0x0415</span>
<span class="cp">#define RJ54N1_STILL_CONTROL		0x0417</span>
<span class="cp">#define RJ54N1_INC_USE_SEL_H		0x0425</span>
<span class="cp">#define RJ54N1_INC_USE_SEL_L		0x0426</span>
<span class="cp">#define RJ54N1_MIRROR_STILL_MODE	0x0427</span>
<span class="cp">#define RJ54N1_INIT_START		0x0428</span>
<span class="cp">#define RJ54N1_SCALE_1_2_LEV		0x0429</span>
<span class="cp">#define RJ54N1_SCALE_4_LEV		0x042a</span>
<span class="cp">#define RJ54N1_Y_GAIN			0x04d8</span>
<span class="cp">#define RJ54N1_APT_GAIN_UP		0x04fa</span>
<span class="cp">#define RJ54N1_RA_SEL_UL		0x0530</span>
<span class="cp">#define RJ54N1_BYTE_SWAP		0x0531</span>
<span class="cp">#define RJ54N1_OUT_SIGPO		0x053b</span>
<span class="cp">#define RJ54N1_WB_SEL_WEIGHT_I		0x054e</span>
<span class="cp">#define RJ54N1_BIT8_WB			0x0569</span>
<span class="cp">#define RJ54N1_HCAPS_WB			0x056a</span>
<span class="cp">#define RJ54N1_VCAPS_WB			0x056b</span>
<span class="cp">#define RJ54N1_HCAPE_WB			0x056c</span>
<span class="cp">#define RJ54N1_VCAPE_WB			0x056d</span>
<span class="cp">#define RJ54N1_EXPOSURE_CONTROL		0x058c</span>
<span class="cp">#define RJ54N1_FRAME_LENGTH_S_H		0x0595</span>
<span class="cp">#define RJ54N1_FRAME_LENGTH_S_L		0x0596</span>
<span class="cp">#define RJ54N1_FRAME_LENGTH_P_H		0x0597</span>
<span class="cp">#define RJ54N1_FRAME_LENGTH_P_L		0x0598</span>
<span class="cp">#define RJ54N1_PEAK_H			0x05b7</span>
<span class="cp">#define RJ54N1_PEAK_50			0x05b8</span>
<span class="cp">#define RJ54N1_PEAK_60			0x05b9</span>
<span class="cp">#define RJ54N1_PEAK_DIFF		0x05ba</span>
<span class="cp">#define RJ54N1_IOC			0x05ef</span>
<span class="cp">#define RJ54N1_TG_BYPASS		0x0700</span>
<span class="cp">#define RJ54N1_PLL_L			0x0701</span>
<span class="cp">#define RJ54N1_PLL_N			0x0702</span>
<span class="cp">#define RJ54N1_PLL_EN			0x0704</span>
<span class="cp">#define RJ54N1_RATIO_TG			0x0706</span>
<span class="cp">#define RJ54N1_RATIO_T			0x0707</span>
<span class="cp">#define RJ54N1_RATIO_R			0x0708</span>
<span class="cp">#define RJ54N1_RAMP_TGCLK_EN		0x0709</span>
<span class="cp">#define RJ54N1_OCLK_DSP			0x0710</span>
<span class="cp">#define RJ54N1_RATIO_OP			0x0711</span>
<span class="cp">#define RJ54N1_RATIO_O			0x0712</span>
<span class="cp">#define RJ54N1_OCLK_SEL_EN		0x0713</span>
<span class="cp">#define RJ54N1_CLK_RST			0x0717</span>
<span class="cp">#define RJ54N1_RESET_STANDBY		0x0718</span>
<span class="cp">#define RJ54N1_FWFLG			0x07fe</span>

<span class="cp">#define E_EXCLK				(1 &lt;&lt; 7)</span>
<span class="cp">#define SOFT_STDBY			(1 &lt;&lt; 4)</span>
<span class="cp">#define SEN_RSTX			(1 &lt;&lt; 2)</span>
<span class="cp">#define TG_RSTX				(1 &lt;&lt; 1)</span>
<span class="cp">#define DSP_RSTX			(1 &lt;&lt; 0)</span>

<span class="cp">#define RESIZE_HOLD_SEL			(1 &lt;&lt; 2)</span>
<span class="cp">#define RESIZE_GO			(1 &lt;&lt; 1)</span>

<span class="cm">/*</span>
<span class="cm"> * When cropping, the camera automatically centers the cropped region, there</span>
<span class="cm"> * doesn&#39;t seem to be a way to specify an explicit location of the rectangle.</span>
<span class="cm"> */</span>
<span class="cp">#define RJ54N1_COLUMN_SKIP		0</span>
<span class="cp">#define RJ54N1_ROW_SKIP			0</span>
<span class="cp">#define RJ54N1_MAX_WIDTH		1600</span>
<span class="cp">#define RJ54N1_MAX_HEIGHT		1200</span>

<span class="cp">#define PLL_L				2</span>
<span class="cp">#define PLL_N				0x31</span>

<span class="cm">/* I2C addresses: 0x50, 0x51, 0x60, 0x61 */</span>

<span class="cm">/* RJ54N1CB0C has only one fixed colorspace per pixelcode */</span>
<span class="k">struct</span> <span class="n">rj54n1_datafmt</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span>	<span class="n">code</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_colorspace</span>		<span class="n">colorspace</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Find a data format by a pixel code in an array */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rj54n1_datafmt</span> <span class="o">*</span><span class="nf">rj54n1_find_datafmt</span><span class="p">(</span>
	<span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">code</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rj54n1_datafmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">code</span> <span class="o">==</span> <span class="n">code</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">fmt</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rj54n1_datafmt</span> <span class="n">rj54n1_colour_fmts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span><span class="p">,</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">},</span>
	<span class="p">{</span><span class="n">V4L2_MBUS_FMT_YVYU8_2X8</span><span class="p">,</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">},</span>
	<span class="p">{</span><span class="n">V4L2_MBUS_FMT_RGB565_2X8_LE</span><span class="p">,</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">},</span>
	<span class="p">{</span><span class="n">V4L2_MBUS_FMT_RGB565_2X8_BE</span><span class="p">,</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">},</span>
	<span class="p">{</span><span class="n">V4L2_MBUS_FMT_SBGGR10_2X8_PADHI_LE</span><span class="p">,</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">},</span>
	<span class="p">{</span><span class="n">V4L2_MBUS_FMT_SBGGR10_2X8_PADLO_LE</span><span class="p">,</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">},</span>
	<span class="p">{</span><span class="n">V4L2_MBUS_FMT_SBGGR10_2X8_PADHI_BE</span><span class="p">,</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">},</span>
	<span class="p">{</span><span class="n">V4L2_MBUS_FMT_SBGGR10_2X8_PADLO_BE</span><span class="p">,</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">},</span>
	<span class="p">{</span><span class="n">V4L2_MBUS_FMT_SBGGR10_1X10</span><span class="p">,</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rj54n1_clock_div</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">ratio_tg</span><span class="p">;</span>	<span class="cm">/* can be 0 or an odd number */</span>
	<span class="n">u8</span> <span class="n">ratio_t</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ratio_r</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ratio_op</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ratio_o</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rj54n1</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="n">hdl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rj54n1_clock_div</span> <span class="n">clk_div</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rj54n1_datafmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">rect</span><span class="p">;</span>	<span class="cm">/* Sensor window */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tgclk_mhz</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">auto_wb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">width</span><span class="p">;</span>	<span class="cm">/* Output window */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">height</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">resize</span><span class="p">;</span>	<span class="cm">/* Sensor * 1024 / resize = Output */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">scale</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bank</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rj54n1_reg_val</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rj54n1_reg_val</span> <span class="n">bank_4</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x417</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x42c</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x42d</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x42e</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x42f</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x430</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x431</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x432</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x433</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x434</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x43c</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x43e</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x445</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x4ba</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x4bb</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x4bc</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x4db</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x4fe</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rj54n1_reg_val</span> <span class="n">bank_5</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x514</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x516</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x518</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x51a</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x51d</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x56f</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x575</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x5bc</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x5c1</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x5e5</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x5e6</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x5e7</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x5e8</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x5e9</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x5ea</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x5eb</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x5ec</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x5fe</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rj54n1_reg_val</span> <span class="n">bank_7</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x70a</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x714</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x715</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x716</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x7FE</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rj54n1_reg_val</span> <span class="n">bank_8</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x800</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x801</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x802</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x805</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x806</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x807</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x808</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x809</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x80A</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x80B</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x80C</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x80D</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x80E</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x80F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x810</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x811</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x812</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x813</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x814</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x815</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x816</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x817</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x818</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x819</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x81A</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x81B</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x81C</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x81D</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x81E</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x81F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x820</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x821</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x822</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x823</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x824</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x825</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x826</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x827</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x828</span><span class="p">,</span> <span class="mh">0x4F</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x829</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x82A</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x82B</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x82C</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x82D</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x82E</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x82F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x830</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x831</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x832</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x833</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x834</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x835</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x836</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x837</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x838</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x839</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x83A</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x83B</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x83C</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x83D</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x83E</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x83F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x840</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x841</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x842</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x843</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x844</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x845</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x846</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x847</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x848</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x849</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x84A</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x84B</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x84C</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x84D</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x84E</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x84F</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x850</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x851</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x852</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x853</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x854</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x855</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x856</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x857</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x858</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x859</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x85A</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x85B</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x85C</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x85D</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x85E</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x85F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x860</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x861</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x862</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x863</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x864</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x865</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x866</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x867</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x868</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x869</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x86A</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x86B</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x86C</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x86D</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x86E</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x86F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x870</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x871</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x872</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x873</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x874</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x875</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x876</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x877</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x878</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x879</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x87A</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x87B</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x87C</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x87D</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x87E</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x87F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x880</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x881</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x882</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x883</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x884</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x885</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x886</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x887</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x888</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x889</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x88A</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x88B</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x88C</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x88D</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x88E</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x88F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x890</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x891</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x892</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x893</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x894</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x895</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x896</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x897</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x898</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x899</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x89A</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x89B</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x89C</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x89D</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x89E</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x89F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8A0</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8A1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8A2</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8A3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8A4</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8A5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8A6</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8A7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8A8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8A9</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8AA</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8AB</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8AC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8AD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8AE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8AF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8B0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8B1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8B6</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8B7</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8B8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8B9</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8BA</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8BB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8BC</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8BD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8FE</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rj54n1_reg_val</span> <span class="n">bank_10</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x10bf</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Clock dividers - these are default register values, divider = register + 1 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rj54n1_clock_div</span> <span class="n">clk_div</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ratio_tg</span>	<span class="o">=</span> <span class="mi">3</span> <span class="cm">/* default: 5 */</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ratio_t</span>	<span class="o">=</span> <span class="mi">4</span> <span class="cm">/* default: 1 */</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ratio_r</span>	<span class="o">=</span> <span class="mi">4</span> <span class="cm">/* default: 0 */</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ratio_op</span>	<span class="o">=</span> <span class="mi">1</span> <span class="cm">/* default: 5 */</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ratio_o</span>	<span class="o">=</span> <span class="mi">9</span> <span class="cm">/* default: 0 */</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="nf">to_rj54n1</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">),</span> <span class="k">struct</span> <span class="n">rj54n1</span><span class="p">,</span> <span class="n">subdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="n">rj54n1</span> <span class="o">=</span> <span class="n">to_rj54n1</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set bank */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">!=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[0x%x] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span>
		     <span class="k">const</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="n">rj54n1</span> <span class="o">=</span> <span class="n">to_rj54n1</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set bank */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">!=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[0x%x] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[0x%x] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reg_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span>
		   <span class="k">const</span> <span class="n">u8</span> <span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reg_write_multiple</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">rj54n1_reg_val</span> <span class="o">*</span><span class="n">rv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">rv</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">rv</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">rv</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_enum_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rj54n1_colour_fmts</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">code</span> <span class="o">=</span> <span class="n">rj54n1_colour_fmts</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_s_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="cm">/* Switch between preview and still shot modes */</span>
	<span class="k">return</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_STILL_CONTROL</span><span class="p">,</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_set_rect</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">reg_x</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg_y</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg_xy</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg_xy</span><span class="p">,</span>
			<span class="p">((</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg_x</span><span class="p">,</span> <span class="n">width</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg_y</span><span class="p">,</span> <span class="n">height</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Some commands, specifically certain initialisation sequences, require</span>
<span class="cm"> * a commit operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_INIT_START</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_INIT_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rj54n1_sensor_scale</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">in_w</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">in_h</span><span class="p">,</span>
			       <span class="n">s32</span> <span class="o">*</span><span class="n">out_w</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">out_h</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_s_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="n">rj54n1</span> <span class="o">=</span> <span class="n">to_rj54n1</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dummy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">output_w</span><span class="p">,</span> <span class="n">output_h</span><span class="p">,</span>
		<span class="n">input_w</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">input_h</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* arbitrary minimum width and height, edges unimportant */</span>
	<span class="n">soc_camera_limit_side</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_w</span><span class="p">,</span>
		     <span class="n">RJ54N1_COLUMN_SKIP</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">RJ54N1_MAX_WIDTH</span><span class="p">);</span>

	<span class="n">soc_camera_limit_side</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_h</span><span class="p">,</span>
		     <span class="n">RJ54N1_ROW_SKIP</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">RJ54N1_MAX_HEIGHT</span><span class="p">);</span>

	<span class="n">output_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_w</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">resize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">resize</span><span class="p">;</span>
	<span class="n">output_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_h</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">resize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">resize</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Scaling for %dx%d : %u = %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">input_w</span><span class="p">,</span> <span class="n">input_h</span><span class="p">,</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">resize</span><span class="p">,</span> <span class="n">output_w</span><span class="p">,</span> <span class="n">output_h</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rj54n1_sensor_scale</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output_w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output_h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">width</span>		<span class="o">=</span> <span class="n">output_w</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">height</span>		<span class="o">=</span> <span class="n">output_h</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">resize</span>		<span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="n">input_w</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="n">input_h</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="n">rj54n1</span> <span class="o">=</span> <span class="n">to_rj54n1</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span>	<span class="o">=</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span>			<span class="o">=</span> <span class="n">RJ54N1_COLUMN_SKIP</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span>			<span class="o">=</span> <span class="n">RJ54N1_ROW_SKIP</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span>			<span class="o">=</span> <span class="n">RJ54N1_MAX_WIDTH</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="n">RJ54N1_MAX_HEIGHT</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">defrect</span>			<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>				<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_g_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="n">rj54n1</span> <span class="o">=</span> <span class="n">to_rj54n1</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span>	<span class="o">=</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The actual geometry configuration routine. It scales the input window into</span>
<span class="cm"> * the output one, updates the window sizes and returns an error or the resize</span>
<span class="cm"> * coefficient on success. Note: we only use the &quot;Fixed Scaling&quot; on this camera.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_sensor_scale</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">in_w</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">in_h</span><span class="p">,</span>
			       <span class="n">s32</span> <span class="o">*</span><span class="n">out_w</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">out_h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="n">rj54n1</span> <span class="o">=</span> <span class="n">to_rj54n1</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skip</span><span class="p">,</span> <span class="n">resize</span><span class="p">,</span> <span class="n">input_w</span> <span class="o">=</span> <span class="o">*</span><span class="n">in_w</span><span class="p">,</span> <span class="n">input_h</span> <span class="o">=</span> <span class="o">*</span><span class="n">in_h</span><span class="p">,</span>
		<span class="n">output_w</span> <span class="o">=</span> <span class="o">*</span><span class="n">out_w</span><span class="p">,</span> <span class="n">output_h</span> <span class="o">=</span> <span class="o">*</span><span class="n">out_h</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">inc_sel</span><span class="p">,</span> <span class="n">wb_bit8</span><span class="p">,</span> <span class="n">wb_left</span><span class="p">,</span> <span class="n">wb_right</span><span class="p">,</span> <span class="n">wb_top</span><span class="p">,</span> <span class="n">wb_bottom</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">peak</span><span class="p">,</span> <span class="n">peak_50</span><span class="p">,</span> <span class="n">peak_60</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have a problem with crops, where the window is larger than 512x384</span>
<span class="cm">	 * and output window is larger than a half of the input one. In this</span>
<span class="cm">	 * case we have to either reduce the input window to equal or below</span>
<span class="cm">	 * 512x384 or the output window to equal or below 1/2 of the input.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">output_w</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">(</span><span class="mi">512U</span><span class="p">,</span> <span class="n">input_w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">output_w</span> <span class="o">&gt;</span> <span class="n">RJ54N1_MAX_WIDTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_w</span> <span class="o">=</span> <span class="n">RJ54N1_MAX_WIDTH</span><span class="p">;</span>
			<span class="n">output_w</span> <span class="o">=</span> <span class="n">RJ54N1_MAX_WIDTH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">input_w</span> <span class="o">=</span> <span class="n">output_w</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Adjusted output width: in %u, out %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">input_w</span><span class="p">,</span> <span class="n">output_w</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">output_h</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">(</span><span class="mi">384U</span><span class="p">,</span> <span class="n">input_h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">output_h</span> <span class="o">&gt;</span> <span class="n">RJ54N1_MAX_HEIGHT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_h</span> <span class="o">=</span> <span class="n">RJ54N1_MAX_HEIGHT</span><span class="p">;</span>
			<span class="n">output_h</span> <span class="o">=</span> <span class="n">RJ54N1_MAX_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">input_h</span> <span class="o">=</span> <span class="n">output_h</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Adjusted output height: in %u, out %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">input_h</span><span class="p">,</span> <span class="n">output_h</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Idea: use the read mode for snapshots, handle separate geometries */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rj54n1_set_rect</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_X_OUTPUT_SIZE_S_L</span><span class="p">,</span>
			      <span class="n">RJ54N1_Y_OUTPUT_SIZE_S_L</span><span class="p">,</span>
			      <span class="n">RJ54N1_XY_OUTPUT_SIZE_S_H</span><span class="p">,</span> <span class="n">output_w</span><span class="p">,</span> <span class="n">output_h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rj54n1_set_rect</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_X_OUTPUT_SIZE_P_L</span><span class="p">,</span>
			      <span class="n">RJ54N1_Y_OUTPUT_SIZE_P_L</span><span class="p">,</span>
			      <span class="n">RJ54N1_XY_OUTPUT_SIZE_P_H</span><span class="p">,</span> <span class="n">output_w</span><span class="p">,</span> <span class="n">output_h</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">output_w</span> <span class="o">&gt;</span> <span class="n">input_w</span> <span class="o">&amp;&amp;</span> <span class="n">output_h</span> <span class="o">&gt;</span> <span class="n">input_h</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_w</span> <span class="o">=</span> <span class="n">output_w</span><span class="p">;</span>
		<span class="n">input_h</span> <span class="o">=</span> <span class="n">output_h</span><span class="p">;</span>

		<span class="n">resize</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">resize_x</span><span class="p">,</span> <span class="n">resize_y</span><span class="p">;</span>
		<span class="n">resize_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_w</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="n">output_w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">output_w</span><span class="p">;</span>
		<span class="n">resize_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_h</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="n">output_h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">output_h</span><span class="p">;</span>

		<span class="cm">/* We want max(resize_x, resize_y), check if it still fits */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resize_x</span> <span class="o">&gt;</span> <span class="n">resize_y</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">output_h</span> <span class="o">*</span> <span class="n">resize_x</span> <span class="o">+</span> <span class="mi">512</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">&gt;</span> <span class="n">RJ54N1_MAX_HEIGHT</span><span class="p">)</span>
			<span class="n">resize</span> <span class="o">=</span> <span class="p">(</span><span class="n">RJ54N1_MAX_HEIGHT</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="n">output_h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">output_h</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resize_y</span> <span class="o">&gt;</span> <span class="n">resize_x</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">output_w</span> <span class="o">*</span> <span class="n">resize_y</span> <span class="o">+</span> <span class="mi">512</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">&gt;</span> <span class="n">RJ54N1_MAX_WIDTH</span><span class="p">)</span>
			<span class="n">resize</span> <span class="o">=</span> <span class="p">(</span><span class="n">RJ54N1_MAX_WIDTH</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="n">output_w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">output_w</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">resize</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">resize_x</span><span class="p">,</span> <span class="n">resize_y</span><span class="p">);</span>

		<span class="cm">/* Prohibited value ranges */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">resize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2040</span> <span class="p">...</span> <span class="mi">2047</span>:
			<span class="n">resize</span> <span class="o">=</span> <span class="mi">2039</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4080</span> <span class="p">...</span> <span class="mi">4095</span>:
			<span class="n">resize</span> <span class="o">=</span> <span class="mi">4079</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8160</span> <span class="p">...</span> <span class="mi">8191</span>:
			<span class="n">resize</span> <span class="o">=</span> <span class="mi">8159</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16320</span> <span class="p">...</span> <span class="mi">16384</span>:
			<span class="n">resize</span> <span class="o">=</span> <span class="mi">16319</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set scaling */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RESIZE_HOLD_L</span><span class="p">,</span> <span class="n">resize</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RESIZE_HOLD_H</span><span class="p">,</span> <span class="n">resize</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure a skipping bitmask. The sensor will select a skipping value</span>
<span class="cm">	 * among set bits automatically. This is very unclear in the datasheet</span>
<span class="cm">	 * too. I was told, in this register one enables all skipping values,</span>
<span class="cm">	 * that are required for a specific resize, and the camera selects</span>
<span class="cm">	 * automatically, which ones to use. But it is unclear how to identify,</span>
<span class="cm">	 * which cropping values are needed. Secondly, why don&#39;t we just set all</span>
<span class="cm">	 * bits and let the camera choose? Would it increase processing time and</span>
<span class="cm">	 * reduce the framerate? Using 0xfffc for INC_USE_SEL doesn&#39;t seem to</span>
<span class="cm">	 * improve the image quality or stability for larger frames (see comment</span>
<span class="cm">	 * above), but I didn&#39;t check the framerate.</span>
<span class="cm">	 */</span>
	<span class="n">skip</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">resize</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">15U</span><span class="p">);</span>

	<span class="n">inc_sel</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">skip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inc_sel</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">inc_sel</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resize</span> <span class="o">&amp;</span> <span class="mi">1023</span> <span class="o">&amp;&amp;</span> <span class="n">skip</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">inc_sel</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">skip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_INC_USE_SEL_L</span><span class="p">,</span> <span class="n">inc_sel</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_INC_USE_SEL_H</span><span class="p">,</span> <span class="n">inc_sel</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">auto_wb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Auto white balance window */</span>
		<span class="n">wb_left</span>	  <span class="o">=</span> <span class="n">output_w</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">wb_right</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">output_w</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">wb_top</span>	  <span class="o">=</span> <span class="n">output_h</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">wb_bottom</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">output_h</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">wb_bit8</span>	  <span class="o">=</span> <span class="p">((</span><span class="n">wb_left</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">wb_top</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">wb_right</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">wb_bottom</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_BIT8_WB</span><span class="p">,</span> <span class="n">wb_bit8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_HCAPS_WB</span><span class="p">,</span> <span class="n">wb_left</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_VCAPS_WB</span><span class="p">,</span> <span class="n">wb_top</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_HCAPE_WB</span><span class="p">,</span> <span class="n">wb_right</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_VCAPE_WB</span><span class="p">,</span> <span class="n">wb_bottom</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Antiflicker */</span>
	<span class="n">peak</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">RJ54N1_MAX_WIDTH</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">*</span> <span class="n">resize</span> <span class="o">/</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">tgclk_mhz</span> <span class="o">/</span>
		<span class="mi">10000</span><span class="p">;</span>
	<span class="n">peak_50</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">peak_60</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_PEAK_H</span><span class="p">,</span>
				<span class="p">((</span><span class="n">peak_50</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">peak_60</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_PEAK_50</span><span class="p">,</span> <span class="n">peak_50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_PEAK_60</span><span class="p">,</span> <span class="n">peak_60</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_PEAK_DIFF</span><span class="p">,</span> <span class="n">peak</span> <span class="o">/</span> <span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* Start resizing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RESIZE_CONTROL</span><span class="p">,</span>
				<span class="n">RESIZE_HOLD_SEL</span> <span class="o">|</span> <span class="n">RESIZE_GO</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Constant taken from manufacturer&#39;s example */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">230</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RESIZE_CONTROL</span><span class="p">,</span> <span class="n">RESIZE_HOLD_SEL</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">in_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_w</span> <span class="o">*</span> <span class="n">resize</span> <span class="o">+</span> <span class="mi">512</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="o">*</span><span class="n">in_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_h</span> <span class="o">*</span> <span class="n">resize</span> <span class="o">+</span> <span class="mi">512</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="o">*</span><span class="n">out_w</span> <span class="o">=</span> <span class="n">output_w</span><span class="p">;</span>
	<span class="o">*</span><span class="n">out_h</span> <span class="o">=</span> <span class="n">output_h</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Scaled for %dx%d : %u = %ux%u, skip %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">*</span><span class="n">in_w</span><span class="p">,</span> <span class="o">*</span><span class="n">in_h</span><span class="p">,</span> <span class="n">resize</span><span class="p">,</span> <span class="n">output_w</span><span class="p">,</span> <span class="n">output_h</span><span class="p">,</span> <span class="n">skip</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">resize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_set_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="n">rj54n1</span> <span class="o">=</span> <span class="n">to_rj54n1</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Enable external clock */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RESET_STANDBY</span><span class="p">,</span> <span class="n">E_EXCLK</span> <span class="o">|</span> <span class="n">SOFT_STDBY</span><span class="p">);</span>
	<span class="cm">/* Leave stand-by. Note: use this when implementing suspend / resume */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RESET_STANDBY</span><span class="p">,</span> <span class="n">E_EXCLK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_PLL_L</span><span class="p">,</span> <span class="n">PLL_L</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_PLL_N</span><span class="p">,</span> <span class="n">PLL_N</span><span class="p">);</span>

	<span class="cm">/* TGCLK dividers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RATIO_TG</span><span class="p">,</span>
				<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">clk_div</span><span class="p">.</span><span class="n">ratio_tg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RATIO_T</span><span class="p">,</span>
				<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">clk_div</span><span class="p">.</span><span class="n">ratio_t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RATIO_R</span><span class="p">,</span>
				<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">clk_div</span><span class="p">.</span><span class="n">ratio_r</span><span class="p">);</span>

	<span class="cm">/* Enable TGCLK &amp; RAMP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RAMP_TGCLK_EN</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* Disable clock output */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OCLK_DSP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set divisors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RATIO_OP</span><span class="p">,</span>
				<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">clk_div</span><span class="p">.</span><span class="n">ratio_op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RATIO_O</span><span class="p">,</span>
				<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">clk_div</span><span class="p">.</span><span class="n">ratio_o</span><span class="p">);</span>

	<span class="cm">/* Enable OCLK */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OCLK_SEL_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Use PLL for Timing Generator, write 2 to reserved bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_TG_BYPASS</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Take sensor out of reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RESET_STANDBY</span><span class="p">,</span>
				<span class="n">E_EXCLK</span> <span class="o">|</span> <span class="n">SEN_RSTX</span><span class="p">);</span>
	<span class="cm">/* Enable PLL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_PLL_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Wait for PLL to stabilise */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Enable clock to frequency divider */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_CLK_RST</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_CLK_RST</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Resetting RJ54N1CB0C clock failed: %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start the PLL */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OCLK_DSP</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable OCLK */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OCLK_SEL_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_reg_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="n">rj54n1</span> <span class="o">=</span> <span class="n">to_rj54n1</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">rj54n1_set_clock</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write_multiple</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">bank_7</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bank_7</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write_multiple</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">bank_10</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bank_10</span><span class="p">));</span>

	<span class="cm">/* Set binning divisors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_SCALE_1_2_LEV</span><span class="p">,</span> <span class="mi">3</span> <span class="o">|</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_SCALE_4_LEV</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">);</span>

	<span class="cm">/* Switch to fixed resize mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RESIZE_CONTROL</span><span class="p">,</span>
				<span class="n">RESIZE_HOLD_SEL</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Set gain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_Y_GAIN</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mirror the image back: default is upside down and left-to-right...</span>
<span class="cm">	 * Set manual preview / still shot switching</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_MIRROR_STILL_MODE</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write_multiple</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">bank_4</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bank_4</span><span class="p">));</span>

	<span class="cm">/* Auto exposure area */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_EXPOSURE_CONTROL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="cm">/* Check current auto WB config */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_WB_SEL_WEIGHT_I</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">auto_wb</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write_multiple</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">bank_5</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bank_5</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write_multiple</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">bank_8</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bank_8</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RESET_STANDBY</span><span class="p">,</span>
				<span class="n">E_EXCLK</span> <span class="o">|</span> <span class="n">DSP_RSTX</span> <span class="o">|</span> <span class="n">SEN_RSTX</span><span class="p">);</span>

	<span class="cm">/* Commit init */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rj54n1_commit</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="cm">/* Take DSP, TG, sensor out of reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RESET_STANDBY</span><span class="p">,</span>
				<span class="n">E_EXCLK</span> <span class="o">|</span> <span class="n">DSP_RSTX</span> <span class="o">|</span> <span class="n">TG_RSTX</span> <span class="o">|</span> <span class="n">SEN_RSTX</span><span class="p">);</span>

	<span class="cm">/* Start register update? Same register as 0x?FE in many bank_* sets */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_FWFLG</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Constant taken from manufacturer&#39;s example */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">700</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_try_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="n">rj54n1</span> <span class="o">=</span> <span class="n">to_rj54n1</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rj54n1_datafmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">align</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_1X10</span> <span class="o">||</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_2X8_PADHI_BE</span> <span class="o">||</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_2X8_PADLO_BE</span> <span class="o">||</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_2X8_PADHI_LE</span> <span class="o">||</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_2X8_PADLO_LE</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: code = %d, width = %u, height = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">rj54n1_find_datafmt</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">rj54n1_colour_fmts</span><span class="p">,</span>
				  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rj54n1_colour_fmts</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">;</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>

	<span class="n">v4l_bound_align_image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="n">RJ54N1_MAX_WIDTH</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="n">RJ54N1_MAX_HEIGHT</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_s_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="n">rj54n1</span> <span class="o">=</span> <span class="n">to_rj54n1</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rj54n1_datafmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">output_w</span><span class="p">,</span> <span class="n">output_h</span><span class="p">,</span> <span class="n">max_w</span><span class="p">,</span> <span class="n">max_h</span><span class="p">,</span>
		<span class="n">input_w</span> <span class="o">=</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">input_h</span> <span class="o">=</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The host driver can call us without .try_fmt(), so, we have to take</span>
<span class="cm">	 * care ourseleves</span>
<span class="cm">	 */</span>
	<span class="n">rj54n1_try_fmt</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Verify if the sensor has just been powered on. TODO: replace this</span>
<span class="cm">	 * with proper PM, when a suitable API is available.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RESET_STANDBY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">E_EXCLK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rj54n1_reg_init</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: code = %d, width = %u, height = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/* RA_SEL_UL is only relevant for raw modes, ignored otherwise. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OUT_SEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_BYTE_SWAP</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_YVYU8_2X8</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OUT_SEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_BYTE_SWAP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_RGB565_2X8_LE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OUT_SEL</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_BYTE_SWAP</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_RGB565_2X8_BE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OUT_SEL</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_BYTE_SWAP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_2X8_PADLO_LE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OUT_SEL</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_BYTE_SWAP</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RA_SEL_UL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_2X8_PADHI_LE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OUT_SEL</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_BYTE_SWAP</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RA_SEL_UL</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_2X8_PADLO_BE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OUT_SEL</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_BYTE_SWAP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RA_SEL_UL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_2X8_PADHI_BE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OUT_SEL</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_BYTE_SWAP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_RA_SEL_UL</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_1X10</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OUT_SEL</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Special case: a raw mode with 10 bits of data per clock tick */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OCLK_SEL_EN</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_1X10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Supported scales 1:1 &gt;= scale &gt; 1:16 */</span>
	<span class="n">max_w</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input_w</span> <span class="o">&gt;</span> <span class="n">max_w</span><span class="p">)</span>
		<span class="n">input_w</span> <span class="o">=</span> <span class="n">max_w</span><span class="p">;</span>
	<span class="n">max_h</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input_h</span> <span class="o">&gt;</span> <span class="n">max_h</span><span class="p">)</span>
		<span class="n">input_h</span> <span class="o">=</span> <span class="n">max_h</span><span class="p">;</span>

	<span class="n">output_w</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">output_h</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rj54n1_sensor_scale</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output_w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output_h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">rj54n1_find_datafmt</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">rj54n1_colour_fmts</span><span class="p">,</span>
				  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rj54n1_colour_fmts</span><span class="p">));</span>

	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">fmt</span>		<span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">resize</span>		<span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="n">input_w</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="n">input_h</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">width</span>		<span class="o">=</span> <span class="n">output_w</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">height</span>		<span class="o">=</span> <span class="n">output_h</span><span class="p">;</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>		<span class="o">=</span> <span class="n">output_w</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span>		<span class="o">=</span> <span class="n">output_h</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span>		<span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span>		<span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_CHIP_MATCH_I2C_ADDR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">.</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span>	<span class="o">=</span> <span class="n">V4L2_IDENT_RJ54N1CB0C</span><span class="p">;</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">revision</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_CHIP_MATCH_I2C_ADDR</span> <span class="o">||</span>
	    <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x400</span> <span class="o">||</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x1fff</span><span class="p">)</span>
		<span class="cm">/* Registers &gt; 0x0800 are only available from Sharp support */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">.</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_CHIP_MATCH_I2C_ADDR</span> <span class="o">||</span>
	    <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x400</span> <span class="o">||</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x1fff</span><span class="p">)</span>
		<span class="cm">/* Registers &gt;= 0x0800 are only available from Sharp support */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">.</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="n">rj54n1</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rj54n1</span><span class="p">,</span> <span class="n">hdl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_VFLIP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_MIRROR_STILL_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_MIRROR_STILL_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HFLIP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_MIRROR_STILL_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_MIRROR_STILL_MODE</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_GAIN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_Y_GAIN</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_WHITE_BALANCE</span>:
		<span class="cm">/* Auto WB area - whole image */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_WB_SEL_WEIGHT_I</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">,</span>
			    <span class="mh">0x80</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">auto_wb</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">rj54n1_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">rj54n1_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">rj54n1_subdev_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_chip_ident</span>	<span class="o">=</span> <span class="n">rj54n1_g_chip_ident</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">g_register</span>	<span class="o">=</span> <span class="n">rj54n1_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_register</span>	<span class="o">=</span> <span class="n">rj54n1_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_g_mbus_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_mbus_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span>
		<span class="n">V4L2_MBUS_PCLK_SAMPLE_RISING</span> <span class="o">|</span> <span class="n">V4L2_MBUS_PCLK_SAMPLE_FALLING</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_MASTER</span> <span class="o">|</span> <span class="n">V4L2_MBUS_DATA_ACTIVE_HIGH</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_HSYNC_ACTIVE_HIGH</span> <span class="o">|</span> <span class="n">V4L2_MBUS_VSYNC_ACTIVE_HIGH</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_MBUS_PARALLEL</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">soc_camera_apply_board_flags</span><span class="p">(</span><span class="n">icl</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_s_mbus_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_mbus_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="cm">/* Figures 2.5-1 to 2.5-3 - default falling pixclk edge */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">soc_camera_apply_board_flags</span><span class="p">(</span><span class="n">icl</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">V4L2_MBUS_PCLK_SAMPLE_RISING</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OUT_SIGPO</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_OUT_SIGPO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">rj54n1_subdev_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_stream</span>	<span class="o">=</span> <span class="n">rj54n1_s_stream</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_mbus_fmt</span>	<span class="o">=</span> <span class="n">rj54n1_s_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_mbus_fmt</span>	<span class="o">=</span> <span class="n">rj54n1_g_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_mbus_fmt</span>	<span class="o">=</span> <span class="n">rj54n1_try_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_mbus_fmt</span>	<span class="o">=</span> <span class="n">rj54n1_enum_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_crop</span>		<span class="o">=</span> <span class="n">rj54n1_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_crop</span>		<span class="o">=</span> <span class="n">rj54n1_s_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cropcap</span>	<span class="o">=</span> <span class="n">rj54n1_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_mbus_config</span>	<span class="o">=</span> <span class="n">rj54n1_g_mbus_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_mbus_config</span>	<span class="o">=</span> <span class="n">rj54n1_s_mbus_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">rj54n1_subdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">rj54n1_subdev_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">rj54n1_subdev_video_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Interface active, can use i2c. If it fails, it can indeed mean, that</span>
<span class="cm"> * this wasn&#39;t our capture interface, so, we wait for the right one</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_video_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">rj54n1_pdata</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Read out the chip version register */</span>
	<span class="n">data1</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_DEV_CODE</span><span class="p">);</span>
	<span class="n">data2</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_DEV_CODE2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data1</span> <span class="o">!=</span> <span class="mh">0x51</span> <span class="o">||</span> <span class="n">data2</span> <span class="o">!=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No RJ54N1CB0C found, read 0x%x:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ei2c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure IOCTL polarity from the platform data: 0 or 1 &lt;&lt; 7. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RJ54N1_IOC</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ioctl_high</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ei2c</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Detected a RJ54N1CB0C chip ID 0x%x:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">);</span>

<span class="nl">ei2c:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">did</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="n">rj54n1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">to_i2c_adapter</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rj54n1_pdata</span> <span class="o">*</span><span class="n">rj54n1_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">icl</span> <span class="o">||</span> <span class="o">!</span><span class="n">icl</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RJ54N1CB0C: missing platform data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rj54n1_priv</span> <span class="o">=</span> <span class="n">icl</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;I2C-Adapter doesn&#39;t support I2C_FUNC_SMBUS_BYTE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rj54n1</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rj54n1</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rj54n1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rj54n1_subdev_ops</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rj54n1_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_VFLIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rj54n1_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_HFLIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rj54n1_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_GAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">66</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rj54n1_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_AUTO_WHITE_BALANCE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">rj54n1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">clk_div</span>		<span class="o">=</span> <span class="n">clk_div</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">left</span>	<span class="o">=</span> <span class="n">RJ54N1_COLUMN_SKIP</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span>	<span class="o">=</span> <span class="n">RJ54N1_ROW_SKIP</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="n">RJ54N1_MAX_WIDTH</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="n">RJ54N1_MAX_HEIGHT</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">width</span>		<span class="o">=</span> <span class="n">RJ54N1_MAX_WIDTH</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">height</span>		<span class="o">=</span> <span class="n">RJ54N1_MAX_HEIGHT</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">fmt</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">rj54n1_colour_fmts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">resize</span>		<span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">tgclk_mhz</span>	<span class="o">=</span> <span class="p">(</span><span class="n">rj54n1_priv</span><span class="o">-&gt;</span><span class="n">mclk_freq</span> <span class="o">/</span> <span class="n">PLL_L</span> <span class="o">*</span> <span class="n">PLL_N</span><span class="p">)</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">clk_div</span><span class="p">.</span><span class="n">ratio_tg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">clk_div</span><span class="p">.</span><span class="n">ratio_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rj54n1_video_probe</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">rj54n1_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rj54n1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rj54n1_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rj54n1</span> <span class="o">*</span><span class="n">rj54n1</span> <span class="o">=</span> <span class="n">to_rj54n1</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">icl</span><span class="o">-&gt;</span><span class="n">free_bus</span><span class="p">)</span>
		<span class="n">icl</span><span class="o">-&gt;</span><span class="n">free_bus</span><span class="p">(</span><span class="n">icl</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rj54n1</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rj54n1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">rj54n1_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;rj54n1cb0c&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">rj54n1_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">rj54n1_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rj54n1cb0c&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">rj54n1_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">rj54n1_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">rj54n1_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">rj54n1_i2c_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sharp RJ54N1CB0C Camera driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Guennadi Liakhovetski &lt;g.liakhovetski@gmx.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
