<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › cx88 › cx88-input.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cx88-input.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Device driver for GPIO attached remote control interfaces</span>
<span class="cm"> * on Conexant 2388x based TV/DVB cards.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003 Pavel Machek</span>
<span class="cm"> * Copyright (c) 2004 Gerd Knorr</span>
<span class="cm"> * Copyright (c) 2004, 2005 Chris Pascoe</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/hrtimer.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &quot;cx88.h&quot;</span>
<span class="cp">#include &lt;media/rc-core.h&gt;</span>

<span class="cp">#define MODULE_NAME &quot;cx88xx&quot;</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="k">struct</span> <span class="n">cx88_IR</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">users</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="cm">/* sample from gpio pin 16 */</span>
	<span class="n">u32</span> <span class="n">sampling</span><span class="p">;</span>

	<span class="cm">/* poll external decoder */</span>
	<span class="kt">int</span> <span class="n">polling</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hrtimer</span> <span class="n">timer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpio_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last_gpio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask_keycode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask_keydown</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask_keyup</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">ir_samplerate</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ir_samplerate</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ir_samplerate</span><span class="p">,</span> <span class="s">&quot;IR samplerate in kHz, 1 - 20, default 4&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ir_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ir_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>	<span class="cm">/* debug level [IR] */</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ir_debug</span><span class="p">,</span> <span class="s">&quot;enable debug messages [IR]&quot;</span><span class="p">);</span>

<span class="cp">#define ir_dprintk(fmt, arg...)	if (ir_debug) \</span>
<span class="cp">	printk(KERN_DEBUG &quot;%s IR: &quot; fmt , ir-&gt;core-&gt;name , ##arg)</span>

<span class="cp">#define dprintk(fmt, arg...)	if (ir_debug) \</span>
<span class="cp">	printk(KERN_DEBUG &quot;cx88 IR: &quot; fmt , ##arg)</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx88_ir_handle_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_IR</span> <span class="o">*</span><span class="n">ir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpio</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">auxgpio</span><span class="p">;</span>

	<span class="cm">/* read gpio value */</span>
	<span class="n">gpio</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">boardnr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_NPGTECH_REALTV_TOP10FM</span>:
		<span class="cm">/* This board apparently uses a combination of 2 GPIO</span>
<span class="cm">		   to represent the keys. Additionally, the second GPIO</span>
<span class="cm">		   can be used for parity.</span>

<span class="cm">		   Example:</span>

<span class="cm">		   for key &quot;5&quot;</span>
<span class="cm">			gpio = 0x758, auxgpio = 0xe5 or 0xf5</span>
<span class="cm">		   for key &quot;Power&quot;</span>
<span class="cm">			gpio = 0x758, auxgpio = 0xed or 0xfd</span>
<span class="cm">		 */</span>

		<span class="n">auxgpio</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">MO_GP1_IO</span><span class="p">);</span>
		<span class="cm">/* Take out the parity part */</span>
		<span class="n">gpio</span><span class="o">=</span><span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="mh">0x7fd</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">auxgpio</span> <span class="o">&amp;</span> <span class="mh">0xef</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_DTV1000</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_DTV1800H</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_DTV1800H_XC4000</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_DTV2000H_PLUS</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_TV2000_XP_GLOBAL</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_TV2000_XP_GLOBAL_6F36</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_TV2000_XP_GLOBAL_6F43</span>:
		<span class="n">gpio</span> <span class="o">=</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="mh">0x6ff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">cx_read</span><span class="p">(</span><span class="n">MO_GP1_IO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x900</span><span class="p">);</span>
		<span class="n">auxgpio</span> <span class="o">=</span> <span class="n">gpio</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">auxgpio</span> <span class="o">=</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">last_gpio</span> <span class="o">==</span> <span class="n">auxgpio</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">last_gpio</span> <span class="o">=</span> <span class="n">auxgpio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* extract data */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">ir_extract_bits</span><span class="p">(</span><span class="n">gpio</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span><span class="p">);</span>
	<span class="n">ir_dprintk</span><span class="p">(</span><span class="s">&quot;irq gpio=0x%x code=%d | %s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">gpio</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
		   <span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">?</span> <span class="s">&quot;poll&quot;</span> <span class="o">:</span> <span class="s">&quot;irq&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keydown</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; down&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; up&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">boardnr</span> <span class="o">==</span> <span class="n">CX88_BOARD_NORWOOD_MICRO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">gpio_key</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">MO_GP0_IO</span><span class="p">);</span>

		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">gpio_key</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">rc_keydown</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keydown</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* bit set on keydown */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keydown</span><span class="p">)</span>
			<span class="n">rc_keydown_notimeout</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc_keyup</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* bit cleared on keydown */</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span><span class="p">))</span>
			<span class="n">rc_keydown_notimeout</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc_keyup</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* can&#39;t distinguish keydown/up :-/ */</span>
		<span class="n">rc_keydown_notimeout</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rc_keyup</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">hrtimer_restart</span> <span class="nf">cx88_ir_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">missed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx88_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx88_IR</span><span class="p">,</span> <span class="n">timer</span><span class="p">);</span>

	<span class="n">cx88_ir_handle_key</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="n">missed</span> <span class="o">=</span> <span class="n">hrtimer_forward_now</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				     <span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">missed</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ir_dprintk</span><span class="p">(</span><span class="s">&quot;Missed ticks %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">missed</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">HRTIMER_RESTART</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__cx88_ir_start</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx88_IR</span> <span class="o">*</span><span class="n">ir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">core</span> <span class="o">||</span> <span class="o">!</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ir</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hrtimer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="n">HRTIMER_MODE_REL</span><span class="p">);</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">cx88_ir_work</span><span class="p">;</span>
		<span class="n">hrtimer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
			      <span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">),</span>
			      <span class="n">HRTIMER_MODE_REL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">sampling</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">pci_irqmask</span> <span class="o">|=</span> <span class="n">PCI_INT_IR_SMPINT</span><span class="p">;</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_DDS_IO</span><span class="p">,</span> <span class="mh">0x33F286</span> <span class="o">*</span> <span class="n">ir_samplerate</span><span class="p">);</span> <span class="cm">/* samplerate */</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_DDSCFG_IO</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">);</span> <span class="cm">/* enable */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__cx88_ir_stop</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx88_IR</span> <span class="o">*</span><span class="n">ir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">core</span> <span class="o">||</span> <span class="o">!</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ir</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">sampling</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_DDSCFG_IO</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">pci_irqmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_INT_IR_SMPINT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span><span class="p">)</span>
		<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx88_ir_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">__cx88_ir_start</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx88_ir_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span>
		<span class="n">__cx88_ir_stop</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx88_ir_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__cx88_ir_start</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx88_ir_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span>
		<span class="n">__cx88_ir_stop</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="kt">int</span> <span class="nf">cx88_ir_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx88_IR</span> <span class="o">*</span><span class="n">ir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rc_type</span> <span class="o">=</span> <span class="n">RC_TYPE_OTHER</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hardware_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* For devices with a hardware mask, when</span>
<span class="cm">				 * used with a full-code IR table</span>
<span class="cm">				 */</span>

	<span class="n">ir</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ir</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">rc_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* detect &amp; configure */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">boardnr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_DNTV_LIVE_DVB_T</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_KWORLD_DVB_T</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_KWORLD_DVB_T_CX22702</span>:
		<span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_DNTV_LIVE_DVB_T</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span> <span class="o">=</span> <span class="n">MO_GP1_IO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_TERRATEC_CINERGY_1400_DVB_T1</span>:
		<span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_CINERGY_1400</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">sampling</span> <span class="o">=</span> <span class="mh">0xeb04</span><span class="p">;</span> <span class="cm">/* address */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_HAUPPAUGE</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_HAUPPAUGE_DVB_T1</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_HAUPPAUGE_NOVASE2_S1</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_HAUPPAUGE_NOVASPLUS_S1</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_HAUPPAUGE_HVR1100</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_HAUPPAUGE_HVR3000</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_HAUPPAUGE_HVR4000</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_HAUPPAUGE_HVR4000LITE</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_PCHDTV_HD3000</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_PCHDTV_HD5500</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_HAUPPAUGE_IRONLY</span>:
		<span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_HAUPPAUGE</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">sampling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_DTV2000H</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_DTV2000H_J</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_DTV1800H</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_DTV1800H_XC4000</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_DTV2000H_PLUS</span>:
		<span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_WINFAST</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span> <span class="o">=</span> <span class="n">MO_GP0_IO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x8f8</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST2000XP_EXPERT</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_DTV1000</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_TV2000_XP_GLOBAL</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_TV2000_XP_GLOBAL_6F36</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_WINFAST_TV2000_XP_GLOBAL_6F43</span>:
		<span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_WINFAST</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span> <span class="o">=</span> <span class="n">MO_GP0_IO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x8f8</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_IODATA_GVBCTV7E</span>:
		<span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_IODATA_BCTV7E</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span> <span class="o">=</span> <span class="n">MO_GP0_IO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0xfd</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_PROLINK_PLAYTVPVR</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_PIXELVIEW_PLAYTV_ULTRA_PRO</span>:
		<span class="cm">/*</span>
<span class="cm">		 * It seems that this hardware is paired with NEC extended</span>
<span class="cm">		 * address 0x866b. So, unfortunately, its usage with other</span>
<span class="cm">		 * IR&#39;s with different address won&#39;t work. Still, there are</span>
<span class="cm">		 * other IR&#39;s from the same manufacturer that works, like the</span>
<span class="cm">		 * 002-T mini RC, provided with newer PV hardware</span>
<span class="cm">		 */</span>
		<span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_PIXELVIEW_MK12</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span> <span class="o">=</span> <span class="n">MO_GP1_IO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="n">hardware_mask</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>	<span class="cm">/* Hardware returns only 6 bits from command part */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_PROLINK_PV_8000GT</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_PROLINK_PV_GLOBAL_XTREME</span>:
		<span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_PIXELVIEW_NEW</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span> <span class="o">=</span> <span class="n">MO_GP1_IO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_KWORLD_LTV883</span>:
		<span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_PIXELVIEW</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span> <span class="o">=</span> <span class="n">MO_GP1_IO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_ADSTECH_DVB_T_PCI</span>:
		<span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_ADSTECH_DVB_T_PCI</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span> <span class="o">=</span> <span class="n">MO_GP1_IO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0xbf</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_MSI_TVANYWHERE_MASTER</span>:
		<span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_MSI_TVANYWHERE</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span> <span class="o">=</span> <span class="n">MO_GP1_IO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_AVERTV_303</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_AVERTV_STUDIO_303</span>:
		<span class="n">ir_codes</span>         <span class="o">=</span> <span class="n">RC_MAP_AVERTV_303</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span>    <span class="o">=</span> <span class="n">MO_GP2_IO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0xfb</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_OMICOM_SS4_PCI</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_SATTRADE_ST4200</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_TBS_8920</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_TBS_8910</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_PROF_7300</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_PROF_7301</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_PROF_6200</span>:
		<span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_TBS_NEC</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">sampling</span> <span class="o">=</span> <span class="mh">0xff00</span><span class="p">;</span> <span class="cm">/* address */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_TEVII_S464</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_TEVII_S460</span>:
	<span class="k">case</span> <span class="n">CX88_BOARD_TEVII_S420</span>:
		<span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_TEVII_NEC</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">sampling</span> <span class="o">=</span> <span class="mh">0xff00</span><span class="p">;</span> <span class="cm">/* address */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_DNTV_LIVE_DVB_T_PRO</span>:
		<span class="n">ir_codes</span>         <span class="o">=</span> <span class="n">RC_MAP_DNTV_LIVE_DVBT_PRO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">sampling</span>     <span class="o">=</span> <span class="mh">0xff00</span><span class="p">;</span> <span class="cm">/* address */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_NORWOOD_MICRO</span>:
		<span class="n">ir_codes</span>         <span class="o">=</span> <span class="n">RC_MAP_NORWOOD</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span>    <span class="o">=</span> <span class="n">MO_GP1_IO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x0e</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_NPGTECH_REALTV_TOP10FM</span>:
		<span class="n">ir_codes</span>         <span class="o">=</span> <span class="n">RC_MAP_NPGTECH</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span>    <span class="o">=</span> <span class="n">MO_GP0_IO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0xfa</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_PINNACLE_PCTV_HD_800i</span>:
		<span class="n">ir_codes</span>         <span class="o">=</span> <span class="n">RC_MAP_PINNACLE_PCTV_HD</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">sampling</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_POWERCOLOR_REAL_ANGEL</span>:
		<span class="n">ir_codes</span>         <span class="o">=</span> <span class="n">RC_MAP_POWERCOLOR_REAL_ANGEL</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">gpio_addr</span>    <span class="o">=</span> <span class="n">MO_GP2_IO</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span>      <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_TWINHAN_VP1027_DVBS</span>:
		<span class="n">ir_codes</span>         <span class="o">=</span> <span class="n">RC_MAP_TWINHAN_VP1027_DVBS</span><span class="p">;</span>
		<span class="n">rc_type</span>          <span class="o">=</span> <span class="n">RC_TYPE_NEC</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">sampling</span>     <span class="o">=</span> <span class="mh">0xff00</span><span class="p">;</span> <span class="cm">/* address */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir_codes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The usage of mask_keycode were very convenient, due to several</span>
<span class="cm">	 * reasons. Among others, the scancode tables were using the scancode</span>
<span class="cm">	 * as the index elements. So, the less bits it was used, the smaller</span>
<span class="cm">	 * the table were stored. After the input changes, the better is to use</span>
<span class="cm">	 * the full scancodes, since it allows replacing the IR remote by</span>
<span class="cm">	 * another one. Unfortunately, there are still some hardware, like</span>
<span class="cm">	 * Pixelview Ultra Pro, where only part of the scancode is sent via</span>
<span class="cm">	 * GPIO. So, there&#39;s no way to get the full scancode. Due to that,</span>
<span class="cm">	 * hardware_mask were introduced here: it represents those hardware</span>
<span class="cm">	 * that has such limits.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hardware_mask</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span><span class="p">)</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="n">hardware_mask</span><span class="p">;</span>

	<span class="cm">/* init input device */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;cx88 IR (%s)&quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">),</span> <span class="s">&quot;pci-%s/ir0&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_phys</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_PCI</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">ir_codes</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">core</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">cx88_ir_open</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">cx88_ir_close</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">scanmask</span> <span class="o">=</span> <span class="n">hardware_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">sampling</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_type</span> <span class="o">=</span> <span class="n">RC_DRIVER_IR_RAW</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span> <span class="cm">/* 10 ms */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_type</span> <span class="o">=</span> <span class="n">RC_DRIVER_SCANCODE</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">rc_type</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">core</span> <span class="o">=</span> <span class="n">core</span><span class="p">;</span>
	<span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span> <span class="o">=</span> <span class="n">ir</span><span class="p">;</span>

	<span class="cm">/* all done */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rc_register_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free:</span>
	<span class="n">rc_free_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx88_ir_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx88_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">;</span>

	<span class="cm">/* skip detach on non attached boards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">ir</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cx88_ir_stop</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>
	<span class="n">rc_unregister_device</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>

	<span class="cm">/* done */</span>
	<span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="kt">void</span> <span class="nf">cx88_ir_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx88_IR</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">samples</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">todo</span><span class="p">,</span> <span class="n">bits</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ir_raw_event</span> <span class="n">ev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span> <span class="o">||</span> <span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">sampling</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Samples are stored in a 32 bit register, oldest sample in</span>
<span class="cm">	 * the msb. A set bit represents space and an unset bit</span>
<span class="cm">	 * represents a pulse.</span>
<span class="cm">	 */</span>
	<span class="n">samples</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">MO_SAMPLE_IO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">samples</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">idle</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">init_ir_raw_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">todo</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">todo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">todo</span> <span class="o">-=</span> <span class="n">bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ev</span><span class="p">.</span><span class="n">pulse</span> <span class="o">=</span> <span class="n">samples</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span> <span class="o">?</span> <span class="nb">false</span> <span class="o">:</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="mi">32U</span> <span class="o">-</span> <span class="n">fls</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">pulse</span> <span class="o">?</span> <span class="n">samples</span> <span class="o">:</span> <span class="o">~</span><span class="n">samples</span><span class="p">));</span>
		<span class="n">ev</span><span class="p">.</span><span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">*</span> <span class="p">(</span><span class="n">NSEC_PER_SEC</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">/</span> <span class="n">ir_samplerate</span><span class="p">;</span>
		<span class="n">ir_raw_event_store_with_filter</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
		<span class="n">samples</span> <span class="o">&lt;&lt;=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ir_raw_event_handle</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_key_pvr2000</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">code</span><span class="p">;</span>

	<span class="cm">/* poll IR chip */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* key pressed ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* read actual key code */</span>
	<span class="n">code</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;IR Key/Flags: (0x%02x/0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ir_key</span> <span class="o">=</span> <span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ir_raw</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx88_i2c_init_ir</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">default_addr_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span>
		<span class="n">I2C_CLIENT_END</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pvr2000_addr_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span>
		<span class="n">I2C_CLIENT_END</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">addr_list</span> <span class="o">=</span> <span class="n">default_addr_list</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">addrp</span><span class="p">;</span>
	<span class="cm">/* Instantiate the IR receiver device, if present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">i2c_rc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_board_info</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;ir_video&quot;</span><span class="p">,</span> <span class="n">I2C_NAME_SIZE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">boardnr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX88_BOARD_LEADTEK_PVR2000</span>:
		<span class="n">addr_list</span> <span class="o">=</span> <span class="n">pvr2000_addr_list</span><span class="p">;</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cx88 Leadtek PVR 2000 remote&quot;</span><span class="p">;</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">RC_TYPE_UNKNOWN</span><span class="p">;</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">get_key_pvr2000</span><span class="p">;</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_EMPTY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can&#39;t call i2c_new_probed_device() because it uses</span>
<span class="cm">	 * quick writes for probing and at least some RC receiver</span>
<span class="cm">	 * devices only reply to reads.</span>
<span class="cm">	 * Also, Hauppauge XVR needs to be specified, as address 0x71</span>
<span class="cm">	 * conflicts with another remote type used with saa7134</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addrp</span> <span class="o">=</span> <span class="n">addr_list</span><span class="p">;</span> <span class="o">*</span><span class="n">addrp</span> <span class="o">!=</span> <span class="n">I2C_CLIENT_END</span><span class="p">;</span> <span class="n">addrp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">addrp</span> <span class="o">==</span> <span class="mh">0x71</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Hauppauge XVR */</span>
			<span class="n">core</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cx88 Hauppauge XVR remote&quot;</span><span class="p">;</span>
			<span class="n">core</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_HAUPPAUGE</span><span class="p">;</span>
			<span class="n">core</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">RC_TYPE_RC5</span><span class="p">;</span>
			<span class="n">core</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">internal_get_key_func</span> <span class="o">=</span> <span class="n">IR_KBD_GET_KEY_HAUP_XVR</span><span class="p">;</span>

			<span class="n">info</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_xfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">*</span><span class="n">addrp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">I2C_SMBUS_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">I2C_SMBUS_QUICK</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">addrp</span><span class="p">;</span>
			<span class="n">i2c_new_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Gerd Knorr, Pavel Machek, Chris Pascoe&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;input driver for cx88 GPIO-based IR remote controls&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
