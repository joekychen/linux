<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › cx88 › cx88-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cx88-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * device driver for Conexant 2388x based TV cards</span>
<span class="cm"> * driver core</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 2003 Gerd Knorr &lt;kraxel@bytesex.org&gt; [SuSE Labs]</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 2005-2006 Mauro Carvalho Chehab &lt;mchehab@infradead.org&gt;</span>
<span class="cm"> *     - Multituner support</span>
<span class="cm"> *     - video_ioctl2 conversion</span>
<span class="cm"> *     - PAL/M fixes</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/sound.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &quot;cx88.h&quot;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;v4l2 driver module for cx2388x based TV cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Gerd Knorr &lt;kraxel@bytesex.org&gt; [SuSE Labs]&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">core_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">core_debug</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">core_debug</span><span class="p">,</span><span class="s">&quot;enable debug messages [core]&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nicam</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nicam</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nicam</span><span class="p">,</span><span class="s">&quot;tv audio is nicam&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nocomb</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nocomb</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nocomb</span><span class="p">,</span><span class="s">&quot;disable comb filter&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(level,fmt, arg...)	if (core_debug &gt;= level)	\</span>
<span class="cp">	printk(KERN_DEBUG &quot;%s: &quot; fmt, core-&gt;name , ## arg)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cx88_devcount</span><span class="p">;</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">cx88_devlist</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">devlist</span><span class="p">);</span>

<span class="cp">#define NO_SYNC_LINE (-1U)</span>

<span class="cm">/* @lpi: lines per IRQ, or 0 to not generate irqs. Note: IRQ to be</span>
<span class="cm">	 generated _after_ lpi lines are transferred. */</span>
<span class="k">static</span> <span class="n">__le32</span><span class="o">*</span> <span class="nf">cx88_risc_field</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sync_line</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">padding</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lpi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span><span class="n">todo</span><span class="p">,</span><span class="n">sol</span><span class="p">;</span>

	<span class="cm">/* sync instruction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_line</span> <span class="o">!=</span> <span class="n">NO_SYNC_LINE</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_RESYNC</span> <span class="o">|</span> <span class="n">sync_line</span><span class="p">);</span>

	<span class="cm">/* scan lines */</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="n">sglist</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">lines</span><span class="p">;</span> <span class="n">line</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">offset</span> <span class="o">-=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">sg</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpi</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">line</span> <span class="o">%</span> <span class="n">lpi</span><span class="p">))</span>
			<span class="n">sol</span> <span class="o">=</span> <span class="n">RISC_SOL</span> <span class="o">|</span> <span class="n">RISC_IRQ1</span> <span class="o">|</span> <span class="n">RISC_CNT_INC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sol</span> <span class="o">=</span> <span class="n">RISC_SOL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpl</span> <span class="o">&lt;=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* fits into current chunk */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_WRITE</span><span class="o">|</span><span class="n">sol</span><span class="o">|</span><span class="n">RISC_EOL</span><span class="o">|</span><span class="n">bpl</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">+</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">offset</span><span class="o">+=</span><span class="n">bpl</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* scanline needs to be split */</span>
			<span class="n">todo</span> <span class="o">=</span> <span class="n">bpl</span><span class="p">;</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_WRITE</span><span class="o">|</span><span class="n">sol</span><span class="o">|</span>
					    <span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">));</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">+</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">todo</span> <span class="o">-=</span> <span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sg</span><span class="o">++</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">todo</span> <span class="o">&gt;</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_WRITE</span><span class="o">|</span>
						    <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
				<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
				<span class="n">todo</span> <span class="o">-=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
				<span class="n">sg</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_WRITE</span><span class="o">|</span><span class="n">RISC_EOL</span><span class="o">|</span><span class="n">todo</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">todo</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">padding</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx88_risc_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">top_offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bottom_offset</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">padding</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">instructions</span><span class="p">,</span><span class="n">fields</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">fields</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">top_offset</span><span class="p">)</span>
		<span class="n">fields</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">bottom_offset</span><span class="p">)</span>
		<span class="n">fields</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* estimate risc mem: worst case is one write per page border +</span>
<span class="cm">	   one write per scan line + syncs + jump (all 2 dwords).  Padding</span>
<span class="cm">	   can cause next bpl to start close to a page border.  First DMA</span>
<span class="cm">	   region may be smaller than PAGE_SIZE */</span>
	<span class="n">instructions</span>  <span class="o">=</span> <span class="n">fields</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">bpl</span> <span class="o">+</span> <span class="n">padding</span><span class="p">)</span> <span class="o">*</span> <span class="n">lines</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="n">lines</span><span class="p">);</span>
	<span class="n">instructions</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">btcx_riscmem_alloc</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span><span class="n">risc</span><span class="p">,</span><span class="n">instructions</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* write risc instructions */</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">top_offset</span><span class="p">)</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="n">cx88_risc_field</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="n">top_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">bpl</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">bottom_offset</span><span class="p">)</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="n">cx88_risc_field</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="n">bottom_offset</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span>
				     <span class="n">bpl</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* save pointer to jmp instruction address */</span>
	<span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">=</span> <span class="n">rp</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">-</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx88_risc_databuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpl</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lpi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">instructions</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* estimate risc mem: worst case is one write per page border +</span>
<span class="cm">	   one write per scan line + syncs + jump (all 2 dwords).  Here</span>
<span class="cm">	   there is no padding and no sync.  First DMA region may be smaller</span>
<span class="cm">	   than PAGE_SIZE */</span>
	<span class="n">instructions</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">bpl</span> <span class="o">*</span> <span class="n">lines</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="n">lines</span><span class="p">;</span>
	<span class="n">instructions</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">btcx_riscmem_alloc</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span><span class="n">risc</span><span class="p">,</span><span class="n">instructions</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* write risc instructions */</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">cx88_risc_field</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NO_SYNC_LINE</span><span class="p">,</span> <span class="n">bpl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">lpi</span><span class="p">);</span>

	<span class="cm">/* save pointer to jmp instruction address */</span>
	<span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">=</span> <span class="n">rp</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">-</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx88_risc_stopper</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">btcx_riscmem_alloc</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">risc</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="mi">16</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* write risc instructions */</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_WRITECR</span>  <span class="o">|</span> <span class="n">RISC_IRQ2</span> <span class="o">|</span> <span class="n">RISC_IMM</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RISC_JUMP</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cx88_free_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx88_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">videobuf_dmabuf</span> <span class="o">*</span><span class="n">dma</span><span class="o">=</span><span class="n">videobuf_to_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">in_interrupt</span><span class="p">());</span>
	<span class="n">videobuf_waiton</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">videobuf_dma_unmap</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="n">videobuf_dma_free</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">btcx_riscmem_free</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">risc</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_NEEDS_INIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>
<span class="cm">/* our SRAM memory layout                                             */</span>

<span class="cm">/* we are going to put all thr risc programs into host memory, so we</span>
<span class="cm"> * can use the whole SDRAM for the DMA fifos.  To simplify things, we</span>
<span class="cm"> * use a static memory layout.  That surely will waste memory in case</span>
<span class="cm"> * we don&#39;t use all DMA channels at the same time (which will be the</span>
<span class="cm"> * case most of the time).  But that still gives us enough FIFO space</span>
<span class="cm"> * to be able to deal with insane long pci latencies ...</span>
<span class="cm"> *</span>
<span class="cm"> * FIFO space allocations:</span>
<span class="cm"> *    channel  21    (y video)  - 10.0k</span>
<span class="cm"> *    channel  22    (u video)  -  2.0k</span>
<span class="cm"> *    channel  23    (v video)  -  2.0k</span>
<span class="cm"> *    channel  24    (vbi)      -  4.0k</span>
<span class="cm"> *    channels 25+26 (audio)    -  4.0k</span>
<span class="cm"> *    channel  28    (mpeg)     -  4.0k</span>
<span class="cm"> *    channel  27    (audio rds)-  3.0k</span>
<span class="cm"> *    TOTAL                     = 29.0k</span>
<span class="cm"> *</span>
<span class="cm"> * Every channel has 160 bytes control data (64 bytes instruction</span>
<span class="cm"> * queue and 6 CDT entries), which is close to 2k total.</span>
<span class="cm"> *</span>
<span class="cm"> * Address layout:</span>
<span class="cm"> *    0x0000 - 0x03ff    CMDs / reserved</span>
<span class="cm"> *    0x0400 - 0x0bff    instruction queues + CDs</span>
<span class="cm"> *    0x0c00 -           FIFOs</span>
<span class="cm"> */</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">sram_channel</span> <span class="k">const</span> <span class="n">cx88_sram_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SRAM_CH21</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;video y / packed&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span> <span class="o">=</span> <span class="mh">0x180040</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span> <span class="o">=</span> <span class="mh">0x180400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>        <span class="o">=</span> <span class="mh">0x180400</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span> <span class="o">=</span> <span class="mh">0x180c00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>  <span class="o">=</span> <span class="mh">0x002800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA21_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA21_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA21_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA21_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH22</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;video u&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span> <span class="o">=</span> <span class="mh">0x180080</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span> <span class="o">=</span> <span class="mh">0x1804a0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>        <span class="o">=</span> <span class="mh">0x1804a0</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span> <span class="o">=</span> <span class="mh">0x183400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>  <span class="o">=</span> <span class="mh">0x000800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA22_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA22_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA22_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA22_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH23</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;video v&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span> <span class="o">=</span> <span class="mh">0x1800c0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span> <span class="o">=</span> <span class="mh">0x180540</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>        <span class="o">=</span> <span class="mh">0x180540</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span> <span class="o">=</span> <span class="mh">0x183c00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>  <span class="o">=</span> <span class="mh">0x000800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA23_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA23_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA23_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA23_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH24</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;vbi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span> <span class="o">=</span> <span class="mh">0x180100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span> <span class="o">=</span> <span class="mh">0x1805e0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>        <span class="o">=</span> <span class="mh">0x1805e0</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span> <span class="o">=</span> <span class="mh">0x184400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>  <span class="o">=</span> <span class="mh">0x001000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA24_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA24_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA24_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA24_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH25</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;audio from&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span> <span class="o">=</span> <span class="mh">0x180140</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span> <span class="o">=</span> <span class="mh">0x180680</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>        <span class="o">=</span> <span class="mh">0x180680</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span> <span class="o">=</span> <span class="mh">0x185400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>  <span class="o">=</span> <span class="mh">0x001000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA25_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA25_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA25_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA25_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH26</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;audio to&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span> <span class="o">=</span> <span class="mh">0x180180</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span> <span class="o">=</span> <span class="mh">0x180720</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>        <span class="o">=</span> <span class="mh">0x180680</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span>  <span class="cm">/* same as audio IN */</span>
		<span class="p">.</span><span class="n">fifo_start</span> <span class="o">=</span> <span class="mh">0x185400</span><span class="p">,</span>       <span class="cm">/* same as audio IN */</span>
		<span class="p">.</span><span class="n">fifo_size</span>  <span class="o">=</span> <span class="mh">0x001000</span><span class="p">,</span>       <span class="cm">/* same as audio IN */</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA26_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA26_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA26_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA26_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH28</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;mpeg&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span> <span class="o">=</span> <span class="mh">0x180200</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span> <span class="o">=</span> <span class="mh">0x1807C0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>        <span class="o">=</span> <span class="mh">0x1807C0</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span> <span class="o">=</span> <span class="mh">0x186400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>  <span class="o">=</span> <span class="mh">0x001000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA28_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA28_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA28_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA28_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRAM_CH27</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;audio rds&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmds_start</span> <span class="o">=</span> <span class="mh">0x1801C0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctrl_start</span> <span class="o">=</span> <span class="mh">0x180860</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cdt</span>        <span class="o">=</span> <span class="mh">0x180860</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_start</span> <span class="o">=</span> <span class="mh">0x187400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>  <span class="o">=</span> <span class="mh">0x000C00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA27_PTR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ptr2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA27_PTR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt1_reg</span>   <span class="o">=</span> <span class="n">MO_DMA27_CNT1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cnt2_reg</span>   <span class="o">=</span> <span class="n">MO_DMA27_CNT2</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">cx88_sram_channel_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">sram_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">risc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">lines</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cdt</span><span class="p">;</span>

	<span class="n">bpl</span>   <span class="o">=</span> <span class="p">(</span><span class="n">bpl</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span> <span class="cm">/* alignment */</span>
	<span class="n">cdt</span>   <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">cdt</span><span class="p">;</span>
	<span class="n">lines</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">/</span> <span class="n">bpl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lines</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">lines</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lines</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* write CDT */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lines</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">cdt</span> <span class="o">+</span> <span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_start</span> <span class="o">+</span> <span class="n">bpl</span><span class="o">*</span><span class="n">i</span><span class="p">);</span>

	<span class="cm">/* write CMDS */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">risc</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">,</span> <span class="n">cdt</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span>  <span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="n">lines</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ctrl_start</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">64</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* fill registers */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ptr1_reg</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_start</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ptr2_reg</span><span class="p">,</span> <span class="n">cdt</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cnt1_reg</span><span class="p">,</span> <span class="p">(</span><span class="n">bpl</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cnt2_reg</span><span class="p">,</span> <span class="p">(</span><span class="n">lines</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;sram setup %s: bpl=%d lines=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bpl</span><span class="p">,</span> <span class="n">lines</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>
<span class="cm">/* debug helper code                                                  */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx88_risc_decode</span><span class="p">(</span><span class="n">u32</span> <span class="n">risc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">instr</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">RISC_SYNC</span>    <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;sync&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">RISC_WRITE</span>   <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;write&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">RISC_WRITEC</span>  <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;writec&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">RISC_READ</span>    <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;read&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">RISC_READC</span>   <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;readc&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">RISC_JUMP</span>    <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;jump&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">RISC_SKIP</span>    <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;skip&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">RISC_WRITERM</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;writerm&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">RISC_WRITECM</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;writecm&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">RISC_WRITECR</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;writecr&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="k">const</span> <span class="n">incr</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">RISC_WRITE</span>   <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">RISC_JUMP</span>    <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">RISC_WRITERM</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">RISC_WRITECM</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">RISC_WRITECR</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;12&quot;</span><span class="p">,</span>   <span class="s">&quot;13&quot;</span><span class="p">,</span>   <span class="s">&quot;14&quot;</span><span class="p">,</span>   <span class="s">&quot;resync&quot;</span><span class="p">,</span>
		<span class="s">&quot;cnt0&quot;</span><span class="p">,</span> <span class="s">&quot;cnt1&quot;</span><span class="p">,</span> <span class="s">&quot;18&quot;</span><span class="p">,</span>   <span class="s">&quot;19&quot;</span><span class="p">,</span>
		<span class="s">&quot;20&quot;</span><span class="p">,</span>   <span class="s">&quot;21&quot;</span><span class="p">,</span>   <span class="s">&quot;22&quot;</span><span class="p">,</span>   <span class="s">&quot;23&quot;</span><span class="p">,</span>
		<span class="s">&quot;irq1&quot;</span><span class="p">,</span> <span class="s">&quot;irq2&quot;</span><span class="p">,</span> <span class="s">&quot;eol&quot;</span><span class="p">,</span>  <span class="s">&quot;sol&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%08x [ %s&quot;</span><span class="p">,</span> <span class="n">risc</span><span class="p">,</span>
	       <span class="n">instr</span><span class="p">[</span><span class="n">risc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">?</span> <span class="n">instr</span><span class="p">[</span><span class="n">risc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;INVALID&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">risc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span><span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; count=%d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">risc</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">incr</span><span class="p">[</span><span class="n">risc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">?</span> <span class="n">incr</span><span class="p">[</span><span class="n">risc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">cx88_sram_channel_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">sram_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;initial risc&quot;</span><span class="p">,</span>
		<span class="s">&quot;cdt base&quot;</span><span class="p">,</span>
		<span class="s">&quot;cdt size&quot;</span><span class="p">,</span>
		<span class="s">&quot;iq base&quot;</span><span class="p">,</span>
		<span class="s">&quot;iq size&quot;</span><span class="p">,</span>
		<span class="s">&quot;risc pc&quot;</span><span class="p">,</span>
		<span class="s">&quot;iq wr ptr&quot;</span><span class="p">,</span>
		<span class="s">&quot;iq rd ptr&quot;</span><span class="p">,</span>
		<span class="s">&quot;cdt current&quot;</span><span class="p">,</span>
		<span class="s">&quot;pci target&quot;</span><span class="p">,</span>
		<span class="s">&quot;line / byte&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">u32</span> <span class="n">risc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">n</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s - dma channel status dump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">name</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:   cmds: %-12s: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		       <span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">risc</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmds_start</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">11</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:   risc%d: &quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%08x [ arg #%d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">risc</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">cx88_risc_decode</span><span class="p">(</span><span class="n">risc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">risc</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ctrl_start</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:   iq %x: &quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">cx88_risc_decode</span><span class="p">(</span><span class="n">risc</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">risc</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ctrl_start</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">));</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:   iq %x: 0x%08x [ arg #%d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">risc</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: fifo: 0x%08x -&gt; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_start</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_start</span><span class="o">+</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ctrl: 0x%08x -&gt; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ctrl_start</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ctrl_start</span><span class="o">+</span><span class="mi">6</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:   ptr1_reg: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ptr1_reg</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:   ptr2_reg: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ptr2_reg</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:   cnt1_reg: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cnt1_reg</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:   cnt2_reg: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">cx_read</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cnt2_reg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cx88_pci_irqs</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;vid&quot;</span><span class="p">,</span> <span class="s">&quot;aud&quot;</span><span class="p">,</span> <span class="s">&quot;ts&quot;</span><span class="p">,</span> <span class="s">&quot;vip&quot;</span><span class="p">,</span> <span class="s">&quot;hst&quot;</span><span class="p">,</span> <span class="s">&quot;5&quot;</span><span class="p">,</span> <span class="s">&quot;6&quot;</span><span class="p">,</span> <span class="s">&quot;tm1&quot;</span><span class="p">,</span>
	<span class="s">&quot;src_dma&quot;</span><span class="p">,</span> <span class="s">&quot;dst_dma&quot;</span><span class="p">,</span> <span class="s">&quot;risc_rd_err&quot;</span><span class="p">,</span> <span class="s">&quot;risc_wr_err&quot;</span><span class="p">,</span>
	<span class="s">&quot;brdg_err&quot;</span><span class="p">,</span> <span class="s">&quot;src_dma_err&quot;</span><span class="p">,</span> <span class="s">&quot;dst_dma_err&quot;</span><span class="p">,</span> <span class="s">&quot;ipb_dma_err&quot;</span><span class="p">,</span>
	<span class="s">&quot;i2c&quot;</span><span class="p">,</span> <span class="s">&quot;i2c_rack&quot;</span><span class="p">,</span> <span class="s">&quot;ir_smp&quot;</span><span class="p">,</span> <span class="s">&quot;gpio0&quot;</span><span class="p">,</span> <span class="s">&quot;gpio1&quot;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">cx88_print_irqbits</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strings</span><span class="p">[],</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bits</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s [0x%x]&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">strings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="kt">int</span> <span class="nf">cx88_core_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PCI_INT_IR_SMPINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx88_ir_irq</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>
		<span class="n">handled</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handled</span><span class="p">)</span>
		<span class="n">cx88_print_irqbits</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;irq pci&quot;</span><span class="p">,</span>
				   <span class="n">cx88_pci_irqs</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cx88_pci_irqs</span><span class="p">),</span>
				   <span class="n">status</span><span class="p">,</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">pci_irqmask</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx88_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">cx88_dmaqueue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx88_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="n">bc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">cx88_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="cm">/* count comes from the hw and is is 16bit wide --</span>
<span class="cm">		 * this trick handles wrap-arounds correctly for</span>
<span class="cm">		 * up to 32767 buffers in flight... */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">s16</span><span class="p">)</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">ts</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;[%p/%d] wakeup reg=%d buf=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">i</span><span class="p">,</span>
			<span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_DONE</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">BUFFER_TIMEOUT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: %d buffers handled (should be 1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">bc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx88_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable RISC controller + IRQs */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_DEV_CNTRL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* stop dma transfers */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_VID_DMACNTRL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_AUD_DMACNTRL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_TS_DMACNTRL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_VIP_DMACNTRL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_GPHST_DMACNTRL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* stop interrupts */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_PCI_INTMSK</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_VID_INTMSK</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_AUD_INTMSK</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_TS_INTMSK</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_VIP_INTMSK</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_GPHST_INTMSK</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* stop capturing */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">VID_CAPTURE_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx88_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
	<span class="n">cx88_shutdown</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>

	<span class="cm">/* clear irq status */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_VID_INTSTAT</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span> <span class="c1">// Clear PIV int</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_PCI_INTSTAT</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span> <span class="c1">// Clear PCI int</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_INT1_STAT</span><span class="p">,</span>   <span class="mh">0xFFFFFFFF</span><span class="p">);</span> <span class="c1">// Clear RISC int</span>

	<span class="cm">/* wait a bit */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* init sram */</span>
	<span class="n">cx88_sram_channel_setup</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88_sram_channels</span><span class="p">[</span><span class="n">SRAM_CH21</span><span class="p">],</span> <span class="mi">720</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx88_sram_channel_setup</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88_sram_channels</span><span class="p">[</span><span class="n">SRAM_CH22</span><span class="p">],</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx88_sram_channel_setup</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88_sram_channels</span><span class="p">[</span><span class="n">SRAM_CH23</span><span class="p">],</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx88_sram_channel_setup</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88_sram_channels</span><span class="p">[</span><span class="n">SRAM_CH24</span><span class="p">],</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx88_sram_channel_setup</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88_sram_channels</span><span class="p">[</span><span class="n">SRAM_CH25</span><span class="p">],</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx88_sram_channel_setup</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88_sram_channels</span><span class="p">[</span><span class="n">SRAM_CH26</span><span class="p">],</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx88_sram_channel_setup</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88_sram_channels</span><span class="p">[</span><span class="n">SRAM_CH28</span><span class="p">],</span> <span class="mi">188</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx88_sram_channel_setup</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88_sram_channels</span><span class="p">[</span><span class="n">SRAM_CH27</span><span class="p">],</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* misc init ... */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_INPUT_FORMAT</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>   <span class="c1">// agc enable</span>
				   <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span>   <span class="c1">// agc gain</span>
				   <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span>   <span class="c1">// adaptibe agc</span>
				   <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>   <span class="c1">// chroma agc</span>
				   <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span>  <span class="mi">9</span><span class="p">)</span> <span class="o">|</span>   <span class="c1">// ckillen</span>
				   <span class="p">(</span><span class="mi">7</span><span class="p">)));</span>

	<span class="cm">/* setup image format */</span>
	<span class="n">cx_andor</span><span class="p">(</span><span class="n">MO_COLOR_CTRL</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>

	<span class="cm">/* setup FIFO Thresholds */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_PDMA_STHRSH</span><span class="p">,</span>   <span class="mh">0x0807</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_PDMA_DTHRSH</span><span class="p">,</span>   <span class="mh">0x0807</span><span class="p">);</span>

	<span class="cm">/* fixes flashing of image */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_AGC_SYNC_TIP1</span><span class="p">,</span> <span class="mh">0x0380000F</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_AGC_BACK_VBI</span><span class="p">,</span>  <span class="mh">0x00E00555</span><span class="p">);</span>

	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_VID_INTSTAT</span><span class="p">,</span>   <span class="mh">0xFFFFFFFF</span><span class="p">);</span> <span class="c1">// Clear PIV int</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_PCI_INTSTAT</span><span class="p">,</span>   <span class="mh">0xFFFFFFFF</span><span class="p">);</span> <span class="c1">// Clear PCI int</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_INT1_STAT</span><span class="p">,</span>     <span class="mh">0xFFFFFFFF</span><span class="p">);</span> <span class="c1">// Clear RISC int</span>

	<span class="cm">/* Reset on-board parts */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_SRST_IO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_SRST_IO</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="kr">inline</span> <span class="nf">norm_swidth</span><span class="p">(</span><span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_MN</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">V4L2_STD_PAL_Nc</span><span class="p">))</span> <span class="o">?</span> <span class="mi">754</span> <span class="o">:</span> <span class="mi">922</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="kr">inline</span> <span class="nf">norm_hdelay</span><span class="p">(</span><span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_MN</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">V4L2_STD_PAL_Nc</span><span class="p">))</span> <span class="o">?</span> <span class="mi">135</span> <span class="o">:</span> <span class="mi">186</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="kr">inline</span> <span class="nf">norm_vdelay</span><span class="p">(</span><span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x24</span> <span class="o">:</span> <span class="mh">0x18</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="kr">inline</span> <span class="nf">norm_fsc8</span><span class="p">(</span><span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_M</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">28604892</span><span class="p">;</span>      <span class="c1">// 3.575611 MHz</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_PAL_Nc</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">28656448</span><span class="p">;</span>      <span class="c1">// 3.582056 MHz</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="c1">// All NTSC/M and variants</span>
		<span class="k">return</span> <span class="mi">28636360</span><span class="p">;</span>      <span class="c1">// 3.57954545 MHz +/- 10 Hz</span>

	<span class="cm">/* SECAM have also different sub carrier for chroma,</span>
<span class="cm">	   but step_db and step_dr, at cx88_set_tvnorm already handles that.</span>

<span class="cm">	   The same FSC applies to PAL/BGDKIH, PAL/60, NTSC/4.43 and PAL/N</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="mi">35468950</span><span class="p">;</span>      <span class="c1">// 4.43361875 MHz +/- 5 Hz</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="kr">inline</span> <span class="nf">norm_htotal</span><span class="p">(</span><span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fsc4</span><span class="o">=</span><span class="n">norm_fsc8</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* returns 4*FSC / vtotal / frames per seconds */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">)</span> <span class="o">?</span>
				<span class="p">((</span><span class="n">fsc4</span><span class="o">+</span><span class="mi">312</span><span class="p">)</span><span class="o">/</span><span class="mi">625</span><span class="o">+</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="mi">25</span> <span class="o">:</span>
				<span class="p">((</span><span class="n">fsc4</span><span class="o">+</span><span class="mi">262</span><span class="p">)</span><span class="o">/</span><span class="mi">525</span><span class="o">*</span><span class="mi">1001</span><span class="o">+</span><span class="mi">15000</span><span class="p">)</span><span class="o">/</span><span class="mi">30000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="kr">inline</span> <span class="nf">norm_vbipack</span><span class="p">(</span><span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">)</span> <span class="o">?</span> <span class="mi">511</span> <span class="o">:</span> <span class="mi">400</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx88_set_scale</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
		   <span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">swidth</span>  <span class="o">=</span> <span class="n">norm_swidth</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sheight</span> <span class="o">=</span> <span class="n">norm_maxh</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_scale: %dx%d [%s%s,%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
		<span class="n">V4L2_FIELD_HAS_TOP</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>    <span class="o">?</span> <span class="s">&quot;T&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">V4L2_FIELD_HAS_BOTTOM</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;B&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">v4l2_norm_to_name</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
		<span class="n">height</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>recalc H delay and scale registers</p></td><td class="code"><div class="highlight"><pre>	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">norm_hdelay</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">))</span> <span class="o">/</span> <span class="n">swidth</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">&amp;=</span> <span class="mh">0x3fe</span><span class="p">;</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_HDELAY_EVEN</span><span class="p">,</span>  <span class="n">value</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_HDELAY_ODD</span><span class="p">,</span>   <span class="n">value</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_scale: hdelay  0x%04x (width %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span><span class="n">swidth</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">swidth</span> <span class="o">*</span> <span class="mi">4096</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_HSCALE_EVEN</span><span class="p">,</span>  <span class="n">value</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_HSCALE_ODD</span><span class="p">,</span>   <span class="n">value</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_scale: hscale  0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_HACTIVE_EVEN</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_HACTIVE_ODD</span><span class="p">,</span>  <span class="n">width</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_scale: hactive 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>recalc V scale Register (delay is constant)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_VDELAY_EVEN</span><span class="p">,</span> <span class="n">norm_vdelay</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">));</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_VDELAY_ODD</span><span class="p">,</span>  <span class="n">norm_vdelay</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_scale: vdelay  0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">norm_vdelay</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">));</span>

	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x10000</span> <span class="o">-</span> <span class="p">(</span><span class="n">sheight</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">/</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">512</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_VSCALE_EVEN</span><span class="p">,</span>  <span class="n">value</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_VSCALE_ODD</span><span class="p">,</span>   <span class="n">value</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_scale: vscale  0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_VACTIVE_EVEN</span><span class="p">,</span> <span class="n">sheight</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_VACTIVE_ODD</span><span class="p">,</span>  <span class="n">sheight</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_scale: vactive 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sheight</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>setup filters</p></td><td class="code"><div class="highlight"><pre>	<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>        <span class="c1">// CFILT (default)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">tvnorm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INPUT</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">).</span><span class="n">type</span> <span class="o">==</span> <span class="n">CX88_VMUX_SVIDEO</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_INTERLACED</span> <span class="o">==</span> <span class="n">field</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span> <span class="c1">// VINT (interlaced vertical scaling)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">385</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// 3-tap interpolation</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">193</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// 5-tap interpolation</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nocomb</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span> <span class="c1">// disable comb filter</span>

	<span class="n">cx_andor</span><span class="p">(</span><span class="n">MO_FILTER_EVEN</span><span class="p">,</span>  <span class="mh">0x7ffc7f</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span> <span class="cm">/* preserve PEAKEN, PSEL */</span>
	<span class="n">cx_andor</span><span class="p">(</span><span class="n">MO_FILTER_ODD</span><span class="p">,</span>   <span class="mh">0x7ffc7f</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_scale: filter  0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">xtal</span> <span class="o">=</span> <span class="mi">28636363</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prescale</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ofreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">pre</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
	<span class="n">u64</span> <span class="n">pll</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prescale</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">prescale</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prescale</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">prescale</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">pll</span> <span class="o">=</span> <span class="n">ofreq</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">prescale</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">pll</span><span class="p">,</span><span class="n">xtal</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span> <span class="o">&amp;</span> <span class="mh">0x3ffffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pre</span><span class="p">[</span><span class="n">prescale</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s/0: pll out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_pll:    MO_PLL_REG       0x%08x [old=0x%08x,freq=%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">reg</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">MO_PLL_REG</span><span class="p">),</span> <span class="n">ofreq</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_PLL_REG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">MO_DEVICE_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;pll locked [pre=%d,ofreq=%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">prescale</span><span class="p">,</span><span class="n">ofreq</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;pll not locked yet, waiting ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;pll NOT locked [pre=%d,ofreq=%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">prescale</span><span class="p">,</span><span class="n">ofreq</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx88_start_audio_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* constant 128 made buzz in analog Nicam-stereo for bigger fifo_size */</span>
	<span class="kt">int</span> <span class="n">bpl</span> <span class="o">=</span> <span class="n">cx88_sram_channels</span><span class="p">[</span><span class="n">SRAM_CH25</span><span class="p">].</span><span class="n">fifo_size</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">rds_bpl</span> <span class="o">=</span> <span class="n">cx88_sram_channels</span><span class="p">[</span><span class="n">SRAM_CH27</span><span class="p">].</span><span class="n">fifo_size</span><span class="o">/</span><span class="n">AUD_RDS_LINES</span><span class="p">;</span>

	<span class="cm">/* If downstream RISC is enabled, bail out; ALSA is managing DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cx_read</span><span class="p">(</span><span class="n">MO_AUD_DMACNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* setup fifo + format */</span>
	<span class="n">cx88_sram_channel_setup</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88_sram_channels</span><span class="p">[</span><span class="n">SRAM_CH25</span><span class="p">],</span> <span class="n">bpl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx88_sram_channel_setup</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88_sram_channels</span><span class="p">[</span><span class="n">SRAM_CH26</span><span class="p">],</span> <span class="n">bpl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx88_sram_channel_setup</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88_sram_channels</span><span class="p">[</span><span class="n">SRAM_CH27</span><span class="p">],</span>
				<span class="n">rds_bpl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_AUDD_LNGTH</span><span class="p">,</span> <span class="n">bpl</span><span class="p">);</span> <span class="cm">/* fifo bpl size */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_AUDR_LNGTH</span><span class="p">,</span> <span class="n">rds_bpl</span><span class="p">);</span> <span class="cm">/* fifo bpl size */</span>

	<span class="cm">/* enable Up, Down and Audio RDS fifo */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_AUD_DMACNTRL</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx88_stop_audio_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If downstream RISC is enabled, bail out; ALSA is managing DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cx_read</span><span class="p">(</span><span class="n">MO_AUD_DMACNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* stop dma */</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_AUD_DMACNTRL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_tvaudio</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v4l2_std_id</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CX88_VMUX_TELEVISION</span> <span class="o">!=</span> <span class="n">INPUT</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">).</span><span class="n">type</span> <span class="o">&amp;&amp;</span>
	    <span class="n">CX88_VMUX_CABLE</span> <span class="o">!=</span> <span class="n">INPUT</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">).</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_STD_PAL_BG</span> <span class="o">&amp;</span> <span class="n">norm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">tvaudio</span> <span class="o">=</span> <span class="n">WW_BG</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_STD_PAL_DK</span> <span class="o">&amp;</span> <span class="n">norm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">tvaudio</span> <span class="o">=</span> <span class="n">WW_DK</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_STD_PAL_I</span> <span class="o">&amp;</span> <span class="n">norm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">tvaudio</span> <span class="o">=</span> <span class="n">WW_I</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_STD_SECAM_L</span> <span class="o">&amp;</span> <span class="n">norm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">tvaudio</span> <span class="o">=</span> <span class="n">WW_L</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">V4L2_STD_SECAM_B</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM_G</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM_H</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">norm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">tvaudio</span> <span class="o">=</span> <span class="n">WW_BG</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_STD_SECAM_DK</span> <span class="o">&amp;</span> <span class="n">norm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">tvaudio</span> <span class="o">=</span> <span class="n">WW_DK</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">V4L2_STD_NTSC_M</span> <span class="o">&amp;</span> <span class="n">norm</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">V4L2_STD_PAL_M</span>  <span class="o">&amp;</span> <span class="n">norm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">tvaudio</span> <span class="o">=</span> <span class="n">WW_BTSC</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_STD_NTSC_M_JP</span> <span class="o">&amp;</span> <span class="n">norm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">tvaudio</span> <span class="o">=</span> <span class="n">WW_EIAJ</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s/0: tvaudio support needs work for this tv norm [%s], sorry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">v4l2_norm_to_name</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">));</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">tvaudio</span> <span class="o">=</span> <span class="n">WW_NONE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cx_andor</span><span class="p">(</span><span class="n">MO_AFECFG_IO</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">cx88_set_tvaudio</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>
	<span class="cm">/* cx88_set_stereo(dev,V4L2_TUNER_MODE_STEREO); */</span>

<span class="cm">/*</span>
<span class="cm">   This should be needed only on cx88-alsa. It seems that some cx88 chips have</span>
<span class="cm">   bugs and does require DMA enabled for it to work.</span>
<span class="cm"> */</span>
	<span class="n">cx88_start_audio_dma</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">int</span> <span class="nf">cx88_set_tvnorm</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fsc8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">adc_clock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vdec_clock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">step_db</span><span class="p">,</span><span class="n">step_dr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp64</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bdelay</span><span class="p">,</span><span class="n">agcdelay</span><span class="p">,</span><span class="n">htotal</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cxiformat</span><span class="p">,</span> <span class="n">cxoformat</span><span class="p">;</span>

	<span class="n">core</span><span class="o">-&gt;</span><span class="n">tvnorm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">;</span>
	<span class="n">fsc8</span>       <span class="o">=</span> <span class="n">norm_fsc8</span><span class="p">(</span><span class="n">norm</span><span class="p">);</span>
	<span class="n">adc_clock</span>  <span class="o">=</span> <span class="n">xtal</span><span class="p">;</span>
	<span class="n">vdec_clock</span> <span class="o">=</span> <span class="n">fsc8</span><span class="p">;</span>
	<span class="n">step_db</span>    <span class="o">=</span> <span class="n">fsc8</span><span class="p">;</span>
	<span class="n">step_dr</span>    <span class="o">=</span> <span class="n">fsc8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cxiformat</span> <span class="o">=</span> <span class="n">VideoFormatNTSCJapan</span><span class="p">;</span>
		<span class="n">cxoformat</span> <span class="o">=</span> <span class="mh">0x181f0008</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC_443</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cxiformat</span> <span class="o">=</span> <span class="n">VideoFormatNTSC443</span><span class="p">;</span>
		<span class="n">cxoformat</span> <span class="o">=</span> <span class="mh">0x181f0008</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_M</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cxiformat</span> <span class="o">=</span> <span class="n">VideoFormatPALM</span><span class="p">;</span>
		<span class="n">cxoformat</span> <span class="o">=</span> <span class="mh">0x1c1f0008</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_N</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cxiformat</span> <span class="o">=</span> <span class="n">VideoFormatPALN</span><span class="p">;</span>
		<span class="n">cxoformat</span> <span class="o">=</span> <span class="mh">0x1c1f0008</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_Nc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cxiformat</span> <span class="o">=</span> <span class="n">VideoFormatPALNC</span><span class="p">;</span>
		<span class="n">cxoformat</span> <span class="o">=</span> <span class="mh">0x1c1f0008</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_60</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cxiformat</span> <span class="o">=</span> <span class="n">VideoFormatPAL60</span><span class="p">;</span>
		<span class="n">cxoformat</span> <span class="o">=</span> <span class="mh">0x181f0008</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cxiformat</span> <span class="o">=</span> <span class="n">VideoFormatNTSC</span><span class="p">;</span>
		<span class="n">cxoformat</span> <span class="o">=</span> <span class="mh">0x181f0008</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">step_db</span> <span class="o">=</span> <span class="mi">4250000</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">step_dr</span> <span class="o">=</span> <span class="mi">4406250</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">cxiformat</span> <span class="o">=</span> <span class="n">VideoFormatSECAM</span><span class="p">;</span>
		<span class="n">cxoformat</span> <span class="o">=</span> <span class="mh">0x181f0008</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* PAL */</span>
		<span class="n">cxiformat</span> <span class="o">=</span> <span class="n">VideoFormatPAL</span><span class="p">;</span>
		<span class="n">cxoformat</span> <span class="o">=</span> <span class="mh">0x181f0008</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_tvnorm: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> fsc8=%d adc=%d vdec=%d db/dr=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">v4l2_norm_to_name</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">),</span> <span class="n">fsc8</span><span class="p">,</span> <span class="n">adc_clock</span><span class="p">,</span> <span class="n">vdec_clock</span><span class="p">,</span>
		<span class="n">step_db</span><span class="p">,</span> <span class="n">step_dr</span><span class="p">);</span>
	<span class="n">set_pll</span><span class="p">(</span><span class="n">core</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">vdec_clock</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_tvnorm: MO_INPUT_FORMAT  0x%08x [old=0x%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cxiformat</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">MO_INPUT_FORMAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="cm">/* Chroma AGC must be disabled if SECAM is used, we enable it</span>
<span class="cm">	   by default on PAL and NTSC */</span>
	<span class="n">cx_andor</span><span class="p">(</span><span class="n">MO_INPUT_FORMAT</span><span class="p">,</span> <span class="mh">0x40f</span><span class="p">,</span>
		 <span class="n">norm</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span> <span class="o">?</span> <span class="n">cxiformat</span> <span class="o">:</span> <span class="n">cxiformat</span> <span class="o">|</span> <span class="mh">0x400</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>FIXME: as-is from DScaler</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_tvnorm: MO_OUTPUT_FORMAT 0x%08x [old=0x%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cxoformat</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">MO_OUTPUT_FORMAT</span><span class="p">));</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_OUTPUT_FORMAT</span><span class="p">,</span> <span class="n">cxoformat</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>MO<em>SCONV</em>REG = adc clock / video dec clock * 2^17</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmp64</span>  <span class="o">=</span> <span class="n">adc_clock</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">);</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">tmp64</span><span class="p">,</span> <span class="n">vdec_clock</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_tvnorm: MO_SCONV_REG     0x%08x [old=0x%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tmp64</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">MO_SCONV_REG</span><span class="p">));</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_SCONV_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tmp64</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>MO<em>SUB</em>STEP = 8 * fsc / video dec clock * 2^22</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmp64</span>  <span class="o">=</span> <span class="n">step_db</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">tmp64</span><span class="p">,</span> <span class="n">vdec_clock</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_tvnorm: MO_SUB_STEP      0x%08x [old=0x%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tmp64</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">MO_SUB_STEP</span><span class="p">));</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_SUB_STEP</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tmp64</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>MO<em>SUB</em>STEP_DR = 8 * 4406250 / video dec clock * 2^22</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmp64</span>  <span class="o">=</span> <span class="n">step_dr</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">tmp64</span><span class="p">,</span> <span class="n">vdec_clock</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_tvnorm: MO_SUB_STEP_DR   0x%08x [old=0x%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tmp64</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">MO_SUB_STEP_DR</span><span class="p">));</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_SUB_STEP_DR</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tmp64</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>bdelay + agcdelay</p></td><td class="code"><div class="highlight"><pre>	<span class="n">bdelay</span>   <span class="o">=</span> <span class="n">vdec_clock</span> <span class="o">*</span> <span class="mi">65</span> <span class="o">/</span> <span class="mi">20000000</span> <span class="o">+</span> <span class="mi">21</span><span class="p">;</span>
	<span class="n">agcdelay</span> <span class="o">=</span> <span class="n">vdec_clock</span> <span class="o">*</span> <span class="mi">68</span> <span class="o">/</span> <span class="mi">20000000</span> <span class="o">+</span> <span class="mi">15</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_tvnorm: MO_AGC_BURST     0x%08x [old=0x%08x,bdelay=%d,agcdelay=%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">bdelay</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agcdelay</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">MO_AGC_BURST</span><span class="p">),</span> <span class="n">bdelay</span><span class="p">,</span> <span class="n">agcdelay</span><span class="p">);</span>
	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_AGC_BURST</span><span class="p">,</span> <span class="p">(</span><span class="n">bdelay</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agcdelay</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>htotal</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmp64</span> <span class="o">=</span> <span class="n">norm_htotal</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">vdec_clock</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">tmp64</span><span class="p">,</span> <span class="n">fsc8</span><span class="p">);</span>
	<span class="n">htotal</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tmp64</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;set_tvnorm: MO_HTOTAL        0x%08x [old=0x%08x,htotal=%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">htotal</span><span class="p">,</span> <span class="n">cx_read</span><span class="p">(</span><span class="n">MO_HTOTAL</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tmp64</span><span class="p">);</span>
	<span class="n">cx_andor</span><span class="p">(</span><span class="n">MO_HTOTAL</span><span class="p">,</span> <span class="mh">0x07ff</span><span class="p">,</span> <span class="n">htotal</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>vbi stuff, set vbi offset to 10 (for 20 Clk*2 pixels), this makes
the effective vbi offset ~244 samples, the same as the Bt8x8</p></td><td class="code"><div class="highlight"><pre>	<span class="n">cx_write</span><span class="p">(</span><span class="n">MO_VBI_PACKET</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">norm_vbipack</span><span class="p">(</span><span class="n">norm</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>this is needed as well to set all tvnorm parameter</p></td><td class="code"><div class="highlight"><pre>	<span class="n">cx88_set_scale</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>audio</p></td><td class="code"><div class="highlight"><pre>	<span class="n">set_tvaudio</span><span class="p">(</span><span class="n">core</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>tell i2c chips</p></td><td class="code"><div class="highlight"><pre>	<span class="n">call_all</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="n">norm</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>done</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="nf">cx88_vdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">template_</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vfd</span><span class="p">;</span>

	<span class="n">vfd</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">vfd</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">vfd</span> <span class="o">=</span> <span class="o">*</span><span class="n">template_</span><span class="p">;</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">video_device_release</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s %s (%s)&quot;</span><span class="p">,</span>
		 <span class="n">core</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">vfd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cx88_core</span><span class="o">*</span> <span class="nf">cx88_core_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88_devlist</span><span class="p">,</span> <span class="n">devlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">pci_slot</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">cx88_get_resources</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">pci</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devlist</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devlist</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">core</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">core</span> <span class="o">=</span> <span class="n">cx88_core_create</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">cx88_devcount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">core</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx88_devcount</span><span class="o">++</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx88_devlist</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">core</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx88_core_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx88_core</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
			   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">cx88_ir_fini</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">i2c_rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">i2c_rtc</span><span class="p">)</span>
			<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">i2c_rtc</span><span class="p">);</span>
		<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lmmio</span><span class="p">);</span>
	<span class="n">cx88_devcount</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_print_irqbits</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_core_irq</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_wakeup</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_reset</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_shutdown</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_risc_buffer</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_risc_databuffer</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_risc_stopper</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_free_buffer</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_sram_channels</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_sram_channel_setup</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_sram_channel_dump</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_set_tvnorm</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_set_scale</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_vdev_init</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_core_get</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_core_put</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_ir_start</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx88_ir_stop</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> * kate: eol &quot;unix&quot;; indent-width 3; remove-trailing-space on; replace-trailing-space-save on; tab-width 8; replace-tabs off; space-indent off; mixed-indent off</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
