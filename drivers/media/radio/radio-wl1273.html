<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › radio › radio-wl1273.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>radio-wl1273.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for the Texas Instruments WL1273 FM radio.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Nokia Corporation</span>
<span class="cm"> * Author: Matti J. Aaltonen &lt;matti.j.aaltonen@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/wl1273-core.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>

<span class="cp">#define DRIVER_DESC &quot;Wl1273 FM Radio&quot;</span>

<span class="cp">#define WL1273_POWER_SET_OFF		0</span>
<span class="cp">#define WL1273_POWER_SET_FM		BIT(0)</span>
<span class="cp">#define WL1273_POWER_SET_RDS		BIT(1)</span>
<span class="cp">#define WL1273_POWER_SET_RETENTION	BIT(4)</span>

<span class="cp">#define WL1273_PUPD_SET_OFF		0x00</span>
<span class="cp">#define WL1273_PUPD_SET_ON		0x01</span>
<span class="cp">#define WL1273_PUPD_SET_RETENTION	0x10</span>

<span class="cp">#define WL1273_FREQ(x)		(x * 10000 / 625)</span>
<span class="cp">#define WL1273_INV_FREQ(x)	(x * 625 / 10000)</span>

<span class="cm">/*</span>
<span class="cm"> * static int radio_nr - The number of the radio device</span>
<span class="cm"> *</span>
<span class="cm"> * The default is 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">radio_nr</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span> <span class="s">&quot;The number of the radio device. Default = 0&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bus_type</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">forbidden</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">preemphasis</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spacing</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_power</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_frequency</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_frequency</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rangelow</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rangehigh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">band</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">stereo</span><span class="p">;</span>

	<span class="cm">/* RDS */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rds_on</span><span class="p">;</span>

	<span class="n">wait_queue_head_t</span> <span class="n">read_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span> <span class="cm">/* for serializing fm radio operations */</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">busy</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rd_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wr_index</span><span class="p">;</span>

	<span class="cm">/* Selected interrupts */</span>
	<span class="n">u16</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">irq_received</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="n">ctrl_handler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="n">v4l2dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="n">videodev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">write_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rds_users</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define WL1273_IRQ_MASK	 (WL1273_FR_EVENT		|	\</span>
<span class="cp">			  WL1273_POW_ENB_EVENT)</span>

<span class="cm">/*</span>
<span class="cm"> * static unsigned int rds_buf - the number of RDS buffer blocks used.</span>
<span class="cm"> *</span>
<span class="cm"> * The default number is 100.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rds_buf</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rds_buf</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rds_buf</span><span class="p">,</span> <span class="s">&quot;Number of RDS buffer entries. Default = 100&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_write_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span><span class="p">,</span>
			      <span class="n">__u8</span> <span class="o">*</span><span class="n">fw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">fw</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">fw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">fw</span> <span class="o">+=</span> <span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:len[%d]: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: i: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: len + 1: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Last transfer always fails. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">len</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WL1273_FIFO_HAS_DATA(status)	(1 &lt;&lt; 5 &amp; status)</span>
<span class="cp">#define WL1273_RDS_CORRECTABLE_ERROR	(1 &lt;&lt; 3)</span>
<span class="cp">#define WL1273_RDS_UNCORRECTABLE_ERROR	(1 &lt;&lt; 4)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_rds</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b0</span> <span class="o">=</span> <span class="n">WL1273_RDS_DATA_GET</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rds_data</span> <span class="n">rds</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rds</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rds</span><span class="p">),</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RDS_SYNC_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* RDS decoder not synchronized */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* copy all four RDS blocks to internal buffer */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">WL1273_FM_DRIVER_NAME</span>
				<span class="s">&quot;: %s: read_rds error r == %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">rds</span><span class="p">.</span><span class="n">block</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WL1273_FIFO_HAS_DATA</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* copy bits 0-2 (the block ID) to bits 3-5 */</span>
		<span class="n">rds</span><span class="p">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">V4L2_RDS_BLOCK_MSK</span> <span class="o">&amp;</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">rds</span><span class="p">.</span><span class="n">block</span> <span class="o">|=</span> <span class="n">rds</span><span class="p">.</span><span class="n">block</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>

		<span class="cm">/* copy the error bits to standard positions */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WL1273_RDS_UNCORRECTABLE_ERROR</span> <span class="o">&amp;</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rds</span><span class="p">.</span><span class="n">block</span> <span class="o">|=</span> <span class="n">V4L2_RDS_BLOCK_ERROR</span><span class="p">;</span>
			<span class="n">rds</span><span class="p">.</span><span class="n">block</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_RDS_BLOCK_CORRECTED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span>  <span class="p">(</span><span class="n">WL1273_RDS_CORRECTABLE_ERROR</span> <span class="o">&amp;</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rds</span><span class="p">.</span><span class="n">block</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_RDS_BLOCK_ERROR</span><span class="p">;</span>
			<span class="n">rds</span><span class="p">.</span><span class="n">block</span> <span class="o">|=</span> <span class="n">V4L2_RDS_BLOCK_CORRECTED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* copy RDS block to internal buffer */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">rds</span><span class="p">,</span> <span class="n">RDS_BLOCK_SIZE</span><span class="p">);</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

		<span class="cm">/* wrap write pointer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span> <span class="o">&gt;=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">)</span>
			<span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* check for overflow &amp; start over */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span> <span class="o">==</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RDS OVERFLOW&quot;</span><span class="p">);</span>

			<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">WL1273_FIFO_HAS_DATA</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

	<span class="cm">/* wake up read queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span> <span class="o">!=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span><span class="p">)</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">read_queue</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">wl1273_fm_irq_thread_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_FLAG_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_BL_EVENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_received</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: BL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_RDS_EVENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

		<span class="n">wl1273_fm_rds</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_BBLK_EVENT</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: BBLK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_LSYNC_EVENT</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: LSYNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_LEV_EVENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">level</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RSSI_LVL_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: LEV: 0x%x04</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_IFFR_EVENT</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: IFFR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_PI_EVENT</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: PI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_PD_EVENT</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: PD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_STIC_EVENT</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: STIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_MAL_EVENT</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: MAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_POW_ENB_EVENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NOT BUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: POW_ENB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_SCAN_OVER_EVENT</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: SCAN_OVER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_ERROR_EVENT</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WL1273_FR_EVENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">freq</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: FR:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_TUNER_MODE_SET</span><span class="p">,</span>
					<span class="n">TUNER_MODE_STOP_SEARCH</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s: TUNER_MODE_SET fails: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_FREQ_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">WL1273_BAND_JAPAN</span><span class="p">)</span>
				<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rx_frequency</span> <span class="o">=</span> <span class="n">WL1273_BAND_JAPAN_LOW</span> <span class="o">+</span>
					<span class="n">freq</span> <span class="o">*</span> <span class="mi">50</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rx_frequency</span> <span class="o">=</span> <span class="n">WL1273_BAND_OTHER_LOW</span> <span class="o">+</span>
					<span class="n">freq</span> <span class="o">*</span> <span class="mi">50</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 *  The driver works better with this msleep,</span>
<span class="cm">			 *  the documentation doesn&#39;t mention it.</span>
<span class="cm">			 */</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">15000</span><span class="p">);</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%dkHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rx_frequency</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_CHANL_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%dkHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: NOT BUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_INT_MASK_SET</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_set_tx_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">WL1273_BAND_TX_LOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Frequency out of range: %d &lt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span>
			<span class="n">WL1273_BAND_TX_LOW</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">WL1273_BAND_TX_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Frequency out of range: %d &gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span>
			<span class="n">WL1273_BAND_TX_HIGH</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  The driver works better with this sleep,</span>
<span class="cm">	 *  the documentation doesn&#39;t mention it.</span>
<span class="cm">	 */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: freq: %d kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="cm">/* Set the current tx channel */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_CHANL_SET</span><span class="p">,</span> <span class="n">freq</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>

	<span class="cm">/* wait for the FR IRQ */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;WL1273_CHANL_SET: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="cm">/* Enable the output power */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_POWER_ENB_SET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>

	<span class="cm">/* wait for the POWER_ENB IRQ */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">tx_frequency</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;WL1273_POWER_ENB_SET: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="k">return</span>	<span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_set_rx_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rangelow</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Frequency out of range: %d &lt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span>
			<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rangelow</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rangehigh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Frequency out of range: %d &gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span>
			<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rangehigh</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %dkHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_INT_MASK_SET</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">WL1273_BAND_JAPAN</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">-</span> <span class="n">WL1273_BAND_JAPAN_LOW</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">-</span> <span class="n">WL1273_BAND_OTHER_LOW</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_FREQ_SET</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FREQ_SET fails</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_TUNER_MODE_SET</span><span class="p">,</span> <span class="n">TUNER_MODE_PRESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TUNER_MODE_SET fails</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rx_frequency</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_FREQ_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Freq get: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">WL1273_BAND_JAPAN</span><span class="p">)</span>
			<span class="n">freq</span> <span class="o">=</span> <span class="n">WL1273_BAND_JAPAN_LOW</span> <span class="o">+</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">f</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">freq</span> <span class="o">=</span> <span class="n">WL1273_BAND_OTHER_LOW</span> <span class="o">+</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">f</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_CHANL_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

		<span class="n">freq</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">freq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wl1273_fm_upload_firmware_patch() -	Upload the firmware.</span>
<span class="cm"> * @radio:				A pointer to the device struct.</span>
<span class="cm"> *</span>
<span class="cm"> * The firmware file consists of arrays of bytes where the first byte</span>
<span class="cm"> * gives the array length. The first byte in the file gives the</span>
<span class="cm"> * number of these arrays.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_upload_firmware_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">packet_num</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_p</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span> <span class="o">=</span> <span class="s">&quot;radio-wl1273-fw.bin&quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Uploading the firmware patch is not always necessary,</span>
<span class="cm">	 * so we only print an info message.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_p</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - %s not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">fw_p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">packet_num</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: packets: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">packet_num</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_write_fw</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">packet_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FW upload error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ignore possible error here */</span>
	<span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - download OK, r: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_p</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_POWER_SET</span><span class="p">,</span>
				    <span class="n">WL1273_POWER_SET_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: POWER_SET fails: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_PUPD_SET</span><span class="p">,</span>
				    <span class="n">WL1273_PUPD_SET_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: PUPD_SET fails: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">();</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Back to reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1273_fm_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Out of reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">();</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">WL1273_POWER_SET_FM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_on</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">WL1273_POWER_SET_RDS</span><span class="p">;</span>

		<span class="cm">/* If this fails try again */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_POWER_SET</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_POWER_SET</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: POWER_SET fails</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* rds buffer configuration */</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If this fails try again once */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_PUPD_SET</span><span class="p">,</span> <span class="n">WL1273_PUPD_SET_ON</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_PUPD_SET</span><span class="p">,</span>
					<span class="n">WL1273_PUPD_SET_ON</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: PUPD_SET fails</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_on</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RDS_DATA_ENB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RDS_DATA_ENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Illegal mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_upload_firmware_patch</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Firmware upload failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Sometimes the chip is in a wrong power state at this point.</span>
<span class="cm">		 * So we set the power once again.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">WL1273_POWER_SET_FM</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_on</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">WL1273_POWER_SET_RDS</span><span class="p">;</span>

			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_POWER_SET</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: POWER_SET fails</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_TX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_PUPD_SET</span><span class="p">,</span>
					<span class="n">WL1273_PUPD_SET_ON</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: PUPD_SET fails</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">();</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: return: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Cannot go from OFF to SUSPENDED */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_POWER_SET</span><span class="p">,</span>
				<span class="n">WL1273_POWER_SET_RETENTION</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_TX</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_PUPD_SET</span><span class="p">,</span>
				<span class="n">WL1273_PUPD_SET_RETENTION</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: POWER_SET fails: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Forbidden modes: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">forbidden</span><span class="p">);</span>

	<span class="n">old_mode</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">forbidden</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WL1273_MODE_RX</span>:
	<span class="k">case</span> <span class="n">WL1273_MODE_TX</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_start</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Cannot start.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl1273_fm_stop</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_INT_MASK_SET</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;INT_MASK_SET fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* remember previous settings */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_rx_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rx_frequency</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set freq fails: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">set_volume</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set volume fails: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Set vol: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">core</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_tx_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">tx_frequency</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set freq fails: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Set audio mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">set_audio</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot set audio mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WL1273_MODE_OFF</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_stop</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Off fails: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WL1273_MODE_OFF</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WL1273_MODE_SUSPENDED</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_suspend</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Suspend fails: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WL1273_MODE_SUSPENDED</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Unknown mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">old_mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_set_seek</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wrap_around</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seek_upward</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">seek_upward</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">f</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rx_frequency</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx_frequency: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&amp;&amp;</span> <span class="n">f</span> <span class="o">+</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">spacing</span> <span class="o">&lt;=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rangehigh</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_rx_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">f</span> <span class="o">+</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">spacing</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&amp;&amp;</span> <span class="n">wrap_around</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_rx_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rangelow</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">spacing</span> <span class="o">&gt;=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rangelow</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_rx_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">f</span> <span class="o">-</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">spacing</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wrap_around</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_rx_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rangehigh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">SCHAR_MIN</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">SCHAR_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: BUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_INT_MASK_SET</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_SEARCH_LVL_SET</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_SEARCH_DIR_SET</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_TUNER_MODE_SET</span><span class="p">,</span> <span class="n">TUNER_MODE_AUTO_SEEK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_received</span> <span class="o">&amp;</span> <span class="n">WL1273_BL_EVENT</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_received</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WL1273_BL_EVENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrap_around</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Wrap around */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Wrap around in HW seek.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seek_upward</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rangelow</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rangehigh</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_rx_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: BUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_TUNER_MODE_SET</span><span class="p">,</span> <span class="n">TUNER_MODE_AUTO_SEEK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wl1273_fm_get_tx_ctune() -	Get the TX tuning capacitor value.</span>
<span class="cm"> * @radio:			A pointer to the device struct.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">wl1273_fm_get_tx_ctune</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_OFF</span> <span class="o">||</span>
	    <span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_SUSPENDED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_READ_FMANT_TUNE_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: read error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wl1273_fm_set_preemphasis() - Set the TX pre-emphasis value.</span>
<span class="cm"> * @radio:			 A pointer to the device struct.</span>
<span class="cm"> * @preemphasis:		 The new pre-amphasis value.</span>
<span class="cm"> *</span>
<span class="cm"> * Possible pre-emphasis values are: V4L2_PREEMPHASIS_DISABLED,</span>
<span class="cm"> * V4L2_PREEMPHASIS_50_uS and V4L2_PREEMPHASIS_75_uS.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_set_preemphasis</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">preemphasis</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">em</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_OFF</span> <span class="o">||</span>
	    <span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_SUSPENDED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">preemphasis</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_PREEMPHASIS_DISABLED</span>:
		<span class="n">em</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PREEMPHASIS_50_uS</span>:
		<span class="n">em</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PREEMPHASIS_75_uS</span>:
		<span class="n">em</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_PREMPH_SET</span><span class="p">,</span> <span class="n">em</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">preemphasis</span> <span class="o">=</span> <span class="n">preemphasis</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_rds_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_on</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_POWER_SET</span><span class="p">,</span>
			<span class="n">WL1273_POWER_SET_FM</span> <span class="o">|</span> <span class="n">WL1273_POWER_SET_RDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_rx_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rx_frequency</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set freq fails: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_rds_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_on</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WL1273_RDS_EVENT</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_INT_MASK_SET</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Service pending read */</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">read_queue</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_POWER_SET</span><span class="p">,</span> <span class="n">WL1273_POWER_SET_FM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_rx_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rx_frequency</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set freq fails: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: exiting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_set_rds</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_OFF</span> <span class="o">||</span>
	    <span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_SUSPENDED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">WL1273_RDS_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RDS_CNTRL_SET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_TX</span> <span class="o">&amp;&amp;</span> <span class="n">new_mode</span> <span class="o">==</span> <span class="n">WL1273_RDS_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RDS_DATA_ENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_TX</span> <span class="o">&amp;&amp;</span> <span class="n">new_mode</span> <span class="o">==</span> <span class="n">WL1273_RDS_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RDS_DATA_ENB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span> <span class="o">&amp;&amp;</span> <span class="n">new_mode</span> <span class="o">==</span> <span class="n">WL1273_RDS_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_rds_off</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span> <span class="o">&amp;&amp;</span> <span class="n">new_mode</span> <span class="o">==</span> <span class="n">WL1273_RDS_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_rds_on</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Unknown mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_on</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">WL1273_RDS_ON</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">wl1273_fm_fops_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">WL1273_MODE_TX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: RDS not on.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Multiple processes can open the device, but only</span>
<span class="cm">	 * one gets to write to it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">&amp;&amp;</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>

	<span class="cm">/* Manual Mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RDS_CONFIG_DATA_SET</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">write_buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;From user: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">);</span>

	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WL1273_RDS_DATA_SET</span><span class="p">;</span>
	<span class="n">core</span><span class="o">-&gt;</span><span class="n">write_data</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">,</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">wl1273_fm_fops_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">pts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">&amp;&amp;</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">read_queue</span><span class="p">,</span> <span class="n">pts</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span> <span class="o">!=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_fops_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span> <span class="o">&amp;&amp;</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_on</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_users</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_flags</span> <span class="o">|=</span> <span class="n">WL1273_RDS_EVENT</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_INT_MASK_SET</span><span class="p">,</span>
				<span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_users</span><span class="o">++</span><span class="p">;</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_fops_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_users</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_users</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

			<span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WL1273_RDS_EVENT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span>
						<span class="n">WL1273_INT_MASK_SET</span><span class="p">,</span>
						<span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">)</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">wl1273_fm_fops_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: RDS not on.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Multiple processes can open the device, but only</span>
<span class="cm">	 * one at a time gets read access.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">&amp;&amp;</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RDS_SYNC_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get RDS_SYNC fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RDS_SYNC: Not synchronized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* block if no new data available */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span> <span class="o">==</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Wait for RDS data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">read_queue</span><span class="p">,</span>
					     <span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span> <span class="o">!=</span>
					     <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* calculate block count from byte count */</span>
	<span class="n">count</span> <span class="o">/=</span> <span class="n">RDS_BLOCK_SIZE</span><span class="p">;</span>

	<span class="cm">/* copy RDS blocks from the internal buffer and to user buffer */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">block_count</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span> <span class="o">==</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* always transfer complete RDS blocks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span><span class="p">],</span>
				 <span class="n">RDS_BLOCK_SIZE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* increment and wrap the read pointer */</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span> <span class="o">+=</span> <span class="n">RDS_BLOCK_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span> <span class="o">&gt;=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">)</span>
			<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* increment counters */</span>
		<span class="n">block_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">RDS_BLOCK_SIZE</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">+=</span> <span class="n">RDS_BLOCK_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">wl1273_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">wl1273_fm_fops_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">wl1273_fm_fops_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">wl1273_fm_fops_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">wl1273_fm_fops_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">wl1273_fm_fops_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">capability</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">capability</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">WL1273_FM_DRIVER_NAME</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">capability</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">capability</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;Texas Instruments Wl1273 FM Radio&quot;</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">capability</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">capability</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">capability</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>

	<span class="n">capability</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_HW_FREQ_SEEK</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_TUNER</span> <span class="o">|</span> <span class="n">V4L2_CAP_RADIO</span> <span class="o">|</span> <span class="n">V4L2_CAP_AUDIO</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_RDS_CAPTURE</span> <span class="o">|</span> <span class="n">V4L2_CAP_MODULATOR</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_RDS_OUTPUT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wl1273_fm_set_tx_power() -	Set the transmission power value.</span>
<span class="cm"> * @core:			A pointer to the device struct.</span>
<span class="cm"> * @power:			The new power value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_set_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="n">u16</span> <span class="n">power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_OFF</span> <span class="o">||</span>
	    <span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_SUSPENDED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Convert the dBuV value to chip presentation */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_POWER_LEV_SET</span><span class="p">,</span> <span class="mi">122</span> <span class="o">-</span> <span class="n">power</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">tx_power</span> <span class="o">=</span> <span class="n">power</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WL1273_SPACING_50kHz	1</span>
<span class="cp">#define WL1273_SPACING_100kHz	2</span>
<span class="cp">#define WL1273_SPACING_200kHz	4</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_tx_set_spacing</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spacing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spacing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_SCAN_SPACING_SET</span><span class="p">,</span>
				<span class="n">WL1273_SPACING_100kHz</span><span class="p">);</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">spacing</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spacing</span> <span class="o">-</span> <span class="mi">50000</span> <span class="o">&lt;</span> <span class="mi">25000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_SCAN_SPACING_SET</span><span class="p">,</span>
				<span class="n">WL1273_SPACING_50kHz</span><span class="p">);</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">spacing</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spacing</span> <span class="o">-</span> <span class="mi">100000</span> <span class="o">&lt;</span> <span class="mi">50000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_SCAN_SPACING_SET</span><span class="p">,</span>
				<span class="n">WL1273_SPACING_100kHz</span><span class="p">);</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">spacing</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_SCAN_SPACING_SET</span><span class="p">,</span>
				<span class="n">WL1273_SPACING_200kHz</span><span class="p">);</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">spacing</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_g_volatile_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span>  <span class="n">V4L2_CID_TUNE_ANTENNA_CAPACITOR</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">wl1273_fm_get_tx_ctune</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Unknown IOCTL: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WL1273_MUTE_SOFT_ENABLE    (1 &lt;&lt; 0)</span>
<span class="cp">#define WL1273_MUTE_AC             (1 &lt;&lt; 1)</span>
<span class="cp">#define WL1273_MUTE_HARD_LEFT      (1 &lt;&lt; 2)</span>
<span class="cp">#define WL1273_MUTE_HARD_RIGHT     (1 &lt;&lt; 3)</span>
<span class="cp">#define WL1273_MUTE_SOFT_FORCE     (1 &lt;&lt; 4)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="nf">to_radio</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl1273_device</span><span class="p">,</span> <span class="n">ctrl_handler</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">to_radio</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span> <span class="o">&amp;&amp;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span>
					<span class="n">WL1273_MUTE_STATUS_SET</span><span class="p">,</span>
					<span class="n">WL1273_MUTE_HARD_LEFT</span> <span class="o">|</span>
					<span class="n">WL1273_MUTE_HARD_RIGHT</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span>
					<span class="n">WL1273_MUTE_STATUS_SET</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_TX</span> <span class="o">&amp;&amp;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_MUTE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_TX</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_MUTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_mode</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">WL1273_MODE_OFF</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span>  <span class="n">core</span><span class="o">-&gt;</span><span class="n">set_volume</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">volume</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_PREEMPHASIS</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_preemphasis</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_POWER_LEVEL</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_tx_power</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Unknown IOCTL: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_g_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">audio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Radio&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_AUDCAP_STEREO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_s_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">audio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WL1273_RDS_NOT_SYNCHRONIZED 0</span>
<span class="cp">#define WL1273_RDS_SYNCHRONIZED 1</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">tuner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tuner</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">tuner</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">WL1273_FM_DRIVER_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tuner</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">;</span>

	<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rangelow</span>	<span class="o">=</span> <span class="n">WL1273_FREQ</span><span class="p">(</span><span class="n">WL1273_BAND_JAPAN_LOW</span><span class="p">);</span>
	<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rangehigh</span> <span class="o">=</span> <span class="n">WL1273_FREQ</span><span class="p">(</span><span class="n">WL1273_BAND_OTHER_HIGH</span><span class="p">);</span>

	<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_TUNER_CAP_LOW</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_RDS</span> <span class="o">|</span>
		<span class="n">V4L2_TUNER_CAP_STEREO</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_RDS_BLOCK_IO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">stereo</span><span class="p">)</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_STEREO_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RSSI_LVL_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Signal: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tuner</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">);</span>

	<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">afc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RDS_SYNC_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">WL1273_RDS_SYNCHRONIZED</span><span class="p">)</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_SUB_RDS</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_s_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">tuner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tuner-&gt;index: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tuner</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tuner-&gt;name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tuner</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tuner-&gt;capability: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tuner</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tuner-&gt;rxsubchans: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rxsubchans</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tuner-&gt;rangelow: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rangelow</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tuner-&gt;rangehigh: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rangehigh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tuner</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_mode</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">WL1273_MODE_RX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_RDS</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_rds</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">WL1273_RDS_ON</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_rds</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">WL1273_RDS_OFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: RDS fails: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tuner</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_MOST_MODE_SET</span><span class="p">,</span> <span class="n">WL1273_RX_MONO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: MOST_MODE fails: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">stereo</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_MOST_MODE_SET</span><span class="p">,</span> <span class="n">WL1273_RX_STEREO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: MOST_MODE fails: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">stereo</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: tuner-&gt;audmode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">tuner</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_g_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">freq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">;</span>
	<span class="n">freq</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">WL1273_FREQ</span><span class="p">(</span><span class="n">wl1273_fm_get_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_s_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;freq-&gt;type != V4L2_TUNER_RADIO: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;freq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_rx_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span>
					  <span class="n">WL1273_INV_FREQ</span><span class="p">(</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">WL1273_FM_DRIVER_NAME</span>
				 <span class="s">&quot;: set frequency failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_tx_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span>
					  <span class="n">WL1273_INV_FREQ</span><span class="p">(</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">WL1273_FM_DRIVER_NAME</span>
				 <span class="s">&quot;: set frequency failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wl1273_vidioc_s_frequency: DONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WL1273_DEFAULT_SEEK_LEVEL	7</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_s_hw_freq_seek</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">v4l2_hw_freq_seek</span> <span class="o">*</span><span class="n">seek</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seek</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">seek</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_mode</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">WL1273_MODE_RX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_tx_set_spacing</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">seek</span><span class="o">-&gt;</span><span class="n">spacing</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HW seek failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_seek</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">seek</span><span class="o">-&gt;</span><span class="n">wrap_around</span><span class="p">,</span> <span class="n">seek</span><span class="o">-&gt;</span><span class="n">seek_upward</span><span class="p">,</span>
			       <span class="n">WL1273_DEFAULT_SEEK_LEVEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HW seek failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_s_modulator</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_modulator</span> <span class="o">*</span><span class="n">modulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modulator</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_mode</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">WL1273_MODE_TX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modulator</span><span class="o">-&gt;</span><span class="n">txsubchans</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_RDS</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_rds</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">WL1273_RDS_ON</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">wl1273_fm_set_rds</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">WL1273_RDS_OFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modulator</span><span class="o">-&gt;</span><span class="n">txsubchans</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_MONO_SET</span><span class="p">,</span> <span class="n">WL1273_TX_MONO</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_MONO_SET</span><span class="p">,</span>
				<span class="n">WL1273_RX_STEREO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">WL1273_FM_DRIVER_NAME</span>
			 <span class="s">&quot;MONO_SET fails: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_g_modulator</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_modulator</span> <span class="o">*</span><span class="n">modulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">modulator</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">WL1273_FM_DRIVER_NAME</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">modulator</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">modulator</span><span class="o">-&gt;</span><span class="n">rangelow</span> <span class="o">=</span> <span class="n">WL1273_FREQ</span><span class="p">(</span><span class="n">WL1273_BAND_JAPAN_LOW</span><span class="p">);</span>
	<span class="n">modulator</span><span class="o">-&gt;</span><span class="n">rangehigh</span> <span class="o">=</span> <span class="n">WL1273_FREQ</span><span class="p">(</span><span class="n">WL1273_BAND_OTHER_HIGH</span><span class="p">);</span>

	<span class="n">modulator</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span>  <span class="n">V4L2_TUNER_CAP_LOW</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_RDS</span> <span class="o">|</span>
		<span class="n">V4L2_TUNER_CAP_STEREO</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_RDS_BLOCK_IO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">WL1273_MODE_TX</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_MONO_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">WL1273_TX_STEREO</span><span class="p">)</span>
		<span class="n">modulator</span><span class="o">-&gt;</span><span class="n">txsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">modulator</span><span class="o">-&gt;</span><span class="n">txsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_on</span><span class="p">)</span>
		<span class="n">modulator</span><span class="o">-&gt;</span><span class="n">txsubchans</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_SUB_RDS</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_vidioc_log_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_DESC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Mode: Off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Mode: Suspended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_ASIC_ID_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get ASIC_ID fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ASIC_ID: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_ASIC_VER_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get ASIC_VER fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ASIC Version: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_FIRM_VER_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get FIRM_VER fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FW version: %d(0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_BAND_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get BAND fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BAND: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_PUPD_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get PUPD fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PUPD: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_CHANL_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get CHANL fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tx frequency: %dkHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="o">*</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WL1273_MODE_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bf</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rangelow</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_FREQ_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get FREQ fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX Frequency: %dkHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bf</span> <span class="o">+</span> <span class="n">val</span><span class="o">*</span><span class="mi">50</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_MOST_MODE_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get MOST_MODE fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MOST_MODE: Stereo according to blend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MOST_MODE: Force mono output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MOST_MODE: Unexpected value: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_MOST_BLEND_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get MOST_BLEND fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;MOST_BLEND: Switched blend &amp; hysteresis.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MOST_BLEND: Soft blend.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MOST_BLEND: Unexpected val: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_STEREO_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get STEREO fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;STEREO: Not detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;STEREO: Detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;STEREO: Unexpected value: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RSSI_LVL_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get RSSI_LVL fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX signal strength: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_POWER_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get POWER fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;POWER: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_INT_MASK_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get INT_MASK fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;INT_MASK: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_RDS_SYNC_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get RDS_SYNC fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RDS_SYNC: Not synchronized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RDS_SYNC: Synchronized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RDS_SYNC: Unexpected value: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_I2S_MODE_CONFIG_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get I2S_MODE_CONFIG fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;I2S_MODE_CONFIG: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">WL1273_VOLUME_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Get VOLUME fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VOLUME: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1273_vdev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">wl1273_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">wl1273_fm_vidioc_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_volatile_ctrl</span> <span class="o">=</span> <span class="n">wl1273_fm_g_volatile_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">wl1273_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>	<span class="o">=</span> <span class="n">wl1273_fm_vidioc_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>		<span class="o">=</span> <span class="n">wl1273_fm_vidioc_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>		<span class="o">=</span> <span class="n">wl1273_fm_vidioc_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_audio</span>		<span class="o">=</span> <span class="n">wl1273_fm_vidioc_g_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_audio</span>		<span class="o">=</span> <span class="n">wl1273_fm_vidioc_s_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_tuner</span>		<span class="o">=</span> <span class="n">wl1273_fm_vidioc_g_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_tuner</span>		<span class="o">=</span> <span class="n">wl1273_fm_vidioc_s_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_frequency</span>	<span class="o">=</span> <span class="n">wl1273_fm_vidioc_g_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_frequency</span>	<span class="o">=</span> <span class="n">wl1273_fm_vidioc_s_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_hw_freq_seek</span>	<span class="o">=</span> <span class="n">wl1273_fm_vidioc_s_hw_freq_seek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_modulator</span>	<span class="o">=</span> <span class="n">wl1273_fm_vidioc_g_modulator</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_modulator</span>	<span class="o">=</span> <span class="n">wl1273_fm_vidioc_s_modulator</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_log_status</span>      <span class="o">=</span> <span class="n">wl1273_fm_vidioc_log_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">wl1273_viddev_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fops</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">wl1273_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">wl1273_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="n">WL1273_FM_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">wl1273_vdev_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1273_fm_radio_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">*</span><span class="n">core</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">radio</span><span class="p">);</span>
	<span class="n">core</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">free_resources</span><span class="p">();</span>

	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="n">video_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">);</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">v4l2dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">wl1273_fm_radio_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1273_core</span> <span class="o">**</span><span class="n">core</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1273_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">core</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No platform data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">pdata_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">radio</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">radio</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">pdata_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* RDS buffer allocation */</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">rds_buf</span> <span class="o">*</span> <span class="n">RDS_BLOCK_SIZE</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot allocate memory for RDS buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_kmalloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span> <span class="o">=</span> <span class="o">*</span><span class="n">core</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">irq_flags</span> <span class="o">=</span> <span class="n">WL1273_IRQ_MASK</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WL1273_MODE_OFF</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">tx_power</span> <span class="o">=</span> <span class="mi">118</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">=</span> <span class="n">WL1273_AUDIO_ANALOG</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">WL1273_BAND_OTHER</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">i2s_mode</span> <span class="o">=</span> <span class="n">WL1273_I2S_DEF_MODE</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">channel_number</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">volume</span> <span class="o">=</span> <span class="n">WL1273_DEFAULT_VOLUME</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rx_frequency</span> <span class="o">=</span> <span class="n">WL1273_BAND_OTHER_LOW</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">tx_frequency</span> <span class="o">=</span> <span class="n">WL1273_BAND_OTHER_HIGH</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rangelow</span> <span class="o">=</span> <span class="n">WL1273_BAND_OTHER_LOW</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rangehigh</span> <span class="o">=</span> <span class="n">WL1273_BAND_OTHER_HIGH</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">stereo</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="s">&quot;I2C&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">request_resources</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">request_resources</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">WL1273_FM_DRIVER_NAME</span>
				<span class="s">&quot;: Cannot get platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_resources</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					 <span class="n">wl1273_fm_irq_thread_handler</span><span class="p">,</span>
					 <span class="n">IRQF_ONESHOT</span> <span class="o">|</span> <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">,</span>
					 <span class="s">&quot;wl1273-fm&quot;</span><span class="p">,</span> <span class="n">radio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">WL1273_FM_DRIVER_NAME</span>
				<span class="s">&quot;: Unable to register IRQ handler: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_request_irq</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">WL1273_FM_DRIVER_NAME</span> <span class="s">&quot;: Core WL1273 IRQ&quot;</span>
			<span class="s">&quot; not configured&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_resources</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">read_queue</span><span class="p">);</span>

	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">write_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">write_buf_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">v4l2dev</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rds_users</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">v4l2dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot register v4l2_device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">device_register_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* V4L2 configuration */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl1273_viddev_template</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">wl1273_viddev_template</span><span class="p">));</span>

	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">.</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">v4l2dev</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="cm">/* add in ascending ID order */</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl1273_ctrl_ops</span><span class="p">,</span>
			  <span class="n">V4L2_CID_AUDIO_VOLUME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WL1273_MAX_VOLUME</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="n">WL1273_DEFAULT_VOLUME</span><span class="p">);</span>

	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl1273_ctrl_ops</span><span class="p">,</span>
			  <span class="n">V4L2_CID_AUDIO_MUTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">v4l2_ctrl_new_std_menu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl1273_ctrl_ops</span><span class="p">,</span>
			       <span class="n">V4L2_CID_TUNE_PREEMPHASIS</span><span class="p">,</span>
			       <span class="n">V4L2_PREEMPHASIS_75_uS</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
			       <span class="n">V4L2_PREEMPHASIS_50_uS</span><span class="p">);</span>

	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl1273_ctrl_ops</span><span class="p">,</span>
			  <span class="n">V4L2_CID_TUNE_POWER_LEVEL</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">118</span><span class="p">);</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl1273_ctrl_ops</span><span class="p">,</span>
				 <span class="n">V4L2_CID_TUNE_ANTENNA_CAPACITOR</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">)</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_VOLATILE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ctrl handler error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">handler_init_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">,</span> <span class="n">radio</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">radio</span><span class="p">);</span>

	<span class="cm">/* register video device */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">,</span> <span class="n">VFL_TYPE_RADIO</span><span class="p">,</span> <span class="n">radio_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">WL1273_FM_DRIVER_NAME</span>
			<span class="s">&quot;: Could not register video device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">handler_init_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">handler_init_err:</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">v4l2dev</span><span class="p">);</span>
<span class="nl">device_register_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">write_buf</span><span class="p">);</span>
<span class="nl">write_buf_err:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">radio</span><span class="p">);</span>
<span class="nl">err_request_irq:</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">free_resources</span><span class="p">();</span>
<span class="nl">err_resources:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
<span class="nl">err_kmalloc:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
<span class="nl">pdata_err:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">wl1273_fm_radio_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">wl1273_fm_radio_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">wl1273_fm_radio_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;wl1273_fm_radio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">wl1273_fm_radio_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Matti Aaltonen &lt;matti.j.aaltonen@nokia.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:wl1273_fm_radio&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
