<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › radio › si4713-i2c.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>si4713-i2c.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/media/radio/si4713-i2c.c</span>
<span class="cm"> *</span>
<span class="cm"> * Silicon Labs Si4713 FM Radio Transmitter I2C commands.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009 Nokia Corporation</span>
<span class="cm"> * Contact: Eduardo Valentin &lt;eduardo.valentin@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>

<span class="cp">#include &quot;si4713-i2c.h&quot;</span>

<span class="cm">/* module parameters */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0 - 2)&quot;</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Eduardo Valentin &lt;eduardo.valentin@nokia.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;I2C driver for Si4713 FM Radio Transmitter&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;0.0.1&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">si4713_supply_names</span><span class="p">[</span><span class="n">SI4713_NUM_SUPPLIES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;vio&quot;</span><span class="p">,</span>
	<span class="s">&quot;vdd&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define DEFAULT_RDS_PI			0x00</span>
<span class="cp">#define DEFAULT_RDS_PTY			0x00</span>
<span class="cp">#define DEFAULT_RDS_PS_NAME		&quot;&quot;</span>
<span class="cp">#define DEFAULT_RDS_RADIO_TEXT		DEFAULT_RDS_PS_NAME</span>
<span class="cp">#define DEFAULT_RDS_DEVIATION		0x00C8</span>
<span class="cp">#define DEFAULT_RDS_PS_REPEAT_COUNT	0x0003</span>
<span class="cp">#define DEFAULT_LIMITER_RTIME		0x1392</span>
<span class="cp">#define DEFAULT_LIMITER_DEV		0x102CA</span>
<span class="cp">#define DEFAULT_PILOT_FREQUENCY 	0x4A38</span>
<span class="cp">#define DEFAULT_PILOT_DEVIATION		0x1A5E</span>
<span class="cp">#define DEFAULT_ACOMP_ATIME		0x0000</span>
<span class="cp">#define DEFAULT_ACOMP_RTIME		0xF4240L</span>
<span class="cp">#define DEFAULT_ACOMP_GAIN		0x0F</span>
<span class="cp">#define DEFAULT_ACOMP_THRESHOLD 	(-0x28)</span>
<span class="cp">#define DEFAULT_MUTE			0x01</span>
<span class="cp">#define DEFAULT_POWER_LEVEL		88</span>
<span class="cp">#define DEFAULT_FREQUENCY		8800</span>
<span class="cp">#define DEFAULT_PREEMPHASIS		FMPE_EU</span>
<span class="cp">#define DEFAULT_TUNE_RNL		0xFF</span>

<span class="cp">#define to_si4713_device(sd)	container_of(sd, struct si4713_device, sd)</span>

<span class="cm">/* frequency domain transformation (using times 10 to avoid floats) */</span>
<span class="cp">#define FREQDEV_UNIT	100000</span>
<span class="cp">#define FREQV4L2_MULTI	625</span>
<span class="cp">#define si4713_to_v4l2(f)	((f * FREQDEV_UNIT) / FREQV4L2_MULTI)</span>
<span class="cp">#define v4l2_to_si4713(f)	((f * FREQV4L2_MULTI) / FREQDEV_UNIT)</span>
<span class="cp">#define FREQ_RANGE_LOW			7600</span>
<span class="cp">#define FREQ_RANGE_HIGH			10800</span>

<span class="cp">#define MAX_ARGS 7</span>

<span class="cp">#define RDS_BLOCK			8</span>
<span class="cp">#define RDS_BLOCK_CLEAR			0x03</span>
<span class="cp">#define RDS_BLOCK_LOAD			0x04</span>
<span class="cp">#define RDS_RADIOTEXT_2A		0x20</span>
<span class="cp">#define RDS_RADIOTEXT_BLK_SIZE		4</span>
<span class="cp">#define RDS_RADIOTEXT_INDEX_MAX		0x0F</span>
<span class="cp">#define RDS_CARRIAGE_RETURN		0x0D</span>

<span class="cp">#define rds_ps_nblocks(len)	((len / RDS_BLOCK) + (len % RDS_BLOCK ? 1 : 0))</span>

<span class="cp">#define get_status_bit(p, b, m)	(((p) &amp; (m)) &gt;&gt; (b))</span>
<span class="cp">#define set_bits(p, v, b, m)	(((p) &amp; ~(m)) | ((v) &lt;&lt; (b)))</span>

<span class="cp">#define ATTACK_TIME_UNIT	500</span>

<span class="cp">#define POWER_OFF			0x00</span>
<span class="cp">#define POWER_ON			0x01</span>

<span class="cp">#define msb(x)                  ((u8)((u16) x &gt;&gt; 8))</span>
<span class="cp">#define lsb(x)                  ((u8)((u16) x &amp;  0x00FF))</span>
<span class="cp">#define compose_u16(msb, lsb)	(((u16)msb &lt;&lt; 8) | lsb)</span>
<span class="cp">#define check_command_failed(status)	(!(status &amp; SI4713_CTS) || \</span>
<span class="cp">					(status &amp; SI4713_ERR))</span>
<span class="cm">/* mute definition */</span>
<span class="cp">#define set_mute(p)	((p &amp; 1) | ((p &amp; 1) &lt;&lt; 1));</span>
<span class="cp">#define get_mute(p)	(p &amp; 0x01)</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define DBG_BUFFER(device, message, buffer, size)			\</span>
<span class="cp">	{								\</span>
<span class="cp">		int i;							\</span>
<span class="cp">		char str[(size)*5];					\</span>
<span class="cp">		for (i = 0; i &lt; size; i++)				\</span>
<span class="cp">			sprintf(str + i * 5, &quot; 0x%02x&quot;, buffer[i]);	\</span>
<span class="cp">		v4l2_dbg(2, debug, device, &quot;%s:%s\n&quot;, message, str);	\</span>
<span class="cp">	}</span>
<span class="cp">#else</span>
<span class="cp">#define DBG_BUFFER(device, message, buffer, size)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Values for limiter release time (sorted by second column)</span>
<span class="cm"> *	device	release</span>
<span class="cm"> *	value	time (us)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">limiter_times</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2000</span><span class="p">,</span>	<span class="mi">250</span><span class="p">,</span>
	<span class="mi">1000</span><span class="p">,</span>	<span class="mi">500</span><span class="p">,</span>
	<span class="mi">510</span><span class="p">,</span>	<span class="mi">1000</span><span class="p">,</span>
	<span class="mi">255</span><span class="p">,</span>	<span class="mi">2000</span><span class="p">,</span>
	<span class="mi">170</span><span class="p">,</span>	<span class="mi">3000</span><span class="p">,</span>
	<span class="mi">127</span><span class="p">,</span>	<span class="mi">4020</span><span class="p">,</span>
	<span class="mi">102</span><span class="p">,</span>	<span class="mi">5010</span><span class="p">,</span>
	<span class="mi">85</span><span class="p">,</span>	<span class="mi">6020</span><span class="p">,</span>
	<span class="mi">73</span><span class="p">,</span>	<span class="mi">7010</span><span class="p">,</span>
	<span class="mi">64</span><span class="p">,</span>	<span class="mi">7990</span><span class="p">,</span>
	<span class="mi">57</span><span class="p">,</span>	<span class="mi">8970</span><span class="p">,</span>
	<span class="mi">51</span><span class="p">,</span>	<span class="mi">10030</span><span class="p">,</span>
	<span class="mi">25</span><span class="p">,</span>	<span class="mi">20470</span><span class="p">,</span>
	<span class="mi">17</span><span class="p">,</span>	<span class="mi">30110</span><span class="p">,</span>
	<span class="mi">13</span><span class="p">,</span>	<span class="mi">39380</span><span class="p">,</span>
	<span class="mi">10</span><span class="p">,</span>	<span class="mi">51190</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span>	<span class="mi">63690</span><span class="p">,</span>
	<span class="mi">7</span><span class="p">,</span>	<span class="mi">73140</span><span class="p">,</span>
	<span class="mi">6</span><span class="p">,</span>	<span class="mi">85330</span><span class="p">,</span>
	<span class="mi">5</span><span class="p">,</span>	<span class="mi">102390</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Values for audio compression release time (sorted by second column)</span>
<span class="cm"> *	device	release</span>
<span class="cm"> *	value	time (us)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">acomp_rtimes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>	<span class="mi">100000</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>	<span class="mi">200000</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>	<span class="mi">350000</span><span class="p">,</span>
	<span class="mi">3</span><span class="p">,</span>	<span class="mi">525000</span><span class="p">,</span>
	<span class="mi">4</span><span class="p">,</span>	<span class="mi">1000000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Values for preemphasis (sorted by second column)</span>
<span class="cm"> *	device	preemphasis</span>
<span class="cm"> *	value	value (v4l2)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">preemphasis_values</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">FMPE_DISABLED</span><span class="p">,</span>	<span class="n">V4L2_PREEMPHASIS_DISABLED</span><span class="p">,</span>
	<span class="n">FMPE_EU</span><span class="p">,</span>	<span class="n">V4L2_PREEMPHASIS_50_uS</span><span class="p">,</span>
	<span class="n">FMPE_USA</span><span class="p">,</span>	<span class="n">V4L2_PREEMPHASIS_75_uS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usecs_to_dev</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">usecs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">array</span><span class="p">[],</span>
			<span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">array</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">usecs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dev_to_usecs</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">array</span><span class="p">[],</span>
			<span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">array</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* si4713_handler: IRQ handler, just complete work */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">si4713_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
			<span class="s">&quot;%s: sending signal to completion work.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_send_command - sends a command to si4713 and waits its response</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> * @command: command id</span>
<span class="cm"> * @args: command arguments we are sending (up to 7)</span>
<span class="cm"> * @argn: actual size of @args</span>
<span class="cm"> * @response: buffer to place the expected response from the device (up to 15)</span>
<span class="cm"> * @respn: actual size of @response</span>
<span class="cm"> * @usecs: amount of time to wait before reading the response (in usecs)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">command</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="n">args</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">argn</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">response</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">respn</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">usecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">data1</span><span class="p">[</span><span class="n">MAX_ARGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* First send the command and its arguments */</span>
	<span class="n">data1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">argn</span><span class="p">);</span>
	<span class="n">DBG_BUFFER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Parameters&quot;</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">argn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">argn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">argn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Error while sending command 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">command</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait response from interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span>
				<span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">usecs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
				<span class="s">&quot;(%s) Device took too much time to answer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Then get the response */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">respn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">respn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
			<span class="s">&quot;Error while reading response for command 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">command</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG_BUFFER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Response&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">respn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_command_failed</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_read_property - reads a si4713 property</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> * @prop: property identification number</span>
<span class="cm"> * @pv: property value to be returned on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_read_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">prop</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">[</span><span class="n">SI4713_GET_PROP_NRESP</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * 	.First byte = 0</span>
<span class="cm">	 * 	.Second byte = property&#39;s MSB</span>
<span class="cm">	 * 	.Third byte = property&#39;s LSB</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">args</span><span class="p">[</span><span class="n">SI4713_GET_PROP_NARGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="n">msb</span><span class="p">(</span><span class="n">prop</span><span class="p">),</span>
		<span class="n">lsb</span><span class="p">(</span><span class="n">prop</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_send_command</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_CMD_GET_PROPERTY</span><span class="p">,</span>
				  <span class="n">args</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span>
				  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pv</span> <span class="o">=</span> <span class="n">compose_u16</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
			<span class="s">&quot;%s: property=0x%02x value=0x%02x status=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="o">*</span><span class="n">pv</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_write_property - modifies a si4713 property</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> * @prop: property identification number</span>
<span class="cm"> * @val: new value for that property</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_write_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">prop</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">resp</span><span class="p">[</span><span class="n">SI4713_SET_PROP_NRESP</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * 	.First byte = 0</span>
<span class="cm">	 * 	.Second byte = property&#39;s MSB</span>
<span class="cm">	 * 	.Third byte = property&#39;s LSB</span>
<span class="cm">	 * 	.Fourth byte = value&#39;s MSB</span>
<span class="cm">	 * 	.Fifth byte = value&#39;s LSB</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">args</span><span class="p">[</span><span class="n">SI4713_SET_PROP_NARGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="n">msb</span><span class="p">(</span><span class="n">prop</span><span class="p">),</span>
		<span class="n">lsb</span><span class="p">(</span><span class="n">prop</span><span class="p">),</span>
		<span class="n">msb</span><span class="p">(</span><span class="n">val</span><span class="p">),</span>
		<span class="n">lsb</span><span class="p">(</span><span class="n">val</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_send_command</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_CMD_SET_PROPERTY</span><span class="p">,</span>
					<span class="n">args</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">args</span><span class="p">),</span>
					<span class="n">resp</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span>
					<span class="n">DEFAULT_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
			<span class="s">&quot;%s: property=0x%02x value=0x%02x status=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * As there is no command response for SET_PROPERTY,</span>
<span class="cm">	 * wait Tcomp time to finish before proceed, in order</span>
<span class="cm">	 * to have property properly set.</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">TIMEOUT_SET_PROPERTY</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_powerup - Powers the device up</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_powerup</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">resp</span><span class="p">[</span><span class="n">SI4713_PWUP_NRESP</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * 	.First byte = Enabled interrupts and boot function</span>
<span class="cm">	 * 	.Second byte = Input operation mode</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">args</span><span class="p">[</span><span class="n">SI4713_PWUP_NARGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">SI4713_PWUP_CTSIEN</span> <span class="o">|</span> <span class="n">SI4713_PWUP_GPO2OEN</span> <span class="o">|</span> <span class="n">SI4713_PWUP_FUNC_TX</span><span class="p">,</span>
		<span class="n">SI4713_PWUP_OPMOD_ANALOG</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">regulator_bulk_enable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span>
				    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Failed to enable supplies: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_send_command</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_CMD_POWER_UP</span><span class="p">,</span>
					<span class="n">args</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">args</span><span class="p">),</span>
					<span class="n">resp</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span>
					<span class="n">TIMEOUT_POWER_UP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Powerup response: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Device in power up mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">POWER_ON</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_write_property</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_GPO_IEN</span><span class="p">,</span>
						<span class="n">SI4713_STC_INT</span> <span class="o">|</span> <span class="n">SI4713_CTS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">))</span>
			<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">regulator_bulk_disable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span>
					     <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
				 <span class="s">&quot;Failed to disable supplies: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_powerdown - Powers the device down</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_powerdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">resp</span><span class="p">[</span><span class="n">SI4713_PWDN_NRESP</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_send_command</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_CMD_POWER_DOWN</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">resp</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span>
					<span class="n">DEFAULT_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Power down response: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Device in reset mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">))</span>
			<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">regulator_bulk_disable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span>
					     <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
				 <span class="s">&quot;Failed to disable supplies: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">POWER_OFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_checkrev - Checks if we are treating a device with the correct rev.</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_checkrev</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">resp</span><span class="p">[</span><span class="n">SI4713_GETREV_NRESP</span><span class="p">];</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_send_command</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_CMD_GET_REV</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">resp</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span>
					<span class="n">DEFAULT_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">SI4713_PRODUCT_NUMBER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;chip found @ 0x%02x (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Invalid product number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_wait_stc - Waits STC interrupt and clears status bits. Useful</span>
<span class="cm"> *		     for TX_TUNE_POWER, TX_TUNE_FREQ and TX_TUNE_MEAS</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> * @usecs: timeout to wait for STC interrupt signal</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_wait_stc</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">usecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">resp</span><span class="p">[</span><span class="n">SI4713_GET_STATUS_NRESP</span><span class="p">];</span>

	<span class="cm">/* Wait response from STC interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span>
			<span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">usecs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
			<span class="s">&quot;%s: device took too much time to answer (%d usec).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">usecs</span><span class="p">);</span>

	<span class="cm">/* Clear status bits */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_send_command</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_CMD_GET_INT_STATUS</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">resp</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span>
					<span class="n">DEFAULT_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
			<span class="s">&quot;%s: status bits: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SI4713_STC_INT</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_tx_tune_freq - Sets the state of the RF carrier and sets the tuning</span>
<span class="cm"> * 			frequency between 76 and 108 MHz in 10 kHz units and</span>
<span class="cm"> * 			steps of 50 kHz.</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> * @frequency: desired frequency (76 - 108 MHz, unit 10 KHz, step 50 kHz)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_tx_tune_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">frequency</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">[</span><span class="n">SI4713_TXFREQ_NRESP</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * 	.First byte = 0</span>
<span class="cm">	 * 	.Second byte = frequency&#39;s MSB</span>
<span class="cm">	 * 	.Third byte = frequency&#39;s LSB</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">args</span><span class="p">[</span><span class="n">SI4713_TXFREQ_NARGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="n">msb</span><span class="p">(</span><span class="n">frequency</span><span class="p">),</span>
		<span class="n">lsb</span><span class="p">(</span><span class="n">frequency</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_send_command</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_CMD_TX_TUNE_FREQ</span><span class="p">,</span>
				  <span class="n">args</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span>
				  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
			<span class="s">&quot;%s: frequency=0x%02x status=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">frequency</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_wait_stc</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">TIMEOUT_TX_TUNE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">compose_u16</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_tx_tune_power - Sets the RF voltage level between 88 and 115 dBuV in</span>
<span class="cm"> * 			1 dB units. A value of 0x00 indicates off. The command</span>
<span class="cm"> * 			also sets the antenna tuning capacitance. A value of 0</span>
<span class="cm"> * 			indicates autotuning, and a value of 1 - 191 indicates</span>
<span class="cm"> * 			a manual override, which results in a tuning</span>
<span class="cm"> * 			capacitance of 0.25 pF x @antcap.</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> * @power: tuning power (88 - 115 dBuV, unit/step 1 dB)</span>
<span class="cm"> * @antcap: value of antenna tuning capacitor (0 - 191)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_tx_tune_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">power</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">antcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">[</span><span class="n">SI4713_TXPWR_NRESP</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * 	.First byte = 0</span>
<span class="cm">	 * 	.Second byte = 0</span>
<span class="cm">	 * 	.Third byte = power</span>
<span class="cm">	 * 	.Fourth byte = antcap</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">args</span><span class="p">[</span><span class="n">SI4713_TXPWR_NARGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="n">power</span><span class="p">,</span>
		<span class="n">antcap</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">power</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">power</span> <span class="o">&lt;</span> <span class="n">SI4713_MIN_POWER</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">power</span> <span class="o">&gt;</span> <span class="n">SI4713_MAX_POWER</span> <span class="o">||</span> <span class="n">antcap</span> <span class="o">&gt;</span> <span class="n">SI4713_MAX_ANTCAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDOM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_send_command</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_CMD_TX_TUNE_POWER</span><span class="p">,</span>
				  <span class="n">args</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span>
				  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
			<span class="s">&quot;%s: power=0x%02x antcap=0x%02x status=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">antcap</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">si4713_wait_stc</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">TIMEOUT_TX_TUNE_POWER</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_tx_tune_measure - Enters receive mode and measures the received noise</span>
<span class="cm"> * 			level in units of dBuV on the selected frequency.</span>
<span class="cm"> * 			The Frequency must be between 76 and 108 MHz in 10 kHz</span>
<span class="cm"> * 			units and steps of 50 kHz. The command also sets the</span>
<span class="cm"> * 			antenna	tuning capacitance. A value of 0 means</span>
<span class="cm"> * 			autotuning, and a value of 1 to 191 indicates manual</span>
<span class="cm"> * 			override.</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> * @frequency: desired frequency (76 - 108 MHz, unit 10 KHz, step 50 kHz)</span>
<span class="cm"> * @antcap: value of antenna tuning capacitor (0 - 191)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_tx_tune_measure</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">frequency</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">antcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">[</span><span class="n">SI4713_TXMEA_NRESP</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * 	.First byte = 0</span>
<span class="cm">	 * 	.Second byte = frequency&#39;s MSB</span>
<span class="cm">	 * 	.Third byte = frequency&#39;s LSB</span>
<span class="cm">	 * 	.Fourth byte = antcap</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">args</span><span class="p">[</span><span class="n">SI4713_TXMEA_NARGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="n">msb</span><span class="p">(</span><span class="n">frequency</span><span class="p">),</span>
		<span class="n">lsb</span><span class="p">(</span><span class="n">frequency</span><span class="p">),</span>
		<span class="n">antcap</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tune_rnl</span> <span class="o">=</span> <span class="n">DEFAULT_TUNE_RNL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">antcap</span> <span class="o">&gt;</span> <span class="n">SI4713_MAX_ANTCAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDOM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_send_command</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_CMD_TX_TUNE_MEASURE</span><span class="p">,</span>
				  <span class="n">args</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span>
				  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
			<span class="s">&quot;%s: frequency=0x%02x antcap=0x%02x status=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">antcap</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">si4713_wait_stc</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">TIMEOUT_TX_TUNE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_tx_tune_status- Returns the status of the tx_tune_freq, tx_tune_mea or</span>
<span class="cm"> * 			tx_tune_power commands. This command return the current</span>
<span class="cm"> * 			frequency, output voltage in dBuV, the antenna tunning</span>
<span class="cm"> * 			capacitance value and the received noise level. The</span>
<span class="cm"> * 			command also clears the stcint interrupt bit when the</span>
<span class="cm"> * 			first bit of its arguments is high.</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> * @intack: 0x01 to clear the seek/tune complete interrupt status indicator.</span>
<span class="cm"> * @frequency: returned frequency</span>
<span class="cm"> * @power: returned power</span>
<span class="cm"> * @antcap: returned antenna capacitance</span>
<span class="cm"> * @noise: returned noise level</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_tx_tune_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">intack</span><span class="p">,</span>
					<span class="n">u16</span> <span class="o">*</span><span class="n">frequency</span><span class="p">,</span>	<span class="n">u8</span> <span class="o">*</span><span class="n">power</span><span class="p">,</span>
					<span class="n">u8</span> <span class="o">*</span><span class="n">antcap</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">noise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">[</span><span class="n">SI4713_TXSTATUS_NRESP</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * 	.First byte = intack bit</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">args</span><span class="p">[</span><span class="n">SI4713_TXSTATUS_NARGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">intack</span> <span class="o">&amp;</span> <span class="n">SI4713_INTACK_MASK</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_send_command</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_CMD_TX_TUNE_STATUS</span><span class="p">,</span>
				  <span class="n">args</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span>
				  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
			<span class="s">&quot;%s: status=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="o">*</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">compose_u16</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="o">*</span><span class="n">frequency</span><span class="p">;</span>
		<span class="o">*</span><span class="n">power</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="o">*</span><span class="n">antcap</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="o">*</span><span class="n">noise</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;%s: response: %d x 10 kHz &quot;</span>
				<span class="s">&quot;(power %d, antcap %d, rnl %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="o">*</span><span class="n">frequency</span><span class="p">,</span> <span class="o">*</span><span class="n">power</span><span class="p">,</span> <span class="o">*</span><span class="n">antcap</span><span class="p">,</span> <span class="o">*</span><span class="n">noise</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_tx_rds_buff - Loads the RDS group buffer FIFO or circular buffer.</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> * @mode: the buffer operation mode.</span>
<span class="cm"> * @rdsb: RDS Block B</span>
<span class="cm"> * @rdsc: RDS Block C</span>
<span class="cm"> * @rdsd: RDS Block D</span>
<span class="cm"> * @cbleft: returns the number of available circular buffer blocks minus the</span>
<span class="cm"> *          number of used circular buffer blocks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_tx_rds_buff</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rdsb</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">rdsc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rdsd</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">cbleft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">[</span><span class="n">SI4713_RDSBUFF_NRESP</span><span class="p">];</span>

	<span class="k">const</span> <span class="n">u8</span> <span class="n">args</span><span class="p">[</span><span class="n">SI4713_RDSBUFF_NARGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SI4713_RDSBUFF_MODE_MASK</span><span class="p">,</span>
		<span class="n">msb</span><span class="p">(</span><span class="n">rdsb</span><span class="p">),</span>
		<span class="n">lsb</span><span class="p">(</span><span class="n">rdsb</span><span class="p">),</span>
		<span class="n">msb</span><span class="p">(</span><span class="n">rdsc</span><span class="p">),</span>
		<span class="n">lsb</span><span class="p">(</span><span class="n">rdsc</span><span class="p">),</span>
		<span class="n">msb</span><span class="p">(</span><span class="n">rdsd</span><span class="p">),</span>
		<span class="n">lsb</span><span class="p">(</span><span class="n">rdsd</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_send_command</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_CMD_TX_RDS_BUFF</span><span class="p">,</span>
				  <span class="n">args</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span>
				  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span>
			<span class="s">&quot;%s: status=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="o">*</span><span class="n">cbleft</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span><span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;%s: response: interrupts&quot;</span>
				<span class="s">&quot; 0x%02x cb avail: %d cb used %d fifo avail&quot;</span>
				<span class="s">&quot; %d fifo used %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				<span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_tx_rds_ps - Loads the program service buffer.</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> * @psid: program service id to be loaded.</span>
<span class="cm"> * @pschar: assumed 4 size char array to be loaded into the program service</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_tx_rds_ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">psid</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pschar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">[</span><span class="n">SI4713_RDSPS_NRESP</span><span class="p">];</span>

	<span class="k">const</span> <span class="n">u8</span> <span class="n">args</span><span class="p">[</span><span class="n">SI4713_RDSPS_NARGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">psid</span> <span class="o">&amp;</span> <span class="n">SI4713_RDSPS_PSID_MASK</span><span class="p">,</span>
		<span class="n">pschar</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">pschar</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		<span class="n">pschar</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		<span class="n">pschar</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	<span class="p">};</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_send_command</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_CMD_TX_RDS_PS</span><span class="p">,</span>
				  <span class="n">args</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span>
				  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;%s: status=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_set_power_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_powerup</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_powerdown</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_set_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mute</span> <span class="o">=</span> <span class="n">set_mute</span><span class="p">(</span><span class="n">mute</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_write_property</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
				<span class="n">SI4713_TX_LINE_INPUT_MUTE</span><span class="p">,</span> <span class="n">mute</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mute</span> <span class="o">=</span> <span class="n">get_mute</span><span class="p">(</span><span class="n">mute</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_set_rds_ps_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ps_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We want to clear the whole thing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">ps_name</span><span class="p">))</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ps_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_RDS_PS_NAME</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Write the new ps name and clear the padding */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RDS_PS_NAME</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="p">(</span><span class="n">RDS_BLOCK</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_tx_rds_ps</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="n">RDS_BLOCK</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
						<span class="n">ps_name</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Setup the size to be sent */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">ps_name</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ps_name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_write_property</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
				<span class="n">SI4713_TX_RDS_PS_MESSAGE_COUNT</span><span class="p">,</span>
				<span class="n">rds_ps_nblocks</span><span class="p">(</span><span class="n">len</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_write_property</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
				<span class="n">SI4713_TX_RDS_PS_REPEAT_COUNT</span><span class="p">,</span>
				<span class="n">DEFAULT_RDS_PS_REPEAT_COUNT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">ps_name</span><span class="p">,</span> <span class="n">ps_name</span><span class="p">,</span> <span class="n">MAX_RDS_PS_NAME</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_set_rds_radio_text</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">t_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cr_inserted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">left</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">copy</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_tx_rds_buff</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">RDS_BLOCK_CLEAR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">copy</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* RDS spec says that if the last block isn&#39;t used,</span>
<span class="cm">		 * then apply a carriage return</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t_index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">RDS_RADIOTEXT_INDEX_MAX</span> <span class="o">*</span>
			<span class="n">RDS_RADIOTEXT_BLK_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RDS_RADIOTEXT_BLK_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">[</span><span class="n">t_index</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">||</span> <span class="n">rt</span><span class="p">[</span><span class="n">t_index</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">==</span>
					<span class="n">RDS_CARRIAGE_RETURN</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rt</span><span class="p">[</span><span class="n">t_index</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">RDS_CARRIAGE_RETURN</span><span class="p">;</span>
					<span class="n">cr_inserted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_tx_rds_buff</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">RDS_BLOCK_LOAD</span><span class="p">,</span>
				<span class="n">compose_u16</span><span class="p">(</span><span class="n">RDS_RADIOTEXT_2A</span><span class="p">,</span> <span class="n">b_index</span><span class="o">++</span><span class="p">),</span>
				<span class="n">compose_u16</span><span class="p">(</span><span class="n">rt</span><span class="p">[</span><span class="n">t_index</span><span class="p">],</span> <span class="n">rt</span><span class="p">[</span><span class="n">t_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span>
				<span class="n">compose_u16</span><span class="p">(</span><span class="n">rt</span><span class="p">[</span><span class="n">t_index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="n">rt</span><span class="p">[</span><span class="n">t_index</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]),</span>
				<span class="o">&amp;</span><span class="n">left</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">t_index</span> <span class="o">+=</span> <span class="n">RDS_RADIOTEXT_BLK_SIZE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cr_inserted</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">copy:</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">radio_text</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">MAX_RDS_RADIO_TEXT</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_choose_econtrol_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">,</span>
		<span class="n">u32</span> <span class="o">**</span><span class="n">shadow</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">bit</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">mul</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">**</span><span class="n">table</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* FM_TX class controls */</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PI</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_RDS_PI</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mul</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">pi</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_THRESHOLD</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_ACOMP_THRESHOLD</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mul</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">threshold</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_GAIN</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_ACOMP_GAIN</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mul</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">gain</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PILOT_TONE_FREQUENCY</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_PILOT_FREQUENCY</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mul</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">pilot_info</span><span class="p">.</span><span class="n">frequency</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_ATTACK_TIME</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_ACOMP_ATTACK_TIME</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mul</span> <span class="o">=</span> <span class="n">ATTACK_TIME_UNIT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">attack_time</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PILOT_TONE_DEVIATION</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_PILOT_DEVIATION</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mul</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">pilot_info</span><span class="p">.</span><span class="n">deviation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LIMITER_DEVIATION</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_AUDIO_DEVIATION</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mul</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">limiter_info</span><span class="p">.</span><span class="n">deviation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_DEVIATION</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_RDS_DEVIATION</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mul</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">deviation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PTY</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_RDS_PS_MISC</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0x1F</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">pty</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LIMITER_ENABLED</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_ACOMP_ENABLE</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">limiter_info</span><span class="p">.</span><span class="n">enabled</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_ENABLED</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_ACOMP_ENABLE</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">enabled</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PILOT_TONE_ENABLED</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_COMPONENT_ENABLE</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">pilot_info</span><span class="p">.</span><span class="n">enabled</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LIMITER_RELEASE_TIME</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_LIMITER_RELEASE_TIME</span><span class="p">;</span>
		<span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="n">limiter_times</span><span class="p">;</span>
		<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">limiter_times</span><span class="p">);</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">limiter_info</span><span class="p">.</span><span class="n">release_time</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_RELEASE_TIME</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_ACOMP_RELEASE_TIME</span><span class="p">;</span>
		<span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="n">acomp_rtimes</span><span class="p">;</span>
		<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">acomp_rtimes</span><span class="p">);</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">release_time</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_PREEMPHASIS</span>:
		<span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="n">SI4713_TX_PREEMPHASIS</span><span class="p">;</span>
		<span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="n">preemphasis_values</span><span class="p">;</span>
		<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">preemphasis_values</span><span class="p">);</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">preemphasis</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">si4713_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">qc</span><span class="p">);</span>

<span class="cm">/* write string property */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_write_econtrol_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="n">vqc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vqc</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_queryctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vqc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PS_NAME</span>: <span class="p">{</span>
		<span class="kt">char</span> <span class="n">ps_name</span><span class="p">[</span><span class="n">MAX_RDS_PS_NAME</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_RDS_PS_NAME</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">ps_name</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ps_name</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">ps_name</span><span class="p">)</span> <span class="o">%</span> <span class="n">vqc</span><span class="p">.</span><span class="n">step</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_set_rds_ps_name</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ps_name</span><span class="p">);</span>
	<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_RADIO_TEXT</span>: <span class="p">{</span>
		<span class="kt">char</span> <span class="n">radio_text</span><span class="p">[</span><span class="n">MAX_RDS_RADIO_TEXT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_RDS_RADIO_TEXT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">radio_text</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">radio_text</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">radio_text</span><span class="p">)</span> <span class="o">%</span> <span class="n">vqc</span><span class="p">.</span><span class="n">step</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_set_rds_radio_text</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">radio_text</span><span class="p">);</span>
	<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="n">vqc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">vqc</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_queryctrl</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vqc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">vqc</span><span class="p">.</span><span class="n">minimum</span> <span class="o">||</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">vqc</span><span class="p">.</span><span class="n">maximum</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* properties which use tx_tune_power*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_write_econtrol_tune</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">power</span><span class="p">,</span> <span class="n">antcap</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">validate_range</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_POWER_LEVEL</span>:
		<span class="n">power</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">antcap</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">antenna_capacitor</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_ANTENNA_CAPACITOR</span>:
		<span class="n">power</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">;</span>
		<span class="n">antcap</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_tx_tune_power</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">antcap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="n">power</span><span class="p">;</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">antenna_capacitor</span> <span class="o">=</span> <span class="n">antcap</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_write_econtrol_integers</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">property</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mul</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">validate_range</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_choose_econtrol_action</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shadow</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bit</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mul</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mul</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">/</span> <span class="n">mul</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">usecs_to_dev</span><span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">rval</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_read_property</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">set_bits</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_write_property</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mul</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">mul</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">dev_to_usecs</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="n">rval</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">si4713_s_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">si4713_s_modulator</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_modulator</span> <span class="o">*</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * si4713_setup - Sets the device up with current configuration.</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_modulator</span> <span class="n">vm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Get a local copy to avoid race */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sdev</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_RDS_TX_PI</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">pi</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_THRESHOLD</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">threshold</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_GAIN</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">gain</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_PILOT_TONE_FREQUENCY</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">pilot_info</span><span class="p">.</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_ATTACK_TIME</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">attack_time</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_PILOT_TONE_DEVIATION</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">pilot_info</span><span class="p">.</span><span class="n">deviation</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_LIMITER_DEVIATION</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">limiter_info</span><span class="p">.</span><span class="n">deviation</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_RDS_TX_DEVIATION</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">deviation</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_RDS_TX_PTY</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">pty</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_LIMITER_ENABLED</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">limiter_info</span><span class="p">.</span><span class="n">enabled</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_ENABLED</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">enabled</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_PILOT_TONE_ENABLED</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">pilot_info</span><span class="p">.</span><span class="n">enabled</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_LIMITER_RELEASE_TIME</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">limiter_info</span><span class="p">.</span><span class="n">release_time</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_RELEASE_TIME</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">release_time</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_TUNE_PREEMPHASIS</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">preemphasis</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_RDS_TX_PS_NAME</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_set_rds_ps_name</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">ps_name</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_RDS_TX_RADIO_TEXT</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_set_rds_radio_text</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">radio_text</span><span class="p">);</span>

	<span class="cm">/* Device procedure needs to set frequency first */</span>
	<span class="n">f</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">?</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">:</span> <span class="n">DEFAULT_FREQUENCY</span><span class="p">;</span>
	<span class="n">f</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">si4713_to_v4l2</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">frequency</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_s_frequency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_TUNE_POWER_LEVEL</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_tune</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_TUNE_ANTENNA_CAPACITOR</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">antenna_capacitor</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">|=</span> <span class="n">si4713_write_econtrol_tune</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">vm</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">stereo</span><span class="p">)</span>
		<span class="n">vm</span><span class="p">.</span><span class="n">txsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vm</span><span class="p">.</span><span class="n">txsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">vm</span><span class="p">.</span><span class="n">txsubchans</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_SUB_RDS</span><span class="p">;</span>
	<span class="n">si4713_s_modulator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vm</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_initialize - Sets the device up with default configuration.</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_set_power_state</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">POWER_ON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_checkrev</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_set_power_state</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">POWER_OFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">pi</span> <span class="o">=</span> <span class="n">DEFAULT_RDS_PI</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">pty</span> <span class="o">=</span> <span class="n">DEFAULT_RDS_PTY</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">deviation</span> <span class="o">=</span> <span class="n">DEFAULT_RDS_DEVIATION</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">ps_name</span><span class="p">,</span> <span class="n">DEFAULT_RDS_PS_NAME</span><span class="p">,</span> <span class="n">MAX_RDS_PS_NAME</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">radio_text</span><span class="p">,</span> <span class="n">DEFAULT_RDS_RADIO_TEXT</span><span class="p">,</span>
							<span class="n">MAX_RDS_RADIO_TEXT</span><span class="p">);</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">limiter_info</span><span class="p">.</span><span class="n">release_time</span> <span class="o">=</span> <span class="n">DEFAULT_LIMITER_RTIME</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">limiter_info</span><span class="p">.</span><span class="n">deviation</span> <span class="o">=</span> <span class="n">DEFAULT_LIMITER_DEV</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">limiter_info</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">pilot_info</span><span class="p">.</span><span class="n">deviation</span> <span class="o">=</span> <span class="n">DEFAULT_PILOT_DEVIATION</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">pilot_info</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">DEFAULT_PILOT_FREQUENCY</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">pilot_info</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">release_time</span> <span class="o">=</span> <span class="n">DEFAULT_ACOMP_RTIME</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">attack_time</span> <span class="o">=</span> <span class="n">DEFAULT_ACOMP_ATIME</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">DEFAULT_ACOMP_THRESHOLD</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">gain</span> <span class="o">=</span> <span class="n">DEFAULT_ACOMP_GAIN</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">acomp_info</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">DEFAULT_FREQUENCY</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">preemphasis</span> <span class="o">=</span> <span class="n">DEFAULT_PREEMPHASIS</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mute</span> <span class="o">=</span> <span class="n">DEFAULT_MUTE</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="n">DEFAULT_POWER_LEVEL</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">antenna_capacitor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">stereo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tune_rnl</span> <span class="o">=</span> <span class="n">DEFAULT_TUNE_RNL</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* read string property */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_read_econtrol_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PS_NAME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">ps_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">control</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">MAX_RDS_PS_NAME</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">ps_name</span><span class="p">,</span>
					<span class="n">strlen</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">ps_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_RADIO_TEXT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">radio_text</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">control</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">MAX_RDS_RADIO_TEXT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">radio_text</span><span class="p">,</span>
					<span class="n">strlen</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">radio_text</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * si4713_update_tune_status - update properties from tx_tune_status</span>
<span class="cm"> * command. Must be called with sdev-&gt;mutex held.</span>
<span class="cm"> * @sdev: si4713_device structure for the device we are communicating</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_update_tune_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_tx_tune_status</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">antenna_capacitor</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tune_rnl</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* properties which use tx_tune_status */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_read_econtrol_tune</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_update_tune_status</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_POWER_LEVEL</span>:
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_ANTENNA_CAPACITOR</span>:
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">antenna_capacitor</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">};</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_read_econtrol_integers</span><span class="p">(</span><span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">property</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mul</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_choose_econtrol_action</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shadow</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bit</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mul</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_read_property</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="cm">/* Keep negative values for threshold */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_THRESHOLD</span><span class="p">)</span>
			<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span>
			<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="n">get_status_bit</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mul</span><span class="p">)</span>
			<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">mul</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">shadow</span> <span class="o">=</span> <span class="n">dev_to_usecs</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="n">shadow</span><span class="p">;</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Video4Linux Subdev Interface</span>
<span class="cm"> */</span>
<span class="cm">/* si4713_s_ext_ctrls - set extended controls value */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_s_ext_ctrls</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">ctrls</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_si4713_device</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">ctrl_class</span> <span class="o">!=</span> <span class="n">V4L2_CTRL_CLASS_FM_TX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PS_NAME</span>:
		<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_RADIO_TEXT</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_write_econtrol_string</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
							<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_CID_TUNE_ANTENNA_CAPACITOR</span>:
		<span class="k">case</span> <span class="n">V4L2_CID_TUNE_POWER_LEVEL</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_write_econtrol_tune</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
							<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_write_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
							<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* si4713_g_ext_ctrls - get extended controls value */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_g_ext_ctrls</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">ctrls</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_si4713_device</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">ctrl_class</span> <span class="o">!=</span> <span class="n">V4L2_CTRL_CLASS_FM_TX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PS_NAME</span>:
		<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_RADIO_TEXT</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_read_econtrol_string</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
							<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_CID_TUNE_ANTENNA_CAPACITOR</span>:
		<span class="k">case</span> <span class="n">V4L2_CID_TUNE_POWER_LEVEL</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_read_econtrol_tune</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
							<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">si4713_read_econtrol_integers</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
							<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* si4713_queryctrl - enumerate control items */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* User class controls */</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEFAULT_MUTE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* FM_TX class controls */</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PI</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEFAULT_RDS_PI</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PTY</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEFAULT_RDS_PTY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_DEVIATION</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_RDS_DEVIATION</span><span class="p">,</span>
						<span class="mi">10</span><span class="p">,</span> <span class="n">DEFAULT_RDS_DEVIATION</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PS_NAME</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Report step as 8. From RDS spec, psname</span>
<span class="cm">		 * should be 8. But there are receivers which scroll strings</span>
<span class="cm">		 * sized as 8xN.</span>
<span class="cm">		 */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_RDS_PS_NAME</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_RADIO_TEXT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Report step as 32 (2A block). From RDS spec,</span>
<span class="cm">		 * radio text should be 32 for 2A block. But there are receivers</span>
<span class="cm">		 * which scroll strings sized as 32xN. Setting default to 32.</span>
<span class="cm">		 */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_RDS_RADIO_TEXT</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LIMITER_ENABLED</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LIMITER_RELEASE_TIME</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="n">MAX_LIMITER_RELEASE_TIME</span><span class="p">,</span>
						<span class="mi">50</span><span class="p">,</span> <span class="n">DEFAULT_LIMITER_RTIME</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LIMITER_DEVIATION</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_LIMITER_DEVIATION</span><span class="p">,</span>
						<span class="mi">10</span><span class="p">,</span> <span class="n">DEFAULT_LIMITER_DEV</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_ENABLED</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_GAIN</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_ACOMP_GAIN</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						<span class="n">DEFAULT_ACOMP_GAIN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_THRESHOLD</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">MIN_ACOMP_THRESHOLD</span><span class="p">,</span>
						<span class="n">MAX_ACOMP_THRESHOLD</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						<span class="n">DEFAULT_ACOMP_THRESHOLD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_ATTACK_TIME</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_ACOMP_ATTACK_TIME</span><span class="p">,</span>
						<span class="mi">500</span><span class="p">,</span> <span class="n">DEFAULT_ACOMP_ATIME</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_RELEASE_TIME</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">MAX_ACOMP_RELEASE_TIME</span><span class="p">,</span>
						<span class="mi">100000</span><span class="p">,</span> <span class="n">DEFAULT_ACOMP_RTIME</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_PILOT_TONE_ENABLED</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PILOT_TONE_DEVIATION</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_PILOT_DEVIATION</span><span class="p">,</span>
						<span class="mi">10</span><span class="p">,</span> <span class="n">DEFAULT_PILOT_DEVIATION</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PILOT_TONE_FREQUENCY</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_PILOT_FREQUENCY</span><span class="p">,</span>
						<span class="mi">1</span><span class="p">,</span> <span class="n">DEFAULT_PILOT_FREQUENCY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_PREEMPHASIS</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">V4L2_PREEMPHASIS_DISABLED</span><span class="p">,</span>
						<span class="n">V4L2_PREEMPHASIS_75_uS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						<span class="n">V4L2_PREEMPHASIS_50_uS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_POWER_LEVEL</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEFAULT_POWER_LEVEL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_ANTENNA_CAPACITOR</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* si4713_g_ctrl - get the value of a control */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_si4713_device</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_read_property</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_TX_LINE_INPUT_MUTE</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mute</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">get_mute</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mute</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* si4713_s_ctrl - set the value of a control */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_si4713_device</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_set_mute</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_set_power_state</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">POWER_DOWN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_set_power_state</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">POWER_UP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_setup</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_set_mute</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* si4713_ioctl - deal with private ioctls (only rnl for now) */</span>
<span class="kt">long</span> <span class="nf">si4713_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_si4713_device</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">si4713_rnl</span> <span class="o">*</span><span class="n">rnl</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SI4713_IOC_MEASURE_RNL</span>:
		<span class="n">frequency</span> <span class="o">=</span> <span class="n">v4l2_to_si4713</span><span class="p">(</span><span class="n">rnl</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Set desired measurement frequency */</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_tx_tune_measure</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
			<span class="cm">/* get results from tune status */</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_update_tune_status</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rnl</span><span class="o">-&gt;</span><span class="n">rnl</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tune_rnl</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* nothing */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">si4713_subdev_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">queryctrl</span>	<span class="o">=</span> <span class="n">si4713_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_ext_ctrls</span>	<span class="o">=</span> <span class="n">si4713_g_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ext_ctrls</span>	<span class="o">=</span> <span class="n">si4713_s_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_ctrl</span>		<span class="o">=</span> <span class="n">si4713_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ctrl</span>		<span class="o">=</span> <span class="n">si4713_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">si4713_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* si4713_g_modulator - get modulator attributes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_g_modulator</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_modulator</span> <span class="o">*</span><span class="n">vm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_si4713_device</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;FM Modulator&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">vm</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_TUNER_CAP_STEREO</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_LOW</span> <span class="o">|</span>
		<span class="n">V4L2_TUNER_CAP_RDS</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_RDS_CONTROLS</span><span class="p">;</span>

	<span class="cm">/* Report current frequency range limits */</span>
	<span class="n">vm</span><span class="o">-&gt;</span><span class="n">rangelow</span> <span class="o">=</span> <span class="n">si4713_to_v4l2</span><span class="p">(</span><span class="n">FREQ_RANGE_LOW</span><span class="p">);</span>
	<span class="n">vm</span><span class="o">-&gt;</span><span class="n">rangehigh</span> <span class="o">=</span> <span class="n">si4713_to_v4l2</span><span class="p">(</span><span class="n">FREQ_RANGE_HIGH</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">comp_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_read_property</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SI4713_TX_COMPONENT_ENABLE</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">comp_en</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">get_status_bit</span><span class="p">(</span><span class="n">comp_en</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">get_status_bit</span><span class="p">(</span><span class="n">comp_en</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Report current audio mode: mono or stereo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">stereo</span><span class="p">)</span>
		<span class="n">vm</span><span class="o">-&gt;</span><span class="n">txsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vm</span><span class="o">-&gt;</span><span class="n">txsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>

	<span class="cm">/* Report rds feature status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">vm</span><span class="o">-&gt;</span><span class="n">txsubchans</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_SUB_RDS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vm</span><span class="o">-&gt;</span><span class="n">txsubchans</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_TUNER_SUB_RDS</span><span class="p">;</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* si4713_s_modulator - set modulator attributes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_s_modulator</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_modulator</span> <span class="o">*</span><span class="n">vm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_si4713_device</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">stereo</span><span class="p">,</span> <span class="n">rds</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Set audio mode: mono or stereo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">txsubchans</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">)</span>
		<span class="n">stereo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">txsubchans</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">)</span>
		<span class="n">stereo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rds</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">txsubchans</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_RDS</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_read_property</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
						<span class="n">SI4713_TX_COMPONENT_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">set_bits</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">stereo</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">set_bits</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">rds</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_write_property</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
						<span class="n">SI4713_TX_COMPONENT_ENABLE</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">stereo</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">rds_info</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">rds</span><span class="p">;</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* si4713_g_frequency - get tuner or modulator radio frequency */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_g_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_si4713_device</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">p</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_tx_tune_status</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">si4713_to_v4l2</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* si4713_s_frequency - set tuner or modulator radio frequency */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_s_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_si4713_device</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">frequency</span> <span class="o">=</span> <span class="n">v4l2_to_si4713</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>

	<span class="cm">/* Check frequency range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="n">FREQ_RANGE_LOW</span> <span class="o">||</span> <span class="n">frequency</span> <span class="o">&gt;</span> <span class="n">FREQ_RANGE_HIGH</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDOM</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_tx_tune_freq</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">frequency</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="n">frequency</span> <span class="o">=</span> <span class="n">rval</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">si4713_to_v4l2</span><span class="p">(</span><span class="n">frequency</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_tuner_ops</span> <span class="n">si4713_subdev_tuner_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_frequency</span>	<span class="o">=</span> <span class="n">si4713_g_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_frequency</span>	<span class="o">=</span> <span class="n">si4713_s_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_modulator</span>	<span class="o">=</span> <span class="n">si4713_g_modulator</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_modulator</span>	<span class="o">=</span> <span class="n">si4713_s_modulator</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">si4713_subdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">si4713_subdev_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">si4713_subdev_tuner_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * I2C driver interface</span>
<span class="cm"> */</span>
<span class="cm">/* si4713_probe - probe for the device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">si4713_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to alloc video device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">gpio_reset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">,</span> <span class="s">&quot;si4713 reset&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to request gpio: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_sdev</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">gpio_reset</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">;</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span> <span class="o">=</span> <span class="n">si4713_supply_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">regulator_bulk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span>
				  <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot get regulators: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_gpio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si4713_subdev_ops</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			<span class="n">si4713_handler</span><span class="p">,</span> <span class="n">IRQF_TRIGGER_FALLING</span> <span class="o">|</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span>
			<span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Could not request IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">put_reg</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;IRQ requested.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;IRQ not configured. Using timeouts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">si4713_initialize</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Failed to probe device information.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_irq:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>
<span class="nl">put_reg:</span>
	<span class="n">regulator_bulk_free</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
<span class="nl">free_gpio:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">))</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">);</span>
<span class="nl">free_sdev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* si4713_remove - remove the device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si4713_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">si4713_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_si4713_device</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span>
		<span class="n">si4713_set_power_state</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">POWER_DOWN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">regulator_bulk_free</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">))</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* si4713_i2c_driver - i2c driver interface */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">si4713_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;si4713&quot;</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">si4713_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">si4713_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;si4713&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">si4713_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">si4713_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>       <span class="o">=</span> <span class="n">si4713_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">si4713_i2c_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
