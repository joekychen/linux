<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › radio › si470x › radio-si470x.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>radio-si470x.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/media/radio/si470x/radio-si470x.h</span>
<span class="cm"> *</span>
<span class="cm"> *  Driver for radios with Silicon Labs Si470x FM Radio Receivers</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2009 Tobias Lorenz &lt;tobias.lorenz@gmx.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>


<span class="cm">/* driver definitions */</span>
<span class="cp">#define DRIVER_NAME &quot;radio-si470x&quot;</span>


<span class="cm">/* kernel includes */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-event.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>



<span class="cm">/**************************************************************************</span>
<span class="cm"> * Register Definitions</span>
<span class="cm"> **************************************************************************/</span>
<span class="cp">#define RADIO_REGISTER_SIZE	2	</span><span class="cm">/* 16 register bit width */</span><span class="cp"></span>
<span class="cp">#define RADIO_REGISTER_NUM	16	</span><span class="cm">/* DEVICEID   ... RDSD */</span><span class="cp"></span>
<span class="cp">#define RDS_REGISTER_NUM	6	</span><span class="cm">/* STATUSRSSI ... RDSD */</span><span class="cp"></span>

<span class="cp">#define DEVICEID		0	</span><span class="cm">/* Device ID */</span><span class="cp"></span>
<span class="cp">#define DEVICEID_PN		0xf000	</span><span class="cm">/* bits 15..12: Part Number */</span><span class="cp"></span>
<span class="cp">#define DEVICEID_MFGID		0x0fff	</span><span class="cm">/* bits 11..00: Manufacturer ID */</span><span class="cp"></span>

<span class="cp">#define CHIPID			1	</span><span class="cm">/* Chip ID */</span><span class="cp"></span>
<span class="cp">#define CHIPID_REV		0xfc00	</span><span class="cm">/* bits 15..10: Chip Version */</span><span class="cp"></span>
<span class="cp">#define CHIPID_DEV		0x0200	</span><span class="cm">/* bits 09..09: Device */</span><span class="cp"></span>
<span class="cp">#define CHIPID_FIRMWARE		0x01ff	</span><span class="cm">/* bits 08..00: Firmware Version */</span><span class="cp"></span>

<span class="cp">#define POWERCFG		2	</span><span class="cm">/* Power Configuration */</span><span class="cp"></span>
<span class="cp">#define POWERCFG_DSMUTE		0x8000	</span><span class="cm">/* bits 15..15: Softmute Disable */</span><span class="cp"></span>
<span class="cp">#define POWERCFG_DMUTE		0x4000	</span><span class="cm">/* bits 14..14: Mute Disable */</span><span class="cp"></span>
<span class="cp">#define POWERCFG_MONO		0x2000	</span><span class="cm">/* bits 13..13: Mono Select */</span><span class="cp"></span>
<span class="cp">#define POWERCFG_RDSM		0x0800	</span><span class="cm">/* bits 11..11: RDS Mode (Si4701 only) */</span><span class="cp"></span>
<span class="cp">#define POWERCFG_SKMODE		0x0400	</span><span class="cm">/* bits 10..10: Seek Mode */</span><span class="cp"></span>
<span class="cp">#define POWERCFG_SEEKUP		0x0200	</span><span class="cm">/* bits 09..09: Seek Direction */</span><span class="cp"></span>
<span class="cp">#define POWERCFG_SEEK		0x0100	</span><span class="cm">/* bits 08..08: Seek */</span><span class="cp"></span>
<span class="cp">#define POWERCFG_DISABLE	0x0040	</span><span class="cm">/* bits 06..06: Powerup Disable */</span><span class="cp"></span>
<span class="cp">#define POWERCFG_ENABLE		0x0001	</span><span class="cm">/* bits 00..00: Powerup Enable */</span><span class="cp"></span>

<span class="cp">#define CHANNEL			3	</span><span class="cm">/* Channel */</span><span class="cp"></span>
<span class="cp">#define CHANNEL_TUNE		0x8000	</span><span class="cm">/* bits 15..15: Tune */</span><span class="cp"></span>
<span class="cp">#define CHANNEL_CHAN		0x03ff	</span><span class="cm">/* bits 09..00: Channel Select */</span><span class="cp"></span>

<span class="cp">#define SYSCONFIG1		4	</span><span class="cm">/* System Configuration 1 */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG1_RDSIEN	0x8000	</span><span class="cm">/* bits 15..15: RDS Interrupt Enable (Si4701 only) */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG1_STCIEN	0x4000	</span><span class="cm">/* bits 14..14: Seek/Tune Complete Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG1_RDS		0x1000	</span><span class="cm">/* bits 12..12: RDS Enable (Si4701 only) */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG1_DE		0x0800	</span><span class="cm">/* bits 11..11: De-emphasis (0=75us 1=50us) */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG1_AGCD		0x0400	</span><span class="cm">/* bits 10..10: AGC Disable */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG1_BLNDADJ	0x00c0	</span><span class="cm">/* bits 07..06: Stereo/Mono Blend Level Adjustment */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG1_GPIO3	0x0030	</span><span class="cm">/* bits 05..04: General Purpose I/O 3 */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG1_GPIO2	0x000c	</span><span class="cm">/* bits 03..02: General Purpose I/O 2 */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG1_GPIO1	0x0003	</span><span class="cm">/* bits 01..00: General Purpose I/O 1 */</span><span class="cp"></span>

<span class="cp">#define SYSCONFIG2		5	</span><span class="cm">/* System Configuration 2 */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG2_SEEKTH	0xff00	</span><span class="cm">/* bits 15..08: RSSI Seek Threshold */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG2_BAND		0x0080	</span><span class="cm">/* bits 07..06: Band Select */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG2_SPACE	0x0030	</span><span class="cm">/* bits 05..04: Channel Spacing */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG2_VOLUME	0x000f	</span><span class="cm">/* bits 03..00: Volume */</span><span class="cp"></span>

<span class="cp">#define SYSCONFIG3		6	</span><span class="cm">/* System Configuration 3 */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG3_SMUTER	0xc000	</span><span class="cm">/* bits 15..14: Softmute Attack/Recover Rate */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG3_SMUTEA	0x3000	</span><span class="cm">/* bits 13..12: Softmute Attenuation */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG3_SKSNR	0x00f0	</span><span class="cm">/* bits 07..04: Seek SNR Threshold */</span><span class="cp"></span>
<span class="cp">#define SYSCONFIG3_SKCNT	0x000f	</span><span class="cm">/* bits 03..00: Seek FM Impulse Detection Threshold */</span><span class="cp"></span>

<span class="cp">#define TEST1			7	</span><span class="cm">/* Test 1 */</span><span class="cp"></span>
<span class="cp">#define TEST1_AHIZEN		0x4000	</span><span class="cm">/* bits 14..14: Audio High-Z Enable */</span><span class="cp"></span>

<span class="cp">#define TEST2			8	</span><span class="cm">/* Test 2 */</span><span class="cp"></span>
<span class="cm">/* TEST2 only contains reserved bits */</span>

<span class="cp">#define BOOTCONFIG		9	</span><span class="cm">/* Boot Configuration */</span><span class="cp"></span>
<span class="cm">/* BOOTCONFIG only contains reserved bits */</span>

<span class="cp">#define STATUSRSSI		10	</span><span class="cm">/* Status RSSI */</span><span class="cp"></span>
<span class="cp">#define STATUSRSSI_RDSR		0x8000	</span><span class="cm">/* bits 15..15: RDS Ready (Si4701 only) */</span><span class="cp"></span>
<span class="cp">#define STATUSRSSI_STC		0x4000	</span><span class="cm">/* bits 14..14: Seek/Tune Complete */</span><span class="cp"></span>
<span class="cp">#define STATUSRSSI_SF		0x2000	</span><span class="cm">/* bits 13..13: Seek Fail/Band Limit */</span><span class="cp"></span>
<span class="cp">#define STATUSRSSI_AFCRL	0x1000	</span><span class="cm">/* bits 12..12: AFC Rail */</span><span class="cp"></span>
<span class="cp">#define STATUSRSSI_RDSS		0x0800	</span><span class="cm">/* bits 11..11: RDS Synchronized (Si4701 only) */</span><span class="cp"></span>
<span class="cp">#define STATUSRSSI_BLERA	0x0600	</span><span class="cm">/* bits 10..09: RDS Block A Errors (Si4701 only) */</span><span class="cp"></span>
<span class="cp">#define STATUSRSSI_ST		0x0100	</span><span class="cm">/* bits 08..08: Stereo Indicator */</span><span class="cp"></span>
<span class="cp">#define STATUSRSSI_RSSI		0x00ff	</span><span class="cm">/* bits 07..00: RSSI (Received Signal Strength Indicator) */</span><span class="cp"></span>

<span class="cp">#define READCHAN		11	</span><span class="cm">/* Read Channel */</span><span class="cp"></span>
<span class="cp">#define READCHAN_BLERB		0xc000	</span><span class="cm">/* bits 15..14: RDS Block D Errors (Si4701 only) */</span><span class="cp"></span>
<span class="cp">#define READCHAN_BLERC		0x3000	</span><span class="cm">/* bits 13..12: RDS Block C Errors (Si4701 only) */</span><span class="cp"></span>
<span class="cp">#define READCHAN_BLERD		0x0c00	</span><span class="cm">/* bits 11..10: RDS Block B Errors (Si4701 only) */</span><span class="cp"></span>
<span class="cp">#define READCHAN_READCHAN	0x03ff	</span><span class="cm">/* bits 09..00: Read Channel */</span><span class="cp"></span>

<span class="cp">#define RDSA			12	</span><span class="cm">/* RDSA */</span><span class="cp"></span>
<span class="cp">#define RDSA_RDSA		0xffff	</span><span class="cm">/* bits 15..00: RDS Block A Data (Si4701 only) */</span><span class="cp"></span>

<span class="cp">#define RDSB			13	</span><span class="cm">/* RDSB */</span><span class="cp"></span>
<span class="cp">#define RDSB_RDSB		0xffff	</span><span class="cm">/* bits 15..00: RDS Block B Data (Si4701 only) */</span><span class="cp"></span>

<span class="cp">#define RDSC			14	</span><span class="cm">/* RDSC */</span><span class="cp"></span>
<span class="cp">#define RDSC_RDSC		0xffff	</span><span class="cm">/* bits 15..00: RDS Block C Data (Si4701 only) */</span><span class="cp"></span>

<span class="cp">#define RDSD			15	</span><span class="cm">/* RDSD */</span><span class="cp"></span>
<span class="cp">#define RDSD_RDSD		0xffff	</span><span class="cm">/* bits 15..00: RDS Block D Data (Si4701 only) */</span><span class="cp"></span>



<span class="cm">/**************************************************************************</span>
<span class="cm"> * General Driver Definitions</span>
<span class="cm"> **************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * si470x_device - private data</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">si470x_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="n">videodev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="n">hdl</span><span class="p">;</span>

	<span class="cm">/* Silabs internal registers (0..15) */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">registers</span><span class="p">[</span><span class="n">RADIO_REGISTER_NUM</span><span class="p">];</span>

	<span class="cm">/* RDS receive buffer */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">read_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>		<span class="cm">/* buffer locking */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>		<span class="cm">/* size is always multiple of three */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rd_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wr_index</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">completion</span> <span class="n">completion</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">stci_enabled</span><span class="p">;</span>		<span class="cm">/* Seek/Tune Complete Interrupt */</span>

<span class="cp">#if defined(CONFIG_USB_SI470X) || defined(CONFIG_USB_SI470X_MODULE)</span>
	<span class="cm">/* reference to USB and video device */</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>

	<span class="cm">/* Interrupt endpoint handling */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">int_in_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">int_in_endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">int_in_urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">int_in_running</span><span class="p">;</span>

	<span class="cm">/* scratch page */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">software_version</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hardware_version</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_I2C_SI470X) || defined(CONFIG_I2C_SI470X_MODULE)</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>



<span class="cm">/**************************************************************************</span>
<span class="cm"> * Firmware Versions</span>
<span class="cm"> **************************************************************************/</span>

<span class="cp">#define RADIO_FW_VERSION	15</span>



<span class="cm">/**************************************************************************</span>
<span class="cm"> * Frequency Multiplicator</span>
<span class="cm"> **************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * The frequency is set in units of 62.5 Hz when using V4L2_TUNER_CAP_LOW,</span>
<span class="cm"> * 62.5 kHz otherwise.</span>
<span class="cm"> * The tuner is able to have a channel spacing of 50, 100 or 200 kHz.</span>
<span class="cm"> * tuner-&gt;capability is therefore set to V4L2_TUNER_CAP_LOW</span>
<span class="cm"> * The FREQ_MUL is then: 1 MHz / 62.5 Hz = 16000</span>
<span class="cm"> */</span>
<span class="cp">#define FREQ_MUL (1000000 / 62.5)</span>



<span class="cm">/**************************************************************************</span>
<span class="cm"> * Common Functions</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">si470x_viddev_template</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">si470x_ctrl_ops</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">si470x_get_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnr</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnr</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">si470x_disconnect_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">si470x_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">si470x_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">si470x_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">si470x_fops_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">si470x_fops_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">si470x_vidioc_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">capability</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
