<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › radio › si470x › radio-si470x-common.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>radio-si470x-common.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/media/radio/si470x/radio-si470x-common.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Driver for radios with Silicon Labs Si470x FM Radio Receivers</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2009 Tobias Lorenz &lt;tobias.lorenz@gmx.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>


<span class="cm">/*</span>
<span class="cm"> * History:</span>
<span class="cm"> * 2008-01-12	Tobias Lorenz &lt;tobias.lorenz@gmx.net&gt;</span>
<span class="cm"> *		Version 1.0.0</span>
<span class="cm"> *		- First working version</span>
<span class="cm"> * 2008-01-13	Tobias Lorenz &lt;tobias.lorenz@gmx.net&gt;</span>
<span class="cm"> *		Version 1.0.1</span>
<span class="cm"> *		- Improved error handling, every function now returns errno</span>
<span class="cm"> *		- Improved multi user access (start/mute/stop)</span>
<span class="cm"> *		- Channel doesn&#39;t get lost anymore after start/mute/stop</span>
<span class="cm"> *		- RDS support added (polling mode via interrupt EP 1)</span>
<span class="cm"> *		- marked default module parameters with *value*</span>
<span class="cm"> *		- switched from bit structs to bit masks</span>
<span class="cm"> *		- header file cleaned and integrated</span>
<span class="cm"> * 2008-01-14	Tobias Lorenz &lt;tobias.lorenz@gmx.net&gt;</span>
<span class="cm"> * 		Version 1.0.2</span>
<span class="cm"> * 		- hex values are now lower case</span>
<span class="cm"> * 		- commented USB ID for ADS/Tech moved on todo list</span>
<span class="cm"> * 		- blacklisted si470x in hid-quirks.c</span>
<span class="cm"> * 		- rds buffer handling functions integrated into *_work, *_read</span>
<span class="cm"> * 		- rds_command in si470x_poll exchanged against simple retval</span>
<span class="cm"> * 		- check for firmware version 15</span>
<span class="cm"> * 		- code order and prototypes still remain the same</span>
<span class="cm"> * 		- spacing and bottom of band codes remain the same</span>
<span class="cm"> * 2008-01-16	Tobias Lorenz &lt;tobias.lorenz@gmx.net&gt;</span>
<span class="cm"> *		Version 1.0.3</span>
<span class="cm"> * 		- code reordered to avoid function prototypes</span>
<span class="cm"> *		- switch/case defaults are now more user-friendly</span>
<span class="cm"> *		- unified comment style</span>
<span class="cm"> *		- applied all checkpatch.pl v1.12 suggestions</span>
<span class="cm"> *		  except the warning about the too long lines with bit comments</span>
<span class="cm"> *		- renamed FMRADIO to RADIO to cut line length (checkpatch.pl)</span>
<span class="cm"> * 2008-01-22	Tobias Lorenz &lt;tobias.lorenz@gmx.net&gt;</span>
<span class="cm"> *		Version 1.0.4</span>
<span class="cm"> *		- avoid poss. locking when doing copy_to_user which may sleep</span>
<span class="cm"> *		- RDS is automatically activated on read now</span>
<span class="cm"> *		- code cleaned of unnecessary rds_commands</span>
<span class="cm"> *		- USB Vendor/Product ID for ADS/Tech FM Radio Receiver verified</span>
<span class="cm"> *		  (thanks to Guillaume RAMOUSSE)</span>
<span class="cm"> * 2008-01-27	Tobias Lorenz &lt;tobias.lorenz@gmx.net&gt;</span>
<span class="cm"> *		Version 1.0.5</span>
<span class="cm"> *		- number of seek_retries changed to tune_timeout</span>
<span class="cm"> *		- fixed problem with incomplete tune operations by own buffers</span>
<span class="cm"> *		- optimization of variables and printf types</span>
<span class="cm"> *		- improved error logging</span>
<span class="cm"> * 2008-01-31	Tobias Lorenz &lt;tobias.lorenz@gmx.net&gt;</span>
<span class="cm"> *		Oliver Neukum &lt;oliver@neukum.org&gt;</span>
<span class="cm"> *		Version 1.0.6</span>
<span class="cm"> *		- fixed coverity checker warnings in *_usb_driver_disconnect</span>
<span class="cm"> *		- probe()/open() race by correct ordering in probe()</span>
<span class="cm"> *		- DMA coherency rules by separate allocation of all buffers</span>
<span class="cm"> *		- use of endianness macros</span>
<span class="cm"> *		- abuse of spinlock, replaced by mutex</span>
<span class="cm"> *		- racy handling of timer in disconnect,</span>
<span class="cm"> *		  replaced by delayed_work</span>
<span class="cm"> *		- racy interruptible_sleep_on(),</span>
<span class="cm"> *		  replaced with wait_event_interruptible()</span>
<span class="cm"> *		- handle signals in read()</span>
<span class="cm"> * 2008-02-08	Tobias Lorenz &lt;tobias.lorenz@gmx.net&gt;</span>
<span class="cm"> *		Oliver Neukum &lt;oliver@neukum.org&gt;</span>
<span class="cm"> *		Version 1.0.7</span>
<span class="cm"> *		- usb autosuspend support</span>
<span class="cm"> *		- unplugging fixed</span>
<span class="cm"> * 2008-05-07	Tobias Lorenz &lt;tobias.lorenz@gmx.net&gt;</span>
<span class="cm"> *		Version 1.0.8</span>
<span class="cm"> *		- hardware frequency seek support</span>
<span class="cm"> *		- afc indication</span>
<span class="cm"> *		- more safety checks, let si470x_get_freq return errno</span>
<span class="cm"> *		- vidioc behavior corrected according to v4l2 spec</span>
<span class="cm"> * 2008-10-20	Alexey Klimov &lt;klimov.linux@gmail.com&gt;</span>
<span class="cm"> * 		- add support for KWorld USB FM Radio FM700</span>
<span class="cm"> * 		- blacklisted KWorld radio in hid-core.c and hid-ids.h</span>
<span class="cm"> * 2008-12-03	Mark Lord &lt;mlord@pobox.com&gt;</span>
<span class="cm"> *		- add support for DealExtreme USB Radio</span>
<span class="cm"> * 2009-01-31	Bob Ross &lt;pigiron@gmx.com&gt;</span>
<span class="cm"> *		- correction of stereo detection/setting</span>
<span class="cm"> *		- correction of signal strength indicator scaling</span>
<span class="cm"> * 2009-01-31	Rick Bronson &lt;rick@efn.org&gt;</span>
<span class="cm"> *		Tobias Lorenz &lt;tobias.lorenz@gmx.net&gt;</span>
<span class="cm"> *		- add LED status output</span>
<span class="cm"> *		- get HW/SW version from scratchpad</span>
<span class="cm"> * 2009-06-16   Edouard Lafargue &lt;edouard@lafargue.name&gt;</span>
<span class="cm"> *		Version 1.0.10</span>
<span class="cm"> *		- add support for interrupt mode for RDS endpoint,</span>
<span class="cm"> *                instead of polling.</span>
<span class="cm"> *                Improves RDS reception significantly</span>
<span class="cm"> */</span>


<span class="cm">/* kernel includes */</span>
<span class="cp">#include &quot;radio-si470x.h&quot;</span>



<span class="cm">/**************************************************************************</span>
<span class="cm"> * Module Parameters</span>
<span class="cm"> **************************************************************************/</span>

<span class="cm">/* Spacing (kHz) */</span>
<span class="cm">/* 0: 200 kHz (USA, Australia) */</span>
<span class="cm">/* 1: 100 kHz (Europe, Japan) */</span>
<span class="cm">/* 2:  50 kHz */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">space</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="s">&quot;Spacing: 0=200kHz 1=100kHz *2=50kHz*&quot;</span><span class="p">);</span>

<span class="cm">/* Bottom of Band (MHz) */</span>
<span class="cm">/* 0: 87.5 - 108 MHz (USA, Europe)*/</span>
<span class="cm">/* 1: 76   - 108 MHz (Japan wide band) */</span>
<span class="cm">/* 2: 76   -  90 MHz (Japan) */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">band</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="s">&quot;Band: 0=87.5..108MHz *1=76..108MHz* 2=76..90MHz&quot;</span><span class="p">);</span>

<span class="cm">/* De-emphasis */</span>
<span class="cm">/* 0: 75 us (USA) */</span>
<span class="cm">/* 1: 50 us (Europe, Australia, Japan) */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">de</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">de</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">de</span><span class="p">,</span> <span class="s">&quot;De-emphasis: 0=75us *1=50us*&quot;</span><span class="p">);</span>

<span class="cm">/* Tune timeout */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tune_timeout</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tune_timeout</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tune_timeout</span><span class="p">,</span> <span class="s">&quot;Tune timeout: *3000*&quot;</span><span class="p">);</span>

<span class="cm">/* Seek timeout */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seek_timeout</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">seek_timeout</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">seek_timeout</span><span class="p">,</span> <span class="s">&quot;Seek timeout: *5000*&quot;</span><span class="p">);</span>



<span class="cm">/**************************************************************************</span>
<span class="cm"> * Generic Functions</span>
<span class="cm"> **************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * si470x_set_chan - set the channel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si470x_set_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">timed_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* start tuning */</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">CHANNEL</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CHANNEL_CHAN</span><span class="p">;</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">CHANNEL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CHANNEL_TUNE</span> <span class="o">|</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">CHANNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* currently I2C driver only uses interrupt way to tune */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">stci_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>

		<span class="cm">/* wait till tune operation has completed */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">tune_timeout</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
			<span class="n">timed_out</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* wait till tune operation has completed */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">tune_timeout</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_get_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">STATUSRSSI</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">stop</span><span class="p">;</span>
			<span class="n">timed_out</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(((</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">STATUSRSSI</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">STATUSRSSI_STC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">timed_out</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">STATUSRSSI</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">STATUSRSSI_STC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tune does not complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timed_out</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;tune timed out after %u ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tune_timeout</span><span class="p">);</span>

<span class="nl">stop:</span>
	<span class="cm">/* stop tuning */</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">CHANNEL</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CHANNEL_TUNE</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">CHANNEL</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_get_freq - get the frequency</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si470x_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">band_bottom</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Spacing (kHz) */</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SYSCONFIG2_SPACE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* 0: 200 kHz (USA, Australia) */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">spacing</span> <span class="o">=</span> <span class="mf">0.200</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 1: 100 kHz (Europe, Japan) */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">spacing</span> <span class="o">=</span> <span class="mf">0.100</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 2:  50 kHz */</span>
	<span class="nl">default:</span>
		<span class="n">spacing</span> <span class="o">=</span> <span class="mf">0.050</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="cm">/* Bottom of Band (MHz) */</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SYSCONFIG2_BAND</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* 0: 87.5 - 108 MHz (USA, Europe) */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">band_bottom</span> <span class="o">=</span> <span class="mf">87.5</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 1: 76   - 108 MHz (Japan wide band) */</span>
	<span class="nl">default:</span>
		<span class="n">band_bottom</span> <span class="o">=</span> <span class="mi">76</span>   <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 2: 76   -  90 MHz (Japan) */</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">band_bottom</span> <span class="o">=</span> <span class="mi">76</span>   <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="cm">/* read channel */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_get_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">READCHAN</span><span class="p">);</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">READCHAN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">READCHAN_READCHAN</span><span class="p">;</span>

	<span class="cm">/* Frequency (MHz) = Spacing (kHz) x Channel + Bottom of Band (MHz) */</span>
	<span class="o">*</span><span class="n">freq</span> <span class="o">=</span> <span class="n">chan</span> <span class="o">*</span> <span class="n">spacing</span> <span class="o">+</span> <span class="n">band_bottom</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_set_freq - set the frequency</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">si470x_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">band_bottom</span><span class="p">,</span> <span class="n">band_top</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">chan</span><span class="p">;</span>

	<span class="cm">/* Spacing (kHz) */</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SYSCONFIG2_SPACE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* 0: 200 kHz (USA, Australia) */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">spacing</span> <span class="o">=</span> <span class="mf">0.200</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 1: 100 kHz (Europe, Japan) */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">spacing</span> <span class="o">=</span> <span class="mf">0.100</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 2:  50 kHz */</span>
	<span class="nl">default:</span>
		<span class="n">spacing</span> <span class="o">=</span> <span class="mf">0.050</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="cm">/* Bottom/Top of Band (MHz) */</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SYSCONFIG2_BAND</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* 0: 87.5 - 108 MHz (USA, Europe) */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">band_bottom</span> <span class="o">=</span> <span class="mf">87.5</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
		<span class="n">band_top</span> <span class="o">=</span> <span class="mi">108</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 1: 76   - 108 MHz (Japan wide band) */</span>
	<span class="nl">default:</span>
		<span class="n">band_bottom</span> <span class="o">=</span> <span class="mi">76</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
		<span class="n">band_top</span> <span class="o">=</span> <span class="mi">108</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 2: 76   -  90 MHz (Japan) */</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">band_bottom</span> <span class="o">=</span> <span class="mi">76</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
		<span class="n">band_top</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">band_bottom</span><span class="p">,</span> <span class="n">band_top</span><span class="p">);</span>
	<span class="cm">/* Chan = [ Freq (Mhz) - Bottom of Band (MHz) ] / Spacing (kHz) */</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">-</span> <span class="n">band_bottom</span><span class="p">)</span> <span class="o">/</span> <span class="n">spacing</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">si470x_set_chan</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_set_seek - set seek</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si470x_set_seek</span><span class="p">(</span><span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wrap_around</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seek_upward</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">timed_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* start seeking */</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">|=</span> <span class="n">POWERCFG_SEEK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrap_around</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">POWERCFG_SKMODE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">|=</span> <span class="n">POWERCFG_SKMODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seek_upward</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">|=</span> <span class="n">POWERCFG_SEEKUP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">POWERCFG_SEEKUP</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">POWERCFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* currently I2C driver only uses interrupt way to seek */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">stci_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>

		<span class="cm">/* wait till seek operation has completed */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">seek_timeout</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
			<span class="n">timed_out</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* wait till seek operation has completed */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">seek_timeout</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_get_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">STATUSRSSI</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">stop</span><span class="p">;</span>
			<span class="n">timed_out</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(((</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">STATUSRSSI</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">STATUSRSSI_STC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">timed_out</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">STATUSRSSI</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">STATUSRSSI_STC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;seek does not complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">STATUSRSSI</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">STATUSRSSI_SF</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;seek failed / band limit reached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">stop:</span>
	<span class="cm">/* stop seeking */</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">POWERCFG_SEEK</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">POWERCFG</span><span class="p">);</span>

	<span class="cm">/* try again, if timed out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">timed_out</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_start - switch on radio</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">si470x_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* powercfg */</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">POWERCFG_DMUTE</span> <span class="o">|</span> <span class="n">POWERCFG_ENABLE</span> <span class="o">|</span> <span class="n">POWERCFG_RDSM</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">POWERCFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* sysconfig 1 */</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG1</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">de</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SYSCONFIG1_DE</span><span class="p">;</span>		<span class="cm">/* DE*/</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">SYSCONFIG1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* sysconfig 2 */</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG2</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="mh">0x3f</span>  <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>				<span class="cm">/* SEEKTH */</span>
		<span class="p">((</span><span class="n">band</span>  <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SYSCONFIG2_BAND</span><span class="p">)</span>  <span class="o">|</span>	<span class="cm">/* BAND */</span>
		<span class="p">((</span><span class="n">space</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SYSCONFIG2_SPACE</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* SPACE */</span>
		<span class="mi">15</span><span class="p">;</span>					<span class="cm">/* VOLUME (max) */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">SYSCONFIG2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* reset last channel */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_set_chan</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">CHANNEL</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CHANNEL_CHAN</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_stop - switch off radio</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">si470x_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* sysconfig 1 */</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYSCONFIG1_RDS</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">SYSCONFIG1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* powercfg */</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">POWERCFG_DMUTE</span><span class="p">;</span>
	<span class="cm">/* POWERCFG_ENABLE has to automatically go low */</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">|=</span> <span class="n">POWERCFG_ENABLE</span> <span class="o">|</span>	<span class="n">POWERCFG_DISABLE</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">POWERCFG</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_rds_on - switch on rds reception</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si470x_rds_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* sysconfig 1 */</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SYSCONFIG1_RDS</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">SYSCONFIG1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYSCONFIG1_RDS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/**************************************************************************</span>
<span class="cm"> * File Operations Interface</span>
<span class="cm"> **************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * si470x_fops_read - read RDS data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">si470x_fops_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* switch on rds reception */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SYSCONFIG1_RDS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">si470x_rds_on</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>

	<span class="cm">/* block if no new data available */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span> <span class="o">==</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">read_queue</span><span class="p">,</span>
			<span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span> <span class="o">!=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* calculate block count from byte count */</span>
	<span class="n">count</span> <span class="o">/=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* copy RDS block out of internal buffer and to user buffer */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">block_count</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span> <span class="o">==</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* always transfer rds complete blocks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
			<span class="cm">/* retval = -EFAULT; */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* increment and wrap read pointer */</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span> <span class="o">&gt;=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">)</span>
			<span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* increment counters */</span>
		<span class="n">block_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_fops_poll - poll RDS data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">si470x_fops_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">pts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">req_events</span> <span class="o">=</span> <span class="n">poll_requested_events</span><span class="p">(</span><span class="n">pts</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_poll</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">pts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req_events</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* switch on rds reception */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SYSCONFIG1_RDS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">si470x_rds_on</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>

		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">read_queue</span><span class="p">,</span> <span class="n">pts</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">rd_index</span> <span class="o">!=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">wr_index</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_fops - file operations interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">si470x_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>			<span class="o">=</span> <span class="n">si470x_fops_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>			<span class="o">=</span> <span class="n">si470x_fops_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>		<span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">si470x_fops_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">si470x_fops_release</span><span class="p">,</span>
<span class="p">};</span>



<span class="cm">/**************************************************************************</span>
<span class="cm"> * Video4Linux Interface</span>
<span class="cm"> **************************************************************************/</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">si470x_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">si470x_device</span><span class="p">,</span> <span class="n">hdl</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span>:
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYSCONFIG2_VOLUME</span><span class="p">;</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">SYSCONFIG2</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
			<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">POWERCFG_DMUTE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">|=</span> <span class="n">POWERCFG_DMUTE</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">POWERCFG</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_vidioc_g_tuner - get tuner attributes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si470x_vidioc_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">tuner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tuner</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">si470x_get_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">STATUSRSSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* driver constants */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">tuner</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;FM&quot;</span><span class="p">);</span>
	<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">;</span>
	<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_TUNER_CAP_LOW</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_STEREO</span> <span class="o">|</span>
			    <span class="n">V4L2_TUNER_CAP_RDS</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_RDS_BLOCK_IO</span><span class="p">;</span>

	<span class="cm">/* range limits */</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">SYSCONFIG2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SYSCONFIG2_BAND</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* 0: 87.5 - 108 MHz (USA, Europe, default) */</span>
	<span class="nl">default:</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rangelow</span>  <span class="o">=</span>  <span class="mf">87.5</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rangehigh</span> <span class="o">=</span> <span class="mi">108</span>   <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 1: 76   - 108 MHz (Japan wide band) */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rangelow</span>  <span class="o">=</span>  <span class="mi">76</span>   <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rangehigh</span> <span class="o">=</span> <span class="mi">108</span>   <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 2: 76   -  90 MHz (Japan) */</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rangelow</span>  <span class="o">=</span>  <span class="mi">76</span>   <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rangehigh</span> <span class="o">=</span>  <span class="mi">90</span>   <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="cm">/* stereo indicator == stereo (instead of mono) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">STATUSRSSI</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">STATUSRSSI_ST</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
	<span class="cm">/* If there is a reliable method of detecting an RDS channel,</span>
<span class="cm">	   then this code should check for that before setting this</span>
<span class="cm">	   RDS subchannel. */</span>
	<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_SUB_RDS</span><span class="p">;</span>

	<span class="cm">/* mono/stereo selector */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">POWERCFG_MONO</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">;</span>

	<span class="cm">/* min is worst, max is best; signal:0..0xffff; rssi: 0..0xff */</span>
	<span class="cm">/* measured in units of dbµV in 1 db increments (max at ~75 dbµV) */</span>
	<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">STATUSRSSI</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">STATUSRSSI_RSSI</span><span class="p">);</span>
	<span class="cm">/* the ideal factor is 0xffff/75 = 873,8 */</span>
	<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">tuner</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">*</span> <span class="mi">873</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">tuner</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tuner</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="cm">/* automatic frequency control: -1: freq to low, 1 freq to high */</span>
	<span class="cm">/* AFCRL does only indicate that freq. differs, not if too low/high */</span>
	<span class="n">tuner</span><span class="o">-&gt;</span><span class="n">afc</span> <span class="o">=</span> <span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">STATUSRSSI</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">STATUSRSSI_AFCRL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_vidioc_s_tuner - set tuner attributes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si470x_vidioc_s_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">tuner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tuner</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* mono/stereo selector */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tuner</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">|=</span> <span class="n">POWERCFG_MONO</span><span class="p">;</span>  <span class="cm">/* force mono */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
	<span class="nl">default:</span>
		<span class="n">radio</span><span class="o">-&gt;</span><span class="n">registers</span><span class="p">[</span><span class="n">POWERCFG</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">POWERCFG_MONO</span><span class="p">;</span> <span class="cm">/* try stereo */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">si470x_set_register</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">POWERCFG</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_vidioc_g_frequency - get tuner or modulator radio frequency</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si470x_vidioc_g_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">freq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">si470x_get_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_vidioc_s_frequency - set tuner or modulator radio frequency</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si470x_vidioc_s_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">si470x_set_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_vidioc_s_hw_freq_seek - set hardware frequency seek</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">si470x_vidioc_s_hw_freq_seek</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_hw_freq_seek</span> <span class="o">*</span><span class="n">seek</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">si470x_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seek</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">si470x_set_seek</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">seek</span><span class="o">-&gt;</span><span class="n">wrap_around</span><span class="p">,</span> <span class="n">seek</span><span class="o">-&gt;</span><span class="n">seek_upward</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">si470x_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">si470x_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * si470x_ioctl_ops - video device ioctl operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">si470x_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>	<span class="o">=</span> <span class="n">si470x_vidioc_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_tuner</span>		<span class="o">=</span> <span class="n">si470x_vidioc_g_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_tuner</span>		<span class="o">=</span> <span class="n">si470x_vidioc_s_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_frequency</span>	<span class="o">=</span> <span class="n">si470x_vidioc_g_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_frequency</span>	<span class="o">=</span> <span class="n">si470x_vidioc_s_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_hw_freq_seek</span>	<span class="o">=</span> <span class="n">si470x_vidioc_s_hw_freq_seek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_subscribe_event</span> <span class="o">=</span> <span class="n">v4l2_ctrl_subscribe_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_unsubscribe_event</span> <span class="o">=</span> <span class="n">v4l2_event_unsubscribe</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * si470x_viddev_template - video device interface</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">video_device</span> <span class="n">si470x_viddev_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fops</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">si470x_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">video_device_release_empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">si470x_ioctl_ops</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
