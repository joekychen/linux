<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › radio › radio-tea5764.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>radio-tea5764.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * driver/media/radio/radio-tea5764.c</span>
<span class="cm"> *</span>
<span class="cm"> * Driver for TEA5764 radio chip for linux 2.6.</span>
<span class="cm"> * This driver is for TEA5764 chip from NXP, used in EZX phones from Motorola.</span>
<span class="cm"> * The I2C protocol is used for communicate with chip.</span>
<span class="cm"> *</span>
<span class="cm"> * Based in radio-tea5761.c Copyright (C) 2005 Nokia Corporation</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2008 Fabio Belavenuto &lt;belavenuto@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> * History:</span>
<span class="cm"> * 2008-12-06   Fabio Belavenuto &lt;belavenuto@gmail.com&gt;</span>
<span class="cm"> *              initial code</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> *  add platform_data support for IRQs platform dependencies</span>
<span class="cm"> *  add RDS support</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;			</span><span class="cm">/* Initdata			*/</span><span class="cp"></span>
<span class="cp">#include &lt;linux/videodev2.h&gt;		</span><span class="cm">/* kernel radio structs		*/</span><span class="cp"></span>
<span class="cp">#include &lt;linux/i2c.h&gt;			</span><span class="cm">/* I2C				*/</span><span class="cp"></span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>

<span class="cp">#define DRIVER_VERSION	&quot;0.0.2&quot;</span>

<span class="cp">#define DRIVER_AUTHOR	&quot;Fabio Belavenuto &lt;belavenuto@gmail.com&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC	&quot;A driver for the TEA5764 radio chip for EZX Phones.&quot;</span>

<span class="cp">#define PINFO(format, ...)\</span>
<span class="cp">	printk(KERN_INFO KBUILD_MODNAME &quot;: &quot;\</span>
<span class="cp">		DRIVER_VERSION &quot;: &quot; format &quot;\n&quot;, ## __VA_ARGS__)</span>
<span class="cp">#define PWARN(format, ...)\</span>
<span class="cp">	printk(KERN_WARNING KBUILD_MODNAME &quot;: &quot;\</span>
<span class="cp">		DRIVER_VERSION &quot;: &quot; format &quot;\n&quot;, ## __VA_ARGS__)</span>
<span class="cp"># define PDEBUG(format, ...)\</span>
<span class="cp">	printk(KERN_DEBUG KBUILD_MODNAME &quot;: &quot;\</span>
<span class="cp">		DRIVER_VERSION &quot;: &quot; format &quot;\n&quot;, ## __VA_ARGS__)</span>

<span class="cm">/* Frequency limits in MHz -- these are European values.  For Japanese</span>
<span class="cm">devices, that would be 76000 and 91000.  */</span>
<span class="cp">#define FREQ_MIN  87500</span>
<span class="cp">#define FREQ_MAX 108000</span>
<span class="cp">#define FREQ_MUL 16</span>

<span class="cm">/* TEA5764 registers */</span>
<span class="cp">#define TEA5764_MANID		0x002b</span>
<span class="cp">#define TEA5764_CHIPID		0x5764</span>

<span class="cp">#define TEA5764_INTREG_BLMSK	0x0001</span>
<span class="cp">#define TEA5764_INTREG_FRRMSK	0x0002</span>
<span class="cp">#define TEA5764_INTREG_LEVMSK	0x0008</span>
<span class="cp">#define TEA5764_INTREG_IFMSK	0x0010</span>
<span class="cp">#define TEA5764_INTREG_BLMFLAG	0x0100</span>
<span class="cp">#define TEA5764_INTREG_FRRFLAG	0x0200</span>
<span class="cp">#define TEA5764_INTREG_LEVFLAG	0x0800</span>
<span class="cp">#define TEA5764_INTREG_IFFLAG	0x1000</span>

<span class="cp">#define TEA5764_FRQSET_SUD	0x8000</span>
<span class="cp">#define TEA5764_FRQSET_SM	0x4000</span>

<span class="cp">#define TEA5764_TNCTRL_PUPD1	0x8000</span>
<span class="cp">#define TEA5764_TNCTRL_PUPD0	0x4000</span>
<span class="cp">#define TEA5764_TNCTRL_BLIM	0x2000</span>
<span class="cp">#define TEA5764_TNCTRL_SWPM	0x1000</span>
<span class="cp">#define TEA5764_TNCTRL_IFCTC	0x0800</span>
<span class="cp">#define TEA5764_TNCTRL_AFM	0x0400</span>
<span class="cp">#define TEA5764_TNCTRL_SMUTE	0x0200</span>
<span class="cp">#define TEA5764_TNCTRL_SNC	0x0100</span>
<span class="cp">#define TEA5764_TNCTRL_MU	0x0080</span>
<span class="cp">#define TEA5764_TNCTRL_SSL1	0x0040</span>
<span class="cp">#define TEA5764_TNCTRL_SSL0	0x0020</span>
<span class="cp">#define TEA5764_TNCTRL_HLSI	0x0010</span>
<span class="cp">#define TEA5764_TNCTRL_MST	0x0008</span>
<span class="cp">#define TEA5764_TNCTRL_SWP	0x0004</span>
<span class="cp">#define TEA5764_TNCTRL_DTC	0x0002</span>
<span class="cp">#define TEA5764_TNCTRL_AHLSI	0x0001</span>

<span class="cp">#define TEA5764_TUNCHK_LEVEL(x)	(((x) &amp; 0x00F0) &gt;&gt; 4)</span>
<span class="cp">#define TEA5764_TUNCHK_IFCNT(x) (((x) &amp; 0xFE00) &gt;&gt; 9)</span>
<span class="cp">#define TEA5764_TUNCHK_TUNTO	0x0100</span>
<span class="cp">#define TEA5764_TUNCHK_LD	0x0008</span>
<span class="cp">#define TEA5764_TUNCHK_STEREO	0x0004</span>

<span class="cp">#define TEA5764_TESTREG_TRIGFR	0x0800</span>

<span class="k">struct</span> <span class="n">tea5764_regs</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">intreg</span><span class="p">;</span>				<span class="cm">/* INTFLAG &amp; INTMSK */</span>
	<span class="n">u16</span> <span class="n">frqset</span><span class="p">;</span>				<span class="cm">/* FRQSETMSB &amp; FRQSETLSB */</span>
	<span class="n">u16</span> <span class="n">tnctrl</span><span class="p">;</span>				<span class="cm">/* TNCTRL1 &amp; TNCTRL2 */</span>
	<span class="n">u16</span> <span class="n">frqchk</span><span class="p">;</span>				<span class="cm">/* FRQCHKMSB &amp; FRQCHKLSB */</span>
	<span class="n">u16</span> <span class="n">tunchk</span><span class="p">;</span>				<span class="cm">/* IFCHK &amp; LEVCHK */</span>
	<span class="n">u16</span> <span class="n">testreg</span><span class="p">;</span>				<span class="cm">/* TESTBITS &amp; TESTMODE */</span>
	<span class="n">u16</span> <span class="n">rdsstat</span><span class="p">;</span>				<span class="cm">/* RDSSTAT1 &amp; RDSSTAT2 */</span>
	<span class="n">u16</span> <span class="n">rdslb</span><span class="p">;</span>				<span class="cm">/* RDSLBMSB &amp; RDSLBLSB */</span>
	<span class="n">u16</span> <span class="n">rdspb</span><span class="p">;</span>				<span class="cm">/* RDSPBMSB &amp; RDSPBLSB */</span>
	<span class="n">u16</span> <span class="n">rdsbc</span><span class="p">;</span>				<span class="cm">/* RDSBBC &amp; RDSGBC */</span>
	<span class="n">u16</span> <span class="n">rdsctrl</span><span class="p">;</span>				<span class="cm">/* RDSCTRL1 &amp; RDSCTRL2 */</span>
	<span class="n">u16</span> <span class="n">rdsbbl</span><span class="p">;</span>				<span class="cm">/* PAUSEDET &amp; RDSBBL */</span>
	<span class="n">u16</span> <span class="n">manid</span><span class="p">;</span>				<span class="cm">/* MANID1 &amp; MANID2 */</span>
	<span class="n">u16</span> <span class="n">chipid</span><span class="p">;</span>				<span class="cm">/* CHIPID1 &amp; CHIPID2 */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">tea5764_write_regs</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">intreg</span><span class="p">;</span>				<span class="cm">/* INTMSK */</span>
	<span class="n">u16</span> <span class="n">frqset</span><span class="p">;</span>				<span class="cm">/* FRQSETMSB &amp; FRQSETLSB */</span>
	<span class="n">u16</span> <span class="n">tnctrl</span><span class="p">;</span>				<span class="cm">/* TNCTRL1 &amp; TNCTRL2 */</span>
	<span class="n">u16</span> <span class="n">testreg</span><span class="p">;</span>				<span class="cm">/* TESTBITS &amp; TESTMODE */</span>
	<span class="n">u16</span> <span class="n">rdsctrl</span><span class="p">;</span>				<span class="cm">/* RDSCTRL1 &amp; RDSCTRL2 */</span>
	<span class="n">u16</span> <span class="n">rdsbbl</span><span class="p">;</span>				<span class="cm">/* PAUSEDET &amp; RDSBBL */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_RADIO_TEA5764_XTAL</span>
<span class="cp">#define RADIO_TEA5764_XTAL 1</span>
<span class="cp">#else</span>
<span class="cp">#define RADIO_TEA5764_XTAL 0</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">radio_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">use_xtal</span> <span class="o">=</span> <span class="n">RADIO_TEA5764_XTAL</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">tea5764_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>		<span class="o">*</span><span class="n">i2c_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span>		<span class="o">*</span><span class="n">videodev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tea5764_regs</span>		<span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>			<span class="n">mutex</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* I2C code related */</span>
<span class="kt">int</span> <span class="nf">tea5764_i2c_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tea5764_regs</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">__be16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tea5764_i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_write_regs</span> <span class="n">wr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tea5764_regs</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wr</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">wr</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">intreg</span>  <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">intreg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">frqset</span>  <span class="o">=</span> <span class="n">__cpu_to_be16</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">frqset</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">tnctrl</span>  <span class="o">=</span> <span class="n">__cpu_to_be16</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">testreg</span> <span class="o">=</span> <span class="n">__cpu_to_be16</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">testreg</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">rdsctrl</span> <span class="o">=</span> <span class="n">__cpu_to_be16</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rdsctrl</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">.</span><span class="n">rdsbbl</span>  <span class="o">=</span> <span class="n">__cpu_to_be16</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rdsbbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* V4L2 code related */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="n">radio_qctrl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_MUTE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Mute&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tea5764_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_regs</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span> <span class="o">&amp;</span> <span class="n">TEA5764_TNCTRL_PUPD0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TEA5764_TNCTRL_AFM</span> <span class="o">|</span> <span class="n">TEA5764_TNCTRL_MU</span> <span class="o">|</span>
			       <span class="n">TEA5764_TNCTRL_HLSI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_xtal</span><span class="p">)</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">testreg</span> <span class="o">|=</span> <span class="n">TEA5764_TESTREG_TRIGFR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">testreg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TEA5764_TESTREG_TRIGFR</span><span class="p">;</span>

		<span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span> <span class="o">|=</span> <span class="n">TEA5764_TNCTRL_PUPD0</span><span class="p">;</span>
		<span class="n">tea5764_i2c_write</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tea5764_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_regs</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span> <span class="o">&amp;</span> <span class="n">TEA5764_TNCTRL_PUPD0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TEA5764_TNCTRL_PUPD0</span><span class="p">;</span>
		<span class="n">tea5764_i2c_write</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tea5764_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_regs</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="cm">/* formula: (freq [+ or -] 225000) / 8192 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span> <span class="o">&amp;</span> <span class="n">TEA5764_TNCTRL_HLSI</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">frqset</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">+</span> <span class="mi">225000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">frqset</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">-</span> <span class="mi">225000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8192</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tea5764_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_regs</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span> <span class="o">&amp;</span> <span class="n">TEA5764_TNCTRL_HLSI</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">frqchk</span> <span class="o">*</span> <span class="mi">8192</span><span class="p">)</span> <span class="o">-</span> <span class="mi">225000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">frqchk</span> <span class="o">*</span> <span class="mi">8192</span><span class="p">)</span> <span class="o">+</span> <span class="mi">225000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* tune an frequency, freq is defined by v4l&#39;s TUNER_LOW, i.e. 1/16th kHz */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tea5764_tune</span><span class="p">(</span><span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tea5764_set_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tea5764_i2c_write</span><span class="p">(</span><span class="n">radio</span><span class="p">))</span>
		<span class="n">PWARN</span><span class="p">(</span><span class="s">&quot;Could not set frequency!&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tea5764_set_audout_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">audmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_regs</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tnctrl</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audmode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span> <span class="o">|=</span> <span class="n">TEA5764_TNCTRL_MST</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TEA5764_TNCTRL_MST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tnctrl</span> <span class="o">!=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span><span class="p">)</span>
		<span class="n">tea5764_i2c_write</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tea5764_get_audout_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_regs</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span> <span class="o">&amp;</span> <span class="n">TEA5764_TNCTRL_MST</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tea5764_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_regs</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tnctrl</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span> <span class="o">|=</span> <span class="n">TEA5764_TNCTRL_MU</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TEA5764_TNCTRL_MU</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tnctrl</span> <span class="o">!=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span><span class="p">)</span>
		<span class="n">tea5764_i2c_write</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tea5764_is_muted</span><span class="p">(</span><span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">tnctrl</span> <span class="o">&amp;</span> <span class="n">TEA5764_TNCTRL_MU</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* V4L2 vidioc */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">),</span>
		 <span class="s">&quot;I2C:%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_TUNER</span> <span class="o">|</span> <span class="n">V4L2_CAP_RADIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tea5764_regs</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;FM&quot;</span><span class="p">);</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">;</span>
	<span class="n">tea5764_i2c_read</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">rangelow</span>   <span class="o">=</span> <span class="n">FREQ_MIN</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">rangehigh</span>  <span class="o">=</span> <span class="n">FREQ_MAX</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_TUNER_CAP_LOW</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_STEREO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tunchk</span> <span class="o">&amp;</span> <span class="n">TEA5764_TUNCHK_STEREO</span><span class="p">)</span>
		<span class="n">v</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">v</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">tea5764_get_audout_mode</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">TEA5764_TUNCHK_LEVEL</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tunchk</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0xffff</span> <span class="o">/</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">afc</span> <span class="o">=</span> <span class="n">TEA5764_TUNCHK_IFCNT</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tunchk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tea5764_set_audout_mode</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We special case this as a power down control. */</span>
		<span class="n">tea5764_power_down</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">FREQ_MIN</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">FREQ_MAX</span> <span class="o">*</span> <span class="n">FREQ_MUL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">tea5764_power_up</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="n">tea5764_tune</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">*</span> <span class="mi">125</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tea5764_regs</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">tea5764_i2c_read</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">));</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tnctrl</span> <span class="o">&amp;</span> <span class="n">TEA5764_TNCTRL_PUPD0</span><span class="p">)</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="p">(</span><span class="n">tea5764_get_freq</span><span class="p">(</span><span class="n">radio</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">125</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">radio_qctrl</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">radio_qctrl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">radio_qctrl</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">qc</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
		<span class="n">tea5764_i2c_read</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">tea5764_is_muted</span><span class="p">(</span><span class="n">radio</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
		<span class="n">tea5764_mute</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Radio&quot;</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_AUDCAP_STEREO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* File system interface */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">tea5764_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">tea5764_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>    <span class="o">=</span> <span class="n">vidioc_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_tuner</span>     <span class="o">=</span> <span class="n">vidioc_g_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_tuner</span>     <span class="o">=</span> <span class="n">vidioc_s_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_audio</span>     <span class="o">=</span> <span class="n">vidioc_g_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_audio</span>     <span class="o">=</span> <span class="n">vidioc_s_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>     <span class="o">=</span> <span class="n">vidioc_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>     <span class="o">=</span> <span class="n">vidioc_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_frequency</span> <span class="o">=</span> <span class="n">vidioc_g_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_frequency</span> <span class="o">=</span> <span class="n">vidioc_s_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span>   <span class="o">=</span> <span class="n">vidioc_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span>      <span class="o">=</span> <span class="n">vidioc_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span>      <span class="o">=</span> <span class="n">vidioc_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* V4L2 interface */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">tea5764_radio_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;TEA5764 FM-Radio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">tea5764_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span> 	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tea5764_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">video_device_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* I2C probe: check if the device exists and register with v4l if it is */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tea5764_i2c_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tea5764_regs</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;probe&quot;</span><span class="p">);</span>
	<span class="n">radio</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tea5764_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">i2c_client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">tea5764_i2c_read</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errfr</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;chipid = %04X, manid = %04X&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">chipid</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">manid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chipid</span> <span class="o">!=</span> <span class="n">TEA5764_CHIPID</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">manid</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TEA5764_MANID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PWARN</span><span class="p">(</span><span class="s">&quot;This chip is not a TEA5764!&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errfr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errfr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tea5764_radio_template</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">tea5764_radio_template</span><span class="p">));</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">radio</span><span class="p">);</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">,</span> <span class="n">radio</span><span class="p">);</span>
	<span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">;</span>

	<span class="cm">/* initialize and power off the chip */</span>
	<span class="n">tea5764_i2c_read</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="n">tea5764_set_audout_mode</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">);</span>
	<span class="n">tea5764_mute</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tea5764_power_down</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">,</span> <span class="n">VFL_TYPE_RADIO</span><span class="p">,</span> <span class="n">radio_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PWARN</span><span class="p">(</span><span class="s">&quot;Could not register video device!&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errrel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PINFO</span><span class="p">(</span><span class="s">&quot;registered.&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">errrel:</span>
	<span class="n">video_device_release</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">);</span>
<span class="nl">errfr:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">tea5764_i2c_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tea5764_device</span> <span class="o">*</span><span class="n">radio</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;remove&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tea5764_power_down</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
		<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">radio</span><span class="o">-&gt;</span><span class="n">videodev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* I2C subsystem interface */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">tea5764_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;radio-tea5764&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>					<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">tea5764_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">tea5764_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;radio-tea5764&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">tea5764_i2c_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tea5764_i2c_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">tea5764_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">tea5764_i2c_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRIVER_VERSION</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">use_xtal</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_xtal</span><span class="p">,</span> <span class="s">&quot;Chip have a xtal connected in board&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span> <span class="s">&quot;video4linux device number to use&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
