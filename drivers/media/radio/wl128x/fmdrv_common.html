<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › radio › wl128x › fmdrv_common.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>fmdrv_common.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  FM Driver for Connectivity chip of Texas Instruments.</span>
<span class="cm"> *</span>
<span class="cm"> *  This sub-module of FM driver is common for FM RX and TX</span>
<span class="cm"> *  functionality. This module is responsible for:</span>
<span class="cm"> *  1) Forming group of Channel-8 commands to perform particular</span>
<span class="cm"> *     functionality (eg., frequency set require more than</span>
<span class="cm"> *     one Channel-8 command to be sent to the chip).</span>
<span class="cm"> *  2) Sending each Channel-8 command to the chip and reading</span>
<span class="cm"> *     response back over Shared Transport.</span>
<span class="cm"> *  3) Managing TX and RX Queues and Tasklets.</span>
<span class="cm"> *  4) Handling FM Interrupt packet and taking appropriate action.</span>
<span class="cm"> *  5) Loading FM firmware to the chip (common, FM TX, and FM RX</span>
<span class="cm"> *     firmware files based on mode selection)</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2011 Texas Instruments</span>
<span class="cm"> *  Author: Raja Mani &lt;raja_mani@ti.com&gt;</span>
<span class="cm"> *  Author: Manjunatha Halli &lt;manjunatha_halli@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> *  published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &quot;fmdrv.h&quot;</span>
<span class="cp">#include &quot;fmdrv_v4l2.h&quot;</span>
<span class="cp">#include &quot;fmdrv_common.h&quot;</span>
<span class="cp">#include &lt;linux/ti_wilink_st.h&gt;</span>
<span class="cp">#include &quot;fmdrv_rx.h&quot;</span>
<span class="cp">#include &quot;fmdrv_tx.h&quot;</span>

<span class="cm">/* Region info */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">region_info</span> <span class="n">region_configs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Europe/US */</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">chanl_space</span> <span class="o">=</span> <span class="n">FM_CHANNEL_SPACING_200KHZ</span> <span class="o">*</span> <span class="n">FM_FREQ_MUL</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bot_freq</span> <span class="o">=</span> <span class="mi">87500</span><span class="p">,</span>	<span class="cm">/* 87.5 MHz */</span>
	 <span class="p">.</span><span class="n">top_freq</span> <span class="o">=</span> <span class="mi">108000</span><span class="p">,</span>	<span class="cm">/* 108 MHz */</span>
	 <span class="p">.</span><span class="n">fm_band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="cm">/* Japan */</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">chanl_space</span> <span class="o">=</span> <span class="n">FM_CHANNEL_SPACING_200KHZ</span> <span class="o">*</span> <span class="n">FM_FREQ_MUL</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bot_freq</span> <span class="o">=</span> <span class="mi">76000</span><span class="p">,</span>	<span class="cm">/* 76 MHz */</span>
	 <span class="p">.</span><span class="n">top_freq</span> <span class="o">=</span> <span class="mi">90000</span><span class="p">,</span>	<span class="cm">/* 90 MHz */</span>
	 <span class="p">.</span><span class="n">fm_band</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Band selection */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">default_radio_region</span><span class="p">;</span>	<span class="cm">/* Europe/US */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">default_radio_region</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">default_radio_region</span><span class="p">,</span> <span class="s">&quot;Region: 0=Europe/US, 1=Japan&quot;</span><span class="p">);</span>

<span class="cm">/* RDS buffer blocks */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">default_rds_buf</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">default_rds_buf</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rds_buf</span><span class="p">,</span> <span class="s">&quot;RDS buffer entries&quot;</span><span class="p">);</span>

<span class="cm">/* Radio Nr */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">radio_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span> <span class="s">&quot;Radio Nr&quot;</span><span class="p">);</span>

<span class="cm">/* FM irq handlers forward declaration */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_send_flag_getcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_flag_getcmd_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_hw_malfunction</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_rds_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_send_rdsdata_getcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_rdsdata_getcmd_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_rds_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_tune_op_ended</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_power_enb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_low_rssi_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_afjump_set_pi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_set_pi_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_afjump_set_pimask</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_set_pimask_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_afjump_setfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_setfreq_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_afjump_enableint</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_afjump_enableint_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_start_afjump</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_start_afjump_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_afjump_rd_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_afjump_rd_freq_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_low_rssi_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_send_intmsk_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fm_irq_handle_intmsk_cmd_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * When FM common module receives interrupt packet, following handlers</span>
<span class="cm"> * will be executed one after another to service the interrupt(s)</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">fmc_irq_handler_index</span> <span class="p">{</span>
	<span class="n">FM_SEND_FLAG_GETCMD_IDX</span><span class="p">,</span>
	<span class="n">FM_HANDLE_FLAG_GETCMD_RESP_IDX</span><span class="p">,</span>

	<span class="cm">/* HW malfunction irq handler */</span>
	<span class="n">FM_HW_MAL_FUNC_IDX</span><span class="p">,</span>

	<span class="cm">/* RDS threshold reached irq handler */</span>
	<span class="n">FM_RDS_START_IDX</span><span class="p">,</span>
	<span class="n">FM_RDS_SEND_RDS_GETCMD_IDX</span><span class="p">,</span>
	<span class="n">FM_RDS_HANDLE_RDS_GETCMD_RESP_IDX</span><span class="p">,</span>
	<span class="n">FM_RDS_FINISH_IDX</span><span class="p">,</span>

	<span class="cm">/* Tune operation ended irq handler */</span>
	<span class="n">FM_HW_TUNE_OP_ENDED_IDX</span><span class="p">,</span>

	<span class="cm">/* TX power enable irq handler */</span>
	<span class="n">FM_HW_POWER_ENB_IDX</span><span class="p">,</span>

	<span class="cm">/* Low RSSI irq handler */</span>
	<span class="n">FM_LOW_RSSI_START_IDX</span><span class="p">,</span>
	<span class="n">FM_AF_JUMP_SETPI_IDX</span><span class="p">,</span>
	<span class="n">FM_AF_JUMP_HANDLE_SETPI_RESP_IDX</span><span class="p">,</span>
	<span class="n">FM_AF_JUMP_SETPI_MASK_IDX</span><span class="p">,</span>
	<span class="n">FM_AF_JUMP_HANDLE_SETPI_MASK_RESP_IDX</span><span class="p">,</span>
	<span class="n">FM_AF_JUMP_SET_AF_FREQ_IDX</span><span class="p">,</span>
	<span class="n">FM_AF_JUMP_HANDLE_SET_AFFREQ_RESP_IDX</span><span class="p">,</span>
	<span class="n">FM_AF_JUMP_ENABLE_INT_IDX</span><span class="p">,</span>
	<span class="n">FM_AF_JUMP_ENABLE_INT_RESP_IDX</span><span class="p">,</span>
	<span class="n">FM_AF_JUMP_START_AFJUMP_IDX</span><span class="p">,</span>
	<span class="n">FM_AF_JUMP_HANDLE_START_AFJUMP_RESP_IDX</span><span class="p">,</span>
	<span class="n">FM_AF_JUMP_RD_FREQ_IDX</span><span class="p">,</span>
	<span class="n">FM_AF_JUMP_RD_FREQ_RESP_IDX</span><span class="p">,</span>
	<span class="n">FM_LOW_RSSI_FINISH_IDX</span><span class="p">,</span>

	<span class="cm">/* Interrupt process post action */</span>
	<span class="n">FM_SEND_INTMSK_CMD_IDX</span><span class="p">,</span>
	<span class="n">FM_HANDLE_INTMSK_CMD_RESP_IDX</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* FM interrupt handler table */</span>
<span class="k">static</span> <span class="n">int_handler_prototype</span> <span class="n">int_handler_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">fm_irq_send_flag_getcmd</span><span class="p">,</span>
	<span class="n">fm_irq_handle_flag_getcmd_resp</span><span class="p">,</span>
	<span class="n">fm_irq_handle_hw_malfunction</span><span class="p">,</span>
	<span class="n">fm_irq_handle_rds_start</span><span class="p">,</span> <span class="cm">/* RDS threshold reached irq handler */</span>
	<span class="n">fm_irq_send_rdsdata_getcmd</span><span class="p">,</span>
	<span class="n">fm_irq_handle_rdsdata_getcmd_resp</span><span class="p">,</span>
	<span class="n">fm_irq_handle_rds_finish</span><span class="p">,</span>
	<span class="n">fm_irq_handle_tune_op_ended</span><span class="p">,</span>
	<span class="n">fm_irq_handle_power_enb</span><span class="p">,</span> <span class="cm">/* TX power enable irq handler */</span>
	<span class="n">fm_irq_handle_low_rssi_start</span><span class="p">,</span>
	<span class="n">fm_irq_afjump_set_pi</span><span class="p">,</span>
	<span class="n">fm_irq_handle_set_pi_resp</span><span class="p">,</span>
	<span class="n">fm_irq_afjump_set_pimask</span><span class="p">,</span>
	<span class="n">fm_irq_handle_set_pimask_resp</span><span class="p">,</span>
	<span class="n">fm_irq_afjump_setfreq</span><span class="p">,</span>
	<span class="n">fm_irq_handle_setfreq_resp</span><span class="p">,</span>
	<span class="n">fm_irq_afjump_enableint</span><span class="p">,</span>
	<span class="n">fm_irq_afjump_enableint_resp</span><span class="p">,</span>
	<span class="n">fm_irq_start_afjump</span><span class="p">,</span>
	<span class="n">fm_irq_handle_start_afjump_resp</span><span class="p">,</span>
	<span class="n">fm_irq_afjump_rd_freq</span><span class="p">,</span>
	<span class="n">fm_irq_afjump_rd_freq_resp</span><span class="p">,</span>
	<span class="n">fm_irq_handle_low_rssi_finish</span><span class="p">,</span>
	<span class="n">fm_irq_send_intmsk_cmd</span><span class="p">,</span> <span class="cm">/* Interrupt process post action */</span>
	<span class="n">fm_irq_handle_intmsk_cmd_resp</span>
<span class="p">};</span>

<span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">g_st_write</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">completion</span> <span class="n">wait_for_fmdrv_reg_comp</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fm_irq_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span><span class="p">](</span><span class="n">fmdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Continue next function in interrupt handler table */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fm_irq_call_stage</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">stage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">stage</span><span class="p">;</span>
	<span class="n">fm_irq_call</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fm_irq_timeout_stage</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">stage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">stage</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">FM_DRV_TX_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef FM_DUMP_TXRX_PKT</span>
 <span class="cm">/* To dump outgoing FM Channel-8 packets */</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dump_tx_skb_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">len_org</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fm_cmd_msg_hdr</span> <span class="o">*</span><span class="n">cmd_hdr</span><span class="p">;</span>

	<span class="n">cmd_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fm_cmd_msg_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;&lt;&lt;%shdr:%02x len:%02x opcode:%02x type:%s dlen:%02x&quot;</span><span class="p">,</span>
	       <span class="n">fm_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">completion</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">cmd_hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span>
	       <span class="n">cmd_hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cmd_hdr</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span>
	       <span class="n">cmd_hdr</span><span class="o">-&gt;</span><span class="n">rd_wr</span> <span class="o">?</span> <span class="s">&quot;RD&quot;</span> <span class="o">:</span> <span class="s">&quot;WR&quot;</span><span class="p">,</span> <span class="n">cmd_hdr</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">);</span>

	<span class="n">len_org</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">FM_CMD_MSG_HDR_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len_org</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">   data(%d): &quot;</span><span class="p">,</span> <span class="n">cmd_hdr</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len_org</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%x &quot;</span><span class="p">,</span>
			       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">FM_CMD_MSG_HDR_SIZE</span> <span class="o">+</span> <span class="n">index</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">len_org</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;..&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

 <span class="cm">/* To dump incoming FM Channel-8 packets */</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dump_rx_skb_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">len_org</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fm_event_msg_hdr</span> <span class="o">*</span><span class="n">evt_hdr</span><span class="p">;</span>

	<span class="n">evt_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fm_event_msg_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;&gt;&gt; hdr:%02x len:%02x sts:%02x numhci:%02x &quot;</span>
	    <span class="s">&quot;opcode:%02x type:%s dlen:%02x&quot;</span><span class="p">,</span> <span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
	    <span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">num_fm_hci_cmds</span><span class="p">,</span> <span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">rd_wr</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RD&quot;</span> <span class="o">:</span> <span class="s">&quot;WR&quot;</span><span class="p">,</span> <span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">);</span>

	<span class="n">len_org</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">FM_EVT_MSG_HDR_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len_org</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">   data(%d): &quot;</span><span class="p">,</span> <span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len_org</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%x &quot;</span><span class="p">,</span>
			       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">FM_EVT_MSG_HDR_SIZE</span> <span class="o">+</span> <span class="n">index</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">len_org</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;..&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">fmc_update_region_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">region_to_set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region_configs</span><span class="p">[</span><span class="n">region_to_set</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FM common sub-module will schedule this tasklet whenever it receives</span>
<span class="cm"> * FM packet from ST driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">recv_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fm_irq</span> <span class="o">*</span><span class="n">irq_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fm_event_msg_hdr</span> <span class="o">*</span><span class="n">evt_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_fm_hci_cmds</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">fmdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">irq_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">;</span>
	<span class="cm">/* Process all packets in the RX queue */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx_q</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fm_event_msg_hdr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;skb(%p) has only %d bytes, &quot;</span>
				<span class="s">&quot;at least need %zu bytes to decode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fm_event_msg_hdr</span><span class="p">));</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">evt_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">num_fm_hci_cmds</span> <span class="o">=</span> <span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">num_fm_hci_cmds</span><span class="p">;</span>

		<span class="cm">/* FM interrupt packet? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">FM_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FM interrupt handler started already? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FM_INTTASK_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">FM_INTTASK_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">irq_info</span><span class="o">-&gt;</span><span class="n">stage</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Inval stage resetting to zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">irq_info</span><span class="o">-&gt;</span><span class="n">stage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/*</span>
<span class="cm">				 * Execute first function in interrupt handler</span>
<span class="cm">				 * table.</span>
<span class="cm">				 */</span>
				<span class="n">irq_info</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">irq_info</span><span class="o">-&gt;</span><span class="n">stage</span><span class="p">](</span><span class="n">fmdev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">FM_INTTASK_SCHEDULE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Anyone waiting for this with completion handler? */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">pre_op</span> <span class="o">&amp;&amp;</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_comp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">complete</span><span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_comp</span><span class="p">);</span>

			<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_comp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Is this for interrupt handler? */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">pre_op</span> <span class="o">&amp;&amp;</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_comp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Response SKB ptr not NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="cm">/* Execute interrupt handler where state index points */</span>
			<span class="n">irq_info</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">irq_info</span><span class="o">-&gt;</span><span class="n">stage</span><span class="p">](</span><span class="n">fmdev</span><span class="p">);</span>

			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Nobody claimed SKB(%p),purging</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check flow control field. If Num_FM_HCI_Commands field is</span>
<span class="cm">		 * not zero, schedule FM TX tasklet.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_fm_hci_cmds</span> <span class="o">&amp;&amp;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">))</span>
				<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_task</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* FM send tasklet: is scheduled when FM packet has to be sent to chip */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">fmdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Check, is there any timeout happened to last transmitted packet */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">last_tx_jiffies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">FM_DRV_TX_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;TX timeout occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Send queued FM TX packets */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">);</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">pre_op</span> <span class="o">=</span> <span class="n">fm_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fm_op</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_comp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Response completion handler is not NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_comp</span> <span class="o">=</span> <span class="n">fm_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">;</span>

	<span class="cm">/* Write FM packet to ST driver */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">g_st_write</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_comp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;TX tasklet failed to send skb(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">last_tx_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Queues FM Channel-8 packet to FM TX queue and schedules FM TX tasklet for</span>
<span class="cm"> * transmission</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fm_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">fm_op</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">,</span>	<span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">wait_completion</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fm_cmd_msg_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fm_op</span> <span class="o">&gt;=</span> <span class="n">FM_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Invalid fm opcode - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fm_op</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FM_FW_DW_INPROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">payload</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Payload data is NULL during fw download</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FM_FW_DW_INPROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">=</span>
		    <span class="n">FM_CMD_MSG_HDR_SIZE</span> <span class="o">+</span> <span class="p">((</span><span class="n">payload</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">payload_len</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;No memory to create new SKB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t fill FM header info for the commands which come from</span>
<span class="cm">	 * FM firmware file.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FM_FW_DW_INPROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">FM_INTTASK_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Fill command header info */</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fm_cmd_msg_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">FM_CMD_MSG_HDR_SIZE</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">FM_PKT_LOGICAL_CHAN_NUMBER</span><span class="p">;</span>	<span class="cm">/* 0x08 */</span>

		<span class="cm">/* 3 (fm_opcode,rd_wr,dlen) + payload len) */</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">payload</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">payload_len</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>

		<span class="cm">/* FM opcode */</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">fm_op</span><span class="p">;</span>

		<span class="cm">/* read/write type */</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">rd_wr</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dlen</span> <span class="o">=</span> <span class="n">payload_len</span><span class="p">;</span>
		<span class="n">fm_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fm_op</span> <span class="o">=</span> <span class="n">fm_op</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If firmware download has finished and the command is</span>
<span class="cm">		 * not a read command then payload is != NULL - a write</span>
<span class="cm">		 * command with u16 payload - convert to be16</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">payload</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">payload</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">payload</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">payload</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fm_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fm_op</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">payload</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">payload</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">),</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>

	<span class="n">fm_cb</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">completion</span> <span class="o">=</span> <span class="n">wait_completion</span><span class="p">;</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_task</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Sends FM Channel-8 command to the chip and waits for the response */</span>
<span class="kt">int</span> <span class="nf">fmc_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">fm_op</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">response_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fm_event_msg_hdr</span> <span class="o">*</span><span class="n">evt_hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">maintask_comp</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fm_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">fm_op</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">maintask_comp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">maintask_comp</span><span class="p">,</span>
					 <span class="n">FM_DRV_TX_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Timeout(%d sec),didn&#39;t get reg&quot;</span>
			   <span class="s">&quot;completion signal from RX tasklet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">FM_DRV_TX_TIMEOUT</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Response SKB is missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">evt_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Received event pkt status(%d) is not zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Send response data to caller */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">response_len</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Skip header info and copy only response data */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fm_event_msg_hdr</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">);</span>
		<span class="o">*</span><span class="n">response_len</span> <span class="o">=</span> <span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">response_len</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">evt_hdr</span><span class="o">-&gt;</span><span class="n">dlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">response_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --- Helper functions used in FM interrupt handlers ---*/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">check_cmdresp_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fm_event_msg_hdr</span> <span class="o">*</span><span class="n">fm_evt_hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">fm_evt_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fm_evt_hdr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;irq: opcode %x response status is not zero &quot;</span>
				<span class="s">&quot;Initiating irq recovery process</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fm_evt_hdr</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">);</span>

		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">FM_DRV_TX_TIMEOUT</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fm_irq_common_cmd_resp_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">stage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_cmdresp_status</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">fm_irq_call_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">stage</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt process timeout handler.</span>
<span class="cm"> * One of the irq handler did not get proper response from the chip. So take</span>
<span class="cm"> * recovery action here. FM interrupts are disabled in the beginning of</span>
<span class="cm"> * interrupt process. Therefore reset stage index to re-enable default</span>
<span class="cm"> * interrupts. So that next interrupt will be processed as usual.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">int_timeout_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fm_irq</span> <span class="o">*</span><span class="n">fmirq</span><span class="p">;</span>

	<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;irq: timeout,trying to re-enable fm interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">fmdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fmirq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">;</span>
	<span class="n">fmirq</span><span class="o">-&gt;</span><span class="n">retry</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmirq</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">&gt;</span> <span class="n">FM_IRQ_TIMEOUT_RETRY_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Stop recovery action (interrupt reenable process) and</span>
<span class="cm">		 * reset stage index &amp; retry count values */</span>
		<span class="n">fmirq</span><span class="o">-&gt;</span><span class="n">stage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fmirq</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Recovery action failed during&quot;</span>
				<span class="s">&quot;irq processing, max retry reached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fm_irq_call_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_SEND_INTMSK_CMD_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------- FM interrupt handlers ------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_send_flag_getcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">flag</span><span class="p">;</span>

	<span class="cm">/* Send FLAG_GET command , to know the source of interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fm_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FLAG_GET</span><span class="p">,</span> <span class="n">REG_RD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">fm_irq_timeout_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_HANDLE_FLAG_GETCMD_RESP_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_flag_getcmd_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fm_event_msg_hdr</span> <span class="o">*</span><span class="n">fm_evt_hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_cmdresp_status</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fm_evt_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Skip header info and copy only response data */</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fm_event_msg_hdr</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">flag</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fm_evt_hdr</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">);</span>

	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
	<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;irq: flag register(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>

	<span class="cm">/* Continue next function in interrupt handler table */</span>
	<span class="n">fm_irq_call_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_HW_MAL_FUNC_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_hw_malfunction</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">FM_MAL_EVENT</span> <span class="o">&amp;</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">mask</span><span class="p">)</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;irq: HW MAL int received - do nothing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Continue next function in interrupt handler table */</span>
	<span class="n">fm_irq_call_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_RDS_START_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_rds_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">FM_RDS_EVENT</span> <span class="o">&amp;</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;irq: rds threshold reached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">FM_RDS_SEND_RDS_GETCMD_IDX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Continue next function in interrupt handler table */</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">FM_HW_TUNE_OP_ENDED_IDX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fm_irq_call</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_send_rdsdata_getcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Send the command to read RDS data from the chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fm_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">RDS_DATA_GET</span><span class="p">,</span> <span class="n">REG_RD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">FM_RX_RDS_FIFO_THRESHOLD</span> <span class="o">*</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">fm_irq_timeout_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_RDS_HANDLE_RDS_GETCMD_RESP_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Keeps track of current RX channel AF (Alternate Frequency) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_rx_update_af_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">af</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tuned_station_info</span> <span class="o">*</span><span class="n">stat_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">stat_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">fm_band</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>

	<span class="cm">/* First AF indicates the number of AF follows. Reset the list */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">af</span> <span class="o">&gt;=</span> <span class="n">FM_RDS_1_AF_FOLLOWS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">af</span> <span class="o">&lt;=</span> <span class="n">FM_RDS_25_AF_FOLLOWS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">stat_info</span><span class="p">.</span><span class="n">af_list_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">af</span> <span class="o">-</span> <span class="n">FM_RDS_1_AF_FOLLOWS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">stat_info</span><span class="p">.</span><span class="n">afcache_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;No of expected AF : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">stat_info</span><span class="p">.</span><span class="n">af_list_max</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">af</span> <span class="o">&lt;</span> <span class="n">FM_RDS_MIN_AF</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_idx</span> <span class="o">==</span> <span class="n">FM_BAND_EUROPE_US</span> <span class="o">&amp;&amp;</span> <span class="n">af</span> <span class="o">&gt;</span> <span class="n">FM_RDS_MAX_AF</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_idx</span> <span class="o">==</span> <span class="n">FM_BAND_JAPAN</span> <span class="o">&amp;&amp;</span> <span class="n">af</span> <span class="o">&gt;</span> <span class="n">FM_RDS_MAX_AF_JAPAN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">bot_freq</span> <span class="o">+</span> <span class="p">(</span><span class="n">af</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">==</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Current freq(%d) is matching with received AF(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Do check in AF cache */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">stat_info</span><span class="o">-&gt;</span><span class="n">afcache_size</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat_info</span><span class="o">-&gt;</span><span class="n">af_cache</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">freq</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Reached the limit of the list - ignore the next AF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">stat_info</span><span class="o">-&gt;</span><span class="n">af_list_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;AF cache is full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we reached the end of the list then this AF is not</span>
<span class="cm">	 * in the list - add it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">stat_info</span><span class="o">-&gt;</span><span class="n">afcache_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Storing AF %d to cache index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">stat_info</span><span class="o">-&gt;</span><span class="n">af_cache</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">stat_info</span><span class="o">-&gt;</span><span class="n">afcache_size</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Converts RDS buffer data from big endian format</span>
<span class="cm"> * to little endian format.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_rdsparse_swapbytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fm_rdsdata_format</span> <span class="o">*</span><span class="n">rds_format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">byte1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rds_buff</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since in Orca the 2 RDS Data bytes are in little endian and</span>
<span class="cm">	 * in Dolphin they are in big endian, the parsing of the RDS data</span>
<span class="cm">	 * is chip dependent</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">asci_id</span> <span class="o">!=</span> <span class="mh">0x6350</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rds_buff</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rds_format</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">groupdatabuff</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">FM_RX_RDS_INFO_FIELD_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">byte1</span> <span class="o">=</span> <span class="n">rds_buff</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="n">rds_buff</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rds_buff</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">rds_buff</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">byte1</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_rdsdata_getcmd_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fm_rdsdata_format</span> <span class="n">rds_fmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fm_rds</span> <span class="o">*</span><span class="n">rds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">group_idx</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rds_data</span><span class="p">,</span> <span class="n">meta_data</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">blk_idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cur_picode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rds_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_cmdresp_status</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Skip header info */</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fm_event_msg_hdr</span><span class="p">));</span>
	<span class="n">rds_data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">rds_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Parse the RDS data */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rds_len</span> <span class="o">&gt;=</span> <span class="n">FM_RDS_BLK_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">meta_data</span> <span class="o">=</span> <span class="n">rds_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="cm">/* Get the type: 0=A, 1=B, 2=C, 3=C&#39;, 4=D, 5=E */</span>
		<span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">meta_data</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>

		<span class="cm">/* Transform the blk type into index sequence (0, 1, 2, 3, 4) */</span>
		<span class="n">blk_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;=</span> <span class="n">FM_RDS_BLOCK_C</span> <span class="o">?</span> <span class="n">type</span> <span class="o">:</span> <span class="p">(</span><span class="n">type</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Block index:%d(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blk_idx</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">meta_data</span> <span class="o">&amp;</span> <span class="n">FM_RDS_STATUS_ERR_MASK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Bad&quot;</span> <span class="o">:</span> <span class="s">&quot;Ok&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">meta_data</span> <span class="o">&amp;</span> <span class="n">FM_RDS_STATUS_ERR_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blk_idx</span> <span class="o">&lt;</span> <span class="n">FM_RDS_BLK_IDX_A</span> <span class="o">||</span> <span class="n">blk_idx</span> <span class="o">&gt;</span> <span class="n">FM_RDS_BLK_IDX_D</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Block sequence mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rds</span><span class="o">-&gt;</span><span class="n">last_blk_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Skip checkword (control) byte and copy only data byte */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rds_fmt</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">groupdatabuff</span><span class="p">.</span>
				<span class="n">buff</span><span class="p">[</span><span class="n">blk_idx</span> <span class="o">*</span> <span class="p">(</span><span class="n">FM_RDS_BLK_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)],</span>
				<span class="n">rds_data</span><span class="p">,</span> <span class="p">(</span><span class="n">FM_RDS_BLK_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

		<span class="n">rds</span><span class="o">-&gt;</span><span class="n">last_blk_idx</span> <span class="o">=</span> <span class="n">blk_idx</span><span class="p">;</span>

		<span class="cm">/* If completed a whole group then handle it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk_idx</span> <span class="o">==</span> <span class="n">FM_RDS_BLK_IDX_D</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Good block received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fm_rdsparse_swapbytes</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rds_fmt</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Extract PI code and store in local cache.</span>
<span class="cm">			 * We need this during AF switch processing.</span>
<span class="cm">			 */</span>
			<span class="n">cur_picode</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rds_fmt</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">groupgeneral</span><span class="p">.</span><span class="n">pidata</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">stat_info</span><span class="p">.</span><span class="n">picode</span> <span class="o">!=</span> <span class="n">cur_picode</span><span class="p">)</span>
				<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">stat_info</span><span class="p">.</span><span class="n">picode</span> <span class="o">=</span> <span class="n">cur_picode</span><span class="p">;</span>

			<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;picode:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_picode</span><span class="p">);</span>

			<span class="n">group_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rds_fmt</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">groupgeneral</span><span class="p">.</span><span class="n">blk_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;(fmdrv):Group:%ld%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">group_idx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
					<span class="p">(</span><span class="n">group_idx</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;B&quot;</span> <span class="o">:</span> <span class="s">&quot;A&quot;</span><span class="p">);</span>

			<span class="n">group_idx</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">rds_fmt</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">groupgeneral</span><span class="p">.</span><span class="n">blk_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">group_idx</span> <span class="o">==</span> <span class="n">FM_RDS_GROUP_TYPE_MASK_0A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fm_rx_update_af_cache</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">rds_fmt</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">group0A</span><span class="p">.</span><span class="n">af</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">fm_rx_update_af_cache</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">rds_fmt</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">group0A</span><span class="p">.</span><span class="n">af</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rds_len</span> <span class="o">-=</span> <span class="n">FM_RDS_BLK_SIZE</span><span class="p">;</span>
		<span class="n">rds_data</span> <span class="o">+=</span> <span class="n">FM_RDS_BLK_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy raw rds data to internal rds buffer */</span>
	<span class="n">rds_data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">rds_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rds_buff_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rds_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Fill RDS buffer as per V4L2 specification.</span>
<span class="cm">		 * Store control byte</span>
<span class="cm">		 */</span>
		<span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">rds_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>
		<span class="n">blk_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;=</span> <span class="n">FM_RDS_BLOCK_C</span> <span class="o">?</span> <span class="n">type</span> <span class="o">:</span> <span class="p">(</span><span class="n">type</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">tmpbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">blk_idx</span><span class="p">;</span>	<span class="cm">/* Offset name */</span>
		<span class="n">tmpbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">blk_idx</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* Received offset */</span>

		<span class="cm">/* Store data byte */</span>
		<span class="n">tmpbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rds_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">tmpbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rds_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rds</span><span class="o">-&gt;</span><span class="n">buff</span><span class="p">[</span><span class="n">rds</span><span class="o">-&gt;</span><span class="n">wr_idx</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">tmpbuf</span><span class="p">,</span> <span class="n">FM_RDS_BLK_SIZE</span><span class="p">);</span>
		<span class="n">rds</span><span class="o">-&gt;</span><span class="n">wr_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rds</span><span class="o">-&gt;</span><span class="n">wr_idx</span> <span class="o">+</span> <span class="n">FM_RDS_BLK_SIZE</span><span class="p">)</span> <span class="o">%</span> <span class="n">rds</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>

		<span class="cm">/* Check for overflow &amp; start over */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rds</span><span class="o">-&gt;</span><span class="n">wr_idx</span> <span class="o">==</span> <span class="n">rds</span><span class="o">-&gt;</span><span class="n">rd_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;RDS buffer overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rds</span><span class="o">-&gt;</span><span class="n">wr_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rds</span><span class="o">-&gt;</span><span class="n">rd_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rds_len</span> <span class="o">-=</span> <span class="n">FM_RDS_BLK_SIZE</span><span class="p">;</span>
		<span class="n">rds_data</span> <span class="o">+=</span> <span class="n">FM_RDS_BLK_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rds_buff_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Wakeup read queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rds</span><span class="o">-&gt;</span><span class="n">wr_idx</span> <span class="o">!=</span> <span class="n">rds</span><span class="o">-&gt;</span><span class="n">rd_idx</span><span class="p">)</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rds</span><span class="o">-&gt;</span><span class="n">read_queue</span><span class="p">);</span>

	<span class="n">fm_irq_call_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_RDS_FINISH_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_rds_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fm_irq_call_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_HW_TUNE_OP_ENDED_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_tune_op_ended</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FM_FR_EVENT</span> <span class="o">|</span> <span class="n">FM_BL_EVENT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fmdev</span><span class="o">-&gt;</span>
	    <span class="n">irq_info</span><span class="p">.</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;irq: tune ended/bandlimit reached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FM_AF_SWITCH_INPROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">FM_AF_JUMP_RD_FREQ_IDX</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">maintask_comp</span><span class="p">);</span>
			<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">FM_HW_POWER_ENB_IDX</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">FM_HW_POWER_ENB_IDX</span><span class="p">;</span>

	<span class="n">fm_irq_call</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_power_enb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">FM_POW_ENB_EVENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;irq: Power Enabled/Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">maintask_comp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fm_irq_call_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_LOW_RSSI_START_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_low_rssi_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">af_mode</span> <span class="o">==</span> <span class="n">FM_RX_RDS_AF_SWITCH_MODE_ON</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">FM_LEV_EVENT</span> <span class="o">&amp;</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">mask</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">freq</span> <span class="o">!=</span> <span class="n">FM_UNDEFINED_FREQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">stat_info</span><span class="p">.</span><span class="n">afcache_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;irq: rssi level has fallen below threshold level</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Disable further low RSSI interrupts */</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FM_LEV_EVENT</span><span class="p">;</span>

		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">afjump_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">freq_before_jump</span> <span class="o">=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">freq</span><span class="p">;</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">FM_AF_JUMP_SETPI_IDX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Continue next function in interrupt handler table */</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">FM_SEND_INTMSK_CMD_IDX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fm_irq_call</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_afjump_set_pi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">payload</span><span class="p">;</span>

	<span class="cm">/* Set PI code - must be updated if the AF list is not empty */</span>
	<span class="n">payload</span> <span class="o">=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">stat_info</span><span class="p">.</span><span class="n">picode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fm_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">RDS_PI_SET</span><span class="p">,</span> <span class="n">REG_WR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">fm_irq_timeout_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_AF_JUMP_HANDLE_SETPI_RESP_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_set_pi_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fm_irq_common_cmd_resp_helper</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_AF_JUMP_SETPI_MASK_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set PI mask.</span>
<span class="cm"> * 0xFFFF = Enable PI code matching</span>
<span class="cm"> * 0x0000 = Disable PI code matching</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_afjump_set_pimask</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">payload</span><span class="p">;</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fm_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">RDS_PI_MASK_SET</span><span class="p">,</span> <span class="n">REG_WR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">fm_irq_timeout_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_AF_JUMP_HANDLE_SETPI_MASK_RESP_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_set_pimask_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fm_irq_common_cmd_resp_helper</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_AF_JUMP_SET_AF_FREQ_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_afjump_setfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">frq_index</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">payload</span><span class="p">;</span>

	<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Swtich to %d KHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">stat_info</span><span class="p">.</span><span class="n">af_cache</span><span class="p">[</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">afjump_idx</span><span class="p">]);</span>
	<span class="n">frq_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">stat_info</span><span class="p">.</span><span class="n">af_cache</span><span class="p">[</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">afjump_idx</span><span class="p">]</span> <span class="o">-</span>
	     <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">bot_freq</span><span class="p">)</span> <span class="o">/</span> <span class="n">FM_FREQ_MUL</span><span class="p">;</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="n">frq_index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fm_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">AF_FREQ_SET</span><span class="p">,</span> <span class="n">REG_WR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">fm_irq_timeout_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_AF_JUMP_HANDLE_SET_AFFREQ_RESP_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_setfreq_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fm_irq_common_cmd_resp_helper</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_AF_JUMP_ENABLE_INT_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_afjump_enableint</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">payload</span><span class="p">;</span>

	<span class="cm">/* Enable FR (tuning operation ended) interrupt */</span>
	<span class="n">payload</span> <span class="o">=</span> <span class="n">FM_FR_EVENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fm_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">INT_MASK_SET</span><span class="p">,</span> <span class="n">REG_WR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">fm_irq_timeout_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_AF_JUMP_ENABLE_INT_RESP_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_afjump_enableint_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fm_irq_common_cmd_resp_helper</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_AF_JUMP_START_AFJUMP_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_start_afjump</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">payload</span><span class="p">;</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="n">FM_TUNER_AF_JUMP_MODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fm_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">TUNER_MODE_SET</span><span class="p">,</span> <span class="n">REG_WR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">fm_irq_timeout_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_AF_JUMP_HANDLE_START_AFJUMP_RESP_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_start_afjump_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_cmdresp_status</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">FM_SEND_FLAG_GETCMD_IDX</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">FM_AF_SWITCH_INPROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">FM_INTTASK_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_afjump_rd_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">payload</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fm_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FREQ_SET</span><span class="p">,</span> <span class="n">REG_RD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">fm_irq_timeout_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_AF_JUMP_RD_FREQ_RESP_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_afjump_rd_freq_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">read_freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">curr_freq</span><span class="p">,</span> <span class="n">jumped_freq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_cmdresp_status</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Skip header info and copy only response data */</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fm_event_msg_hdr</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">read_freq</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">read_freq</span><span class="p">));</span>
	<span class="n">read_freq</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">read_freq</span><span class="p">);</span>
	<span class="n">curr_freq</span> <span class="o">=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">bot_freq</span> <span class="o">+</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">read_freq</span> <span class="o">*</span> <span class="n">FM_FREQ_MUL</span><span class="p">);</span>

	<span class="n">jumped_freq</span> <span class="o">=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">stat_info</span><span class="p">.</span><span class="n">af_cache</span><span class="p">[</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">afjump_idx</span><span class="p">];</span>

	<span class="cm">/* If the frequency was changed the jump succeeded */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">curr_freq</span> <span class="o">!=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">freq_before_jump</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">curr_freq</span> <span class="o">==</span> <span class="n">jumped_freq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Successfully switched to alternate freq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">curr_freq</span><span class="p">);</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">curr_freq</span><span class="p">;</span>
		<span class="n">fm_rx_reset_rds_cache</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>

		<span class="cm">/* AF feature is on, enable low level RSSI interrupt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">af_mode</span> <span class="o">==</span> <span class="n">FM_RX_RDS_AF_SWITCH_MODE_ON</span><span class="p">)</span>
			<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">FM_LEV_EVENT</span><span class="p">;</span>

		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">FM_LOW_RSSI_FINISH_IDX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* jump to the next freq in the AF list */</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">afjump_idx</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* If we reached the end of the list - stop searching */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">afjump_idx</span> <span class="o">&gt;=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">stat_info</span><span class="p">.</span><span class="n">afcache_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;AF switch processing failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">FM_LOW_RSSI_FINISH_IDX</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* AF List is not over - try next one */</span>

			<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Trying next freq in AF cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">FM_AF_JUMP_SETPI_IDX</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">fm_irq_call</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_low_rssi_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fm_irq_call_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_SEND_INTMSK_CMD_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_send_intmsk_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">payload</span><span class="p">;</span>

	<span class="cm">/* Re-enable FM interrupts */</span>
	<span class="n">payload</span> <span class="o">=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fm_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">INT_MASK_SET</span><span class="p">,</span> <span class="n">REG_WR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">fm_irq_timeout_stage</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_HANDLE_INTMSK_CMD_RESP_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_irq_handle_intmsk_cmd_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_cmdresp_status</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is last function in interrupt table to be executed.</span>
<span class="cm">	 * So, reset stage index to 0.</span>
<span class="cm">	 */</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">FM_SEND_FLAG_GETCMD_IDX</span><span class="p">;</span>

	<span class="cm">/* Start processing any pending interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FM_INTTASK_SCHEDULE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span><span class="p">](</span><span class="n">fmdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FM_INTTASK_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Returns availability of RDS data in internel buffer */</span>
<span class="kt">int</span> <span class="nf">fmc_is_rds_data_available</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">pts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">read_queue</span><span class="p">,</span> <span class="n">pts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">rd_idx</span> <span class="o">!=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">wr_idx</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Copies RDS data from internal buffer to user buffer */</span>
<span class="kt">int</span> <span class="nf">fmc_transfer_rds_from_internal_buff</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">block_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">wr_idx</span> <span class="o">==</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">rd_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">read_queue</span><span class="p">,</span>
				<span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">wr_idx</span> <span class="o">!=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">rd_idx</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate block count from byte count */</span>
	<span class="n">count</span> <span class="o">/=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">block_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rds_buff_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">block_count</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">wr_idx</span> <span class="o">==</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">rd_idx</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">rd_idx</span><span class="p">],</span>
					<span class="n">FM_RDS_BLK_SIZE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">rd_idx</span> <span class="o">+=</span> <span class="n">FM_RDS_BLK_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">rd_idx</span> <span class="o">&gt;=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">buf_size</span><span class="p">)</span>
			<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">rd_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">block_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">FM_RDS_BLK_SIZE</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">FM_RDS_BLK_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rds_buff_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fmc_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">freq_to_set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">curr_fmmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FM_MODE_RX</span>:
		<span class="k">return</span> <span class="n">fm_rx_set_freq</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">freq_to_set</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FM_MODE_TX</span>:
		<span class="k">return</span> <span class="n">fm_tx_set_freq</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">freq_to_set</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fmc_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">cur_tuned_frq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">freq</span> <span class="o">==</span> <span class="n">FM_UNDEFINED_FREQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;RX frequency is not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur_tuned_frq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Invalid memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">curr_fmmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FM_MODE_RX</span>:
		<span class="o">*</span><span class="n">cur_tuned_frq</span> <span class="o">=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">freq</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FM_MODE_TX</span>:
		<span class="o">*</span><span class="n">cur_tuned_frq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* TODO : Change this later */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fmc_set_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">region_to_set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">curr_fmmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FM_MODE_RX</span>:
		<span class="k">return</span> <span class="n">fm_rx_set_region</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">region_to_set</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FM_MODE_TX</span>:
		<span class="k">return</span> <span class="n">fm_tx_set_region</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">region_to_set</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fmc_set_mute_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mute_mode_toset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">curr_fmmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FM_MODE_RX</span>:
		<span class="k">return</span> <span class="n">fm_rx_set_mute_mode</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">mute_mode_toset</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FM_MODE_TX</span>:
		<span class="k">return</span> <span class="n">fm_tx_set_mute_mode</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">mute_mode_toset</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fmc_set_stereo_mono</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">curr_fmmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FM_MODE_RX</span>:
		<span class="k">return</span> <span class="n">fm_rx_set_stereo_mono</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FM_MODE_TX</span>:
		<span class="k">return</span> <span class="n">fm_tx_set_stereo_mono</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fmc_set_rds_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rds_en_dis</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">curr_fmmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FM_MODE_RX</span>:
		<span class="k">return</span> <span class="n">fm_rx_set_rds_mode</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">rds_en_dis</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FM_MODE_TX</span>:
		<span class="k">return</span> <span class="n">fm_tx_set_rds_mode</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">rds_en_dis</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Sends power off command to the chip */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fm_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">payload</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FM_CORE_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;FM core is not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">curr_fmmode</span> <span class="o">==</span> <span class="n">FM_MODE_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;FM chip is already in OFF state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fmc_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_POWER_MODE</span><span class="p">,</span> <span class="n">REG_WR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fmc_release</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Reads init command from FM firmware file and loads to the chip */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fm_download_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bts_header</span> <span class="o">*</span><span class="n">fw_header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="n">action</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bts_action_delay</span> <span class="o">*</span><span class="n">delay</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">fw_len</span><span class="p">,</span> <span class="n">cmd_cnt</span><span class="p">;</span>

	<span class="n">cmd_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">FM_FW_DW_INPROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Unable to read firmware(%s) content</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Firmware(%s) length : %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">fw_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fw_len</span> <span class="o">=</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="n">fw_header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bts_header</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_header</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">FM_FW_FILE_HEADER_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;%s not a legal TI firmware file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rel_fw</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;FW(%s) magic number : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">fw_header</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">);</span>

	<span class="cm">/* Skip file header info , we already verified it */</span>
	<span class="n">fw_data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bts_header</span><span class="p">);</span>
	<span class="n">fw_len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bts_header</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">fw_data</span> <span class="o">&amp;&amp;</span> <span class="n">fw_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">action</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_data</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ACTION_SEND_COMMAND</span>:	<span class="cm">/* Send */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fmc_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">action</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						<span class="n">action</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">rel_fw</span><span class="p">;</span>

			<span class="n">cmd_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ACTION_DELAY</span>:	<span class="cm">/* Delay */</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bts_action_delay</span> <span class="o">*</span><span class="p">)</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="n">delay</span><span class="o">-&gt;</span><span class="n">msec</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fw_data</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bts_action</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>
		<span class="n">fw_len</span> <span class="o">-=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bts_action</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Firmware commands(%d) loaded to chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd_cnt</span><span class="p">);</span>
<span class="nl">rel_fw:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">FM_FW_DW_INPROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Loads default RX configuration to the chip */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_default_rx_configuration</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fm_rx_set_volume</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_DEFAULT_RX_VOLUME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fm_rx_set_rssi_threshold</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_DEFAULT_RSSI_THRESHOLD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Does FM power on sequence */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fm_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">payload</span><span class="p">,</span> <span class="n">asic_id</span><span class="p">,</span> <span class="n">asic_ver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resp_len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fw_name</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;=</span> <span class="n">FM_MODE_ENTRY_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Invalid firmware download option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize FM common module. FM GPIO toggling is</span>
<span class="cm">	 * taken care in Shared Transport driver.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fmc_prepare</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Unable to prepare FM Common</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="n">FM_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmc_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">FM_POWER_MODE</span><span class="p">,</span> <span class="n">REG_WR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">rel</span><span class="p">;</span>

	<span class="cm">/* Allow the chip to settle down in Channel-8 mode */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmc_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">ASIC_ID_GET</span><span class="p">,</span> <span class="n">REG_RD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">asic_id</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">asic_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp_len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">rel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmc_send_cmd</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">ASIC_VER_GET</span><span class="p">,</span> <span class="n">REG_RD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">asic_ver</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">asic_ver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp_len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">rel</span><span class="p">;</span>

	<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;ASIC ID: 0x%x , ASIC Version: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">asic_id</span><span class="p">),</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">asic_ver</span><span class="p">));</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">fw_name</span><span class="p">,</span> <span class="s">&quot;%s_%x.%d.bts&quot;</span><span class="p">,</span> <span class="n">FM_FMC_FW_FILE_START</span><span class="p">,</span>
		<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">asic_id</span><span class="p">),</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">asic_ver</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fm_download_firmware</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Failed to download firmware file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">fw_name</span><span class="p">,</span> <span class="s">&quot;%s_%x.%d.bts&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FM_MODE_RX</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">FM_RX_FW_FILE_START</span> <span class="o">:</span> <span class="n">FM_TX_FW_FILE_START</span><span class="p">,</span>
			<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">asic_id</span><span class="p">),</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">asic_ver</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fm_download_firmware</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Failed to download firmware file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">rel:</span>
	<span class="k">return</span> <span class="n">fmc_release</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set FM Modes(TX, RX, OFF) */</span>
<span class="kt">int</span> <span class="nf">fmc_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">fm_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fm_mode</span> <span class="o">&gt;=</span> <span class="n">FM_MODE_ENTRY_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Invalid FM mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">curr_fmmode</span> <span class="o">==</span> <span class="n">fm_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Already fm is in mode(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fm_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fm_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FM_MODE_OFF</span>:	<span class="cm">/* OFF Mode */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fm_power_down</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Failed to set OFF mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FM_MODE_TX</span>:	<span class="cm">/* TX Mode */</span>
	<span class="k">case</span> <span class="n">FM_MODE_RX</span>:	<span class="cm">/* RX Mode */</span>
		<span class="cm">/* Power down before switching to TX or RX mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">curr_fmmode</span> <span class="o">!=</span> <span class="n">FM_MODE_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">fm_power_down</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Failed to set OFF mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fm_power_up</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">fm_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Failed to load firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">curr_fmmode</span> <span class="o">=</span> <span class="n">fm_mode</span><span class="p">;</span>

	<span class="cm">/* Set default configuration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">curr_fmmode</span> <span class="o">==</span> <span class="n">FM_MODE_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Loading default rx configuration..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">load_default_rx_configuration</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Failed to load default values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns current FM mode (TX, RX, OFF) */</span>
<span class="kt">int</span> <span class="nf">fmc_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">fmmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FM_CORE_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;FM core is not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmmode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Invalid memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">fmmode</span> <span class="o">=</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">curr_fmmode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called by ST layer when FM packet is available */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">fm_st_receive</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">;</span>

	<span class="n">fmdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Invalid SKB received from ST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">FM_PKT_LOGICAL_CHAN_NUMBER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Received SKB (%p) is not FM Channel 8 pkt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx_task</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by ST layer to indicate protocol registration completion</span>
<span class="cm"> * status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm_st_reg_comp_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">;</span>

	<span class="n">fmdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">streg_cbdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait_for_fmdrv_reg_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function will be called from FM V4L2 open function.</span>
<span class="cm"> * Register with ST driver and initialize driver data.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fmc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">st_proto_s</span> <span class="n">fm_st_proto</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FM_CORE_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;FM Core is already up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fm_st_proto</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fm_st_proto</span><span class="p">));</span>
	<span class="n">fm_st_proto</span><span class="p">.</span><span class="n">recv</span> <span class="o">=</span> <span class="n">fm_st_receive</span><span class="p">;</span>
	<span class="n">fm_st_proto</span><span class="p">.</span><span class="n">match_packet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fm_st_proto</span><span class="p">.</span><span class="n">reg_complete_cb</span> <span class="o">=</span> <span class="n">fm_st_reg_comp_cb</span><span class="p">;</span>
	<span class="n">fm_st_proto</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* TI ST driver will fill write pointer */</span>
	<span class="n">fm_st_proto</span><span class="p">.</span><span class="n">priv_data</span> <span class="o">=</span> <span class="n">fmdev</span><span class="p">;</span>
	<span class="n">fm_st_proto</span><span class="p">.</span><span class="n">chnl_id</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">fm_st_proto</span><span class="p">.</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">fm_st_proto</span><span class="p">.</span><span class="n">hdr_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fm_st_proto</span><span class="p">.</span><span class="n">offset_len_in_hdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fm_st_proto</span><span class="p">.</span><span class="n">len_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fm_st_proto</span><span class="p">.</span><span class="n">reserve</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">st_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fm_st_proto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait_for_fmdrv_reg_comp</span><span class="p">);</span>
		<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">streg_cbdata</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;%s waiting for ST reg completion signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait_for_fmdrv_reg_comp</span><span class="p">,</span>
						 <span class="n">FM_ST_REG_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Timeout(%d sec), didn&#39;t get reg &quot;</span>
					<span class="s">&quot;completion signal from ST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">FM_ST_REG_TIMEOUT</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">streg_cbdata</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;ST reg comp CB called with error &quot;</span>
					<span class="s">&quot;status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">streg_cbdata</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;st_register failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fm_st_proto</span><span class="p">.</span><span class="n">write</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">g_st_write</span> <span class="o">=</span> <span class="n">fm_st_proto</span><span class="p">.</span><span class="n">write</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Failed to get ST write func pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">st_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fm_st_proto</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;st_unregister failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rds_buff_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_skb_lock</span><span class="p">);</span>

	<span class="cm">/* Initialize TX queue and TX tasklet */</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_task</span><span class="p">,</span> <span class="n">send_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fmdev</span><span class="p">);</span>

	<span class="cm">/* Initialize RX Queue and RX tasklet */</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx_q</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx_task</span><span class="p">,</span> <span class="n">recv_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fmdev</span><span class="p">);</span>

	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_comp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">int_timeout_handler</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fmdev</span><span class="p">;</span>
	<span class="cm">/*TODO: add FM_STIC_EVENT later */</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">FM_MAL_EVENT</span><span class="p">;</span>

	<span class="cm">/* Region info */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">region</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region_configs</span><span class="p">[</span><span class="n">default_radio_region</span><span class="p">],</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">region_info</span><span class="p">));</span>

	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">mute_mode</span> <span class="o">=</span> <span class="n">FM_MUTE_OFF</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rf_depend_mute</span> <span class="o">=</span> <span class="n">FM_RX_RF_DEPENDENT_MUTE_OFF</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">FM_RDS_DISABLE</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">FM_UNDEFINED_FREQ</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds_mode</span> <span class="o">=</span> <span class="n">FM_RDS_SYSTEM_RDS</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">af_mode</span> <span class="o">=</span> <span class="n">FM_RX_RDS_AF_SWITCH_MODE_OFF</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fm_rx_reset_rds_cache</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">read_queue</span><span class="p">);</span>

	<span class="n">fm_rx_reset_station_info</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">FM_CORE_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function will be called from FM V4L2 release function.</span>
<span class="cm"> * Unregister from ST driver.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fmc_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">st_proto_s</span> <span class="n">fm_st_proto</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FM_CORE_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;FM Core is already down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Service pending read */</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">read_queue</span><span class="p">);</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_task</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx_task</span><span class="p">);</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_q</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx_q</span><span class="p">);</span>

	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">resp_comp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fm_st_proto</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fm_st_proto</span><span class="p">));</span>
	<span class="n">fm_st_proto</span><span class="p">.</span><span class="n">chnl_id</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">st_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fm_st_proto</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Failed to de-register FM from ST %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;Successfully unregistered from ST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">FM_CORE_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Module init function. Ask FM V4L module to register video device.</span>
<span class="cm"> * Allocate memory for FM driver context and RX RDS buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fm_drv_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">fmdbg</span><span class="p">(</span><span class="s">&quot;FM driver version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FM_DRV_VERSION</span><span class="p">);</span>

	<span class="n">fmdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fmdev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fmdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Can&#39;t allocate operation structure memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">default_rds_buf</span> <span class="o">*</span> <span class="n">FM_RDS_BLK_SIZE</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">buff</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">buff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmerr</span><span class="p">(</span><span class="s">&quot;Can&#39;t allocate rds ring buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fm_v4l2_init_video_device</span><span class="p">(</span><span class="n">fmdev</span><span class="p">,</span> <span class="n">radio_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rel_rdsbuf</span><span class="p">;</span>

	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">int_handler_table</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">curr_fmmode</span> <span class="o">=</span> <span class="n">FM_MODE_OFF</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">.</span><span class="n">pwr_lvl</span> <span class="o">=</span> <span class="n">FM_PWR_LVL_DEF</span><span class="p">;</span>
	<span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">.</span><span class="n">preemph</span> <span class="o">=</span> <span class="n">FM_TX_PREEMPH_50US</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">rel_rdsbuf:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">buff</span><span class="p">);</span>
<span class="nl">rel_dev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Module exit function. Ask FM V4L module to unregister video device */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">fm_drv_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fmdev</span> <span class="o">*</span><span class="n">fmdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">fmdev</span> <span class="o">=</span> <span class="n">fm_v4l2_deinit_video_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fmdev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">buff</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fmdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">fm_drv_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">fm_drv_exit</span><span class="p">);</span>

<span class="cm">/* ------------- Module Info ------------- */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Manjunatha Halli &lt;manjunatha_halli@ti.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;FM Driver for TI&#39;s Connectivity chip. &quot;</span> <span class="n">FM_DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">FM_DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
