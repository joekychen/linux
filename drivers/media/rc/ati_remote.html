<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › rc › ati_remote.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ati_remote.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  USB ATI Remote support</span>
<span class="cm"> *</span>
<span class="cm"> *                Copyright (c) 2011, 2012 Anssi Hannula &lt;anssi.hannula@iki.fi&gt;</span>
<span class="cm"> *  Version 2.2.0 Copyright (c) 2004 Torrey Hoffman &lt;thoffman@arnor.net&gt;</span>
<span class="cm"> *  Version 2.1.1 Copyright (c) 2002 Vladimir Dergachev</span>
<span class="cm"> *</span>
<span class="cm"> *  This 2.2.0 version is a rewrite / cleanup of the 2.1.1 driver, including</span>
<span class="cm"> *  porting to the 2.6 kernel interfaces, along with other modification</span>
<span class="cm"> *  to better match the style of the existing usb/input drivers.  However, the</span>
<span class="cm"> *  protocol and hardware handling is essentially unchanged from 2.1.1.</span>
<span class="cm"> *</span>
<span class="cm"> *  The 2.1.1 driver was derived from the usbati_remote and usbkbd drivers by</span>
<span class="cm"> *  Vojtech Pavlik.</span>
<span class="cm"> *</span>
<span class="cm"> *  Changes:</span>
<span class="cm"> *</span>
<span class="cm"> *  Feb 2004: Torrey Hoffman &lt;thoffman@arnor.net&gt;</span>
<span class="cm"> *            Version 2.2.0</span>
<span class="cm"> *  Jun 2004: Torrey Hoffman &lt;thoffman@arnor.net&gt;</span>
<span class="cm"> *            Version 2.2.1</span>
<span class="cm"> *            Added key repeat support contributed by:</span>
<span class="cm"> *                Vincent Vanackere &lt;vanackere@lif.univ-mrs.fr&gt;</span>
<span class="cm"> *            Added support for the &quot;Lola&quot; remote contributed by:</span>
<span class="cm"> *                Seth Cohn &lt;sethcohn@yahoo.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</span>
<span class="cm"> *</span>
<span class="cm"> * Hardware &amp; software notes</span>
<span class="cm"> *</span>
<span class="cm"> * These remote controls are distributed by ATI as part of their</span>
<span class="cm"> * &quot;All-In-Wonder&quot; video card packages.  The receiver self-identifies as a</span>
<span class="cm"> * &quot;USB Receiver&quot; with manufacturer &quot;X10 Wireless Technology Inc&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * The &quot;Lola&quot; remote is available from X10.  See:</span>
<span class="cm"> *    http://www.x10.com/products/lola_sg1.htm</span>
<span class="cm"> * The Lola is similar to the ATI remote but has no mouse support, and slightly</span>
<span class="cm"> * different keys.</span>
<span class="cm"> *</span>
<span class="cm"> * It is possible to use multiple receivers and remotes on multiple computers</span>
<span class="cm"> * simultaneously by configuring them to use specific channels.</span>
<span class="cm"> *</span>
<span class="cm"> * The RF protocol used by the remote supports 16 distinct channels, 1 to 16.</span>
<span class="cm"> * Actually, it may even support more, at least in some revisions of the</span>
<span class="cm"> * hardware.</span>
<span class="cm"> *</span>
<span class="cm"> * Each remote can be configured to transmit on one channel as follows:</span>
<span class="cm"> *   - Press and hold the &quot;hand icon&quot; button.</span>
<span class="cm"> *   - When the red LED starts to blink, let go of the &quot;hand icon&quot; button.</span>
<span class="cm"> *   - When it stops blinking, input the channel code as two digits, from 01</span>
<span class="cm"> *     to 16, and press the hand icon again.</span>
<span class="cm"> *</span>
<span class="cm"> * The timing can be a little tricky.  Try loading the module with debug=1</span>
<span class="cm"> * to have the kernel print out messages about the remote control number</span>
<span class="cm"> * and mask.  Note: debugging prints remote numbers as zero-based hexadecimal.</span>
<span class="cm"> *</span>
<span class="cm"> * The driver has a &quot;channel_mask&quot; parameter. This bitmask specifies which</span>
<span class="cm"> * channels will be ignored by the module.  To mask out channels, just add</span>
<span class="cm"> * all the 2^channel_number values together.</span>
<span class="cm"> *</span>
<span class="cm"> * For instance, set channel_mask = 2^4 = 16 (binary 10000) to make ati_remote</span>
<span class="cm"> * ignore signals coming from remote controls transmitting on channel 4, but</span>
<span class="cm"> * accept all other channels.</span>
<span class="cm"> *</span>
<span class="cm"> * Or, set channel_mask = 65533, (0xFFFD), and all channels except 1 will be</span>
<span class="cm"> * ignored.</span>
<span class="cm"> *</span>
<span class="cm"> * The default is 0 (respond to all channels). Bit 0 and bits 17-32 of this</span>
<span class="cm"> * parameter are unused.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/usb/input.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;media/rc-core.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Module and Version Information, Module Parameters</span>
<span class="cm"> */</span>

<span class="cp">#define ATI_REMOTE_VENDOR_ID		0x0bc7</span>
<span class="cp">#define LOLA_REMOTE_PRODUCT_ID		0x0002</span>
<span class="cp">#define LOLA2_REMOTE_PRODUCT_ID		0x0003</span>
<span class="cp">#define ATI_REMOTE_PRODUCT_ID		0x0004</span>
<span class="cp">#define NVIDIA_REMOTE_PRODUCT_ID	0x0005</span>
<span class="cp">#define MEDION_REMOTE_PRODUCT_ID	0x0006</span>
<span class="cp">#define FIREFLY_REMOTE_PRODUCT_ID	0x0008</span>

<span class="cp">#define DRIVER_VERSION		&quot;2.2.1&quot;</span>
<span class="cp">#define DRIVER_AUTHOR           &quot;Torrey Hoffman &lt;thoffman@arnor.net&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC             &quot;ATI/X10 RF USB Remote Control&quot;</span>

<span class="cp">#define NAME_BUFSIZE      80    </span><span class="cm">/* size of product name, path buffers */</span><span class="cp"></span>
<span class="cp">#define DATA_BUFSIZE      63    </span><span class="cm">/* size of URB data buffers */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Duplicate event filtering time.</span>
<span class="cm"> * Sequential, identical KIND_FILTERED inputs with less than</span>
<span class="cm"> * FILTER_TIME milliseconds between them are considered as repeat</span>
<span class="cm"> * events. The hardware generates 5 events for the first keypress</span>
<span class="cm"> * and we have to take this into account for an accurate repeat</span>
<span class="cm"> * behaviour.</span>
<span class="cm"> */</span>
<span class="cp">#define FILTER_TIME	60 </span><span class="cm">/* msec */</span><span class="cp"></span>
<span class="cp">#define REPEAT_DELAY	500 </span><span class="cm">/* msec */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel_mask</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">channel_mask</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">channel_mask</span><span class="p">,</span> <span class="s">&quot;Bitmask of remote control channels to ignore&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Enable extra debug messages and information&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">repeat_filter</span> <span class="o">=</span> <span class="n">FILTER_TIME</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">repeat_filter</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">repeat_filter</span><span class="p">,</span> <span class="s">&quot;Repeat filter time, default = 60 msec&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">repeat_delay</span> <span class="o">=</span> <span class="n">REPEAT_DELAY</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">repeat_delay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">repeat_delay</span><span class="p">,</span> <span class="s">&quot;Delay before sending repeats, default = 500 msec&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">mouse</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mouse</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mouse</span><span class="p">,</span> <span class="s">&quot;Enable mouse device, default = yes&quot;</span><span class="p">);</span>

<span class="cp">#define dbginfo(dev, format, arg...) do { if (debug) dev_info(dev , format , ## arg); } while (0)</span>
<span class="cp">#undef err</span>
<span class="cp">#define err(format, arg...) printk(KERN_ERR format , ## arg)</span>

<span class="k">struct</span> <span class="n">ati_receiver_type</span> <span class="p">{</span>
	<span class="cm">/* either default_keymap or get_default_keymap should be set */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">default_keymap</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get_default_keymap</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_medion_keymap</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * There are many different Medion remotes shipped with a receiver</span>
<span class="cm">	 * with the same usb id, but the receivers have subtle differences</span>
<span class="cm">	 * in the USB descriptors allowing us to detect them.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">manufacturer</span> <span class="o">&amp;&amp;</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_CONFIG_ATT_WAKEUP</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">,</span> <span class="s">&quot;X10 Wireless Technology Inc&quot;</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">,</span> <span class="s">&quot;USB Receiver&quot;</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">RC_MAP_MEDION_X10_DIGITAINER</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">,</span> <span class="s">&quot;X10 WTI&quot;</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">,</span> <span class="s">&quot;RF receiver&quot;</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">RC_MAP_MEDION_X10_OR2X</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">,</span> <span class="s">&quot;X10 Wireless Technology Inc&quot;</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">,</span> <span class="s">&quot;USB Receiver&quot;</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">RC_MAP_MEDION_X10</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;Unknown Medion X10 receiver, using default ati_remote Medion keymap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">RC_MAP_MEDION_X10</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ati_receiver_type</span> <span class="n">type_ati</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">default_keymap</span> <span class="o">=</span> <span class="n">RC_MAP_ATI_X10</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ati_receiver_type</span> <span class="n">type_medion</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">get_default_keymap</span> <span class="o">=</span> <span class="n">get_medion_keymap</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ati_receiver_type</span> <span class="n">type_firefly</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">default_keymap</span> <span class="o">=</span> <span class="n">RC_MAP_SNAPSTREAM_FIREFLY</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">ati_remote_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ATI_REMOTE_VENDOR_ID</span><span class="p">,</span> <span class="n">LOLA_REMOTE_PRODUCT_ID</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">type_ati</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ATI_REMOTE_VENDOR_ID</span><span class="p">,</span> <span class="n">LOLA2_REMOTE_PRODUCT_ID</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">type_ati</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ATI_REMOTE_VENDOR_ID</span><span class="p">,</span> <span class="n">ATI_REMOTE_PRODUCT_ID</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">type_ati</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ATI_REMOTE_VENDOR_ID</span><span class="p">,</span> <span class="n">NVIDIA_REMOTE_PRODUCT_ID</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">type_ati</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ATI_REMOTE_VENDOR_ID</span><span class="p">,</span> <span class="n">MEDION_REMOTE_PRODUCT_ID</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">type_medion</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ATI_REMOTE_VENDOR_ID</span><span class="p">,</span> <span class="n">FIREFLY_REMOTE_PRODUCT_ID</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">type_firefly</span> <span class="p">},</span>
	<span class="p">{}</span>	<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">ati_remote_table</span><span class="p">);</span>

<span class="cm">/* Get hi and low bytes of a 16-bits int */</span>
<span class="cp">#define HI(a)	((unsigned char)((a) &gt;&gt; 8))</span>
<span class="cp">#define LO(a)	((unsigned char)((a) &amp; 0xff))</span>

<span class="cp">#define SEND_FLAG_IN_PROGRESS	1</span>
<span class="cp">#define SEND_FLAG_COMPLETE	2</span>

<span class="cm">/* Device initialization strings */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">init1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x14</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">init2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">};</span>

<span class="k">struct</span> <span class="n">ati_remote</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">irq_urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">out_urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">endpoint_in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">endpoint_out</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outbuf</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">inbuf_dma</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">outbuf_dma</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_data</span><span class="p">;</span>     <span class="cm">/* Detect duplicate events */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_jiffies</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">acc_jiffies</span><span class="p">;</span>  <span class="cm">/* handle acceleration */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">first_jiffies</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">repeat_count</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">rc_name</span><span class="p">[</span><span class="n">NAME_BUFSIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">rc_phys</span><span class="p">[</span><span class="n">NAME_BUFSIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">mouse_name</span><span class="p">[</span><span class="n">NAME_BUFSIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">mouse_phys</span><span class="p">[</span><span class="n">NAME_BUFSIZE</span><span class="p">];</span>

	<span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">send_flags</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">users</span><span class="p">;</span> <span class="cm">/* 0-2, users are rc and input */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">open_mutex</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* &quot;Kinds&quot; of messages sent from the hardware to the driver. */</span>
<span class="cp">#define KIND_END        0</span>
<span class="cp">#define KIND_LITERAL    1   </span><span class="cm">/* Simply pass to input system */</span><span class="cp"></span>
<span class="cp">#define KIND_FILTERED   2   </span><span class="cm">/* Add artificial key-up events, drop keyrepeats */</span><span class="cp"></span>
<span class="cp">#define KIND_LU         3   </span><span class="cm">/* Directional keypad diagonals - left up, */</span><span class="cp"></span>
<span class="cp">#define KIND_RU         4   </span><span class="cm">/*   right up,  */</span><span class="cp"></span>
<span class="cp">#define KIND_LD         5   </span><span class="cm">/*   left down, */</span><span class="cp"></span>
<span class="cp">#define KIND_RD         6   </span><span class="cm">/*   right down */</span><span class="cp"></span>
<span class="cp">#define KIND_ACCEL      7   </span><span class="cm">/* Directional keypad - left, right, up, down.*/</span><span class="cp"></span>

<span class="cm">/* Translation table from hardware messages to input events. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">short</span> <span class="n">kind</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>  <span class="n">ati_remote_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Directional control pad axes */</span>
	<span class="p">{</span><span class="n">KIND_ACCEL</span><span class="p">,</span>   <span class="mh">0x70</span><span class="p">,</span> <span class="n">EV_REL</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>   <span class="cm">/* left */</span>
	<span class="p">{</span><span class="n">KIND_ACCEL</span><span class="p">,</span>   <span class="mh">0x71</span><span class="p">,</span> <span class="n">EV_REL</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>    <span class="cm">/* right */</span>
	<span class="p">{</span><span class="n">KIND_ACCEL</span><span class="p">,</span>   <span class="mh">0x72</span><span class="p">,</span> <span class="n">EV_REL</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>   <span class="cm">/* up */</span>
	<span class="p">{</span><span class="n">KIND_ACCEL</span><span class="p">,</span>   <span class="mh">0x73</span><span class="p">,</span> <span class="n">EV_REL</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>    <span class="cm">/* down */</span>
	<span class="cm">/* Directional control pad diagonals */</span>
	<span class="p">{</span><span class="n">KIND_LU</span><span class="p">,</span>      <span class="mh">0x74</span><span class="p">,</span> <span class="n">EV_REL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>        <span class="cm">/* left up */</span>
	<span class="p">{</span><span class="n">KIND_RU</span><span class="p">,</span>      <span class="mh">0x75</span><span class="p">,</span> <span class="n">EV_REL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>        <span class="cm">/* right up */</span>
	<span class="p">{</span><span class="n">KIND_LD</span><span class="p">,</span>      <span class="mh">0x77</span><span class="p">,</span> <span class="n">EV_REL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>        <span class="cm">/* left down */</span>
	<span class="p">{</span><span class="n">KIND_RD</span><span class="p">,</span>      <span class="mh">0x76</span><span class="p">,</span> <span class="n">EV_REL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>        <span class="cm">/* right down */</span>

	<span class="cm">/* &quot;Mouse button&quot; buttons */</span>
	<span class="p">{</span><span class="n">KIND_LITERAL</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="cm">/* left btn down */</span>
	<span class="p">{</span><span class="n">KIND_LITERAL</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* left btn up */</span>
	<span class="p">{</span><span class="n">KIND_LITERAL</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span><span class="cm">/* right btn down */</span>
	<span class="p">{</span><span class="n">KIND_LITERAL</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span><span class="cm">/* right btn up */</span>

	<span class="cm">/* Artificial &quot;doubleclick&quot; events are generated by the hardware.</span>
<span class="cm">	 * They are mapped to the &quot;side&quot; and &quot;extra&quot; mouse buttons here. */</span>
	<span class="p">{</span><span class="n">KIND_FILTERED</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">BTN_SIDE</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="cm">/* left dblclick */</span>
	<span class="p">{</span><span class="n">KIND_FILTERED</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">BTN_EXTRA</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span><span class="cm">/* right dblclick */</span>

	<span class="cm">/* Non-mouse events are handled by rc-core */</span>
	<span class="p">{</span><span class="n">KIND_END</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">EV_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Local function prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ati_remote_sendpacket</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ati_remote_irq_out</span>		<span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ati_remote_irq_in</span>		<span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ati_remote_input_report</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ati_remote_initialize</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ati_remote_probe</span>		<span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ati_remote_disconnect</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">);</span>

<span class="cm">/* usb specific object to register with the usb subsystem */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">ati_remote_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>         <span class="o">=</span> <span class="s">&quot;ati_remote&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>        <span class="o">=</span> <span class="n">ati_remote_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>   <span class="o">=</span> <span class="n">ati_remote_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>     <span class="o">=</span> <span class="n">ati_remote_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	ati_remote_dump_input</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ati_remote_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Weird byte 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Weird key %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Weird data, len=%d %02x %02x %02x %02x %02x %02x ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">len</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	ati_remote_open</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ati_remote_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">++</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* one was already active */</span>

	<span class="cm">/* On first open, submit the read urb which was set up previously. */</span>
	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">irq_urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">irq_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: usb_submit_urb failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	ati_remote_close</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ati_remote_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">irq_urb</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ati_remote_input_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">inputdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">inputdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ati_remote_open</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ati_remote_input_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">inputdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">inputdev</span><span class="p">);</span>
	<span class="n">ati_remote_close</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ati_remote_rc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ati_remote_open</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ati_remote_rc_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">ati_remote_close</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		ati_remote_irq_out</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ati_remote_irq_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">|=</span> <span class="n">SEND_FLAG_COMPLETE</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	ati_remote_sendpacket</span>
<span class="cm"> *</span>
<span class="cm"> *	Used to send device initialization strings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ati_remote_sendpacket</span><span class="p">(</span><span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set up out_urb */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">LO</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">HI</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="n">LO</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">SEND_FLAG_IN_PROGRESS</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;sendpacket: usb_submit_urb failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
		<span class="p">((</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">&amp;</span> <span class="n">SEND_FLAG_COMPLETE</span><span class="p">)),</span>
		<span class="n">HZ</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	ati_remote_compute_accel</span>
<span class="cm"> *</span>
<span class="cm"> * Implements acceleration curve for directional control pad</span>
<span class="cm"> * If elapsed time since last event is &gt; 1/4 second, user &quot;stopped&quot;,</span>
<span class="cm"> * so reset acceleration. Otherwise, user is probably holding the control</span>
<span class="cm"> * pad down, so we increase acceleration, ramping up over two seconds to</span>
<span class="cm"> * a maximum speed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ati_remote_compute_accel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">accel</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">20</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">acc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">old_jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">250</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">acc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">acc_jiffies</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">acc_jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">125</span><span class="p">)))</span>
		<span class="n">acc</span> <span class="o">=</span> <span class="n">accel</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">acc_jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">250</span><span class="p">)))</span>
		<span class="n">acc</span> <span class="o">=</span> <span class="n">accel</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">acc_jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">)))</span>
		<span class="n">acc</span> <span class="o">=</span> <span class="n">accel</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">acc_jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">)))</span>
		<span class="n">acc</span> <span class="o">=</span> <span class="n">accel</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">acc_jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1500</span><span class="p">)))</span>
		<span class="n">acc</span> <span class="o">=</span> <span class="n">accel</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">acc_jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">)))</span>
		<span class="n">acc</span> <span class="o">=</span> <span class="n">accel</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">acc</span> <span class="o">=</span> <span class="n">accel</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">acc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	ati_remote_report_input</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ati_remote_input_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="o">=</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">acc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">remote_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scancode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wheel_keycode</span> <span class="o">=</span> <span class="n">KEY_RESERVED</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * data[0] = 0x14</span>
<span class="cm">	 * data[1] = data[2] + data[3] + 0xd5 (a checksum byte)</span>
<span class="cm">	 * data[2] = the key code (with toggle bit in MSB with some models)</span>
<span class="cm">	 * data[3] = channel &lt;&lt; 4 (the low 4 bits must be zero)</span>
<span class="cm">	 */</span>

	<span class="cm">/* Deal with strange looking inputs */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x14</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">ati_remote_dump</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0xd5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbginfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;wrong checksum in input: %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Mask unwanted remote channels.  */</span>
	<span class="cm">/* note: remote_num is 0-based, channel 1 on remote == 0 here */</span>
	<span class="n">remote_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">remote_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dbginfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Masked input from channel 0x%02x: data %02x,%02x, mask= 0x%02lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">remote_num</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">channel_mask</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * MSB is a toggle code, though only used by some devices</span>
<span class="cm">	 * (e.g. SnapStream Firefly)</span>
<span class="cm">	 */</span>
	<span class="n">scancode</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

	<span class="n">dbginfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;channel 0x%02x; key data %02x, scancode %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">remote_num</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">scancode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scancode</span> <span class="o">&gt;=</span> <span class="mh">0x70</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is either a mouse or scrollwheel event, depending on</span>
<span class="cm">		 * the remote/keymap.</span>
<span class="cm">		 * Get the keycode assigned to scancode 0x78/0x70. If it is</span>
<span class="cm">		 * set, assume this is a scrollwheel up/down event.</span>
<span class="cm">		 */</span>
		<span class="n">wheel_keycode</span> <span class="o">=</span> <span class="n">rc_g_keycode_from_table</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span>
							<span class="n">scancode</span> <span class="o">&amp;</span> <span class="mh">0x78</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wheel_keycode</span> <span class="o">==</span> <span class="n">KEY_RESERVED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* scrollwheel was not mapped, assume mouse */</span>

			<span class="cm">/* Look up event code index in the mouse translation table. */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kind</span> <span class="o">!=</span> <span class="n">KIND_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scancode</span> <span class="o">==</span> <span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">kind</span> <span class="o">==</span> <span class="n">KIND_LITERAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">type</span><span class="p">,</span>
			<span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">code</span><span class="p">,</span>
			<span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">old_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">kind</span> <span class="o">==</span> <span class="n">KIND_FILTERED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

		<span class="cm">/* Filter duplicate events which happen &quot;too close&quot; together. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">old_data</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">old_jiffies</span> <span class="o">+</span>
				     <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">repeat_filter</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">repeat_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">repeat_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">first_jiffies</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">old_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">old_jiffies</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

		<span class="cm">/* Ensure we skip at least the 4 first duplicate events (generated</span>
<span class="cm">		 * by a single keypress), and continue skipping until repeat_delay</span>
<span class="cm">		 * msecs have passed</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">repeat_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">repeat_count</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span>
		     <span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">first_jiffies</span> <span class="o">+</span>
				      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">repeat_delay</span><span class="p">))))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Not a mouse event, hand it to rc-core. */</span>
			<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">wheel_keycode</span> <span class="o">!=</span> <span class="n">KEY_RESERVED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * This is a scrollwheel event, send the</span>
<span class="cm">				 * scroll up (0x78) / down (0x70) scancode</span>
<span class="cm">				 * repeatedly as many times as indicated by</span>
<span class="cm">				 * rest of the scancode.</span>
<span class="cm">				 */</span>
				<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">scancode</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">scancode</span> <span class="o">&amp;=</span> <span class="mh">0x78</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				* We don&#39;t use the rc-core repeat handling yet as</span>
<span class="cm">				* it would cause ghost repeats which would be a</span>
<span class="cm">				* regression for this driver.</span>
<span class="cm">				*/</span>
				<span class="n">rc_keydown_notimeout</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">scancode</span><span class="p">,</span>
						     <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">rc_keyup</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">input_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">type</span><span class="p">,</span>
			<span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">code</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">input_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">type</span><span class="p">,</span>
			<span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">code</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Other event kinds are from the directional control pad, and have an</span>
<span class="cm">		 * acceleration factor applied to them.  Without this acceleration, the</span>
<span class="cm">		 * control pad is mostly unusable.</span>
<span class="cm">		 */</span>
		<span class="n">acc</span> <span class="o">=</span> <span class="n">ati_remote_compute_accel</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">KIND_ACCEL</span>:
			<span class="n">input_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">type</span><span class="p">,</span>
				<span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">code</span><span class="p">,</span>
				<span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">value</span> <span class="o">*</span> <span class="n">acc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KIND_LU</span>:
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span> <span class="o">-</span><span class="n">acc</span><span class="p">);</span>
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="o">-</span><span class="n">acc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KIND_RU</span>:
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span> <span class="n">acc</span><span class="p">);</span>
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="o">-</span><span class="n">acc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KIND_LD</span>:
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span> <span class="o">-</span><span class="n">acc</span><span class="p">);</span>
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="n">acc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KIND_RD</span>:
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span> <span class="n">acc</span><span class="p">);</span>
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="n">acc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ati_remote kind=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">kind</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">old_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">old_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	ati_remote_irq_in</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ati_remote_irq_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:			<span class="cm">/* success */</span>
		<span class="n">ati_remote_input_report</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:	<span class="cm">/* unlink */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: urb error status, unlink? </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* error */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Nonzero urb status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: usb_submit_urb()=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	ati_remote_alloc_buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ati_remote_alloc_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">inbuf</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">DATA_BUFSIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">inbuf_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">outbuf</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">DATA_BUFSIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">outbuf_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">outbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">irq_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">irq_urb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	ati_remote_free_buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ati_remote_free_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">irq_urb</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="p">);</span>

	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">DATA_BUFSIZE</span><span class="p">,</span>
		<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">inbuf_dma</span><span class="p">);</span>

	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">DATA_BUFSIZE</span><span class="p">,</span>
		<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">outbuf</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">outbuf_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ati_remote_input_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REL</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_MOUSE</span><span class="p">)]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_LEFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_RIGHT</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_SIDE</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_EXTRA</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">REL_X</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">REL_Y</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kind</span> <span class="o">!=</span> <span class="n">KIND_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_KEY</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ati_remote_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">code</span><span class="p">,</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">ati_remote</span><span class="p">);</span>

	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">ati_remote_input_open</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">ati_remote_input_close</span><span class="p">;</span>

	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">mouse_name</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">mouse_phys</span><span class="p">;</span>

	<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ati_remote_rc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ati_remote</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">driver_type</span> <span class="o">=</span> <span class="n">RC_DRIVER_SCANCODE</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">RC_TYPE_OTHER</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;ati_remote&quot;</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">ati_remote_rc_open</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">ati_remote_rc_close</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">=</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_name</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_phys</span> <span class="o">=</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_phys</span><span class="p">;</span>

	<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ati_remote_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">maxp</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* Set up irq_urb */</span>
	<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">endpoint_in</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
	<span class="n">maxp</span> <span class="o">=</span> <span class="n">usb_maxpacket</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">usb_pipeout</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">maxp</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxp</span> <span class="o">&gt;</span> <span class="n">DATA_BUFSIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">DATA_BUFSIZE</span> <span class="o">:</span> <span class="n">maxp</span><span class="p">;</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">irq_urb</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">,</span>
			 <span class="n">maxp</span><span class="p">,</span> <span class="n">ati_remote_irq_in</span><span class="p">,</span> <span class="n">ati_remote</span><span class="p">,</span>
			 <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">endpoint_in</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">irq_urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span> <span class="o">=</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">inbuf_dma</span><span class="p">;</span>
	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">irq_urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>

	<span class="cm">/* Set up out_urb */</span>
	<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndintpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">endpoint_out</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
	<span class="n">maxp</span> <span class="o">=</span> <span class="n">usb_maxpacket</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">usb_pipeout</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">maxp</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxp</span> <span class="o">&gt;</span> <span class="n">DATA_BUFSIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">DATA_BUFSIZE</span> <span class="o">:</span> <span class="n">maxp</span><span class="p">;</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">outbuf</span><span class="p">,</span>
			 <span class="n">maxp</span><span class="p">,</span> <span class="n">ati_remote_irq_out</span><span class="p">,</span> <span class="n">ati_remote</span><span class="p">,</span>
			 <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">endpoint_out</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span> <span class="o">=</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">outbuf_dma</span><span class="p">;</span>
	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>

	<span class="cm">/* send initialization strings */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ati_remote_sendpacket</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">,</span> <span class="mh">0x8004</span><span class="p">,</span> <span class="n">init1</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ati_remote_sendpacket</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">,</span> <span class="mh">0x8007</span><span class="p">,</span> <span class="n">init2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Initializing ati_remote hardware failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	ati_remote_probe</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ati_remote_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">iface_host</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">endpoint_in</span><span class="p">,</span> <span class="o">*</span><span class="n">endpoint_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ati_receiver_type</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ati_receiver_type</span> <span class="o">*</span><span class="p">)</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iface_host</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s: Unexpected desc.bNumEndpoints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">endpoint_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iface_host</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">endpoint_out</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iface_host</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_endpoint_is_int_in</span><span class="p">(</span><span class="n">endpoint_in</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s: Unexpected endpoint_in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">endpoint_in</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s: endpoint_in message size==0? </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ati_remote</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ati_remote</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">rc_dev</span> <span class="o">=</span> <span class="n">rc_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ati_remote</span> <span class="o">||</span> <span class="o">!</span><span class="n">rc_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>

	<span class="cm">/* Allocate URB buffers, URBs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ati_remote_alloc_buffers</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ati_remote</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>

	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">endpoint_in</span> <span class="o">=</span> <span class="n">endpoint_in</span><span class="p">;</span>
	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">endpoint_out</span> <span class="o">=</span> <span class="n">endpoint_out</span><span class="p">;</span>
	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>
	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rc_dev</span><span class="p">;</span>
	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="n">interface</span><span class="p">;</span>

	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_phys</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">mouse_phys</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_phys</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">mouse_phys</span><span class="p">));</span>

	<span class="n">strlcat</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_phys</span><span class="p">,</span> <span class="s">&quot;/input0&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_phys</span><span class="p">));</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">mouse_phys</span><span class="p">,</span> <span class="s">&quot;/input1&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">mouse_phys</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_name</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_name</span><span class="p">),</span>
			 <span class="s">&quot;%s %s&quot;</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_name</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_name</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_name</span><span class="p">),</span>
			<span class="n">DRIVER_DESC</span> <span class="s">&quot;(%04x,%04x)&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">),</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">));</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">mouse_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">mouse_name</span><span class="p">),</span>
		 <span class="s">&quot;%s mouse&quot;</span><span class="p">,</span> <span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rc_name</span><span class="p">);</span>

	<span class="n">rc_dev</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">RC_MAP_ATI_X10</span><span class="p">;</span> <span class="cm">/* default map */</span>

	<span class="cm">/* set default keymap according to receiver model */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">default_keymap</span><span class="p">)</span>
			<span class="n">rc_dev</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">default_keymap</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">get_default_keymap</span><span class="p">)</span>
			<span class="n">rc_dev</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">get_default_keymap</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ati_remote_rc_init</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>

	<span class="cm">/* Device Hardware Initialization - fills in ati_remote-&gt;idev from udev. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ati_remote_initialize</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>

	<span class="cm">/* Set up and register rc device */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rc_register_device</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>

	<span class="cm">/* use our delay for rc_dev */</span>
	<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_DELAY</span><span class="p">]</span> <span class="o">=</span> <span class="n">repeat_delay</span><span class="p">;</span>

	<span class="cm">/* Set up and register mouse input device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mouse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_dev</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>

		<span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>
		<span class="n">ati_remote_input_init</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">ati_remote</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail5:</span>	<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
 <span class="nl">fail4:</span>	<span class="n">rc_unregister_device</span><span class="p">(</span><span class="n">rc_dev</span><span class="p">);</span>
	<span class="n">rc_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="nl">fail3:</span>	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">irq_urb</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="p">);</span>
 <span class="nl">fail2:</span>	<span class="n">ati_remote_free_buffers</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">);</span>
 <span class="nl">fail1:</span>	<span class="n">rc_free_device</span><span class="p">(</span><span class="n">rc_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	ati_remote_disconnect</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ati_remote_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ati_remote</span> <span class="o">*</span><span class="n">ati_remote</span><span class="p">;</span>

	<span class="n">ati_remote</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ati_remote</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - null device?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">irq_urb</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">out_urb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
	<span class="n">rc_unregister_device</span><span class="p">(</span><span class="n">ati_remote</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">ati_remote_free_buffers</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ati_remote</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">ati_remote_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
