<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › rc › nuvoton-cir.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>nuvoton-cir.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for Nuvoton Technology Corporation w83667hg/w83677hg-i CIR</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Jarod Wilson &lt;jarod@redhat.com&gt;</span>
<span class="cm"> * Copyright (C) 2009 Nuvoton PS Team</span>
<span class="cm"> *</span>
<span class="cm"> * Special thanks to Nuvoton for providing hardware, spec sheets and</span>
<span class="cm"> * sample code upon which portions of this driver are based. Indirect</span>
<span class="cm"> * thanks also to Maxim Levitsky, whose ene_ir driver this driver is</span>
<span class="cm"> * modeled after.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of the</span>
<span class="cm"> * License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307</span>
<span class="cm"> * USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pnp.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;media/rc-core.h&gt;</span>
<span class="cp">#include &lt;linux/pci_ids.h&gt;</span>

<span class="cp">#include &quot;nuvoton-cir.h&quot;</span>

<span class="cm">/* write val to config reg */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nvt_cr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cr_efir</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cr_efdr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* read val from config reg */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">nvt_cr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cr_efir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cr_efdr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* update config register bit without changing other bits */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nvt_set_reg_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* clear config register bit without changing other bits */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nvt_clear_reg_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">val</span><span class="p">;</span>
	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* enter extended function mode */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nvt_efm_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Enabling Extended Function Mode explicitly requires writing 2x */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">EFER_EFM_ENABLE</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cr_efir</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">EFER_EFM_ENABLE</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cr_efir</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* exit extended function mode */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nvt_efm_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">EFER_EFM_DISABLE</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cr_efir</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When you want to address a specific logical device, write its logical</span>
<span class="cm"> * device number to CR_LOGICAL_DEV_SEL, then enable/disable by writing</span>
<span class="cm"> * 0x1/0x0 respectively to CR_LOGICAL_DEV_EN.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nvt_select_logical_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ldev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CR_LOGICAL_DEV_SEL</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cr_efir</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ldev</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cr_efdr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* write val to cir config register */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nvt_cir_reg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* read val from cir config register */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">nvt_cir_reg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* write val to cir wake register */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* read val from cir wake config register */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define pr_reg(text, ...) \</span>
<span class="cp">	printk(KERN_INFO KBUILD_MODNAME &quot;: &quot; text, ## __VA_ARGS__)</span>

<span class="cm">/* dump current cir register contents */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cir_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nvt_efm_enable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">nvt_select_logical_dev</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_CIR</span><span class="p">);</span>

	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot;%s: Dump CIR logical device registers:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">NVT_DRIVER_NAME</span><span class="p">);</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * CR CIR ACTIVE :   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CR_LOGICAL_DEV_EN</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * CR CIR BASE ADDR: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CR_CIR_BASE_ADDR_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CR_CIR_BASE_ADDR_LO</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * CR CIR IRQ NUM:   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CR_CIR_IRQ_RSRC</span><span class="p">));</span>

	<span class="n">nvt_efm_disable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot;%s: Dump CIR registers:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">NVT_DRIVER_NAME</span><span class="p">);</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * IRCON:     0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_IRCON</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * IRSTS:     0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_IRSTS</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * IREN:      0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_IREN</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * RXFCONT:   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_RXFCONT</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * CP:        0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_CP</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * CC:        0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_CC</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * SLCH:      0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_SLCH</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * SLCL:      0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_SLCL</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * FIFOCON:   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_FIFOCON</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * IRFIFOSTS: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_IRFIFOSTS</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * SRXFIFO:   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_SRXFIFO</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * TXFCONT:   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_TXFCONT</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * STXFIFO:   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_STXFIFO</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * FCCH:      0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_FCCH</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * FCCL:      0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_FCCL</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * IRFSM:     0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_IRFSM</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* dump current cir wake register contents */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cir_wake_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">fifo_len</span><span class="p">;</span>

	<span class="n">nvt_efm_enable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">nvt_select_logical_dev</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_CIR_WAKE</span><span class="p">);</span>

	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot;%s: Dump CIR WAKE logical device registers:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">NVT_DRIVER_NAME</span><span class="p">);</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * CR CIR WAKE ACTIVE :   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CR_LOGICAL_DEV_EN</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * CR CIR WAKE BASE ADDR: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CR_CIR_BASE_ADDR_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CR_CIR_BASE_ADDR_LO</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * CR CIR WAKE IRQ NUM:   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CR_CIR_IRQ_RSRC</span><span class="p">));</span>

	<span class="n">nvt_efm_disable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot;%s: Dump CIR WAKE registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">NVT_DRIVER_NAME</span><span class="p">);</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * IRCON:          0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_IRCON</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * IRSTS:          0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_IRSTS</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * IREN:           0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_IREN</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * FIFO CMP DEEP:  0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_FIFO_CMP_DEEP</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * FIFO CMP TOL:   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_FIFO_CMP_TOL</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * FIFO COUNT:     0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_FIFO_COUNT</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * SLCH:           0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_SLCH</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * SLCL:           0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_SLCL</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * FIFOCON:        0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_FIFOCON</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * SRXFSTS:        0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_SRXFSTS</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * SAMPLE RX FIFO: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_SAMPLE_RX_FIFO</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * WR FIFO DATA:   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_WR_FIFO_DATA</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * RD FIFO ONLY:   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_RD_FIFO_ONLY</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * RD FIFO ONLY IDX: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_RD_FIFO_ONLY_IDX</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * FIFO IGNORE:    0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_FIFO_IGNORE</span><span class="p">));</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot; * IRFSM:          0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_IRFSM</span><span class="p">));</span>

	<span class="n">fifo_len</span> <span class="o">=</span> <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_FIFO_COUNT</span><span class="p">);</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot;%s: Dump CIR WAKE FIFO (len %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">NVT_DRIVER_NAME</span><span class="p">,</span> <span class="n">fifo_len</span><span class="p">);</span>
	<span class="n">pr_reg</span><span class="p">(</span><span class="s">&quot;* Contents = &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fifo_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span>
		       <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_RD_FIFO_ONLY</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* detect hardware features */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvt_hw_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">chip_major</span><span class="p">,</span> <span class="n">chip_minor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">chip_id</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">chip_unknown</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">nvt_efm_enable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="cm">/* Check if we&#39;re wired for the alternate EFER setup */</span>
	<span class="n">chip_major</span> <span class="o">=</span> <span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CR_CHIP_ID_HI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_major</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cr_efir</span> <span class="o">=</span> <span class="n">CR_EFIR2</span><span class="p">;</span>
		<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cr_efdr</span> <span class="o">=</span> <span class="n">CR_EFDR2</span><span class="p">;</span>
		<span class="n">nvt_efm_enable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
		<span class="n">chip_major</span> <span class="o">=</span> <span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CR_CHIP_ID_HI</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">chip_minor</span> <span class="o">=</span> <span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CR_CHIP_ID_LO</span><span class="p">);</span>

	<span class="cm">/* these are the known working chip revisions... */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chip_major</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHIP_ID_HIGH_667</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">chip_id</span><span class="p">,</span> <span class="s">&quot;w83667hg</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_minor</span> <span class="o">!=</span> <span class="n">CHIP_ID_LOW_667</span><span class="p">)</span>
			<span class="n">chip_unknown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHIP_ID_HIGH_677B</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">chip_id</span><span class="p">,</span> <span class="s">&quot;w83677hg</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_minor</span> <span class="o">!=</span> <span class="n">CHIP_ID_LOW_677B2</span> <span class="o">&amp;&amp;</span>
		    <span class="n">chip_minor</span> <span class="o">!=</span> <span class="n">CHIP_ID_LOW_677B3</span><span class="p">)</span>
			<span class="n">chip_unknown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHIP_ID_HIGH_677C</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">chip_id</span><span class="p">,</span> <span class="s">&quot;w83677hg-c</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_minor</span> <span class="o">!=</span> <span class="n">CHIP_ID_LOW_677C</span><span class="p">)</span>
			<span class="n">chip_unknown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">chip_id</span><span class="p">,</span> <span class="s">&quot;w836x7hg</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chip_unknown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* warn, but still let the driver load, if we don&#39;t know this chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_unknown</span><span class="p">)</span>
		<span class="n">nvt_pr</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;%s: unknown chip, id: 0x%02x 0x%02x, &quot;</span>
		       <span class="s">&quot;it may not work...&quot;</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">,</span> <span class="n">chip_major</span><span class="p">,</span> <span class="n">chip_minor</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;%s: chip id: 0x%02x 0x%02x&quot;</span><span class="p">,</span>
			<span class="n">chip_id</span><span class="p">,</span> <span class="n">chip_major</span><span class="p">,</span> <span class="n">chip_minor</span><span class="p">);</span>

	<span class="n">nvt_efm_disable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">chip_major</span> <span class="o">=</span> <span class="n">chip_major</span><span class="p">;</span>
	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">chip_minor</span> <span class="o">=</span> <span class="n">chip_minor</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_cir_ldev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">psreg</span><span class="p">,</span> <span class="n">psmask</span><span class="p">,</span> <span class="n">psval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">chip_major</span> <span class="o">==</span> <span class="n">CHIP_ID_HIGH_667</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psreg</span> <span class="o">=</span> <span class="n">CR_MULTIFUNC_PIN_SEL</span><span class="p">;</span>
		<span class="n">psmask</span> <span class="o">=</span> <span class="n">MULTIFUNC_PIN_SEL_MASK</span><span class="p">;</span>
		<span class="n">psval</span> <span class="o">=</span> <span class="n">MULTIFUNC_ENABLE_CIR</span> <span class="o">|</span> <span class="n">MULTIFUNC_ENABLE_CIRWB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">psreg</span> <span class="o">=</span> <span class="n">CR_OUTPUT_PIN_SEL</span><span class="p">;</span>
		<span class="n">psmask</span> <span class="o">=</span> <span class="n">OUTPUT_PIN_SEL_MASK</span><span class="p">;</span>
		<span class="n">psval</span> <span class="o">=</span> <span class="n">OUTPUT_ENABLE_CIR</span> <span class="o">|</span> <span class="n">OUTPUT_ENABLE_CIRWB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* output pin selection: enable CIR, with WB sensor enabled */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">nvt_cr_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">psreg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">psmask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">psval</span><span class="p">;</span>
	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">psreg</span><span class="p">);</span>

	<span class="cm">/* Select CIR logical device and enable */</span>
	<span class="n">nvt_select_logical_dev</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_CIR</span><span class="p">);</span>
	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_ENABLE</span><span class="p">,</span> <span class="n">CR_LOGICAL_DEV_EN</span><span class="p">);</span>

	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">CR_CIR_BASE_ADDR_HI</span><span class="p">);</span>
	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">CR_CIR_BASE_ADDR_LO</span><span class="p">);</span>

	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_irq</span><span class="p">,</span> <span class="n">CR_CIR_IRQ_RSRC</span><span class="p">);</span>

	<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;CIR initialized, base io port address: 0x%lx, irq: %d&quot;</span><span class="p">,</span>
		<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_addr</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_cir_wake_ldev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Select ACPI logical device, enable it and CIR Wake */</span>
	<span class="n">nvt_select_logical_dev</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_ACPI</span><span class="p">);</span>
	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_ENABLE</span><span class="p">,</span> <span class="n">CR_LOGICAL_DEV_EN</span><span class="p">);</span>

	<span class="cm">/* Enable CIR Wake via PSOUT# (Pin60) */</span>
	<span class="n">nvt_set_reg_bit</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_ENABLE_BIT</span><span class="p">,</span> <span class="n">CR_ACPI_CIR_WAKE</span><span class="p">);</span>

	<span class="cm">/* enable cir interrupt of mouse/keyboard IRQ event */</span>
	<span class="n">nvt_set_reg_bit</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_INTR_MOUSE_IRQ_BIT</span><span class="p">,</span> <span class="n">CR_ACPI_IRQ_EVENTS</span><span class="p">);</span>

	<span class="cm">/* enable pme interrupt of cir wakeup event */</span>
	<span class="n">nvt_set_reg_bit</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">PME_INTR_CIR_PASS_BIT</span><span class="p">,</span> <span class="n">CR_ACPI_IRQ_EVENTS2</span><span class="p">);</span>

	<span class="cm">/* Select CIR Wake logical device and enable */</span>
	<span class="n">nvt_select_logical_dev</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_CIR_WAKE</span><span class="p">);</span>
	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_ENABLE</span><span class="p">,</span> <span class="n">CR_LOGICAL_DEV_EN</span><span class="p">);</span>

	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">CR_CIR_BASE_ADDR_HI</span><span class="p">);</span>
	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">CR_CIR_BASE_ADDR_LO</span><span class="p">);</span>

	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_irq</span><span class="p">,</span> <span class="n">CR_CIR_IRQ_RSRC</span><span class="p">);</span>

	<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;CIR Wake initialized, base io port address: 0x%lx, irq: %d&quot;</span><span class="p">,</span>
		<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_addr</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* clear out the hardware&#39;s cir rx fifo */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_clear_cir_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_FIFOCON</span><span class="p">);</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">CIR_FIFOCON_RXFIFOCLR</span><span class="p">,</span> <span class="n">CIR_FIFOCON</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* clear out the hardware&#39;s cir wake rx fifo */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_clear_cir_wake_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_FIFOCON</span><span class="p">);</span>
	<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">CIR_WAKE_FIFOCON_RXFIFOCLR</span><span class="p">,</span>
			       <span class="n">CIR_WAKE_FIFOCON</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* clear out the hardware&#39;s cir tx fifo */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_clear_tx_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_FIFOCON</span><span class="p">);</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">CIR_FIFOCON_TXFIFOCLR</span><span class="p">,</span> <span class="n">CIR_FIFOCON</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* enable RX Trigger Level Reach and Packet End interrupts */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_set_cir_iren</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">iren</span><span class="p">;</span>

	<span class="n">iren</span> <span class="o">=</span> <span class="n">CIR_IREN_RTR</span> <span class="o">|</span> <span class="n">CIR_IREN_PE</span><span class="p">;</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">iren</span><span class="p">,</span> <span class="n">CIR_IREN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_cir_regs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set sample limit count (PE interrupt raised when reached) */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_RX_LIMIT_COUNT</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">CIR_SLCH</span><span class="p">);</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_RX_LIMIT_COUNT</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">CIR_SLCL</span><span class="p">);</span>

	<span class="cm">/* set fifo irq trigger levels */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_FIFOCON_TX_TRIGGER_LEV</span> <span class="o">|</span>
			  <span class="n">CIR_FIFOCON_RX_TRIGGER_LEV</span><span class="p">,</span> <span class="n">CIR_FIFOCON</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable TX and RX, specify carrier on = low, off = high, and set</span>
<span class="cm">	 * sample period (currently 50us)</span>
<span class="cm">	 */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span>
			  <span class="n">CIR_IRCON_TXEN</span> <span class="o">|</span> <span class="n">CIR_IRCON_RXEN</span> <span class="o">|</span>
			  <span class="n">CIR_IRCON_RXINV</span> <span class="o">|</span> <span class="n">CIR_IRCON_SAMPLE_PERIOD_SEL</span><span class="p">,</span>
			  <span class="n">CIR_IRCON</span><span class="p">);</span>

	<span class="cm">/* clear hardware rx and tx fifos */</span>
	<span class="n">nvt_clear_cir_fifo</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">nvt_clear_tx_fifo</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="cm">/* clear any and all stray interrupts */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">CIR_IRSTS</span><span class="p">);</span>

	<span class="cm">/* and finally, enable interrupts */</span>
	<span class="n">nvt_set_cir_iren</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_cir_wake_regs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set number of bytes needed for wake from s3 (default 65) */</span>
	<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_FIFO_CMP_BYTES</span><span class="p">,</span>
			       <span class="n">CIR_WAKE_FIFO_CMP_DEEP</span><span class="p">);</span>

	<span class="cm">/* set tolerance/variance allowed per byte during wake compare */</span>
	<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_CMP_TOLERANCE</span><span class="p">,</span>
			       <span class="n">CIR_WAKE_FIFO_CMP_TOL</span><span class="p">);</span>

	<span class="cm">/* set sample limit count (PE interrupt raised when reached) */</span>
	<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_RX_LIMIT_COUNT</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">CIR_WAKE_SLCH</span><span class="p">);</span>
	<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_RX_LIMIT_COUNT</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">CIR_WAKE_SLCL</span><span class="p">);</span>

	<span class="cm">/* set cir wake fifo rx trigger level (currently 67) */</span>
	<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_FIFOCON_RX_TRIGGER_LEV</span><span class="p">,</span>
			       <span class="n">CIR_WAKE_FIFOCON</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable TX and RX, specific carrier on = low, off = high, and set</span>
<span class="cm">	 * sample period (currently 50us)</span>
<span class="cm">	 */</span>
	<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_IRCON_MODE0</span> <span class="o">|</span> <span class="n">CIR_WAKE_IRCON_RXEN</span> <span class="o">|</span>
			       <span class="n">CIR_WAKE_IRCON_R</span> <span class="o">|</span> <span class="n">CIR_WAKE_IRCON_RXINV</span> <span class="o">|</span>
			       <span class="n">CIR_WAKE_IRCON_SAMPLE_PERIOD_SEL</span><span class="p">,</span>
			       <span class="n">CIR_WAKE_IRCON</span><span class="p">);</span>

	<span class="cm">/* clear cir wake rx fifo */</span>
	<span class="n">nvt_clear_cir_wake_fifo</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="cm">/* clear any and all stray interrupts */</span>
	<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">CIR_WAKE_IRSTS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_enable_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nvt_efm_enable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="n">nvt_select_logical_dev</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_ACPI</span><span class="p">);</span>
	<span class="n">nvt_set_reg_bit</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_ENABLE_BIT</span><span class="p">,</span> <span class="n">CR_ACPI_CIR_WAKE</span><span class="p">);</span>
	<span class="n">nvt_set_reg_bit</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_INTR_MOUSE_IRQ_BIT</span><span class="p">,</span> <span class="n">CR_ACPI_IRQ_EVENTS</span><span class="p">);</span>
	<span class="n">nvt_set_reg_bit</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">PME_INTR_CIR_PASS_BIT</span><span class="p">,</span> <span class="n">CR_ACPI_IRQ_EVENTS2</span><span class="p">);</span>

	<span class="n">nvt_select_logical_dev</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_CIR_WAKE</span><span class="p">);</span>
	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_ENABLE</span><span class="p">,</span> <span class="n">CR_LOGICAL_DEV_EN</span><span class="p">);</span>

	<span class="n">nvt_efm_disable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_IRCON_MODE0</span> <span class="o">|</span> <span class="n">CIR_WAKE_IRCON_RXEN</span> <span class="o">|</span>
			       <span class="n">CIR_WAKE_IRCON_R</span> <span class="o">|</span> <span class="n">CIR_WAKE_IRCON_RXINV</span> <span class="o">|</span>
			       <span class="n">CIR_WAKE_IRCON_SAMPLE_PERIOD_SEL</span><span class="p">,</span>
			       <span class="n">CIR_WAKE_IRCON</span><span class="p">);</span>
	<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">CIR_WAKE_IRSTS</span><span class="p">);</span>
	<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CIR_WAKE_IREN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* rx carrier detect only works in learning mode, must be called w/nvt_lock */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">nvt_rx_carrier_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="n">carrier</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_FCCL</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_FCCH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">pkts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BUF_PULSE_BIT</span><span class="p">)</span>
			<span class="n">duration</span> <span class="o">+=</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BUF_LEN_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">duration</span> <span class="o">*=</span> <span class="n">SAMPLE_PERIOD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span> <span class="o">||</span> <span class="o">!</span><span class="n">duration</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nvt_pr</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="s">&quot;Unable to determine carrier! (c:%u, d:%u)&quot;</span><span class="p">,</span>
		       <span class="n">count</span><span class="p">,</span> <span class="n">duration</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">carrier</span> <span class="o">=</span> <span class="n">MS_TO_NS</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">carrier</span> <span class="o">&gt;</span> <span class="n">MAX_CARRIER</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">carrier</span> <span class="o">&lt;</span> <span class="n">MIN_CARRIER</span><span class="p">))</span>
		<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;WTF? Carrier frequency out of range!&quot;</span><span class="p">);</span>

	<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;Carrier frequency: %u (count %u, duration %u)&quot;</span><span class="p">,</span>
		<span class="n">carrier</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">duration</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">carrier</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set carrier frequency</span>
<span class="cm"> *</span>
<span class="cm"> * set carrier on 2 registers: CP &amp; CC</span>
<span class="cm"> * always set CP as 0x81</span>
<span class="cm"> * set CC by SPEC, CC = 3MHz/carrier - 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvt_set_tx_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">carrier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CIR_CP</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">3000000</span> <span class="o">/</span> <span class="p">(</span><span class="n">carrier</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">CIR_CC</span><span class="p">);</span>

	<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;cp: 0x%x cc: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_CP</span><span class="p">),</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_CC</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nvt_tx_ir</span>
<span class="cm"> *</span>
<span class="cm"> * 1) clean TX fifo first (handled by AP)</span>
<span class="cm"> * 2) copy data from user space</span>
<span class="cm"> * 3) disable RX interrupts, enable TX interrupts: TTR &amp; TFU</span>
<span class="cm"> * 4) send 9 packets to TX FIFO to open TTR</span>
<span class="cm"> * in interrupt_handler:</span>
<span class="cm"> * 5) send all data out</span>
<span class="cm"> * go back to write():</span>
<span class="cm"> * 6) disable TX interrupts, re-enable RX interupts</span>
<span class="cm"> *</span>
<span class="cm"> * The key problem of this function is user space data may larger than</span>
<span class="cm"> * driver&#39;s data buf length. So nvt_tx_ir() will only copy TX_BUF_LEN data to</span>
<span class="cm"> * buf, and keep current copied data buf num in cur_buf_num. But driver&#39;s buf</span>
<span class="cm"> * number may larger than TXFCONT (0xff). So in interrupt_handler, it has to</span>
<span class="cm"> * set TXFCONT as 0xff, until buf_count less than 0xff.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvt_tx_ir</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">txbuf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iren</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">TX_BUF_LEN</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)),</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">txbuf</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf_count</span><span class="p">);</span>

	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cur_buf_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* save currently enabled interrupts */</span>
	<span class="n">iren</span> <span class="o">=</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_IREN</span><span class="p">);</span>

	<span class="cm">/* now disable all interrupts, save TFU &amp; TTR */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_IREN_TFU</span> <span class="o">|</span> <span class="n">CIR_IREN_TTR</span><span class="p">,</span> <span class="n">CIR_IREN</span><span class="p">);</span>

	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">ST_TX_REPLY</span><span class="p">;</span>

	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_FIFOCON_TX_TRIGGER_LEV_8</span> <span class="o">|</span>
			  <span class="n">CIR_FIFOCON_RXFIFOCLR</span><span class="p">,</span> <span class="n">CIR_FIFOCON</span><span class="p">);</span>

	<span class="cm">/* trigger TTR interrupt by writing out ones, (yes, it&#39;s ugly) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">CIR_STXFIFO</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">==</span> <span class="n">ST_TX_REQUEST</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">ST_TX_NONE</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* restore enabled interrupts to prior state */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">iren</span><span class="p">,</span> <span class="n">CIR_IREN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* dump contents of the last rx buffer we got from the hw rx fifo */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_dump_rx_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s (len %d): &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">pkts</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">pkts</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_BUF_LEN</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;0x%02x &quot;</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process raw data in rx driver buffer, store it in raw IR event kfifo,</span>
<span class="cm"> * trigger decode when appropriate.</span>
<span class="cm"> *</span>
<span class="cm"> * We get IR data samples one byte at a time. If the msb is set, its a pulse,</span>
<span class="cm"> * otherwise its a space. The lower 7 bits are the count of SAMPLE_PERIOD</span>
<span class="cm"> * (default 50us) intervals for that pulse/space. A discrete signal is</span>
<span class="cm"> * followed by a series of 0x7f packets, then either 0x7&lt;something&gt; or 0x80</span>
<span class="cm"> * to signal more IR coming (repeats) or end of IR, respectively. We store</span>
<span class="cm"> * sample data in the raw event kfifo until we see 0x7&lt;something&gt; (except f)</span>
<span class="cm"> * or 0x80, at which time, we trigger a decode operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_process_rx_ir_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_IR_RAW_EVENT</span><span class="p">(</span><span class="n">rawir</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">carrier</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sample</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">nvt_dbg_verbose</span><span class="p">(</span><span class="s">&quot;%s firing&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">nvt_dump_rx_buf</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">carrier_detect_enabled</span><span class="p">)</span>
		<span class="n">carrier</span> <span class="o">=</span> <span class="n">nvt_rx_carrier_detect</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="n">nvt_dbg_verbose</span><span class="p">(</span><span class="s">&quot;Processing buffer of len %d&quot;</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">pkts</span><span class="p">);</span>

	<span class="n">init_ir_raw_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rawir</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">pkts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sample</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">rawir</span><span class="p">.</span><span class="n">pulse</span> <span class="o">=</span> <span class="p">((</span><span class="n">sample</span> <span class="o">&amp;</span> <span class="n">BUF_PULSE_BIT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rawir</span><span class="p">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">US_TO_NS</span><span class="p">((</span><span class="n">sample</span> <span class="o">&amp;</span> <span class="n">BUF_LEN_MASK</span><span class="p">)</span>
					  <span class="o">*</span> <span class="n">SAMPLE_PERIOD</span><span class="p">);</span>

		<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;Storing %s with duration %d&quot;</span><span class="p">,</span>
			<span class="n">rawir</span><span class="p">.</span><span class="n">pulse</span> <span class="o">?</span> <span class="s">&quot;pulse&quot;</span> <span class="o">:</span> <span class="s">&quot;space&quot;</span><span class="p">,</span> <span class="n">rawir</span><span class="p">.</span><span class="n">duration</span><span class="p">);</span>

		<span class="n">ir_raw_event_store_with_filter</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rawir</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * BUF_PULSE_BIT indicates end of IR data, BUF_REPEAT_BYTE</span>
<span class="cm">		 * indicates end of IR signal, but new data incoming. In both</span>
<span class="cm">		 * cases, it means we&#39;re ready to call ir_raw_event_handle</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sample</span> <span class="o">==</span> <span class="n">BUF_PULSE_BIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">pkts</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;Calling ir_raw_event_handle (signal end)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ir_raw_event_handle</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">pkts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;Calling ir_raw_event_handle (buffer empty)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ir_raw_event_handle</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>

	<span class="n">nvt_dbg_verbose</span><span class="p">(</span><span class="s">&quot;%s done&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_handle_rx_fifo_overrun</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nvt_pr</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;RX FIFO overrun detected, flushing data!&quot;</span><span class="p">);</span>

	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">pkts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nvt_clear_cir_fifo</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">ir_raw_event_reset</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* copy data from hardware rx fifo into driver buffer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_get_rx_ir_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fifocount</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">b_idx</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">overrun</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Get count of how many bytes to read from RX FIFO */</span>
	<span class="n">fifocount</span> <span class="o">=</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_RXFCONT</span><span class="p">);</span>
	<span class="cm">/* if we get 0xff, probably means the logical dev is disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifocount</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* watch out for a fifo overrun condition */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fifocount</span> <span class="o">&gt;</span> <span class="n">RX_BUF_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">overrun</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">fifocount</span> <span class="o">=</span> <span class="n">RX_BUF_LEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;attempting to fetch %u bytes from hw rx fifo&quot;</span><span class="p">,</span> <span class="n">fifocount</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">b_idx</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">pkts</span><span class="p">;</span>

	<span class="cm">/* This should never happen, but lets check anyway... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_idx</span> <span class="o">+</span> <span class="n">fifocount</span> <span class="o">&gt;</span> <span class="n">RX_BUF_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nvt_process_rx_ir_data</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
		<span class="n">b_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read fifocount bytes from CIR Sample RX FIFO register */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fifocount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_SRXFIFO</span><span class="p">);</span>
		<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">b_idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">pkts</span> <span class="o">+=</span> <span class="n">fifocount</span><span class="p">;</span>
	<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;%s: pkts now %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">pkts</span><span class="p">);</span>

	<span class="n">nvt_process_rx_ir_data</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overrun</span><span class="p">)</span>
		<span class="n">nvt_handle_rx_fifo_overrun</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_cir_log_irqs</span><span class="p">(</span><span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">u8</span> <span class="n">iren</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nvt_pr</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;IRQ 0x%02x (IREN 0x%02x) :%s%s%s%s%s%s%s%s%s&quot;</span><span class="p">,</span>
		<span class="n">status</span><span class="p">,</span> <span class="n">iren</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_IRSTS_RDR</span>	<span class="o">?</span> <span class="s">&quot; RDR&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_IRSTS_RTR</span>	<span class="o">?</span> <span class="s">&quot; RTR&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_IRSTS_PE</span>	<span class="o">?</span> <span class="s">&quot; PE&quot;</span>		<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_IRSTS_RFO</span>	<span class="o">?</span> <span class="s">&quot; RFO&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_IRSTS_TE</span>	<span class="o">?</span> <span class="s">&quot; TE&quot;</span>		<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_IRSTS_TTR</span>	<span class="o">?</span> <span class="s">&quot; TTR&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_IRSTS_TFU</span>	<span class="o">?</span> <span class="s">&quot; TFU&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_IRSTS_GH</span>	<span class="o">?</span> <span class="s">&quot; GH&quot;</span>		<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CIR_IRSTS_RDR</span> <span class="o">|</span> <span class="n">CIR_IRSTS_RTR</span> <span class="o">|</span> <span class="n">CIR_IRSTS_PE</span> <span class="o">|</span>
			   <span class="n">CIR_IRSTS_RFO</span> <span class="o">|</span> <span class="n">CIR_IRSTS_TE</span> <span class="o">|</span> <span class="n">CIR_IRSTS_TTR</span> <span class="o">|</span>
			   <span class="n">CIR_IRSTS_TFU</span> <span class="o">|</span> <span class="n">CIR_IRSTS_GH</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ?&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nvt_cir_tx_inactive</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tx_inactive</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_state</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tx_state</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_state</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tx_inactive</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_state</span> <span class="o">==</span> <span class="n">ST_TX_NONE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tx_inactive</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* interrupt service routine for incoming and outgoing CIR data */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nvt_cir_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">iren</span><span class="p">,</span> <span class="n">cur_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">nvt_dbg_verbose</span><span class="p">(</span><span class="s">&quot;%s firing&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">nvt_efm_enable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">nvt_select_logical_dev</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_CIR</span><span class="p">);</span>
	<span class="n">nvt_efm_disable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get IR Status register contents. Write 1 to ack/clear</span>
<span class="cm">	 *</span>
<span class="cm">	 * bit: reg name      - description</span>
<span class="cm">	 *   7: CIR_IRSTS_RDR - RX Data Ready</span>
<span class="cm">	 *   6: CIR_IRSTS_RTR - RX FIFO Trigger Level Reach</span>
<span class="cm">	 *   5: CIR_IRSTS_PE  - Packet End</span>
<span class="cm">	 *   4: CIR_IRSTS_RFO - RX FIFO Overrun (RDR will also be set)</span>
<span class="cm">	 *   3: CIR_IRSTS_TE  - TX FIFO Empty</span>
<span class="cm">	 *   2: CIR_IRSTS_TTR - TX FIFO Trigger Level Reach</span>
<span class="cm">	 *   1: CIR_IRSTS_TFU - TX FIFO Underrun</span>
<span class="cm">	 *   0: CIR_IRSTS_GH  - Min Length Detected</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_IRSTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nvt_dbg_verbose</span><span class="p">(</span><span class="s">&quot;%s exiting, IRSTS 0x0&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">CIR_IRSTS</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">IRQ_NONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ack/clear all irq flags we&#39;ve got */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">CIR_IRSTS</span><span class="p">);</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CIR_IRSTS</span><span class="p">);</span>

	<span class="cm">/* Interrupt may be shared with CIR Wake, bail if CIR not enabled */</span>
	<span class="n">iren</span> <span class="o">=</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_IREN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iren</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nvt_dbg_verbose</span><span class="p">(</span><span class="s">&quot;%s exiting, CIR not enabled&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">IRQ_NONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">nvt_cir_log_irqs</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">iren</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_IRSTS_RTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME: add code for study/learn mode */</span>
		<span class="cm">/* We only do rx if not tx&#39;ing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvt_cir_tx_inactive</span><span class="p">(</span><span class="n">nvt</span><span class="p">))</span>
			<span class="n">nvt_get_rx_ir_data</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_IRSTS_PE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvt_cir_tx_inactive</span><span class="p">(</span><span class="n">nvt</span><span class="p">))</span>
			<span class="n">nvt_get_rx_ir_data</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">cur_state</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">study_state</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur_state</span> <span class="o">==</span> <span class="n">ST_STUDY_NONE</span><span class="p">)</span>
			<span class="n">nvt_clear_cir_fifo</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_IRSTS_TE</span><span class="p">)</span>
		<span class="n">nvt_clear_tx_fifo</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_IRSTS_TTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">pos</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cur_buf_num</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf_count</span><span class="p">;</span>

		<span class="cm">/* Write data into the hardware tx fifo while pos &lt; count */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">CIR_STXFIFO</span><span class="p">);</span>
			<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cur_buf_num</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Disable TX FIFO Trigger Level Reach (TTR) interrupt */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">nvt_cir_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_IREN</span><span class="p">);</span>
			<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CIR_IREN_TTR</span><span class="p">,</span> <span class="n">CIR_IREN</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_IRSTS_TFU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">==</span> <span class="n">ST_TX_REPLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">ST_TX_REQUEST</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nvt_dbg_verbose</span><span class="p">(</span><span class="s">&quot;%s done&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">IRQ_HANDLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Interrupt service routine for CIR Wake */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nvt_cir_wake_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">iren</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">nvt_dbg_wake</span><span class="p">(</span><span class="s">&quot;%s firing&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_IRSTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">IRQ_NONE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_WAKE_IRSTS_IR_PENDING</span><span class="p">)</span>
		<span class="n">nvt_clear_cir_wake_fifo</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">CIR_WAKE_IRSTS</span><span class="p">);</span>
	<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CIR_WAKE_IRSTS</span><span class="p">);</span>

	<span class="cm">/* Interrupt may be shared with CIR, bail if Wake not enabled */</span>
	<span class="n">iren</span> <span class="o">=</span> <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_IREN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iren</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nvt_dbg_wake</span><span class="p">(</span><span class="s">&quot;%s exiting, wake not enabled&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">IRQ_HANDLED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CIR_WAKE_IRSTS_PE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">wake_state</span> <span class="o">==</span> <span class="n">ST_WAKE_START</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_RD_FIFO_ONLY_IDX</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">nvt_cir_wake_reg_read</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_WAKE_RD_FIFO_ONLY</span><span class="p">);</span>
			<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;setting wake up key: 0x%x&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">nvt_cir_wake_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CIR_WAKE_IREN</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">wake_state</span> <span class="o">=</span> <span class="n">ST_WAKE_FINISH</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nvt_dbg_wake</span><span class="p">(</span><span class="s">&quot;%s done&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">IRQ_HANDLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_enable_cir</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set function enable flags */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">CIR_IRCON_TXEN</span> <span class="o">|</span> <span class="n">CIR_IRCON_RXEN</span> <span class="o">|</span>
			  <span class="n">CIR_IRCON_RXINV</span> <span class="o">|</span> <span class="n">CIR_IRCON_SAMPLE_PERIOD_SEL</span><span class="p">,</span>
			  <span class="n">CIR_IRCON</span><span class="p">);</span>

	<span class="n">nvt_efm_enable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="cm">/* enable the CIR logical device */</span>
	<span class="n">nvt_select_logical_dev</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_CIR</span><span class="p">);</span>
	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_ENABLE</span><span class="p">,</span> <span class="n">CR_LOGICAL_DEV_EN</span><span class="p">);</span>

	<span class="n">nvt_efm_disable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="cm">/* clear all pending interrupts */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">CIR_IRSTS</span><span class="p">);</span>

	<span class="cm">/* enable interrupts */</span>
	<span class="n">nvt_set_cir_iren</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_disable_cir</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable CIR interrupts */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CIR_IREN</span><span class="p">);</span>

	<span class="cm">/* clear any and all pending interrupts */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">CIR_IRSTS</span><span class="p">);</span>

	<span class="cm">/* clear all function enable flags */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CIR_IRCON</span><span class="p">);</span>

	<span class="cm">/* clear hardware rx and tx fifos */</span>
	<span class="n">nvt_clear_cir_fifo</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">nvt_clear_tx_fifo</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="n">nvt_efm_enable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="cm">/* disable the CIR logical device */</span>
	<span class="n">nvt_select_logical_dev</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_CIR</span><span class="p">);</span>
	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_DISABLE</span><span class="p">,</span> <span class="n">CR_LOGICAL_DEV_EN</span><span class="p">);</span>

	<span class="n">nvt_efm_disable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvt_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nvt_enable_cir</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nvt_disable_cir</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Allocate memory, probe hardware, and initialize everything */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvt_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">nvt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvt_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nvt</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* input device for IR remote (and tx) */</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">rc_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="cm">/* validate pnp resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">pnp_port_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CIR_IOREG_LENGTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IR PNP Port not valid!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_irq_valid</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PNP IRQ not valid!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">pnp_port_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CIR_IOREG_LENGTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Wake PNP Port not valid!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_addr</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_irq</span>  <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_addr</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* irq is always shared between cir and cir wake */</span>
	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_irq</span>  <span class="o">=</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_irq</span><span class="p">;</span>

	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cr_efir</span> <span class="o">=</span> <span class="n">CR_EFIR</span><span class="p">;</span>
	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cr_efdr</span> <span class="o">=</span> <span class="n">CR_EFDR</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pnp_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nvt</span><span class="p">);</span>
	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nvt_hw_detect</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="cm">/* Initialize CIR &amp; CIR Wake Logical Devices */</span>
	<span class="n">nvt_efm_enable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">nvt_cir_ldev_init</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">nvt_cir_wake_ldev_init</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">nvt_efm_disable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="cm">/* Initialize CIR &amp; CIR Wake Config Registers */</span>
	<span class="n">nvt_cir_regs_init</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">nvt_cir_wake_regs_init</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="cm">/* Set up the rc device */</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">nvt</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">driver_type</span> <span class="o">=</span> <span class="n">RC_DRIVER_IR_RAW</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">RC_TYPE_ALL</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">nvt_open</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">nvt_close</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">tx_ir</span> <span class="o">=</span> <span class="n">nvt_tx_ir</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">s_tx_carrier</span> <span class="o">=</span> <span class="n">nvt_set_tx_carrier</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">=</span> <span class="s">&quot;Nuvoton w836x7hg Infrared Remote Transceiver&quot;</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_phys</span> <span class="o">=</span> <span class="s">&quot;nuvoton/cir0&quot;</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_HOST</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_WINBOND2</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">chip_major</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">-&gt;</span><span class="n">chip_minor</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">NVT_DRIVER_NAME</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">RC_MAP_RC6_MCE</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">MS_TO_NS</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="cm">/* rx resolution is hardwired to 50us atm, 1, 25, 100 also possible */</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rx_resolution</span> <span class="o">=</span> <span class="n">US_TO_NS</span><span class="p">(</span><span class="n">CIR_SAMPLE_PERIOD</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	rdev-&gt;min_timeout = XYZ;</span>
<span class="c">	rdev-&gt;max_timeout = XYZ;</span>
<span class="c">	/* tx bits */</span>
<span class="c">	rdev-&gt;tx_resolution = XYZ;</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="cm">/* now claim resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_addr</span><span class="p">,</span>
			    <span class="n">CIR_IOREG_LENGTH</span><span class="p">,</span> <span class="n">NVT_DRIVER_NAME</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_irq</span><span class="p">,</span> <span class="n">nvt_cir_isr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">NVT_DRIVER_NAME</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">nvt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failure2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_addr</span><span class="p">,</span>
			    <span class="n">CIR_IOREG_LENGTH</span><span class="p">,</span> <span class="n">NVT_DRIVER_NAME</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failure3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_irq</span><span class="p">,</span> <span class="n">nvt_cir_wake_isr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">NVT_DRIVER_NAME</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">nvt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failure4</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rc_register_device</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure5</span><span class="p">;</span>

	<span class="n">device_init_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="n">nvt_pr</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="s">&quot;driver has been successfully loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cir_dump_regs</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
		<span class="n">cir_wake_dump_regs</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failure5:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_irq</span><span class="p">,</span> <span class="n">nvt</span><span class="p">);</span>
<span class="nl">failure4:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_addr</span><span class="p">,</span> <span class="n">CIR_IOREG_LENGTH</span><span class="p">);</span>
<span class="nl">failure3:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_irq</span><span class="p">,</span> <span class="n">nvt</span><span class="p">);</span>
<span class="nl">failure2:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_addr</span><span class="p">,</span> <span class="n">CIR_IOREG_LENGTH</span><span class="p">);</span>
<span class="nl">failure:</span>
	<span class="n">rc_free_device</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">nvt_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span> <span class="o">=</span> <span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* disable CIR */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CIR_IREN</span><span class="p">);</span>
	<span class="n">nvt_disable_cir</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="cm">/* enable CIR Wake (for IR power-on) */</span>
	<span class="n">nvt_enable_wake</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* free resources */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_irq</span><span class="p">,</span> <span class="n">nvt</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_irq</span><span class="p">,</span> <span class="n">nvt</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_addr</span><span class="p">,</span> <span class="n">CIR_IOREG_LENGTH</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">cir_wake_addr</span><span class="p">,</span> <span class="n">CIR_IOREG_LENGTH</span><span class="p">);</span>

	<span class="n">rc_unregister_device</span><span class="p">(</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvt_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span> <span class="o">=</span> <span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;%s called&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* zero out misc state tracking */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">study_state</span> <span class="o">=</span> <span class="n">ST_STUDY_NONE</span><span class="p">;</span>
	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">wake_state</span> <span class="o">=</span> <span class="n">ST_WAKE_NONE</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">nvt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">ST_TX_NONE</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* disable all CIR interrupts */</span>
	<span class="n">nvt_cir_reg_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CIR_IREN</span><span class="p">);</span>

	<span class="n">nvt_efm_enable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="cm">/* disable cir logical dev */</span>
	<span class="n">nvt_select_logical_dev</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_CIR</span><span class="p">);</span>
	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_DISABLE</span><span class="p">,</span> <span class="n">CR_LOGICAL_DEV_EN</span><span class="p">);</span>

	<span class="n">nvt_efm_disable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="cm">/* make sure wake is enabled */</span>
	<span class="n">nvt_enable_wake</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvt_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span> <span class="o">=</span> <span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">nvt_dbg</span><span class="p">(</span><span class="s">&quot;%s called&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* open interrupt */</span>
	<span class="n">nvt_set_cir_iren</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="cm">/* Enable CIR logical device */</span>
	<span class="n">nvt_efm_enable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">nvt_select_logical_dev</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_CIR</span><span class="p">);</span>
	<span class="n">nvt_cr_write</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="n">LOGICAL_DEV_ENABLE</span><span class="p">,</span> <span class="n">CR_LOGICAL_DEV_EN</span><span class="p">);</span>

	<span class="n">nvt_efm_disable</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="n">nvt_cir_regs_init</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
	<span class="n">nvt_cir_wake_regs_init</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvt_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvt_dev</span> <span class="o">*</span><span class="n">nvt</span> <span class="o">=</span> <span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">nvt_enable_wake</span><span class="p">(</span><span class="n">nvt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="n">nvt_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;WEC0530&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* CIR */</span>
	<span class="p">{</span> <span class="s">&quot;NTN0530&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* CIR for new chip&#39;s pnp id*/</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_driver</span> <span class="n">nvt_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">NVT_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">nvt_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PNP_DRIVER_RES_DO_NOT_CHANGE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">nvt_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">nvt_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">nvt_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">nvt_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">nvt_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">nvt_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pnp_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nvt_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pnp_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvt_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Enable debugging output&quot;</span><span class="p">);</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pnp</span><span class="p">,</span> <span class="n">nvt_ids</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Nuvoton W83667HG-A &amp; W83677HG-I CIR driver&quot;</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jarod Wilson &lt;jarod@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">nvt_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">nvt_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
