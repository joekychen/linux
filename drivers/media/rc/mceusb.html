<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › rc › mceusb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mceusb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for USB Windows Media Center Ed. eHome Infrared Transceivers</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2010-2011, Jarod Wilson &lt;jarod@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the original lirc_mceusb and lirc_mceusb2 drivers, by Dan</span>
<span class="cm"> * Conti, Martin Blatter and Daniel Melander, the latter of which was</span>
<span class="cm"> * in turn also based on the lirc_atiusb driver by Paul Miller. The</span>
<span class="cm"> * two mce drivers were merged into one by Jarod Wilson, with transmit</span>
<span class="cm"> * support for the 1st-gen device added primarily by Patrick Calhoun,</span>
<span class="cm"> * with a bit of tweaks by Jarod. Debugging improvements and proper</span>
<span class="cm"> * support for what appears to be 3rd-gen hardware added by Jarod.</span>
<span class="cm"> * Initial port from lirc driver to ir-core drivery by Jarod, based</span>
<span class="cm"> * partially on a port to an earlier proposed IR infrastructure by</span>
<span class="cm"> * Jon Smirl, which included enhancements and simplifications to the</span>
<span class="cm"> * incoming IR buffer parsing routines.</span>
<span class="cm"> *</span>
<span class="cm"> * Updated in July of 2011 with the aid of Microsoft&#39;s official</span>
<span class="cm"> * remote/transceiver requirements and specification document, found at</span>
<span class="cm"> * download.microsoft.com, title</span>
<span class="cm"> * Windows-Media-Center-RC-IR-Collection-Green-Button-Specification-03-08-2011-V2.pdf</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/input.h&gt;</span>
<span class="cp">#include &lt;linux/pm_wakeup.h&gt;</span>
<span class="cp">#include &lt;media/rc-core.h&gt;</span>

<span class="cp">#define DRIVER_VERSION	&quot;1.92&quot;</span>
<span class="cp">#define DRIVER_AUTHOR	&quot;Jarod Wilson &lt;jarod@redhat.com&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC	&quot;Windows Media Center Ed. eHome Infrared Transceiver &quot; \</span>
<span class="cp">			&quot;device driver&quot;</span>
<span class="cp">#define DRIVER_NAME	&quot;mceusb&quot;</span>

<span class="cp">#define USB_BUFLEN		32 </span><span class="cm">/* USB reception buffer length */</span><span class="cp"></span>
<span class="cp">#define USB_CTRL_MSG_SZ		2  </span><span class="cm">/* Size of usb ctrl msg on gen1 hw */</span><span class="cp"></span>
<span class="cp">#define MCE_G1_INIT_MSGS	40 </span><span class="cm">/* Init messages on gen1 hw to throw out */</span><span class="cp"></span>

<span class="cm">/* MCE constants */</span>
<span class="cp">#define MCE_CMDBUF_SIZE		384  </span><span class="cm">/* MCE Command buffer length */</span><span class="cp"></span>
<span class="cp">#define MCE_TIME_UNIT		50   </span><span class="cm">/* Approx 50us resolution */</span><span class="cp"></span>
<span class="cp">#define MCE_CODE_LENGTH		5    </span><span class="cm">/* Normal length of packet (with header) */</span><span class="cp"></span>
<span class="cp">#define MCE_PACKET_SIZE		4    </span><span class="cm">/* Normal length of packet (without header) */</span><span class="cp"></span>
<span class="cp">#define MCE_IRDATA_HEADER	0x84 </span><span class="cm">/* Actual header format is 0x80 + num_bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_IRDATA_TRAILER	0x80 </span><span class="cm">/* End of IR data */</span><span class="cp"></span>
<span class="cp">#define MCE_TX_HEADER_LENGTH	3    </span><span class="cm">/* # of bytes in the initializing tx header */</span><span class="cp"></span>
<span class="cp">#define MCE_MAX_CHANNELS	2    </span><span class="cm">/* Two transmitters, hardware dependent? */</span><span class="cp"></span>
<span class="cp">#define MCE_DEFAULT_TX_MASK	0x03 </span><span class="cm">/* Vals: TX1=0x01, TX2=0x02, ALL=0x03 */</span><span class="cp"></span>
<span class="cp">#define MCE_PULSE_BIT		0x80 </span><span class="cm">/* Pulse bit, MSB set == PULSE else SPACE */</span><span class="cp"></span>
<span class="cp">#define MCE_PULSE_MASK		0x7f </span><span class="cm">/* Pulse mask */</span><span class="cp"></span>
<span class="cp">#define MCE_MAX_PULSE_LENGTH	0x7f </span><span class="cm">/* Longest transmittable pulse symbol */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * The interface between the host and the IR hardware is command-response</span>
<span class="cm"> * based. All commands and responses have a consistent format, where a lead</span>
<span class="cm"> * byte always identifies the type of data following it. The lead byte has</span>
<span class="cm"> * a port value in the 3 highest bits and a length value in the 5 lowest</span>
<span class="cm"> * bits.</span>
<span class="cm"> *</span>
<span class="cm"> * The length field is overloaded, with a value of 11111 indicating that the</span>
<span class="cm"> * following byte is a command or response code, and the length of the entire</span>
<span class="cm"> * message is determined by the code. If the length field is not 11111, then</span>
<span class="cm"> * it specifies the number of bytes of port data that follow.</span>
<span class="cm"> */</span>
<span class="cp">#define MCE_CMD			0x1f</span>
<span class="cp">#define MCE_PORT_IR		0x4	</span><span class="cm">/* (0x4 &lt;&lt; 5) | MCE_CMD = 0x9f */</span><span class="cp"></span>
<span class="cp">#define MCE_PORT_SYS		0x7	</span><span class="cm">/* (0x7 &lt;&lt; 5) | MCE_CMD = 0xff */</span><span class="cp"></span>
<span class="cp">#define MCE_PORT_SER		0x6	</span><span class="cm">/* 0xc0 thru 0xdf flush &amp; 0x1f bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_PORT_MASK	0xe0	</span><span class="cm">/* Mask out command bits */</span><span class="cp"></span>

<span class="cm">/* Command port headers */</span>
<span class="cp">#define MCE_CMD_PORT_IR		0x9f	</span><span class="cm">/* IR-related cmd/rsp */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_PORT_SYS	0xff	</span><span class="cm">/* System (non-IR) device cmd/rsp */</span><span class="cp"></span>

<span class="cm">/* Commands that set device state  (2-4 bytes in length) */</span>
<span class="cp">#define MCE_CMD_RESET		0xfe	</span><span class="cm">/* Reset device, 2 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_RESUME		0xaa	</span><span class="cm">/* Resume device after error, 2 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_SETIRCFS	0x06	</span><span class="cm">/* Set tx carrier, 4 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_SETIRTIMEOUT	0x0c	</span><span class="cm">/* Set timeout, 4 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_SETIRTXPORTS	0x08	</span><span class="cm">/* Set tx ports, 3 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_SETIRRXPORTEN	0x14	</span><span class="cm">/* Set rx ports, 3 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_FLASHLED	0x23	</span><span class="cm">/* Flash receiver LED, 2 bytes */</span><span class="cp"></span>

<span class="cm">/* Commands that query device state (all 2 bytes, unless noted) */</span>
<span class="cp">#define MCE_CMD_GETIRCFS	0x07	</span><span class="cm">/* Get carrier */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_GETIRTIMEOUT	0x0d	</span><span class="cm">/* Get timeout */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_GETIRTXPORTS	0x13	</span><span class="cm">/* Get tx ports */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_GETIRRXPORTEN	0x15	</span><span class="cm">/* Get rx ports */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_GETPORTSTATUS	0x11	</span><span class="cm">/* Get tx port status, 3 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_GETIRNUMPORTS	0x16	</span><span class="cm">/* Get number of ports */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_GETWAKESOURCE	0x17	</span><span class="cm">/* Get wake source */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_GETEMVER	0x22	</span><span class="cm">/* Get emulator interface version */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_GETDEVDETAILS	0x21	</span><span class="cm">/* Get device details (em ver2 only) */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_GETWAKESUPPORT	0x20	</span><span class="cm">/* Get wake details (em ver2 only) */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_GETWAKEVERSION	0x18	</span><span class="cm">/* Get wake pattern (em ver2 only) */</span><span class="cp"></span>

<span class="cm">/* Misc commands */</span>
<span class="cp">#define MCE_CMD_NOP		0xff	</span><span class="cm">/* No operation */</span><span class="cp"></span>

<span class="cm">/* Responses to commands (non-error cases) */</span>
<span class="cp">#define MCE_RSP_EQIRCFS		0x06	</span><span class="cm">/* tx carrier, 4 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_RSP_EQIRTIMEOUT	0x0c	</span><span class="cm">/* rx timeout, 4 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_RSP_GETWAKESOURCE	0x17	</span><span class="cm">/* wake source, 3 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_RSP_EQIRTXPORTS	0x08	</span><span class="cm">/* tx port mask, 3 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_RSP_EQIRRXPORTEN	0x14	</span><span class="cm">/* rx port mask, 3 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_RSP_GETPORTSTATUS	0x11	</span><span class="cm">/* tx port status, 7 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_RSP_EQIRRXCFCNT	0x15	</span><span class="cm">/* rx carrier count, 4 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_RSP_EQIRNUMPORTS	0x16	</span><span class="cm">/* number of ports, 4 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_RSP_EQWAKESUPPORT	0x20	</span><span class="cm">/* wake capabilities, 3 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_RSP_EQWAKEVERSION	0x18	</span><span class="cm">/* wake pattern details, 6 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_RSP_EQDEVDETAILS	0x21	</span><span class="cm">/* device capabilities, 3 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_RSP_EQEMVER		0x22	</span><span class="cm">/* emulator interface ver, 3 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_RSP_FLASHLED	0x23	</span><span class="cm">/* success flashing LED, 2 bytes */</span><span class="cp"></span>

<span class="cm">/* Responses to error cases, must send MCE_CMD_RESUME to clear them */</span>
<span class="cp">#define MCE_RSP_CMD_ILLEGAL	0xfe	</span><span class="cm">/* illegal command for port, 2 bytes */</span><span class="cp"></span>
<span class="cp">#define MCE_RSP_TX_TIMEOUT	0x81	</span><span class="cm">/* tx timed out, 2 bytes */</span><span class="cp"></span>

<span class="cm">/* Misc commands/responses not defined in the MCE remote/transceiver spec */</span>
<span class="cp">#define MCE_CMD_SIG_END		0x01	</span><span class="cm">/* End of signal */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_PING		0x03	</span><span class="cm">/* Ping device */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_UNKNOWN		0x04	</span><span class="cm">/* Unknown */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_UNKNOWN2	0x05	</span><span class="cm">/* Unknown */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_UNKNOWN3	0x09	</span><span class="cm">/* Unknown */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_UNKNOWN4	0x0a	</span><span class="cm">/* Unknown */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_G_REVISION	0x0b	</span><span class="cm">/* Get hw/sw revision */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_UNKNOWN5	0x0e	</span><span class="cm">/* Unknown */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_UNKNOWN6	0x0f	</span><span class="cm">/* Unknown */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_UNKNOWN8	0x19	</span><span class="cm">/* Unknown */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_UNKNOWN9	0x1b	</span><span class="cm">/* Unknown */</span><span class="cp"></span>
<span class="cp">#define MCE_CMD_NULL		0x00	</span><span class="cm">/* These show up various places... */</span><span class="cp"></span>

<span class="cm">/* if buf[i] &amp; MCE_PORT_MASK == 0x80 and buf[i] != MCE_CMD_PORT_IR,</span>
<span class="cm"> * then we&#39;re looking at a raw IR data sample */</span>
<span class="cp">#define MCE_COMMAND_IRDATA	0x80</span>
<span class="cp">#define MCE_PACKET_LENGTH_MASK	0x1f </span><span class="cm">/* Packet length mask */</span><span class="cp"></span>

<span class="cm">/* module parameters */</span>
<span class="cp">#ifdef CONFIG_USB_DEBUG</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define mce_dbg(dev, fmt, ...)					\</span>
<span class="cp">	do {							\</span>
<span class="cp">		if (debug)					\</span>
<span class="cp">			dev_info(dev, fmt, ## __VA_ARGS__);	\</span>
<span class="cp">	} while (0)</span>

<span class="cm">/* general constants */</span>
<span class="cp">#define SEND_FLAG_IN_PROGRESS	1</span>
<span class="cp">#define SEND_FLAG_COMPLETE	2</span>
<span class="cp">#define RECV_FLAG_IN_PROGRESS	3</span>
<span class="cp">#define RECV_FLAG_COMPLETE	4</span>

<span class="cp">#define MCEUSB_RX		1</span>
<span class="cp">#define MCEUSB_TX		2</span>

<span class="cp">#define VENDOR_PHILIPS		0x0471</span>
<span class="cp">#define VENDOR_SMK		0x0609</span>
<span class="cp">#define VENDOR_TATUNG		0x1460</span>
<span class="cp">#define VENDOR_GATEWAY		0x107b</span>
<span class="cp">#define VENDOR_SHUTTLE		0x1308</span>
<span class="cp">#define VENDOR_SHUTTLE2		0x051c</span>
<span class="cp">#define VENDOR_MITSUMI		0x03ee</span>
<span class="cp">#define VENDOR_TOPSEED		0x1784</span>
<span class="cp">#define VENDOR_RICAVISION	0x179d</span>
<span class="cp">#define VENDOR_ITRON		0x195d</span>
<span class="cp">#define VENDOR_FIC		0x1509</span>
<span class="cp">#define VENDOR_LG		0x043e</span>
<span class="cp">#define VENDOR_MICROSOFT	0x045e</span>
<span class="cp">#define VENDOR_FORMOSA		0x147a</span>
<span class="cp">#define VENDOR_FINTEK		0x1934</span>
<span class="cp">#define VENDOR_PINNACLE		0x2304</span>
<span class="cp">#define VENDOR_ECS		0x1019</span>
<span class="cp">#define VENDOR_WISTRON		0x0fb8</span>
<span class="cp">#define VENDOR_COMPRO		0x185b</span>
<span class="cp">#define VENDOR_NORTHSTAR	0x04eb</span>
<span class="cp">#define VENDOR_REALTEK		0x0bda</span>
<span class="cp">#define VENDOR_TIVO		0x105a</span>
<span class="cp">#define VENDOR_CONEXANT		0x0572</span>

<span class="k">enum</span> <span class="n">mceusb_model_type</span> <span class="p">{</span>
	<span class="n">MCE_GEN2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* Most boards */</span>
	<span class="n">MCE_GEN1</span><span class="p">,</span>
	<span class="n">MCE_GEN3</span><span class="p">,</span>
	<span class="n">MCE_GEN2_TX_INV</span><span class="p">,</span>
	<span class="n">POLARIS_EVK</span><span class="p">,</span>
	<span class="n">CX_HYBRID_TV</span><span class="p">,</span>
	<span class="n">MULTIFUNCTION</span><span class="p">,</span>
	<span class="n">TIVO_KIT</span><span class="p">,</span>
	<span class="n">MCE_GEN2_NO_TX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mceusb_model</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">mce_gen1</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mce_gen2</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mce_gen3</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_mask_normal</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">no_tx</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ir_intfnum</span><span class="p">;</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rc_map</span><span class="p">;</span>	<span class="cm">/* Allow specify a per-board map */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>	<span class="cm">/* per-board name */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mceusb_model</span> <span class="n">mceusb_model</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">MCE_GEN1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mce_gen1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tx_mask_normal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">MCE_GEN2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mce_gen2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">MCE_GEN2_NO_TX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mce_gen2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">no_tx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">MCE_GEN2_TX_INV</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mce_gen2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tx_mask_normal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">MCE_GEN3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mce_gen3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tx_mask_normal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">POLARIS_EVK</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * In fact, the EVK is shipped without</span>
<span class="cm">		 * remotes, but we should have something handy,</span>
<span class="cm">		 * to allow testing it</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">rc_map</span> <span class="o">=</span> <span class="n">RC_MAP_HAUPPAUGE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Conexant Hybrid TV (cx231xx) MCE IR&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">CX_HYBRID_TV</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">no_tx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* tx isn&#39;t wired up at all */</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Conexant Hybrid TV (cx231xx) MCE IR&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">MULTIFUNCTION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mce_gen2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ir_intfnum</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">TIVO_KIT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mce_gen2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_map</span> <span class="o">=</span> <span class="n">RC_MAP_TIVO</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">mceusb_dev_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Original Microsoft MCE IR Transceiver (often HP-branded) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_MICROSOFT</span><span class="p">,</span> <span class="mh">0x006d</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN1</span> <span class="p">},</span>
	<span class="cm">/* Philips Infrared Transceiver - Sahara branded */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_PHILIPS</span><span class="p">,</span> <span class="mh">0x0608</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Philips Infrared Transceiver - HP branded */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_PHILIPS</span><span class="p">,</span> <span class="mh">0x060c</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN2_TX_INV</span> <span class="p">},</span>
	<span class="cm">/* Philips SRM5100 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_PHILIPS</span><span class="p">,</span> <span class="mh">0x060d</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Philips Infrared Transceiver - Omaura */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_PHILIPS</span><span class="p">,</span> <span class="mh">0x060f</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Philips Infrared Transceiver - Spinel plus */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_PHILIPS</span><span class="p">,</span> <span class="mh">0x0613</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Philips eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_PHILIPS</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Philips/Spinel plus IR transceiver for ASUS */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_PHILIPS</span><span class="p">,</span> <span class="mh">0x206c</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Philips/Spinel plus IR transceiver for ASUS */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_PHILIPS</span><span class="p">,</span> <span class="mh">0x2088</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Philips IR transceiver (Dell branded) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_PHILIPS</span><span class="p">,</span> <span class="mh">0x2093</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Realtek MCE IR Receiver and card reader */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_REALTEK</span><span class="p">,</span> <span class="mh">0x0161</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MULTIFUNCTION</span> <span class="p">},</span>
	<span class="cm">/* SMK/Toshiba G83C0004D410 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_SMK</span><span class="p">,</span> <span class="mh">0x031d</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN2_TX_INV</span> <span class="p">},</span>
	<span class="cm">/* SMK eHome Infrared Transceiver (Sony VAIO) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_SMK</span><span class="p">,</span> <span class="mh">0x0322</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN2_TX_INV</span> <span class="p">},</span>
	<span class="cm">/* bundled with Hauppauge PVR-150 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_SMK</span><span class="p">,</span> <span class="mh">0x0334</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN2_TX_INV</span> <span class="p">},</span>
	<span class="cm">/* SMK eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_SMK</span><span class="p">,</span> <span class="mh">0x0338</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* SMK/I-O Data GV-MC7/RCKIT Receiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_SMK</span><span class="p">,</span> <span class="mh">0x0353</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN2_NO_TX</span> <span class="p">},</span>
	<span class="cm">/* Tatung eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_TATUNG</span><span class="p">,</span> <span class="mh">0x9150</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Shuttle eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_SHUTTLE</span><span class="p">,</span> <span class="mh">0xc001</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Shuttle eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_SHUTTLE2</span><span class="p">,</span> <span class="mh">0xc001</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Gateway eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_GATEWAY</span><span class="p">,</span> <span class="mh">0x3009</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Mitsumi */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_MITSUMI</span><span class="p">,</span> <span class="mh">0x2501</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Topseed eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_TOPSEED</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN2_TX_INV</span> <span class="p">},</span>
	<span class="cm">/* Topseed HP eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_TOPSEED</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN2_TX_INV</span> <span class="p">},</span>
	<span class="cm">/* Topseed eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_TOPSEED</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN2_TX_INV</span> <span class="p">},</span>
	<span class="cm">/* Topseed eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_TOPSEED</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN3</span> <span class="p">},</span>
	<span class="cm">/* Topseed eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_TOPSEED</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN2_TX_INV</span> <span class="p">},</span>
	<span class="cm">/* Topseed eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_TOPSEED</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN3</span> <span class="p">},</span>
	<span class="cm">/* Ricavision internal Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_RICAVISION</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Itron ione Libra Q-11 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_ITRON</span><span class="p">,</span> <span class="mh">0x7002</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* FIC eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_FIC</span><span class="p">,</span> <span class="mh">0x9242</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* LG eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_LG</span><span class="p">,</span> <span class="mh">0x9803</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Microsoft MCE Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_MICROSOFT</span><span class="p">,</span> <span class="mh">0x00a0</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Formosa eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_FORMOSA</span><span class="p">,</span> <span class="mh">0xe015</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Formosa21 / eHome Infrared Receiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_FORMOSA</span><span class="p">,</span> <span class="mh">0xe016</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Formosa aim / Trust MCE Infrared Receiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_FORMOSA</span><span class="p">,</span> <span class="mh">0xe017</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN2_NO_TX</span> <span class="p">},</span>
	<span class="cm">/* Formosa Industrial Computing / Beanbag Emulation Device */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_FORMOSA</span><span class="p">,</span> <span class="mh">0xe018</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Formosa21 / eHome Infrared Receiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_FORMOSA</span><span class="p">,</span> <span class="mh">0xe03a</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Formosa Industrial Computing AIM IR605/A */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_FORMOSA</span><span class="p">,</span> <span class="mh">0xe03c</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Formosa Industrial Computing */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_FORMOSA</span><span class="p">,</span> <span class="mh">0xe03e</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Formosa Industrial Computing */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_FORMOSA</span><span class="p">,</span> <span class="mh">0xe042</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Fintek eHome Infrared Transceiver (HP branded) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_FINTEK</span><span class="p">,</span> <span class="mh">0x5168</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Fintek eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_FINTEK</span><span class="p">,</span> <span class="mh">0x0602</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Fintek eHome Infrared Transceiver (in the AOpen MP45) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_FINTEK</span><span class="p">,</span> <span class="mh">0x0702</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Pinnacle Remote Kit */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_PINNACLE</span><span class="p">,</span> <span class="mh">0x0225</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">MCE_GEN3</span> <span class="p">},</span>
	<span class="cm">/* Elitegroup Computer Systems IR */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_ECS</span><span class="p">,</span> <span class="mh">0x0f38</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Wistron Corp. eHome Infrared Receiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_WISTRON</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Compro K100 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_COMPRO</span><span class="p">,</span> <span class="mh">0x3020</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Compro K100 v2 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_COMPRO</span><span class="p">,</span> <span class="mh">0x3082</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Northstar Systems, Inc. eHome Infrared Transceiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_NORTHSTAR</span><span class="p">,</span> <span class="mh">0xe004</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* TiVo PC IR Receiver */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_TIVO</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">TIVO_KIT</span> <span class="p">},</span>
	<span class="cm">/* Conexant Hybrid TV &quot;Shelby&quot; Polaris SDK */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_CONEXANT</span><span class="p">,</span> <span class="mh">0x58a1</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">POLARIS_EVK</span> <span class="p">},</span>
	<span class="cm">/* Conexant Hybrid TV RDU253S Polaris */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_CONEXANT</span><span class="p">,</span> <span class="mh">0x58a5</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">CX_HYBRID_TV</span> <span class="p">},</span>
	<span class="cm">/* Terminating entry */</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* data structure for each usb transceiver */</span>
<span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="p">{</span>
	<span class="cm">/* ir-core bits */</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* optional features we can enable */</span>
	<span class="n">bool</span> <span class="n">carrier_report_enabled</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">learning_enabled</span><span class="p">;</span>

	<span class="cm">/* core device bits */</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* usb */</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb_in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">usb_ep_in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">usb_ep_out</span><span class="p">;</span>

	<span class="cm">/* buffers and dma */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf_in</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len_in</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_in</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_out</span><span class="p">;</span>

	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">CMD_HEADER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">SUBCMD</span><span class="p">,</span>
		<span class="n">CMD_DATA</span><span class="p">,</span>
		<span class="n">PARSE_IRDATA</span><span class="p">,</span>
	<span class="p">}</span> <span class="n">parser_state</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">rem</span><span class="p">;</span>		<span class="cm">/* Remaining IR data bytes in packet */</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">connected</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">tx_mask_normal</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">microsoft_gen1</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">no_tx</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* transmit support */</span>
	<span class="kt">int</span> <span class="n">send_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">carrier</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tx_mask</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">mceusb_model_type</span> <span class="n">model</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">need_reset</span><span class="p">;</span>	<span class="cm">/* flag to issue a device resume cmd */</span>
	<span class="n">u8</span> <span class="n">emver</span><span class="p">;</span>		<span class="cm">/* emulator interface version */</span>
	<span class="n">u8</span> <span class="n">num_txports</span><span class="p">;</span>		<span class="cm">/* number of transmit ports */</span>
	<span class="n">u8</span> <span class="n">num_rxports</span><span class="p">;</span>		<span class="cm">/* number of receive sensors */</span>
	<span class="n">u8</span> <span class="n">txports_cabled</span><span class="p">;</span>	<span class="cm">/* bitmask of transmitters with cable */</span>
	<span class="n">u8</span> <span class="n">rxports_active</span><span class="p">;</span>	<span class="cm">/* bitmask of active receive sensors */</span>
<span class="p">};</span>

<span class="cm">/* MCE Device Command Strings, generally a port and command pair */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">DEVICE_RESUME</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span><span class="n">MCE_CMD_NULL</span><span class="p">,</span> <span class="n">MCE_CMD_PORT_SYS</span><span class="p">,</span>
				   <span class="n">MCE_CMD_RESUME</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">GET_REVISION</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span><span class="n">MCE_CMD_PORT_SYS</span><span class="p">,</span> <span class="n">MCE_CMD_G_REVISION</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">GET_EMVER</span><span class="p">[]</span>		<span class="o">=</span> <span class="p">{</span><span class="n">MCE_CMD_PORT_SYS</span><span class="p">,</span> <span class="n">MCE_CMD_GETEMVER</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">GET_WAKEVERSION</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span><span class="n">MCE_CMD_PORT_SYS</span><span class="p">,</span> <span class="n">MCE_CMD_GETWAKEVERSION</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">FLASH_LED</span><span class="p">[]</span>		<span class="o">=</span> <span class="p">{</span><span class="n">MCE_CMD_PORT_SYS</span><span class="p">,</span> <span class="n">MCE_CMD_FLASHLED</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">GET_UNKNOWN2</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span><span class="n">MCE_CMD_PORT_IR</span><span class="p">,</span> <span class="n">MCE_CMD_UNKNOWN2</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">GET_CARRIER_FREQ</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span><span class="n">MCE_CMD_PORT_IR</span><span class="p">,</span> <span class="n">MCE_CMD_GETIRCFS</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">GET_RX_TIMEOUT</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span><span class="n">MCE_CMD_PORT_IR</span><span class="p">,</span> <span class="n">MCE_CMD_GETIRTIMEOUT</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">GET_NUM_PORTS</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span><span class="n">MCE_CMD_PORT_IR</span><span class="p">,</span> <span class="n">MCE_CMD_GETIRNUMPORTS</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">GET_TX_BITMASK</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span><span class="n">MCE_CMD_PORT_IR</span><span class="p">,</span> <span class="n">MCE_CMD_GETIRTXPORTS</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">GET_RX_SENSOR</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span><span class="n">MCE_CMD_PORT_IR</span><span class="p">,</span> <span class="n">MCE_CMD_GETIRRXPORTEN</span><span class="p">};</span>
<span class="cm">/* sub in desired values in lower byte or bytes for full command */</span>
<span class="cm">/* FIXME: make use of these for transmit.</span>
<span class="cm">static char SET_CARRIER_FREQ[]	= {MCE_CMD_PORT_IR,</span>
<span class="cm">				   MCE_CMD_SETIRCFS, 0x00, 0x00};</span>
<span class="cm">static char SET_TX_BITMASK[]	= {MCE_CMD_PORT_IR, MCE_CMD_SETIRTXPORTS, 0x00};</span>
<span class="cm">static char SET_RX_TIMEOUT[]	= {MCE_CMD_PORT_IR,</span>
<span class="cm">				   MCE_CMD_SETIRTIMEOUT, 0x00, 0x00};</span>
<span class="cm">static char SET_RX_SENSOR[]	= {MCE_CMD_PORT_IR,</span>
<span class="cm">				   MCE_RSP_EQIRRXPORTEN, 0x00};</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mceusb_cmdsize</span><span class="p">(</span><span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">subcmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">datasize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MCE_CMD_NULL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">subcmd</span> <span class="o">==</span> <span class="n">MCE_CMD_PORT_SYS</span><span class="p">)</span>
			<span class="n">datasize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCE_CMD_PORT_SYS</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">subcmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MCE_RSP_EQWAKEVERSION</span>:
			<span class="n">datasize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_CMD_G_REVISION</span>:
			<span class="n">datasize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_RSP_EQWAKESUPPORT</span>:
			<span class="n">datasize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">MCE_CMD_PORT_IR</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">subcmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MCE_CMD_UNKNOWN</span>:
		<span class="k">case</span> <span class="n">MCE_RSP_EQIRCFS</span>:
		<span class="k">case</span> <span class="n">MCE_RSP_EQIRTIMEOUT</span>:
		<span class="k">case</span> <span class="n">MCE_RSP_EQIRRXCFCNT</span>:
			<span class="n">datasize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_CMD_SIG_END</span>:
		<span class="k">case</span> <span class="n">MCE_RSP_EQIRTXPORTS</span>:
		<span class="k">case</span> <span class="n">MCE_RSP_EQIRRXPORTEN</span>:
			<span class="n">datasize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">datasize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mceusb_dev_printdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">bool</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">codes</span><span class="p">[</span><span class="n">USB_BUFLEN</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">inout</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">subcmd</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">data4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">carrier</span><span class="p">,</span> <span class="n">period</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* skip meaningless 0xb1 0x60 header bytes on orig receiver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">microsoft_gen1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">out</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">offset</span><span class="p">)</span>
		<span class="n">skip</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">skip</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">USB_BUFLEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">codes</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">offset</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%sx data: %s(length=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">out</span> <span class="o">?</span> <span class="s">&quot;t&quot;</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">),</span> <span class="n">codes</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">inout</span><span class="p">,</span> <span class="s">&quot;Request</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">inout</span><span class="p">,</span> <span class="s">&quot;Got</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">start</span>  <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">skip</span><span class="p">;</span>
	<span class="n">cmd</span>    <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">subcmd</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data1</span>  <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data2</span>  <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data3</span>  <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data4</span>  <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MCE_CMD_NULL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">subcmd</span> <span class="o">==</span> <span class="n">MCE_CMD_NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">subcmd</span> <span class="o">==</span> <span class="n">MCE_CMD_PORT_SYS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">data1</span> <span class="o">==</span> <span class="n">MCE_CMD_RESUME</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device resume requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown command 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">cmd</span><span class="p">,</span> <span class="n">subcmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCE_CMD_PORT_SYS</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">subcmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MCE_RSP_EQEMVER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out</span><span class="p">)</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Emulator interface version %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">data1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_CMD_G_REVISION</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Get hw/sw rev?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hw/sw rev 0x%02x 0x%02x &quot;</span>
					 <span class="s">&quot;0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span>
					 <span class="n">buf</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">4</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_CMD_RESUME</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device resume requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_RSP_CMD_ILLEGAL</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Illegal PORT_SYS command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_RSP_EQWAKEVERSION</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out</span><span class="p">)</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Wake version, proto: 0x%02x, &quot;</span>
					 <span class="s">&quot;payload: 0x%02x, address: 0x%02x, &quot;</span>
					 <span class="s">&quot;version: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">data4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_RSP_GETPORTSTATUS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out</span><span class="p">)</span>
				<span class="cm">/* We use data1 + 1 here, to match hw labels */</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX port %d: blaster is%s connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">data1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data4</span> <span class="o">?</span> <span class="s">&quot; not&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_CMD_FLASHLED</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Attempting to flash LED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown command 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">cmd</span><span class="p">,</span> <span class="n">subcmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCE_CMD_PORT_IR</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">subcmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MCE_CMD_SIG_END</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;End of signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_CMD_PING</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_CMD_UNKNOWN</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Resp to 9f 05 of 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_RSP_EQIRCFS</span>:
			<span class="n">period</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span>
					<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">data1</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">data2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">period</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">carrier</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">period</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s carrier of %u Hz (period %uus)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">inout</span><span class="p">,</span> <span class="n">carrier</span><span class="p">,</span> <span class="n">period</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_CMD_GETIRCFS</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Get carrier mode and freq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_RSP_EQIRTXPORTS</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s transmit blaster mask of 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">inout</span><span class="p">,</span> <span class="n">data1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_RSP_EQIRTIMEOUT</span>:
			<span class="cm">/* value is in units of 50us, so x*50/1000 ms */</span>
			<span class="n">period</span> <span class="o">=</span> <span class="p">((</span><span class="n">data1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data2</span><span class="p">)</span> <span class="o">*</span> <span class="n">MCE_TIME_UNIT</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s receive timeout of %d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">inout</span><span class="p">,</span> <span class="n">period</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_CMD_GETIRTIMEOUT</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Get receive timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_CMD_GETIRTXPORTS</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Get transmit blaster mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_RSP_EQIRRXPORTEN</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %s-range receive sensor in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">inout</span><span class="p">,</span> <span class="n">data1</span> <span class="o">==</span> <span class="mh">0x02</span> <span class="o">?</span> <span class="s">&quot;short&quot;</span> <span class="o">:</span> <span class="s">&quot;long&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_CMD_GETIRRXPORTEN</span>:
		<span class="cm">/* aka MCE_RSP_EQIRRXCFCNT */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Get receive sensor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">learning_enabled</span><span class="p">)</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX pulse count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="p">((</span><span class="n">data1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data2</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_RSP_EQIRNUMPORTS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Num TX ports: %x, num RX ports: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MCE_RSP_CMD_ILLEGAL</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Illegal PORT_IR command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown command 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">cmd</span><span class="p">,</span> <span class="n">subcmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MCE_IRDATA_TRAILER</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;End of raw IR data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">MCE_CMD_PORT_IR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">MCE_PORT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MCE_COMMAND_IRDATA</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Raw IR data, %d pulse/space samples</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">rem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mce_async_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ir</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>

		<span class="n">mceusb_dev_printdata</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* the transfer buffer and urb were allocated in mce_request_packet */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* request incoming or send outgoing usb packet - used to initialize remote */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mce_request_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">urb_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">async_urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">async_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb_type</span> <span class="o">==</span> <span class="n">MCEUSB_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">async_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">async_urb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error, couldn&#39;t allocate urb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">async_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">async_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error, couldn&#39;t allocate buf!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">async_urb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* outbound data */</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndintpipe</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
				      <span class="n">ir</span><span class="o">-&gt;</span><span class="n">usb_ep_out</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
		<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">async_urb</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span>
			<span class="n">async_buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span><span class="n">mce_async_callback</span><span class="p">,</span>
			<span class="n">ir</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">usb_ep_out</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">async_buf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">urb_type</span> <span class="o">==</span> <span class="n">MCEUSB_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* standard request */</span>
		<span class="n">async_urb</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">urb_in</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">RECV_FLAG_IN_PROGRESS</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error! Unknown urb type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb_type</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mce_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;receive request called (size=%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">async_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">async_urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">async_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mce_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;receive request FAILED! (res=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mce_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;receive request complete (res=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mce_async_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DEVICE_RESUME</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">need_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">need_reset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">mce_request_packet</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">DEVICE_RESUME</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span> <span class="n">MCEUSB_TX</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mce_request_packet</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">MCEUSB_TX</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mce_flush_rx_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mce_request_packet</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">MCEUSB_RX</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Send data out the IR blaster port(s) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mceusb_tx_ir</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">txbuf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmdcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmdbuf</span><span class="p">;</span> <span class="cm">/* MCE command buffer */</span>
	<span class="kt">long</span> <span class="n">signal_duration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Singnal length in us */</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">;</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_time</span><span class="p">);</span>

	<span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="o">*</span> <span class="n">MCE_CMDBUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* MCE tx init header */</span>
	<span class="n">cmdbuf</span><span class="p">[</span><span class="n">cmdcount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MCE_CMD_PORT_IR</span><span class="p">;</span>
	<span class="n">cmdbuf</span><span class="p">[</span><span class="n">cmdcount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MCE_CMD_SETIRTXPORTS</span><span class="p">;</span>
	<span class="n">cmdbuf</span><span class="p">[</span><span class="n">cmdcount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">tx_mask</span><span class="p">;</span>

	<span class="cm">/* Generate mce packet data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmdcount</span> <span class="o">&lt;</span> <span class="n">MCE_CMDBUF_SIZE</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">signal_duration</span> <span class="o">+=</span> <span class="n">txbuf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">txbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">txbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">MCE_TIME_UNIT</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span> <span class="cm">/* loop to support long pulses/spaces &gt; 127*50us=6.35ms */</span>

			<span class="cm">/* Insert mce packet header every 4th entry */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cmdcount</span> <span class="o">&lt;</span> <span class="n">MCE_CMDBUF_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">cmdcount</span> <span class="o">-</span> <span class="n">MCE_TX_HEADER_LENGTH</span><span class="p">)</span> <span class="o">%</span>
			     <span class="n">MCE_CODE_LENGTH</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">cmdbuf</span><span class="p">[</span><span class="n">cmdcount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MCE_IRDATA_HEADER</span><span class="p">;</span>

			<span class="cm">/* Insert mce packet data */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmdcount</span> <span class="o">&lt;</span> <span class="n">MCE_CMDBUF_SIZE</span><span class="p">)</span>
				<span class="n">cmdbuf</span><span class="p">[</span><span class="n">cmdcount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">txbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MCE_PULSE_BIT</span> <span class="o">?</span>
					 <span class="n">txbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="n">MCE_MAX_PULSE_LENGTH</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="n">MCE_PULSE_BIT</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">txbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MCE_MAX_PULSE_LENGTH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">txbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">MCE_MAX_PULSE_LENGTH</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Fix packet length in last header */</span>
	<span class="n">cmdbuf</span><span class="p">[</span><span class="n">cmdcount</span> <span class="o">-</span> <span class="p">(</span><span class="n">cmdcount</span> <span class="o">-</span> <span class="n">MCE_TX_HEADER_LENGTH</span><span class="p">)</span> <span class="o">%</span> <span class="n">MCE_CODE_LENGTH</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">MCE_COMMAND_IRDATA</span> <span class="o">+</span> <span class="p">(</span><span class="n">cmdcount</span> <span class="o">-</span> <span class="n">MCE_TX_HEADER_LENGTH</span><span class="p">)</span> <span class="o">%</span>
		<span class="n">MCE_CODE_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Check if we have room for the empty packet at the end */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdcount</span> <span class="o">&gt;=</span> <span class="n">MCE_CMDBUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* All mce commands end with an empty packet (0x80) */</span>
	<span class="n">cmdbuf</span><span class="p">[</span><span class="n">cmdcount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MCE_IRDATA_TRAILER</span><span class="p">;</span>

	<span class="cm">/* Transmit the command to the mce device */</span>
	<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">,</span> <span class="n">cmdcount</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The lircd gap calculation expects the write function to</span>
<span class="cm">	 * wait the time it takes for the ircommand to be sent before</span>
<span class="cm">	 * it returns.</span>
<span class="cm">	 */</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end_time</span><span class="p">);</span>
	<span class="n">signal_duration</span> <span class="o">-=</span> <span class="p">(</span><span class="n">end_time</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="o">+</span>
			   <span class="p">(</span><span class="n">end_time</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">;</span>

	<span class="cm">/* delay with the closest number of ticks */</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">signal_duration</span><span class="p">));</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmdbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Sets active IR outputs -- mce devices typically have two */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mceusb_set_tx_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">tx_mask_normal</span><span class="p">)</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">tx_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">tx_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="n">MCE_DEFAULT_TX_MASK</span> <span class="o">?</span>
				<span class="n">mask</span> <span class="o">^</span> <span class="n">MCE_DEFAULT_TX_MASK</span> <span class="o">:</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Sets the send carrier frequency and mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mceusb_set_tx_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">carrier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clk</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prescaler</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmdbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">MCE_CMD_PORT_IR</span><span class="p">,</span>
				    <span class="n">MCE_CMD_SETIRCFS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>

	<span class="cm">/* Carrier has changed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">carrier</span> <span class="o">!=</span> <span class="n">carrier</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">carrier</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ir</span><span class="o">-&gt;</span><span class="n">carrier</span> <span class="o">=</span> <span class="n">carrier</span><span class="p">;</span>
			<span class="n">cmdbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MCE_CMD_SIG_END</span><span class="p">;</span>
			<span class="n">cmdbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MCE_IRDATA_TRAILER</span><span class="p">;</span>
			<span class="n">mce_dbg</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: disabling carrier &quot;</span>
				<span class="s">&quot;modulation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmdbuf</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">carrier</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">prescaler</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">prescaler</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">prescaler</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">divisor</span> <span class="o">=</span> <span class="p">(</span><span class="n">clk</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">prescaler</span><span class="p">))</span> <span class="o">/</span> <span class="n">carrier</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">divisor</span> <span class="o">&lt;=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ir</span><span class="o">-&gt;</span><span class="n">carrier</span> <span class="o">=</span> <span class="n">carrier</span><span class="p">;</span>
				<span class="n">cmdbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">prescaler</span><span class="p">;</span>
				<span class="n">cmdbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">divisor</span><span class="p">;</span>
				<span class="n">mce_dbg</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: requesting %u HZ &quot;</span>
					<span class="s">&quot;carrier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">carrier</span><span class="p">);</span>

				<span class="cm">/* Transmit new carrier to mce device */</span>
				<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmdbuf</span><span class="p">));</span>
				<span class="k">return</span> <span class="n">carrier</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">carrier</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We don&#39;t do anything but print debug spew for many of the command bits</span>
<span class="cm"> * we receive from the hardware, but some of them are useful information</span>
<span class="cm"> * we want to store so that we can use them.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mceusb_handle_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
	<span class="cm">/* the one and only 5-byte return value command */</span>
	<span class="k">case</span> <span class="n">MCE_RSP_GETPORTSTATUS</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
			<span class="n">ir</span><span class="o">-&gt;</span><span class="n">txports_cabled</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hi</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* 2-byte return value commands */</span>
	<span class="k">case</span> <span class="n">MCE_RSP_EQIRTIMEOUT</span>:
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">US_TO_NS</span><span class="p">((</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">lo</span><span class="p">)</span> <span class="o">*</span> <span class="n">MCE_TIME_UNIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCE_RSP_EQIRNUMPORTS</span>:
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">num_txports</span> <span class="o">=</span> <span class="n">hi</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">num_rxports</span> <span class="o">=</span> <span class="n">lo</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* 1-byte return value commands */</span>
	<span class="k">case</span> <span class="n">MCE_RSP_EQEMVER</span>:
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">emver</span> <span class="o">=</span> <span class="n">hi</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCE_RSP_EQIRTXPORTS</span>:
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">tx_mask</span> <span class="o">=</span> <span class="n">hi</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCE_RSP_EQIRRXPORTEN</span>:
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">learning_enabled</span> <span class="o">=</span> <span class="p">((</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">rxports_active</span> <span class="o">=</span> <span class="n">hi</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCE_RSP_CMD_ILLEGAL</span>:
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">need_reset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mceusb_process_ir_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_IR_RAW_EVENT</span><span class="p">(</span><span class="n">rawir</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* skip meaningless 0xb1 0x60 header bytes on orig receiver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">microsoft_gen1</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* if there&#39;s no data, just return now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">parser_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SUBCMD</span>:
			<span class="n">ir</span><span class="o">-&gt;</span><span class="n">rem</span> <span class="o">=</span> <span class="n">mceusb_cmdsize</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">mceusb_dev_printdata</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
					     <span class="n">ir</span><span class="o">-&gt;</span><span class="n">rem</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">mceusb_handle_command</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ir</span><span class="o">-&gt;</span><span class="n">parser_state</span> <span class="o">=</span> <span class="n">CMD_DATA</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARSE_IRDATA</span>:
			<span class="n">ir</span><span class="o">-&gt;</span><span class="n">rem</span><span class="o">--</span><span class="p">;</span>
			<span class="n">init_ir_raw_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rawir</span><span class="p">);</span>
			<span class="n">rawir</span><span class="p">.</span><span class="n">pulse</span> <span class="o">=</span> <span class="p">((</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MCE_PULSE_BIT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rawir</span><span class="p">.</span><span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MCE_PULSE_MASK</span><span class="p">)</span>
					 <span class="o">*</span> <span class="n">US_TO_NS</span><span class="p">(</span><span class="n">MCE_TIME_UNIT</span><span class="p">);</span>

			<span class="n">mce_dbg</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Storing %s with duration %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rawir</span><span class="p">.</span><span class="n">pulse</span> <span class="o">?</span> <span class="s">&quot;pulse&quot;</span> <span class="o">:</span> <span class="s">&quot;space&quot;</span><span class="p">,</span>
				<span class="n">rawir</span><span class="p">.</span><span class="n">duration</span><span class="p">);</span>

			<span class="n">ir_raw_event_store_with_filter</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rawir</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMD_DATA</span>:
			<span class="n">ir</span><span class="o">-&gt;</span><span class="n">rem</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMD_HEADER</span>:
			<span class="cm">/* decode mce packets of the form (84),AA,BB,CC,DD */</span>
			<span class="cm">/* IR data packets can span USB messages - rem */</span>
			<span class="n">ir</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MCE_CMD_PORT_IR</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">MCE_PORT_MASK</span><span class="p">)</span> <span class="o">!=</span>
			     <span class="n">MCE_COMMAND_IRDATA</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ir</span><span class="o">-&gt;</span><span class="n">parser_state</span> <span class="o">=</span> <span class="n">SUBCMD</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ir</span><span class="o">-&gt;</span><span class="n">rem</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">MCE_PACKET_LENGTH_MASK</span><span class="p">);</span>
			<span class="n">mceusb_dev_printdata</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">,</span>
					     <span class="n">i</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">rem</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rem</span><span class="p">)</span>
				<span class="n">ir</span><span class="o">-&gt;</span><span class="n">parser_state</span> <span class="o">=</span> <span class="n">PARSE_IRDATA</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ir_raw_event_reset</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">parser_state</span> <span class="o">!=</span> <span class="n">CMD_HEADER</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rem</span><span class="p">)</span>
			<span class="n">ir</span><span class="o">-&gt;</span><span class="n">parser_state</span> <span class="o">=</span> <span class="n">CMD_HEADER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mce_dbg</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;processed IR data, calling ir_raw_event_handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ir_raw_event_handle</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mceusb_dev_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ir</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_unlink_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">==</span> <span class="n">RECV_FLAG_IN_PROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">send_flags</span> <span class="o">=</span> <span class="n">SEND_FLAG_COMPLETE</span><span class="p">;</span>
		<span class="n">mce_dbg</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setup answer received %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* success */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">mceusb_process_ir_data</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="n">usb_unlink_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:
	<span class="nl">default:</span>
		<span class="n">mce_dbg</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error: urb status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mceusb_get_emulator_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If we get no reply or an illegal command reply, its ver 1, says MS */</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">emver</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">GET_EMVER</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_EMVER</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mceusb_gen1_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">USB_CTRL_MSG_SZ</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: memory allocation failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is a strange one. Windows issues a set address to the device</span>
<span class="cm">	 * on the receive control pipe and expect a certain value pair back</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">USB_REQ_SET_ADDRESS</span><span class="p">,</span> <span class="n">USB_TYPE_VENDOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="n">data</span><span class="p">,</span> <span class="n">USB_CTRL_MSG_SZ</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">mce_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - ret = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">mce_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - data[0] = %d, data[1] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* set feature: bit rate 38400 bps */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">USB_REQ_SET_FEATURE</span><span class="p">,</span> <span class="n">USB_TYPE_VENDOR</span><span class="p">,</span>
			      <span class="mh">0xc04e</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">mce_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - ret = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* bRequest 4: set char length to 8 bits */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="mi">4</span><span class="p">,</span> <span class="n">USB_TYPE_VENDOR</span><span class="p">,</span>
			      <span class="mh">0x0808</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">mce_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - retB = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* bRequest 2: set handshaking to use DTR/DSR */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="mi">2</span><span class="p">,</span> <span class="n">USB_TYPE_VENDOR</span><span class="p">,</span>
			      <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">mce_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - retC = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* device resume */</span>
	<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">DEVICE_RESUME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DEVICE_RESUME</span><span class="p">));</span>

	<span class="cm">/* get hw/sw revision? */</span>
	<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">GET_REVISION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_REVISION</span><span class="p">));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mceusb_gen2_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* device resume */</span>
	<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">DEVICE_RESUME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DEVICE_RESUME</span><span class="p">));</span>

	<span class="cm">/* get hw/sw revision? */</span>
	<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">GET_REVISION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_REVISION</span><span class="p">));</span>

	<span class="cm">/* get wake version (protocol, key, address) */</span>
	<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">GET_WAKEVERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_WAKEVERSION</span><span class="p">));</span>

	<span class="cm">/* unknown what this one actually returns... */</span>
	<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">GET_UNKNOWN2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_UNKNOWN2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mceusb_get_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmdbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">MCE_CMD_PORT_SYS</span><span class="p">,</span>
				    <span class="n">MCE_CMD_GETPORTSTATUS</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>

	<span class="cm">/* defaults, if the hardware doesn&#39;t support querying */</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">num_txports</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">num_rxports</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* get number of tx and rx ports */</span>
	<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">GET_NUM_PORTS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_NUM_PORTS</span><span class="p">));</span>

	<span class="cm">/* get the carrier and frequency */</span>
	<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">GET_CARRIER_FREQ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_CARRIER_FREQ</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">num_txports</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">no_tx</span><span class="p">)</span>
		<span class="cm">/* get the transmitter bitmask */</span>
		<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">GET_TX_BITMASK</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_TX_BITMASK</span><span class="p">));</span>

	<span class="cm">/* get receiver timeout value */</span>
	<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">GET_RX_TIMEOUT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_RX_TIMEOUT</span><span class="p">));</span>

	<span class="cm">/* get receiver sensor setting */</span>
	<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">GET_RX_SENSOR</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_RX_SENSOR</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">num_txports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmdbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmdbuf</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mceusb_flash_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">emver</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mce_async_out</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">FLASH_LED</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FLASH_LED</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="nf">mceusb_init_rc_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">rc_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;remote dev allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s (%04x:%04x)&quot;</span><span class="p">,</span>
		 <span class="n">mceusb_model</span><span class="p">[</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">].</span><span class="n">name</span> <span class="o">?</span>
			<span class="n">mceusb_model</span><span class="p">[</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">].</span><span class="n">name</span> <span class="o">:</span>
			<span class="s">&quot;Media Center Ed. eHome Infrared Remote Transceiver&quot;</span><span class="p">,</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">));</span>

	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>

	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_phys</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">);</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ir</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">driver_type</span> <span class="o">=</span> <span class="n">RC_DRIVER_IR_RAW</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">RC_TYPE_ALL</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">MS_TO_NS</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">no_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">s_tx_mask</span> <span class="o">=</span> <span class="n">mceusb_set_tx_mask</span><span class="p">;</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">s_tx_carrier</span> <span class="o">=</span> <span class="n">mceusb_set_tx_carrier</span><span class="p">;</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">tx_ir</span> <span class="o">=</span> <span class="n">mceusb_tx_ir</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">mceusb_model</span><span class="p">[</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">].</span><span class="n">rc_map</span> <span class="o">?</span>
			<span class="n">mceusb_model</span><span class="p">[</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">].</span><span class="n">rc_map</span> <span class="o">:</span> <span class="n">RC_MAP_RC6_MCE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rc_register_device</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;remote dev registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">rc_free_device</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mceusb_dev_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">idesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">maxp</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">63</span><span class="p">],</span> <span class="n">name</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">mceusb_model_type</span> <span class="n">model</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_gen3</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_microsoft_gen1</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tx_mask_normal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ir_intfnum</span><span class="p">;</span>

	<span class="n">mce_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">idesc</span>  <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>

	<span class="n">is_gen3</span> <span class="o">=</span> <span class="n">mceusb_model</span><span class="p">[</span><span class="n">model</span><span class="p">].</span><span class="n">mce_gen3</span><span class="p">;</span>
	<span class="n">is_microsoft_gen1</span> <span class="o">=</span> <span class="n">mceusb_model</span><span class="p">[</span><span class="n">model</span><span class="p">].</span><span class="n">mce_gen1</span><span class="p">;</span>
	<span class="n">tx_mask_normal</span> <span class="o">=</span> <span class="n">mceusb_model</span><span class="p">[</span><span class="n">model</span><span class="p">].</span><span class="n">tx_mask_normal</span><span class="p">;</span>
	<span class="n">ir_intfnum</span> <span class="o">=</span> <span class="n">mceusb_model</span><span class="p">[</span><span class="n">model</span><span class="p">].</span><span class="n">ir_intfnum</span><span class="p">;</span>

	<span class="cm">/* There are multi-function devices with non-IR interfaces */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idesc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span> <span class="o">!=</span> <span class="n">ir_intfnum</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* step through the endpoints to find first bulk in and out endpoint */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">idesc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idesc</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ep_in</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_DIR_MASK</span><span class="p">)</span>
			    <span class="o">==</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">)</span>
			    <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">)</span>
			    <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">)))</span> <span class="p">{</span>

			<span class="n">ep_in</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
			<span class="n">ep_in</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">;</span>
			<span class="n">ep_in</span><span class="o">-&gt;</span><span class="n">bInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mce_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;acceptable inbound endpoint &quot;</span>
				<span class="s">&quot;found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ep_out</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_DIR_MASK</span><span class="p">)</span>
			    <span class="o">==</span> <span class="n">USB_DIR_OUT</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">)</span>
			    <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">)</span>
			    <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">)))</span> <span class="p">{</span>

			<span class="n">ep_out</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
			<span class="n">ep_out</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">;</span>
			<span class="n">ep_out</span><span class="o">-&gt;</span><span class="n">bInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mce_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;acceptable outbound endpoint &quot;</span>
				<span class="s">&quot;found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep_in</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mce_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;inbound and/or endpoint not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep_in</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
	<span class="n">maxp</span> <span class="o">=</span> <span class="n">usb_maxpacket</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">usb_pipeout</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>

	<span class="n">ir</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mceusb_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mem_alloc_fail</span><span class="p">;</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">maxp</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dma_in</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">buf_in_alloc_fail</span><span class="p">;</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">urb_in</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">urb_in</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">urb_in_alloc_fail</span><span class="p">;</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">len_in</span> <span class="o">=</span> <span class="n">maxp</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">microsoft_gen1</span> <span class="o">=</span> <span class="n">is_microsoft_gen1</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">tx_mask_normal</span> <span class="o">=</span> <span class="n">tx_mask_normal</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">no_tx</span> <span class="o">=</span> <span class="n">mceusb_model</span><span class="p">[</span><span class="n">model</span><span class="p">].</span><span class="n">no_tx</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">;</span>

	<span class="cm">/* Saving usb interface data for use by the transmitter routine */</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">usb_ep_in</span> <span class="o">=</span> <span class="n">ep_in</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">usb_ep_out</span> <span class="o">=</span> <span class="n">ep_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">iManufacturer</span>
	    <span class="o">&amp;&amp;</span> <span class="n">usb_string</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">iManufacturer</span><span class="p">,</span>
			  <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">iProduct</span>
	    <span class="o">&amp;&amp;</span> <span class="n">usb_string</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">iProduct</span><span class="p">,</span>
			  <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
			 <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mceusb_init_rc_dev</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rc_dev_fail</span><span class="p">;</span>

	<span class="cm">/* wire up inbound data handler */</span>
	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">urb_in</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">,</span>
		<span class="n">maxp</span><span class="p">,</span> <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span> <span class="n">mceusb_dev_recv</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">ep_in</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">urb_in</span><span class="o">-&gt;</span><span class="n">transfer_dma</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dma_in</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">urb_in</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>

	<span class="cm">/* flush buffers on the device */</span>
	<span class="n">mce_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Flushing receive buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mce_flush_rx_buffer</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">maxp</span><span class="p">);</span>

	<span class="cm">/* figure out which firmware/emulator version this hardware has */</span>
	<span class="n">mceusb_get_emulator_version</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>

	<span class="cm">/* initialize device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">microsoft_gen1</span><span class="p">)</span>
		<span class="n">mceusb_gen1_init</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_gen3</span><span class="p">)</span>
		<span class="n">mceusb_gen2_init</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>

	<span class="n">mceusb_get_parameters</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>

	<span class="n">mceusb_flash_led</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">no_tx</span><span class="p">)</span>
		<span class="n">mceusb_set_tx_mask</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="n">MCE_DEFAULT_TX_MASK</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">ir</span><span class="p">);</span>

	<span class="cm">/* enable wake via this device */</span>
	<span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Registered %s with mce emulator interface &quot;</span>
		 <span class="s">&quot;version %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">emver</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%x tx ports (0x%x cabled) and &quot;</span>
		 <span class="s">&quot;%x rx sensors (0x%x active)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ir</span><span class="o">-&gt;</span><span class="n">num_txports</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">txports_cabled</span><span class="p">,</span>
		 <span class="n">ir</span><span class="o">-&gt;</span><span class="n">num_rxports</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">rxports_active</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Error-handling path */</span>
<span class="nl">rc_dev_fail:</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">urb_in</span><span class="p">);</span>
<span class="nl">urb_in_alloc_fail:</span>
	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">maxp</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dma_in</span><span class="p">);</span>
<span class="nl">buf_in_alloc_fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
<span class="nl">mem_alloc_fail:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: device setup failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">mceusb_dev_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">usbdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rc_unregister_device</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">urb_in</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">urb_in</span><span class="p">);</span>
	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">len_in</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">buf_in</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">dma_in</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mceusb_dev_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">urb_in</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mceusb_dev_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mceusb_dev</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">urb_in</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">mceusb_dev_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">mceusb_dev_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>	<span class="n">__devexit_p</span><span class="p">(</span><span class="n">mceusb_dev_disconnect</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>	<span class="n">mceusb_dev_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>	<span class="n">mceusb_dev_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span>	<span class="n">mceusb_dev_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">mceusb_dev_table</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">mceusb_dev_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">mceusb_dev_table</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug enabled or not&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
