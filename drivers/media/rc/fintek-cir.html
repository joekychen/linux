<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › rc › fintek-cir.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fintek-cir.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for Feature Integration Technology Inc. (aka Fintek) LPC CIR</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Jarod Wilson &lt;jarod@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Special thanks to Fintek for providing hardware and spec sheets.</span>
<span class="cm"> * This driver is based upon the nuvoton, ite and ene drivers for</span>
<span class="cm"> * similar hardware.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of the</span>
<span class="cm"> * License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307</span>
<span class="cm"> * USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>

<span class="cm">/* platform driver name to register */</span>
<span class="cp">#define FINTEK_DRIVER_NAME	&quot;fintek-cir&quot;</span>
<span class="cp">#define FINTEK_DESCRIPTION	&quot;Fintek LPC SuperIO Consumer IR Transceiver&quot;</span>
<span class="cp">#define VENDOR_ID_FINTEK	0x1934</span>


<span class="cm">/* debugging module parameter */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>

<span class="cp">#define fit_pr(level, text, ...) \</span>
<span class="cp">	printk(level KBUILD_MODNAME &quot;: &quot; text, ## __VA_ARGS__)</span>

<span class="cp">#define fit_dbg(text, ...) \</span>
<span class="cp">	if (debug) \</span>
<span class="cp">		printk(KERN_DEBUG \</span>
<span class="cp">			KBUILD_MODNAME &quot;: &quot; text &quot;\n&quot; , ## __VA_ARGS__)</span>

<span class="cp">#define fit_dbg_verbose(text, ...) \</span>
<span class="cp">	if (debug &gt; 1) \</span>
<span class="cp">		printk(KERN_DEBUG \</span>
<span class="cp">			KBUILD_MODNAME &quot;: &quot; text &quot;\n&quot; , ## __VA_ARGS__)</span>

<span class="cp">#define fit_dbg_wake(text, ...) \</span>
<span class="cp">	if (debug &gt; 2) \</span>
<span class="cp">		printk(KERN_DEBUG \</span>
<span class="cp">			KBUILD_MODNAME &quot;: &quot; text &quot;\n&quot; , ## __VA_ARGS__)</span>


<span class="cp">#define TX_BUF_LEN 256</span>
<span class="cp">#define RX_BUF_LEN 32</span>

<span class="k">struct</span> <span class="n">fintek_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">fintek_lock</span><span class="p">;</span>

	<span class="cm">/* for rx */</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="n">RX_BUF_LEN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkts</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="n">TX_BUF_LEN</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_count</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_buf_num</span><span class="p">;</span>
		<span class="n">wait_queue_head_t</span> <span class="n">queue</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">tx</span><span class="p">;</span>

	<span class="cm">/* Config register index/data port pair */</span>
	<span class="n">u8</span> <span class="n">cr_ip</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cr_dp</span><span class="p">;</span>

	<span class="cm">/* hardware I/O settings */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cir_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cir_irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cir_port_len</span><span class="p">;</span>

	<span class="cm">/* hardware id */</span>
	<span class="n">u8</span> <span class="n">chip_major</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">chip_minor</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">chip_vendor</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">logical_dev_cir</span><span class="p">;</span>

	<span class="cm">/* hardware features */</span>
	<span class="n">bool</span> <span class="n">hw_learning_capable</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">hw_tx_capable</span><span class="p">;</span>

	<span class="cm">/* rx settings */</span>
	<span class="n">bool</span> <span class="n">learning_enabled</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">carrier_detect_enabled</span><span class="p">;</span>

	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">CMD_HEADER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">SUBCMD</span><span class="p">,</span>
		<span class="n">CMD_DATA</span><span class="p">,</span>
		<span class="n">PARSE_IRDATA</span><span class="p">,</span>
	<span class="p">}</span> <span class="n">parser_state</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">rem</span><span class="p">;</span>

	<span class="cm">/* carrier period = 1 / frequency */</span>
	<span class="n">u32</span> <span class="n">carrier</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* buffer packet constants, largely identical to mceusb.c */</span>
<span class="cp">#define BUF_PULSE_BIT		0x80</span>
<span class="cp">#define BUF_LEN_MASK		0x1f</span>
<span class="cp">#define BUF_SAMPLE_MASK		0x7f</span>

<span class="cp">#define BUF_COMMAND_HEADER	0x9f</span>
<span class="cp">#define BUF_COMMAND_MASK	0xe0</span>
<span class="cp">#define BUF_COMMAND_NULL	0x00</span>
<span class="cp">#define BUF_HW_CMD_HEADER	0xff</span>
<span class="cp">#define BUF_CMD_G_REVISION	0x0b</span>
<span class="cp">#define BUF_CMD_S_CARRIER	0x06</span>
<span class="cp">#define BUF_CMD_S_TIMEOUT	0x0c</span>
<span class="cp">#define BUF_CMD_SIG_END		0x01</span>
<span class="cp">#define BUF_CMD_S_TXMASK	0x08</span>
<span class="cp">#define BUF_CMD_S_RXSENSOR	0x14</span>
<span class="cp">#define BUF_RSP_PULSE_COUNT	0x15</span>

<span class="cp">#define CIR_SAMPLE_PERIOD	50</span>

<span class="cm">/*</span>
<span class="cm"> * Configuration Register:</span>
<span class="cm"> *  Index Port</span>
<span class="cm"> *  Data Port</span>
<span class="cm"> */</span>
<span class="cp">#define CR_INDEX_PORT		0x2e</span>
<span class="cp">#define CR_DATA_PORT		0x2f</span>

<span class="cm">/* Possible alternate values, depends on how the chip is wired */</span>
<span class="cp">#define CR_INDEX_PORT2		0x4e</span>
<span class="cp">#define CR_DATA_PORT2		0x4f</span>

<span class="cm">/*</span>
<span class="cm"> * GCR_CONFIG_PORT_SEL bit 4 specifies which Index Port value is</span>
<span class="cm"> * active. 1 = 0x4e, 0 = 0x2e</span>
<span class="cm"> */</span>
<span class="cp">#define PORT_SEL_PORT_4E_EN	0x10</span>

<span class="cm">/* Extended Function Mode enable/disable magic values */</span>
<span class="cp">#define CONFIG_REG_ENABLE	0x87</span>
<span class="cp">#define CONFIG_REG_DISABLE	0xaa</span>

<span class="cm">/* Chip IDs found in CR_CHIP_ID_{HI,LO} */</span>
<span class="cp">#define CHIP_ID_HIGH_F71809U	0x04</span>
<span class="cp">#define CHIP_ID_LOW_F71809U	0x08</span>

<span class="cm">/*</span>
<span class="cm"> * Global control regs we need to care about:</span>
<span class="cm"> *      Global Control                  def.</span>
<span class="cm"> *      Register name           addr    val. */</span>
<span class="cp">#define GCR_SOFTWARE_RESET	0x02 </span><span class="cm">/* 0x00 */</span><span class="cp"></span>
<span class="cp">#define GCR_LOGICAL_DEV_NO	0x07 </span><span class="cm">/* 0x00 */</span><span class="cp"></span>
<span class="cp">#define GCR_CHIP_ID_HI		0x20 </span><span class="cm">/* 0x04 */</span><span class="cp"></span>
<span class="cp">#define GCR_CHIP_ID_LO		0x21 </span><span class="cm">/* 0x08 */</span><span class="cp"></span>
<span class="cp">#define GCR_VENDOR_ID_HI	0x23 </span><span class="cm">/* 0x19 */</span><span class="cp"></span>
<span class="cp">#define GCR_VENDOR_ID_LO	0x24 </span><span class="cm">/* 0x34 */</span><span class="cp"></span>
<span class="cp">#define GCR_CONFIG_PORT_SEL	0x25 </span><span class="cm">/* 0x01 */</span><span class="cp"></span>
<span class="cp">#define GCR_KBMOUSE_WAKEUP	0x27</span>

<span class="cp">#define LOGICAL_DEV_DISABLE	0x00</span>
<span class="cp">#define LOGICAL_DEV_ENABLE	0x01</span>

<span class="cm">/* Logical device number of the CIR function */</span>
<span class="cp">#define LOGICAL_DEV_CIR_REV1	0x05</span>
<span class="cp">#define LOGICAL_DEV_CIR_REV2	0x08</span>

<span class="cm">/* CIR Logical Device (LDN 0x08) config registers */</span>
<span class="cp">#define CIR_CR_COMMAND_INDEX	0x04</span>
<span class="cp">#define CIR_CR_IRCS		0x05 </span><span class="cm">/* Before host writes command to IR, host</span>
<span class="cm">					must set to 1. When host finshes write</span>
<span class="cm">					command to IR, host must clear to 0. */</span><span class="cp"></span>
<span class="cp">#define CIR_CR_COMMAND_DATA	0x06 </span><span class="cm">/* Host read or write comand data */</span><span class="cp"></span>
<span class="cp">#define CIR_CR_CLASS		0x07 </span><span class="cm">/* 0xff = rx-only, 0x66 = rx + 2 tx,</span>
<span class="cm">					0x33 = rx + 1 tx */</span><span class="cp"></span>
<span class="cp">#define CIR_CR_DEV_EN		0x30 </span><span class="cm">/* bit0 = 1 enables CIR */</span><span class="cp"></span>
<span class="cp">#define CIR_CR_BASE_ADDR_HI	0x60 </span><span class="cm">/* MSB of CIR IO base addr */</span><span class="cp"></span>
<span class="cp">#define CIR_CR_BASE_ADDR_LO	0x61 </span><span class="cm">/* LSB of CIR IO base addr */</span><span class="cp"></span>
<span class="cp">#define CIR_CR_IRQ_SEL		0x70 </span><span class="cm">/* bits3-0 store CIR IRQ */</span><span class="cp"></span>
<span class="cp">#define CIR_CR_PSOUT_STATUS	0xf1</span>
<span class="cp">#define CIR_CR_WAKE_KEY3_ADDR	0xf8</span>
<span class="cp">#define CIR_CR_WAKE_KEY3_CODE	0xf9</span>
<span class="cp">#define CIR_CR_WAKE_KEY3_DC	0xfa</span>
<span class="cp">#define CIR_CR_WAKE_CONTROL	0xfb</span>
<span class="cp">#define CIR_CR_WAKE_KEY12_ADDR	0xfc</span>
<span class="cp">#define CIR_CR_WAKE_KEY4_ADDR	0xfd</span>
<span class="cp">#define CIR_CR_WAKE_KEY5_ADDR	0xfe</span>

<span class="cp">#define CLASS_RX_ONLY		0xff</span>
<span class="cp">#define CLASS_RX_2TX		0x66</span>
<span class="cp">#define CLASS_RX_1TX		0x33</span>

<span class="cm">/* CIR device registers */</span>
<span class="cp">#define CIR_STATUS		0x00</span>
<span class="cp">#define CIR_RX_DATA		0x01</span>
<span class="cp">#define CIR_TX_CONTROL		0x02</span>
<span class="cp">#define CIR_TX_DATA		0x03</span>
<span class="cp">#define CIR_CONTROL		0x04</span>

<span class="cm">/* Bits to enable CIR wake */</span>
<span class="cp">#define LOGICAL_DEV_ACPI	0x01</span>
<span class="cp">#define LDEV_ACPI_WAKE_EN_REG	0xe8</span>
<span class="cp">#define ACPI_WAKE_EN_CIR_BIT	0x04</span>

<span class="cp">#define LDEV_ACPI_PME_EN_REG	0xf0</span>
<span class="cp">#define LDEV_ACPI_PME_CLR_REG	0xf1</span>
<span class="cp">#define ACPI_PME_CIR_BIT	0x02</span>

<span class="cp">#define LDEV_ACPI_STATE_REG	0xf4</span>
<span class="cp">#define ACPI_STATE_CIR_BIT	0x20</span>

<span class="cm">/*</span>
<span class="cm"> * CIR status register (0x00):</span>
<span class="cm"> *   7 - CIR_IRQ_EN (1 = enable CIR IRQ, 0 = disable)</span>
<span class="cm"> *   3 - TX_FINISH (1 when TX finished, write 1 to clear)</span>
<span class="cm"> *   2 - TX_UNDERRUN (1 on TX underrun, write 1 to clear)</span>
<span class="cm"> *   1 - RX_TIMEOUT (1 on RX timeout, write 1 to clear)</span>
<span class="cm"> *   0 - RX_RECEIVE (1 on RX receive, write 1 to clear)</span>
<span class="cm"> */</span>
<span class="cp">#define CIR_STATUS_IRQ_EN	0x80</span>
<span class="cp">#define CIR_STATUS_TX_FINISH	0x08</span>
<span class="cp">#define CIR_STATUS_TX_UNDERRUN	0x04</span>
<span class="cp">#define CIR_STATUS_RX_TIMEOUT	0x02</span>
<span class="cp">#define CIR_STATUS_RX_RECEIVE	0x01</span>
<span class="cp">#define CIR_STATUS_IRQ_MASK	0x0f</span>

<span class="cm">/*</span>
<span class="cm"> * CIR TX control register (0x02):</span>
<span class="cm"> *   7 - TX_START (1 to indicate TX start, auto-cleared when done)</span>
<span class="cm"> *   6 - TX_END (1 to indicate TX data written to TX fifo)</span>
<span class="cm"> */</span>
<span class="cp">#define CIR_TX_CONTROL_TX_START	0x80</span>
<span class="cp">#define CIR_TX_CONTROL_TX_END	0x40</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
