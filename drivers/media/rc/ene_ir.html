<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › rc › ene_ir.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ene_ir.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * driver for ENE KB3926 B/C/D/E/F CIR (pnp id: ENE0XXX)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Maxim Levitsky &lt;maximlevitsky@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of the</span>
<span class="cm"> * License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307</span>
<span class="cm"> * USA</span>
<span class="cm"> *</span>
<span class="cm"> * Special thanks to:</span>
<span class="cm"> *   Sami R. &lt;maesesami@gmail.com&gt; for lot of help in debugging and therefore</span>
<span class="cm"> *    bringing to life support for transmission &amp; learning mode.</span>
<span class="cm"> *</span>
<span class="cm"> *   Charlie Andrews &lt;charliethepilot@googlemail.com&gt; for lots of help in</span>
<span class="cm"> *   bringing up the support of new firmware buffer that is popular</span>
<span class="cm"> *   on latest notebooks</span>
<span class="cm"> *</span>
<span class="cm"> *   ENE for partial device documentation</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pnp.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;media/rc-core.h&gt;</span>
<span class="cp">#include &quot;ene_ir.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sample_period</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">learning_mode_force</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">txsim</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_set_reg_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span> <span class="o">+</span> <span class="n">ENE_ADDR_HI</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span> <span class="o">+</span> <span class="n">ENE_ADDR_LO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* read a hardware register */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">ene_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">ene_set_reg_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span> <span class="o">+</span> <span class="n">ENE_IO</span><span class="p">);</span>
	<span class="n">dbg_regs</span><span class="p">(</span><span class="s">&quot;reg %04x == %02x&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* write a hardware register */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbg_regs</span><span class="p">(</span><span class="s">&quot;reg %04x &lt;- %02x&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">ene_set_reg_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span> <span class="o">+</span> <span class="n">ENE_IO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set bits in hardware register */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_set_reg_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbg_regs</span><span class="p">(</span><span class="s">&quot;reg %04x |= %02x&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">ene_set_reg_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span> <span class="o">+</span> <span class="n">ENE_IO</span><span class="p">)</span> <span class="o">|</span> <span class="n">mask</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span> <span class="o">+</span> <span class="n">ENE_IO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Clear bits in hardware register */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_clear_reg_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbg_regs</span><span class="p">(</span><span class="s">&quot;reg %04x &amp;= ~%02x &quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">ene_set_reg_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span> <span class="o">+</span> <span class="n">ENE_IO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span> <span class="o">+</span> <span class="n">ENE_IO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* A helper to set/clear a bit in register according to boolean variable */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_set_clear_reg_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">,</span>
								<span class="n">bool</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span>
		<span class="n">ene_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ene_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* detect hardware features */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_hw_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">chip_major</span><span class="p">,</span> <span class="n">chip_minor</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hw_revision</span><span class="p">,</span> <span class="n">old_ver</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fw_reg2</span><span class="p">,</span> <span class="n">fw_reg1</span><span class="p">;</span>

	<span class="n">ene_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_ECSTS</span><span class="p">,</span> <span class="n">ENE_ECSTS_RSRVD</span><span class="p">);</span>
	<span class="n">chip_major</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_ECVER_MAJOR</span><span class="p">);</span>
	<span class="n">chip_minor</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_ECVER_MINOR</span><span class="p">);</span>
	<span class="n">ene_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_ECSTS</span><span class="p">,</span> <span class="n">ENE_ECSTS_RSRVD</span><span class="p">);</span>

	<span class="n">hw_revision</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_ECHV</span><span class="p">);</span>
	<span class="n">old_ver</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_HW_VER_OLD</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pll_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_PLLFRH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_PLLFRL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sample_period</span> <span class="o">!=</span> <span class="n">ENE_DEFAULT_SAMPLE_PERIOD</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_period_adjust</span> <span class="o">=</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pll_freq</span> <span class="o">==</span> <span class="n">ENE_DEFAULT_PLL_FREQ</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_revision</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;device seems to be disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;send a mail to lirc-list@lists.sourceforge.net</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;please attach output of acpidump and dmidecode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;chip is 0x%02x%02x - kbver = 0x%02x, rev = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">chip_major</span><span class="p">,</span> <span class="n">chip_minor</span><span class="p">,</span> <span class="n">old_ver</span><span class="p">,</span> <span class="n">hw_revision</span><span class="p">);</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;PLL freq = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pll_freq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_major</span> <span class="o">==</span> <span class="mh">0x33</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;chips 0x33xx aren&#39;t supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_major</span> <span class="o">==</span> <span class="mh">0x39</span> <span class="o">&amp;&amp;</span> <span class="n">chip_minor</span> <span class="o">==</span> <span class="mh">0x26</span> <span class="o">&amp;&amp;</span> <span class="n">hw_revision</span> <span class="o">==</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_revision</span> <span class="o">=</span> <span class="n">ENE_HW_C</span><span class="p">;</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;KB3926C detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_ver</span> <span class="o">==</span> <span class="mh">0x24</span> <span class="o">&amp;&amp;</span> <span class="n">hw_revision</span> <span class="o">==</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_revision</span> <span class="o">=</span> <span class="n">ENE_HW_B</span><span class="p">;</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;KB3926B detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_revision</span> <span class="o">=</span> <span class="n">ENE_HW_D</span><span class="p">;</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;KB3926D or higher detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* detect features hardware supports */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_revision</span> <span class="o">&lt;</span> <span class="n">ENE_HW_C</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fw_reg1</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW1</span><span class="p">);</span>
	<span class="n">fw_reg2</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW2</span><span class="p">);</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Firmware regs: %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_reg1</span><span class="p">,</span> <span class="n">fw_reg2</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_use_gpio_0a</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">fw_reg2</span> <span class="o">&amp;</span> <span class="n">ENE_FW2_GP0A</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_learning_and_tx_capable</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">fw_reg2</span> <span class="o">&amp;</span> <span class="n">ENE_FW2_LEARNING</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_extra_buffer</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">fw_reg1</span> <span class="o">&amp;</span> <span class="n">ENE_FW1_HAS_EXTRA_BUF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_learning_and_tx_capable</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_fan_input</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">fw_reg2</span> <span class="o">&amp;</span> <span class="n">ENE_FW2_FAN_INPUT</span><span class="p">);</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Hardware features:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_learning_and_tx_capable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;* Supports transmitting &amp; learning mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;   This feature is rare and therefore,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;   you are welcome to test it,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;   and/or contact the author via:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;   lirc-list@lists.sourceforge.net</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;   or maximlevitsky@gmail.com</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;* Uses GPIO %s for IR raw input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_use_gpio_0a</span> <span class="o">?</span> <span class="s">&quot;40&quot;</span> <span class="o">:</span> <span class="s">&quot;0A&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_fan_input</span><span class="p">)</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;* Uses unused fan feedback input as source of demodulated IR data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_fan_input</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;* Uses GPIO %s for IR demodulated input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_use_gpio_0a</span> <span class="o">?</span> <span class="s">&quot;0A&quot;</span> <span class="o">:</span> <span class="s">&quot;40&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_extra_buffer</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;* Uses new style input buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read properities of hw sample buffer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_rx_setup_hw_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">ene_rx_read_hw_pointer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">w_pointer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_extra_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">buffer_len</span> <span class="o">=</span> <span class="n">ENE_FW_PACKET_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf1_address</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf1_len</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf2_address</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf2_len</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">buffer_len</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf1_len</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf2_len</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Hardware uses 2 extended buffers:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  0x%04x - len : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf1_address</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf1_len</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  0x%04x - len : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf2_address</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf2_len</span><span class="p">);</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Total buffer len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">buffer_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">buffer_len</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">buffer_len</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf1_address</span> <span class="o">&gt;</span> <span class="mh">0xFBFC</span> <span class="o">||</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf1_address</span> <span class="o">&lt;</span> <span class="mh">0xEC00</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf2_address</span> <span class="o">&gt;</span> <span class="mh">0xFBFC</span> <span class="o">||</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf2_address</span> <span class="o">&lt;</span> <span class="mh">0xEC00</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">buffer_len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ene_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW1</span><span class="p">,</span> <span class="n">ENE_FW1_EXTRA_BUF_HND</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error validating extra buffers, device probably won&#39;t work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_extra_buffer</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ene_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW1</span><span class="p">,</span> <span class="n">ENE_FW1_EXTRA_BUF_HND</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Restore the pointers to extra buffers - to make module reload work*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_rx_restore_hw_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_extra_buffer</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf1_address</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf1_address</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf1_len</span><span class="p">);</span>

	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf2_address</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf2_address</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf2_len</span><span class="p">);</span>
	<span class="n">ene_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW1</span><span class="p">,</span> <span class="n">ENE_FW1_EXTRA_BUF_HND</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read hardware write pointer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_rx_read_hw_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_extra_buffer</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">w_pointer</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW_RX_POINTER</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">w_pointer</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW2</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">ENE_FW2_BUF_WPTR</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ENE_FW_PACKET_SIZE</span><span class="p">;</span>

	<span class="n">dbg_verbose</span><span class="p">(</span><span class="s">&quot;RB: HW write pointer: %02x, driver read pointer: %02x&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">w_pointer</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Gets address of next sample from HW ring buffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_rx_get_sample_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r_pointer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">w_pointer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg_verbose</span><span class="p">(</span><span class="s">&quot;RB: hit end, try update w_pointer&quot;</span><span class="p">);</span>
		<span class="n">ene_rx_read_hw_pointer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">w_pointer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg_verbose</span><span class="p">(</span><span class="s">&quot;RB: end of data at %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg_verbose</span><span class="p">(</span><span class="s">&quot;RB: reading at offset %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span><span class="p">);</span>
	<span class="n">r_pointer</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">buffer_len</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbg_verbose</span><span class="p">(</span><span class="s">&quot;RB: next read will be from offset %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r_pointer</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg_verbose</span><span class="p">(</span><span class="s">&quot;RB: read at main buffer at %d&quot;</span><span class="p">,</span> <span class="n">r_pointer</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span> <span class="o">+</span> <span class="n">r_pointer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r_pointer</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r_pointer</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf1_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg_verbose</span><span class="p">(</span><span class="s">&quot;RB: read at 1st extra buffer at %d&quot;</span><span class="p">,</span> <span class="n">r_pointer</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf1_address</span> <span class="o">+</span> <span class="n">r_pointer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r_pointer</span> <span class="o">-=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf1_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r_pointer</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf2_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg_verbose</span><span class="p">(</span><span class="s">&quot;RB: read at 2nd extra buffer at %d&quot;</span><span class="p">,</span> <span class="n">r_pointer</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_buf2_address</span> <span class="o">+</span> <span class="n">r_pointer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;attempt to read beyond ring buffer end&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Sense current received carrier */</span>
<span class="kt">void</span> <span class="nf">ene_rx_sense_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_IR_RAW_EVENT</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">carrier</span><span class="p">,</span> <span class="n">duty_cycle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">period</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCAR_PRD</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">hperiod</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCAR_HPRD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">period</span> <span class="o">&amp;</span> <span class="n">ENE_CIRCAR_PRD_VALID</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">period</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENE_CIRCAR_PRD_VALID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">period</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;RX: hardware carrier period = %02x&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;RX: hardware carrier pulse period = %02x&quot;</span><span class="p">,</span> <span class="n">hperiod</span><span class="p">);</span>

	<span class="n">carrier</span> <span class="o">=</span> <span class="mi">2000000</span> <span class="o">/</span> <span class="n">period</span><span class="p">;</span>
	<span class="n">duty_cycle</span> <span class="o">=</span> <span class="p">(</span><span class="n">hperiod</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="n">period</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;RX: sensed carrier = %d Hz, duty cycle %d%%&quot;</span><span class="p">,</span>
						<span class="n">carrier</span><span class="p">,</span> <span class="n">duty_cycle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">carrier_detect_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ev</span><span class="p">.</span><span class="n">carrier_report</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ev</span><span class="p">.</span><span class="n">carrier</span> <span class="o">=</span> <span class="n">carrier</span><span class="p">;</span>
		<span class="n">ev</span><span class="p">.</span><span class="n">duty_cycle</span> <span class="o">=</span> <span class="n">duty_cycle</span><span class="p">;</span>
		<span class="n">ir_raw_event_store</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* this enables/disables the CIR RX engine */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_rx_enable_cir_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ene_set_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCFG</span><span class="p">,</span>
			<span class="n">ENE_CIRCFG_RX_EN</span> <span class="o">|</span> <span class="n">ENE_CIRCFG_RX_IRQ</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this selects input for CIR engine. Ether GPIO 0A or GPIO40*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_rx_select_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">gpio_0a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ene_set_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCFG2</span><span class="p">,</span> <span class="n">ENE_CIRCFG2_GPIO0A</span><span class="p">,</span> <span class="n">gpio_0a</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this enables alternative input via fan tachometer sensor and bypasses</span>
<span class="cm"> * the hw CIR engine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_rx_enable_fan_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_fan_input</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FAN_AS_IN1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FAN_AS_IN1</span><span class="p">,</span> <span class="n">ENE_FAN_AS_IN1_EN</span><span class="p">);</span>
		<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FAN_AS_IN2</span><span class="p">,</span> <span class="n">ENE_FAN_AS_IN2_EN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* setup the receiver for RX*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_rx_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">learning_mode</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">learning_mode_enabled</span> <span class="o">||</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">carrier_detect_enabled</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sample_period_adjust</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;RX: setup receiver, learning mode = %d&quot;</span><span class="p">,</span> <span class="n">learning_mode</span><span class="p">);</span>


	<span class="cm">/* This selects RLC input and clears CFG2 settings */</span>
	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCFG2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* set sample period*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sample_period</span> <span class="o">==</span> <span class="n">ENE_DEFAULT_SAMPLE_PERIOD</span><span class="p">)</span>
		<span class="n">sample_period_adjust</span> <span class="o">=</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pll_freq</span> <span class="o">==</span> <span class="n">ENE_DEFAULT_PLL_FREQ</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRRLC_CFG</span><span class="p">,</span>
			<span class="p">(</span><span class="n">sample_period</span> <span class="o">+</span> <span class="n">sample_period_adjust</span><span class="p">)</span> <span class="o">|</span>
						<span class="n">ENE_CIRRLC_CFG_OVERFLOW</span><span class="p">);</span>
	<span class="cm">/* revB doesn&#39;t support inputs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_revision</span> <span class="o">&lt;</span> <span class="n">ENE_HW_C</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">select_timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">learning_mode</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_learning_and_tx_capable</span><span class="p">);</span>

		<span class="cm">/* Enable the opposite of the normal input</span>
<span class="cm">		That means that if GPIO40 is normally used, use GPIO0A</span>
<span class="cm">		and vice versa.</span>
<span class="cm">		This input will carry non demodulated</span>
<span class="cm">		signal, and we will tell the hw to demodulate it itself */</span>
		<span class="n">ene_rx_select_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_use_gpio_0a</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fan_input_inuse</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* Enable carrier demodulation */</span>
		<span class="n">ene_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCFG</span><span class="p">,</span> <span class="n">ENE_CIRCFG_CARR_DEMOD</span><span class="p">);</span>

		<span class="cm">/* Enable carrier detection */</span>
		<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCAR_PULS</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">);</span>
		<span class="n">ene_set_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCFG2</span><span class="p">,</span> <span class="n">ENE_CIRCFG2_CARR_DETECT</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">carrier_detect_enabled</span> <span class="o">||</span> <span class="n">debug</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_fan_input</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fan_input_inuse</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ene_rx_select_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_use_gpio_0a</span><span class="p">);</span>

		<span class="cm">/* Disable carrier detection &amp; demodulation */</span>
		<span class="n">ene_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCFG</span><span class="p">,</span> <span class="n">ENE_CIRCFG_CARR_DEMOD</span><span class="p">);</span>
		<span class="n">ene_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCFG2</span><span class="p">,</span> <span class="n">ENE_CIRCFG2_CARR_DETECT</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">select_timeout:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fan_input_inuse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rx_resolution</span> <span class="o">=</span> <span class="n">US_TO_NS</span><span class="p">(</span><span class="n">ENE_FW_SAMPLE_PERIOD_FAN</span><span class="p">);</span>

		<span class="cm">/* Fan input doesn&#39;t support timeouts, it just ends the</span>
<span class="cm">			input with a maximum sample */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">min_timeout</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">max_timeout</span> <span class="o">=</span>
			<span class="n">US_TO_NS</span><span class="p">(</span><span class="n">ENE_FW_SMPL_BUF_FAN_MSK</span> <span class="o">*</span>
				<span class="n">ENE_FW_SAMPLE_PERIOD_FAN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">rx_resolution</span> <span class="o">=</span> <span class="n">US_TO_NS</span><span class="p">(</span><span class="n">sample_period</span><span class="p">);</span>

		<span class="cm">/* Theoreticly timeout is unlimited, but we cap it</span>
<span class="cm">		 * because it was seen that on one device, it</span>
<span class="cm">		 * would stop sending spaces after around 250 msec.</span>
<span class="cm">		 * Besides, this is close to 2^32 anyway and timeout is u32.</span>
<span class="cm">		 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">min_timeout</span> <span class="o">=</span> <span class="n">US_TO_NS</span><span class="p">(</span><span class="mi">127</span> <span class="o">*</span> <span class="n">sample_period</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">max_timeout</span> <span class="o">=</span> <span class="n">US_TO_NS</span><span class="p">(</span><span class="mi">200000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_learning_and_tx_capable</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">tx_resolution</span> <span class="o">=</span> <span class="n">US_TO_NS</span><span class="p">(</span><span class="n">sample_period</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">max_timeout</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">max_timeout</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">min_timeout</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">min_timeout</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Enable the device for receive */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_rx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg_value</span><span class="p">;</span>

	<span class="cm">/* Enable system interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_revision</span> <span class="o">&lt;</span> <span class="n">ENE_HW_C</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENEB_IRQ</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENEB_IRQ_UNK1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg_value</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_IRQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">;</span>
		<span class="n">reg_value</span> <span class="o">|=</span> <span class="n">ENE_IRQ_UNK_EN</span><span class="p">;</span>
		<span class="n">reg_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENE_IRQ_STATUS</span><span class="p">;</span>
		<span class="n">reg_value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&amp;</span> <span class="n">ENE_IRQ_MASK</span><span class="p">);</span>
		<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_IRQ</span><span class="p">,</span> <span class="n">reg_value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable inputs */</span>
	<span class="n">ene_rx_enable_fan_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fan_input_inuse</span><span class="p">);</span>
	<span class="n">ene_rx_enable_cir_engine</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fan_input_inuse</span><span class="p">);</span>

	<span class="cm">/* ack any pending irqs - just in case */</span>
	<span class="n">ene_irq_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* enable firmware bits */</span>
	<span class="n">ene_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW1</span><span class="p">,</span> <span class="n">ENE_FW1_ENABLE</span> <span class="o">|</span> <span class="n">ENE_FW1_IRQ</span><span class="p">);</span>

	<span class="cm">/* enter idle mode */</span>
	<span class="n">ir_raw_event_set_idle</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Disable the device receiver */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_rx_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable inputs */</span>
	<span class="n">ene_rx_enable_cir_engine</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">ene_rx_enable_fan_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* disable hardware IRQ and firmware flag */</span>
	<span class="n">ene_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW1</span><span class="p">,</span> <span class="n">ENE_FW1_ENABLE</span> <span class="o">|</span> <span class="n">ENE_FW1_IRQ</span><span class="p">);</span>

	<span class="n">ir_raw_event_set_idle</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This resets the receiver. Useful to stop stream of spaces at end of</span>
<span class="cm"> * transmission</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_rx_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ene_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCFG</span><span class="p">,</span> <span class="n">ENE_CIRCFG_RX_EN</span><span class="p">);</span>
	<span class="n">ene_set_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCFG</span><span class="p">,</span> <span class="n">ENE_CIRCFG_RX_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set up the TX carrier frequency and duty cycle */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_tx_set_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tx_puls_width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ene_set_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCFG</span><span class="p">,</span>
		<span class="n">ENE_CIRCFG_TX_CARR</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_period</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_period</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_duty_cycle</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_duty_cycle</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tx_puls_width</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_period</span> <span class="o">/</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_duty_cycle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_puls_width</span><span class="p">)</span>
		<span class="n">tx_puls_width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: pulse distance = %d * 500 ns&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_period</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: pulse width = %d * 500 ns&quot;</span><span class="p">,</span> <span class="n">tx_puls_width</span><span class="p">);</span>

	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRMOD_PRD</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_period</span> <span class="o">|</span> <span class="n">ENE_CIRMOD_PRD_POL</span><span class="p">);</span>
	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRMOD_HPRD</span><span class="p">,</span> <span class="n">tx_puls_width</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Enable/disable transmitters */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_tx_set_transmitters</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ene_set_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_GPIOFS8</span><span class="p">,</span> <span class="n">ENE_GPIOFS8_GPIO41</span><span class="p">,</span>
					<span class="o">!!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transmitter_mask</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
	<span class="n">ene_set_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_GPIOFS1</span><span class="p">,</span> <span class="n">ENE_GPIOFS1_GPIO0D</span><span class="p">,</span>
					<span class="o">!!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transmitter_mask</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* prepare transmission */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_tx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">conf1</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCFG</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">fwreg2</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW2</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">saved_conf1</span> <span class="o">=</span> <span class="n">conf1</span><span class="p">;</span>

	<span class="cm">/* Show information about currently connected transmitter jacks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fwreg2</span> <span class="o">&amp;</span> <span class="n">ENE_FW2_EMMITER1_CONN</span><span class="p">)</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: Transmitter #1 is connected&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fwreg2</span> <span class="o">&amp;</span> <span class="n">ENE_FW2_EMMITER2_CONN</span><span class="p">)</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: Transmitter #2 is connected&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fwreg2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ENE_FW2_EMMITER1_CONN</span> <span class="o">|</span> <span class="n">ENE_FW2_EMMITER2_CONN</span><span class="p">)))</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;TX: transmitter cable isn&#39;t connected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* disable receive on revc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_revision</span> <span class="o">==</span> <span class="n">ENE_HW_C</span><span class="p">)</span>
		<span class="n">conf1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENE_CIRCFG_RX_EN</span><span class="p">;</span>

	<span class="cm">/* Enable TX engine */</span>
	<span class="n">conf1</span> <span class="o">|=</span> <span class="n">ENE_CIRCFG_TX_EN</span> <span class="o">|</span> <span class="n">ENE_CIRCFG_TX_IRQ</span><span class="p">;</span>
	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCFG</span><span class="p">,</span> <span class="n">conf1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* end transmission */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_tx_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_CIRCFG</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">saved_conf1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* TX one sample - must be called with dev-&gt;hw_lock*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_tx_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">raw_tx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sample</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">pulse</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_sample_pulse</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;TX: BUG: attempt to transmit NULL buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Grab next TX sample */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_sample</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_pos</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: no more data to send&quot;</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: last sample sent by hardware&quot;</span><span class="p">);</span>
				<span class="n">ene_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_complete</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">sample</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_pos</span><span class="o">++</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_sample_pulse</span> <span class="o">=</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_sample_pulse</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_sample</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">sample_period</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_sample</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_sample</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">raw_tx</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_sample</span> <span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">ENE_CIRRLC_OUT_MASK</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_sample</span> <span class="o">-=</span> <span class="n">raw_tx</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: sample %8d (%s)&quot;</span><span class="p">,</span> <span class="n">raw_tx</span> <span class="o">*</span> <span class="n">sample_period</span><span class="p">,</span>
						<span class="n">pulse</span> <span class="o">?</span> <span class="s">&quot;pulse&quot;</span> <span class="o">:</span> <span class="s">&quot;space&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pulse</span><span class="p">)</span>
		<span class="n">raw_tx</span> <span class="o">|=</span> <span class="n">ENE_CIRRLC_OUT_PULSE</span><span class="p">;</span>

	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_reg</span> <span class="o">?</span> <span class="n">ENE_CIRRLC_OUT1</span> <span class="o">:</span> <span class="n">ENE_CIRRLC_OUT0</span><span class="p">,</span> <span class="n">raw_tx</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_reg</span> <span class="o">=</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_reg</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="cm">/* simulate TX done interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txsim</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_sim_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">500</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* timer to simulate tx done interrupt */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_tx_irqsim</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ene_tx_sample</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* read irq status and ack it */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_irq_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">irq_status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fw_flags1</span><span class="p">,</span> <span class="n">fw_flags2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fw_flags2</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_revision</span> <span class="o">&lt;</span> <span class="n">ENE_HW_C</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_status</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENEB_IRQ_STATUS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">ENEB_IRQ_STATUS_IR</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ene_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENEB_IRQ_STATUS</span><span class="p">,</span> <span class="n">ENEB_IRQ_STATUS_IR</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ENE_IRQ_RX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq_status</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_IRQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">ENE_IRQ_STATUS</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* original driver does that twice - a workaround ? */</span>
	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_IRQ</span><span class="p">,</span> <span class="n">irq_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENE_IRQ_STATUS</span><span class="p">);</span>
	<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_IRQ</span><span class="p">,</span> <span class="n">irq_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENE_IRQ_STATUS</span><span class="p">);</span>

	<span class="cm">/* check RX interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_flags2</span> <span class="o">&amp;</span> <span class="n">ENE_FW2_RXIRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">ENE_IRQ_RX</span><span class="p">;</span>
		<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW2</span><span class="p">,</span> <span class="n">fw_flags2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENE_FW2_RXIRQ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* check TX interrupt */</span>
	<span class="n">fw_flags1</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_flags1</span> <span class="o">&amp;</span> <span class="n">ENE_FW1_TXIRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ene_write_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW1</span><span class="p">,</span> <span class="n">fw_flags1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENE_FW1_TXIRQ</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">ENE_IRQ_TX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* interrupt handler */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ene_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">hw_value</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hw_sample</span><span class="p">,</span> <span class="n">irq_status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">pulse</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">DEFINE_IR_RAW_EVENT</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg_verbose</span><span class="p">(</span><span class="s">&quot;ISR called&quot;</span><span class="p">);</span>
	<span class="n">ene_rx_read_hw_pointer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">irq_status</span> <span class="o">=</span> <span class="n">ene_irq_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">ENE_IRQ_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg_verbose</span><span class="p">(</span><span class="s">&quot;TX interrupt&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_learning_and_tx_capable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX interrupt on unsupported device!&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ene_tx_sample</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">ENE_IRQ_RX</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">dbg_verbose</span><span class="p">(</span><span class="s">&quot;RX interrupt&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_learning_and_tx_capable</span><span class="p">)</span>
		<span class="n">ene_rx_sense_carrier</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* On hardware that don&#39;t support extra buffer we need to trust</span>
<span class="cm">		the interrupt and not track the read pointer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_extra_buffer</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">w_pointer</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ENE_FW_PACKET_SIZE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">ene_rx_get_sample_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">dbg_verbose</span><span class="p">(</span><span class="s">&quot;next sample to read at: %04x&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reg</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">hw_value</span> <span class="o">=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fan_input_inuse</span><span class="p">)</span> <span class="p">{</span>

			<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ENE_FW_SMPL_BUF_FAN</span> <span class="o">-</span> <span class="n">ENE_FW_SAMPLE_BUFFER</span><span class="p">;</span>

			<span class="cm">/* read high part of the sample */</span>
			<span class="n">hw_value</span> <span class="o">|=</span> <span class="n">ene_read_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">pulse</span> <span class="o">=</span> <span class="n">hw_value</span> <span class="o">&amp;</span> <span class="n">ENE_FW_SMPL_BUF_FAN_PLS</span><span class="p">;</span>

			<span class="cm">/* clear space bit, and other unused bits */</span>
			<span class="n">hw_value</span> <span class="o">&amp;=</span> <span class="n">ENE_FW_SMPL_BUF_FAN_MSK</span><span class="p">;</span>
			<span class="n">hw_sample</span> <span class="o">=</span> <span class="n">hw_value</span> <span class="o">*</span> <span class="n">ENE_FW_SAMPLE_PERIOD_FAN</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pulse</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">hw_value</span> <span class="o">&amp;</span> <span class="n">ENE_FW_SAMPLE_SPACE</span><span class="p">);</span>
			<span class="n">hw_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENE_FW_SAMPLE_SPACE</span><span class="p">;</span>
			<span class="n">hw_sample</span> <span class="o">=</span> <span class="n">hw_value</span> <span class="o">*</span> <span class="n">sample_period</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_period_adjust</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hw_sample</span> <span class="o">*=</span> <span class="mi">100</span><span class="p">;</span>
				<span class="n">hw_sample</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_period_adjust</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_extra_buffer</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hw_sample</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">r_pointer</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">w_pointer</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;RX: %d (%s)&quot;</span><span class="p">,</span> <span class="n">hw_sample</span><span class="p">,</span> <span class="n">pulse</span> <span class="o">?</span> <span class="s">&quot;pulse&quot;</span> <span class="o">:</span> <span class="s">&quot;space&quot;</span><span class="p">);</span>

		<span class="n">ev</span><span class="p">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">US_TO_NS</span><span class="p">(</span><span class="n">hw_sample</span><span class="p">);</span>
		<span class="n">ev</span><span class="p">.</span><span class="n">pulse</span> <span class="o">=</span> <span class="n">pulse</span><span class="p">;</span>
		<span class="n">ir_raw_event_store_with_filter</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ir_raw_event_handle</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize default settings */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_setup_default_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_period</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_duty_cycle</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/*%*/</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">transmitter_mask</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">learning_mode_enabled</span> <span class="o">=</span> <span class="n">learning_mode_force</span><span class="p">;</span>

	<span class="cm">/* Set reasonable default timeout */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">US_TO_NS</span><span class="p">(</span><span class="mi">150000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Upload all hardware settings at once. Used at load and resume time */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_setup_hw_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_learning_and_tx_capable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ene_tx_set_carrier</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ene_tx_set_transmitters</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ene_rx_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* outside interface: called on first open*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ene_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* outside interface: called on device close*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ene_rx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* outside interface: set transmitter mask */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_set_tx_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tx_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: attempt to set transmitter mask %02x&quot;</span><span class="p">,</span> <span class="n">tx_mask</span><span class="p">);</span>

	<span class="cm">/* invalid txmask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_mask</span> <span class="o">||</span> <span class="n">tx_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: invalid mask&quot;</span><span class="p">);</span>
		<span class="cm">/* return count of transmitters */</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">transmitter_mask</span> <span class="o">=</span> <span class="n">tx_mask</span><span class="p">;</span>
	<span class="n">ene_tx_set_transmitters</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* outside interface : set tx carrier */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_set_tx_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">carrier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">period</span> <span class="o">=</span> <span class="mi">2000000</span> <span class="o">/</span> <span class="n">carrier</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: attempt to set tx carrier to %d kHz&quot;</span><span class="p">,</span> <span class="n">carrier</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">period</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">period</span> <span class="o">&gt;</span> <span class="n">ENE_CIRMOD_PRD_MAX</span> <span class="o">||</span>
			<span class="n">period</span> <span class="o">&lt;</span> <span class="n">ENE_CIRMOD_PRD_MIN</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: out of range %d-%d kHz carrier&quot;</span><span class="p">,</span>
			<span class="mi">2000</span> <span class="o">/</span> <span class="n">ENE_CIRMOD_PRD_MIN</span><span class="p">,</span> <span class="mi">2000</span> <span class="o">/</span> <span class="n">ENE_CIRMOD_PRD_MAX</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
	<span class="n">ene_tx_set_carrier</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*outside interface : set tx duty cycle */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_set_tx_duty_cycle</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">duty_cycle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: setting duty cycle to %d%%&quot;</span><span class="p">,</span> <span class="n">duty_cycle</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_duty_cycle</span> <span class="o">=</span> <span class="n">duty_cycle</span><span class="p">;</span>
	<span class="n">ene_tx_set_carrier</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* outside interface: enable learning mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_set_learning_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">learning_mode_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">learning_mode_enabled</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="n">ene_rx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ene_rx_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ene_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_set_carrier_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">carrier_detect_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">carrier_detect_enabled</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="n">ene_rx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ene_rx_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ene_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* outside interface: enable or disable idle mode */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_set_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">idle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ene_rx_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;RX: end of data&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* outside interface: transmit */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_buffer</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_len</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_sample</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_sample_pulse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: %d samples&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_len</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ene_tx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Transmit first two samples */</span>
	<span class="n">ene_tx_sample</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ene_tx_sample</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_complete</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: timeout&quot;</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ene_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;TX: done&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* probe entry */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pnp_dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* allocate memory */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">rc_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">rdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="cm">/* validate resources */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* init these to -1, as 0 is valid for both */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">pnp_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">pnp_port_len</span><span class="p">(</span><span class="n">pnp_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ENE_IO_SIZE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_irq_valid</span><span class="p">(</span><span class="n">pnp_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="n">pnp_set_drvdata</span><span class="p">(</span><span class="n">pnp_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pnp_dev</span> <span class="o">=</span> <span class="n">pnp_dev</span><span class="p">;</span>

	<span class="cm">/* don&#39;t allow too short/long sample periods */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sample_period</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">sample_period</span> <span class="o">&gt;</span> <span class="mh">0x7F</span><span class="p">)</span>
		<span class="n">sample_period</span> <span class="o">=</span> <span class="n">ENE_DEFAULT_SAMPLE_PERIOD</span><span class="p">;</span>

	<span class="cm">/* detect hardware version and features */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ene_hw_detect</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_learning_and_tx_capable</span> <span class="o">&amp;&amp;</span> <span class="n">txsim</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_learning_and_tx_capable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_sim_timer</span><span class="p">,</span> <span class="n">ene_tx_irqsim</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Simulation of TX activated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_learning_and_tx_capable</span><span class="p">)</span>
		<span class="n">learning_mode_force</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">driver_type</span> <span class="o">=</span> <span class="n">RC_DRIVER_IR_RAW</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">RC_TYPE_ALL</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">ene_open</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">ene_close</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">s_idle</span> <span class="o">=</span> <span class="n">ene_set_idle</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">ENE_DRIVER_NAME</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">RC_MAP_RC6_MCE</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">=</span> <span class="s">&quot;ENE eHome Infrared Remote Receiver&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_learning_and_tx_capable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">s_learning_mode</span> <span class="o">=</span> <span class="n">ene_set_learning_mode</span><span class="p">;</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_complete</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">tx_ir</span> <span class="o">=</span> <span class="n">ene_transmit</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">s_tx_mask</span> <span class="o">=</span> <span class="n">ene_set_tx_mask</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">s_tx_carrier</span> <span class="o">=</span> <span class="n">ene_set_tx_carrier</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">s_tx_duty_cycle</span> <span class="o">=</span> <span class="n">ene_set_tx_duty_cycle</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">s_carrier_report</span> <span class="o">=</span> <span class="n">ene_set_carrier_report</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">=</span> <span class="s">&quot;ENE eHome Infrared Remote Transceiver&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>

	<span class="n">ene_rx_setup_hw_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ene_setup_default_settings</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ene_setup_hw_settings</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pnp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pnp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* claim the resources */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pnp_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span><span class="p">,</span> <span class="n">ENE_IO_SIZE</span><span class="p">,</span> <span class="n">ENE_DRIVER_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">pnp_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ene_isr</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">ENE_DRIVER_NAME</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">rc_register_device</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;driver has been successfully loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span><span class="p">,</span> <span class="n">ENE_IO_SIZE</span><span class="p">);</span>
<span class="nl">error1:</span>
	<span class="n">rc_free_device</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* main unload function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pnp_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">pnp_dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ene_rx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ene_rx_restore_hw_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_io</span><span class="p">,</span> <span class="n">ENE_IO_SIZE</span><span class="p">);</span>
	<span class="n">rc_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* enable wake on IR (wakes on specific button on original remote) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_enable_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">device_may_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pnp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;wake on IR %s&quot;</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
	<span class="n">ene_set_clear_reg_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ENE_FW1</span><span class="p">,</span> <span class="n">ENE_FW1_WAKE</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pnp_dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">pnp_dev</span><span class="p">);</span>
	<span class="n">ene_enable_wake</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* TODO: add support for wake pattern */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pnp_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">pnp_dev</span><span class="p">);</span>
	<span class="n">ene_setup_hw_settings</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_enabled</span><span class="p">)</span>
		<span class="n">ene_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ene_enable_wake</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pnp_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ene_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">pnp_dev</span><span class="p">);</span>
	<span class="n">ene_enable_wake</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="n">ene_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;ENE0100&quot;</span><span class="p">,},</span>
	<span class="p">{.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;ENE0200&quot;</span><span class="p">,},</span>
	<span class="p">{.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;ENE0201&quot;</span><span class="p">,},</span>
	<span class="p">{.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;ENE0202&quot;</span><span class="p">,},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_driver</span> <span class="n">ene_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ENE_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ene_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">PNP_DRIVER_RES_DO_NOT_CHANGE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ene_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ene_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ene_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ene_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">ene_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ene_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pnp_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ene_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pnp_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ene_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">sample_period</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sample_period</span><span class="p">,</span> <span class="s">&quot;Hardware sample period (50 us default)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">learning_mode_force</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">learning_mode_force</span><span class="p">,</span> <span class="s">&quot;Enable learning mode by default&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">txsim</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">txsim</span><span class="p">,</span>
	<span class="s">&quot;Simulate TX features on unsupported hardware (dangerous)&quot;</span><span class="p">);</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pnp</span><span class="p">,</span> <span class="n">ene_ids</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span>
	<span class="p">(</span><span class="s">&quot;Infrared input driver for KB3926B/C/D/E/F &quot;</span>
	<span class="s">&quot;(aka ENE0100/ENE0200/ENE0201/ENE0202) CIR port&quot;</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Maxim Levitsky&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ene_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ene_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
