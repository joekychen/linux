<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › rc › imon.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>imon.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   imon.c:	input and display driver for SoundGraph iMON IR/VFD/LCD</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright(C) 2010  Jarod Wilson &lt;jarod@wilsonet.com&gt;</span>
<span class="cm"> *   Portions based on the original lirc_imon driver,</span>
<span class="cm"> *	Copyright(C) 2004  Venky Raju(dev@venky.ws)</span>
<span class="cm"> *</span>
<span class="cm"> *   Huge thanks to R. Geoff Newbury for invaluable debugging on the</span>
<span class="cm"> *   0xffdc iMON devices, and for sending me one to hack on, without</span>
<span class="cm"> *   which the support for them wouldn&#39;t be nearly as good. Thanks</span>
<span class="cm"> *   also to the numerous 0xffdc device owners that tested auto-config</span>
<span class="cm"> *   support for me and provided debug dumps from their devices.</span>
<span class="cm"> *</span>
<span class="cm"> *   imon is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;:%s: &quot; fmt, __func__</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>

<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/input.h&gt;</span>
<span class="cp">#include &lt;media/rc-core.h&gt;</span>

<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>

<span class="cp">#define MOD_AUTHOR	&quot;Jarod Wilson &lt;jarod@wilsonet.com&gt;&quot;</span>
<span class="cp">#define MOD_DESC	&quot;Driver for SoundGraph iMON MultiMedia IR/Display&quot;</span>
<span class="cp">#define MOD_NAME	&quot;imon&quot;</span>
<span class="cp">#define MOD_VERSION	&quot;0.9.4&quot;</span>

<span class="cp">#define DISPLAY_MINOR_BASE	144</span>
<span class="cp">#define DEVICE_NAME	&quot;lcd%d&quot;</span>

<span class="cp">#define BUF_CHUNK_SIZE	8</span>
<span class="cp">#define BUF_SIZE	128</span>

<span class="cp">#define BIT_DURATION	250	</span><span class="cm">/* each bit received is 250us */</span><span class="cp"></span>

<span class="cp">#define IMON_CLOCK_ENABLE_PACKETS	2</span>

<span class="cm">/*** P R O T O T Y P E S ***/</span>

<span class="cm">/* USB Callback prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">imon_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">imon_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">usb_rx_callback_intf0</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">usb_rx_callback_intf1</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">usb_tx_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>

<span class="cm">/* suspend/resume support */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">imon_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">imon_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">);</span>

<span class="cm">/* Display file_operations function prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">display_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">display_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>

<span class="cm">/* VFD write operation */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">vfd_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">n_bytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>

<span class="cm">/* LCD file_operations override function prototypes */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">lcd_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">n_bytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>

<span class="cm">/*** G L O B A L S ***/</span>

<span class="k">struct</span> <span class="n">imon_context</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="cm">/* Newer devices have two interfaces */</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev_intf0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev_intf1</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">display_supported</span><span class="p">;</span>		<span class="cm">/* not all controllers do */</span>
	<span class="n">bool</span> <span class="n">display_isopen</span><span class="p">;</span>		<span class="cm">/* display port has been opened */</span>
	<span class="n">bool</span> <span class="n">rf_device</span><span class="p">;</span>			<span class="cm">/* true if iMON 2.4G LT/DT RF device */</span>
	<span class="n">bool</span> <span class="n">rf_isassociating</span><span class="p">;</span>		<span class="cm">/* RF remote associating */</span>
	<span class="n">bool</span> <span class="n">dev_present_intf0</span><span class="p">;</span>		<span class="cm">/* USB device presence, interface 0 */</span>
	<span class="n">bool</span> <span class="n">dev_present_intf1</span><span class="p">;</span>		<span class="cm">/* USB device presence, interface 1 */</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>		<span class="cm">/* to lock this object */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">remove_ok</span><span class="p">;</span>	<span class="cm">/* For unexpected USB disconnects */</span>

	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">rx_endpoint_intf0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">rx_endpoint_intf1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">tx_endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">rx_urb_intf0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">rx_urb_intf1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">tx_urb</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tx_control</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">usb_rx_buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">usb_tx_buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">tx_t</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data_buf</span><span class="p">[</span><span class="mi">35</span><span class="p">];</span>	<span class="cm">/* user data buffer */</span>
		<span class="k">struct</span> <span class="n">completion</span> <span class="n">finished</span><span class="p">;</span>	<span class="cm">/* wait for write to finish */</span>
		<span class="n">bool</span> <span class="n">busy</span><span class="p">;</span>			<span class="cm">/* write in progress */</span>
		<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>			<span class="cm">/* status of tx completion */</span>
	<span class="p">}</span> <span class="n">tx</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">vendor</span><span class="p">;</span>			<span class="cm">/* usb vendor ID */</span>
	<span class="n">u16</span> <span class="n">product</span><span class="p">;</span>			<span class="cm">/* usb product ID */</span>

	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>		<span class="cm">/* rc-core device for remote */</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>		<span class="cm">/* input device for panel &amp; IR mouse */</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">touch</span><span class="p">;</span>	<span class="cm">/* input device for touchscreen */</span>

	<span class="n">spinlock_t</span> <span class="n">kc_lock</span><span class="p">;</span>		<span class="cm">/* make sure we get keycodes right */</span>
	<span class="n">u32</span> <span class="n">kc</span><span class="p">;</span>				<span class="cm">/* current input keycode */</span>
	<span class="n">u32</span> <span class="n">last_keycode</span><span class="p">;</span>		<span class="cm">/* last reported input keycode */</span>
	<span class="n">u32</span> <span class="n">rc_scancode</span><span class="p">;</span>		<span class="cm">/* the computed remote scancode */</span>
	<span class="n">u8</span> <span class="n">rc_toggle</span><span class="p">;</span>			<span class="cm">/* the computed remote toggle bit */</span>
	<span class="n">u64</span> <span class="n">rc_type</span><span class="p">;</span>			<span class="cm">/* iMON or MCE (RC6) IR protocol? */</span>
	<span class="n">bool</span> <span class="n">release_code</span><span class="p">;</span>		<span class="cm">/* some keys send a release code */</span>

	<span class="n">u8</span> <span class="n">display_type</span><span class="p">;</span>		<span class="cm">/* store the display type */</span>
	<span class="n">bool</span> <span class="n">pad_mouse</span><span class="p">;</span>			<span class="cm">/* toggle kbd(0)/mouse(1) mode */</span>

	<span class="kt">char</span> <span class="n">name_rdev</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>		<span class="cm">/* rc input device name */</span>
	<span class="kt">char</span> <span class="n">phys_rdev</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>		<span class="cm">/* rc input device phys path */</span>

	<span class="kt">char</span> <span class="n">name_idev</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>		<span class="cm">/* input device name */</span>
	<span class="kt">char</span> <span class="n">phys_idev</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>		<span class="cm">/* input device phys path */</span>

	<span class="kt">char</span> <span class="n">name_touch</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>		<span class="cm">/* touch screen name */</span>
	<span class="kt">char</span> <span class="n">phys_touch</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>		<span class="cm">/* touch screen phys path */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">ttimer</span><span class="p">;</span>	<span class="cm">/* touch screen timer */</span>
	<span class="kt">int</span> <span class="n">touch_x</span><span class="p">;</span>			<span class="cm">/* x coordinate on touchscreen */</span>
	<span class="kt">int</span> <span class="n">touch_y</span><span class="p">;</span>			<span class="cm">/* y coordinate on touchscreen */</span>
<span class="p">};</span>

<span class="cp">#define TOUCH_TIMEOUT	(HZ/30)</span>

<span class="cm">/* vfd character device file operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">vfd_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">display_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">vfd_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">display_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* lcd character device file operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lcd_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">display_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">lcd_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">display_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">IMON_DISPLAY_TYPE_AUTO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">IMON_DISPLAY_TYPE_VFD</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">IMON_DISPLAY_TYPE_LCD</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">IMON_DISPLAY_TYPE_VGA</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">IMON_DISPLAY_TYPE_NONE</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">IMON_KEY_IMON</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">IMON_KEY_MCE</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">IMON_KEY_PANEL</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * USB Device ID for iMON USB Control Boards</span>
<span class="cm"> *</span>
<span class="cm"> * The Windows drivers contain 6 different inf files, more or less one for</span>
<span class="cm"> * each new device until the 0x0034-0x0046 devices, which all use the same</span>
<span class="cm"> * driver. Some of the devices in the 34-46 range haven&#39;t been definitively</span>
<span class="cm"> * identified yet. Early devices have either a TriGem Computer, Inc. or a</span>
<span class="cm"> * Samsung vendor ID (0x0aa8 and 0x04e8 respectively), while all later</span>
<span class="cm"> * devices use the SoundGraph vendor ID (0x15c2). This driver only supports</span>
<span class="cm"> * the ffdc and later devices, which do onboard decoding.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">imon_usb_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Several devices with this same device ID, all use iMON_PAD.inf</span>
<span class="cm">	 * SoundGraph iMON PAD (IR &amp; VFD)</span>
<span class="cm">	 * SoundGraph iMON PAD (IR &amp; LCD)</span>
<span class="cm">	 * SoundGraph iMON Knob (IR only)</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0xffdc</span><span class="p">)</span> <span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * Newer devices, all driven by the latest iMON Windows driver, full</span>
<span class="cm">	 * list of device IDs extracted via &#39;strings Setup/data1.hdr |grep 15c2&#39;</span>
<span class="cm">	 * Need user input to fill in details on unknown devices.</span>
<span class="cm">	 */</span>
	<span class="cm">/* SoundGraph iMON OEM Touch LCD (IR &amp; 7&quot; VGA LCD) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x0034</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* SoundGraph iMON OEM Touch LCD (IR &amp; 4.3&quot; VGA LCD) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* SoundGraph iMON OEM VFD (IR &amp; VFD) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* device specifics unknown */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x0037</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* SoundGraph iMON OEM LCD (IR &amp; LCD) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x0038</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* SoundGraph iMON UltraBay (IR &amp; LCD) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x0039</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* device specifics unknown */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x003a</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* device specifics unknown */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x003b</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* SoundGraph iMON OEM Inside (IR only) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x003c</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* device specifics unknown */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x003d</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* device specifics unknown */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x003e</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* device specifics unknown */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x003f</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* device specifics unknown */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* SoundGraph iMON MINI (IR only) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x0041</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Antec Veris Multimedia Station EZ External (IR only) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x0042</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Antec Veris Multimedia Station Basic Internal (IR only) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Antec Veris Multimedia Station Elite (IR &amp; VFD) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x0044</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Antec Veris Multimedia Station Premiere (IR &amp; LCD) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x0045</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* device specifics unknown */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x15c2</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="cm">/* USB Device data */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">imon_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">MOD_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">imon_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">imon_disconnect</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">imon_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">imon_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">imon_usb_id_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_class_driver</span> <span class="n">imon_vfd_class</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DEVICE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">vfd_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">minor_base</span>	<span class="o">=</span> <span class="n">DISPLAY_MINOR_BASE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_class_driver</span> <span class="n">imon_lcd_class</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DEVICE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">lcd_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">minor_base</span>	<span class="o">=</span> <span class="n">DISPLAY_MINOR_BASE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* imon receiver front panel/knob key table */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">hw_code</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">keycode</span><span class="p">;</span>
<span class="p">}</span> <span class="n">imon_panel_key_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x000000000f00ffeell</span><span class="p">,</span> <span class="n">KEY_MEDIA</span> <span class="p">},</span> <span class="cm">/* Go */</span>
	<span class="p">{</span> <span class="mh">0x000000001200ffeell</span><span class="p">,</span> <span class="n">KEY_UP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000001300ffeell</span><span class="p">,</span> <span class="n">KEY_DOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000001400ffeell</span><span class="p">,</span> <span class="n">KEY_LEFT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000001500ffeell</span><span class="p">,</span> <span class="n">KEY_RIGHT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000001600ffeell</span><span class="p">,</span> <span class="n">KEY_ENTER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000001700ffeell</span><span class="p">,</span> <span class="n">KEY_ESC</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000001f00ffeell</span><span class="p">,</span> <span class="n">KEY_AUDIO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000002000ffeell</span><span class="p">,</span> <span class="n">KEY_VIDEO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000002100ffeell</span><span class="p">,</span> <span class="n">KEY_CAMERA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000002700ffeell</span><span class="p">,</span> <span class="n">KEY_DVD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000002300ffeell</span><span class="p">,</span> <span class="n">KEY_TV</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000002b00ffeell</span><span class="p">,</span> <span class="n">KEY_EXIT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000002c00ffeell</span><span class="p">,</span> <span class="n">KEY_SELECT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000002d00ffeell</span><span class="p">,</span> <span class="n">KEY_MENU</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000000500ffeell</span><span class="p">,</span> <span class="n">KEY_PREVIOUS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000000700ffeell</span><span class="p">,</span> <span class="n">KEY_REWIND</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000000400ffeell</span><span class="p">,</span> <span class="n">KEY_STOP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000003c00ffeell</span><span class="p">,</span> <span class="n">KEY_PLAYPAUSE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000000800ffeell</span><span class="p">,</span> <span class="n">KEY_FASTFORWARD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000000600ffeell</span><span class="p">,</span> <span class="n">KEY_NEXT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000010000ffeell</span><span class="p">,</span> <span class="n">KEY_RIGHT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000001000000ffeell</span><span class="p">,</span> <span class="n">KEY_LEFT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000003d00ffeell</span><span class="p">,</span> <span class="n">KEY_SELECT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000100000000ffeell</span><span class="p">,</span> <span class="n">KEY_VOLUMEUP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x010000000000ffeell</span><span class="p">,</span> <span class="n">KEY_VOLUMEDOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000000000100ffeell</span><span class="p">,</span> <span class="n">KEY_MUTE</span> <span class="p">},</span>
	<span class="cm">/* 0xffdc iMON MCE VFD */</span>
	<span class="p">{</span> <span class="mh">0x00010000ffffffeell</span><span class="p">,</span> <span class="n">KEY_VOLUMEUP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01000000ffffffeell</span><span class="p">,</span> <span class="n">KEY_VOLUMEDOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00000001ffffffeell</span><span class="p">,</span> <span class="n">KEY_MUTE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0000000fffffffeell</span><span class="p">,</span> <span class="n">KEY_MEDIA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00000012ffffffeell</span><span class="p">,</span> <span class="n">KEY_UP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00000013ffffffeell</span><span class="p">,</span> <span class="n">KEY_DOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00000014ffffffeell</span><span class="p">,</span> <span class="n">KEY_LEFT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00000015ffffffeell</span><span class="p">,</span> <span class="n">KEY_RIGHT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00000016ffffffeell</span><span class="p">,</span> <span class="n">KEY_ENTER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00000017ffffffeell</span><span class="p">,</span> <span class="n">KEY_ESC</span> <span class="p">},</span>
	<span class="cm">/* iMON Knob values */</span>
	<span class="p">{</span> <span class="mh">0x000100ffffffffeell</span><span class="p">,</span> <span class="n">KEY_VOLUMEUP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x010000ffffffffeell</span><span class="p">,</span> <span class="n">KEY_VOLUMEDOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000008ffffffffeell</span><span class="p">,</span> <span class="n">KEY_MUTE</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* to prevent races between open() and disconnect(), probing, etc */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">driver_lock</span><span class="p">);</span>

<span class="cm">/* Module bookkeeping bits */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">MOD_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">MOD_DESC</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">MOD_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">imon_usb_id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug messages: 0=no, 1=yes (default: no)&quot;</span><span class="p">);</span>

<span class="cm">/* lcd, vfd, vga or none? should be auto-detected, but can be overridden... */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">display_type</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">display_type</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">display_type</span><span class="p">,</span> <span class="s">&quot;Type of attached display. 0=autodetect, &quot;</span>
		 <span class="s">&quot;1=vfd, 2=lcd, 3=vga, 4=none (default: autodetect)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pad_stabilize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pad_stabilize</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pad_stabilize</span><span class="p">,</span> <span class="s">&quot;Apply stabilization algorithm to iMON PAD &quot;</span>
		 <span class="s">&quot;presses in arrow key mode. 0=disable, 1=enable (default).&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * In certain use cases, mouse mode isn&#39;t really helpful, and could actually</span>
<span class="cm"> * cause confusion, so allow disabling it when the IR device is open.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">nomouse</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nomouse</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nomouse</span><span class="p">,</span> <span class="s">&quot;Disable mouse input device mode when IR device is &quot;</span>
		 <span class="s">&quot;open. 0=don&#39;t disable, 1=disable. (default: don&#39;t disable)&quot;</span><span class="p">);</span>

<span class="cm">/* threshold at which a pad push registers as an arrow key in kbd mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pad_thresh</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pad_thresh</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pad_thresh</span><span class="p">,</span> <span class="s">&quot;Threshold at which a pad push registers as an &quot;</span>
		 <span class="s">&quot;arrow key in kbd mode (default: 28)&quot;</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_imon_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf0</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf1</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: iMON context freed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Called when the Display device (e.g. /dev/lcd0)</span>
<span class="cm"> * is opened by the application.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">display_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">subminor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* prevent races with disconnect */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>

	<span class="n">subminor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">interface</span> <span class="o">=</span> <span class="n">usb_find_interface</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imon_driver</span><span class="p">,</span> <span class="n">subminor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;could not find interface for minor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">subminor</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ictx</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no context found for minor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">subminor</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;display not supported by device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_isopen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;display port is already open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_isopen</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ictx</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;display port opened</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Called when the display device (e.g. /dev/lcd0)</span>
<span class="cm"> * is closed by the application.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">display_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ictx</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no context for device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;display not supported by device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_isopen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;display is not open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_isopen</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;display port closed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Sends a packet to the device -- this function must be called with</span>
<span class="cm"> * ictx-&gt;lock held, or its unlock/lock sequence while waiting for tx</span>
<span class="cm"> * to complete can/will lead to a deadlock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">control_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Check if we need to use control or interrupt urb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx_control</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndintpipe</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="p">,</span>
				      <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx_endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
		<span class="n">interval</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx_endpoint</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">;</span>

		<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span>
				 <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_tx_buf</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_tx_buf</span><span class="p">),</span>
				 <span class="n">usb_tx_callback</span><span class="p">,</span> <span class="n">ictx</span><span class="p">,</span> <span class="n">interval</span><span class="p">);</span>

		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* fill request into kmalloc&#39;ed space: */</span>
		<span class="n">control_req</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ctrlrequest</span><span class="p">),</span>
				      <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control_req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="cm">/* setup packet is &#39;21 09 0200 0001 0008&#39; */</span>
		<span class="n">control_req</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
		<span class="n">control_req</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
		<span class="n">control_req</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0200</span><span class="p">);</span>
		<span class="n">control_req</span><span class="o">-&gt;</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">);</span>
		<span class="n">control_req</span><span class="o">-&gt;</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0008</span><span class="p">);</span>

		<span class="cm">/* control pipe is endpoint 0x00 */</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* build the control urb */</span>
		<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="p">,</span>
				     <span class="n">pipe</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">control_req</span><span class="p">,</span>
				     <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_tx_buf</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_tx_buf</span><span class="p">),</span>
				     <span class="n">usb_tx_callback</span><span class="p">,</span> <span class="n">ictx</span><span class="p">);</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">finished</span><span class="p">);</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">smp_rmb</span><span class="p">();</span> <span class="cm">/* ensure later readers know we&#39;re busy */</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">smp_rmb</span><span class="p">();</span> <span class="cm">/* ensure later readers know we&#39;re not busy */</span>
		<span class="n">pr_err_ratelimited</span><span class="p">(</span><span class="s">&quot;error submitting urb(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Wait for transmission to complete (or abort) */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">finished</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="n">pr_err_ratelimited</span><span class="p">(</span><span class="s">&quot;task interrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="n">pr_err_ratelimited</span><span class="p">(</span><span class="s">&quot;packet tx failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">control_req</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Induce a mandatory 5ms delay before returning, as otherwise,</span>
<span class="cm">	 * send_packet can get called so rapidly as to overwhelm the device,</span>
<span class="cm">	 * particularly on faster systems and/or those with quirky usb.</span>
<span class="cm">	 */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Sends an associate packet to the iMON 2.4G.</span>
<span class="cm"> *</span>
<span class="cm"> * This might not be such a good idea, since it has an id collision with</span>
<span class="cm"> * some versions of the &quot;IR &amp; VFD&quot; combo. The only way to determine if it</span>
<span class="cm"> * is an RF version is to look at the product description string. (Which</span>
<span class="cm"> * we currently do not fetch).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_associate_24g</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">packet</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
					  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no context for device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev_present_intf0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no iMON device present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_tx_buf</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">packet</span><span class="p">));</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">send_packet</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Sends packets to setup and show clock on iMON display</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments: year - last 2 digits of year, month - 1..12,</span>
<span class="cm"> * day - 1..31, dow - day of the week (0-Sun...6-Sat),</span>
<span class="cm"> * hour - 0..23, minute - 0..59, second - 0..59</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_set_imon_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">year</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">month</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">day</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dow</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hour</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minute</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">second</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">clock_enable_pkt</span><span class="p">[</span><span class="n">IMON_CLOCK_ENABLE_PACKETS</span><span class="p">][</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no context for device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IMON_DISPLAY_TYPE_LCD</span>:
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">year</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">day</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">hour</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">minute</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">second</span><span class="p">;</span>

		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">==</span> <span class="mh">0xffdc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
			<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x51</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
			<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8a</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IMON_DISPLAY_TYPE_VFD</span>:
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">year</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">day</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dow</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">hour</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">minute</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">second</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clock_enable_pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x42</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMON_CLOCK_ENABLE_PACKETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_tx_buf</span><span class="p">,</span> <span class="n">clock_enable_pkt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">send_packet</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;send_packet failed for packet %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * These are the sysfs functions to handle the association on the iMON 2.4G LT.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_associate_remote</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rf_isassociating</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;associating</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;closed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">&quot;Visit http://www.lirc.org/html/imon-24g.html for &quot;</span>
		 <span class="s">&quot;instructions on how to associate your iMON 2.4G DT/LT &quot;</span>
		 <span class="s">&quot;remote</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_associate_remote</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">;</span>

	<span class="n">ictx</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rf_isassociating</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">send_associate_24g</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sysfs functions to control internal imon clock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_imon_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;Not supported.&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
			<span class="s">&quot;To set the clock on your iMON display:</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;# date </span><span class="se">\&quot;</span><span class="s">+%%y %%m %%d %%w %%H %%M %%S</span><span class="se">\&quot;</span><span class="s"> &gt; imon_clock</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_isopen</span> <span class="o">?</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">NOTE: imon device must be closed</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_imon_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">dow</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_isopen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u %u %u %u %u %u %u&quot;</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">year</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">month</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">day</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dow</span><span class="p">,</span>
		   <span class="o">&amp;</span><span class="n">hour</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">second</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">month</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">month</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">day</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">day</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dow</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hour</span> <span class="o">&gt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">minute</span> <span class="o">&gt;</span> <span class="mi">59</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">second</span> <span class="o">&gt;</span> <span class="mi">59</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">send_set_imon_clock</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">dow</span><span class="p">,</span>
				     <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">imon_clock</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_imon_clock</span><span class="p">,</span>
		   <span class="n">store_imon_clock</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">associate_remote</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_associate_remote</span><span class="p">,</span>
		   <span class="n">store_associate_remote</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">imon_display_sysfs_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_imon_clock</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">imon_display_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">imon_display_sysfs_entries</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">imon_rf_sysfs_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_associate_remote</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">imon_rf_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">imon_rf_sysfs_entries</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Writes data to the VFD.  The iMON VFD is 2x16 characters</span>
<span class="cm"> * and requires data in 5 consecutive USB interrupt packets,</span>
<span class="cm"> * each packet but the last carrying 7 bytes.</span>
<span class="cm"> *</span>
<span class="cm"> * I don&#39;t know if the VFD board supports features such as</span>
<span class="cm"> * scrolling, clearing rows, blanking, etc. so at</span>
<span class="cm"> * the caller must provide a full screen of data.  If fewer</span>
<span class="cm"> * than 32 bytes are provided spaces will be appended to</span>
<span class="cm"> * generate a full screen.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">vfd_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">n_bytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">seq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vfd_packet6</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span> <span class="p">};</span>

	<span class="n">ictx</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err_ratelimited</span><span class="p">(</span><span class="s">&quot;no context for device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev_present_intf0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err_ratelimited</span><span class="p">(</span><span class="s">&quot;no iMON device present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_bytes</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">n_bytes</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err_ratelimited</span><span class="p">(</span><span class="s">&quot;invalid payload size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">n_bytes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Pad with spaces */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">n_bytes</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">35</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_tx_buf</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_tx_buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">seq</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">send_packet</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err_ratelimited</span><span class="p">(</span><span class="s">&quot;send packet #%d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seq</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">seq</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">35</span><span class="p">);</span>

	<span class="cm">/* Send packet #6 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_tx_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vfd_packet6</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vfd_packet6</span><span class="p">));</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_tx_buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">seq</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">send_packet</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">pr_err_ratelimited</span><span class="p">(</span><span class="s">&quot;send packet #%d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seq</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="o">?</span> <span class="n">n_bytes</span> <span class="o">:</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Writes data to the LCD.  The iMON OEM LCD screen expects 8-byte</span>
<span class="cm"> * packets. We accept data as 16 hexadecimal digits, followed by a</span>
<span class="cm"> * newline (to make it easy to drive the device from a command-line</span>
<span class="cm"> * -- even though the actual binary data is a bit complicated).</span>
<span class="cm"> *</span>
<span class="cm"> * The device itself is not a &quot;traditional&quot; text-mode display. It&#39;s</span>
<span class="cm"> * actually a 16x96 pixel bitmap display. That means if you want to</span>
<span class="cm"> * display text, you&#39;ve got to have your own &quot;font&quot; and translate the</span>
<span class="cm"> * text into bitmaps for display. This is really flexible (you can</span>
<span class="cm"> * display whatever diacritics you need, and so on), but it&#39;s also</span>
<span class="cm"> * a lot more complicated than most LCDs...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">lcd_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">n_bytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">;</span>

	<span class="n">ictx</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err_ratelimited</span><span class="p">(</span><span class="s">&quot;no context for device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err_ratelimited</span><span class="p">(</span><span class="s">&quot;no iMON display present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_bytes</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err_ratelimited</span><span class="p">(</span><span class="s">&quot;invalid payload size: %d (expected 8)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">n_bytes</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_tx_buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">send_packet</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err_ratelimited</span><span class="p">(</span><span class="s">&quot;send packet failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: write %d bytes to LCD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">n_bytes</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="o">?</span> <span class="n">n_bytes</span> <span class="o">:</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Callback function for USB core API: transmit data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usb_tx_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ictx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="cm">/* notify waiters that write has finished */</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">smp_rmb</span><span class="p">();</span> <span class="cm">/* ensure later readers know we&#39;re not busy */</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">finished</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * report touchscreen input</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">imon_touch_display_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">!=</span> <span class="n">IMON_DISPLAY_TYPE_VGA</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch_x</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch_y</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iMON IR receivers support two different signal sets -- those used by</span>
<span class="cm"> * the iMON remotes, and those used by the Windows MCE remotes (which is</span>
<span class="cm"> * really just RC-6), but only one or the other at a time, as the signals</span>
<span class="cm"> * are decoded onboard the receiver.</span>
<span class="cm"> *</span>
<span class="cm"> * This function gets called two different ways, one way is from</span>
<span class="cm"> * rc_register_device, for initial protocol selection/setup, and the other is</span>
<span class="cm"> * via a userspace-initiated protocol change request, either by direct sysfs</span>
<span class="cm"> * prodding or by something like ir-keytable. In the rc_register_device case,</span>
<span class="cm"> * the imon context lock is already held, but when initiated from userspace,</span>
<span class="cm"> * it is not, so we must acquire it prior to calling send_packet, which</span>
<span class="cm"> * requires that the lock is held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">imon_ir_change_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">rc_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">unlock</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ir_proto_packet</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x86</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc_type</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rc_type</span> <span class="o">&amp;</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">allowed_protos</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Looks like you&#39;re trying to use an IR protocol &quot;</span>
			 <span class="s">&quot;this device does not support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rc_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RC_TYPE_RC6</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Configuring IR receiver for MCE protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ir_proto_packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RC_TYPE_UNKNOWN</span>:
	<span class="k">case</span> <span class="n">RC_TYPE_OTHER</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Configuring IR receiver for iMON protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pad_stabilize</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PAD stabilize functionality disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* ir_proto_packet[0] = 0x00; // already the default */</span>
		<span class="n">rc_type</span> <span class="o">=</span> <span class="n">RC_TYPE_OTHER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unsupported IR protocol specified, overriding &quot;</span>
			 <span class="s">&quot;to iMON IR protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pad_stabilize</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PAD stabilize functionality disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* ir_proto_packet[0] = 0x00; // already the default */</span>
		<span class="n">rc_type</span> <span class="o">=</span> <span class="n">RC_TYPE_OTHER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_tx_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ir_proto_packet</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir_proto_packet</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">unlock</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">send_packet</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rc_type</span> <span class="o">=</span> <span class="n">rc_type</span><span class="p">;</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">pad_mouse</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlock</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tv2int</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">usecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sec</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">tv_usec</span> <span class="o">&gt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usecs</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="n">sec</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usecs</span> <span class="o">+=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">;</span>

	<span class="n">sec</span> <span class="o">+=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">sec</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">usecs</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">sec</span> <span class="o">+=</span> <span class="n">usecs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sec</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sec</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * The directional pad behaves a bit differently, depending on whether this is</span>
<span class="cm"> * one of the older ffdc devices or a newer device. Newer devices appear to</span>
<span class="cm"> * have a higher resolution matrix for more precise mouse movement, but it</span>
<span class="cm"> * makes things overly sensitive in keyboard mode, so we do some interesting</span>
<span class="cm"> * contortions to make it less touchy. Older devices run through the same</span>
<span class="cm"> * routine with shorter timeout and a smaller threshold.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stabilize</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="n">u16</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">u16</span> <span class="n">threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">ct</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="n">prev_time</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="n">hit_time</span>  <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">prev_result</span><span class="p">,</span> <span class="n">hits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msec</span><span class="p">,</span> <span class="n">msec_hit</span><span class="p">;</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="p">);</span>
	<span class="n">msec</span> <span class="o">=</span> <span class="n">tv2int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev_time</span><span class="p">);</span>
	<span class="n">msec_hit</span> <span class="o">=</span> <span class="n">tv2int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hit_time</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msec</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">x</span> <span class="o">+=</span> <span class="n">a</span><span class="p">;</span>
	<span class="n">y</span> <span class="o">+=</span> <span class="n">b</span><span class="p">;</span>

	<span class="n">prev_time</span> <span class="o">=</span> <span class="n">ct</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="o">||</span> <span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x7F</span> <span class="o">:</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x7F00</span> <span class="o">:</span> <span class="mh">0x8000</span><span class="p">;</span>

		<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">prev_result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hits</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hits</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mh">0x7F</span>:
					<span class="n">y</span> <span class="o">=</span> <span class="mi">17</span> <span class="o">*</span> <span class="n">threshold</span> <span class="o">/</span> <span class="mi">30</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x80</span>:
					<span class="n">y</span> <span class="o">-=</span> <span class="mi">17</span> <span class="o">*</span> <span class="n">threshold</span> <span class="o">/</span> <span class="mi">30</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x7F00</span>:
					<span class="n">x</span> <span class="o">=</span> <span class="mi">17</span> <span class="o">*</span> <span class="n">threshold</span> <span class="o">/</span> <span class="mi">30</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x8000</span>:
					<span class="n">x</span> <span class="o">-=</span> <span class="mi">17</span> <span class="o">*</span> <span class="n">threshold</span> <span class="o">/</span> <span class="mi">30</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hits</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">msec_hit</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">prev_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
			<span class="n">hits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hit_time</span> <span class="o">=</span> <span class="n">ct</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">imon_remote_key_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">scancode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">keycode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">release</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_release_code</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Look for the initial press of a button */</span>
	<span class="n">keycode</span> <span class="o">=</span> <span class="n">rc_g_keycode_from_table</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">scancode</span><span class="p">);</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rc_toggle</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rc_scancode</span> <span class="o">=</span> <span class="n">scancode</span><span class="p">;</span>

	<span class="cm">/* Look for the release of a button */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">==</span> <span class="n">KEY_RESERVED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release</span> <span class="o">=</span> <span class="n">scancode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x4000</span><span class="p">;</span>
		<span class="n">keycode</span> <span class="o">=</span> <span class="n">rc_g_keycode_from_table</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">release</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">!=</span> <span class="n">KEY_RESERVED</span><span class="p">)</span>
			<span class="n">is_release_code</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">release_code</span> <span class="o">=</span> <span class="n">is_release_code</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">keycode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">imon_mce_key_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">scancode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">keycode</span><span class="p">;</span>

<span class="cp">#define MCE_KEY_MASK 0x7000</span>
<span class="cp">#define MCE_TOGGLE_BIT 0x8000</span>

	<span class="cm">/*</span>
<span class="cm">	 * On some receivers, mce keys decode to 0x8000f04xx and 0x8000f84xx</span>
<span class="cm">	 * (the toggle bit flipping between alternating key presses), while</span>
<span class="cm">	 * on other receivers, we see 0x8000f74xx and 0x8000ff4xx. To keep</span>
<span class="cm">	 * the table trim, we always or in the bits to look up 0x8000ff4xx,</span>
<span class="cm">	 * but we can&#39;t or them into all codes, as some keys are decoded in</span>
<span class="cm">	 * a different way w/o the same use of the toggle bit...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scancode</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span>
		<span class="n">scancode</span> <span class="o">=</span> <span class="n">scancode</span> <span class="o">|</span> <span class="n">MCE_KEY_MASK</span> <span class="o">|</span> <span class="n">MCE_TOGGLE_BIT</span><span class="p">;</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rc_scancode</span> <span class="o">=</span> <span class="n">scancode</span><span class="p">;</span>
	<span class="n">keycode</span> <span class="o">=</span> <span class="n">rc_g_keycode_from_table</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">scancode</span><span class="p">);</span>

	<span class="cm">/* not used in mce mode, but make sure we know its false */</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">release_code</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">keycode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">imon_panel_key_lookup</span><span class="p">(</span><span class="n">u64</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">keycode</span> <span class="o">=</span> <span class="n">KEY_RESERVED</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">imon_panel_key_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imon_panel_key_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_code</span> <span class="o">==</span> <span class="p">(</span><span class="n">code</span> <span class="o">|</span> <span class="mh">0xffee</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">keycode</span> <span class="o">=</span> <span class="n">imon_panel_key_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">keycode</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">keycode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">imon_mouse_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">rel_x</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">rel_y</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">right_shift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">mouse_input</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* newer iMON device PAD or mouse button */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">!=</span> <span class="mh">0xffdc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rel_x</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">rel_y</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">right_shift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* 0xffdc iMON PAD or mouse button input */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">==</span> <span class="mh">0xffdc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rel_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
			<span class="n">rel_x</span> <span class="o">|=</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">rel_x</span> <span class="o">=</span> <span class="n">rel_x</span> <span class="o">+</span> <span class="n">rel_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">rel_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="n">rel_y</span> <span class="o">|=</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">rel_y</span> <span class="o">=</span> <span class="n">rel_y</span> <span class="o">+</span> <span class="n">rel_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">right_shift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* some ffdc devices decode mouse buttons differently... */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">==</span> <span class="mh">0xffdc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x68</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">right_shift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* ch+/- buttons, which we use for an emulated scroll wheel */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">==</span> <span class="n">KEY_CHANNELUP</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">==</span> <span class="n">KEY_CHANNELDOWN</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mouse_input</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mouse_input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sending mouse data via input subsystem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">,</span> <span class="n">REL_WHEEL</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rel_x</span> <span class="o">||</span> <span class="n">rel_y</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span> <span class="n">rel_x</span><span class="p">);</span>
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="n">rel_y</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span>
					 <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">right_shift</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">last_keycode</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mouse_input</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">imon_touch_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ttimer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">TOUCH_TIMEOUT</span><span class="p">);</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch_y</span> <span class="o">=</span> <span class="mh">0xfff</span> <span class="o">-</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch_x</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch_y</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">imon_pad_to_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rel_x</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">rel_y</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">threshold</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scancode</span> <span class="o">=</span> <span class="n">KEY_RESERVED</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The imon directional pad functions more like a touchpad. Bytes 3 &amp; 4</span>
<span class="cm">	 * contain a position coordinate (x,y), with each component ranging</span>
<span class="cm">	 * from -14 to 14. We want to down-sample this to only 4 discrete values</span>
<span class="cm">	 * for up/down/left/right arrow keys. Also, when you get too close to</span>
<span class="cm">	 * diagonals, it has a tendency to jump back and forth, so lets try to</span>
<span class="cm">	 * ignore when they get too close.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">!=</span> <span class="mh">0xffdc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* first, pad to 8 bytes so it conforms with everything else */</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>	<span class="cm">/* in msecs */</span>
		<span class="cm">/* (2*threshold) x (2*threshold) square */</span>
		<span class="n">threshold</span> <span class="o">=</span> <span class="n">pad_thresh</span> <span class="o">?</span> <span class="n">pad_thresh</span> <span class="o">:</span> <span class="mi">28</span><span class="p">;</span>
		<span class="n">rel_x</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">rel_y</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rc_type</span> <span class="o">==</span> <span class="n">RC_TYPE_OTHER</span> <span class="o">&amp;&amp;</span> <span class="n">pad_stabilize</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">rel_x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rel_y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dir</span> <span class="o">=</span> <span class="n">stabilize</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">rel_x</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">rel_y</span><span class="p">,</span>
						<span class="n">timeout</span><span class="p">,</span> <span class="n">threshold</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span>
							  <span class="n">flags</span><span class="p">);</span>
					<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">=</span> <span class="n">KEY_UNKNOWN</span><span class="p">;</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span>
							       <span class="n">flags</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
				<span class="n">scancode</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Hack alert: instead of using keycodes, we have</span>
<span class="cm">			 * to use hard-coded scancodes here...</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">rel_y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">abs</span><span class="p">(</span><span class="n">rel_x</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rel_y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x7F</span> <span class="o">:</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rel_y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">scancode</span> <span class="o">=</span> <span class="mh">0x01007f00</span><span class="p">;</span> <span class="cm">/* KEY_DOWN */</span>
				<span class="k">else</span>
					<span class="n">scancode</span> <span class="o">=</span> <span class="mh">0x01008000</span><span class="p">;</span> <span class="cm">/* KEY_UP */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rel_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x7F</span> <span class="o">:</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rel_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">scancode</span> <span class="o">=</span> <span class="mh">0x0100007f</span><span class="p">;</span> <span class="cm">/* KEY_RIGHT */</span>
				<span class="k">else</span>
					<span class="n">scancode</span> <span class="o">=</span> <span class="mh">0x01000080</span><span class="p">;</span> <span class="cm">/* KEY_LEFT */</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle on-board decoded pad events for e.g. older VFD/iMON-Pad</span>
<span class="cm">	 * device (15c2:ffdc). The remote generates various codes from</span>
<span class="cm">	 * 0x68nnnnB7 to 0x6AnnnnB7, the left mouse button generates</span>
<span class="cm">	 * 0x688301b7 and the right one 0x688481b7. All other keys generate</span>
<span class="cm">	 * 0x2nnnnnnn. Position coordinate is encoded in buf[1] and buf[2] with</span>
<span class="cm">	 * reversed endianess. Extract direction from buffer, rotate endianess,</span>
<span class="cm">	 * adjust sign and feed the values into stabilize(). The resulting codes</span>
<span class="cm">	 * will be 0x01008000, 0x01007F00, which match the newer devices.</span>
<span class="cm">	 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* in msecs */</span>
		<span class="cm">/* (2*threshold) x (2*threshold) square */</span>
		<span class="n">threshold</span> <span class="o">=</span> <span class="n">pad_thresh</span> <span class="o">?</span> <span class="n">pad_thresh</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span>

		<span class="cm">/* buf[1] is x */</span>
		<span class="n">rel_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
			<span class="n">rel_x</span> <span class="o">|=</span> <span class="o">~</span><span class="mh">0x10</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* buf[2] is y */</span>
		<span class="n">rel_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="n">rel_y</span> <span class="o">|=</span> <span class="o">~</span><span class="mh">0x10</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rc_type</span> <span class="o">==</span> <span class="n">RC_TYPE_OTHER</span> <span class="o">&amp;&amp;</span> <span class="n">pad_stabilize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dir</span> <span class="o">=</span> <span class="n">stabilize</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">rel_x</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">rel_y</span><span class="p">,</span>
					<span class="n">timeout</span><span class="p">,</span> <span class="n">threshold</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">=</span> <span class="n">KEY_UNKNOWN</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">scancode</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Hack alert: instead of using keycodes, we have</span>
<span class="cm">			 * to use hard-coded scancodes here...</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">rel_y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">abs</span><span class="p">(</span><span class="n">rel_x</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rel_y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x7F</span> <span class="o">:</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rel_y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">scancode</span> <span class="o">=</span> <span class="mh">0x01007f00</span><span class="p">;</span> <span class="cm">/* KEY_DOWN */</span>
				<span class="k">else</span>
					<span class="n">scancode</span> <span class="o">=</span> <span class="mh">0x01008000</span><span class="p">;</span> <span class="cm">/* KEY_UP */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rel_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x7F</span> <span class="o">:</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rel_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">scancode</span> <span class="o">=</span> <span class="mh">0x0100007f</span><span class="p">;</span> <span class="cm">/* KEY_RIGHT */</span>
				<span class="k">else</span>
					<span class="n">scancode</span> <span class="o">=</span> <span class="mh">0x01000080</span><span class="p">;</span> <span class="cm">/* KEY_LEFT */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scancode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">=</span> <span class="n">imon_remote_key_lookup</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">scancode</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * figure out if these is a press or a release. We don&#39;t actually</span>
<span class="cm"> * care about repeats, as those will be auto-generated within the IR</span>
<span class="cm"> * subsystem for repeating scancodes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">imon_parse_press_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ktype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">press_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* key release of 0x02XXXXXX key */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">==</span> <span class="n">KEY_RESERVED</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x02</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">last_keycode</span><span class="p">;</span>

	<span class="cm">/* mouse button release on (some) 0xffdc devices */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">==</span> <span class="n">KEY_RESERVED</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x68</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x82</span> <span class="o">&amp;&amp;</span>
		 <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x81</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xb7</span><span class="p">)</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">last_keycode</span><span class="p">;</span>

	<span class="cm">/* mouse button release on (some other) 0xffdc devices */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">==</span> <span class="n">KEY_RESERVED</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
		 <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x81</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xb7</span><span class="p">)</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">last_keycode</span><span class="p">;</span>

	<span class="cm">/* mce-specific button handling, no keyup events */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ktype</span> <span class="o">==</span> <span class="n">IMON_KEY_MCE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rc_toggle</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">press_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* incoherent or irrelevant data */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">==</span> <span class="n">KEY_RESERVED</span><span class="p">)</span>
		<span class="n">press_type</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* key release of 0xXXXXXXb7 key */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">release_code</span><span class="p">)</span>
		<span class="n">press_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* this is a button press */</span>
	<span class="k">else</span>
		<span class="n">press_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">press_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Process the incoming packet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">imon_incoming_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">kc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">scancode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">press_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="n">prev_time</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">ktype</span><span class="p">;</span>

	<span class="cm">/* filter out junk data on the older 0xffdc imon devices */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Figure out what key was pressed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xee</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scancode</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">));</span>
		<span class="n">ktype</span> <span class="o">=</span> <span class="n">IMON_KEY_PANEL</span><span class="p">;</span>
		<span class="n">kc</span> <span class="o">=</span> <span class="n">imon_panel_key_lookup</span><span class="p">(</span><span class="n">scancode</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scancode</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rc_type</span> <span class="o">==</span> <span class="n">RC_TYPE_RC6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ktype</span> <span class="o">=</span> <span class="n">IMON_KEY_IMON</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">ktype</span> <span class="o">=</span> <span class="n">IMON_KEY_MCE</span><span class="p">;</span>
			<span class="n">kc</span> <span class="o">=</span> <span class="n">imon_mce_key_lookup</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">scancode</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ktype</span> <span class="o">=</span> <span class="n">IMON_KEY_IMON</span><span class="p">;</span>
			<span class="n">kc</span> <span class="o">=</span> <span class="n">imon_remote_key_lookup</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">scancode</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* keyboard/mouse mode toggle button */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kc</span> <span class="o">==</span> <span class="n">KEY_KEYBOARD</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">release_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">last_keycode</span> <span class="o">=</span> <span class="n">kc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nomouse</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">pad_mouse</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">pad_mouse</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;toggling to %s mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">pad_mouse</span> <span class="o">?</span> <span class="s">&quot;mouse&quot;</span> <span class="o">:</span> <span class="s">&quot;keyboard&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">pad_mouse</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mouse mode disabled, passing key value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">=</span> <span class="n">kc</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* send touchscreen events through input subsystem if touchpad data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">IMON_DISPLAY_TYPE_VGA</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
	    <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x86</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">imon_touch_event</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* look for mouse events with pad in mouse mode */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">pad_mouse</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imon_mouse_event</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now for some special handling to convert pad input to arrow keys */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">len</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">len</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">imon_pad_to_keys</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;intf%d decoded packet: &quot;</span><span class="p">,</span> <span class="n">intf</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">press_type</span> <span class="o">=</span> <span class="n">imon_parse_press_type</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ktype</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">press_type</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">not_input_data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">==</span> <span class="n">KEY_UNKNOWN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unknown_key</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ktype</span> <span class="o">!=</span> <span class="n">IMON_KEY_PANEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">press_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc_keyup</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rc_keydown</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rc_scancode</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rc_toggle</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">last_keycode</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Only panel type events left to process now */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="cm">/* KEY_MUTE repeats from knob need to be suppressed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">==</span> <span class="n">KEY_MUTE</span> <span class="o">&amp;&amp;</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span> <span class="o">==</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">last_keycode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msec</span> <span class="o">=</span> <span class="n">tv2int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev_time</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msec</span> <span class="o">&lt;</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_DELAY</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">prev_time</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">kc</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="n">press_type</span><span class="p">);</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>

	<span class="cm">/* panel keys don&#39;t generate a release */</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">last_keycode</span> <span class="o">=</span> <span class="n">kc</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">unknown_key:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: unknown keypress, code 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">scancode</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">not_input_data:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;imon %s: invalid incoming packet &quot;</span>
			 <span class="s">&quot;size (len = %d, intf%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">intf</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* iMON 2.4G associate frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
	    <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span> <span class="o">&amp;&amp;</span>				<span class="cm">/* REFID */</span>
	    <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span> <span class="o">&amp;&amp;</span>
	    <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span> <span class="o">&amp;&amp;</span>
	    <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span> <span class="o">&amp;&amp;</span>				<span class="cm">/* iMON 2.4G */</span>
	   <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4E</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xDF</span><span class="p">)</span> <span class="o">||</span>	<span class="cm">/* LT */</span>
	    <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x5E</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xDF</span><span class="p">)))</span> <span class="p">{</span>	<span class="cm">/* DT */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: remote associated refid=%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rf_isassociating</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Callback function for USB core API: receive data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usb_rx_callback_intf0</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intfnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ictx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if we get a callback before we&#39;re done configuring the hardware, we</span>
<span class="cm">	 * can&#39;t yet process the data, as there&#39;s nowhere to send it, but we</span>
<span class="cm">	 * still need to submit a new rx URB to avoid wedging the hardware</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev_present_intf0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:		<span class="cm">/* usbcore unlink successful! */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:	<span class="cm">/* transport endpoint was shut down */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">imon_incoming_packet</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">intfnum</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;imon %s: status(%d): ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usb_rx_callback_intf1</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intfnum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ictx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if we get a callback before we&#39;re done configuring the hardware, we</span>
<span class="cm">	 * can&#39;t yet process the data, as there&#39;s nowhere to send it, but we</span>
<span class="cm">	 * still need to submit a new rx URB to avoid wedging the hardware</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev_present_intf1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:		<span class="cm">/* usbcore unlink successful! */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:	<span class="cm">/* transport endpoint was shut down */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">imon_incoming_packet</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">intfnum</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;imon %s: status(%d): ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf1</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The 0x15c2:0xffdc device ID was used for umpteen different imon</span>
<span class="cm"> * devices, and all of them constantly spew interrupts, even when there</span>
<span class="cm"> * is no actual data to report. However, byte 6 of this buffer looks like</span>
<span class="cm"> * its unique across device variants, so we&#39;re trying to key off that to</span>
<span class="cm"> * figure out which display type (if any) and what IR protocol the device</span>
<span class="cm"> * actually supports. These devices have their IR protocol hard-coded into</span>
<span class="cm"> * their firmware, they can&#39;t be changed on the fly like the newer hardware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">imon_get_ffdc_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ffdc_cfg_byte</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_rx_buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">detected_display_type</span> <span class="o">=</span> <span class="n">IMON_DISPLAY_TYPE_NONE</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">RC_TYPE_OTHER</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ffdc_cfg_byte</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* iMON Knob, no display, iMON IR + vol knob */</span>
	<span class="k">case</span> <span class="mh">0x21</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;0xffdc iMON Knob, iMON IR&quot;</span><span class="p">);</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_supported</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* iMON 2.4G LT (usb stick), no display, iMON RF */</span>
	<span class="k">case</span> <span class="mh">0x4e</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;0xffdc iMON 2.4G LT, iMON RF&quot;</span><span class="p">);</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_supported</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rf_device</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* iMON VFD, no IR (does have vol knob tho) */</span>
	<span class="k">case</span> <span class="mh">0x35</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;0xffdc iMON VFD + knob, no IR&quot;</span><span class="p">);</span>
		<span class="n">detected_display_type</span> <span class="o">=</span> <span class="n">IMON_DISPLAY_TYPE_VFD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* iMON VFD, iMON IR */</span>
	<span class="k">case</span> <span class="mh">0x24</span>:
	<span class="k">case</span> <span class="mh">0x85</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;0xffdc iMON VFD, iMON IR&quot;</span><span class="p">);</span>
		<span class="n">detected_display_type</span> <span class="o">=</span> <span class="n">IMON_DISPLAY_TYPE_VFD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* iMON VFD, MCE IR */</span>
	<span class="k">case</span> <span class="mh">0x46</span>:
	<span class="k">case</span> <span class="mh">0x7e</span>:
	<span class="k">case</span> <span class="mh">0x9e</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;0xffdc iMON VFD, MCE IR&quot;</span><span class="p">);</span>
		<span class="n">detected_display_type</span> <span class="o">=</span> <span class="n">IMON_DISPLAY_TYPE_VFD</span><span class="p">;</span>
		<span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">RC_TYPE_RC6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* iMON LCD, MCE IR */</span>
	<span class="k">case</span> <span class="mh">0x9f</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;0xffdc iMON LCD, MCE IR&quot;</span><span class="p">);</span>
		<span class="n">detected_display_type</span> <span class="o">=</span> <span class="n">IMON_DISPLAY_TYPE_LCD</span><span class="p">;</span>
		<span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">RC_TYPE_RC6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown 0xffdc device, &quot;</span>
			 <span class="s">&quot;defaulting to VFD and iMON IR&quot;</span><span class="p">);</span>
		<span class="n">detected_display_type</span> <span class="o">=</span> <span class="n">IMON_DISPLAY_TYPE_VFD</span><span class="p">;</span>
		<span class="cm">/* We don&#39;t know which one it is, allow user to set the</span>
<span class="cm">		 * RC6 one from userspace if OTHER wasn&#39;t correct. */</span>
		<span class="n">allowed_protos</span> <span class="o">|=</span> <span class="n">RC_TYPE_RC6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; (id 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ffdc_cfg_byte</span><span class="p">);</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">=</span> <span class="n">detected_display_type</span><span class="p">;</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rc_type</span> <span class="o">=</span> <span class="n">allowed_protos</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">imon_set_display_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">configured_display_type</span> <span class="o">=</span> <span class="n">IMON_DISPLAY_TYPE_VFD</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to auto-detect the type of display if the user hasn&#39;t set</span>
<span class="cm">	 * it by hand via the display_type modparam. Default is VFD.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">IMON_DISPLAY_TYPE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0xffdc</span>:
			<span class="cm">/* set in imon_get_ffdc_type() */</span>
			<span class="n">configured_display_type</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0034</span>:
		<span class="k">case</span> <span class="mh">0x0035</span>:
			<span class="n">configured_display_type</span> <span class="o">=</span> <span class="n">IMON_DISPLAY_TYPE_VGA</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0038</span>:
		<span class="k">case</span> <span class="mh">0x0039</span>:
		<span class="k">case</span> <span class="mh">0x0045</span>:
			<span class="n">configured_display_type</span> <span class="o">=</span> <span class="n">IMON_DISPLAY_TYPE_LCD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x003c</span>:
		<span class="k">case</span> <span class="mh">0x0041</span>:
		<span class="k">case</span> <span class="mh">0x0042</span>:
		<span class="k">case</span> <span class="mh">0x0043</span>:
			<span class="n">configured_display_type</span> <span class="o">=</span> <span class="n">IMON_DISPLAY_TYPE_NONE</span><span class="p">;</span>
			<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_supported</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0036</span>:
		<span class="k">case</span> <span class="mh">0x0044</span>:
		<span class="nl">default:</span>
			<span class="n">configured_display_type</span> <span class="o">=</span> <span class="n">IMON_DISPLAY_TYPE_VFD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">configured_display_type</span> <span class="o">=</span> <span class="n">display_type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">IMON_DISPLAY_TYPE_NONE</span><span class="p">)</span>
			<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_supported</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: overriding display type to %d via &quot;</span>
			 <span class="s">&quot;modparam</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">display_type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">=</span> <span class="n">configured_display_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="nf">imon_init_rdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fp_packet</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
					    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x88</span> <span class="p">};</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">rc_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;remote control dev allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">name_rdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">name_rdev</span><span class="p">),</span>
		 <span class="s">&quot;iMON Remote (%04x:%04x)&quot;</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">);</span>
	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_rdev</span><span class="p">,</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_rdev</span><span class="p">));</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_rdev</span><span class="p">,</span> <span class="s">&quot;/input0&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_rdev</span><span class="p">));</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">name_rdev</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_phys</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_rdev</span><span class="p">;</span>
	<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ictx</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">driver_type</span> <span class="o">=</span> <span class="n">RC_DRIVER_SCANCODE</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">RC_TYPE_OTHER</span> <span class="o">|</span> <span class="n">RC_TYPE_RC6</span><span class="p">;</span> <span class="cm">/* iMON PAD or MCE */</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">change_protocol</span> <span class="o">=</span> <span class="n">imon_ir_change_protocol</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">MOD_NAME</span><span class="p">;</span>

	<span class="cm">/* Enable front-panel buttons and/or knobs */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_tx_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp_packet</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp_packet</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">send_packet</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>
	<span class="cm">/* Not fatal, but warn about it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;panel buttons/knobs setup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">==</span> <span class="mh">0xffdc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">imon_get_ffdc_type</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rc_type</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">imon_set_display_type</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rc_type</span> <span class="o">==</span> <span class="n">RC_TYPE_RC6</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">RC_MAP_IMON_MCE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">RC_MAP_IMON_PAD</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rc_register_device</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;remote input dev register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">rc_free_device</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="nf">imon_init_idev</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">idev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;input dev allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">name_idev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">name_idev</span><span class="p">),</span>
		 <span class="s">&quot;iMON Panel, Knob and Mouse(%04x:%04x)&quot;</span><span class="p">,</span>
		 <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">name_idev</span><span class="p">;</span>

	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_idev</span><span class="p">,</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_idev</span><span class="p">));</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_idev</span><span class="p">,</span> <span class="s">&quot;/input1&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_idev</span><span class="p">));</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_idev</span><span class="p">;</span>

	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REL</span><span class="p">);</span>

	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_MOUSE</span><span class="p">)]</span> <span class="o">=</span>
		<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_LEFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_RIGHT</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">REL_X</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">REL_Y</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">REL_WHEEL</span><span class="p">);</span>

	<span class="cm">/* panel and/or knob code support */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">imon_panel_key_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">kc</span> <span class="o">=</span> <span class="n">imon_panel_key_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">keycode</span><span class="p">;</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">kc</span><span class="p">,</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">ictx</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;input dev register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">idev</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="nf">imon_init_touch</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">touch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">touch</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">touch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;touchscreen input dev allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">touch_alloc_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">name_touch</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">name_touch</span><span class="p">),</span>
		 <span class="s">&quot;iMON USB Touchscreen (%04x:%04x)&quot;</span><span class="p">,</span>
		 <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">);</span>
	<span class="n">touch</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">name_touch</span><span class="p">;</span>

	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf1</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_touch</span><span class="p">,</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_touch</span><span class="p">));</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_touch</span><span class="p">,</span> <span class="s">&quot;/input2&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_touch</span><span class="p">));</span>
	<span class="n">touch</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">phys_touch</span><span class="p">;</span>

	<span class="n">touch</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">);</span>
	<span class="n">touch</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">)]</span> <span class="o">=</span>
		<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">touch</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>
			     <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">touch</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>
			     <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">touch</span><span class="p">,</span> <span class="n">ictx</span><span class="p">);</span>

	<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">touch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">touch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">touch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;touchscreen input dev register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">touch_register_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">touch</span><span class="p">;</span>

<span class="nl">touch_register_failed:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">touch</span><span class="p">);</span>

<span class="nl">touch_alloc_failed:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">imon_find_endpoints</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">iface_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">rx_endpoint</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">tx_endpoint</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ifnum</span> <span class="o">=</span> <span class="n">iface_desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_endpts</span> <span class="o">=</span> <span class="n">iface_desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ep_dir</span><span class="p">,</span> <span class="n">ep_type</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ir_ep_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">display_ep_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tx_control</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Scan the endpoint list and set:</span>
<span class="cm">	 *	first input endpoint = IR endpoint</span>
<span class="cm">	 *	first output endpoint = display endpoint</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_endpts</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ir_ep_found</span> <span class="o">&amp;&amp;</span> <span class="n">display_ep_found</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iface_desc</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
		<span class="n">ep_dir</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_DIR_MASK</span><span class="p">;</span>
		<span class="n">ep_type</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir_ep_found</span> <span class="o">&amp;&amp;</span> <span class="n">ep_dir</span> <span class="o">==</span> <span class="n">USB_DIR_IN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ep_type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">rx_endpoint</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
			<span class="n">ir_ep_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: found IR endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">display_ep_found</span> <span class="o">&amp;&amp;</span> <span class="n">ep_dir</span> <span class="o">==</span> <span class="n">USB_DIR_OUT</span> <span class="o">&amp;&amp;</span>
			   <span class="n">ep_type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_endpoint</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
			<span class="n">display_ep_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: found display endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ifnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_endpoint_intf0</span> <span class="o">=</span> <span class="n">rx_endpoint</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * tx is used to send characters to lcd/vfd, associate RF</span>
<span class="cm">		 * remotes, set IR protocol, and maybe more...</span>
<span class="cm">		 */</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx_endpoint</span> <span class="o">=</span> <span class="n">tx_endpoint</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_endpoint_intf1</span> <span class="o">=</span> <span class="n">rx_endpoint</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we didn&#39;t find a display endpoint, this is probably one of the</span>
<span class="cm">	 * newer iMON devices that use control urb instead of interrupt</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">display_ep_found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_control</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">display_ep_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: device uses control endpoint, not &quot;</span>
			<span class="s">&quot;interface OUT endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some iMON receivers have no display. Unfortunately, it seems</span>
<span class="cm">	 * that SoundGraph recycles device IDs between devices both with</span>
<span class="cm">	 * and without... :\</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">IMON_DISPLAY_TYPE_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">display_ep_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: device has no display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * iMON Touch devices have a VGA touchscreen, but no &quot;display&quot;, as</span>
<span class="cm">	 * that refers to e.g. /dev/lcd0 (a character device LCD or VFD).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">IMON_DISPLAY_TYPE_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">display_ep_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: iMON Touch device found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Input endpoint is mandatory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir_ep_found</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no valid input (IR) endpoint found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">=</span> <span class="n">tx_control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">display_ep_found</span><span class="p">)</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ir_ep_found</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="nf">imon_init_intf0</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">rx_urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">tx_urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">iface_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ictx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: kzalloc failed for context&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rx_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: usb_alloc_urb failed for IR urb&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_urb_alloc_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tx_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: usb_alloc_urb failed for display urb&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">tx_urb_alloc_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">kc_lock</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span> <span class="o">=</span> <span class="n">usb_get_dev</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">));</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf0</span> <span class="o">=</span> <span class="n">rx_urb</span><span class="p">;</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx_urb</span> <span class="o">=</span> <span class="n">tx_urb</span><span class="p">;</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rf_device</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">vendor</span>  <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">);</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">iface_desc</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imon_find_endpoints</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">iface_desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">find_endpoint_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf0</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="p">,</span>
		<span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="p">,</span>
			<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_endpoint_intf0</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_rx_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_rx_buf</span><span class="p">),</span>
		<span class="n">usb_rx_callback_intf0</span><span class="p">,</span> <span class="n">ictx</span><span class="p">,</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_endpoint_intf0</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;usb_submit_urb failed for intf0 (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">urb_submit_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="n">imon_init_idev</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: input device setup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">idev_setup_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">imon_init_rdev</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: rc device setup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rdev_setup_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev_present_intf0</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ictx</span><span class="p">;</span>

<span class="nl">rdev_setup_failed:</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
<span class="nl">idev_setup_failed:</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf0</span><span class="p">);</span>
<span class="nl">urb_submit_failed:</span>
<span class="nl">find_endpoint_failed:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">tx_urb</span><span class="p">);</span>
<span class="nl">tx_urb_alloc_failed:</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">rx_urb</span><span class="p">);</span>
<span class="nl">rx_urb_alloc_failed:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to initialize intf0, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="nf">imon_init_intf1</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">rx_urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">iface_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rx_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;usb_alloc_urb failed for IR urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_urb_alloc_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">IMON_DISPLAY_TYPE_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ttimer</span><span class="p">);</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ttimer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ictx</span><span class="p">;</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ttimer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">imon_touch_display_timeout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf1</span> <span class="o">=</span> <span class="n">usb_get_dev</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">));</span>
	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf1</span> <span class="o">=</span> <span class="n">rx_urb</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">iface_desc</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imon_find_endpoints</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">iface_desc</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">find_endpoint_failed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">IMON_DISPLAY_TYPE_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="n">imon_init_touch</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">touch_setup_failed</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf1</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf1</span><span class="p">,</span>
		<span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf1</span><span class="p">,</span>
			<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_endpoint_intf1</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_rx_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_rx_buf</span><span class="p">),</span>
		<span class="n">usb_rx_callback_intf1</span><span class="p">,</span> <span class="n">ictx</span><span class="p">,</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_endpoint_intf1</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;usb_submit_urb failed for intf1 (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">urb_submit_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev_present_intf1</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ictx</span><span class="p">;</span>

<span class="nl">urb_submit_failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">);</span>
<span class="nl">touch_setup_failed:</span>
<span class="nl">find_endpoint_failed:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">rx_urb</span><span class="p">);</span>
<span class="nl">rx_urb_alloc_failed:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to initialize intf1, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">imon_init_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Registering iMON display with sysfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* set up sysfs entry for built-in clock */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imon_display_attr_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not create display sysfs &quot;</span>
			<span class="s">&quot;entries(%d)&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">IMON_DISPLAY_TYPE_LCD</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_register_dev</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imon_lcd_class</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_register_dev</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imon_vfd_class</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="cm">/* Not a fatal error, so ignore */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not get a minor number for &quot;</span>
			 <span class="s">&quot;display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Callback function for USB core API: Probe</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">imon_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">iface_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">first_if</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ifnum</span><span class="p">,</span> <span class="n">sysfs_err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">first_if_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">product</span><span class="p">;</span>

	<span class="n">usbdev</span>     <span class="o">=</span> <span class="n">usb_get_dev</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">interface</span><span class="p">));</span>
	<span class="n">iface_desc</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="n">ifnum</span>      <span class="o">=</span> <span class="n">iface_desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="n">vendor</span>     <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">);</span>
	<span class="n">product</span>    <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: found iMON device (%04x:%04x, intf%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">);</span>

	<span class="cm">/* prevent races probing devices w/multiple interfaces */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>

	<span class="n">first_if</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">first_if_ctx</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">first_if</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ifnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ictx</span> <span class="o">=</span> <span class="n">imon_init_intf0</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to initialize context!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="cm">/* this is the secondary interface on the device */</span>
		<span class="n">ictx</span> <span class="o">=</span> <span class="n">imon_init_intf1</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">first_if_ctx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to attach to context!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">ictx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ifnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">product</span> <span class="o">==</span> <span class="mh">0xffdc</span> <span class="o">&amp;&amp;</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rf_device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sysfs_err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">imon_rf_attr_group</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_err</span><span class="p">)</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not create RF sysfs entries(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">sysfs_err</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_supported</span><span class="p">)</span>
			<span class="n">imon_init_display</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">interface</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;iMON device (%04x:%04x, intf%d) on &quot;</span>
		 <span class="s">&quot;usb&lt;%d:%d&gt; initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">,</span>
		 <span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">busnum</span><span class="p">,</span> <span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to register, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Callback function for USB core API: disconnect</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">imon_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ifnum</span><span class="p">;</span>

	<span class="cm">/* prevent races with multi-interface device probing and display_open */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>

	<span class="n">ictx</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ifnum</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * sysfs_remove_group is safe to call even if sysfs_create_group</span>
<span class="cm">	 * hasn&#39;t been called</span>
<span class="cm">	 */</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imon_display_attr_group</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imon_rf_attr_group</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Abort ongoing write */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">);</span>
		<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">finished</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ifnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev_present_intf0</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf0</span><span class="p">);</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
		<span class="n">rc_unregister_device</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_supported</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">IMON_DISPLAY_TYPE_LCD</span><span class="p">)</span>
				<span class="n">usb_deregister_dev</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imon_lcd_class</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">IMON_DISPLAY_TYPE_VFD</span><span class="p">)</span>
				<span class="n">usb_deregister_dev</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imon_vfd_class</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev_present_intf1</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">IMON_DISPLAY_TYPE_VGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">);</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ttimer</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev_present_intf0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">dev_present_intf1</span><span class="p">)</span>
		<span class="n">free_imon_context</span><span class="p">(</span><span class="n">ictx</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: iMON device (intf%d) disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imon_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ifnum</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ifnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imon_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imon_context</span> <span class="o">*</span><span class="n">ictx</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ifnum</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ifnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf0</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="p">,</span>
			<span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf0</span><span class="p">,</span>
				<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_endpoint_intf0</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
			<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_rx_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_rx_buf</span><span class="p">),</span>
			<span class="n">usb_rx_callback_intf0</span><span class="p">,</span> <span class="n">ictx</span><span class="p">,</span>
			<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_endpoint_intf0</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf1</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf1</span><span class="p">,</span>
			<span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usbdev_intf1</span><span class="p">,</span>
				<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_endpoint_intf1</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
			<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_rx_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">usb_rx_buf</span><span class="p">),</span>
			<span class="n">usb_rx_callback_intf1</span><span class="p">,</span> <span class="n">ictx</span><span class="p">,</span>
			<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_endpoint_intf1</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">rx_urb_intf1</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">imon_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
