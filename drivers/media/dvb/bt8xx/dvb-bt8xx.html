<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › bt8xx › dvb-bt8xx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dvb-bt8xx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Bt8xx based DVB adapter driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2002,2003 Florian Schirmer &lt;jolt@tuxbox.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) &quot;dvb_bt8xx: &quot; fmt</span>

<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>

<span class="cp">#include &quot;dmxdev.h&quot;</span>
<span class="cp">#include &quot;dvbdev.h&quot;</span>
<span class="cp">#include &quot;dvb_demux.h&quot;</span>
<span class="cp">#include &quot;dvb_frontend.h&quot;</span>
<span class="cp">#include &quot;dvb-bt8xx.h&quot;</span>
<span class="cp">#include &quot;bt878.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Turn on/off debugging (default:off).&quot;</span><span class="p">);</span>

<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>

<span class="cp">#define dprintk( args... ) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (debug) printk(KERN_DEBUG args); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define IF_FREQUENCYx6 217    </span><span class="cm">/* 6 * 36.16666666667MHz */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_bt8xx_task</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>printk("%d ", card->bt->finished_block);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">last_block</span> <span class="o">!=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">finished_block</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">TS_Size</span> <span class="o">?</span> <span class="n">dvb_dmx_swfilter_204</span> <span class="o">:</span> <span class="n">dvb_dmx_swfilter</span><span class="p">)</span>
			<span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">buf_cpu</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">last_block</span> <span class="o">*</span>
					    <span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">block_bytes</span><span class="p">],</span>
			 <span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">block_bytes</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">last_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">last_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">block_count</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_bt8xx_start_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">dvbdmxfeed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span><span class="o">*</span><span class="n">dvbdmx</span> <span class="o">=</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dvb_bt8xx: start_feed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">frontend</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">nfeeds</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">nfeeds</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">nfeeds</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">bt878_start</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">gpio_mode</span><span class="p">,</span>
			    <span class="n">card</span><span class="o">-&gt;</span><span class="n">op_sync_orin</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irq_err_ignore</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_bt8xx_stop_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">dvbdmxfeed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">dvbdmx</span> <span class="o">=</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dvb_bt8xx: stop_feed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">frontend</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">nfeeds</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">nfeeds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bt878_stop</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_pci_slot_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">adev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bt878</span> <span class="n">__devinit</span> <span class="o">*</span><span class="nf">dvb_bt8xx_878_match</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bttv_nr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">bttv_pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">card_nr</span><span class="p">;</span>

	<span class="cm">/* Hmm, n squared. Hope n is small */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">card_nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">card_nr</span> <span class="o">&lt;</span> <span class="n">bt878_num</span><span class="p">;</span> <span class="n">card_nr</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_pci_slot_eq</span><span class="p">(</span><span class="n">bt878</span><span class="p">[</span><span class="n">card_nr</span><span class="p">].</span><span class="n">dev</span><span class="p">,</span> <span class="n">bttv_pci_dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">bt878</span><span class="p">[</span><span class="n">card_nr</span><span class="p">];</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">thomson_dtt7579_demod_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_clock_config</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x38</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_reset</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_adc_ctl_1_cfg</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_agc_cfg</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_gpp_ctl_cfg</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0x33</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_capt_range_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x32</span> <span class="p">};</span>

	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_clock_config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_clock_config</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_reset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_reset</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_adc_ctl_1_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_adc_ctl_1_cfg</span><span class="p">));</span>

	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_agc_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_agc_cfg</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_gpp_ctl_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_gpp_ctl_cfg</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_capt_range_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_capt_range_cfg</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">thomson_dtt7579_tuner_calc_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">pllbuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">83333</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">500000</span><span class="p">)</span> <span class="o">+</span> <span class="n">IF_FREQUENCYx6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">542000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mh">0xb4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">771000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mh">0xbc</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mh">0xf4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">443250000</span><span class="p">)</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">bs</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mt352_config</span> <span class="n">thomson_dtt7579_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>
	<span class="p">.</span><span class="n">demod_init</span> <span class="o">=</span> <span class="n">thomson_dtt7579_demod_init</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">zl10353_config</span> <span class="n">thomson_dtt7579_zl10353_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24108_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">pump</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">band</span><span class="p">,</span> <span class="n">pll</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">osci</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span><span class="mi">950000</span><span class="p">,</span><span class="mi">1019000</span><span class="p">,</span><span class="mi">1075000</span><span class="p">,</span><span class="mi">1178000</span><span class="p">,</span><span class="mi">1296000</span><span class="p">,</span><span class="mi">1432000</span><span class="p">,</span>
		<span class="mi">1576000</span><span class="p">,</span><span class="mi">1718000</span><span class="p">,</span><span class="mi">1856000</span><span class="p">,</span><span class="mi">2036000</span><span class="p">,</span><span class="mi">2150000</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">bandsel</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x00020000</span><span class="p">,</span><span class="mh">0x00040000</span><span class="p">,</span><span class="mh">0x00100800</span><span class="p">,</span><span class="mh">0x00101000</span><span class="p">,</span>
		<span class="mh">0x00102000</span><span class="p">,</span><span class="mh">0x00104000</span><span class="p">,</span><span class="mh">0x00108000</span><span class="p">,</span><span class="mh">0x00110000</span><span class="p">,</span>
		<span class="mh">0x00120000</span><span class="p">,</span><span class="mh">0x00140000</span><span class="p">};</span>

	<span class="cp">#define XTAL 1011100 </span><span class="cm">/* Hz, really 1.0111 MHz and a /10 prescaler */</span><span class="cp"></span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;cx24108 debug: entering SetTunerFreq, freq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="cm">/* This is really the bit driving the tuner chip cx24108 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span><span class="o">&lt;</span><span class="mi">950000</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">950000</span><span class="p">;</span> <span class="cm">/* kHz */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span><span class="o">&gt;</span><span class="mi">2150000</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">2150000</span><span class="p">;</span> <span class="cm">/* satellite IF is 950..2150MHz */</span>

	<span class="cm">/* decide which VCO to use for the input frequency */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">osci</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">osci</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;cx24108 debug: select vco #%d (f=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="n">band</span><span class="o">=</span><span class="n">bandsel</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="cm">/* the gain values must be set by SetSymbolrate */</span>
	<span class="cm">/* compute the pll divider needed, from Conexant data sheet,</span>
<span class="cm">	   resolved for (n*32+a), remember f(vco) is f(receive) *2 or *4,</span>
<span class="cm">	   depending on the divider bit. It is set to /4 on the 2 lowest</span>
<span class="cm">	   bands  */</span>
	<span class="n">n</span><span class="o">=</span><span class="p">((</span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">2</span><span class="o">?</span><span class="mi">2</span><span class="o">:</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">freq</span><span class="o">*</span><span class="mi">10L</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">XTAL</span><span class="o">/</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">a</span><span class="o">=</span><span class="n">n</span><span class="o">%</span><span class="mi">32</span><span class="p">;</span> <span class="n">n</span><span class="o">/=</span><span class="mi">32</span><span class="p">;</span> <span class="k">if</span><span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="n">n</span><span class="o">--</span><span class="p">;</span>
	<span class="n">pump</span><span class="o">=</span><span class="p">(</span><span class="n">freq</span><span class="o">&lt;</span><span class="p">(</span><span class="n">osci</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">osci</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">pll</span><span class="o">=</span><span class="mh">0xf8000000</span><span class="o">|</span>
	    <span class="p">((</span><span class="n">pump</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">14</span><span class="o">+</span><span class="mi">11</span><span class="p">))</span><span class="o">|</span>
	    <span class="p">((</span><span class="n">n</span><span class="o">&amp;</span><span class="mh">0x1ff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">11</span><span class="p">))</span><span class="o">|</span>
	    <span class="p">((</span><span class="n">a</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">);</span>
	<span class="cm">/* everything is shifted left 11 bits to left-align the bits in the</span>
<span class="cm">	   32bit word. Output to the tuner goes MSB-aligned, after all */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;cx24108 debug: pump=%d, n=%d, a=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pump</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="n">cx24110_pll_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span><span class="n">band</span><span class="p">);</span>
	<span class="cm">/* set vga and vca to their widest-band settings, as a precaution.</span>
<span class="cm">	   SetSymbolrate might not be called to set this up */</span>
	<span class="n">cx24110_pll_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span><span class="mh">0x500c0000</span><span class="p">);</span>
	<span class="n">cx24110_pll_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span><span class="mh">0x83f1f800</span><span class="p">);</span>
	<span class="n">cx24110_pll_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span><span class="n">pll</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>writereg(client,0x56,0x7f);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pinnsat_tuner_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">bttv_gpio_enable</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>  <span class="cm">/* output */</span>
	<span class="n">bttv_write_gpio</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>   <span class="cm">/* relay on */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pinnsat_tuner_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">bttv_write_gpio</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>   <span class="cm">/* relay off */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cx24110_config</span> <span class="n">pctvsat_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">microtune_mt7202dtf_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">cpump</span><span class="p">,</span> <span class="n">band_select</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">};</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="mi">36000000</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">83333</span><span class="p">)</span> <span class="o">/</span> <span class="mi">166666</span><span class="p">;</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">175000000</span><span class="p">)</span>
		<span class="n">cpump</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">390000000</span><span class="p">)</span>
		<span class="n">cpump</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">470000000</span><span class="p">)</span>
		<span class="n">cpump</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">750000000</span><span class="p">)</span>
		<span class="n">cpump</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cpump</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">175000000</span><span class="p">)</span>
		<span class="n">band_select</span> <span class="o">=</span> <span class="mh">0x0e</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">470000000</span><span class="p">)</span>
		<span class="n">band_select</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">band_select</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">|</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpump</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">band_select</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">i2c_transfer</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">div</span> <span class="o">*</span> <span class="mi">166666</span> <span class="o">-</span> <span class="mi">36000000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">microtune_mt7202dtf_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">fw</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span><span class="o">*</span> <span class="n">bt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dvb_bt8xx_card</span><span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">request_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sp887x_config</span> <span class="n">microtune_mt7202dtf_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_firmware</span> <span class="o">=</span> <span class="n">microtune_mt7202dtf_request_firmware</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">advbt771_samsung_tdtc9251dh0_demod_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_clock_config</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x2d</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_reset</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_adc_ctl_1_cfg</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_agc_cfg</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				       <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_av771_extra</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xB5</span><span class="p">,</span> <span class="mh">0x7A</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_capt_range_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x32</span> <span class="p">};</span>

	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_clock_config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_clock_config</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_reset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_reset</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_adc_ctl_1_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_adc_ctl_1_cfg</span><span class="p">));</span>

	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_agc_cfg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_agc_cfg</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_av771_extra</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_av771_extra</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_capt_range_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_capt_range_cfg</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">advbt771_samsung_tdtc9251dh0_tuner_calc_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pllbuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">83333</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">500000</span><span class="p">)</span> <span class="o">+</span> <span class="n">IF_FREQUENCYx6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">150000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mh">0xB4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">173000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mh">0xBC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">250000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mh">0xB4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">400000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mh">0xBC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">420000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mh">0xF4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">470000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mh">0xFC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">600000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mh">0xBC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">730000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mh">0xF4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mh">0xFC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">150000000</span><span class="p">)</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">173000000</span><span class="p">)</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">250000000</span><span class="p">)</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">400000000</span><span class="p">)</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">420000000</span><span class="p">)</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">470000000</span><span class="p">)</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">600000000</span><span class="p">)</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">730000000</span><span class="p">)</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">;</span>
	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">bs</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mt352_config</span> <span class="n">advbt771_samsung_tdtc9251dh0_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>
	<span class="p">.</span><span class="n">demod_init</span> <span class="o">=</span> <span class="n">advbt771_samsung_tdtc9251dh0_demod_init</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dst_config</span> <span class="n">dst_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">or51211_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">fw</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span><span class="o">*</span> <span class="n">bt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dvb_bt8xx_card</span><span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">request_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">or51211_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">bttv_write_gpio</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>   <span class="cm">/* Reset */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">or51211_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* RESET DEVICE</span>
<span class="cm">	 * reset is controlled by GPIO-0</span>
<span class="cm">	 * when set to 0 causes reset and when to 1 for normal op</span>
<span class="cm">	 * must remain reset for 128 clock cycles on a 50Mhz clock</span>
<span class="cm">	 * also PRM1 PRM2 &amp; PRM4 are controlled by GPIO-1,GPIO-2 &amp; GPIO-4</span>
<span class="cm">	 * We assume that the reset has be held low long enough or we</span>
<span class="cm">	 * have been reset by a power on.  When the driver is unloaded</span>
<span class="cm">	 * reset set to 0 so if reloaded we have been reset.</span>
<span class="cm">	 */</span>
	<span class="cm">/* reset &amp; PRM1,2&amp;4 are outputs */</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bttv_gpio_enable</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mh">0x001F</span><span class="p">,</span> <span class="mh">0x001F</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;or51211: Init Error - Can&#39;t Reset DVR (%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">bttv_write_gpio</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mh">0x001F</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>   <span class="cm">/* Reset */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="cm">/* Now set for normal operation */</span>
	<span class="n">bttv_write_gpio</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mh">0x0001F</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="cm">/* wait for operation to begin */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">or51211_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">bttv_write_gpio</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">or51211_config</span> <span class="n">or51211_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x15</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_firmware</span> <span class="o">=</span> <span class="n">or51211_request_firmware</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setmode</span> <span class="o">=</span> <span class="n">or51211_setmode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">or51211_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">or51211_sleep</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vp3021_alps_tded4_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">};</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">36166667</span><span class="p">)</span> <span class="o">/</span> <span class="mi">166667</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x85</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;=</span> <span class="mi">47000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">153000000</span><span class="p">))</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;=</span> <span class="mi">153000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">430000000</span><span class="p">))</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;=</span> <span class="mi">430000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">824000000</span><span class="p">))</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0C</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;=</span> <span class="mi">824000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">863000000</span><span class="p">))</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8C</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">i2c_transfer</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nxt6000_config</span> <span class="n">vp3021_alps_tded4_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clock_inversion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">digitv_alps_tded4_demod_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_clock_config</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x2d</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_reset</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_adc_ctl_1_cfg</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_agc_cfg</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_capt_range_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x32</span> <span class="p">};</span>

	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_clock_config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_clock_config</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_reset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_reset</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_adc_ctl_1_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_adc_ctl_1_cfg</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_agc_cfg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_agc_cfg</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_capt_range_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_capt_range_cfg</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">digitv_alps_tded4_tuner_calc_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>  <span class="n">u8</span> <span class="o">*</span><span class="n">pllbuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">83333</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">500000</span><span class="p">)</span> <span class="o">+</span> <span class="n">IF_FREQUENCYx6</span><span class="p">;</span>

	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">;</span>
	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">pllbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x85</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;frequency %u, div %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">470000000</span><span class="p">)</span>
		<span class="n">pllbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="mi">823000000</span><span class="p">)</span>
		<span class="n">pllbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pllbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">==</span> <span class="mi">8000000</span><span class="p">)</span>
		<span class="n">pllbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">digitv_alps_tded4_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">bt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Reset the frontend, must be called before trying</span>
<span class="cm">	 * to initialise the MT352 or mt352_attach</span>
<span class="cm">	 * will fail. Same goes for the nxt6000 frontend.</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bttv_gpio_enable</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;digitv_alps_tded4: Init Error - Can&#39;t Reset DVR (%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Pulse the reset line */</span>
	<span class="n">bttv_write_gpio</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span> <span class="cm">/* High */</span>
	<span class="n">bttv_write_gpio</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* Low  */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">bttv_write_gpio</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span> <span class="cm">/* High */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mt352_config</span> <span class="n">digitv_alps_tded4_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="p">.</span><span class="n">demod_init</span> <span class="o">=</span> <span class="n">digitv_alps_tded4_demod_init</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lgdt330x_config</span> <span class="n">tdvs_tua6034_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span>    <span class="o">=</span> <span class="mh">0x0e</span><span class="p">,</span>
	<span class="p">.</span><span class="n">demod_chip</span>       <span class="o">=</span> <span class="n">LGDT3303</span><span class="p">,</span>
	<span class="p">.</span><span class="n">serial_mpeg</span>      <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span> <span class="cm">/* TPSERIAL for 3303 in TOP_CONTROL */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lgdt330x_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">bt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set pin 27 of the lgdt3303 chip high to reset the frontend */</span>

	<span class="cm">/* Pulse the reset line */</span>
	<span class="n">bttv_write_gpio</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mh">0x00e00007</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span> <span class="cm">/* High */</span>
	<span class="n">bttv_write_gpio</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mh">0x00e00007</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span> <span class="cm">/* Low  */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">bttv_write_gpio</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="mh">0x00e00007</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span> <span class="cm">/* High */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">frontend_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dst_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BTTV_BOARD_DVICO_DVBT_LITE</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">mt352_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thomson_dtt7579_config</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">zl10353_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thomson_dtt7579_zl10353_config</span><span class="p">,</span>
						  <span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">calc_regs</span> <span class="o">=</span> <span class="n">thomson_dtt7579_tuner_calc_regs</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">174000000</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">862000000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BTTV_BOARD_DVICO_FUSIONHDTV_5_LITE</span>:
		<span class="n">lgdt330x_reset</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">lgdt330x_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tdvs_tua6034_config</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dvb_attach</span><span class="p">(</span><span class="n">simple_tuner_attach</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span>
				   <span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span>
				   <span class="n">TUNER_LG_TDVS_H06XF</span><span class="p">);</span>
			<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;dvb_bt8xx: lgdt330x detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BTTV_BOARD_NEBULA_DIGITV</span>:
		<span class="cm">/*</span>
<span class="cm">		 * It is possible to determine the correct frontend using the I2C bus (see the Nebula SDK);</span>
<span class="cm">		 * this would be a cleaner solution than trying each frontend in turn.</span>
<span class="cm">		 */</span>

		<span class="cm">/* Old Nebula (marked (c)2003 on high profile pci card) has nxt6000 demod */</span>
		<span class="n">digitv_alps_tded4_reset</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">nxt6000_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vp3021_alps_tded4_config</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">vp3021_alps_tded4_tuner_set_params</span><span class="p">;</span>
			<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;dvb_bt8xx: an nxt6000 was detected on your digitv card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* New Nebula (marked (c)2005 on low profile pci card) has mt352 demod */</span>
		<span class="n">digitv_alps_tded4_reset</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">mt352_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">digitv_alps_tded4_config</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">calc_regs</span> <span class="o">=</span> <span class="n">digitv_alps_tded4_tuner_calc_regs</span><span class="p">;</span>
			<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;dvb_bt8xx: an mt352 was detected on your digitv card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BTTV_BOARD_AVDVBT_761</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">sp887x_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">microtune_mt7202dtf_config</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">microtune_mt7202dtf_tuner_set_params</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BTTV_BOARD_AVDVBT_771</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">mt352_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">advbt771_samsung_tdtc9251dh0_config</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">calc_regs</span> <span class="o">=</span> <span class="n">advbt771_samsung_tdtc9251dh0_tuner_calc_regs</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">174000000</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">862000000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BTTV_BOARD_TWINHAN_DST</span>:
		<span class="cm">/*	DST is not a frontend driver !!!		*/</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dst_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*	Setup the Card					*/</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dst_config</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">bt</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dst_ca</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/*	DST is not a frontend, attaching the ASIC	*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">dst_attach</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Could not find a Twinhan DST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*	Attach other DST peripherals if any		*/</span>
		<span class="cm">/*	Conditional Access device			*/</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dst_hw_cap</span> <span class="o">&amp;</span> <span class="n">DST_TYPE_HAS_CA</span><span class="p">)</span>
			<span class="n">dvb_attach</span><span class="p">(</span><span class="n">dst_ca_attach</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BTTV_BOARD_PINNACLESAT</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">cx24110_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pctvsat_config</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">pinnsat_tuner_init</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">pinnsat_tuner_sleep</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">cx24108_tuner_set_params</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BTTV_BOARD_PC_HDTV</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">or51211_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or51211_config</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dvb_attach</span><span class="p">(</span><span class="n">simple_tuner_attach</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span>
				   <span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span>
				   <span class="n">TUNER_PHILIPS_FCV1236D</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;A frontend driver was not found for device [%04x:%04x] subsystem [%04x:%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb_register_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Frontend registration failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">dvb_bt8xx_load_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">dvb_register_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span>
				      <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				      <span class="n">adapter_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dvb_register_adapter failed (errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux</span><span class="p">));</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">DMX_TS_FILTERING</span> <span class="o">|</span> <span class="n">DMX_SECTION_FILTERING</span> <span class="o">|</span> <span class="n">DMX_MEMORY_BASED_FILTERING</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">filternum</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">feednum</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">start_feed</span> <span class="o">=</span> <span class="n">dvb_bt8xx_start_feed</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">stop_feed</span> <span class="o">=</span> <span class="n">dvb_bt8xx_stop_feed</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">write_to_decoder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">dvb_dmx_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dvb_dmx_init failed (errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unregister_adaptor</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">filternum</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">demux</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">dvb_dmxdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dvb_dmxdev_init failed (errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dmx_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe_hw</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">DMX_FRONTEND_0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">add_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe_hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dvb_dmx_init failed (errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dmxdev_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">fe_mem</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">DMX_MEMORY_FE</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">add_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dvb_dmx_init failed (errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_remove_hw_frontend</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">connect_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe_hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dvb_dmx_init failed (errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_remove_mem_frontend</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">dvb_net_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dvbnet</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dvb_net_init failed (errno = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_disconnect_frontend</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">dvb_bt8xx_task</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="p">);</span>

	<span class="n">frontend_init</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_disconnect_frontend:</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">disconnect_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">);</span>
<span class="nl">err_remove_mem_frontend:</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe_mem</span><span class="p">);</span>
<span class="nl">err_remove_hw_frontend:</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe_hw</span><span class="p">);</span>
<span class="nl">err_dmxdev_release:</span>
	<span class="n">dvb_dmxdev_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">);</span>
<span class="nl">err_dmx_release:</span>
	<span class="n">dvb_dmx_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>
<span class="nl">err_unregister_adaptor:</span>
	<span class="n">dvb_unregister_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">dvb_bt8xx_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv_sub_device</span> <span class="o">*</span><span class="n">sub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">bttv_pci_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_bt8xx_card</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">bttv_nr</span> <span class="o">=</span> <span class="n">sub</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="n">sub</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">));</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">i2c_adapter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sub</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">sub</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BTTV_BOARD_PINNACLESAT</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">gpio_mode</span> <span class="o">=</span> <span class="mh">0x0400c060</span><span class="p">;</span>
		<span class="cm">/* should be: BT878_A_GAIN=0,BT878_A_PWRDN,BT878_DA_DPM,BT878_DA_SBR,</span>
<span class="cm">			      BT878_DA_IOM=1,BT878_DA_APP to enable serial highspeed mode. */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">op_sync_orin</span> <span class="o">=</span> <span class="n">BT878_RISC_SYNC_MASK</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irq_err_ignore</span> <span class="o">=</span> <span class="n">BT878_AFBUS</span> <span class="o">|</span> <span class="n">BT878_AFDSR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BTTV_BOARD_DVICO_DVBT_LITE</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">gpio_mode</span> <span class="o">=</span> <span class="mh">0x0400C060</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">op_sync_orin</span> <span class="o">=</span> <span class="n">BT878_RISC_SYNC_MASK</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irq_err_ignore</span> <span class="o">=</span> <span class="n">BT878_AFBUS</span> <span class="o">|</span> <span class="n">BT878_AFDSR</span><span class="p">;</span>
		<span class="cm">/* 26, 15, 14, 6, 5</span>
<span class="cm">		 * A_PWRDN  DA_DPM DA_SBR DA_IOM_DA</span>
<span class="cm">		 * DA_APP(parallel) */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BTTV_BOARD_DVICO_FUSIONHDTV_5_LITE</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">gpio_mode</span> <span class="o">=</span> <span class="mh">0x0400c060</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">op_sync_orin</span> <span class="o">=</span> <span class="n">BT878_RISC_SYNC_MASK</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irq_err_ignore</span> <span class="o">=</span> <span class="n">BT878_AFBUS</span> <span class="o">|</span> <span class="n">BT878_AFDSR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BTTV_BOARD_NEBULA_DIGITV</span>:
	<span class="k">case</span> <span class="n">BTTV_BOARD_AVDVBT_761</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">gpio_mode</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">op_sync_orin</span> <span class="o">=</span> <span class="n">BT878_RISC_SYNC_MASK</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irq_err_ignore</span> <span class="o">=</span> <span class="n">BT878_AFBUS</span> <span class="o">|</span> <span class="n">BT878_AFDSR</span><span class="p">;</span>
		<span class="cm">/* A_PWRDN DA_SBR DA_APP (high speed serial) */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BTTV_BOARD_AVDVBT_771</span>: <span class="c1">//case 0x07711461:</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">gpio_mode</span> <span class="o">=</span> <span class="mh">0x0400402B</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">op_sync_orin</span> <span class="o">=</span> <span class="n">BT878_RISC_SYNC_MASK</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irq_err_ignore</span> <span class="o">=</span> <span class="n">BT878_AFBUS</span> <span class="o">|</span> <span class="n">BT878_AFDSR</span><span class="p">;</span>
		<span class="cm">/* A_PWRDN DA_SBR  DA_APP[0] PKTP=10 RISC_ENABLE FIFO_ENABLE*/</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BTTV_BOARD_TWINHAN_DST</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">gpio_mode</span> <span class="o">=</span> <span class="mh">0x2204f2c</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">op_sync_orin</span> <span class="o">=</span> <span class="n">BT878_RISC_SYNC_MASK</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irq_err_ignore</span> <span class="o">=</span> <span class="n">BT878_APABORT</span> <span class="o">|</span> <span class="n">BT878_ARIPERR</span> <span class="o">|</span>
				       <span class="n">BT878_APPERR</span> <span class="o">|</span> <span class="n">BT878_AFBUS</span><span class="p">;</span>
		<span class="cm">/* 25,21,14,11,10,9,8,3,2 then</span>
<span class="cm">		 * 0x33 = 5,4,1,0</span>
<span class="cm">		 * A_SEL=SML, DA_MLB, DA_SBR,</span>
<span class="cm">		 * DA_SDR=f, fifo trigger = 32 DWORDS</span>
<span class="cm">		 * IOM = 0 == audio A/D</span>
<span class="cm">		 * DPM = 0 == digital audio mode</span>
<span class="cm">		 * == async data parallel port</span>
<span class="cm">		 * then 0x33 (13 is set by start_capture)</span>
<span class="cm">		 * DA_APP = async data parallel port,</span>
<span class="cm">		 * ACAP_EN = 1,</span>
<span class="cm">		 * RISC+FIFO ENABLE */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BTTV_BOARD_PC_HDTV</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">gpio_mode</span> <span class="o">=</span> <span class="mh">0x0100EC7B</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">op_sync_orin</span> <span class="o">=</span> <span class="n">BT878_RISC_SYNC_MASK</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irq_err_ignore</span> <span class="o">=</span> <span class="n">BT878_AFBUS</span> <span class="o">|</span> <span class="n">BT878_AFDSR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unknown bttv card type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sub</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dvb_bt8xx: identified card%d as %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bttv_pci_dev</span> <span class="o">=</span> <span class="n">bttv_get_pcidev</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no pci device for card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span> <span class="o">=</span> <span class="n">dvb_bt8xx_878_match</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">,</span> <span class="n">bttv_pci_dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to determine DMA core of card %d,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;if you have the ALSA bt87x audio driver installed, try removing it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">bttv_nr</span> <span class="o">=</span> <span class="n">sub</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_bt8xx_load_card</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">sub</span><span class="o">-&gt;</span><span class="n">core</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sub</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_bt8xx_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv_sub_device</span> <span class="o">*</span><span class="n">sub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_bt8xx_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sub</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dvb_bt8xx: unloading card%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">bttv_nr</span><span class="p">);</span>

	<span class="n">bt878_stop</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="n">dvb_net_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dvbnet</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe_mem</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe_hw</span><span class="p">);</span>
	<span class="n">dvb_dmxdev_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">);</span>
	<span class="n">dvb_dmx_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvb_unregister_frontend</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
		<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dvb_unregister_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bttv_sub_driver</span> <span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">drv</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;dvb-bt8xx&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">dvb_bt8xx_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">dvb_bt8xx_remove</span><span class="p">,</span>
	<span class="cm">/* FIXME:</span>
<span class="cm">	 * .shutdown	= dvb_bt8xx_shutdown,</span>
<span class="cm">	 * .suspend	= dvb_bt8xx_suspend,</span>
<span class="cm">	 * .resume	= dvb_bt8xx_resume,</span>
<span class="cm">	 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dvb_bt8xx_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bttv_sub_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;dvb&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dvb_bt8xx_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bttv_sub_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dvb_bt8xx_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dvb_bt8xx_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Bt8xx based DVB adapter driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Florian Schirmer &lt;jolt@tuxbox.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
