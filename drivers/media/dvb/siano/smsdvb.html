<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › siano › smsdvb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>smsdvb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/****************************************************************</span>

<span class="cm">Siano Mobile Silicon, Inc.</span>
<span class="cm">MDTV receiver kernel modules.</span>
<span class="cm">Copyright (C) 2006-2008, Uri Shkolnik</span>

<span class="cm">This program is free software: you can redistribute it and/or modify</span>
<span class="cm">it under the terms of the GNU General Public License as published by</span>
<span class="cm">the Free Software Foundation, either version 2 of the License, or</span>
<span class="cm">(at your option) any later version.</span>

<span class="cm"> This program is distributed in the hope that it will be useful,</span>
<span class="cm">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">GNU General Public License for more details.</span>

<span class="cm">You should have received a copy of the GNU General Public License</span>
<span class="cm">along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">****************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="cp">#include &quot;dmxdev.h&quot;</span>
<span class="cp">#include &quot;dvbdev.h&quot;</span>
<span class="cp">#include &quot;dvb_demux.h&quot;</span>
<span class="cp">#include &quot;dvb_frontend.h&quot;</span>

<span class="cp">#include &quot;smscoreapi.h&quot;</span>
<span class="cp">#include &quot;smsendian.h&quot;</span>
<span class="cp">#include &quot;sms-cards.h&quot;</span>

<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">entry</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">smscore_device_t</span> <span class="o">*</span><span class="n">coredev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smscore_client_t</span> <span class="o">*</span><span class="n">smsclient</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dvb_adapter</span>      <span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span>        <span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dmxdev</span>           <span class="n">dmxdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span>     <span class="n">frontend</span><span class="p">;</span>

	<span class="n">fe_status_t</span>             <span class="n">fe_status</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">completion</span>       <span class="n">tune_done</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">SMSHOSTLIB_STATISTICS_DVB_S</span> <span class="n">sms_stat_dvb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">event_fe_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">event_unc_state</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">g_smsdvb_clients</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">g_smsdvb_clientslock</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sms_dbg</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">sms_dbg</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;set debug level (info=1, adv=2 (or-able))&quot;</span><span class="p">);</span>

<span class="cm">/* Events that may come from DVB v3 adapter */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sms_board_dvb3_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">SMS_DVB3_EVENTS</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">struct</span> <span class="n">smscore_device_t</span> <span class="o">*</span><span class="n">coredev</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">coredev</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DVB3_EVENT_INIT</span>:
		<span class="n">sms_debug</span><span class="p">(</span><span class="s">&quot;DVB3_EVENT_INIT&quot;</span><span class="p">);</span>
		<span class="n">sms_board_event</span><span class="p">(</span><span class="n">coredev</span><span class="p">,</span> <span class="n">BOARD_EVENT_BIND</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVB3_EVENT_SLEEP</span>:
		<span class="n">sms_debug</span><span class="p">(</span><span class="s">&quot;DVB3_EVENT_SLEEP&quot;</span><span class="p">);</span>
		<span class="n">sms_board_event</span><span class="p">(</span><span class="n">coredev</span><span class="p">,</span> <span class="n">BOARD_EVENT_POWER_SUSPEND</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVB3_EVENT_HOTPLUG</span>:
		<span class="n">sms_debug</span><span class="p">(</span><span class="s">&quot;DVB3_EVENT_HOTPLUG&quot;</span><span class="p">);</span>
		<span class="n">sms_board_event</span><span class="p">(</span><span class="n">coredev</span><span class="p">,</span> <span class="n">BOARD_EVENT_POWER_INIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVB3_EVENT_FE_LOCK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">event_fe_state</span> <span class="o">!=</span> <span class="n">DVB3_EVENT_FE_LOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">client</span><span class="o">-&gt;</span><span class="n">event_fe_state</span> <span class="o">=</span> <span class="n">DVB3_EVENT_FE_LOCK</span><span class="p">;</span>
			<span class="n">sms_debug</span><span class="p">(</span><span class="s">&quot;DVB3_EVENT_FE_LOCK&quot;</span><span class="p">);</span>
			<span class="n">sms_board_event</span><span class="p">(</span><span class="n">coredev</span><span class="p">,</span> <span class="n">BOARD_EVENT_FE_LOCK</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVB3_EVENT_FE_UNLOCK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">event_fe_state</span> <span class="o">!=</span> <span class="n">DVB3_EVENT_FE_UNLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">client</span><span class="o">-&gt;</span><span class="n">event_fe_state</span> <span class="o">=</span> <span class="n">DVB3_EVENT_FE_UNLOCK</span><span class="p">;</span>
			<span class="n">sms_debug</span><span class="p">(</span><span class="s">&quot;DVB3_EVENT_FE_UNLOCK&quot;</span><span class="p">);</span>
			<span class="n">sms_board_event</span><span class="p">(</span><span class="n">coredev</span><span class="p">,</span> <span class="n">BOARD_EVENT_FE_UNLOCK</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVB3_EVENT_UNC_OK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">event_unc_state</span> <span class="o">!=</span> <span class="n">DVB3_EVENT_UNC_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">client</span><span class="o">-&gt;</span><span class="n">event_unc_state</span> <span class="o">=</span> <span class="n">DVB3_EVENT_UNC_OK</span><span class="p">;</span>
			<span class="n">sms_debug</span><span class="p">(</span><span class="s">&quot;DVB3_EVENT_UNC_OK&quot;</span><span class="p">);</span>
			<span class="n">sms_board_event</span><span class="p">(</span><span class="n">coredev</span><span class="p">,</span> <span class="n">BOARD_EVENT_MULTIPLEX_OK</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVB3_EVENT_UNC_ERR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">event_unc_state</span> <span class="o">!=</span> <span class="n">DVB3_EVENT_UNC_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">client</span><span class="o">-&gt;</span><span class="n">event_unc_state</span> <span class="o">=</span> <span class="n">DVB3_EVENT_UNC_ERR</span><span class="p">;</span>
			<span class="n">sms_debug</span><span class="p">(</span><span class="s">&quot;DVB3_EVENT_UNC_ERR&quot;</span><span class="p">);</span>
			<span class="n">sms_board_event</span><span class="p">(</span><span class="n">coredev</span><span class="p">,</span> <span class="n">BOARD_EVENT_MULTIPLEX_ERRORS</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">sms_err</span><span class="p">(</span><span class="s">&quot;Unknown dvb3 api event&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">smsdvb_update_dvb_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">RECEPTION_STATISTICS_S</span> <span class="o">*</span><span class="n">pReceptionData</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">SMSHOSTLIB_STATISTICS_ST</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sms_dbg</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Reserved = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">Reserved</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;IsRfLocked = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">IsRfLocked</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;IsDemodLocked = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">IsDemodLocked</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;IsExternalLNAOn = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">IsExternalLNAOn</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SNR = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">SNR</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;BER = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">BER</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;FIB_CRC = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">FIB_CRC</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TS_PER = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">TS_PER</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;MFER = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">MFER</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;RSSI = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">RSSI</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;InBandPwr = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">InBandPwr</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;CarrierOffset = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">CarrierOffset</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Frequency = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">Frequency</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Bandwidth = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">Bandwidth</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TransmissionMode = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">TransmissionMode</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ModemState = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ModemState</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;GuardInterval = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">GuardInterval</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;CodeRate = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">CodeRate</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;LPCodeRate = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LPCodeRate</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Hierarchy = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">Hierarchy</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Constellation = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">Constellation</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;BurstSize = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">BurstSize</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;BurstDuration = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">BurstDuration</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;BurstCycleTime = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">BurstCycleTime</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;CalculatedBurstCycleTime = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">CalculatedBurstCycleTime</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;NumOfRows = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">NumOfRows</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;NumOfPaddCols = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">NumOfPaddCols</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;NumOfPunctCols = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">NumOfPunctCols</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ErrorTSPackets = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ErrorTSPackets</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TotalTSPackets = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">TotalTSPackets</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;NumOfValidMpeTlbs = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">NumOfValidMpeTlbs</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;NumOfInvalidMpeTlbs = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">NumOfInvalidMpeTlbs</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;NumOfCorrectedMpeTlbs = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">NumOfCorrectedMpeTlbs</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;BERErrorCount = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">BERErrorCount</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;BERBitCount = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">BERBitCount</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SmsToHostTxErrors = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">SmsToHostTxErrors</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PreBER = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">PreBER</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;CellId = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">CellId</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DvbhSrvIndHP = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">DvbhSrvIndHP</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DvbhSrvIndLP = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">DvbhSrvIndLP</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;NumMPEReceived = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">NumMPEReceived</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">IsDemodLocked</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">IsDemodLocked</span><span class="p">;</span>

	<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">SNR</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">SNR</span><span class="p">;</span>
	<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">BER</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">BER</span><span class="p">;</span>
	<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">BERErrorCount</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">BERErrorCount</span><span class="p">;</span>
	<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">InBandPwr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">InBandPwr</span><span class="p">;</span>
	<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">ErrorTSPackets</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ErrorTSPackets</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">smsdvb_update_isdbt_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">RECEPTION_STATISTICS_S</span> <span class="o">*</span><span class="n">pReceptionData</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">SMSHOSTLIB_STATISTICS_ISDBT_ST</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sms_dbg</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;IsRfLocked = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">IsRfLocked</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;IsDemodLocked = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">IsDemodLocked</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;IsExternalLNAOn = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">IsExternalLNAOn</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SNR = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">SNR</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;RSSI = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">RSSI</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;InBandPwr = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">InBandPwr</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;CarrierOffset = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">CarrierOffset</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Frequency = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">Frequency</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Bandwidth = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">Bandwidth</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TransmissionMode = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">TransmissionMode</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ModemState = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ModemState</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;GuardInterval = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">GuardInterval</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SystemType = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">SystemType</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PartialReception = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">PartialReception</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;NumOfLayers = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">NumOfLayers</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SmsToHostTxErrors = %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">SmsToHostTxErrors</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%d: CodeRate = %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">CodeRate</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%d: Constellation = %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Constellation</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%d: BER = %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BER</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%d: BERErrorCount = %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BERErrorCount</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%d: BERBitCount = %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BERBitCount</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%d: PreBER = %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PreBER</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%d: TS_PER = %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">TS_PER</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%d: ErrorTSPackets = %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ErrorTSPackets</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%d: TotalTSPackets = %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">TotalTSPackets</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%d: TILdepthI = %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">TILdepthI</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%d: NumberOfSegments = %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">NumberOfSegments</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%d: TMCCErrors = %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">TMCCErrors</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">IsDemodLocked</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">IsDemodLocked</span><span class="p">;</span>

	<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">SNR</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">SNR</span><span class="p">;</span>
	<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">InBandPwr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">InBandPwr</span><span class="p">;</span>

	<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">ErrorTSPackets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">BER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">BERErrorCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">BER</span> <span class="o">+=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BER</span><span class="p">;</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">BERErrorCount</span> <span class="o">+=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BERErrorCount</span><span class="p">;</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">ErrorTSPackets</span> <span class="o">+=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LayerInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ErrorTSPackets</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_onresponse</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smscore_buffer_t</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">SmsMsgHdr_ST</span> <span class="o">*</span><span class="n">phdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">SmsMsgHdr_ST</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pMsgData</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">phdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*u32 MsgDataLen = phdr-&gt;msgLength - sizeof(struct SmsMsgHdr_ST);*/</span>
	<span class="n">bool</span> <span class="n">is_status_update</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">smsendian_handle_rx_message</span><span class="p">((</span><span class="k">struct</span> <span class="n">SmsMsgData_ST</span> <span class="o">*</span><span class="p">)</span> <span class="n">phdr</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phdr</span><span class="o">-&gt;</span><span class="n">msgType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSG_SMS_DVBT_BDA_DATA</span>:
		<span class="n">dvb_dmx_swfilter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">phdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				 <span class="n">cb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">SmsMsgHdr_ST</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSG_SMS_RF_TUNE_RES</span>:
	<span class="k">case</span> <span class="n">MSG_SMS_ISDBT_TUNE_RES</span>:
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tune_done</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSG_SMS_SIGNAL_DETECTED_IND</span>:
		<span class="n">sms_info</span><span class="p">(</span><span class="s">&quot;MSG_SMS_SIGNAL_DETECTED_IND&quot;</span><span class="p">);</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">TransmissionData</span><span class="p">.</span><span class="n">IsDemodLocked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">is_status_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSG_SMS_NO_SIGNAL_IND</span>:
		<span class="n">sms_info</span><span class="p">(</span><span class="s">&quot;MSG_SMS_NO_SIGNAL_IND&quot;</span><span class="p">);</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">TransmissionData</span><span class="p">.</span><span class="n">IsDemodLocked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">is_status_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSG_SMS_TRANSMISSION_IND</span>: <span class="p">{</span>
		<span class="n">sms_info</span><span class="p">(</span><span class="s">&quot;MSG_SMS_TRANSMISSION_IND&quot;</span><span class="p">);</span>

		<span class="n">pMsgData</span><span class="o">++</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">TransmissionData</span><span class="p">,</span> <span class="n">pMsgData</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">TRANSMISSION_STATISTICS_S</span><span class="p">));</span>

		<span class="cm">/* Mo need to correct guard interval</span>
<span class="cm">		 * (as opposed to old statistics message).</span>
<span class="cm">		 */</span>
		<span class="n">CORRECT_STAT_BANDWIDTH</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">TransmissionData</span><span class="p">);</span>
		<span class="n">CORRECT_STAT_TRANSMISSON_MODE</span><span class="p">(</span>
				<span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">TransmissionData</span><span class="p">);</span>
		<span class="n">is_status_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MSG_SMS_HO_PER_SLICES_IND</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">RECEPTION_STATISTICS_S</span> <span class="o">*</span><span class="n">pReceptionData</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">ReceptionData</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">SRVM_SIGNAL_STATUS_S</span> <span class="n">SignalStatusData</span><span class="p">;</span>

		<span class="cm">/*sms_info(&quot;MSG_SMS_HO_PER_SLICES_IND&quot;);*/</span>
		<span class="n">pMsgData</span><span class="o">++</span><span class="p">;</span>
		<span class="n">SignalStatusData</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">SignalStatusData</span><span class="p">.</span><span class="n">snr</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">SignalStatusData</span><span class="p">.</span><span class="n">inBandPower</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">SignalStatusData</span><span class="p">.</span><span class="n">tsPackets</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">SignalStatusData</span><span class="p">.</span><span class="n">etsPackets</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">SignalStatusData</span><span class="p">.</span><span class="n">constellation</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">SignalStatusData</span><span class="p">.</span><span class="n">hpCode</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="n">SignalStatusData</span><span class="p">.</span><span class="n">tpsSrvIndLP</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">SignalStatusData</span><span class="p">.</span><span class="n">tpsSrvIndHP</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">SignalStatusData</span><span class="p">.</span><span class="n">cellId</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="n">SignalStatusData</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
		<span class="n">SignalStatusData</span><span class="p">.</span><span class="n">requestId</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">IsRfLocked</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">IsDemodLocked</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">ModemState</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">SNR</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">BER</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">RSSI</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
		<span class="n">CORRECT_STAT_RSSI</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">ReceptionData</span><span class="p">);</span>

		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">InBandPwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">CarrierOffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">TotalTSPackets</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">ErrorTSPackets</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

		<span class="cm">/* TS PER */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">SignalStatusData</span><span class="p">.</span><span class="n">tsPackets</span> <span class="o">+</span> <span class="n">SignalStatusData</span><span class="p">.</span><span class="n">etsPackets</span><span class="p">)</span>
				<span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">TS_PER</span> <span class="o">=</span> <span class="p">(</span><span class="n">SignalStatusData</span><span class="p">.</span><span class="n">etsPackets</span>
					<span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">SignalStatusData</span><span class="p">.</span><span class="n">tsPackets</span>
					<span class="o">+</span> <span class="n">SignalStatusData</span><span class="p">.</span><span class="n">etsPackets</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">TS_PER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">BERBitCount</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">BERErrorCount</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>

		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">MRC_SNR</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">MRC_InBandPwr</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
		<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">MRC_RSSI</span> <span class="o">=</span> <span class="n">pMsgData</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>

		<span class="n">is_status_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MSG_SMS_GET_STATISTICS_RES</span>: <span class="p">{</span>
		<span class="k">union</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">SMSHOSTLIB_STATISTICS_ISDBT_ST</span>  <span class="n">isdbt</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">SmsMsgStatisticsInfo_ST</span>         <span class="n">dvb</span><span class="p">;</span>
		<span class="p">}</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">phdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">RECEPTION_STATISTICS_S</span> <span class="o">*</span><span class="n">pReceptionData</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">ReceptionData</span><span class="p">;</span>

		<span class="n">sms_info</span><span class="p">(</span><span class="s">&quot;MSG_SMS_GET_STATISTICS_RES&quot;</span><span class="p">);</span>

		<span class="n">is_status_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">smscore_get_device_mode</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">coredev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DEVICE_MODE_ISDBT</span>:
		<span class="k">case</span> <span class="n">DEVICE_MODE_ISDBT_BDA</span>:
			<span class="n">smsdvb_update_isdbt_stats</span><span class="p">(</span><span class="n">pReceptionData</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">isdbt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">smsdvb_update_dvb_stats</span><span class="p">(</span><span class="n">pReceptionData</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="p">.</span><span class="n">Stat</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">IsDemodLocked</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">SNR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">BER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">BERErrorCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">InBandPwr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pReceptionData</span><span class="o">-&gt;</span><span class="n">ErrorTSPackets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tune_done</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">sms_info</span><span class="p">(</span><span class="s">&quot;Unhandled message %d&quot;</span><span class="p">,</span> <span class="n">phdr</span><span class="o">-&gt;</span><span class="n">msgType</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="n">smscore_putbuffer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">coredev</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_status_update</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">ReceptionData</span><span class="p">.</span><span class="n">IsDemodLocked</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">client</span><span class="o">-&gt;</span><span class="n">fe_status</span> <span class="o">=</span> <span class="n">FE_HAS_SIGNAL</span> <span class="o">|</span> <span class="n">FE_HAS_CARRIER</span>
				<span class="o">|</span> <span class="n">FE_HAS_VITERBI</span> <span class="o">|</span> <span class="n">FE_HAS_SYNC</span> <span class="o">|</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>
			<span class="n">sms_board_dvb3_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DVB3_EVENT_FE_LOCK</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">ReceptionData</span><span class="p">.</span><span class="n">ErrorTSPackets</span>
					<span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">sms_board_dvb3_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DVB3_EVENT_UNC_OK</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">sms_board_dvb3_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						<span class="n">DVB3_EVENT_UNC_ERR</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">ReceptionData</span><span class="p">.</span><span class="n">IsRfLocked</span><span class="p">)</span>
				<span class="n">client</span><span class="o">-&gt;</span><span class="n">fe_status</span> <span class="o">=</span> <span class="n">FE_HAS_SIGNAL</span> <span class="o">|</span> <span class="n">FE_HAS_CARRIER</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">client</span><span class="o">-&gt;</span><span class="n">fe_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sms_board_dvb3_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DVB3_EVENT_FE_UNLOCK</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smsdvb_unregister_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under clientslock */</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>

	<span class="n">smscore_unregister_client</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">smsclient</span><span class="p">);</span>
	<span class="n">dvb_unregister_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">);</span>
	<span class="n">dvb_dmxdev_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">);</span>
	<span class="n">dvb_dmx_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>
	<span class="n">dvb_unregister_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smsdvb_onremove</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_smsdvb_clientslock</span><span class="p">);</span>

	<span class="n">smsdvb_unregister_client</span><span class="p">((</span><span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">context</span><span class="p">);</span>

	<span class="n">kmutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_smsdvb_clientslock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_start_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">,</span> <span class="n">demux</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">SmsMsgData_ST</span> <span class="n">PidMsg</span><span class="p">;</span>

	<span class="n">sms_debug</span><span class="p">(</span><span class="s">&quot;add pid %d(%x)&quot;</span><span class="p">,</span>
		  <span class="n">feed</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">feed</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">PidMsg</span><span class="p">.</span><span class="n">xMsgHeader</span><span class="p">.</span><span class="n">msgSrcId</span> <span class="o">=</span> <span class="n">DVBT_BDA_CONTROL_MSG_ID</span><span class="p">;</span>
	<span class="n">PidMsg</span><span class="p">.</span><span class="n">xMsgHeader</span><span class="p">.</span><span class="n">msgDstId</span> <span class="o">=</span> <span class="n">HIF_TASK</span><span class="p">;</span>
	<span class="n">PidMsg</span><span class="p">.</span><span class="n">xMsgHeader</span><span class="p">.</span><span class="n">msgFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PidMsg</span><span class="p">.</span><span class="n">xMsgHeader</span><span class="p">.</span><span class="n">msgType</span>  <span class="o">=</span> <span class="n">MSG_SMS_ADD_PID_FILTER_REQ</span><span class="p">;</span>
	<span class="n">PidMsg</span><span class="p">.</span><span class="n">xMsgHeader</span><span class="p">.</span><span class="n">msgLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PidMsg</span><span class="p">);</span>
	<span class="n">PidMsg</span><span class="p">.</span><span class="n">msgData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">feed</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>

	<span class="n">smsendian_handle_tx_message</span><span class="p">((</span><span class="k">struct</span> <span class="n">SmsMsgHdr_ST</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">PidMsg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">smsclient_sendrequest</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">smsclient</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">PidMsg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PidMsg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_stop_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">,</span> <span class="n">demux</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">SmsMsgData_ST</span> <span class="n">PidMsg</span><span class="p">;</span>

	<span class="n">sms_debug</span><span class="p">(</span><span class="s">&quot;remove pid %d(%x)&quot;</span><span class="p">,</span>
		  <span class="n">feed</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">feed</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">PidMsg</span><span class="p">.</span><span class="n">xMsgHeader</span><span class="p">.</span><span class="n">msgSrcId</span> <span class="o">=</span> <span class="n">DVBT_BDA_CONTROL_MSG_ID</span><span class="p">;</span>
	<span class="n">PidMsg</span><span class="p">.</span><span class="n">xMsgHeader</span><span class="p">.</span><span class="n">msgDstId</span> <span class="o">=</span> <span class="n">HIF_TASK</span><span class="p">;</span>
	<span class="n">PidMsg</span><span class="p">.</span><span class="n">xMsgHeader</span><span class="p">.</span><span class="n">msgFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PidMsg</span><span class="p">.</span><span class="n">xMsgHeader</span><span class="p">.</span><span class="n">msgType</span>  <span class="o">=</span> <span class="n">MSG_SMS_REMOVE_PID_FILTER_REQ</span><span class="p">;</span>
	<span class="n">PidMsg</span><span class="p">.</span><span class="n">xMsgHeader</span><span class="p">.</span><span class="n">msgLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PidMsg</span><span class="p">);</span>
	<span class="n">PidMsg</span><span class="p">.</span><span class="n">msgData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">feed</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>

	<span class="n">smsendian_handle_tx_message</span><span class="p">((</span><span class="k">struct</span> <span class="n">SmsMsgHdr_ST</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">PidMsg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">smsclient_sendrequest</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">smsclient</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">PidMsg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PidMsg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_sendrequest_and_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">completion</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">smsendian_handle_tx_message</span><span class="p">((</span><span class="k">struct</span> <span class="n">SmsMsgHdr_ST</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smsclient_sendrequest</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">smsclient</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="n">completion</span><span class="p">,</span>
					   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">))</span> <span class="o">?</span>
						<span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_send_statistics_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">SmsMsgHdr_ST</span> <span class="n">Msg</span> <span class="o">=</span> <span class="p">{</span> <span class="n">MSG_SMS_GET_STATISTICS_REQ</span><span class="p">,</span>
				    <span class="n">DVBT_BDA_CONTROL_MSG_ID</span><span class="p">,</span>
				    <span class="n">HIF_TASK</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">SmsMsgHdr_ST</span><span class="p">),</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">smsdvb_sendrequest_and_wait</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Msg</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tune_done</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">led_feedback</span><span class="p">(</span><span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">fe_status</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sms_board_led_feedback</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">coredev</span><span class="p">,</span>
			<span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">ReceptionData</span><span class="p">.</span><span class="n">BER</span>
			<span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">SMS_LED_HI</span> <span class="o">:</span> <span class="n">SMS_LED_LO</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sms_board_led_feedback</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">coredev</span><span class="p">,</span> <span class="n">SMS_LED_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span><span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="n">client</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">,</span> <span class="n">frontend</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">smsdvb_send_statistics_request</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">fe_status</span><span class="p">;</span>

	<span class="n">led_feedback</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="n">client</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">,</span> <span class="n">frontend</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">smsdvb_send_statistics_request</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">ReceptionData</span><span class="p">.</span><span class="n">BER</span><span class="p">;</span>

	<span class="n">led_feedback</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="n">client</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">,</span> <span class="n">frontend</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">smsdvb_send_statistics_request</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">ReceptionData</span><span class="p">.</span><span class="n">InBandPwr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">95</span><span class="p">)</span>
		<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">ReceptionData</span><span class="p">.</span><span class="n">InBandPwr</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">29</span><span class="p">)</span>
			<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">strength</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">ReceptionData</span><span class="p">.</span><span class="n">InBandPwr</span>
				<span class="o">+</span> <span class="mi">95</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">led_feedback</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="n">client</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">,</span> <span class="n">frontend</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">smsdvb_send_statistics_request</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">ReceptionData</span><span class="p">.</span><span class="n">SNR</span><span class="p">;</span>

	<span class="n">led_feedback</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_read_ucblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ucblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="n">client</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">,</span> <span class="n">frontend</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">smsdvb_send_statistics_request</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ucblocks</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">ReceptionData</span><span class="p">.</span><span class="n">ErrorTSPackets</span><span class="p">;</span>

	<span class="n">led_feedback</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_get_tune_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span> <span class="o">*</span><span class="n">tune</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sms_debug</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">tune</span><span class="o">-&gt;</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
	<span class="n">tune</span><span class="o">-&gt;</span><span class="n">step_size</span> <span class="o">=</span> <span class="mi">250000</span><span class="p">;</span>
	<span class="n">tune</span><span class="o">-&gt;</span><span class="n">max_drift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_dvbt_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">,</span> <span class="n">frontend</span><span class="p">);</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">SmsMsgHdr_ST</span>	<span class="n">Msg</span><span class="p">;</span>
		<span class="n">u32</span>		<span class="n">Data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">Msg</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">fe_status</span> <span class="o">=</span> <span class="n">FE_HAS_SIGNAL</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">event_fe_state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">event_unc_state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">=</span> <span class="n">SYS_DVBT</span><span class="p">;</span>

	<span class="n">Msg</span><span class="p">.</span><span class="n">Msg</span><span class="p">.</span><span class="n">msgSrcId</span> <span class="o">=</span> <span class="n">DVBT_BDA_CONTROL_MSG_ID</span><span class="p">;</span>
	<span class="n">Msg</span><span class="p">.</span><span class="n">Msg</span><span class="p">.</span><span class="n">msgDstId</span> <span class="o">=</span> <span class="n">HIF_TASK</span><span class="p">;</span>
	<span class="n">Msg</span><span class="p">.</span><span class="n">Msg</span><span class="p">.</span><span class="n">msgFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Msg</span><span class="p">.</span><span class="n">Msg</span><span class="p">.</span><span class="n">msgType</span> <span class="o">=</span> <span class="n">MSG_SMS_RF_TUNE_REQ</span><span class="p">;</span>
	<span class="n">Msg</span><span class="p">.</span><span class="n">Msg</span><span class="p">.</span><span class="n">msgLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Msg</span><span class="p">);</span>
	<span class="n">Msg</span><span class="p">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">Msg</span><span class="p">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12000000</span><span class="p">;</span>

	<span class="n">sms_info</span><span class="p">(</span><span class="s">&quot;%s: freq %d band %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">,</span>
		 <span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">Msg</span><span class="p">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BW_8_MHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">Msg</span><span class="p">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BW_7_MHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">Msg</span><span class="p">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BW_6_MHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Disable LNA, if any. An error is returned if no LNA is present */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sms_board_lna_control</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">coredev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fe_status_t</span> <span class="n">status</span><span class="p">;</span>

		<span class="cm">/* tune with LNA off at first */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">smsdvb_sendrequest_and_wait</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Msg</span><span class="p">),</span>
						  <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tune_done</span><span class="p">);</span>

		<span class="n">smsdvb_read_status</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* previous tune didn&#39;t lock - enable LNA and tune again */</span>
		<span class="n">sms_board_lna_control</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">coredev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">smsdvb_sendrequest_and_wait</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Msg</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tune_done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_isdbt_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">,</span> <span class="n">frontend</span><span class="p">);</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">SmsMsgHdr_ST</span>	<span class="n">Msg</span><span class="p">;</span>
		<span class="n">u32</span>		<span class="n">Data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">Msg</span><span class="p">;</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">=</span> <span class="n">SYS_ISDBT</span><span class="p">;</span>

	<span class="n">Msg</span><span class="p">.</span><span class="n">Msg</span><span class="p">.</span><span class="n">msgSrcId</span>  <span class="o">=</span> <span class="n">DVBT_BDA_CONTROL_MSG_ID</span><span class="p">;</span>
	<span class="n">Msg</span><span class="p">.</span><span class="n">Msg</span><span class="p">.</span><span class="n">msgDstId</span>  <span class="o">=</span> <span class="n">HIF_TASK</span><span class="p">;</span>
	<span class="n">Msg</span><span class="p">.</span><span class="n">Msg</span><span class="p">.</span><span class="n">msgFlags</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Msg</span><span class="p">.</span><span class="n">Msg</span><span class="p">.</span><span class="n">msgType</span>   <span class="o">=</span> <span class="n">MSG_SMS_ISDBT_TUNE_REQ</span><span class="p">;</span>
	<span class="n">Msg</span><span class="p">.</span><span class="n">Msg</span><span class="p">.</span><span class="n">msgLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">Msg</span><span class="p">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BW_ISDBT_3SEG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">Msg</span><span class="p">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BW_ISDBT_1SEG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* AUTO */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">Msg</span><span class="p">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BW_ISDBT_3SEG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">Msg</span><span class="p">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BW_ISDBT_1SEG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="cm">/* Assumes 6 MHZ bw */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">6000</span><span class="p">;</span>
			<span class="n">Msg</span><span class="p">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BW_ISDBT_1SEG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">sms_info</span><span class="p">(</span><span class="s">&quot;Segment count %d not supported&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Msg</span><span class="p">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">Msg</span><span class="p">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12000000</span><span class="p">;</span>
	<span class="n">Msg</span><span class="p">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_idx</span><span class="p">;</span>

	<span class="n">sms_info</span><span class="p">(</span><span class="s">&quot;%s: freq %d segwidth %d segindex %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_count</span><span class="p">,</span>
		 <span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_idx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">smsdvb_sendrequest_and_wait</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Msg</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tune_done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">,</span> <span class="n">frontend</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smscore_device_t</span> <span class="o">*</span><span class="n">coredev</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">coredev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">smscore_get_device_mode</span><span class="p">(</span><span class="n">coredev</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEVICE_MODE_DVBT</span>:
	<span class="k">case</span> <span class="n">DEVICE_MODE_DVBT_BDA</span>:
		<span class="k">return</span> <span class="n">smsdvb_dvbt_set_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DEVICE_MODE_ISDBT</span>:
	<span class="k">case</span> <span class="n">DEVICE_MODE_ISDBT_BDA</span>:
		<span class="k">return</span> <span class="n">smsdvb_isdbt_set_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">fep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">,</span> <span class="n">frontend</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smscore_device_t</span> <span class="o">*</span><span class="n">coredev</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">coredev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TRANSMISSION_STATISTICS_S</span> <span class="o">*</span><span class="n">td</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">sms_stat_dvb</span><span class="p">.</span><span class="n">TransmissionData</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">smscore_get_device_mode</span><span class="p">(</span><span class="n">coredev</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEVICE_MODE_DVBT</span>:
	<span class="k">case</span> <span class="n">DEVICE_MODE_DVBT_BDA</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">Frequency</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">Bandwidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">7000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">8000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">TransmissionMode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_2K</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">GuardInterval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_32</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">CodeRate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_1_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_5_6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_7_8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">LPCodeRate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_1_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_5_6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_7_8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">Constellation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QPSK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_64</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">Hierarchy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_NONE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">fep</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">INVERSION_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVICE_MODE_ISDBT</span>:
	<span class="k">case</span> <span class="n">DEVICE_MODE_ISDBT_BDA</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">Frequency</span><span class="p">;</span>
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span>
		<span class="cm">/* todo: retrive the other parameters */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">,</span> <span class="n">frontend</span><span class="p">);</span>

	<span class="n">sms_board_power</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">coredev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">sms_board_dvb3_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DVB3_EVENT_INIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">,</span> <span class="n">frontend</span><span class="p">);</span>

	<span class="n">sms_board_led_feedback</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">coredev</span><span class="p">,</span> <span class="n">SMS_LED_OFF</span><span class="p">);</span>
	<span class="n">sms_board_power</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">coredev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">sms_board_dvb3_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DVB3_EVENT_SLEEP</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smsdvb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* do nothing */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">smsdvb_fe_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;Siano Mobile Digital MDTV Receiver&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span>		<span class="o">=</span> <span class="mi">44250000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span>		<span class="o">=</span> <span class="mi">867250000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span>	<span class="o">=</span> <span class="mi">250000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">FE_CAN_INVERSION_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span>
			<span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_QPSK</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span>
			<span class="n">FE_CAN_QAM_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_TRANSMISSION_MODE_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_GUARD_INTERVAL_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_RECOVER</span> <span class="o">|</span>
			<span class="n">FE_CAN_HIERARCHY_AUTO</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">smsdvb_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">smsdvb_set_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend</span> <span class="o">=</span> <span class="n">smsdvb_get_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">=</span> <span class="n">smsdvb_get_tune_settings</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">smsdvb_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">smsdvb_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">smsdvb_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">smsdvb_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">smsdvb_read_ucblocks</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">smsdvb_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">smsdvb_sleep</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smsdvb_hotplug</span><span class="p">(</span><span class="k">struct</span> <span class="n">smscore_device_t</span> <span class="o">*</span><span class="n">coredev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arrival</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smsclient_params_t</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* device removal handled by onremove callback */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arrival</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">client</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smsdvb_client_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sms_err</span><span class="p">(</span><span class="s">&quot;kmalloc() failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* register dvb adapter */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dvb_register_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
				  <span class="n">sms_get_board</span><span class="p">(</span>
					<span class="n">smscore_get_board_id</span><span class="p">(</span><span class="n">coredev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				  <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sms_err</span><span class="p">(</span><span class="s">&quot;dvb_register_adapter() failed %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">adapter_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init dvb demux */</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">DMX_TS_FILTERING</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">filternum</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="cm">/* todo: nova ??? */</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">feednum</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">start_feed</span> <span class="o">=</span> <span class="n">smsdvb_start_feed</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">stop_feed</span> <span class="o">=</span> <span class="n">smsdvb_stop_feed</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dvb_dmx_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sms_err</span><span class="p">(</span><span class="s">&quot;dvb_dmx_init failed %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dvbdmx_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init dmxdev */</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">filternum</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">demux</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dvb_dmxdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sms_err</span><span class="p">(</span><span class="s">&quot;dvb_dmxdev_init failed %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dmxdev_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init and register frontend */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smsdvb_fe_ops</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">smscore_get_device_mode</span><span class="p">(</span><span class="n">coredev</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEVICE_MODE_DVBT</span>:
	<span class="k">case</span> <span class="n">DEVICE_MODE_DVBT_BDA</span>:
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SYS_DVBT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVICE_MODE_ISDBT</span>:
	<span class="k">case</span> <span class="n">DEVICE_MODE_ISDBT_BDA</span>:
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SYS_ISDBT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dvb_register_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sms_err</span><span class="p">(</span><span class="s">&quot;frontend registration failed %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">frontend_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">params</span><span class="p">.</span><span class="n">initial_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">MSG_SMS_DVBT_BDA_DATA</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">onresponse_handler</span> <span class="o">=</span> <span class="n">smsdvb_onresponse</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">onremove_handler</span> <span class="o">=</span> <span class="n">smsdvb_onremove</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">smscore_register_client</span><span class="p">(</span><span class="n">coredev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">smsclient</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sms_err</span><span class="p">(</span><span class="s">&quot;smscore_register_client() failed %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">client_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">coredev</span> <span class="o">=</span> <span class="n">coredev</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tune_done</span><span class="p">);</span>

	<span class="n">kmutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_smsdvb_clientslock</span><span class="p">);</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g_smsdvb_clients</span><span class="p">);</span>

	<span class="n">kmutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_smsdvb_clientslock</span><span class="p">);</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">event_fe_state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">event_unc_state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sms_board_dvb3_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DVB3_EVENT_HOTPLUG</span><span class="p">);</span>

	<span class="n">sms_info</span><span class="p">(</span><span class="s">&quot;success&quot;</span><span class="p">);</span>
	<span class="n">sms_board_setup</span><span class="p">(</span><span class="n">coredev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">client_error:</span>
	<span class="n">dvb_unregister_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">);</span>

<span class="nl">frontend_error:</span>
	<span class="n">dvb_dmxdev_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">);</span>

<span class="nl">dmxdev_error:</span>
	<span class="n">dvb_dmx_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>

<span class="nl">dvbdmx_error:</span>
	<span class="n">dvb_unregister_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">adapter_error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">smsdvb_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_smsdvb_clients</span><span class="p">);</span>
	<span class="n">kmutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_smsdvb_clientslock</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">smscore_register_hotplug</span><span class="p">(</span><span class="n">smsdvb_hotplug</span><span class="p">);</span>

	<span class="n">sms_debug</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">smsdvb_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smscore_unregister_hotplug</span><span class="p">(</span><span class="n">smsdvb_hotplug</span><span class="p">);</span>

	<span class="n">kmutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_smsdvb_clientslock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_smsdvb_clients</span><span class="p">))</span>
	       <span class="n">smsdvb_unregister_client</span><span class="p">(</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">smsdvb_client_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">g_smsdvb_clients</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>

	<span class="n">kmutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_smsdvb_clientslock</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">smsdvb_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">smsdvb_module_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SMS DVB subsystem adaptation module&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Siano Mobile Silicon, Inc. (uris@siano-ms.com)&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
