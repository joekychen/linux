<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › ttpci › budget-av.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>budget-av.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * budget-av.c: driver for the SAA7146 based Budget DVB cards</span>
<span class="cm"> *              with analog video in</span>
<span class="cm"> *</span>
<span class="cm"> * Compiled from various sources by Michael Hunold &lt;michael@mihu.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * CI interface support (c) 2004 Olivier Gournet &lt;ogournet@anevia.com&gt; &amp;</span>
<span class="cm"> *                               Andrew de Quincey &lt;adq_dvb@lidskialf.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2002 Ralph Metzler &lt;rjkm@metzlerbros.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999-2002 Ralph  Metzler</span>
<span class="cm"> *                       &amp; Marcus Metzler for convergence integrated media GmbH</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> * Or, point your browser to http://www.gnu.org/copyleft/gpl.html</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * the project&#39;s page is at http://www.linuxtv.org/ </span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &quot;budget.h&quot;</span>
<span class="cp">#include &quot;stv0299.h&quot;</span>
<span class="cp">#include &quot;stb0899_drv.h&quot;</span>
<span class="cp">#include &quot;stb0899_reg.h&quot;</span>
<span class="cp">#include &quot;stb0899_cfg.h&quot;</span>
<span class="cp">#include &quot;tda8261.h&quot;</span>
<span class="cp">#include &quot;tda8261_cfg.h&quot;</span>
<span class="cp">#include &quot;tda1002x.h&quot;</span>
<span class="cp">#include &quot;tda1004x.h&quot;</span>
<span class="cp">#include &quot;tua6100.h&quot;</span>
<span class="cp">#include &quot;dvb-pll.h&quot;</span>
<span class="cp">#include &lt;media/saa7146_vv.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#include &quot;dvb_ca_en50221.h&quot;</span>

<span class="cp">#define DEBICICAM		0x02420000</span>

<span class="cp">#define SLOTSTATUS_NONE         1</span>
<span class="cp">#define SLOTSTATUS_PRESENT      2</span>
<span class="cp">#define SLOTSTATUS_RESET        4</span>
<span class="cp">#define SLOTSTATUS_READY        8</span>
<span class="cp">#define SLOTSTATUS_OCCUPIED     (SLOTSTATUS_PRESENT|SLOTSTATUS_RESET|SLOTSTATUS_READY)</span>

<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">budget_av</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget</span> <span class="n">budget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur_input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">has_saa7113</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">ciintf_irq_tasklet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="n">ca</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reinitialise_demod</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ciintf_slot_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">);</span>


<span class="cm">/* GPIO Connections:</span>
<span class="cm"> * 0 - Vcc/Reset (Reset is controlled by capacitor). Resets the frontend *AS WELL*!</span>
<span class="cm"> * 1 - CI memory select 0=&gt;IO memory, 1=&gt;Attribute Memory</span>
<span class="cm"> * 2 - CI Card Enable (Active Low)</span>
<span class="cm"> * 3 - CI Card Detect</span>
<span class="cm"> */</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * INITIALIZATION</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">i2c_readreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mm1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">mm2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">id</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mm1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">mm1</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">mm2</span><span class="p">;</span>

	<span class="n">i2c_transfer</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mm2</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_readregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mm1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">id</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">mm1</span><span class="p">,.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">id</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_writereg</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">;</span>

	<span class="n">msgs</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">id</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_read_attribute_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ttpci_budget_debiread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICAM</span><span class="p">,</span> <span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ciintf_slot_shutdown</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cam ejected 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_write_attribute_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICAM</span><span class="p">,</span> <span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ciintf_slot_shutdown</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cam ejected 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_read_cam_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ttpci_budget_debiread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICAM</span><span class="p">,</span> <span class="n">address</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ciintf_slot_shutdown</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cam ejected 3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_write_cam_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">address</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICAM</span><span class="p">,</span> <span class="n">address</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ciintf_slot_shutdown</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cam ejected 5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ciintf_slot_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_RESET</span><span class="p">;</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span> <span class="cm">/* disable card */</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span> <span class="cm">/* Vcc off */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span> <span class="cm">/* Vcc on */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span> <span class="cm">/* 20 ms Vcc settling time */</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span> <span class="cm">/* enable card */</span>
	<span class="n">ttpci_budget_set_video_port</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">BUDGET_VIDEO_PORTB</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* reinitialise the frontend if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">reinitialise_demod</span><span class="p">)</span>
		<span class="n">dvb_frontend_reinitialise</span><span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_slot_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ciintf_slot_shutdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ttpci_budget_set_video_port</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">BUDGET_VIDEO_PORTB</span><span class="p">);</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_slot_ts_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ciintf_slot_ts_enable: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span><span class="p">);</span>

	<span class="n">ttpci_budget_set_video_port</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">BUDGET_VIDEO_PORTA</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_poll_slot_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* test the card detect line - needs to be done carefully</span>
<span class="cm">	 * since it never goes high for some CAMs on this interface (e.g. topuptv) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">==</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_INPUT</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saa7146_read</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">PSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASK_06</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">==</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_PRESENT</span><span class="p">;</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cam inserted A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We also try and read from IO memory to work round the above detection bug. If</span>
<span class="cm">	 * there is no CAM, we will get a timeout. Only done if there is no cam</span>
<span class="cm">	 * present, since this test actually breaks some cams :(</span>
<span class="cm">	 *</span>
<span class="cm">	 * if the CI interface is not open, we also do the above test since we</span>
<span class="cm">	 * don&#39;t care if the cam has problems - we&#39;ll be resetting it on open() anyway */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">==</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">open</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">ttpci_budget_debiread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">==</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_PRESENT</span><span class="p">;</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cam inserted B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">!=</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ciintf_slot_shutdown</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cam ejected 5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* read from attribute memory in reset/ready state to know when the CAM is ready */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">==</span> <span class="n">SLOTSTATUS_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">ciintf_read_attribute_mem</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mh">0x1d</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_READY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* work out correct return code */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">!=</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">&amp;</span> <span class="n">SLOTSTATUS_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">DVB_CA_EN50221_POLL_CAM_PRESENT</span> <span class="o">|</span> <span class="n">DVB_CA_EN50221_POLL_CAM_READY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">DVB_CA_EN50221_POLL_CAM_PRESENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span><span class="p">));</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>

	<span class="cm">/* Enable DEBI pins */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_27</span> <span class="o">|</span> <span class="n">MASK_11</span><span class="p">);</span>

	<span class="cm">/* register CI interface */</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">read_attribute_mem</span> <span class="o">=</span> <span class="n">ciintf_read_attribute_mem</span><span class="p">;</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">write_attribute_mem</span> <span class="o">=</span> <span class="n">ciintf_write_attribute_mem</span><span class="p">;</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">read_cam_control</span> <span class="o">=</span> <span class="n">ciintf_read_cam_control</span><span class="p">;</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">write_cam_control</span> <span class="o">=</span> <span class="n">ciintf_write_cam_control</span><span class="p">;</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">ciintf_slot_reset</span><span class="p">;</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">slot_shutdown</span> <span class="o">=</span> <span class="n">ciintf_slot_shutdown</span><span class="p">;</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">slot_ts_enable</span> <span class="o">=</span> <span class="n">ciintf_slot_ts_enable</span><span class="p">;</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">poll_slot_status</span> <span class="o">=</span> <span class="n">ciintf_poll_slot_status</span><span class="p">;</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">budget_av</span><span class="p">;</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">ci_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_adapter</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ci initialisation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ci interface initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_27</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ciintf_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7146_GPIO_INPUT</span><span class="p">);</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAA7146_GPIO_INPUT</span><span class="p">);</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SAA7146_GPIO_INPUT</span><span class="p">);</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_INPUT</span><span class="p">);</span>

	<span class="cm">/* release the CA device */</span>
	<span class="n">dvb_ca_en50221_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">);</span>

	<span class="cm">/* disable DEBI pins */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_27</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">saa7113_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span>
	<span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span>
	<span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span>

	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span>
	<span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
	<span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xff</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7113_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="n">budget</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">saa7113_tab</span><span class="p">;</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;saa7113 not found on KNC card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;saa7113 detected and initializing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;saa7113  status=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i2c_readreg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7113_setinput</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span><span class="p">,</span> <span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="n">budget</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">has_saa7113</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">);</span>
		<span class="n">i2c_writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
		<span class="n">i2c_writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">cur_input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">philips_su1278_ty_ci_set_symbol_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">srate</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">aclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">m1</span><span class="p">;</span>

	<span class="n">aclk</span> <span class="o">=</span> <span class="mh">0xb5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">)</span>
		<span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x86</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">5000000</span><span class="p">)</span>
		<span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x89</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">15000000</span><span class="p">)</span>
		<span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x8f</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">45000000</span><span class="p">)</span>
		<span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x95</span><span class="p">;</span>

	<span class="n">m1</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">4000000</span><span class="p">)</span>
		<span class="n">m1</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">aclk</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">bclk</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="n">m1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">philips_su1278_ty_ci_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">,.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">950000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="mi">2150000</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="p">(</span><span class="mi">125</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">125</span><span class="p">;</span>	<span class="cm">/* round correctly */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">((</span><span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0x18000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">&lt;</span> <span class="mi">4000000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">1250000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">1550000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">2050000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">2150000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0xC0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">typhoon_cinergy1200s_inittab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span>		<span class="cm">/* F22FR = 0x7d, F22 = f_VCO / 128 / 0x7d = 22 kHz */</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span>		<span class="cm">/* I2CT = 0, SCLT = 1, SDAT = 1 */</span>
	<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>		<span class="cm">/* DAC not used, set to high impendance mode */</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>		<span class="cm">/* DAC LSB */</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>		<span class="cm">/* DiSEqC off */</span>
	<span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>		<span class="cm">/* FIFO */</span>
	<span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span>		<span class="cm">/* OP1 ctl = Normal, OP1 val = 1 (LNB Power ON) */</span>
	<span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span>		<span class="cm">/* DC offset compensation = ON, beta_agc1 = 2 */</span>
	<span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span>		<span class="cm">/* alpha_tmg = 2, beta_tmg = 3 */</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span>		<span class="c1">// AGC2  0x3d</span>
	<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span>
	<span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span>
	<span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span>		<span class="c1">// lock detector threshold</span>
	<span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>		<span class="c1">// out imp: normal  out type: parallel FEC mode:0</span>
	<span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span>		<span class="c1">// 1/2 threshold</span>
	<span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>		<span class="c1">// 2/3 threshold</span>
	<span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span>		<span class="c1">// 3/4 threshold</span>
	<span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span>		<span class="c1">// 5/6 threshold</span>
	<span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>		<span class="c1">// 7/8 threshold</span>
	<span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span>		<span class="c1">// test all FECs</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span>		<span class="c1">// viterbi and synchro search</span>
	<span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span>		<span class="c1">// rs control</span>
	<span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span>		<span class="c1">// error control</span>
	<span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0299_config</span> <span class="n">typhoon_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inittab</span> <span class="o">=</span> <span class="n">typhoon_cinergy1200s_inittab</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">88000000UL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">skip_reinit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock_output</span> <span class="o">=</span> <span class="n">STV0299_LOCKOUTPUT_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">volt13_op0_op1</span> <span class="o">=</span> <span class="n">STV0299_VOLT13_OP0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_symbol_rate</span> <span class="o">=</span> <span class="n">philips_su1278_ty_ci_set_symbol_rate</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0299_config</span> <span class="n">cinergy_1200s_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inittab</span> <span class="o">=</span> <span class="n">typhoon_cinergy1200s_inittab</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">88000000UL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">skip_reinit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock_output</span> <span class="o">=</span> <span class="n">STV0299_LOCKOUTPUT_0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">volt13_op0_op1</span> <span class="o">=</span> <span class="n">STV0299_VOLT13_OP0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_symbol_rate</span> <span class="o">=</span> <span class="n">philips_su1278_ty_ci_set_symbol_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0299_config</span> <span class="n">cinergy_1200s_1894_0010_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inittab</span> <span class="o">=</span> <span class="n">typhoon_cinergy1200s_inittab</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">88000000UL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">skip_reinit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock_output</span> <span class="o">=</span> <span class="n">STV0299_LOCKOUTPUT_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">volt13_op0_op1</span> <span class="o">=</span> <span class="n">STV0299_VOLT13_OP0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_symbol_rate</span> <span class="o">=</span> <span class="n">philips_su1278_ty_ci_set_symbol_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">philips_cu1216_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#define CU1216_IF 36125000</span>
<span class="cp">#define TUNER_MUL 62500</span>

	<span class="n">u32</span> <span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="n">CU1216_IF</span> <span class="o">+</span> <span class="n">TUNER_MUL</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">TUNER_MUL</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xce</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">150000000</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span>
		  <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">445000000</span> <span class="o">?</span> <span class="mh">0x02</span> <span class="o">:</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xde</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* wait for the pll lock */</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* switch the charge pump to the lower current */</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda1002x_config</span> <span class="n">philips_cu1216_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda1002x_config</span> <span class="n">philips_cu1216_config_altaddress</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0d</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda10023_config</span> <span class="n">philips_cu1216_tda10023_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">philips_tu1216_tuner_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">tu1216_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xab</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">tuner_msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">tu1216_init</span><span class="p">,.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tu1216_init</span><span class="p">)</span> <span class="p">};</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>setup PLL configuration</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">philips_tu1216_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tuner_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">tuner_msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">tuner_buf</span><span class="p">,.</span><span class="n">len</span> <span class="o">=</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">tuner_buf</span><span class="p">)</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">tuner_frequency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">band</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">filter</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>determine charge pump</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tuner_frequency</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">36166000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">87000000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">130000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">160000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">200000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">290000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">420000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">480000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">620000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">830000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">895000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>determine band</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">49000000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">161000000</span><span class="p">)</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">444000000</span><span class="p">)</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">861000000</span><span class="p">)</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>setup PLL filter</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6000000</span>:
		<span class="n">filter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">7000000</span>:
		<span class="n">filter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8000000</span>:
		<span class="n">filter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>calculate divisor
((36166000+((1000000/6)/2)) + Finput)/(1000000/6)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tuner_frequency</span> <span class="o">=</span> <span class="p">(((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">217496</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>setup tuner buffer</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tuner_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">tuner_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tuner_frequency</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tuner_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xca</span><span class="p">;</span>
	<span class="n">tuner_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">band</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">philips_tu1216_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
					   <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">fw</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">request_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda1004x_config</span> <span class="n">philips_tu1216_config</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert_oclk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xtal_freq</span> <span class="o">=</span> <span class="n">TDA10046_XTAL_4M</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc_config</span> <span class="o">=</span> <span class="n">TDA10046_AGC_DEFAULT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">if_freq</span> <span class="o">=</span> <span class="n">TDA10046_FREQ_3617</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_firmware</span> <span class="o">=</span> <span class="n">philips_tu1216_request_firmware</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">philips_sd1878_inittab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span>
	<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span>
	<span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span>
	<span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span>
	<span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span>
	<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span>
	<span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span>
	<span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span>
	<span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span>
	<span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span>
	<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span>
	<span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span>
	<span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span>
	<span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span>
	<span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span>
	<span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span>
	<span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span>
	<span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span>
	<span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">philips_sd1878_ci_set_symbol_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">srate</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">aclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">m1</span><span class="p">;</span>

	<span class="n">aclk</span> <span class="o">=</span> <span class="mh">0xb5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">)</span>
		<span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x86</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">5000000</span><span class="p">)</span>
		<span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x89</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">15000000</span><span class="p">)</span>
		<span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x8f</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">45000000</span><span class="p">)</span>
		<span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x95</span><span class="p">;</span>

	<span class="n">m1</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">4000000</span><span class="p">)</span>
		<span class="n">m1</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">aclk</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">bclk</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="n">m1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0299_config</span> <span class="n">philips_sd1878_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
     <span class="p">.</span><span class="n">inittab</span> <span class="o">=</span> <span class="n">philips_sd1878_inittab</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">88000000UL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">skip_reinit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock_output</span> <span class="o">=</span> <span class="n">STV0299_LOCKOUTPUT_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">volt13_op0_op1</span> <span class="o">=</span> <span class="n">STV0299_VOLT13_OP0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_symbol_rate</span> <span class="o">=</span> <span class="n">philips_sd1878_ci_set_symbol_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* KNC1 DVB-S (STB0899) Inittab	*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stb0899_s1_reg</span> <span class="n">knc1_stb0899_s1_init_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">{</span> <span class="n">STB0899_DEV_ID</span>		<span class="p">,</span> <span class="mh">0x81</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISCNTRL1</span>		<span class="p">,</span> <span class="mh">0x32</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISCNTRL2</span>		<span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISRX_ST0</span>		<span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISRX_ST1</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISPARITY</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISSTATUS</span>		<span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISF22</span>		<span class="p">,</span> <span class="mh">0x8c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISF22RX</span>		<span class="p">,</span> <span class="mh">0x9a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYSREG</span>		<span class="p">,</span> <span class="mh">0x0b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ACRPRESC</span>		<span class="p">,</span> <span class="mh">0x11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ACRDIV1</span>		<span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ACRDIV2</span>		<span class="p">,</span> <span class="mh">0x05</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DACR1</span>			<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DACR2</span>			<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_OUTCFG</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MODECFG</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQSTATUS_3</span>		<span class="p">,</span> <span class="mh">0x30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQSTATUS_2</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQSTATUS_1</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQSTATUS_0</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQMSK_3</span>		<span class="p">,</span> <span class="mh">0xf3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQMSK_2</span>		<span class="p">,</span> <span class="mh">0xfc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQMSK_1</span>		<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQMSK_0</span>		<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQCFG</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_I2CCFG</span>		<span class="p">,</span> <span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_I2CRPT</span>		<span class="p">,</span> <span class="mh">0x58</span> <span class="p">},</span> <span class="cm">/* Repeater=8, Stop=disabled */</span>
	<span class="p">{</span> <span class="n">STB0899_IOPVALUE5</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IOPVALUE4</span>		<span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IOPVALUE3</span>		<span class="p">,</span> <span class="mh">0xc9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IOPVALUE2</span>		<span class="p">,</span> <span class="mh">0x90</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IOPVALUE1</span>		<span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IOPVALUE0</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO00CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO01CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO02CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO03CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO04CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO05CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO06CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO07CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO08CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO09CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO10CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO11CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO12CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO13CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO14CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO15CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO16CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO17CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO18CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO19CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO20CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SDATCFG</span>		<span class="p">,</span> <span class="mh">0xb8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SCLTCFG</span>		<span class="p">,</span> <span class="mh">0xba</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGCRFCFG</span>		<span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span> <span class="cm">/* 0x1c */</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO22</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span> <span class="cm">/* AGCBB2CFG */</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO21</span>		<span class="p">,</span> <span class="mh">0x91</span> <span class="p">},</span> <span class="cm">/* AGCBB1CFG */</span>
	<span class="p">{</span> <span class="n">STB0899_DIRCLKCFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CLKOUT27CFG</span>		<span class="p">,</span> <span class="mh">0x7e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_STDBYCFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CS0CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CS1CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISEQCOCFG</span>		<span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO32CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO33CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO34CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO35CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO36CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO37CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO38CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO39CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_NCOARSE</span>		<span class="p">,</span> <span class="mh">0x15</span> <span class="p">},</span> <span class="cm">/* 0x15 = 27 Mhz Clock, F/3 = 198MHz, F/6 = 99MHz */</span>
	<span class="p">{</span> <span class="n">STB0899_SYNTCTRL</span>		<span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span> <span class="cm">/* 0x00 = CLK from CLKI, 0x02 = CLK from XTALI */</span>
	<span class="p">{</span> <span class="n">STB0899_FILTCTRL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYSCTRL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_STOPCLK1</span>		<span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_STOPCLK2</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_INTBUFSTATUS</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_INTBUFCTRL</span>		<span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xffff</span>			<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stb0899_s1_reg</span> <span class="n">knc1_stb0899_s1_init_3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">STB0899_DEMOD</span>			<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RCOMPC</span>		<span class="p">,</span> <span class="mh">0xc9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC1CN</span>		<span class="p">,</span> <span class="mh">0x41</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC1REF</span>		<span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RTC</span>			<span class="p">,</span> <span class="mh">0x7a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TMGCFG</span>		<span class="p">,</span> <span class="mh">0x4e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC2REF</span>		<span class="p">,</span> <span class="mh">0x33</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TLSR</span>			<span class="p">,</span> <span class="mh">0x84</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFD</span>			<span class="p">,</span> <span class="mh">0xee</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ACLC</span>			<span class="p">,</span> <span class="mh">0x87</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BCLC</span>			<span class="p">,</span> <span class="mh">0x94</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQON</span>			<span class="p">,</span> <span class="mh">0x41</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_LDT</span>			<span class="p">,</span> <span class="mh">0xdd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_LDT2</span>			<span class="p">,</span> <span class="mh">0xc9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUALREF</span>		<span class="p">,</span> <span class="mh">0xb4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TMGRAMP</span>		<span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TMGTHD</span>		<span class="p">,</span> <span class="mh">0x30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IDCCOMP</span>		<span class="p">,</span> <span class="mh">0xfb</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_QDCCOMP</span>		<span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_POWERI</span>		<span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_POWERQ</span>		<span class="p">,</span> <span class="mh">0x3d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RCOMP</span>			<span class="p">,</span> <span class="mh">0x81</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGCIQIN</span>		<span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC2I1</span>		<span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC2I2</span>		<span class="p">,</span> <span class="mh">0xf5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TLIR</span>			<span class="p">,</span> <span class="mh">0x25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RTF</span>			<span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DSTATUS</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_LDI</span>			<span class="p">,</span> <span class="mh">0xca</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFRM</span>			<span class="p">,</span> <span class="mh">0xf1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFRL</span>			<span class="p">,</span> <span class="mh">0xf3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_NIRM</span>			<span class="p">,</span> <span class="mh">0x2a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_NIRL</span>			<span class="p">,</span> <span class="mh">0x05</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ISYMB</span>			<span class="p">,</span> <span class="mh">0x17</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_QSYMB</span>			<span class="p">,</span> <span class="mh">0xfa</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRH</span>			<span class="p">,</span> <span class="mh">0x2f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRM</span>			<span class="p">,</span> <span class="mh">0x68</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRL</span>			<span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRUPH</span>		<span class="p">,</span> <span class="mh">0x2f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRUPM</span>		<span class="p">,</span> <span class="mh">0x68</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRUPL</span>		<span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI1</span>		<span class="p">,</span> <span class="mh">0xfd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ1</span>		<span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI2</span>		<span class="p">,</span> <span class="mh">0x0f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ2</span>		<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI3</span>		<span class="p">,</span> <span class="mh">0xdf</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ3</span>		<span class="p">,</span> <span class="mh">0xfa</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI4</span>		<span class="p">,</span> <span class="mh">0x37</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ4</span>		<span class="p">,</span> <span class="mh">0x0d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI5</span>		<span class="p">,</span> <span class="mh">0xbd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ5</span>		<span class="p">,</span> <span class="mh">0xf7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DSTATUS2</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VSTATUS</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VERROR</span>		<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IQSWAP</span>		<span class="p">,</span> <span class="mh">0x2a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT1M</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT1L</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT2M</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT2L</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT3M</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT3L</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_FECAUTO1</span>		<span class="p">,</span> <span class="mh">0x06</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_FECM</span>			<span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH12</span>			<span class="p">,</span> <span class="mh">0xf0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH23</span>			<span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH34</span>			<span class="p">,</span> <span class="mh">0x78</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH56</span>			<span class="p">,</span> <span class="mh">0x4e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH67</span>			<span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH78</span>			<span class="p">,</span> <span class="mh">0x38</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PRVIT</span>			<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VITSYNC</span>		<span class="p">,</span> <span class="mh">0x19</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RSULC</span>			<span class="p">,</span> <span class="mh">0xb1</span> <span class="p">},</span> <span class="cm">/* DVB = 0xb1, DSS = 0xa1 */</span>
	<span class="p">{</span> <span class="n">STB0899_TSULC</span>			<span class="p">,</span> <span class="mh">0x42</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RSLLC</span>			<span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSLPL</span>			<span class="p">,</span> <span class="mh">0x12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSCFGH</span>		<span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSCFGM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSCFGL</span>		<span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSOUT</span>			<span class="p">,</span> <span class="mh">0x4d</span> <span class="p">},</span> <span class="cm">/* 0x0d for CAM */</span>
	<span class="p">{</span> <span class="n">STB0899_RSSYNCDEL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSINHDELH</span>		<span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSINHDELM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSINHDELL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSLLSTKM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSLLSTKL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSULSTKM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSULSTKL</span>		<span class="p">,</span> <span class="mh">0xab</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PCKLENUL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PCKLENLL</span>		<span class="p">,</span> <span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RSPCKLEN</span>		<span class="p">,</span> <span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSSTATUS</span>		<span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ERRCTRL1</span>		<span class="p">,</span> <span class="mh">0xb6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ERRCTRL2</span>		<span class="p">,</span> <span class="mh">0x96</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ERRCTRL3</span>		<span class="p">,</span> <span class="mh">0x89</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DMONMSK1</span>		<span class="p">,</span> <span class="mh">0x27</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DMONMSK0</span>		<span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DEMAPVIT</span>		<span class="p">,</span> <span class="mh">0x5c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PLPARM</span>		<span class="p">,</span> <span class="mh">0x1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PDELCTRL</span>		<span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PDELCTRL2</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BBHCTRL1</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BBHCTRL2</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_HYSTTHRESH</span>		<span class="p">,</span> <span class="mh">0x77</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MATCSTM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MATCSTL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPLCSTM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPLCSTL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DFLCSTM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DFLCSTL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCCST</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCDCSTM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCDCSTL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ISI_ENTRY</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ISI_BIT_EN</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MATSTRM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MATSTRL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPLSTRM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPLSTRL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DFLSTRM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DFLSTRL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCSTR</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCDSTRM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCDSTRL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFGPDELSTATUS1</span>	<span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFGPDELSTATUS2</span>	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BBFERRORM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BBFERRORL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPKTERRORM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPKTERRORL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xffff</span>			<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* STB0899 demodulator config for the KNC1 and clones */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stb0899_config</span> <span class="n">knc1_dvbs2_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init_dev</span>		<span class="o">=</span> <span class="n">knc1_stb0899_s1_init_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_s2_demod</span>		<span class="o">=</span> <span class="n">stb0899_s2_init_2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_s1_demod</span>		<span class="o">=</span> <span class="n">knc1_stb0899_s1_init_3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_s2_fec</span>		<span class="o">=</span> <span class="n">stb0899_s2_init_4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_tst</span>		<span class="o">=</span> <span class="n">stb0899_s1_init_5</span><span class="p">,</span>

	<span class="p">.</span><span class="n">postproc</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>

	<span class="p">.</span><span class="n">demod_address</span>		<span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>.ts<em>output</em>mode        = STB0899<em>OUT</em>PARALLEL, /* types = SERIAL/PARALLEL  */</p></td><td class="code"><div class="highlight"><pre>	<span class="p">.</span><span class="n">block_sync_mode</span>	<span class="o">=</span> <span class="n">STB0899_SYNC_FORCED</span><span class="p">,</span>	<span class="cm">/* DSS, SYNC_FORCED/UNSYNCED	*/</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>.ts<em>pfbit</em>toggle    = STB0899<em>MPEG</em>NORMAL,  /* DirecTV, MPEG toggling seq   */</p></td><td class="code"><div class="highlight"><pre>	<span class="p">.</span><span class="n">xtal_freq</span>		<span class="o">=</span> <span class="mi">27000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inversion</span>		<span class="o">=</span> <span class="n">IQ_SWAP_OFF</span><span class="p">,</span> <span class="cm">/* 1 */</span>

	<span class="p">.</span><span class="n">lo_clk</span>			<span class="o">=</span> <span class="mi">76500000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hi_clk</span>			<span class="o">=</span> <span class="mi">90000000</span><span class="p">,</span>

	<span class="p">.</span><span class="n">esno_ave</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_ESNO_AVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">esno_quant</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_ESNO_QUANT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">avframes_coarse</span>	<span class="o">=</span> <span class="n">STB0899_DVBS2_AVFRAMES_COARSE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">avframes_fine</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_AVFRAMES_FINE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">miss_threshold</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_MISS_THRESHOLD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uwp_threshold_acq</span>	<span class="o">=</span> <span class="n">STB0899_DVBS2_UWP_THRESHOLD_ACQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uwp_threshold_track</span>	<span class="o">=</span> <span class="n">STB0899_DVBS2_UWP_THRESHOLD_TRACK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uwp_threshold_sof</span>	<span class="o">=</span> <span class="n">STB0899_DVBS2_UWP_THRESHOLD_SOF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sof_search_timeout</span>	<span class="o">=</span> <span class="n">STB0899_DVBS2_SOF_SEARCH_TIMEOUT</span><span class="p">,</span>

	<span class="p">.</span><span class="n">btr_nco_bits</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_BTR_NCO_BITS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">btr_gain_shift_offset</span>	<span class="o">=</span> <span class="n">STB0899_DVBS2_BTR_GAIN_SHIFT_OFFSET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crl_nco_bits</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_CRL_NCO_BITS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ldpc_max_iter</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_LDPC_MAX_ITER</span><span class="p">,</span>

	<span class="p">.</span><span class="n">tuner_get_frequency</span>	<span class="o">=</span> <span class="n">tda8261_get_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_set_frequency</span>	<span class="o">=</span> <span class="n">tda8261_set_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_set_bandwidth</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_get_bandwidth</span>	<span class="o">=</span> <span class="n">tda8261_get_bandwidth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_set_rfsiggain</span>	<span class="o">=</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * SD1878/SHA tuner config</span>
<span class="cm"> * 1F, Single I/P, Horizontal mount, High Sensitivity</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tda8261_config</span> <span class="n">sd1878c_config</span> <span class="o">=</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>.name        = "SD1878/SHA",</p></td><td class="code"><div class="highlight"><pre>	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="p">.</span><span class="n">step_size</span>	<span class="o">=</span> <span class="n">TDA8261_STEP_1000</span> <span class="cm">/* kHz */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">read_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pwm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">,.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">,.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pwm</span><span class="p">,.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">pwm</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">))</span>
		<span class="n">pwm</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pwm</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SUBID_DVBS_KNC1			0x0010</span>
<span class="cp">#define SUBID_DVBS_KNC1_PLUS		0x0011</span>
<span class="cp">#define SUBID_DVBS_TYPHOON		0x4f56</span>
<span class="cp">#define SUBID_DVBS_CINERGY1200		0x1154</span>
<span class="cp">#define SUBID_DVBS_CYNERGY1200N 	0x1155</span>
<span class="cp">#define SUBID_DVBS_TV_STAR		0x0014</span>
<span class="cp">#define SUBID_DVBS_TV_STAR_PLUS_X4	0x0015</span>
<span class="cp">#define SUBID_DVBS_TV_STAR_CI		0x0016</span>
<span class="cp">#define SUBID_DVBS2_KNC1		0x0018</span>
<span class="cp">#define SUBID_DVBS2_KNC1_OEM		0x0019</span>
<span class="cp">#define SUBID_DVBS_EASYWATCH_1  	0x001a</span>
<span class="cp">#define SUBID_DVBS_EASYWATCH_2  	0x001b</span>
<span class="cp">#define SUBID_DVBS2_EASYWATCH		0x001d</span>
<span class="cp">#define SUBID_DVBS_EASYWATCH		0x001e</span>

<span class="cp">#define SUBID_DVBC_EASYWATCH		0x002a</span>
<span class="cp">#define SUBID_DVBC_EASYWATCH_MK3	0x002c</span>
<span class="cp">#define SUBID_DVBC_KNC1			0x0020</span>
<span class="cp">#define SUBID_DVBC_KNC1_PLUS		0x0021</span>
<span class="cp">#define SUBID_DVBC_KNC1_MK3		0x0022</span>
<span class="cp">#define SUBID_DVBC_KNC1_TDA10024	0x0028</span>
<span class="cp">#define SUBID_DVBC_KNC1_PLUS_MK3	0x0023</span>
<span class="cp">#define SUBID_DVBC_CINERGY1200		0x1156</span>
<span class="cp">#define SUBID_DVBC_CINERGY1200_MK3	0x1176</span>

<span class="cp">#define SUBID_DVBT_EASYWATCH		0x003a</span>
<span class="cp">#define SUBID_DVBT_KNC1_PLUS		0x0031</span>
<span class="cp">#define SUBID_DVBT_KNC1			0x0030</span>
<span class="cp">#define SUBID_DVBT_CINERGY1200		0x1157</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">frontend_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span> <span class="n">saa</span> <span class="o">=</span> <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span> <span class="n">fe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Enable / PowerON Frontend */</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>

	<span class="cm">/* Wait for PowerON */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* additional setup necessary for the PLUS cards */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SUBID_DVBS_KNC1_PLUS</span>:
		<span class="k">case</span> <span class="n">SUBID_DVBC_KNC1_PLUS</span>:
		<span class="k">case</span> <span class="n">SUBID_DVBT_KNC1_PLUS</span>:
		<span class="k">case</span> <span class="n">SUBID_DVBC_EASYWATCH</span>:
		<span class="k">case</span> <span class="n">SUBID_DVBC_KNC1_PLUS_MK3</span>:
		<span class="k">case</span> <span class="n">SUBID_DVBS2_KNC1</span>:
		<span class="k">case</span> <span class="n">SUBID_DVBS2_KNC1_OEM</span>:
		<span class="k">case</span> <span class="n">SUBID_DVBS2_EASYWATCH</span>:
			<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">SUBID_DVBS_KNC1</span>:
		<span class="cm">/*</span>
<span class="cm">		 * maybe that setting is needed for other dvb-s cards as well,</span>
<span class="cm">		 * but so far it has been only confirmed for this type</span>
<span class="cm">		 */</span>
		<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">reinitialise_demod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">SUBID_DVBS_KNC1_PLUS</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBS_EASYWATCH_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1894</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0299_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinergy_1200s_1894_0010_config</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dvb_attach</span><span class="p">(</span><span class="n">tua6100_attach</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0299_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">typhoon_config</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">philips_su1278_ty_ci_tuner_set_params</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SUBID_DVBS_TV_STAR</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBS_TV_STAR_PLUS_X4</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBS_TV_STAR_CI</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBS_CYNERGY1200N</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBS_EASYWATCH</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBS_EASYWATCH_2</span>:
		<span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0299_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">philips_sd1878_config</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dvb_attach</span><span class="p">(</span><span class="n">dvb_pll_attach</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span>
				   <span class="n">DVB_PLL_PHILIPS_SD1878_TDA8261</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SUBID_DVBS_TYPHOON</span>:
		<span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0299_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">typhoon_config</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">philips_su1278_ty_ci_tuner_set_params</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SUBID_DVBS2_KNC1</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBS2_KNC1_OEM</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBS2_EASYWATCH</span>:
		<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">reinitialise_demod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stb0899_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">knc1_dvbs2_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">)))</span>
			<span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda8261_attach</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd1878c_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SUBID_DVBS_CINERGY1200</span>:
		<span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0299_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinergy_1200s_config</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">philips_su1278_ty_ci_tuner_set_params</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SUBID_DVBC_KNC1</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBC_KNC1_PLUS</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBC_CINERGY1200</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBC_EASYWATCH</span>:
		<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">reinitialise_demod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span> <span class="o">=</span> <span class="n">SAA7146_I2C_BUS_BIT_RATE_240</span><span class="p">;</span>
		<span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda10021_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">philips_cu1216_config</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span>
				     <span class="n">read_pwm</span><span class="p">(</span><span class="n">budget_av</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda10021_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">philips_cu1216_config_altaddress</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span>
					     <span class="n">read_pwm</span><span class="p">(</span><span class="n">budget_av</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">philips_cu1216_tuner_set_params</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SUBID_DVBC_EASYWATCH_MK3</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBC_CINERGY1200_MK3</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBC_KNC1_MK3</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBC_KNC1_TDA10024</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBC_KNC1_PLUS_MK3</span>:
		<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">reinitialise_demod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span> <span class="o">=</span> <span class="n">SAA7146_I2C_BUS_BIT_RATE_240</span><span class="p">;</span>
		<span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda10023_attach</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">philips_cu1216_tda10023_config</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span>
			<span class="n">read_pwm</span><span class="p">(</span><span class="n">budget_av</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">philips_cu1216_tuner_set_params</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SUBID_DVBT_EASYWATCH</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBT_KNC1</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBT_KNC1_PLUS</span>:
	<span class="k">case</span> <span class="n">SUBID_DVBT_CINERGY1200</span>:
		<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">reinitialise_demod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda10046_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">philips_tu1216_config</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">philips_tu1216_tuner_init</span><span class="p">;</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">philips_tu1216_tuner_set_params</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;A frontend driver was not found for device [%04x:%04x] subsystem [%04x:%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
		       <span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		       <span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
		       <span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="n">fe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_register_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_adapter</span><span class="p">,</span>
				  <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Frontend registration failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">);</span>
		<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">budget_av_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;dev: %p, budget_av: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">budget_av</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">MASK_10</span><span class="p">)</span>
		<span class="n">ttpci_budget_irq10_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_av_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;dev: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">has_saa7113</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

		<span class="n">saa7146_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="n">saa7146_vv_release</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">ci_present</span><span class="p">)</span>
		<span class="n">ciintf_deinit</span><span class="p">(</span><span class="n">budget_av</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvb_unregister_frontend</span><span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">);</span>
		<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ttpci_budget_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">budget_av</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define KNC1_INPUTS 2</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="n">knc1_inputs</span><span class="p">[</span><span class="n">KNC1_INPUTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Composite&quot;</span><span class="p">,</span> <span class="n">V4L2_INPUT_TYPE_TUNER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">V4L2_STD_PAL_BG</span> <span class="o">|</span> <span class="n">V4L2_STD_NTSC_M</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_IN_CAP_STD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;S-Video&quot;</span><span class="p">,</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">V4L2_STD_PAL_BG</span> <span class="o">|</span> <span class="n">V4L2_STD_NTSC_M</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_IN_CAP_STD</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;VIDIOC_ENUMINPUT %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">KNC1_INPUTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">knc1_inputs</span><span class="p">[</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_input</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">saa7146_fh</span> <span class="o">*</span><span class="p">)</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">cur_input</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;VIDIOC_G_INPUT %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">saa7146_fh</span> <span class="o">*</span><span class="p">)</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;VIDIOC_S_INPUT %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">saa7113_setinput</span><span class="p">(</span><span class="n">budget_av</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_ext_vv</span> <span class="n">vv_data</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_av_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7146_pci_extension_data</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_av</span> <span class="o">*</span><span class="n">budget_av</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;dev: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">budget_av</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_av</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">has_saa7113</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">ci_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span> <span class="o">=</span> <span class="n">budget_av</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ttpci_budget_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
				<span class="n">adapter_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">budget_av</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* knc1 initialization */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_STREAM_B</span><span class="p">,</span> <span class="mh">0x04000000</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_INIT</span><span class="p">,</span> <span class="mh">0x07000600</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="n">MASK_09</span> <span class="o">|</span> <span class="n">MASK_25</span> <span class="o">|</span> <span class="n">MASK_10</span> <span class="o">|</span> <span class="n">MASK_26</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7113_init</span><span class="p">(</span><span class="n">budget_av</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">has_saa7113</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">saa7146_vv_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vv_data</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* fixme: proper cleanup here */</span>
			<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;cannot init vv subsystem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vv_data</span><span class="p">.</span><span class="n">vid_ops</span><span class="p">.</span><span class="n">vidioc_enum_input</span> <span class="o">=</span> <span class="n">vidioc_enum_input</span><span class="p">;</span>
		<span class="n">vv_data</span><span class="p">.</span><span class="n">vid_ops</span><span class="p">.</span><span class="n">vidioc_g_input</span> <span class="o">=</span> <span class="n">vidioc_g_input</span><span class="p">;</span>
		<span class="n">vv_data</span><span class="p">.</span><span class="n">vid_ops</span><span class="p">.</span><span class="n">vidioc_s_input</span> <span class="o">=</span> <span class="n">vidioc_s_input</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">saa7146_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;knc1&quot;</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* fixme: proper cleanup here */</span>
			<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;cannot register capture v4l2 device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">saa7146_vv_release</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* beware: this modifies dev-&gt;vv ... */</span>
		<span class="n">saa7146_set_hps_source_and_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SAA7146_HPS_SOURCE_PORT_A</span><span class="p">,</span>
						<span class="n">SAA7146_HPS_SYNC_PORT_A</span><span class="p">);</span>

		<span class="n">saa7113_setinput</span><span class="p">(</span><span class="n">budget_av</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* fixme: find some sane values here... */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BT_V1</span><span class="p">,</span> <span class="mh">0x1c00101f</span><span class="p">);</span>

	<span class="n">mac</span> <span class="o">=</span> <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">proposed_mac</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_readregs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;KNC1-%d: Could not read MAC from KNC1 card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;KNC1-%d: MAC addr = %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">budget_av</span><span class="p">;</span>
	<span class="n">frontend_init</span><span class="p">(</span><span class="n">budget_av</span><span class="p">);</span>
	<span class="n">ciintf_init</span><span class="p">(</span><span class="n">budget_av</span><span class="p">);</span>

	<span class="n">ttpci_budget_init_hooks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_av</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_standard</span> <span class="n">standard</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PAL&quot;</span><span class="p">,.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">v_offset</span> <span class="o">=</span> <span class="mh">0x17</span><span class="p">,.</span><span class="n">v_field</span> <span class="o">=</span> <span class="mi">288</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">h_offset</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">,.</span><span class="n">h_pixels</span> <span class="o">=</span> <span class="mi">680</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">v_max_out</span> <span class="o">=</span> <span class="mi">576</span><span class="p">,.</span><span class="n">h_max_out</span> <span class="o">=</span> <span class="mi">768</span> <span class="p">},</span>

	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;NTSC&quot;</span><span class="p">,.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">v_offset</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">,.</span><span class="n">v_field</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">h_offset</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,.</span><span class="n">h_pixels</span> <span class="o">=</span> <span class="mi">708</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">v_max_out</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,.</span><span class="n">h_max_out</span> <span class="o">=</span> <span class="mi">640</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_ext_vv</span> <span class="n">vv_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="c1">// perhaps later: V4L2_CAP_VBI_CAPTURE, but that need tweaking with the saa7113</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">standard</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">num_stds</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">standard</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_extension</span> <span class="n">budget_extension</span><span class="p">;</span>

<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">knc1s</span><span class="p">,</span> <span class="s">&quot;KNC1 DVB-S&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1S</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">knc1s2</span><span class="p">,</span><span class="s">&quot;KNC1 DVB-S2&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1S2</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">sates2</span><span class="p">,</span><span class="s">&quot;Satelco EasyWatch DVB-S2&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1S2</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">knc1c</span><span class="p">,</span> <span class="s">&quot;KNC1 DVB-C&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1C</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">knc1t</span><span class="p">,</span> <span class="s">&quot;KNC1 DVB-T&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1T</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">kncxs</span><span class="p">,</span> <span class="s">&quot;KNC TV STAR DVB-S&quot;</span><span class="p">,</span> <span class="n">BUDGET_TVSTAR</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">satewpls</span><span class="p">,</span> <span class="s">&quot;Satelco EasyWatch DVB-S light&quot;</span><span class="p">,</span> <span class="n">BUDGET_TVSTAR</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">satewpls1</span><span class="p">,</span> <span class="s">&quot;Satelco EasyWatch DVB-S light&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1S</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">satewps</span><span class="p">,</span> <span class="s">&quot;Satelco EasyWatch DVB-S&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1S</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">satewplc</span><span class="p">,</span> <span class="s">&quot;Satelco EasyWatch DVB-C&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1CP</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">satewcmk3</span><span class="p">,</span> <span class="s">&quot;Satelco EasyWatch DVB-C MK3&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1C_MK3</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">satewt</span><span class="p">,</span> <span class="s">&quot;Satelco EasyWatch DVB-T&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1T</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">knc1sp</span><span class="p">,</span> <span class="s">&quot;KNC1 DVB-S Plus&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1SP</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">knc1spx4</span><span class="p">,</span> <span class="s">&quot;KNC1 DVB-S Plus X4&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1SP</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">knc1cp</span><span class="p">,</span> <span class="s">&quot;KNC1 DVB-C Plus&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1CP</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">knc1cmk3</span><span class="p">,</span> <span class="s">&quot;KNC1 DVB-C MK3&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1C_MK3</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">knc1ctda10024</span><span class="p">,</span> <span class="s">&quot;KNC1 DVB-C TDA10024&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1C_TDA10024</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">knc1cpmk3</span><span class="p">,</span> <span class="s">&quot;KNC1 DVB-C Plus MK3&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1CP_MK3</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">knc1tp</span><span class="p">,</span> <span class="s">&quot;KNC1 DVB-T Plus&quot;</span><span class="p">,</span> <span class="n">BUDGET_KNC1TP</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">cin1200s</span><span class="p">,</span> <span class="s">&quot;TerraTec Cinergy 1200 DVB-S&quot;</span><span class="p">,</span> <span class="n">BUDGET_CIN1200S</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">cin1200sn</span><span class="p">,</span> <span class="s">&quot;TerraTec Cinergy 1200 DVB-S&quot;</span><span class="p">,</span> <span class="n">BUDGET_CIN1200S</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">cin1200c</span><span class="p">,</span> <span class="s">&quot;Terratec Cinergy 1200 DVB-C&quot;</span><span class="p">,</span> <span class="n">BUDGET_CIN1200C</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">cin1200cmk3</span><span class="p">,</span> <span class="s">&quot;Terratec Cinergy 1200 DVB-C MK3&quot;</span><span class="p">,</span> <span class="n">BUDGET_CIN1200C_MK3</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">cin1200t</span><span class="p">,</span> <span class="s">&quot;Terratec Cinergy 1200 DVB-T&quot;</span><span class="p">,</span> <span class="n">BUDGET_CIN1200T</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1s</span><span class="p">,</span> <span class="mh">0x1131</span><span class="p">,</span> <span class="mh">0x4f56</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1s</span><span class="p">,</span> <span class="mh">0x1131</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1s</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1sp</span><span class="p">,</span> <span class="mh">0x1131</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1sp</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">kncxs</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1spx4</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">kncxs</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1s2</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1s2</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0019</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">sates2</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x001d</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">satewpls</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x001e</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">satewpls1</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x001a</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">satewps</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x001b</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">satewplc</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x002a</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">satewcmk3</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x002c</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">satewt</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x003a</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1c</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1cp</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1cmk3</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1ctda10024</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0028</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1cpmk3</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1t</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">knc1tp</span><span class="p">,</span> <span class="mh">0x1894</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">cin1200s</span><span class="p">,</span> <span class="mh">0x153b</span><span class="p">,</span> <span class="mh">0x1154</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">cin1200sn</span><span class="p">,</span> <span class="mh">0x153b</span><span class="p">,</span> <span class="mh">0x1155</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">cin1200c</span><span class="p">,</span> <span class="mh">0x153b</span><span class="p">,</span> <span class="mh">0x1156</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">cin1200cmk3</span><span class="p">,</span> <span class="mh">0x153b</span><span class="p">,</span> <span class="mh">0x1176</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">cin1200t</span><span class="p">,</span> <span class="mh">0x153b</span><span class="p">,</span> <span class="mh">0x1157</span><span class="p">),</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_extension</span> <span class="n">budget_extension</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;budget_av&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SAA7146_USE_I2C_IRQ</span><span class="p">,</span>

	<span class="p">.</span><span class="n">pci_tbl</span> <span class="o">=</span> <span class="n">pci_tbl</span><span class="p">,</span>

	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span> <span class="n">budget_av_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span> <span class="o">=</span> <span class="n">budget_av_detach</span><span class="p">,</span>

	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">MASK_10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_func</span> <span class="o">=</span> <span class="n">budget_av_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">budget_av_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">saa7146_register_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_extension</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">budget_av_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">saa7146_unregister_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_extension</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">budget_av_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">budget_av_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ralph Metzler, Marcus Metzler, Michael Hunold, others&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;driver for the SAA7146 based so-called &quot;</span>
		   <span class="s">&quot;budget PCI DVB w/ analog input and CI-module (e.g. the KNC cards)&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
