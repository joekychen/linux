<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › ttpci › budget-ci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>budget-ci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * budget-ci.c: driver for the SAA7146 based Budget DVB cards</span>
<span class="cm"> *</span>
<span class="cm"> * Compiled from various sources by Michael Hunold &lt;michael@mihu.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *     msp430 IR support contributed by Jack Thomasson &lt;jkt@Helius.COM&gt;</span>
<span class="cm"> *     partially based on the Siemens DVB driver by Ralph+Marcus Metzler</span>
<span class="cm"> *</span>
<span class="cm"> * CI interface support (c) 2004 Andrew de Quincey &lt;adq_dvb@lidskialf.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> * Or, point your browser to http://www.gnu.org/copyleft/gpl.html</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * the project&#39;s page is at http://www.linuxtv.org/</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;media/rc-core.h&gt;</span>

<span class="cp">#include &quot;budget.h&quot;</span>

<span class="cp">#include &quot;dvb_ca_en50221.h&quot;</span>
<span class="cp">#include &quot;stv0299.h&quot;</span>
<span class="cp">#include &quot;stv0297.h&quot;</span>
<span class="cp">#include &quot;tda1004x.h&quot;</span>
<span class="cp">#include &quot;stb0899_drv.h&quot;</span>
<span class="cp">#include &quot;stb0899_reg.h&quot;</span>
<span class="cp">#include &quot;stb0899_cfg.h&quot;</span>
<span class="cp">#include &quot;stb6100.h&quot;</span>
<span class="cp">#include &quot;stb6100_cfg.h&quot;</span>
<span class="cp">#include &quot;lnbp21.h&quot;</span>
<span class="cp">#include &quot;bsbe1.h&quot;</span>
<span class="cp">#include &quot;bsru6.h&quot;</span>
<span class="cp">#include &quot;tda1002x.h&quot;</span>
<span class="cp">#include &quot;tda827x.h&quot;</span>
<span class="cp">#include &quot;bsbe1-d01a.h&quot;</span>

<span class="cp">#define MODULE_NAME &quot;budget_ci&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Regarding DEBIADDR_IR:</span>
<span class="cm"> * Some CI modules hang if random addresses are read.</span>
<span class="cm"> * Using address 0x4000 for the IR read means that we</span>
<span class="cm"> * use the same address as for CI version, which should</span>
<span class="cm"> * be a safe default.</span>
<span class="cm"> */</span>
<span class="cp">#define DEBIADDR_IR		0x4000</span>
<span class="cp">#define DEBIADDR_CICONTROL	0x0000</span>
<span class="cp">#define DEBIADDR_CIVERSION	0x4000</span>
<span class="cp">#define DEBIADDR_IO		0x1000</span>
<span class="cp">#define DEBIADDR_ATTR		0x3000</span>

<span class="cp">#define CICONTROL_RESET		0x01</span>
<span class="cp">#define CICONTROL_ENABLETS	0x02</span>
<span class="cp">#define CICONTROL_CAMDETECT	0x08</span>

<span class="cp">#define DEBICICTL		0x00420000</span>
<span class="cp">#define DEBICICAM		0x02420000</span>

<span class="cp">#define SLOTSTATUS_NONE		1</span>
<span class="cp">#define SLOTSTATUS_PRESENT	2</span>
<span class="cp">#define SLOTSTATUS_RESET	4</span>
<span class="cp">#define SLOTSTATUS_READY	8</span>
<span class="cp">#define SLOTSTATUS_OCCUPIED	(SLOTSTATUS_PRESENT|SLOTSTATUS_RESET|SLOTSTATUS_READY)</span>

<span class="cm">/* RC5 device wildcard */</span>
<span class="cp">#define IR_DEVICE_ANY		255</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rc5_device</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rc5_device</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rc5_device</span><span class="p">,</span> <span class="s">&quot;only IR commands to given RC5 device (device = 0 - 31, any device = 255, default: autodetect)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ir_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ir_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ir_debug</span><span class="p">,</span> <span class="s">&quot;enable debugging information for IR decoding&quot;</span><span class="p">);</span>

<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">budget_ci_ir</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">msp430_irq_tasklet</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">72</span><span class="p">];</span> <span class="cm">/* 40 + 32 for (struct saa7146_dev).name */</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc5_device</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ir_key</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">have_command</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">full_rc5</span><span class="p">;</span>		<span class="cm">/* Outputs a full RC5 code */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">budget_ci</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget</span> <span class="n">budget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">ciintf_irq_tasklet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ci_irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="n">ca</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">budget_ci_ir</span> <span class="n">ir</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tuner_pll_address</span><span class="p">;</span> <span class="cm">/* used for philips_tdm1316l configs */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msp430_ir_interrupt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">command</span> <span class="o">=</span> <span class="n">ttpci_budget_debiread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">DEBIADDR_IR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The msp430 chip can generate two different bytes, command and device</span>
<span class="cm">	 *</span>
<span class="cm">	 * type1: X1CCCCCC, C = command bits (0 - 63)</span>
<span class="cm">	 * type2: X0TDDDDD, D = device bits (0 - 31), T = RC5 toggle bit</span>
<span class="cm">	 *</span>
<span class="cm">	 * Each signal from the remote control can generate one or more command</span>
<span class="cm">	 * bytes and one or more device bytes. For the repeated bytes, the</span>
<span class="cm">	 * highest bit (X) is set. The first command byte is always generated</span>
<span class="cm">	 * before the first device byte. Other than that, no specific order</span>
<span class="cm">	 * seems to apply. To make life interesting, bytes can also be lost.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Only when we have a command and device byte, a keypress is</span>
<span class="cm">	 * generated.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir_debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;budget_ci: received byte 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>

	<span class="cm">/* Remove repeat bit, we use every command */</span>
	<span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

	<span class="cm">/* Is this a RC5 command byte? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">have_command</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">ir_key</span> <span class="o">=</span> <span class="n">command</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* It&#39;s a RC5 device byte */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">have_command</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">have_command</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">rc5_device</span> <span class="o">!=</span> <span class="n">IR_DEVICE_ANY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">rc5_device</span> <span class="o">!=</span> <span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">full_rc5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc_keydown</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">rc5_device</span> <span class="o">&lt;&lt;</span><span class="mi">8</span> <span class="o">|</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">ir_key</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: We should generate complete scancodes for all devices */</span>
	<span class="n">rc_keydown</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">ir_key</span><span class="p">,</span> <span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msp430_ir_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">rc_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;budget_ci: IR interface initialisation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
		 <span class="s">&quot;Budget-CI dvb ir receiver %s&quot;</span><span class="p">,</span> <span class="n">saa</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">phys</span><span class="p">),</span>
		 <span class="s">&quot;pci-%s/ir0&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_phys</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_PCI</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc5_device</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">rc5_device</span> <span class="o">=</span> <span class="n">IR_DEVICE_ANY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">rc5_device</span> <span class="o">=</span> <span class="n">rc5_device</span><span class="p">;</span>

	<span class="cm">/* Select keymap and address */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x100c</span>:
	<span class="k">case</span> <span class="mh">0x100f</span>:
	<span class="k">case</span> <span class="mh">0x1011</span>:
	<span class="k">case</span> <span class="mh">0x1012</span>:
		<span class="cm">/* The hauppauge keymap is a superset of these remotes */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">RC_MAP_HAUPPAUGE</span><span class="p">;</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">full_rc5</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc5_device</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">rc5_device</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1010</span>:
	<span class="k">case</span> <span class="mh">0x1017</span>:
	<span class="k">case</span> <span class="mh">0x1019</span>:
	<span class="k">case</span> <span class="mh">0x101a</span>:
	<span class="k">case</span> <span class="mh">0x101b</span>:
		<span class="cm">/* for the Technotrend 1500 bundled remote */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">RC_MAP_TT_1500</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* unknown remote */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">RC_MAP_BUDGET_CI_OLD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">full_rc5</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">scanmask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">rc_register_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;budget_ci: could not init driver for IR device (code %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="n">rc_free_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">msp430_irq_tasklet</span><span class="p">,</span> <span class="n">msp430_ir_interrupt</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">budget_ci</span><span class="p">);</span>

	<span class="n">SAA7146_IER_ENABLE</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MASK_06</span><span class="p">);</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_IRQHI</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msp430_ir_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">SAA7146_IER_DISABLE</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MASK_06</span><span class="p">);</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_INPUT</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">msp430_irq_tasklet</span><span class="p">);</span>

	<span class="n">rc_unregister_device</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_read_attribute_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ttpci_budget_debiread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICAM</span><span class="p">,</span>
				     <span class="n">DEBIADDR_ATTR</span> <span class="o">|</span> <span class="p">(</span><span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_write_attribute_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICAM</span><span class="p">,</span>
				      <span class="n">DEBIADDR_ATTR</span> <span class="o">|</span> <span class="p">(</span><span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_read_cam_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ttpci_budget_debiread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICAM</span><span class="p">,</span>
				     <span class="n">DEBIADDR_IO</span> <span class="o">|</span> <span class="p">(</span><span class="n">address</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_write_cam_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">address</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICAM</span><span class="p">,</span>
				      <span class="n">DEBIADDR_IO</span> <span class="o">|</span> <span class="p">(</span><span class="n">address</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ci_irq</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>trigger on RISING edge during reset so we know when READY is re-asserted</p></td><td class="code"><div class="highlight"><pre>		<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7146_GPIO_IRQHI</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_RESET</span><span class="p">;</span>
	<span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICTL</span><span class="p">,</span> <span class="n">DEBIADDR_CICONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICTL</span><span class="p">,</span> <span class="n">DEBIADDR_CICONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="n">CICONTROL_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>
	<span class="n">ttpci_budget_set_video_port</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">BUDGET_VIDEO_PORTB</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_slot_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>
	<span class="n">ttpci_budget_set_video_port</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">BUDGET_VIDEO_PORTB</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_slot_ts_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ttpci_budget_debiread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICTL</span><span class="p">,</span> <span class="n">DEBIADDR_CICONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICTL</span><span class="p">,</span> <span class="n">DEBIADDR_CICONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="n">tmp</span> <span class="o">|</span> <span class="n">CICONTROL_ENABLETS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ttpci_budget_set_video_port</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">BUDGET_VIDEO_PORTA</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ciintf_interrupt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>ensure we don't get spurious IRQs during initialisation</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">ci_present</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>read the CAM status</p></td><td class="code"><div class="highlight"><pre>	<span class="n">flags</span> <span class="o">=</span> <span class="n">ttpci_budget_debiread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICTL</span><span class="p">,</span> <span class="n">DEBIADDR_CICONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CICONTROL_CAMDETECT</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>GPIO should be set to trigger on falling edge if a CAM is present</p></td><td class="code"><div class="highlight"><pre>		<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7146_GPIO_IRQLO</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">&amp;</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>CAM insertion IRQ</p></td><td class="code"><div class="highlight"><pre>			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_PRESENT</span><span class="p">;</span>
			<span class="n">dvb_ca_en50221_camchange_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						     <span class="n">DVB_CA_EN50221_CAMCHANGE_INSERTED</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">&amp;</span> <span class="n">SLOTSTATUS_RESET</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>CAM ready (reset completed)</p></td><td class="code"><div class="highlight"><pre>			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_READY</span><span class="p">;</span>
			<span class="n">dvb_ca_en50221_camready_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">&amp;</span> <span class="n">SLOTSTATUS_READY</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>FR/DA IRQ</p></td><td class="code"><div class="highlight"><pre>			<span class="n">dvb_ca_en50221_frda_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>trigger on rising edge if a CAM is not present - when a CAM is inserted, we
only want to get the IRQ when it sets READY. If we trigger on the falling edge,
the CAM might not actually be ready yet.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7146_GPIO_IRQHI</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>generate a CAM removal IRQ if we haven't already</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">&amp;</span> <span class="n">SLOTSTATUS_OCCUPIED</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>CAM removal IRQ</p></td><td class="code"><div class="highlight"><pre>			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">;</span>
			<span class="n">dvb_ca_en50221_camchange_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						     <span class="n">DVB_CA_EN50221_CAMCHANGE_REMOVED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_poll_slot_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>ensure we don't get spurious IRQs during initialisation</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">ci_present</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>read the CAM status</p></td><td class="code"><div class="highlight"><pre>	<span class="n">flags</span> <span class="o">=</span> <span class="n">ttpci_budget_debiread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICTL</span><span class="p">,</span> <span class="n">DEBIADDR_CICONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CICONTROL_CAMDETECT</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>mark it as present if it wasn't before</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">&amp;</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_PRESENT</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>during a RESET, we check if we can read from IO memory to see when CAM is ready</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">&amp;</span> <span class="n">SLOTSTATUS_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ciintf_read_attribute_mem</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1d</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_READY</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">!=</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">&amp;</span> <span class="n">SLOTSTATUS_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">DVB_CA_EN50221_POLL_CAM_PRESENT</span> <span class="o">|</span> <span class="n">DVB_CA_EN50221_POLL_CAM_READY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">DVB_CA_EN50221_POLL_CAM_PRESENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ciintf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ci_version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ca_flags</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>enable DEBI pins</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_27</span> <span class="o">|</span> <span class="n">MASK_11</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>test if it is there</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ci_version</span> <span class="o">=</span> <span class="n">ttpci_budget_debiread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICTL</span><span class="p">,</span> <span class="n">DEBIADDR_CIVERSION</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ci_version</span> <span class="o">&amp;</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>determine whether a CAM is present or not</p></td><td class="code"><div class="highlight"><pre>	<span class="n">flags</span> <span class="o">=</span> <span class="n">ttpci_budget_debiread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICTL</span><span class="p">,</span> <span class="n">DEBIADDR_CICONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CICONTROL_CAMDETECT</span><span class="p">)</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">=</span> <span class="n">SLOTSTATUS_PRESENT</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>version 0xa2 of the CI firmware doesn't generate interrupts</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ci_version</span> <span class="o">==</span> <span class="mh">0xa2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ca_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ci_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ca_flags</span> <span class="o">=</span> <span class="n">DVB_CA_EN50221_FLAG_IRQ_CAMCHANGE</span> <span class="o">|</span>
				<span class="n">DVB_CA_EN50221_FLAG_IRQ_FR</span> <span class="o">|</span>
				<span class="n">DVB_CA_EN50221_FLAG_IRQ_DA</span><span class="p">;</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ci_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>register CI interface</p></td><td class="code"><div class="highlight"><pre>	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">read_attribute_mem</span> <span class="o">=</span> <span class="n">ciintf_read_attribute_mem</span><span class="p">;</span>
	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">write_attribute_mem</span> <span class="o">=</span> <span class="n">ciintf_write_attribute_mem</span><span class="p">;</span>
	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">read_cam_control</span> <span class="o">=</span> <span class="n">ciintf_read_cam_control</span><span class="p">;</span>
	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">write_cam_control</span> <span class="o">=</span> <span class="n">ciintf_write_cam_control</span><span class="p">;</span>
	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">ciintf_slot_reset</span><span class="p">;</span>
	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">slot_shutdown</span> <span class="o">=</span> <span class="n">ciintf_slot_shutdown</span><span class="p">;</span>
	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">slot_ts_enable</span> <span class="o">=</span> <span class="n">ciintf_slot_ts_enable</span><span class="p">;</span>
	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">poll_slot_status</span> <span class="o">=</span> <span class="n">ciintf_poll_slot_status</span><span class="p">;</span>
	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_adapter</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span>
					  <span class="n">ca_flags</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;budget_ci: CI interface detected, but initialisation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Setup CI slot IRQ</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ci_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ciintf_irq_tasklet</span><span class="p">,</span> <span class="n">ciintf_interrupt</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">budget_ci</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">!=</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7146_GPIO_IRQLO</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7146_GPIO_IRQHI</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SAA7146_IER_ENABLE</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MASK_03</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>enable interface</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICTL</span><span class="p">,</span> <span class="n">DEBIADDR_CICONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="n">CICONTROL_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>success!</p></td><td class="code"><div class="highlight"><pre>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;budget_ci: CI interface initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">ci_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>forge a fake CI IRQ so the CAM state is setup correctly</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ci_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">DVB_CA_EN50221_CAMCHANGE_REMOVED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">slot_status</span> <span class="o">!=</span> <span class="n">SLOTSTATUS_NONE</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="n">DVB_CA_EN50221_CAMCHANGE_INSERTED</span><span class="p">;</span>
		<span class="n">dvb_ca_en50221_camchange_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_27</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ciintf_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>disable CI interrupts</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ci_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAA7146_IER_DISABLE</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MASK_03</span><span class="p">);</span>
		<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7146_GPIO_INPUT</span><span class="p">);</span>
		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ciintf_irq_tasklet</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>reset interface</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICTL</span><span class="p">,</span> <span class="n">DEBIADDR_CICONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBICICTL</span><span class="p">,</span> <span class="n">DEBIADDR_CICONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="n">CICONTROL_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>disable TS data stream to CI interface</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAA7146_GPIO_INPUT</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>release the CA device</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dvb_ca_en50221_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>disable DEBI pins</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_27</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">budget_ci_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;dev: %p, budget_ci: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">budget_ci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">MASK_06</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">msp430_irq_tasklet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">MASK_10</span><span class="p">)</span>
		<span class="n">ttpci_budget_irq10_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">MASK_03</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">ci_present</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ci_irq</span><span class="p">))</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">ciintf_irq_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">philips_su1278_tt_inittab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span>
	<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>
	<span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span>
	<span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span>
	<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span>
	<span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span>
	<span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span>
	<span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span>
	<span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span>
	<span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span>
	<span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span>
	<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span>
	<span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span>
	<span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span>
	<span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span>
	<span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span>
	<span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span>
	<span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span>
	<span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span>
	<span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">philips_su1278_tt_set_symbol_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">srate</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&gt;=</span> <span class="mi">10000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">);</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">);</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">);</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">);</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">);</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">);</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">);</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">);</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
		<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">);</span>

	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">philips_su1278_tt_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">950000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="mi">2150000</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="p">(</span><span class="mi">500</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">500</span><span class="p">;</span>	<span class="cm">/* round correctly */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">((</span><span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0x18000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">&lt;</span> <span class="mi">4000000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">1250000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">1550000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">2050000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">2150000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0xC0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0299_config</span> <span class="n">philips_su1278_tt_config</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inittab</span> <span class="o">=</span> <span class="n">philips_su1278_tt_inittab</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">64000000UL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">skip_reinit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock_output</span> <span class="o">=</span> <span class="n">STV0299_LOCKOUTPUT_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">volt13_op0_op1</span> <span class="o">=</span> <span class="n">STV0299_VOLT13_OP1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_symbol_rate</span> <span class="o">=</span> <span class="n">philips_su1278_tt_set_symbol_rate</span><span class="p">,</span>
<span class="p">};</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">philips_tdm1316l_tuner_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">td1316_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xab</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">disable_mc44BC374c</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x68</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">tuner_msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">tuner_pll_address</span><span class="p">,.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">td1316_init</span><span class="p">,.</span><span class="n">len</span> <span class="o">=</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">td1316_init</span><span class="p">)</span> <span class="p">};</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>setup PLL configuration</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>disable the mc44BC374c (do not check for errors)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tuner_msg</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x65</span><span class="p">;</span>
	<span class="n">tuner_msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">disable_mc44BC374c</span><span class="p">;</span>
	<span class="n">tuner_msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disable_mc44BC374c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">philips_tdm1316l_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tuner_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">tuner_msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">tuner_pll_address</span><span class="p">,.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">tuner_buf</span><span class="p">,.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tuner_buf</span><span class="p">)</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">tuner_frequency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">band</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">filter</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>determine charge pump</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tuner_frequency</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">36130000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">87000000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">130000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">160000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">200000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">290000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">420000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">480000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">620000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">830000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">895000000</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>determine band</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">49000000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">159000000</span><span class="p">)</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">444000000</span><span class="p">)</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">861000000</span><span class="p">)</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>setup PLL filter and TDA9889</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6000000</span>:
		<span class="n">tda1004x_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="n">filter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">7000000</span>:
		<span class="n">tda1004x_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">filter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8000000</span>:
		<span class="n">tda1004x_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="n">filter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>calculate divisor
((36130000+((1000000/6)/2)) + Finput)/(1000000/6)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tuner_frequency</span> <span class="o">=</span> <span class="p">(((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">217280</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>setup tuner buffer</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tuner_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tuner_frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tuner_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tuner_frequency</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tuner_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xca</span><span class="p">;</span>
	<span class="n">tuner_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">band</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">philips_tdm1316l_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
					     <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">fw</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">request_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda1004x_config</span> <span class="n">philips_tdm1316l_config</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert_oclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xtal_freq</span> <span class="o">=</span> <span class="n">TDA10046_XTAL_4M</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc_config</span> <span class="o">=</span> <span class="n">TDA10046_AGC_DEFAULT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">if_freq</span> <span class="o">=</span> <span class="n">TDA10046_FREQ_3617</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_firmware</span> <span class="o">=</span> <span class="n">philips_tdm1316l_request_firmware</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda1004x_config</span> <span class="n">philips_tdm1316l_config_invert</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert_oclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xtal_freq</span> <span class="o">=</span> <span class="n">TDA10046_XTAL_4M</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc_config</span> <span class="o">=</span> <span class="n">TDA10046_AGC_DEFAULT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">if_freq</span> <span class="o">=</span> <span class="n">TDA10046_FREQ_3617</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_firmware</span> <span class="o">=</span> <span class="n">philips_tdm1316l_request_firmware</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvbc_philips_tdm1316l_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tuner_buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">tuner_msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">tuner_pll_address</span><span class="p">,</span>
				    <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">tuner_buf</span><span class="p">,</span>
				    <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tuner_buf</span><span class="p">)</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">tuner_frequency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">band</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">filter</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>determine charge pump</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tuner_frequency</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">36125000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">87000000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">130000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">160000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">200000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">290000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">420000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">480000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">620000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">830000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tuner_frequency</span> <span class="o">&lt;</span> <span class="mi">895000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>assume PLL filter should always be 8MHz for the moment.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">filter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>calculate divisor</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tuner_frequency</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">36125000</span> <span class="o">+</span> <span class="p">(</span><span class="mi">62500</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">62500</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>setup tuner buffer</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tuner_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tuner_frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tuner_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tuner_frequency</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tuner_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xc8</span><span class="p">;</span>
	<span class="n">tuner_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">filter</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">band</span><span class="p">;</span>
	<span class="n">tuner_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tuner_msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">dvbc_philips_tdm1316l_inittab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span>
	<span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span>
	<span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span>
	<span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span>
	<span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x44</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span>
	<span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span>
	<span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span>
	<span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span>
	<span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span>
	<span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span>
	<span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span>
	<span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
	<span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span>
	<span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span>
	<span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span>
	<span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span>
	<span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span>
	<span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span>
	<span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span>
	<span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span>
	<span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0297_config</span> <span class="n">dvbc_philips_tdm1316l_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inittab</span> <span class="o">=</span> <span class="n">dvbc_philips_tdm1316l_inittab</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_during_read</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda10023_config</span> <span class="n">tda10023_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xtal</span> <span class="o">=</span> <span class="mi">16000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pll_m</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pll_p</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pll_n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deltaf</span> <span class="o">=</span> <span class="mh">0xa511</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda827x_config</span> <span class="n">tda827x_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* TT S2-3200 DVB-S (STB0899) Inittab */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stb0899_s1_reg</span> <span class="n">tt3200_stb0899_s1_init_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">{</span> <span class="n">STB0899_DEV_ID</span>		<span class="p">,</span> <span class="mh">0x81</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISCNTRL1</span>		<span class="p">,</span> <span class="mh">0x32</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISCNTRL2</span>     	<span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISRX_ST0</span>     	<span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISRX_ST1</span>     	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISPARITY</span>     	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISSTATUS</span>		<span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISF22</span>        	<span class="p">,</span> <span class="mh">0x8c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISF22RX</span>      	<span class="p">,</span> <span class="mh">0x9a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYSREG</span>		<span class="p">,</span> <span class="mh">0x0b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ACRPRESC</span>      	<span class="p">,</span> <span class="mh">0x11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ACRDIV1</span>       	<span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ACRDIV2</span>       	<span class="p">,</span> <span class="mh">0x05</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DACR1</span>         	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DACR2</span>         	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_OUTCFG</span>        	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MODECFG</span>       	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQSTATUS_3</span>		<span class="p">,</span> <span class="mh">0x30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQSTATUS_2</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQSTATUS_1</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQSTATUS_0</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQMSK_3</span>      	<span class="p">,</span> <span class="mh">0xf3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQMSK_2</span>      	<span class="p">,</span> <span class="mh">0xfc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQMSK_1</span>      	<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQMSK_0</span>		<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQCFG</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_I2CCFG</span>        	<span class="p">,</span> <span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_I2CRPT</span>        	<span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span> <span class="cm">/* 12k Pullup, Repeater=16, Stop=disabled */</span>
	<span class="p">{</span> <span class="n">STB0899_IOPVALUE5</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IOPVALUE4</span>		<span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IOPVALUE3</span>		<span class="p">,</span> <span class="mh">0xc9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IOPVALUE2</span>		<span class="p">,</span> <span class="mh">0x90</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IOPVALUE1</span>		<span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IOPVALUE0</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO00CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO01CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO02CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO03CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO04CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO05CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO06CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO07CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO08CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO09CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO10CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO11CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO12CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO13CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO14CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO15CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO16CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO17CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO18CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO19CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO20CFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SDATCFG</span>       	<span class="p">,</span> <span class="mh">0xb8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SCLTCFG</span>       	<span class="p">,</span> <span class="mh">0xba</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGCRFCFG</span>      	<span class="p">,</span> <span class="mh">0x1c</span> <span class="p">},</span> <span class="cm">/* 0x11 */</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO22</span>        	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span> <span class="cm">/* AGCBB2CFG */</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO21</span>        	<span class="p">,</span> <span class="mh">0x91</span> <span class="p">},</span> <span class="cm">/* AGCBB1CFG */</span>
	<span class="p">{</span> <span class="n">STB0899_DIRCLKCFG</span>     	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CLKOUT27CFG</span>   	<span class="p">,</span> <span class="mh">0x7e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_STDBYCFG</span>      	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CS0CFG</span>        	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CS1CFG</span>        	<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISEQCOCFG</span>    	<span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO32CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO33CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO34CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO35CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO36CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO37CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO38CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO39CFG</span>		<span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_NCOARSE</span>       	<span class="p">,</span> <span class="mh">0x15</span> <span class="p">},</span> <span class="cm">/* 0x15 = 27 Mhz Clock, F/3 = 198MHz, F/6 = 99MHz */</span>
	<span class="p">{</span> <span class="n">STB0899_SYNTCTRL</span>      	<span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span> <span class="cm">/* 0x00 = CLK from CLKI, 0x02 = CLK from XTALI */</span>
	<span class="p">{</span> <span class="n">STB0899_FILTCTRL</span>      	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYSCTRL</span>       	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_STOPCLK1</span>      	<span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_STOPCLK2</span>      	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_INTBUFSTATUS</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_INTBUFCTRL</span>    	<span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xffff</span>			<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stb0899_s1_reg</span> <span class="n">tt3200_stb0899_s1_init_3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">STB0899_DEMOD</span>         	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RCOMPC</span>        	<span class="p">,</span> <span class="mh">0xc9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC1CN</span>        	<span class="p">,</span> <span class="mh">0x41</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC1REF</span>       	<span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RTC</span>			<span class="p">,</span> <span class="mh">0x7a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TMGCFG</span>        	<span class="p">,</span> <span class="mh">0x4e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC2REF</span>       	<span class="p">,</span> <span class="mh">0x34</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TLSR</span>          	<span class="p">,</span> <span class="mh">0x84</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFD</span>           	<span class="p">,</span> <span class="mh">0xc7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ACLC</span>			<span class="p">,</span> <span class="mh">0x87</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BCLC</span>          	<span class="p">,</span> <span class="mh">0x94</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQON</span>          	<span class="p">,</span> <span class="mh">0x41</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_LDT</span>           	<span class="p">,</span> <span class="mh">0xdd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_LDT2</span>          	<span class="p">,</span> <span class="mh">0xc9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUALREF</span>      	<span class="p">,</span> <span class="mh">0xb4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TMGRAMP</span>       	<span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TMGTHD</span>        	<span class="p">,</span> <span class="mh">0x30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IDCCOMP</span>		<span class="p">,</span> <span class="mh">0xfb</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_QDCCOMP</span>		<span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_POWERI</span>		<span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_POWERQ</span>		<span class="p">,</span> <span class="mh">0x3d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RCOMP</span>			<span class="p">,</span> <span class="mh">0x81</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGCIQIN</span>		<span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC2I1</span>		<span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC2I2</span>		<span class="p">,</span> <span class="mh">0xf5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TLIR</span>			<span class="p">,</span> <span class="mh">0x25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RTF</span>			<span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DSTATUS</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_LDI</span>			<span class="p">,</span> <span class="mh">0xca</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFRM</span>			<span class="p">,</span> <span class="mh">0xf1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFRL</span>			<span class="p">,</span> <span class="mh">0xf3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_NIRM</span>			<span class="p">,</span> <span class="mh">0x2a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_NIRL</span>			<span class="p">,</span> <span class="mh">0x05</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ISYMB</span>			<span class="p">,</span> <span class="mh">0x17</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_QSYMB</span>			<span class="p">,</span> <span class="mh">0xfa</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRH</span>          	<span class="p">,</span> <span class="mh">0x2f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRM</span>          	<span class="p">,</span> <span class="mh">0x68</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRL</span>          	<span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRUPH</span>        	<span class="p">,</span> <span class="mh">0x2f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRUPM</span>        	<span class="p">,</span> <span class="mh">0x68</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRUPL</span>        	<span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI1</span>		<span class="p">,</span> <span class="mh">0xfd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ1</span>		<span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI2</span>		<span class="p">,</span> <span class="mh">0x0f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ2</span>		<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI3</span>		<span class="p">,</span> <span class="mh">0xdf</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ3</span>		<span class="p">,</span> <span class="mh">0xfa</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI4</span>		<span class="p">,</span> <span class="mh">0x37</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ4</span>		<span class="p">,</span> <span class="mh">0x0d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI5</span>		<span class="p">,</span> <span class="mh">0xbd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ5</span>		<span class="p">,</span> <span class="mh">0xf7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DSTATUS2</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VSTATUS</span>       	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VERROR</span>		<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IQSWAP</span>		<span class="p">,</span> <span class="mh">0x2a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT1M</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT1L</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT2M</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT2L</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT3M</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT3L</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_FECAUTO1</span>      	<span class="p">,</span> <span class="mh">0x06</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_FECM</span>			<span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH12</span>         	<span class="p">,</span> <span class="mh">0xf0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH23</span>         	<span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH34</span>			<span class="p">,</span> <span class="mh">0x78</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH56</span>         	<span class="p">,</span> <span class="mh">0x4e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH67</span>         	<span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH78</span>         	<span class="p">,</span> <span class="mh">0x38</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PRVIT</span>         	<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VITSYNC</span>       	<span class="p">,</span> <span class="mh">0x19</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RSULC</span>         	<span class="p">,</span> <span class="mh">0xb1</span> <span class="p">},</span> <span class="cm">/* DVB = 0xb1, DSS = 0xa1 */</span>
	<span class="p">{</span> <span class="n">STB0899_TSULC</span>         	<span class="p">,</span> <span class="mh">0x42</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RSLLC</span>         	<span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSLPL</span>			<span class="p">,</span> <span class="mh">0x12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSCFGH</span>        	<span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSCFGM</span>        	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSCFGL</span>        	<span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSOUT</span>			<span class="p">,</span> <span class="mh">0x4d</span> <span class="p">},</span> <span class="cm">/* 0x0d for CAM */</span>
	<span class="p">{</span> <span class="n">STB0899_RSSYNCDEL</span>     	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSINHDELH</span>     	<span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSINHDELM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSINHDELL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSLLSTKM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSLLSTKL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSULSTKM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSULSTKL</span>		<span class="p">,</span> <span class="mh">0xab</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PCKLENUL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PCKLENLL</span>		<span class="p">,</span> <span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RSPCKLEN</span>		<span class="p">,</span> <span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSSTATUS</span>		<span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ERRCTRL1</span>      	<span class="p">,</span> <span class="mh">0xb6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ERRCTRL2</span>      	<span class="p">,</span> <span class="mh">0x96</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ERRCTRL3</span>      	<span class="p">,</span> <span class="mh">0x89</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DMONMSK1</span>		<span class="p">,</span> <span class="mh">0x27</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DMONMSK0</span>		<span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DEMAPVIT</span>      	<span class="p">,</span> <span class="mh">0x5c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PLPARM</span>		<span class="p">,</span> <span class="mh">0x1f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PDELCTRL</span>      	<span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PDELCTRL2</span>     	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BBHCTRL1</span>      	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BBHCTRL2</span>      	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_HYSTTHRESH</span>    	<span class="p">,</span> <span class="mh">0x77</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MATCSTM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MATCSTL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPLCSTM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPLCSTL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DFLCSTM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DFLCSTL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCCST</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCDCSTM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCDCSTL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ISI_ENTRY</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ISI_BIT_EN</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MATSTRM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MATSTRL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPLSTRM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPLSTRL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DFLSTRM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DFLSTRL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCSTR</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCDSTRM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCDSTRL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFGPDELSTATUS1</span>	<span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFGPDELSTATUS2</span>	<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BBFERRORM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BBFERRORL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPKTERRORM</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPKTERRORL</span>		<span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xffff</span>			<span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stb0899_config</span> <span class="n">tt3200_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init_dev</span>		<span class="o">=</span> <span class="n">tt3200_stb0899_s1_init_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_s2_demod</span>		<span class="o">=</span> <span class="n">stb0899_s2_init_2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_s1_demod</span>		<span class="o">=</span> <span class="n">tt3200_stb0899_s1_init_3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_s2_fec</span>		<span class="o">=</span> <span class="n">stb0899_s2_init_4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_tst</span>		<span class="o">=</span> <span class="n">stb0899_s1_init_5</span><span class="p">,</span>

	<span class="p">.</span><span class="n">postproc</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>

	<span class="p">.</span><span class="n">demod_address</span> 		<span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>

	<span class="p">.</span><span class="n">xtal_freq</span>		<span class="o">=</span> <span class="mi">27000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inversion</span>		<span class="o">=</span> <span class="n">IQ_SWAP_ON</span><span class="p">,</span> <span class="cm">/* 1 */</span>

	<span class="p">.</span><span class="n">lo_clk</span>			<span class="o">=</span> <span class="mi">76500000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hi_clk</span>			<span class="o">=</span> <span class="mi">99000000</span><span class="p">,</span>

	<span class="p">.</span><span class="n">esno_ave</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_ESNO_AVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">esno_quant</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_ESNO_QUANT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">avframes_coarse</span>	<span class="o">=</span> <span class="n">STB0899_DVBS2_AVFRAMES_COARSE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">avframes_fine</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_AVFRAMES_FINE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">miss_threshold</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_MISS_THRESHOLD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uwp_threshold_acq</span>	<span class="o">=</span> <span class="n">STB0899_DVBS2_UWP_THRESHOLD_ACQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uwp_threshold_track</span>	<span class="o">=</span> <span class="n">STB0899_DVBS2_UWP_THRESHOLD_TRACK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uwp_threshold_sof</span>	<span class="o">=</span> <span class="n">STB0899_DVBS2_UWP_THRESHOLD_SOF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sof_search_timeout</span>	<span class="o">=</span> <span class="n">STB0899_DVBS2_SOF_SEARCH_TIMEOUT</span><span class="p">,</span>

	<span class="p">.</span><span class="n">btr_nco_bits</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_BTR_NCO_BITS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">btr_gain_shift_offset</span>	<span class="o">=</span> <span class="n">STB0899_DVBS2_BTR_GAIN_SHIFT_OFFSET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crl_nco_bits</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_CRL_NCO_BITS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ldpc_max_iter</span>		<span class="o">=</span> <span class="n">STB0899_DVBS2_LDPC_MAX_ITER</span><span class="p">,</span>

	<span class="p">.</span><span class="n">tuner_get_frequency</span>	<span class="o">=</span> <span class="n">stb6100_get_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_set_frequency</span>	<span class="o">=</span> <span class="n">stb6100_set_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_set_bandwidth</span>	<span class="o">=</span> <span class="n">stb6100_set_bandwidth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_get_bandwidth</span>	<span class="o">=</span> <span class="n">stb6100_get_bandwidth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_set_rfsiggain</span>	<span class="o">=</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stb6100_config</span> <span class="n">tt3200_stb6100_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tuner_address</span>	<span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="p">.</span><span class="n">refclock</span>	<span class="o">=</span> <span class="mi">27000000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">frontend_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x100c</span>:		<span class="c1">// Hauppauge/TT Nova-CI budget (stv0299/ALPS BSRU6(tsa5059))</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span>
			<span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0299_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alps_bsru6_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">alps_bsru6_tuner_set_params</span><span class="p">;</span>
			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x100f</span>:		<span class="c1">// Hauppauge/TT Nova-CI budget (stv0299b/Philips su1278(tsa5059))</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span>
			<span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0299_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">philips_su1278_tt_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">philips_su1278_tt_tuner_set_params</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x1010</span>:		<span class="c1">// TT DVB-C CI budget (stv0297/Philips tdm1316l(tda6651tt))</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">tuner_pll_address</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">;</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span>
			<span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0297_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvbc_philips_tdm1316l_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">dvbc_philips_tdm1316l_tuner_set_params</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x1011</span>:		<span class="c1">// Hauppauge/TT Nova-T budget (tda10045/Philips tdm1316l(tda6651tt) + TDA9889)</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">tuner_pll_address</span> <span class="o">=</span> <span class="mh">0x63</span><span class="p">;</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span>
			<span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda10045_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">philips_tdm1316l_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">philips_tdm1316l_tuner_init</span><span class="p">;</span>
			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">philips_tdm1316l_tuner_set_params</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x1012</span>:		<span class="c1">// TT DVB-T CI budget (tda10046/Philips tdm1316l(tda6651tt))</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">tuner_pll_address</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span>
			<span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda10046_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">philips_tdm1316l_config_invert</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">philips_tdm1316l_tuner_init</span><span class="p">;</span>
			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">philips_tdm1316l_tuner_set_params</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x1017</span>:		<span class="c1">// TT S-1500 PCI</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0299_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alps_bsbe1_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">alps_bsbe1_tuner_set_params</span><span class="p">;</span>
			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">;</span>

			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">dishnetwork_send_legacy_command</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">lnbp21_attach</span><span class="p">,</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">LNBP21_LLC</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: No LNBP21 found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">);</span>
				<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x101a</span>: <span class="cm">/* TT Budget-C-1501 (philips tda10023/philips tda8274A) */</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda10023_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tda10023_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda827x_attach</span><span class="p">,</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tda827x_config</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: No tda827x found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">);</span>
				<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x101b</span>: <span class="cm">/* TT S-1500B (BSBE1-D01A - STV0288/STB6000/LNBP21) */</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0288_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stv0288_bsbe1_d01a_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">stb6000_attach</span><span class="p">,</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">lnbp21_attach</span><span class="p">,</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: No LNBP21 found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
					<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">);</span>
					<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: No STB6000 found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">);</span>
				<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x1019</span>:		<span class="c1">// TT S2-3200 PCI</span>
		<span class="cm">/*</span>
<span class="cm">		 * NOTE! on some STB0899 versions, the internal PLL takes a longer time</span>
<span class="cm">		 * to settle, aka LOCK. On the older revisions of the chip, we don&#39;t see</span>
<span class="cm">		 * this, as a result on the newer chips the entire clock tree, will not</span>
<span class="cm">		 * be stable after a freshly POWER &#39;ed up situation.</span>
<span class="cm">		 * In this case, we should RESET the STB0899 (Active LOW) and wait for</span>
<span class="cm">		 * PLL stabilization.</span>
<span class="cm">		 *</span>
<span class="cm">		 * On the TT S2 3200 and clones, the STB0899 demodulator&#39;s RESETB is</span>
<span class="cm">		 * connected to the SAA7146 GPIO, GPIO2, Pin 142</span>
<span class="cm">		 */</span>
		<span class="cm">/* Reset Demodulator */</span>
		<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
		<span class="cm">/* Wait for everything to die */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="cm">/* Pull it up out of Reset state */</span>
		<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>
		<span class="cm">/* Wait for PLL to stabilize */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * PLL state should be stable now. Ideally, we should check</span>
<span class="cm">		 * for PLL LOCK status. But well, never mind!</span>
<span class="cm">		 */</span>
		<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stb0899_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tt3200_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">stb6100_attach</span><span class="p">,</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tt3200_stb6100_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">lnbp21_attach</span><span class="p">,</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: No LNBP21 found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
					<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">);</span>
					<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">);</span>
					<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;budget-ci: A frontend driver was not found for device [%04x:%04x] subsystem [%04x:%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
		       <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		       <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
		       <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb_register_frontend</span>
		    <span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;budget-ci: Frontend registration failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">);</span>
			<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_ci_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7146_pci_extension_data</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">budget_ci</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">budget_ci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;budget_ci: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget_ci</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ttpci_budget_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
				<span class="n">adapter_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">msp430_ir_init</span><span class="p">(</span><span class="n">budget_ci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="n">ciintf_init</span><span class="p">(</span><span class="n">budget_ci</span><span class="p">);</span>

	<span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="p">;</span>
	<span class="n">frontend_init</span><span class="p">(</span><span class="n">budget_ci</span><span class="p">);</span>

	<span class="n">ttpci_budget_init_hooks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out3:</span>
	<span class="n">ttpci_budget_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">);</span>
<span class="nl">out2:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">budget_ci</span><span class="p">);</span>
<span class="nl">out1:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_ci_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="n">budget_ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_ci</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">saa</span> <span class="o">=</span> <span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">ci_present</span><span class="p">)</span>
		<span class="n">ciintf_deinit</span><span class="p">(</span><span class="n">budget_ci</span><span class="p">);</span>
	<span class="n">msp430_ir_deinit</span><span class="p">(</span><span class="n">budget_ci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvb_unregister_frontend</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">);</span>
		<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">.</span><span class="n">dvb_frontend</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ttpci_budget_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_ci</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>disable frontend and CI interface</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SAA7146_GPIO_INPUT</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">budget_ci</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_extension</span> <span class="n">budget_extension</span><span class="p">;</span>

<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">ttbs2</span><span class="p">,</span> <span class="s">&quot;TT-Budget/S-1500 PCI&quot;</span><span class="p">,</span> <span class="n">BUDGET_TT</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">ttbci</span><span class="p">,</span> <span class="s">&quot;TT-Budget/WinTV-NOVA-CI PCI&quot;</span><span class="p">,</span> <span class="n">BUDGET_TT_HW_DISEQC</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">ttbt2</span><span class="p">,</span> <span class="s">&quot;TT-Budget/WinTV-NOVA-T	 PCI&quot;</span><span class="p">,</span> <span class="n">BUDGET_TT</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">ttbtci</span><span class="p">,</span> <span class="s">&quot;TT-Budget-T-CI PCI&quot;</span><span class="p">,</span> <span class="n">BUDGET_TT</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">ttbcci</span><span class="p">,</span> <span class="s">&quot;TT-Budget-C-CI PCI&quot;</span><span class="p">,</span> <span class="n">BUDGET_TT</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">ttc1501</span><span class="p">,</span> <span class="s">&quot;TT-Budget C-1501 PCI&quot;</span><span class="p">,</span> <span class="n">BUDGET_TT</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">tt3200</span><span class="p">,</span> <span class="s">&quot;TT-Budget S2-3200 PCI&quot;</span><span class="p">,</span> <span class="n">BUDGET_TT</span><span class="p">);</span>
<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">ttbs1500b</span><span class="p">,</span> <span class="s">&quot;TT-Budget S-1500B PCI&quot;</span><span class="p">,</span> <span class="n">BUDGET_TT</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">ttbci</span><span class="p">,</span> <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x100c</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">ttbci</span><span class="p">,</span> <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x100f</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">ttbcci</span><span class="p">,</span> <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x1010</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">ttbt2</span><span class="p">,</span> <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x1011</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">ttbtci</span><span class="p">,</span> <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x1012</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">ttbs2</span><span class="p">,</span> <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x1017</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">ttc1501</span><span class="p">,</span> <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x101a</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">tt3200</span><span class="p">,</span> <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x1019</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">ttbs1500b</span><span class="p">,</span> <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x101b</span><span class="p">),</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_extension</span> <span class="n">budget_extension</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;budget_ci dvb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SAA7146_USE_I2C_IRQ</span><span class="p">,</span>

	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pci_tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span> <span class="n">budget_ci_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span> <span class="o">=</span> <span class="n">budget_ci_detach</span><span class="p">,</span>

	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">MASK_03</span> <span class="o">|</span> <span class="n">MASK_06</span> <span class="o">|</span> <span class="n">MASK_10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_func</span> <span class="o">=</span> <span class="n">budget_ci_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">budget_ci_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">saa7146_register_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_extension</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">budget_ci_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">saa7146_unregister_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_extension</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">budget_ci_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">budget_ci_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Michael Hunold, Jack Thomasson, Andrew de Quincey, others&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;driver for the SAA7146 based so-called &quot;</span>
		   <span class="s">&quot;budget PCI DVB cards w/ CI-module produced by &quot;</span>
		   <span class="s">&quot;Siemens, Technotrend, Hauppauge&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
