<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › ttpci › av7110.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>av7110.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * driver for the SAA7146 based AV110 cards (like the Fujitsu-Siemens DVB)</span>
<span class="cm"> * av7110.c: initialization and demux stuff</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999-2002 Ralph  Metzler</span>
<span class="cm"> *                       &amp; Marcus Metzler for convergence integrated media GmbH</span>
<span class="cm"> *</span>
<span class="cm"> * originally based on code by:</span>
<span class="cm"> * Copyright (C) 1998,1999 Christian Theiss &lt;mistert@rz.fh-augsburg.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> * Or, point your browser to http://www.gnu.org/copyleft/gpl.html</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * the project&#39;s page is at http://www.linuxtv.org/ </span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>


<span class="cp">#include &lt;linux/dvb/frontend.h&gt;</span>

<span class="cp">#include &quot;dvb_frontend.h&quot;</span>

<span class="cp">#include &quot;ttpci-eeprom.h&quot;</span>
<span class="cp">#include &quot;av7110.h&quot;</span>
<span class="cp">#include &quot;av7110_hw.h&quot;</span>
<span class="cp">#include &quot;av7110_av.h&quot;</span>
<span class="cp">#include &quot;av7110_ca.h&quot;</span>
<span class="cp">#include &quot;av7110_ipack.h&quot;</span>

<span class="cp">#include &quot;bsbe1.h&quot;</span>
<span class="cp">#include &quot;lnbp21.h&quot;</span>
<span class="cp">#include &quot;bsru6.h&quot;</span>

<span class="cp">#define TS_WIDTH  376</span>
<span class="cp">#define TS_HEIGHT 512</span>
<span class="cp">#define TS_BUFLEN (TS_WIDTH*TS_HEIGHT)</span>
<span class="cp">#define TS_MAX_PACKETS (TS_BUFLEN/TS_SIZE)</span>


<span class="kt">int</span> <span class="n">av7110_debug</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">vidmode</span> <span class="o">=</span> <span class="n">CVBS_RGB_OUT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pids_off</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">adac</span> <span class="o">=</span> <span class="n">DVB_ADAC_TI</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hw_sections</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rgb_on</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">volume</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">budgetpatch</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wss_cfg_4_3</span> <span class="o">=</span> <span class="mh">0x4008</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wss_cfg_16_9</span> <span class="o">=</span> <span class="mh">0x0007</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tv_standard</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">full_ts</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">av7110_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;debug level (bitmask, default 0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vidmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vidmode</span><span class="p">,</span><span class="s">&quot;analog video out: 0 off, 1 CVBS+RGB (default), 2 CVBS+YC, 3 YC&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pids_off</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pids_off</span><span class="p">,</span><span class="s">&quot;clear video/audio/PCR PID filters when demux is closed&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">adac</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">adac</span><span class="p">,</span><span class="s">&quot;audio DAC type: 0 TI, 1 CRYSTAL, 2 MSP (use if autodetection fails)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hw_sections</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hw_sections</span><span class="p">,</span> <span class="s">&quot;0 use software section filter, 1 use hardware&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rgb_on</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rgb_on</span><span class="p">,</span> <span class="s">&quot;For Siemens DVB-C cards only: Enable RGB control&quot;</span>
		<span class="s">&quot; signal on SCART pin 16 to switch SCART video mode from CVBS to RGB&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="s">&quot;initial volume: default 255 (range 0-255)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">budgetpatch</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">budgetpatch</span><span class="p">,</span> <span class="s">&quot;use budget-patch hardware modification: default 0 (0 no, 1 autodetect, 2 always)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">full_ts</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">full_ts</span><span class="p">,</span> <span class="s">&quot;enable code for full-ts hardware modification: 0 disable (default), 1 enable&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">wss_cfg_4_3</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wss_cfg_4_3</span><span class="p">,</span> <span class="s">&quot;WSS 4:3 - default 0x4008 - bit 15: disable, 14: burst mode, 13..0: wss data&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">wss_cfg_16_9</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wss_cfg_16_9</span><span class="p">,</span> <span class="s">&quot;WSS 16:9 - default 0x0007 - bit 15: disable, 14: burst mode, 13..0: wss data&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tv_standard</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tv_standard</span><span class="p">,</span> <span class="s">&quot;TV standard: 0 PAL (default), 1 NTSC&quot;</span><span class="p">);</span>

<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">restart_feeds</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">budget_start_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">budget_stop_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">av7110_num</span><span class="p">;</span>

<span class="cp">#define FE_FUNC_OVERRIDE(fe_func, av7110_copy, av7110_func) \</span>
<span class="cp">{\</span>
<span class="cp">	if (fe_func != NULL) { \</span>
<span class="cp">		av7110_copy = fe_func; \</span>
<span class="cp">		fe_func = av7110_func; \</span>
<span class="cp">	} \</span>
<span class="cp">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_av7110_av</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* set internal volume control to maximum */</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span> <span class="o">=</span> <span class="n">DVB_ADAC_TI</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_set_volume</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">.</span><span class="n">volume_left</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">.</span><span class="n">volume_right</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci:cannot set internal volume to maximum:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_ENCODER</span><span class="p">,</span> <span class="n">SetMonitorType</span><span class="p">,</span>
			    <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">display_ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: unable to set aspect ratio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_ENCODER</span><span class="p">,</span> <span class="n">SetPanScanType</span><span class="p">,</span>
			    <span class="mi">1</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">display_panscan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: unable to set pan scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_ENCODER</span><span class="p">,</span> <span class="n">SetWSSConfig</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wss_cfg_4_3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: unable to configure 4:3 wss</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_ENCODER</span><span class="p">,</span> <span class="n">SetWSSConfig</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">wss_cfg_16_9</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: unable to configure 16:9 wss</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7710_set_video_mode</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">vidmode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci:cannot set video mode:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* handle different card types */</span>
	<span class="cm">/* remaining inits according to card and frontend type */</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">analog_tuner_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">current_input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x13c2</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x000a</span><span class="p">)</span>
		<span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_AUDIODAC</span><span class="p">,</span> <span class="n">ADSwitch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// SPDIF on</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;dvb-ttpci: Crystal audio DAC @ card %d detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span> <span class="o">=</span> <span class="n">DVB_ADAC_CRYSTAL</span><span class="p">;</span>
		<span class="n">i2c_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">);</span>
		<span class="n">i2c_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">);</span>
		<span class="n">i2c_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">i2c_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="cm">/**</span>
<span class="cm">		 * some special handling for the Siemens DVB-C cards...</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">av7110_init_analog_module</span><span class="p">(</span><span class="n">av7110</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* done. */</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x110a</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: DVB-C w/o analog module @ card %d detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span> <span class="o">=</span> <span class="n">DVB_ADAC_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span> <span class="o">=</span> <span class="n">adac</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: adac type set to %d @ card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span> <span class="o">==</span> <span class="n">DVB_ADAC_NONE</span> <span class="o">||</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span> <span class="o">==</span> <span class="n">DVB_ADAC_MSP34x0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>switch DVB SCART on</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_AUDIODAC</span><span class="p">,</span> <span class="n">MainSwitch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci:cannot switch on SCART(Main):%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_AUDIODAC</span><span class="p">,</span> <span class="n">ADSwitch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci:cannot switch on SCART(AD):%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rgb_on</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x110a</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x13c2</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span> <span class="c1">// RGB on, SCART pin 16</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>saa7146<em>setgpio(dev, 3, SAA7146</em>GPIO_OUTLO); // SCARTpin 8</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x13c2</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x000e</span><span class="p">)</span>
		<span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_AUDIODAC</span><span class="p">,</span> <span class="n">SpdifSwitch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// SPDIF on</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_set_volume</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">.</span><span class="n">volume_left</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">.</span><span class="n">volume_right</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci:cannot set volume :%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">recover_arm</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">av7110</span><span class="p">);</span>

	<span class="n">av7110_bootarm</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">init_av7110_av</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>

	<span class="cm">/* card-specific recovery */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">recover</span><span class="p">)</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">recover</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>

	<span class="n">restart_feeds</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_INPUT_EVDEV) || defined(CONFIG_INPUT_EVDEV_MODULE)</span>
	<span class="n">av7110_check_ir_config</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">av7110_arm_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_thread</span><span class="p">)</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_thread</span><span class="p">);</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arm_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">newloops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">av7110</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_wait</span><span class="p">,</span>
			<span class="n">kthread_should_stop</span><span class="p">(),</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">ERESTARTSYS</span> <span class="o">==</span> <span class="n">timeout</span> <span class="o">||</span> <span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
			<span class="cm">/* got signal or told to quit*/</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_ready</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_INPUT_EVDEV) || defined(CONFIG_INPUT_EVDEV_MODULE)</span>
		<span class="n">av7110_check_ir_config</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">newloops</span> <span class="o">=</span> <span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">STATUS_LOOPS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">newloops</span> <span class="o">==</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_loops</span> <span class="o">||</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_errors</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: ARM crashed @ card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>

			<span class="n">recover_arm</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">newloops</span> <span class="o">=</span> <span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">STATUS_LOOPS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_loops</span> <span class="o">=</span> <span class="n">newloops</span><span class="p">;</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * IRQ handling</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DvbDmxFilterCallback</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buffer1</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buffer1_len</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">buffer2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buffer2_len</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">dvb_demux_filter</span> <span class="o">*</span><span class="n">dvbdmxfilter</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">dmx_success</span> <span class="n">success</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">frontend</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">frontend</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">==</span> <span class="n">DMX_MEMORY_FE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMX_TYPE_SEC</span>:
		<span class="k">if</span> <span class="p">((((</span><span class="n">buffer1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">!=</span> <span class="n">buffer1_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">doneq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dmx_section_filter</span> <span class="o">*</span><span class="n">filter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">xor</span><span class="p">,</span> <span class="n">neq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DVB_DEMUX_MASK_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xor</span> <span class="o">=</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">filter_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">buffer1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">neq</span> <span class="o">|=</span> <span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">maskandnotmode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">xor</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">neq</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">.</span><span class="n">sec</span><span class="p">(</span><span class="n">buffer1</span><span class="p">,</span> <span class="n">buffer1_len</span><span class="p">,</span>
						  <span class="n">buffer2</span><span class="p">,</span> <span class="n">buffer2_len</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">,</span>
						  <span class="n">DMX_OK</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DMX_TYPE_TS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_PACKET</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_PAYLOAD_ONLY</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">.</span><span class="n">ts</span><span class="p">(</span><span class="n">buffer1</span><span class="p">,</span> <span class="n">buffer1_len</span><span class="p">,</span>
							 <span class="n">buffer2</span><span class="p">,</span> <span class="n">buffer2_len</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">.</span><span class="n">ts</span><span class="p">,</span>
							 <span class="n">DMX_OK</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">av7110_p2t_write</span><span class="p">(</span><span class="n">buffer1</span><span class="p">,</span> <span class="n">buffer1_len</span><span class="p">,</span>
					 <span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">p2t_filter</span><span class="p">[</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><h1>define DEBUG_TIMING</h1></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">print_time</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG_TIMING</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#define DEBI_READ 0</span>
<span class="cp">#define DEBI_WRITE 1</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">start_debi_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%c %08lx %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dir</span> <span class="o">==</span> <span class="n">DEBI_READ</span> <span class="o">?</span> <span class="sc">&#39;R&#39;</span> <span class="o">:</span> <span class="sc">&#39;W&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saa7146_wait_for_debi_done</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: saa7146_wait_for_debi_done timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SAA7146_ISR_CLEAR</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_19</span><span class="p">);</span> <span class="cm">/* for good measure */</span>
	<span class="n">SAA7146_IER_ENABLE</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_19</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* we want a real DEBI DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">DEBI_WRITE</span><span class="p">)</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBISWAB</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">irdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBISWAB</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">debiirq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="p">)</span><span class="n">cookie</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debitype</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handle</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xfer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">print_time</span><span class="p">(</span><span class="s">&quot;debi&quot;</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;type 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DEBI irq oops @ %ld, psr:0x%08x, ssr:0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">jiffies</span><span class="p">,</span> <span class="n">saa7146_read</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">),</span>
		       <span class="n">saa7146_read</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSR</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">debi_done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debitype</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">DATA_TS_RECORD</span>:
		<span class="n">dvb_dmx_swfilter_packets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">,</span>
					 <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">,</span>
					 <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilen</span> <span class="o">/</span> <span class="mi">188</span><span class="p">);</span>
		<span class="n">xfer</span> <span class="o">=</span> <span class="n">RX_BUFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DATA_PES_RECORD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">recording</span><span class="p">)</span>
			<span class="n">av7110_record_cb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">p2t</span><span class="p">[</span><span class="n">handle</span><span class="p">],</span>
					 <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">,</span>
					 <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilen</span><span class="p">);</span>
		<span class="n">xfer</span> <span class="o">=</span> <span class="n">RX_BUFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DATA_IPMPE</span>:
	<span class="k">case</span> <span class="n">DATA_FSECTION</span>:
	<span class="k">case</span> <span class="n">DATA_PIPING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">handle2filter</span><span class="p">[</span><span class="n">handle</span><span class="p">])</span>
			<span class="n">DvbDmxFilterCallback</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">,</span>
					     <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilen</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					     <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">handle2filter</span><span class="p">[</span><span class="n">handle</span><span class="p">],</span>
					     <span class="n">DMX_OK</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>
		<span class="n">xfer</span> <span class="o">=</span> <span class="n">RX_BUFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DATA_CI_GET</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">flags</span> <span class="o">|=</span> <span class="n">CA_CI_MODULE_PRESENT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">flags</span> <span class="o">|=</span> <span class="n">CA_CI_MODULE_READY</span><span class="p">;</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ci_slot</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ci_get_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ci_rbuffer</span><span class="p">,</span>
				    <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">,</span>
				    <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilen</span><span class="p">);</span>
		<span class="n">xfer</span> <span class="o">=</span> <span class="n">RX_BUFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">DATA_COMMON_INTERFACE</span>:
		<span class="n">CI_handle</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilen</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	{</span>
<span class="c">		int i;</span>

<span class="c">		printk(&quot;av7110%d: &quot;, av7110-&gt;num);</span>
<span class="c">		printk(&quot;%02x &quot;, *(u8 *)av7110-&gt;debi_virt);</span>
<span class="c">		printk(&quot;%02x &quot;, *(1+(u8 *)av7110-&gt;debi_virt));</span>
<span class="c">		for (i = 2; i &lt; av7110-&gt;debilen; i++)</span>
<span class="c">			printk(&quot;%02x &quot;, (*(i+(unsigned char *)av7110-&gt;debi_virt)));</span>
<span class="c">		for (i = 2; i &lt; av7110-&gt;debilen; i++)</span>
<span class="c">			printk(&quot;%c&quot;, chtrans(*(i+(unsigned char *)av7110-&gt;debi_virt)));</span>

<span class="c">		printk(&quot;\n&quot;);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
		<span class="n">xfer</span> <span class="o">=</span> <span class="n">RX_BUFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DATA_DEBUG_MESSAGE</span>:
		<span class="p">((</span><span class="n">s8</span><span class="o">*</span><span class="p">)</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">)[</span><span class="n">Reserved_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">s8</span> <span class="o">*</span><span class="p">)</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">);</span>
		<span class="n">xfer</span> <span class="o">=</span> <span class="n">RX_BUFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DATA_CI_PUT</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;debi DATA_CI_PUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DATA_MPEG_PLAY</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;debi DATA_MPEG_PLAY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DATA_BMP_LOAD</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;debi DATA_BMP_LOAD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">xfer</span> <span class="o">=</span> <span class="n">TX_BUFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">debi_done:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfer</span><span class="p">)</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">xfer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ARM_ClearMailBox</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* irq from av7110 firmware writing the mailbox register in the DPRAM */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gpioirq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="p">)</span><span class="n">cookie</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxbuf</span><span class="p">,</span> <span class="n">txbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debitype</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="cm">/* we shouldn&#39;t get any irq while a debi xfer is running */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: GPIO0 irq oops @ %ld, psr:0x%08x, ssr:0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">jiffies</span><span class="p">,</span> <span class="n">saa7146_read</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">),</span>
		       <span class="n">saa7146_read</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSR</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7146_wait_for_debi_done</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: saa7146_wait_for_debi_done timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span> <span class="cm">/* maybe we should try resetting the debi? */</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilock</span><span class="p">);</span>
	<span class="n">ARM_ClearIrq</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>

	<span class="cm">/* see what the av7110 wants */</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debitype</span> <span class="o">=</span> <span class="n">irdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">IRQ_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilen</span>  <span class="o">=</span> <span class="n">irdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">IRQ_STATE_EXT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rxbuf</span> <span class="o">=</span> <span class="n">irdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">RX_BUFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">txbuf</span> <span class="o">=</span> <span class="n">irdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_BUFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

	<span class="n">print_time</span><span class="p">(</span><span class="s">&quot;gpio&quot;</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;GPIO0 irq 0x%04x %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debitype</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilen</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debitype</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">DATA_TS_PLAY</span>:
	<span class="k">case</span> <span class="n">DATA_PES_PLAY</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DATA_MPEG_VIDEO_EVENT</span>:
	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">h_ar</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">video_event</span> <span class="n">event</span><span class="p">;</span>

		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">irdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">STATUS_MPEG_WIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">h_ar</span> <span class="o">=</span> <span class="n">irdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">STATUS_MPEG_HEIGHT_AR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">IRQ_STATE_EXT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">RX_BUFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h_ar</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>

		<span class="n">event</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VIDEO_EVENT_SIZE_CHANGED</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">.</span><span class="n">h</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">h_ar</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">.</span><span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">VIDEO_FORMAT_16_9</span><span class="p">;</span>
			<span class="n">event</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">VIDEO_FORMAT_16_9</span><span class="p">;</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">video_format</span> <span class="o">=</span> <span class="n">VIDEO_FORMAT_16_9</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">.</span><span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">VIDEO_FORMAT_221_1</span><span class="p">;</span>
			<span class="n">event</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">VIDEO_FORMAT_221_1</span><span class="p">;</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">video_format</span> <span class="o">=</span> <span class="n">VIDEO_FORMAT_221_1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">.</span><span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">VIDEO_FORMAT_4_3</span><span class="p">;</span>
			<span class="n">event</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">VIDEO_FORMAT_4_3</span><span class="p">;</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">video_format</span> <span class="o">=</span> <span class="n">VIDEO_FORMAT_4_3</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;GPIO0 irq: DATA_MPEG_VIDEO_EVENT: w/h/ar = %u/%u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">.</span><span class="n">w</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">.</span><span class="n">h</span><span class="p">,</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">.</span><span class="n">aspect_ratio</span><span class="p">);</span>

		<span class="n">dvb_video_add_event</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">DATA_CI_PUT</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">avail</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dvb_ringbuffer</span> <span class="o">*</span><span class="n">cibuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ci_wbuffer</span><span class="p">;</span>

		<span class="n">avail</span> <span class="o">=</span> <span class="n">dvb_ringbuffer_avail</span><span class="p">(</span><span class="n">cibuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">IRQ_STATE_EXT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_LEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_BUFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">DVB_RINGBUFFER_PEEK</span><span class="p">(</span><span class="n">cibuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">|=</span> <span class="n">DVB_RINGBUFFER_PEEK</span><span class="p">(</span><span class="n">cibuf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">IRQ_STATE_EXT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_LEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_BUFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DVB_RINGBUFFER_SKIP</span><span class="p">(</span><span class="n">cibuf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">dvb_ringbuffer_read</span><span class="p">(</span><span class="n">cibuf</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_LEN</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">IRQ_STATE_EXT</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;DMA: CI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">start_debi_dma</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBI_WRITE</span><span class="p">,</span> <span class="n">DPRAM_BASE</span> <span class="o">+</span> <span class="n">txbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilock</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cibuf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">DATA_MPEG_PLAY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">IRQ_STATE_EXT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_LEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_BUFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debitype</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">av7110_pes_play</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">,</span> <span class="mi">2048</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debitype</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">!=</span> <span class="n">VIDEO_FREEZED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">av7110_pes_play</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avout</span><span class="p">,</span> <span class="mi">2048</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avout</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">IRQ_STATE_EXT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_LEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_BUFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;GPIO0 PES_PLAY len=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_LEN</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">IRQ_STATE_EXT</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;DMA: MPEG_PLAY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">start_debi_dma</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBI_WRITE</span><span class="p">,</span> <span class="n">DPRAM_BASE</span> <span class="o">+</span> <span class="n">txbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DATA_BMP_LOAD</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilen</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;gpio DATA_BMP_LOAD len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmp_state</span> <span class="o">=</span> <span class="n">BMP_LOADED</span><span class="p">;</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">IRQ_STATE_EXT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_LEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_BUFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmpq</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;gpio DATA_BMP_LOAD done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmplen</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmplen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">TX_LEN</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">IRQ_STATE_EXT</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmpbuf</span><span class="o">+</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmpp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmpp</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmplen</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;gpio DATA_BMP_LOAD DMA len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">start_debi_dma</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBI_WRITE</span><span class="p">,</span> <span class="n">DPRAM_BASE</span><span class="o">+</span><span class="n">txbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DATA_CI_GET</span>:
	<span class="k">case</span> <span class="n">DATA_COMMON_INTERFACE</span>:
	<span class="k">case</span> <span class="n">DATA_FSECTION</span>:
	<span class="k">case</span> <span class="n">DATA_IPMPE</span>:
	<span class="k">case</span> <span class="n">DATA_PIPING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">RX_BUFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fall through */</span>

	<span class="k">case</span> <span class="n">DATA_TS_RECORD</span>:
	<span class="k">case</span> <span class="n">DATA_PES_RECORD</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;DMA: TS_REC etc.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">start_debi_dma</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBI_READ</span><span class="p">,</span> <span class="n">DPRAM_BASE</span><span class="o">+</span><span class="n">rxbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DATA_DEBUG_MESSAGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">RX_BUFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start_debi_dma</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBI_READ</span><span class="p">,</span> <span class="n">Reserved</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DATA_IRCOMMAND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">ir_handler</span><span class="p">)</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ir</span><span class="p">.</span><span class="n">ir_handler</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span>
				<span class="n">swahw32</span><span class="p">(</span><span class="n">irdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">Reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)));</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">RX_BUFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: gpioirq unknown type=%d len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debitype</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilen</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debitype</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ARM_ClearMailBox</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_DVB_AV7110_OSD</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_osd_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">parg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">OSD_SEND_CMD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">av7110_osd_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="p">(</span><span class="n">osd_cmd_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">parg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">OSD_GET_CAPABILITY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">av7110_osd_capability</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="p">(</span><span class="n">osd_cap_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">parg</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dvb_osd_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">dvb_generic_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dvb_generic_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">dvb_generic_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_device</span> <span class="n">dvbdev_osd</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">priv</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">writers</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_osd_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kernel_ioctl</span>	<span class="o">=</span> <span class="n">dvb_osd_ioctl</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_DVB_AV7110_OSD */</span><span class="cp"></span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">SetPIDs</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vpid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">apid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ttpid</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">subpid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pcrpid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">aflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vpid</span> <span class="o">==</span> <span class="mh">0x1fff</span> <span class="o">||</span> <span class="n">apid</span> <span class="o">==</span> <span class="mh">0x1fff</span> <span class="o">||</span>
	    <span class="n">ttpid</span> <span class="o">==</span> <span class="mh">0x1fff</span> <span class="o">||</span> <span class="n">subpid</span> <span class="o">==</span> <span class="mh">0x1fff</span> <span class="o">||</span> <span class="n">pcrpid</span> <span class="o">==</span> <span class="mh">0x1fff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpid</span> <span class="o">=</span> <span class="n">apid</span> <span class="o">=</span> <span class="n">ttpid</span> <span class="o">=</span> <span class="n">subpid</span> <span class="o">=</span> <span class="n">pcrpid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_VIDEO</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_AUDIO</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_TELETEXT</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_PCR</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">bypass_mode</span><span class="p">)</span>
		<span class="n">aflags</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_PIDFILTER</span><span class="p">,</span> <span class="n">MultiPID</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
			     <span class="n">pcrpid</span><span class="p">,</span> <span class="n">vpid</span><span class="p">,</span> <span class="n">apid</span><span class="p">,</span> <span class="n">ttpid</span><span class="p">,</span> <span class="n">subpid</span><span class="p">,</span> <span class="n">aflags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ChangePIDs</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vpid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">apid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ttpid</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">subpid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pcrpid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pid_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vpid</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_VIDEO</span><span class="p">]</span> <span class="o">=</span> <span class="n">vpid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">apid</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_AUDIO</span><span class="p">]</span> <span class="o">=</span> <span class="n">apid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ttpid</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_TELETEXT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttpid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcrpid</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_PCR</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcrpid</span><span class="p">;</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_SUBTITLE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_synced</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcrpid</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_PCR</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SetPIDs</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">vpid</span><span class="p">,</span> <span class="n">apid</span><span class="p">,</span> <span class="n">ttpid</span><span class="p">,</span> <span class="n">subpid</span><span class="p">,</span> <span class="n">pcrpid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pid_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/******************************************************************************</span>
<span class="cm"> * hardware filter functions</span>
<span class="cm"> ******************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">StartHWFilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_filter</span> <span class="o">*</span><span class="n">dvbdmxfilter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">dvbdmxfeed</span> <span class="o">=</span> <span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>u16 mode = 0x0320;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">u16</span> <span class="n">mode</span> <span class="o">=</span> <span class="mh">0xb96a</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DMX_TYPE_SEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw_sections</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">.</span><span class="n">filter_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">maskandmode</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">.</span><span class="n">filter_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">maskandmode</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_PACKET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_PAYLOAD_ONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">av7110_p2t_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">p2t_filter</span><span class="p">[</span><span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span> <span class="n">dvbdmxfeed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">COMTYPE_PID_FILTER</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">AddPIDFilter</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_request</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">handle</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: %s error  buf %04x %04x %04x %04x  &quot;</span>
				<span class="s">&quot;ret %d  handle %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				<span class="n">ret</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">hw_handle</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">handle2filter</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvbdmxfilter</span><span class="p">;</span>
	<span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">hw_handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">StopHWFilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_filter</span> <span class="o">*</span><span class="n">dvbdmxfilter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">answ</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">hw_handle</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s tried to stop invalid filter %04x, filter type = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">handle2filter</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">COMTYPE_PID_FILTER</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">DelPIDFilter</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_request</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">answ</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">answ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: %s error  cmd %04x %04x %04x  ret %x  &quot;</span>
				<span class="s">&quot;resp %04x %04x  pid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ret</span><span class="p">,</span>
				<span class="n">answ</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">answ</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dvbdmxfilter</span><span class="o">-&gt;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_feed_start_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">dvbdmxfeed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">dvbdmx</span> <span class="o">=</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">pid</span> <span class="o">=</span> <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">,</span> <span class="n">npids</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="n">npids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">npids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">npids</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">npids</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">npids</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">pes_type</span><span class="p">;</span>
	<span class="n">npids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x8000</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">pid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">npids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_PACKET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">npids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ChangePIDs</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">npids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">npids</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">npids</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">npids</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">StartHWFilter</span><span class="p">(</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">pes_type</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">pes_type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ChangePIDs</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">npids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">npids</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">npids</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">npids</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">pes_type</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">npids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_synced</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_PIDFILTER</span><span class="p">,</span> <span class="n">Scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_PACKET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">pes_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_av_start_record</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">RP_AUDIO</span><span class="p">,</span> <span class="n">dvbdmxfeed</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">pes_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_av_start_record</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">RP_VIDEO</span><span class="p">,</span> <span class="n">dvbdmxfeed</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_feed_stop_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">dvbdmxfeed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">dvbdmx</span> <span class="o">=</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">pid</span> <span class="o">=</span> <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">,</span> <span class="n">npids</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">pes_type</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_av_stop</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">pes_type</span> <span class="o">?</span>  <span class="n">RP_VIDEO</span> <span class="o">:</span> <span class="n">RP_AUDIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">rec_mode</span><span class="p">)</span>
			<span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">recording</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span><span class="p">)</span>
			<span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">npids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">npids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">npids</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">npids</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">npids</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">pes_type</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="c1">//teletext</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_PACKET</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">StopHWFilter</span><span class="p">(</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">);</span>
		<span class="n">npids</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pids_off</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">npids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x8000</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">pid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ChangePIDs</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">npids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">npids</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">npids</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">npids</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_start_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">demux</span> <span class="o">=</span> <span class="n">feed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">demux</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">frontend</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span> <span class="o">&amp;&amp;</span> <span class="n">feed</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mh">0x1fff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DMX_TYPE_TS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_DECODER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">pes_type</span> <span class="o">&lt;=</span> <span class="n">DMX_TS_PES_PCR</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">frontend</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DMX_MEMORY_FE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_DECODER</span><span class="p">)</span>
				       <span class="k">if</span> <span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">pes_type</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
					   <span class="o">!</span><span class="p">(</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					   <span class="o">!</span><span class="p">(</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span> <span class="p">{</span>
					       <span class="n">dvb_ringbuffer_flush_spinlock_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avout</span><span class="p">);</span>
					       <span class="n">dvb_ringbuffer_flush_spinlock_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">);</span>
					       <span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_av_start_play</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span><span class="n">RP_AV</span><span class="p">);</span>
					       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
						       <span class="n">demux</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_feed_start_pid</span><span class="p">(</span><span class="n">feed</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_PACKET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">frontend</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">!=</span> <span class="n">DMX_MEMORY_FE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">StartHWFilter</span><span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">budget_start_feed</span><span class="p">(</span><span class="n">feed</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DMX_TYPE_SEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">demux</span><span class="o">-&gt;</span><span class="n">filternum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DMX_STATE_READY</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">DMX_TYPE_SEC</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">filter</span><span class="p">.</span><span class="n">parent</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">.</span><span class="n">sec</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">demux</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">DMX_STATE_GO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">frontend</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">!=</span> <span class="n">DMX_MEMORY_FE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">StartHWFilter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_stop_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">demux</span> <span class="o">=</span> <span class="n">feed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">demux</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DMX_TYPE_TS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_DECODER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">pes_type</span> <span class="o">&gt;=</span> <span class="n">DMX_TS_PES_OTHER</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">pesfilter</span><span class="p">[</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">pes_type</span><span class="p">])</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">demux</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">pes_type</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
			<span class="n">demux</span><span class="o">-&gt;</span><span class="n">pesfilter</span><span class="p">[</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">pes_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_DECODER</span> <span class="o">&amp;&amp;</span>
		    <span class="n">feed</span><span class="o">-&gt;</span><span class="n">pes_type</span> <span class="o">&lt;</span> <span class="n">DMX_TS_PES_OTHER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_feed_stop_pid</span><span class="p">(</span><span class="n">feed</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_PACKET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">frontend</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">!=</span> <span class="n">DMX_MEMORY_FE</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">StopHWFilter</span><span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">budget_stop_feed</span><span class="p">(</span><span class="n">feed</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DMX_TYPE_SEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">filternum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">DMX_STATE_GO</span> <span class="o">&amp;&amp;</span>
			    <span class="n">demux</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">filter</span><span class="p">.</span><span class="n">parent</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">.</span><span class="n">sec</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">demux</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">DMX_STATE_READY</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">frontend</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">!=</span> <span class="n">DMX_MEMORY_FE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">StopHWFilter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
						<span class="n">ret</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
					<span class="cm">/* keep going, stop as many filters as possible */</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">restart_feeds</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">dvbdmx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">feeding</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">rec_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">feeding</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">feeding1</span><span class="p">;</span> <span class="cm">/* full_ts mod */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">feednum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">feed</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DMX_STATE_GO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DMX_TYPE_SEC</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">filternum</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">DMX_TYPE_SEC</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">filter</span><span class="p">.</span><span class="n">parent</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">.</span><span class="n">sec</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">DMX_STATE_GO</span><span class="p">)</span>
						<span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">DMX_STATE_READY</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">av7110_start_feed</span><span class="p">(</span><span class="n">feed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">feeding1</span> <span class="o">=</span> <span class="n">feeding</span><span class="p">;</span> <span class="cm">/* full_ts mod */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span>
		<span class="n">av7110_av_start_play</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_get_stc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmx_demux</span> <span class="o">*</span><span class="n">demux</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span>
		       <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">stc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fwstc</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">tag</span> <span class="o">=</span> <span class="p">((</span><span class="n">COMTYPE_REQUEST</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">ReqSTC</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">dvbdemux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">;</span>

	<span class="cm">/* pointer casting paranoia... */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">demux</span><span class="p">);</span>
	<span class="n">dvbdemux</span> <span class="o">=</span> <span class="n">demux</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dvbdemux</span><span class="p">);</span>
	<span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_request</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fwstc</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: av7110_fw_request error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;fwstc = %04hx %04hx %04hx %04hx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fwstc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fwstc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fwstc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fwstc</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="o">*</span><span class="n">stc</span> <span class="o">=</span>	<span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="p">((</span><span class="n">fwstc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span>  <span class="n">fwstc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">fwstc</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;stc = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">stc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/******************************************************************************</span>
<span class="cm"> * SEC device file operations</span>
<span class="cm"> ******************************************************************************/</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_set_tone</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_tone_mode_t</span> <span class="n">tone</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tone</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_TONE_ON</span>:
		<span class="k">return</span> <span class="n">Set22K</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SEC_TONE_OFF</span>:
		<span class="k">return</span> <span class="n">Set22K</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_diseqc_send_master_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">dvb_diseqc_master_cmd</span><span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">av7110_diseqc_send</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_diseqc_send_burst</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span>
				    <span class="n">fe_sec_mini_cmd_t</span> <span class="n">minicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">av7110_diseqc_send</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">minicmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* simplified code from budget-core.c */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stop_ts_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;budget: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">feeding1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">budget</span><span class="o">-&gt;</span><span class="n">feeding1</span><span class="p">;</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_20</span><span class="p">);</span>	<span class="cm">/* DMA3 off */</span>
	<span class="n">SAA7146_IER_DISABLE</span><span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_10</span><span class="p">);</span>
	<span class="n">SAA7146_ISR_CLEAR</span><span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_10</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_ts_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;budget: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">feeding1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">++</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">feeding1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">grabbing</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TS_BUFLEN</span><span class="p">);</span>
	<span class="n">budget</span><span class="o">-&gt;</span><span class="n">ttbp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAA7146_ISR_CLEAR</span><span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_10</span><span class="p">);</span>  <span class="cm">/* VPE */</span>
	<span class="n">SAA7146_IER_ENABLE</span><span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_10</span><span class="p">);</span> <span class="cm">/* VPE */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_04</span> <span class="o">|</span> <span class="n">MASK_20</span><span class="p">));</span> <span class="cm">/* DMA3 on */</span>
	<span class="k">return</span> <span class="o">++</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">feeding1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_start_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">demux</span> <span class="o">=</span> <span class="n">feed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">budget</span> <span class="o">=</span> <span class="n">demux</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">feedlock1</span><span class="p">);</span>
	<span class="n">feed</span><span class="o">-&gt;</span><span class="n">pusi_seen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* have a clean section start */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">start_ts_capture</span><span class="p">(</span><span class="n">budget</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">feedlock1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_stop_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">demux</span> <span class="o">=</span> <span class="n">feed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">budget</span> <span class="o">=</span> <span class="n">demux</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;budget: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">feedlock1</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">stop_ts_capture</span><span class="p">(</span><span class="n">budget</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">feedlock1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vpeirq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="p">)</span><span class="n">cookie</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">grabbing</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">olddma</span> <span class="o">=</span> <span class="n">budget</span><span class="o">-&gt;</span><span class="n">ttbp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">newdma</span> <span class="o">=</span> <span class="n">saa7146_read</span><span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_VDP3</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">demux</span> <span class="o">=</span> <span class="n">budget</span><span class="o">-&gt;</span><span class="n">full_ts</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">demux</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">demux1</span><span class="p">;</span>

	<span class="cm">/* nearest lower position divisible by 188 */</span>
	<span class="n">newdma</span> <span class="o">-=</span> <span class="n">newdma</span> <span class="o">%</span> <span class="mi">188</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newdma</span> <span class="o">&gt;=</span> <span class="n">TS_BUFLEN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">budget</span><span class="o">-&gt;</span><span class="n">ttbp</span> <span class="o">=</span> <span class="n">newdma</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">feeding1</span> <span class="o">||</span> <span class="p">(</span><span class="n">newdma</span> <span class="o">==</span> <span class="n">olddma</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Ensure streamed PCI data is synced to CPU */</span>
	<span class="n">pci_dma_sync_sg_for_cpu</span><span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">budget</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">slist</span><span class="p">,</span> <span class="n">budget</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* track rps1 activity */</span>
<span class="c">	printk(&quot;vpeirq: %02x Event Counter 1 0x%04x\n&quot;,</span>
<span class="c">	       mem[olddma],</span>
<span class="c">	       saa7146_read(budget-&gt;dev, EC1R) &amp; 0x3fff);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newdma</span> <span class="o">&gt;</span> <span class="n">olddma</span><span class="p">)</span>
		<span class="cm">/* no wraparound, dump olddma..newdma */</span>
		<span class="n">dvb_dmx_swfilter_packets</span><span class="p">(</span><span class="n">demux</span><span class="p">,</span> <span class="n">mem</span> <span class="o">+</span> <span class="n">olddma</span><span class="p">,</span> <span class="p">(</span><span class="n">newdma</span> <span class="o">-</span> <span class="n">olddma</span><span class="p">)</span> <span class="o">/</span> <span class="mi">188</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* wraparound, dump olddma..buflen and 0..newdma */</span>
		<span class="n">dvb_dmx_swfilter_packets</span><span class="p">(</span><span class="n">demux</span><span class="p">,</span> <span class="n">mem</span> <span class="o">+</span> <span class="n">olddma</span><span class="p">,</span> <span class="p">(</span><span class="n">TS_BUFLEN</span> <span class="o">-</span> <span class="n">olddma</span><span class="p">)</span> <span class="o">/</span> <span class="mi">188</span><span class="p">);</span>
		<span class="n">dvb_dmx_swfilter_packets</span><span class="p">(</span><span class="n">demux</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">newdma</span> <span class="o">/</span> <span class="mi">188</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">dvbdemux</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">dvbdemux1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">demux1</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">registered</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">av7110</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">handle2filter</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">filternum</span> <span class="o">=</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">feednum</span> <span class="o">=</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">start_feed</span> <span class="o">=</span> <span class="n">av7110_start_feed</span><span class="p">;</span>
	<span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">stop_feed</span> <span class="o">=</span> <span class="n">av7110_stop_feed</span><span class="p">;</span>
	<span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">write_to_decoder</span> <span class="o">=</span> <span class="n">av7110_write_to_decoder</span><span class="p">;</span>
	<span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="p">(</span><span class="n">DMX_TS_FILTERING</span> <span class="o">|</span> <span class="n">DMX_SECTION_FILTERING</span> <span class="o">|</span>
				      <span class="n">DMX_MEMORY_BASED_FILTERING</span><span class="p">);</span>

	<span class="n">dvb_dmx_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">get_stc</span> <span class="o">=</span> <span class="n">dvb_get_stc</span><span class="p">;</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">filternum</span> <span class="o">=</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">demux</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dvb_dmxdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">);</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">hw_frontend</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">DMX_FRONTEND_0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">add_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">hw_frontend</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">mem_frontend</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">DMX_MEMORY_FE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">add_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">mem_frontend</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">connect_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">hw_frontend</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">av7110_av_register</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="n">av7110_ca_register</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DVB_AV7110_OSD</span>
	<span class="n">dvb_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osd_dev</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">dvbdev_osd</span><span class="p">,</span> <span class="n">av7110</span><span class="p">,</span> <span class="n">DVB_DEVICE_OSD</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">dvb_net_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budgetpatch</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* initialize software demux1 without its own frontend</span>
<span class="cm">		 * demux1 hardware is connected to frontend0 of demux0</span>
<span class="cm">		 */</span>
		<span class="n">dvbdemux1</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">av7110</span><span class="p">;</span>

		<span class="n">dvbdemux1</span><span class="o">-&gt;</span><span class="n">filternum</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">dvbdemux1</span><span class="o">-&gt;</span><span class="n">feednum</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">dvbdemux1</span><span class="o">-&gt;</span><span class="n">start_feed</span> <span class="o">=</span> <span class="n">budget_start_feed</span><span class="p">;</span>
		<span class="n">dvbdemux1</span><span class="o">-&gt;</span><span class="n">stop_feed</span> <span class="o">=</span> <span class="n">budget_stop_feed</span><span class="p">;</span>
		<span class="n">dvbdemux1</span><span class="o">-&gt;</span><span class="n">write_to_decoder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">dvbdemux1</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="p">(</span><span class="n">DMX_TS_FILTERING</span> <span class="o">|</span> <span class="n">DMX_SECTION_FILTERING</span> <span class="o">|</span>
					       <span class="n">DMX_MEMORY_BASED_FILTERING</span><span class="p">);</span>

		<span class="n">dvb_dmx_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">demux1</span><span class="p">);</span>

		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dmxdev1</span><span class="p">.</span><span class="n">filternum</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dmxdev1</span><span class="p">.</span><span class="n">demux</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvbdemux1</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">;</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dmxdev1</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dvb_dmxdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dmxdev1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">);</span>

		<span class="n">dvb_net_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_net1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvbdemux1</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: additional demux1 for budget-patch registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">dvbdemux</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">dvbdemux1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">demux1</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">registered</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budgetpatch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvb_net_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_net1</span><span class="p">);</span>
		<span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvbdemux1</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">);</span>
		<span class="n">dvb_dmxdev_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dmxdev1</span><span class="p">);</span>
		<span class="n">dvb_dmx_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">demux1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dvb_net_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_net</span><span class="p">);</span>

	<span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">);</span>
	<span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">hw_frontend</span><span class="p">);</span>
	<span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvbdemux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">mem_frontend</span><span class="p">);</span>

	<span class="n">dvb_dmxdev_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">);</span>
	<span class="n">dvb_dmx_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvb_unregister_frontend</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
		<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dvb_unregister_device</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osd_dev</span><span class="p">);</span>
	<span class="n">av7110_av_unregister</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="n">av7110_ca_unregister</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * I2C client commands</span>
<span class="cm"> ****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">i2c_writereg</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">;</span>

	<span class="n">msgs</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">id</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">i2c_readreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mm1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">};</span>
	<span class="n">u8</span> <span class="n">mm2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">id</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mm1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">mm1</span><span class="p">;</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">mm2</span><span class="p">;</span>
	<span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mm2</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * INITIALIZATION</span>
<span class="cm"> ****************************************************************************/</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* check for firmware magic */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bin_fw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;A&#39;</span> <span class="o">||</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;V&#39;</span> <span class="o">||</span>
	    <span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;F&#39;</span> <span class="o">||</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;W&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: this is not an av7110 firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* check dpram file */</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: dpram file is way too big.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">!=</span> <span class="n">crc32_le</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: crc32 of dpram file does not match.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bin_dpram</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">size_dpram</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* check root file */</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">200000</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">300000</span> <span class="o">||</span>
	    <span class="n">len</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bin_fw</span> <span class="o">+</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">size_fw</span><span class="p">)</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: root file has strange size (%d). aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">crc</span> <span class="o">!=</span> <span class="n">crc32_le</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: crc32 of root file does not match.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bin_root</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">size_root</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bin_fw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>

	<span class="cm">/* request the av7110 firmware, this will block until someone uploads it */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="s">&quot;dvb-ttpci-01.fw&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: could not load firmware,&quot;</span>
			       <span class="s">&quot; file not found: dvb-ttpci-01.fw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: usually this should be in &quot;</span>
			       <span class="s">&quot;/usr/lib/hotplug/firmware or /lib/firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: and can be downloaded from&quot;</span>
			       <span class="s">&quot; http://www.linuxtv.org/download/dvb/firmware/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: cannot request firmware&quot;</span>
			       <span class="s">&quot; (error %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: this firmware is way too small.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if the firmware is available */</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bin_fw</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bin_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bin_fw</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">size_fw</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">check_firmware</span><span class="p">(</span><span class="n">av7110</span><span class="p">)))</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bin_fw</span><span class="p">);</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_bsrv2_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pwr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">479500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">125</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="mi">2000000</span><span class="p">)</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="mi">1800000</span><span class="p">)</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="mi">1600000</span><span class="p">)</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="mi">1200000</span><span class="p">)</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;=</span> <span class="mi">1100000</span><span class="p">)</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0x18000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x95</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pwr</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x30</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>NOTE: since we're using a prescaler of 2, we set the
divisor frequency to 62.5kHz and divide by 125 above</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ves1x93_config</span> <span class="n">alps_bsrv2_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xin</span> <span class="o">=</span> <span class="mi">90100000UL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert_pwm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_tdbe2_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x62</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">};</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">35937500</span> <span class="o">+</span> <span class="mi">31250</span><span class="p">)</span> <span class="o">/</span> <span class="mi">62500</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x85</span> <span class="o">|</span> <span class="p">((</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">174000000</span> <span class="o">?</span> <span class="mh">0x88</span> <span class="o">:</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">470000000</span> <span class="o">?</span> <span class="mh">0x84</span> <span class="o">:</span> <span class="mh">0x81</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ves1820_config</span> <span class="n">alps_tdbe2_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xin</span> <span class="o">=</span> <span class="mi">57840000UL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">selagc</span> <span class="o">=</span> <span class="n">VES1820_SELAGC_SIGNAMPERR</span><span class="p">,</span>
<span class="p">};</span>




<span class="k">static</span> <span class="kt">int</span> <span class="nf">grundig_29504_451_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">};</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">125</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8e</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda8083_config</span> <span class="n">grundig_29504_451_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
<span class="p">};</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">philips_cd1516_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">};</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="mi">36125000</span> <span class="o">+</span> <span class="mi">31250</span><span class="p">)</span> <span class="o">/</span> <span class="mi">62500</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8e</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">&lt;</span> <span class="mi">174000000</span> <span class="o">?</span> <span class="mh">0xa1</span> <span class="o">:</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="mi">470000000</span> <span class="o">?</span> <span class="mh">0x92</span> <span class="o">:</span> <span class="mh">0x34</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ves1820_config</span> <span class="n">philips_cd1516_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xin</span> <span class="o">=</span> <span class="mi">57840000UL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">selagc</span> <span class="o">=</span> <span class="n">VES1820_SELAGC_SIGNAMPERR</span><span class="p">,</span>
<span class="p">};</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_tdlb7_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">,</span> <span class="n">pwr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">};</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">36200000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">166666</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;=</span> <span class="mi">782000000</span><span class="p">)</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x85</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwr</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_tdlb7_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">fw</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_DVB_SP8870) || defined(CONFIG_DVB_SP8870_MODULE)</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">request_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sp8870_config</span> <span class="n">alps_tdlb7_config</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x71</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_firmware</span> <span class="o">=</span> <span class="n">alps_tdlb7_request_firmware</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="n">u8</span> <span class="n">nexusca_stv0297_inittab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span>
	<span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span>
	<span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span>
	<span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span>
	<span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x44</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span>
	<span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span>
	<span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span>
	<span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span>
	<span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span>
	<span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span>
	<span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span>
	<span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
	<span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span>
	<span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span>
	<span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span>
	<span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span>
	<span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span>
	<span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span>
	<span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span>
	<span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span>
	<span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nexusca_stv0297_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x63</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">readmsg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x63</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">36150000</span> <span class="o">+</span> <span class="mi">31250</span><span class="p">)</span> <span class="o">/</span> <span class="mi">62500</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xce</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">45000000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">137000000</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">403000000</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">860000000</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nexusca: pll transfer failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>wait for PLL lock</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readmsg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0297_config</span> <span class="n">nexusca_stv0297_config</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x1C</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inittab</span> <span class="o">=</span> <span class="n">nexusca_stv0297_inittab</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_during_read</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">grundig_29504_401_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">cpump</span><span class="p">,</span> <span class="n">band_select</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">};</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="mi">36125000</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">)</span> <span class="o">/</span> <span class="mi">166666</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">175000000</span><span class="p">)</span>
		<span class="n">cpump</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">390000000</span><span class="p">)</span>
		<span class="n">cpump</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">470000000</span><span class="p">)</span>
		<span class="n">cpump</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">750000000</span><span class="p">)</span>
		<span class="n">cpump</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cpump</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">175000000</span><span class="p">)</span>
		<span class="n">band_select</span> <span class="o">=</span> <span class="mh">0x0e</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">470000000</span><span class="p">)</span>
		<span class="n">band_select</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">band_select</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">|</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpump</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">band_select</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">l64781_config</span> <span class="n">grundig_29504_401_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">,</span>
<span class="p">};</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_fe_lock_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">synced</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_synced</span> <span class="o">==</span> <span class="n">synced</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_synced</span> <span class="o">=</span> <span class="n">synced</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pid_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synced</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SetPIDs</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_VIDEO</span><span class="p">],</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_AUDIO</span><span class="p">],</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_TELETEXT</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_PCR</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_PIDFILTER</span><span class="p">,</span> <span class="n">Scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SetPIDs</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_PID_FILTER</span><span class="p">,</span> <span class="n">FlushTSQueue</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_wait_msgstate</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">GPMQBusy</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_synced</span> <span class="o">=</span> <span class="n">synced</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pid_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_fe_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fe_lock_fix</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_set_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_fe_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fe_lock_fix</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_init</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_fe_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span><span class="o">*</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* call the real implementation */</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_read_status</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">status</span> <span class="o">^</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fe_lock_fix</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="o">*</span><span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_fe_diseqc_reset_overload</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fe_lock_fix</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_diseqc_reset_overload</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_fe_diseqc_send_master_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">dvb_diseqc_master_cmd</span><span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fe_lock_fix</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">saved_master_cmd</span> <span class="o">=</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_diseqc_send_master_cmd</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_fe_diseqc_send_burst</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_mini_cmd_t</span> <span class="n">minicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fe_lock_fix</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">saved_minicmd</span> <span class="o">=</span> <span class="n">minicmd</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_diseqc_send_burst</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">minicmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_fe_set_tone</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_tone_mode_t</span> <span class="n">tone</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fe_lock_fix</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">saved_tone</span> <span class="o">=</span> <span class="n">tone</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_set_tone</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">tone</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_fe_set_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_voltage_t</span> <span class="n">voltage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fe_lock_fix</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">saved_voltage</span> <span class="o">=</span> <span class="n">voltage</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_set_voltage</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">voltage</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_fe_dishnetwork_send_legacy_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fe_lock_fix</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_dishnetwork_send_legacy_command</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_s_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">av7110_fe_init</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>

	<span class="n">av7110_fe_set_voltage</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">saved_voltage</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">saved_master_cmd</span><span class="p">.</span><span class="n">msg_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">av7110_fe_diseqc_send_master_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">saved_master_cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">av7110_fe_diseqc_send_burst</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">saved_minicmd</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">av7110_fe_set_tone</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">saved_tone</span><span class="p">);</span>

	<span class="n">av7110_fe_set_frontend</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">read_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span><span class="o">*</span> <span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pwm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">,.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
				 <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">,.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pwm</span><span class="p">,.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">}</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pwm</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">))</span>
		<span class="n">pwm</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pwm</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">frontend_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x110a</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0000</span>: <span class="c1">// Fujitsu/Siemens DVB-Cable (ves1820/Philips CD1516(??))</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">ves1820_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">philips_cd1516_config</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">read_pwm</span><span class="p">(</span><span class="n">av7110</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">philips_cd1516_tuner_set_params</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x13c2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0000</span>: <span class="c1">// Hauppauge/TT WinTV DVB-S rev1.X</span>
		<span class="k">case</span> <span class="mh">0x0003</span>: <span class="c1">// Hauppauge/TT WinTV Nexus-S Rev 2.X</span>
		<span class="k">case</span> <span class="mh">0x1002</span>: <span class="c1">// Hauppauge/TT WinTV DVB-S rev1.3SE</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>try the ALPS BSRV2 first of all</p></td><td class="code"><div class="highlight"><pre>			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">ves1x93_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alps_bsrv2_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">alps_bsrv2_tuner_set_params</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_master_cmd</span> <span class="o">=</span> <span class="n">av7110_diseqc_send_master_cmd</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_burst</span> <span class="o">=</span> <span class="n">av7110_diseqc_send_burst</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_tone</span> <span class="o">=</span> <span class="n">av7110_set_tone</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">recover</span> <span class="o">=</span> <span class="n">dvb_s_recover</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>try the ALPS BSRU6 now</p></td><td class="code"><div class="highlight"><pre>			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0299_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alps_bsru6_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">alps_bsru6_tuner_set_params</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">;</span>

				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_master_cmd</span> <span class="o">=</span> <span class="n">av7110_diseqc_send_master_cmd</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_burst</span> <span class="o">=</span> <span class="n">av7110_diseqc_send_burst</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_tone</span> <span class="o">=</span> <span class="n">av7110_set_tone</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">recover</span> <span class="o">=</span> <span class="n">dvb_s_recover</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Try the grundig 29504-451</p></td><td class="code"><div class="highlight"><pre>			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda8083_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grundig_29504_451_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">grundig_29504_451_tuner_set_params</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_master_cmd</span> <span class="o">=</span> <span class="n">av7110_diseqc_send_master_cmd</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_burst</span> <span class="o">=</span> <span class="n">av7110_diseqc_send_burst</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_tone</span> <span class="o">=</span> <span class="n">av7110_set_tone</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">recover</span> <span class="o">=</span> <span class="n">dvb_s_recover</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Try DVB-C cards */</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x0000</span>:
				<span class="cm">/* Siemens DVB-C (full-length card) VES1820/Philips CD1516 */</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">ves1820_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">philips_cd1516_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
							<span class="n">read_pwm</span><span class="p">(</span><span class="n">av7110</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">philips_cd1516_tuner_set_params</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x0003</span>:
				<span class="cm">/* Hauppauge DVB-C 2.1 VES1820/ALPS TDBE2 */</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">ves1820_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alps_tdbe2_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
							<span class="n">read_pwm</span><span class="p">(</span><span class="n">av7110</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">alps_tdbe2_tuner_set_params</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x0001</span>: <span class="c1">// Hauppauge/TT Nexus-T premium rev1.X</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>try ALPS TDLB7 first, then Grundig 29504-401</p></td><td class="code"><div class="highlight"><pre>			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">sp8870_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alps_tdlb7_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">alps_tdlb7_tuner_set_params</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fall-thru */</span>

		<span class="k">case</span> <span class="mh">0x0008</span>: <span class="c1">// Hauppauge/TT DVB-T</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Grundig 29504-401</p></td><td class="code"><div class="highlight"><pre>			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">l64781_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grundig_29504_401_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">grundig_29504_401_tuner_set_params</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x0002</span>: <span class="c1">// Hauppauge/TT DVB-C premium rev2.X</span>

			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">ves1820_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alps_tdbe2_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">read_pwm</span><span class="p">(</span><span class="n">av7110</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">alps_tdbe2_tuner_set_params</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x0004</span>: <span class="c1">// Galaxis DVB-S rev1.3</span>
			<span class="cm">/* ALPS BSRV2 */</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">ves1x93_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alps_bsrv2_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">alps_bsrv2_tuner_set_params</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_master_cmd</span> <span class="o">=</span> <span class="n">av7110_diseqc_send_master_cmd</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_burst</span> <span class="o">=</span> <span class="n">av7110_diseqc_send_burst</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_tone</span> <span class="o">=</span> <span class="n">av7110_set_tone</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">recover</span> <span class="o">=</span> <span class="n">dvb_s_recover</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x0006</span>: <span class="cm">/* Fujitsu-Siemens DVB-S rev 1.6 */</span>
			<span class="cm">/* Grundig 29504-451 */</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda8083_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grundig_29504_451_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">grundig_29504_451_tuner_set_params</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_master_cmd</span> <span class="o">=</span> <span class="n">av7110_diseqc_send_master_cmd</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_burst</span> <span class="o">=</span> <span class="n">av7110_diseqc_send_burst</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_tone</span> <span class="o">=</span> <span class="n">av7110_set_tone</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">recover</span> <span class="o">=</span> <span class="n">dvb_s_recover</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x000A</span>: <span class="c1">// Hauppauge/TT Nexus-CA rev1.X</span>

			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0297_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nexusca_stv0297_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">nexusca_stv0297_tuner_set_params</span><span class="p">;</span>

				<span class="cm">/* set TDA9819 into DVB mode */</span>
				<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span> <span class="c1">// TDA9819 pin9(STD)</span>
				<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span> <span class="c1">// TDA9819 pin30(VIF)</span>

				<span class="cm">/* tuner on this needs a slower i2c bus speed */</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bitrate</span> <span class="o">=</span> <span class="n">SAA7146_I2C_BUS_BIT_RATE_240</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x000E</span>: <span class="cm">/* Hauppauge/TT Nexus-S rev 2.3 */</span>
			<span class="cm">/* ALPS BSBE1 */</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0299_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alps_bsbe1_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">alps_bsbe1_tuner_set_params</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">lnbp21_attach</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: LNBP21 not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">)</span>
						<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
					<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">dishnetwork_send_legacy_command</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">recover</span> <span class="o">=</span> <span class="n">dvb_s_recover</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME: propagate the failure code from the lower layers */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: A frontend driver was not found for device [%04x:%04x] subsystem [%04x:%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
		       <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		       <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
		       <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">FE_FUNC_OVERRIDE</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">init</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_init</span><span class="p">,</span> <span class="n">av7110_fe_init</span><span class="p">);</span>
		<span class="n">FE_FUNC_OVERRIDE</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_status</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_read_status</span><span class="p">,</span> <span class="n">av7110_fe_read_status</span><span class="p">);</span>
		<span class="n">FE_FUNC_OVERRIDE</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_reset_overload</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_diseqc_reset_overload</span><span class="p">,</span> <span class="n">av7110_fe_diseqc_reset_overload</span><span class="p">);</span>
		<span class="n">FE_FUNC_OVERRIDE</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_master_cmd</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_diseqc_send_master_cmd</span><span class="p">,</span> <span class="n">av7110_fe_diseqc_send_master_cmd</span><span class="p">);</span>
		<span class="n">FE_FUNC_OVERRIDE</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_burst</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_diseqc_send_burst</span><span class="p">,</span> <span class="n">av7110_fe_diseqc_send_burst</span><span class="p">);</span>
		<span class="n">FE_FUNC_OVERRIDE</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_tone</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_set_tone</span><span class="p">,</span> <span class="n">av7110_fe_set_tone</span><span class="p">);</span>
		<span class="n">FE_FUNC_OVERRIDE</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_voltage</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_set_voltage</span><span class="p">,</span> <span class="n">av7110_fe_set_voltage</span><span class="p">);</span>
		<span class="n">FE_FUNC_OVERRIDE</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">dishnetwork_send_legacy_command</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_dishnetwork_send_legacy_command</span><span class="p">,</span> <span class="n">av7110_fe_dishnetwork_send_legacy_command</span><span class="p">);</span>
		<span class="n">FE_FUNC_OVERRIDE</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_frontend</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe_set_frontend</span><span class="p">,</span> <span class="n">av7110_fe_set_frontend</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_register_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;av7110: Frontend registration failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Budgetpatch note:</span>
<span class="cm"> * Original hardware design by Roberto Deza:</span>
<span class="cm"> * There is a DVB_Wiki at</span>
<span class="cm"> * http://www.linuxtv.org/</span>
<span class="cm"> *</span>
<span class="cm"> * New software triggering design by Emard that works on</span>
<span class="cm"> * original Roberto Deza&#39;s hardware:</span>
<span class="cm"> *</span>
<span class="cm"> * rps1 code for budgetpatch will copy internal HS event to GPIO3 pin.</span>
<span class="cm"> * GPIO3 is in budget-patch hardware connectd to port B VSYNC</span>
<span class="cm"> * HS is an internal event of 7146, accessible with RPS</span>
<span class="cm"> * and temporarily raised high every n lines</span>
<span class="cm"> * (n in defined in the RPS_THRESH1 counter threshold)</span>
<span class="cm"> * I think HS is raised high on the beginning of the n-th line</span>
<span class="cm"> * and remains high until this n-th line that triggered</span>
<span class="cm"> * it is completely received. When the receiption of n-th line</span>
<span class="cm"> * ends, HS is lowered.</span>
<span class="cm"> *</span>
<span class="cm"> * To transmit data over DMA, 7146 needs changing state at</span>
<span class="cm"> * port B VSYNC pin. Any changing of port B VSYNC will</span>
<span class="cm"> * cause some DMA data transfer, with more or less packets loss.</span>
<span class="cm"> * It depends on the phase and frequency of VSYNC and</span>
<span class="cm"> * the way of 7146 is instructed to trigger on port B (defined</span>
<span class="cm"> * in DD1_INIT register, 3rd nibble from the right valid</span>
<span class="cm"> * numbers are 0-7, see datasheet)</span>
<span class="cm"> *</span>
<span class="cm"> * The correct triggering can minimize packet loss,</span>
<span class="cm"> * dvbtraffic should give this stable bandwidths:</span>
<span class="cm"> *   22k transponder = 33814 kbit/s</span>
<span class="cm"> * 27.5k transponder = 38045 kbit/s</span>
<span class="cm"> * by experiment it is found that the best results</span>
<span class="cm"> * (stable bandwidths and almost no packet loss)</span>
<span class="cm"> * are obtained using DD1_INIT triggering number 2</span>
<span class="cm"> * (Va at rising edge of VS Fa = HS x VS-failing forced toggle)</span>
<span class="cm"> * and a VSYNC phase that occurs in the middle of DMA transfer</span>
<span class="cm"> * (about byte 188*512=96256 in the DMA window).</span>
<span class="cm"> *</span>
<span class="cm"> * Phase of HS is still not clear to me how to control,</span>
<span class="cm"> * It just happens to be so. It can be seen if one enables</span>
<span class="cm"> * RPS_IRQ and print Event Counter 1 in vpeirq(). Every</span>
<span class="cm"> * time RPS_INTERRUPT is called, the Event Counter 1 will</span>
<span class="cm"> * increment. That&#39;s how the 7146 is programmed to do event</span>
<span class="cm"> * counting in this budget-patch.c</span>
<span class="cm"> * I *think* HPS setting has something to do with the phase</span>
<span class="cm"> * of HS but I can&#39;t be 100% sure in that.</span>
<span class="cm"> *</span>
<span class="cm"> * hardware debug note: a working budget card (including budget patch)</span>
<span class="cm"> * with vpeirq() interrupt setup in mode &quot;0x90&quot; (every 64K) will</span>
<span class="cm"> * generate 3 interrupts per 25-Hz DMA frame of 2*188*512 bytes</span>
<span class="cm"> * and that means 3*25=75 Hz of interrupt freqency, as seen by</span>
<span class="cm"> * watch cat /proc/interrupts</span>
<span class="cm"> *</span>
<span class="cm"> * If this frequency is 3x lower (and data received in the DMA</span>
<span class="cm"> * buffer don&#39;t start with 0x47, but in the middle of packets,</span>
<span class="cm"> * whose lengths appear to be like 188 292 188 104 etc.</span>
<span class="cm"> * this means VSYNC line is not connected in the hardware.</span>
<span class="cm"> * (check soldering pcb and pins)</span>
<span class="cm"> * The same behaviour of missing VSYNC can be duplicated on budget</span>
<span class="cm"> * cards, by seting DD1_INIT trigger mode 7 in 3rd nibble.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">av7110_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">saa7146_pci_extension_data</span> <span class="o">*</span><span class="n">pci_ext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">TS_WIDTH</span> <span class="o">*</span> <span class="n">TS_HEIGHT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="kr">thread</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;dev: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Set RPS_IRQ to 1 to track rps1 activity.</span>
<span class="cm">	 * Enabling this won&#39;t send any interrupt to PC CPU.</span>
<span class="cm">	 */</span>
<span class="cp">#define RPS_IRQ 0</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budgetpatch</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">budgetpatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* autodetect the presence of budget patch</span>
<span class="cm">		 * this only works if saa7146 has been recently</span>
<span class="cm">		 * reset with with MASK_31 to MC1</span>
<span class="cm">		 *</span>
<span class="cm">		 * will wait for VBI_B event (vertical blank at port B)</span>
<span class="cm">		 * and will reset GPIO3 after VBI_B is detected.</span>
<span class="cm">		 * (GPIO3 should be raised high by CPU to</span>
<span class="cm">		 * test if GPIO3 will generate vertical blank signal</span>
<span class="cm">		 * in budget patch GPIO3 is connected to VSYNC_B</span>
<span class="cm">		 */</span>

		<span class="cm">/* RESET SAA7146 */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_31</span><span class="p">);</span>
		<span class="cm">/* autodetection success seems to be time-dependend after reset */</span>

		<span class="cm">/* Fix VSYNC level */</span>
		<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
		<span class="cm">/* set vsync_b triggering */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_STREAM_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* port B VSYNC at rising edge */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_INIT</span><span class="p">,</span> <span class="mh">0x00000200</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BRS_CTRL</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>  <span class="c1">// VBI</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span>
			      <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">MASK_08</span> <span class="o">|</span> <span class="n">MASK_24</span><span class="p">)</span>  <span class="o">|</span>   <span class="c1">// BRS control</span>
			      <span class="mi">0</span> <span class="o">*</span> <span class="p">(</span><span class="n">MASK_09</span> <span class="o">|</span> <span class="n">MASK_25</span><span class="p">)</span>  <span class="o">|</span>   <span class="c1">// a</span>
			      <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">MASK_10</span> <span class="o">|</span> <span class="n">MASK_26</span><span class="p">)</span>  <span class="o">|</span>   <span class="c1">// b</span>
			      <span class="mi">0</span> <span class="o">*</span> <span class="p">(</span><span class="n">MASK_06</span> <span class="o">|</span> <span class="n">MASK_22</span><span class="p">)</span>  <span class="o">|</span>   <span class="c1">// HPS_CTRL1</span>
			      <span class="mi">0</span> <span class="o">*</span> <span class="p">(</span><span class="n">MASK_05</span> <span class="o">|</span> <span class="n">MASK_21</span><span class="p">)</span>  <span class="o">|</span>   <span class="c1">// HPS_CTRL2</span>
			      <span class="mi">0</span> <span class="o">*</span> <span class="p">(</span><span class="n">MASK_01</span> <span class="o">|</span> <span class="n">MASK_15</span><span class="p">)</span>      <span class="c1">// DEBI</span>
		<span class="p">);</span>

		<span class="cm">/* start writing RPS1 code from beginning */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Disable RPS1 */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_29</span><span class="p">);</span>
		<span class="cm">/* RPS1 timeout disable */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPS_TOV1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_PAUSE</span> <span class="o">|</span> <span class="n">EVT_VBI_B</span><span class="p">);</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_WR_REG_MASK</span> <span class="o">|</span> <span class="p">(</span><span class="n">GPIO_CTRL</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">));</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">GPIO3_MSK</span><span class="p">);</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">SAA7146_GPIO_OUTLO</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">);</span>
<span class="cp">#if RPS_IRQ</span>
		<span class="cm">/* issue RPS1 interrupt to increment counter */</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_STOP</span><span class="p">);</span>
		<span class="cm">/* Jump to begin of RPS program as safety measure               (p37) */</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_JUMP</span><span class="p">);</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">d_rps1</span><span class="p">.</span><span class="n">dma_handle</span><span class="p">);</span>

<span class="cp">#if RPS_IRQ</span>
		<span class="cm">/* set event counter 1 source as RPS1 interrupt (0x03)          (rE4 p53)</span>
<span class="cm">		 * use 0x03 to track RPS1 interrupts - increase by 1 every gpio3 is toggled</span>
<span class="cm">		 * use 0x15 to track VPE  interrupts - increase by 1 every vpeirq() is called</span>
<span class="cm">		 */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EC1SSR</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x03</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">3</span> <span class="p">);</span>
		<span class="cm">/* set event counter 1 threshold to maximum allowed value        (rEC p55) */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ECT1R</span><span class="p">,</span>  <span class="mh">0x3fff</span> <span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* Set RPS1 Address register to point to RPS code               (r108 p42) */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPS_ADDR1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">d_rps1</span><span class="p">.</span><span class="n">dma_handle</span><span class="p">);</span>
		<span class="cm">/* Enable RPS1,                                                 (rFC p33) */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_13</span> <span class="o">|</span> <span class="n">MASK_29</span> <span class="p">));</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="cm">/* now send VSYNC_B to rps1 by rising GPIO3 */</span>
		<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="cm">/* if rps1 responded by lowering the GPIO3,</span>
<span class="cm">		 * then we have budgetpatch hardware</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">saa7146_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GPIO_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10000000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">budgetpatch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: BUDGET-PATCH DETECTED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Disable RPS1 */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="p">(</span> <span class="n">MASK_29</span> <span class="p">));</span>
<span class="cp">#if RPS_IRQ</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: Event Counter 1 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saa7146_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EC1R</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span> <span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* prepare the av7110 device struct */</span>
	<span class="n">av7110</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">pci_ext</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span> <span class="o">=</span> <span class="n">av7110</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_firmware</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_kfree_0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_register_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span>
				   <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_put_firmware_1</span><span class="p">;</span>

	<span class="cm">/* the Siemens DVB needs this if you want to have the i2c chips</span>
<span class="cm">	   get recognized before the main driver is fully loaded */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GPIO_CTRL</span><span class="p">,</span> <span class="mh">0x500000</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_ext</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>

	<span class="n">saa7146_i2c_adapter_prepare</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">SAA7146_I2C_BUS_BIT_RATE_120</span><span class="p">);</span> <span class="cm">/* 275 kHz */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_add_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_dvb_unregister_adapter_2</span><span class="p">;</span>

	<span class="n">ttpci_eeprom_parse_mac</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
			       <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">proposed_mac</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* full-ts mod? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">full_ts</span><span class="p">)</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* check for full-ts flag in eeprom */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_readreg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4f</span> <span class="o">&amp;&amp;</span> <span class="n">i2c_readreg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x45</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">i2c_readreg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;dvb-ttpci: full-ts mode enabled for saa7146 port B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">feedlock1</span><span class="p">);</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">grabbing</span> <span class="o">=</span> <span class="n">saa7146_vmalloc_build_pgtable</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
								 <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">grabbing</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_i2c_del_3</span><span class="p">;</span>

		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_STREAM_B</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_10</span> <span class="o">|</span> <span class="n">MASK_26</span><span class="p">));</span>

		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_INIT</span><span class="p">,</span> <span class="mh">0x00000600</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_09</span> <span class="o">|</span> <span class="n">MASK_25</span> <span class="o">|</span> <span class="n">MASK_10</span> <span class="o">|</span> <span class="n">MASK_26</span><span class="p">));</span>

		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BRS_CTRL</span><span class="p">,</span> <span class="mh">0x60000000</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="n">MASK_08</span> <span class="o">|</span> <span class="n">MASK_24</span><span class="p">);</span>

		<span class="cm">/* dma3 */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BT_V1</span><span class="p">,</span> <span class="mh">0x001c0000</span> <span class="o">|</span> <span class="p">(</span><span class="n">saa7146_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BT_V1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x001f0000</span><span class="p">));</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BASE_ODD3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BASE_EVEN3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PROT_ADDR3</span><span class="p">,</span> <span class="n">TS_WIDTH</span> <span class="o">*</span> <span class="n">TS_HEIGHT</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PITCH3</span><span class="p">,</span> <span class="n">TS_WIDTH</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BASE_PAGE3</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">dma</span> <span class="o">|</span> <span class="n">ME1</span> <span class="o">|</span> <span class="mh">0x90</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NUM_LINE_BYTE3</span><span class="p">,</span> <span class="p">(</span><span class="n">TS_HEIGHT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">TS_WIDTH</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="n">MASK_04</span> <span class="o">|</span> <span class="n">MASK_20</span><span class="p">);</span>

		<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">vpe_tasklet</span><span class="p">,</span> <span class="n">vpeirq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">budgetpatch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">feedlock1</span><span class="p">);</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">grabbing</span> <span class="o">=</span> <span class="n">saa7146_vmalloc_build_pgtable</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
								 <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">grabbing</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_i2c_del_3</span><span class="p">;</span>

		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BT_V1</span><span class="p">,</span> <span class="mh">0x1c1f101f</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BCS_CTRL</span><span class="p">,</span> <span class="mh">0x80400040</span><span class="p">);</span>
		<span class="cm">/* set dd1 stream a &amp; b */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_STREAM_B</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_INIT</span><span class="p">,</span> <span class="mh">0x03000200</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_09</span> <span class="o">|</span> <span class="n">MASK_25</span> <span class="o">|</span> <span class="n">MASK_10</span> <span class="o">|</span> <span class="n">MASK_26</span><span class="p">));</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BRS_CTRL</span><span class="p">,</span> <span class="mh">0x60000000</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BASE_ODD3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BASE_EVEN3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PROT_ADDR3</span><span class="p">,</span> <span class="n">TS_WIDTH</span> <span class="o">*</span> <span class="n">TS_HEIGHT</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BASE_PAGE3</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">dma</span> <span class="o">|</span> <span class="n">ME1</span> <span class="o">|</span> <span class="mh">0x90</span><span class="p">);</span>

		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PITCH3</span><span class="p">,</span> <span class="n">TS_WIDTH</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NUM_LINE_BYTE3</span><span class="p">,</span> <span class="p">(</span><span class="n">TS_HEIGHT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">TS_WIDTH</span><span class="p">);</span>

		<span class="cm">/* upload all */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="mh">0x077c077c</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GPIO_CTRL</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">);</span>
<span class="cp">#if RPS_IRQ</span>
		<span class="cm">/* set event counter 1 source as RPS1 interrupt (0x03)          (rE4 p53)</span>
<span class="cm">		 * use 0x03 to track RPS1 interrupts - increase by 1 every gpio3 is toggled</span>
<span class="cm">		 * use 0x15 to track VPE  interrupts - increase by 1 every vpeirq() is called</span>
<span class="cm">		 */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EC1SSR</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x03</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">3</span> <span class="p">);</span>
		<span class="cm">/* set event counter 1 threshold to maximum allowed value        (rEC p55) */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ECT1R</span><span class="p">,</span>  <span class="mh">0x3fff</span> <span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* Setup BUDGETPATCH MAIN RPS1 &quot;program&quot; (p35) */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Wait Source Line Counter Threshold                           (p36) */</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_PAUSE</span> <span class="o">|</span> <span class="n">EVT_HS</span><span class="p">);</span>
		<span class="cm">/* Set GPIO3=1                                                  (p42) */</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_WR_REG_MASK</span> <span class="o">|</span> <span class="p">(</span><span class="n">GPIO_CTRL</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">));</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">GPIO3_MSK</span><span class="p">);</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">SAA7146_GPIO_OUTHI</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">);</span>
<span class="cp">#if RPS_IRQ</span>
		<span class="cm">/* issue RPS1 interrupt */</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* Wait reset Source Line Counter Threshold                     (p36) */</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_PAUSE</span> <span class="o">|</span> <span class="n">RPS_INV</span> <span class="o">|</span> <span class="n">EVT_HS</span><span class="p">);</span>
		<span class="cm">/* Set GPIO3=0                                                  (p42) */</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_WR_REG_MASK</span> <span class="o">|</span> <span class="p">(</span><span class="n">GPIO_CTRL</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">));</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">GPIO3_MSK</span><span class="p">);</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">SAA7146_GPIO_OUTLO</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">);</span>
<span class="cp">#if RPS_IRQ</span>
		<span class="cm">/* issue RPS1 interrupt */</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* Jump to begin of RPS program                                 (p37) */</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_JUMP</span><span class="p">);</span>
		<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">d_rps1</span><span class="p">.</span><span class="n">dma_handle</span><span class="p">);</span>

		<span class="cm">/* Fix VSYNC level */</span>
		<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
		<span class="cm">/* Set RPS1 Address register to point to RPS code               (r108 p42) */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPS_ADDR1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">d_rps1</span><span class="p">.</span><span class="n">dma_handle</span><span class="p">);</span>
		<span class="cm">/* Set Source Line Counter Threshold, using BRS                 (rCC p43)</span>
<span class="cm">		 * It generates HS event every TS_HEIGHT lines</span>
<span class="cm">		 * this is related to TS_WIDTH set in register</span>
<span class="cm">		 * NUM_LINE_BYTE3. If NUM_LINE_BYTE low 16 bits</span>
<span class="cm">		 * are set to TS_WIDTH bytes (TS_WIDTH=2*188),</span>
<span class="cm">		 * then RPS_THRESH1 should be set to trigger</span>
<span class="cm">		 * every TS_HEIGHT (512) lines.</span>
<span class="cm">		 */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPS_THRESH1</span><span class="p">,</span> <span class="p">(</span><span class="n">TS_HEIGHT</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">MASK_12</span> <span class="p">);</span>

		<span class="cm">/* Enable RPS1                                                  (rFC p33) */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_13</span> <span class="o">|</span> <span class="n">MASK_29</span><span class="p">));</span>

		<span class="cm">/* end of budgetpatch register initialization */</span>
		<span class="n">tasklet_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">vpe_tasklet</span><span class="p">,</span>  <span class="n">vpeirq</span><span class="p">,</span>  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">av7110</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BT_V1</span><span class="p">,</span> <span class="mh">0x1c00101f</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BCS_CTRL</span><span class="p">,</span> <span class="mh">0x80400040</span><span class="p">);</span>

		<span class="cm">/* set dd1 stream a &amp; b */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_STREAM_B</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_INIT</span><span class="p">,</span> <span class="mh">0x03000000</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_09</span> <span class="o">|</span> <span class="n">MASK_25</span> <span class="o">|</span> <span class="n">MASK_10</span> <span class="o">|</span> <span class="n">MASK_26</span><span class="p">));</span>

		<span class="cm">/* upload all */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="mh">0x077c077c</span><span class="p">);</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GPIO_CTRL</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tasklet_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_tasklet</span><span class="p">,</span> <span class="n">debiirq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">av7110</span><span class="p">);</span>
	<span class="n">tasklet_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">gpio_tasklet</span><span class="p">,</span> <span class="n">gpioirq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pid_mutex</span><span class="p">);</span>

	<span class="cm">/* locks for data transfers from/to AV7110 */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debilock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debitype</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* default OSD window */</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osd_mutex</span><span class="p">);</span>

	<span class="cm">/* TV standard */</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">vidmode</span> <span class="o">=</span> <span class="n">tv_standard</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">AV7110_VIDEO_MODE_NTSC</span>
					   <span class="o">:</span> <span class="n">AV7110_VIDEO_MODE_PAL</span><span class="p">;</span>

	<span class="cm">/* ARM &quot;watchdog&quot; */</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_wait</span><span class="p">);</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* allocate and init buffers */</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">8192</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_saa71466_vfree_4</span><span class="p">;</span>


	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">iobuf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">AVOUTLEN</span><span class="o">+</span><span class="n">AOUTLEN</span><span class="o">+</span><span class="n">BMPLEN</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">IPACKS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pci_free_5</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_av_init</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_iobuf_vfree_6</span><span class="p">;</span>

	<span class="cm">/* init BMP buffer */</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmpbuf</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="o">+</span><span class="n">AVOUTLEN</span><span class="o">+</span><span class="n">AOUTLEN</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmpq</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_ca_init</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_av7110_av_exit_7</span><span class="p">;</span>

	<span class="cm">/* load firmware into AV7110 cards */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_bootarm</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_av7110_ca_exit_8</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_firmversion</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_stop_arm_9</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FW_VERSION</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">)</span><span class="o">&lt;</span><span class="mh">0x2501</span><span class="p">)</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;dvb-ttpci: Warning, firmware version 0x%04x is too old. &quot;</span>
			<span class="s">&quot;System might be unstable!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FW_VERSION</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">));</span>

	<span class="kr">thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">arm_thread</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">av7110</span><span class="p">,</span> <span class="s">&quot;arm_mon&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="kr">thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_stop_arm_9</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_thread</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">;</span>

	<span class="cm">/* set initial volume in mixer struct */</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">.</span><span class="n">volume_left</span>  <span class="o">=</span> <span class="n">volume</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">.</span><span class="n">volume_right</span> <span class="o">=</span> <span class="n">volume</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_register</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_arm_thread_stop_10</span><span class="p">;</span>

	<span class="n">init_av7110_av</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>

	<span class="cm">/* special case DVB-C: these cards have an analog tuner</span>
<span class="cm">	   plus need some special handling, so we have separate</span>
<span class="cm">	   saa7146_ext_vv data for these... */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_init_v4l</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_av7110_unregister_11</span><span class="p">;</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">av7110</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">frontend_init</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_av7110_exit_v4l_12</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_INPUT_EVDEV) || defined(CONFIG_INPUT_EVDEV_MODULE)</span>
	<span class="n">av7110_ir_init</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;dvb-ttpci: found av7110-%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110_num</span><span class="p">);</span>
	<span class="n">av7110_num</span><span class="o">++</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err_av7110_exit_v4l_12:</span>
	<span class="n">av7110_exit_v4l</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
<span class="nl">err_av7110_unregister_11:</span>
	<span class="n">dvb_unregister</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
<span class="nl">err_arm_thread_stop_10:</span>
	<span class="n">av7110_arm_sync</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
<span class="nl">err_stop_arm_9:</span>
	<span class="cm">/* Nothing to do. Rejoice. */</span>
<span class="nl">err_av7110_ca_exit_8:</span>
	<span class="n">av7110_ca_exit</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
<span class="nl">err_av7110_av_exit_7:</span>
	<span class="n">av7110_av_exit</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
<span class="nl">err_iobuf_vfree_6:</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">);</span>
<span class="nl">err_pci_free_5:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">8192</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_bus</span><span class="p">);</span>
<span class="nl">err_saa71466_vfree_4:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">grabbing</span><span class="p">)</span>
		<span class="n">saa7146_vfree_destroy_pgtable</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">grabbing</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">);</span>
<span class="nl">err_i2c_del_3:</span>
	<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
<span class="nl">err_dvb_unregister_adapter_2:</span>
	<span class="n">dvb_unregister_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">);</span>
<span class="nl">err_put_firmware_1:</span>
	<span class="n">put_firmware</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
<span class="nl">err_kfree_0:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">av7110_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span><span class="o">*</span> <span class="n">saa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">saa</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_INPUT_EVDEV) || defined(CONFIG_INPUT_EVDEV_MODULE)</span>
	<span class="n">av7110_ir_exit</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">budgetpatch</span> <span class="o">||</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budgetpatch</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Disable RPS1 */</span>
			<span class="n">saa7146_write</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_29</span><span class="p">);</span>
			<span class="cm">/* VSYNC LOW (inactive) */</span>
			<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_20</span><span class="p">);</span>	<span class="cm">/* DMA3 off */</span>
		<span class="n">SAA7146_IER_DISABLE</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MASK_10</span><span class="p">);</span>
		<span class="n">SAA7146_ISR_CLEAR</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MASK_10</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">vpe_tasklet</span><span class="p">);</span>
		<span class="n">saa7146_vfree_destroy_pgtable</span><span class="p">(</span><span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">grabbing</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">av7110_exit_v4l</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>

	<span class="n">av7110_arm_sync</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">gpio_tasklet</span><span class="p">);</span>

	<span class="n">dvb_unregister</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>

	<span class="n">SAA7146_IER_DISABLE</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MASK_19</span> <span class="o">|</span> <span class="n">MASK_03</span><span class="p">);</span>
	<span class="n">SAA7146_ISR_CLEAR</span><span class="p">(</span><span class="n">saa</span><span class="p">,</span> <span class="n">MASK_19</span> <span class="o">|</span> <span class="n">MASK_03</span><span class="p">);</span>

	<span class="n">av7110_ca_exit</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="n">av7110_av_exit</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">saa</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">8192</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_virt</span><span class="p">,</span>
			    <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_bus</span><span class="p">);</span>

	<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>

	<span class="n">dvb_unregister_adapter</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">);</span>

	<span class="n">av7110_num</span><span class="o">--</span><span class="p">;</span>

	<span class="n">put_firmware</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>

	<span class="n">saa</span><span class="o">-&gt;</span><span class="n">ext_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">av7110_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>print<em>time("av7110</em>irq");</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* Note: Don&#39;t try to handle the DEBI error irq (MASK_18), in</span>
<span class="cm">	 * intel mode the timeout is asserted all the time...</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">MASK_19</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>printk("av7110_irq: DEBI\n");</p></td><td class="code"><div class="highlight"><pre>		<span class="cm">/* Note 1: The DEBI irq is level triggered: We must enable it</span>
<span class="cm">		 * only after we started a DMA xfer, and disable it here</span>
<span class="cm">		 * immediately, or it will be signalled all the time while</span>
<span class="cm">		 * DEBI is idle.</span>
<span class="cm">		 * Note 2: You would think that an irq which is masked is</span>
<span class="cm">		 * not signalled by the hardware. Not so for the SAA7146:</span>
<span class="cm">		 * An irq is signalled as long as the corresponding bit</span>
<span class="cm">		 * in the ISR is set, and disabling irqs just prevents the</span>
<span class="cm">		 * hardware from setting the ISR bit. This means a) that we</span>
<span class="cm">		 * must clear the ISR *after* disabling the irq (which is why</span>
<span class="cm">		 * we must do it here even though saa7146_core did it already),</span>
<span class="cm">		 * and b) that if we were to disable an edge triggered irq</span>
<span class="cm">		 * (like the gpio irqs sadly are) temporarily we would likely</span>
<span class="cm">		 * loose some. This sucks :-(</span>
<span class="cm">		 */</span>
		<span class="n">SAA7146_IER_DISABLE</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_19</span><span class="p">);</span>
		<span class="n">SAA7146_ISR_CLEAR</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_19</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">MASK_03</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>printk("av7110_irq: GPIO\n");</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">gpio_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">MASK_10</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">vpe_tasklet</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_extension</span> <span class="n">av7110_extension_driver</span><span class="p">;</span>

<span class="cp">#define MAKE_AV7110_INFO(x_var,x_name) \</span>
<span class="cp">static struct saa7146_pci_extension_data x_var = { \</span>
<span class="cp">	.ext_priv = x_name, \</span>
<span class="cp">	.ext = &amp;av7110_extension_driver }</span>

<span class="n">MAKE_AV7110_INFO</span><span class="p">(</span><span class="n">tts_1_X_fsc</span><span class="p">,</span><span class="s">&quot;Technotrend/Hauppauge WinTV DVB-S rev1.X or Fujitsu Siemens DVB-C&quot;</span><span class="p">);</span>
<span class="n">MAKE_AV7110_INFO</span><span class="p">(</span><span class="n">ttt_1_X</span><span class="p">,</span>    <span class="s">&quot;Technotrend/Hauppauge WinTV DVB-T rev1.X&quot;</span><span class="p">);</span>
<span class="n">MAKE_AV7110_INFO</span><span class="p">(</span><span class="n">ttc_1_X</span><span class="p">,</span>    <span class="s">&quot;Technotrend/Hauppauge WinTV Nexus-CA rev1.X&quot;</span><span class="p">);</span>
<span class="n">MAKE_AV7110_INFO</span><span class="p">(</span><span class="n">ttc_2_X</span><span class="p">,</span>    <span class="s">&quot;Technotrend/Hauppauge WinTV DVB-C rev2.X&quot;</span><span class="p">);</span>
<span class="n">MAKE_AV7110_INFO</span><span class="p">(</span><span class="n">tts_2_X</span><span class="p">,</span>    <span class="s">&quot;Technotrend/Hauppauge WinTV Nexus-S rev2.X&quot;</span><span class="p">);</span>
<span class="n">MAKE_AV7110_INFO</span><span class="p">(</span><span class="n">tts_2_3</span><span class="p">,</span>    <span class="s">&quot;Technotrend/Hauppauge WinTV Nexus-S rev2.3&quot;</span><span class="p">);</span>
<span class="n">MAKE_AV7110_INFO</span><span class="p">(</span><span class="n">tts_1_3se</span><span class="p">,</span>  <span class="s">&quot;Technotrend/Hauppauge WinTV DVB-S rev1.3 SE&quot;</span><span class="p">);</span>
<span class="n">MAKE_AV7110_INFO</span><span class="p">(</span><span class="n">ttt</span><span class="p">,</span>        <span class="s">&quot;Technotrend/Hauppauge DVB-T&quot;</span><span class="p">);</span>
<span class="n">MAKE_AV7110_INFO</span><span class="p">(</span><span class="n">fsc</span><span class="p">,</span>        <span class="s">&quot;Fujitsu Siemens DVB-C&quot;</span><span class="p">);</span>
<span class="n">MAKE_AV7110_INFO</span><span class="p">(</span><span class="n">fss</span><span class="p">,</span>        <span class="s">&quot;Fujitsu Siemens DVB-S rev1.6&quot;</span><span class="p">);</span>
<span class="n">MAKE_AV7110_INFO</span><span class="p">(</span><span class="n">gxs_1_3</span><span class="p">,</span>    <span class="s">&quot;Galaxis DVB-S rev1.3&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">fsc</span><span class="p">,</span>         <span class="mh">0x110a</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">tts_1_X_fsc</span><span class="p">,</span> <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">ttt_1_X</span><span class="p">,</span>     <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">ttc_2_X</span><span class="p">,</span>     <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">tts_2_X</span><span class="p">,</span>     <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">gxs_1_3</span><span class="p">,</span>     <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">fss</span><span class="p">,</span>         <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">ttt</span><span class="p">,</span>         <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">ttc_1_X</span><span class="p">,</span>     <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">tts_2_3</span><span class="p">,</span>     <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">),</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">tts_1_3se</span><span class="p">,</span>   <span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x1002</span><span class="p">),</span>

<span class="cm">/*	MAKE_EXTENSION_PCI(???, 0x13c2, 0x0005), UNDEFINED CARD */</span> <span class="c1">// Technisat SkyStar1</span>
<span class="cm">/*	MAKE_EXTENSION_PCI(???, 0x13c2, 0x0009), UNDEFINED CARD */</span> <span class="c1">// TT/Hauppauge WinTV Nexus-CA v????</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_tbl</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_extension</span> <span class="n">av7110_extension_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;av7110&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">SAA7146_USE_I2C_IRQ</span><span class="p">,</span>

	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pci_tbl</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pci_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">av7110_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">av7110_detach</span><span class="p">),</span>

	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">MASK_19</span> <span class="o">|</span> <span class="n">MASK_03</span> <span class="o">|</span> <span class="n">MASK_10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_func</span>	<span class="o">=</span> <span class="n">av7110_irq</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">av7110_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">saa7146_register_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110_extension_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">av7110_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">saa7146_unregister_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110_extension_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">av7110_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">av7110_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;driver for the SAA7146 based AV110 PCI DVB cards by &quot;</span>
		   <span class="s">&quot;Siemens, Technotrend, Hauppauge&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ralph Metzler, Marcus Metzler, others&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
