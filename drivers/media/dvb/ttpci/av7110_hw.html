<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › ttpci › av7110_hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>av7110_hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * av7110_hw.c: av7110 low level hardware access and firmware interface</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999-2002 Ralph  Metzler</span>
<span class="cm"> *                       &amp; Marcus Metzler for convergence integrated media GmbH</span>
<span class="cm"> *</span>
<span class="cm"> * originally based on code by:</span>
<span class="cm"> * Copyright (C) 1998,1999 Christian Theiss &lt;mistert@rz.fh-augsburg.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> * Or, point your browser to http://www.gnu.org/copyleft/gpl.html</span>
<span class="cm"> *</span>
<span class="cm"> * the project&#39;s page is at http://www.linuxtv.org/ </span>
<span class="cm"> */</span>

<span class="cm">/* for debugging ARM communication: */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define COM_DEBUG</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>

<span class="cp">#include &quot;av7110.h&quot;</span>
<span class="cp">#include &quot;av7110_hw.h&quot;</span>

<span class="cp">#define _NOHANDSHAKE</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * DEBI functions</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/* This DEBI code is based on the Stradis driver</span>
<span class="cm">   by Nathan Laredo &lt;laredo@gnu.org&gt; */</span>

<span class="kt">int</span> <span class="nf">av7110_debiwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u32</span> <span class="n">config</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">32764</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: invalid count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saa7146_wait_for_debi_done</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: wait_for_debi_done failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DEBI_CONFIG</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>		<span class="cm">/* immediate transfer */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DEBI_AD</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>			<span class="cm">/* block transfer */</span>
		<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DEBI_AD</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_bus</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DEBI_COMMAND</span><span class="p">,</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">av7110_debiread</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u32</span> <span class="n">config</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">32764</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: invalid count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saa7146_wait_for_debi_done</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: wait_for_debi_done #1 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DEBI_AD</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">debi_bus</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DEBI_COMMAND</span><span class="p">,</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10000</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>

	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DEBI_CONFIG</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saa7146_wait_for_debi_done</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: wait_for_debi_done #2 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">saa7146_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DEBI_AD</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mh">0xffffffffUL</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="mi">4</span> <span class="o">-</span> <span class="n">count</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* av7110 ARM core boot stuff */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">void av7110_reset_arm(struct av7110 *av7110)</span>
<span class="c">{</span>
<span class="c">	saa7146_setgpio(av7110-&gt;dev, RESET_LINE, SAA7146_GPIO_OUTLO);</span>

<span class="c">	/* Disable DEBI and GPIO irq */</span>
<span class="c">	SAA7146_IER_DISABLE(av7110-&gt;dev, MASK_19 | MASK_03);</span>
<span class="c">	SAA7146_ISR_CLEAR(av7110-&gt;dev, MASK_19 | MASK_03);</span>

<span class="c">	saa7146_setgpio(av7110-&gt;dev, RESET_LINE, SAA7146_GPIO_OUTHI);</span>
<span class="c">	msleep(30);	/* the firmware needs some time to initialize */</span>

<span class="c">	ARM_ResetMailBox(av7110);</span>

<span class="c">	SAA7146_ISR_CLEAR(av7110-&gt;dev, MASK_19 | MASK_03);</span>
<span class="c">	SAA7146_IER_ENABLE(av7110-&gt;dev, MASK_03);</span>

<span class="c">	av7110-&gt;arm_ready = 1;</span>
<span class="c">	dprintk(1, &quot;reset ARM\n&quot;);</span>
<span class="c">}</span>
<span class="cp">#endif  /*  0  */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">waitdebi</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_dram</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">rest</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base</span><span class="p">,</span> <span class="n">bootblock</span> <span class="o">=</span> <span class="n">AV7110_BOOT_BLOCK</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="n">blocks</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="n">AV7110_BOOT_MAX_SIZE</span><span class="p">;</span>
	<span class="n">rest</span> <span class="o">=</span> <span class="n">len</span> <span class="o">%</span> <span class="n">AV7110_BOOT_MAX_SIZE</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">DRAM_START_CODE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">blocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">waitdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV7110_BOOT_STATE</span><span class="p">,</span> <span class="n">BOOTSTATE_BUFFER_EMPTY</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: load_dram(): timeout at block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;writing DRAM block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">mwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBISWAB</span><span class="p">,</span> <span class="n">bootblock</span><span class="p">,</span>
		       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">AV7110_BOOT_MAX_SIZE</span><span class="p">,</span> <span class="n">AV7110_BOOT_MAX_SIZE</span><span class="p">);</span>
		<span class="n">bootblock</span> <span class="o">^=</span> <span class="mh">0x1400</span><span class="p">;</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBISWAB</span><span class="p">,</span> <span class="n">AV7110_BOOT_BASE</span><span class="p">,</span> <span class="n">swab32</span><span class="p">(</span><span class="n">base</span><span class="p">),</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">AV7110_BOOT_SIZE</span><span class="p">,</span> <span class="n">AV7110_BOOT_MAX_SIZE</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">AV7110_BOOT_STATE</span><span class="p">,</span> <span class="n">BOOTSTATE_BUFFER_FULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">base</span> <span class="o">+=</span> <span class="n">AV7110_BOOT_MAX_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rest</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">waitdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV7110_BOOT_STATE</span><span class="p">,</span> <span class="n">BOOTSTATE_BUFFER_EMPTY</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: load_dram(): timeout at last block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rest</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">mwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBISWAB</span><span class="p">,</span> <span class="n">bootblock</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">AV7110_BOOT_MAX_SIZE</span><span class="p">,</span> <span class="n">rest</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBISWAB</span><span class="p">,</span> <span class="n">bootblock</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">AV7110_BOOT_MAX_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rest</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBISWAB</span><span class="p">,</span> <span class="n">AV7110_BOOT_BASE</span><span class="p">,</span> <span class="n">swab32</span><span class="p">(</span><span class="n">base</span><span class="p">),</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">AV7110_BOOT_SIZE</span><span class="p">,</span> <span class="n">rest</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">AV7110_BOOT_STATE</span><span class="p">,</span> <span class="n">BOOTSTATE_BUFFER_FULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">waitdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV7110_BOOT_STATE</span><span class="p">,</span> <span class="n">BOOTSTATE_BUFFER_EMPTY</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: load_dram(): timeout after last block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">AV7110_BOOT_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">AV7110_BOOT_STATE</span><span class="p">,</span> <span class="n">BOOTSTATE_BUFFER_FULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">waitdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV7110_BOOT_STATE</span><span class="p">,</span> <span class="n">BOOTSTATE_AV7110_BOOT_COMPLETE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: load_dram(): final handshake timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* we cannot write av7110 DRAM directly, so load a bootloader into</span>
<span class="cm"> * the DPRAM which implements a simple boot protocol */</span>
<span class="kt">int</span> <span class="nf">av7110_bootarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span> <span class="o">=</span> <span class="s">&quot;av7110/bootcode.bin&quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RESET_LINE</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>

	<span class="cm">/* Disable DEBI and GPIO irq */</span>
	<span class="n">SAA7146_IER_DISABLE</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_03</span> <span class="o">|</span> <span class="n">MASK_19</span><span class="p">);</span>
	<span class="n">SAA7146_ISR_CLEAR</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_19</span> <span class="o">|</span> <span class="n">MASK_03</span><span class="p">);</span>

	<span class="cm">/* enable DEBI */</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="mh">0x08800880</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_STREAM_B</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_09</span> <span class="o">|</span> <span class="n">MASK_25</span> <span class="o">|</span> <span class="n">MASK_10</span> <span class="o">|</span> <span class="n">MASK_26</span><span class="p">));</span>

	<span class="cm">/* test DEBI */</span>
	<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBISWAP</span><span class="p">,</span> <span class="n">DPRAM_BASE</span><span class="p">,</span> <span class="mh">0x76543210</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* FIXME: Why does Nexus CA require 2x iwdebi for first init? */</span>
	<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBISWAP</span><span class="p">,</span> <span class="n">DPRAM_BASE</span><span class="p">,</span> <span class="mh">0x76543210</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span><span class="o">=</span><span class="n">irdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">DPRAM_BASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x10325476</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: debi test in av7110_bootarm() failed: &quot;</span>
		       <span class="s">&quot;%08x != %08x (check your BIOS &#39;Plug&amp;Play OS&#39; settings)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ret</span><span class="p">,</span> <span class="mh">0x10325476</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8192</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBISWAP</span><span class="p">,</span> <span class="n">DPRAM_BASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;debi test OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* boot */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;load boot code</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ARM_IRQ_LINE</span><span class="p">,</span> <span class="n">SAA7146_GPIO_IRQLO</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>saa7146<em>setgpio(dev, DEBI</em>DONE<em>LINE, SAA7146</em>GPIO<em>INPUT);
saa7146</em>setgpio(dev, 3, SAA7146<em>GPIO</em>INPUT);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: Failed to load firmware </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fw_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBISWAB</span><span class="p">,</span> <span class="n">DPRAM_BASE</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="n">iwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">AV7110_BOOT_STATE</span><span class="p">,</span> <span class="n">BOOTSTATE_BUFFER_FULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7146_wait_for_debi_done</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: av7110_bootarm(): &quot;</span>
		       <span class="s">&quot;saa7146_wait_for_debi_done() timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RESET_LINE</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;load dram code</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">load_dram</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bin_root</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">size_root</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: av7110_bootarm(): &quot;</span>
		       <span class="s">&quot;load_dram() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RESET_LINE</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;load dpram code</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mwdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBISWAB</span><span class="p">,</span> <span class="n">DPRAM_BASE</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bin_dpram</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">size_dpram</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7146_wait_for_debi_done</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: av7110_bootarm(): &quot;</span>
		       <span class="s">&quot;saa7146_wait_for_debi_done() timed out after loading DRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RESET_LINE</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>	<span class="cm">/* the firmware needs some time to initialize */</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>ARM_ClearIrq(av7110);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ARM_ResetMailBox</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="n">SAA7146_ISR_CLEAR</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_19</span> <span class="o">|</span> <span class="n">MASK_03</span><span class="p">);</span>
	<span class="n">SAA7146_IER_ENABLE</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MASK_03</span><span class="p">);</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;av7110/bootcode.bin&quot;</span><span class="p">);</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * DEBI command polling</span>
<span class="cm"> ****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">av7110_wait_msgstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FW_VERSION</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0x261c</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not supported by old firmware */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* new firmware */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ARM_WAIT_FREE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">MSGSTATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: timeout waiting for MSGSTATE %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">stat</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__av7110_send_fw_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u16</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flags</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>dprintk(4, "%p\n", av7110);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;arm not ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ARM_WAIT_FREE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COMMAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: %s(): timeout waiting for COMMAND idle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FW_VERSION</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0x261f</span><span class="p">)</span>
		<span class="n">wdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COM_IF_LOCK</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="cp">#ifndef _NOHANDSHAKE</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ARM_WAIT_SHAKE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">HANDSHAKE_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: %s(): timeout waiting for HANDSHAKE_REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">COMTYPE_PIDFILTER</span>:
	<span class="k">case</span> <span class="n">COMTYPE_ENCODER</span>:
	<span class="k">case</span> <span class="n">COMTYPE_REC_PLAY</span>:
	<span class="k">case</span> <span class="n">COMTYPE_MPEGDECODER</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;MSG&quot;</span><span class="p">;</span>
		<span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPMQOver</span><span class="p">;</span>
		<span class="n">flags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPMQFull</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMTYPE_OSD</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;OSD&quot;</span><span class="p">;</span>
		<span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OSDQOver</span><span class="p">;</span>
		<span class="n">flags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">OSDQFull</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMTYPE_MISC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">FW_VERSION</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x261d</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;MSG&quot;</span><span class="p">;</span>
			<span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPMQOver</span><span class="p">;</span>
			<span class="n">flags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPMQBusy</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* non-immediate COMMAND type */</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ARM_WAIT_FREE</span><span class="p">);</span>
			<span class="n">stat</span> <span class="o">=</span> <span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">MSGSTATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: %s QUEUE overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: timeout waiting on busy %s QUEUE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COMMAND</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span>
		<span class="n">wdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COMMAND</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">wdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COMMAND</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">wdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COMMAND</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FW_VERSION</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0x261f</span><span class="p">)</span>
		<span class="n">wdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COM_IF_LOCK</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="cp">#ifdef COM_DEBUG</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ARM_WAIT_FREE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COMMAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: %s(): timeout waiting for COMMAND %d to complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">MSGSTATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">GPMQOver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: %s(): GPMQOver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">OSDQOver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: %s(): OSDQOver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_send_fw_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u16</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>dprintk(4, "%p\n", av7110);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;arm not ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__av7110_send_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span><span class="o">!=-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: %s(): av7110_send_fw_cmd error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">av7110_fw_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">com</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>dprintk(4, "%p\n", av7110);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">com</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
		<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_send_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: av7110_fw_cmd error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">int av7110_send_ci_cmd(struct av7110 *av7110, u8 subcom, u8 *buf, u8 len)</span>
<span class="c">{</span>
<span class="c">	int i, ret;</span>
<span class="c">	u16 cmd[18] = { ((COMTYPE_COMMON_IF &lt;&lt; 8) + subcom),</span>
<span class="c">		16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };</span>

<span class="c">	dprintk(4, &quot;%p\n&quot;, av7110);</span>

<span class="c">	for(i = 0; i &lt; len &amp;&amp; i &lt; 32; i++)</span>
<span class="c">	{</span>
<span class="c">		if(i % 2 == 0)</span>
<span class="c">			cmd[(i / 2) + 2] = (u16)(buf[i]) &lt;&lt; 8;</span>
<span class="c">		else</span>
<span class="c">			cmd[(i / 2) + 2] |= buf[i];</span>
<span class="c">	}</span>

<span class="c">	ret = av7110_send_fw_cmd(av7110, cmd, 18);</span>
<span class="c">	if (ret &amp;&amp; ret != -ERESTARTSYS)</span>
<span class="c">		printk(KERN_ERR &quot;dvb-ttpci: av7110_send_ci_cmd error %d\n&quot;, ret);</span>
<span class="c">	return ret;</span>
<span class="c">}</span>
<span class="cp">#endif  /*  0  */</span>

<span class="kt">int</span> <span class="nf">av7110_fw_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">request_buf</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">request_buf_len</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">reply_buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reply_buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>
<span class="cp">#ifdef COM_DEBUG</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;arm not ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">__av7110_send_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">request_buf</span><span class="p">,</span> <span class="n">request_buf_len</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: av7110_fw_request error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ARM_WAIT_FREE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COMMAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: timeout waiting for COMMAND to complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef _NOHANDSHAKE</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

<span class="cp">#ifndef _NOHANDSHAKE</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ARM_WAIT_SHAKE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">HANDSHAKE_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: timeout waiting for HANDSHAKE_REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef COM_DEBUG</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">MSGSTATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">GPMQOver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: GPMQOver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">OSDQOver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: OSDQOver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reply_buf_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">reply_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COM_BUFF</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_fw_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tag</span><span class="p">,</span> <span class="n">u16</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="n">s16</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_request</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: av7110_fw_query error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * Firmware commands</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/* get version of the firmware ROM, RTSL, video ucode and ARM application  */</span>
<span class="kt">int</span> <span class="nf">av7110_firmversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">tag</span> <span class="o">=</span> <span class="p">((</span><span class="n">COMTYPE_REQUEST</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">ReqVersion</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110_fw_query</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: failed to boot firmware @ card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_fw</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_rtsl</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_vid</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: info @ card %d: firm %08x, rtsl %08x, vid %08x, app %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_fw</span><span class="p">,</span>
	       <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_rtsl</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_vid</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">);</span>

	<span class="cm">/* print firmware capabilities */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FW_CI_LL_SUPPORT</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: firmware @ card %d supports CI link layer interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: no firmware support for CI link layer interface @ card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">av7110_diseqc_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">burst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">((</span><span class="n">COMTYPE_AUDIODAC</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">SendDiSEqC</span><span class="p">),</span>
			<span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">burst</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">burst</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_send_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span><span class="o">!=-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: av7110_diseqc_send error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_DVB_AV7110_OSD</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">SetColorBlend</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">windownr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">SetCBlend</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">windownr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">SetBlend_</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">windownr</span><span class="p">,</span>
		     <span class="k">enum</span> <span class="n">av7110_osd_palette_type</span> <span class="n">colordepth</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">blending</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">SetBlend</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			     <span class="n">windownr</span><span class="p">,</span> <span class="n">colordepth</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">blending</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">SetColor_</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">windownr</span><span class="p">,</span>
		     <span class="k">enum</span> <span class="n">av7110_osd_palette_type</span> <span class="n">colordepth</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">colorhi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">colorlo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">SetColor</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
			     <span class="n">windownr</span><span class="p">,</span> <span class="n">colordepth</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">colorhi</span><span class="p">,</span> <span class="n">colorlo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">SetFont</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">windownr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">fontsize</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">colorfg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">colorbg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">Set_Font</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			     <span class="n">windownr</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">colorfg</span><span class="p">,</span> <span class="n">colorbg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">FlushText</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ARM_WAIT_OSD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">BUFF1_BASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: %s(): timeout waiting for BUFF1_BASE == 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">WriteText</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">win</span><span class="p">,</span> <span class="n">u16</span> <span class="n">x</span><span class="p">,</span> <span class="n">u16</span> <span class="n">y</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cbuf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">COMTYPE_OSD</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">DText</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ARM_WAIT_OSD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">BUFF1_BASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: %s: timeout waiting for BUFF1_BASE == 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifndef _NOHANDSHAKE</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ARM_WAIT_SHAKE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">HANDSHAKE_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: %s: timeout waiting for HANDSHAKE_REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">BUFF1_BASE</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
		      <span class="n">swab16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">)),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">wdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">BUFF1_BASE</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__av7110_send_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">cbuf</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dcomlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span><span class="o">!=-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dvb-ttpci: WriteText error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">DrawLine</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">windownr</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">x</span><span class="p">,</span> <span class="n">u16</span> <span class="n">y</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dy</span><span class="p">,</span> <span class="n">u16</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">DLine</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
			     <span class="n">windownr</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">DrawBlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">windownr</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">x</span><span class="p">,</span> <span class="n">u16</span> <span class="n">y</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dy</span><span class="p">,</span> <span class="n">u16</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">DBox</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
			     <span class="n">windownr</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">HideWindow</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">windownr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">WHide</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">windownr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">MoveWindowRel</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">windownr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">x</span><span class="p">,</span> <span class="n">u16</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">WMoveD</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">windownr</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">MoveWindowAbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">windownr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">x</span><span class="p">,</span> <span class="n">u16</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">WMoveA</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">windownr</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">DestroyOSDWindow</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">windownr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">WDestroy</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">windownr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">CreateOSDWindow</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">windownr</span><span class="p">,</span>
				  <span class="n">osd_raw_window_t</span> <span class="n">disptype</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">width</span><span class="p">,</span> <span class="n">u16</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">WCreate</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			     <span class="n">windownr</span><span class="p">,</span> <span class="n">disptype</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">enum</span> <span class="n">av7110_osd_palette_type</span> <span class="n">bpp2pal</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">Pal1Bit</span><span class="p">,</span> <span class="n">Pal2Bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Pal4Bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Pal8Bit</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">osd_raw_window_t</span> <span class="n">bpp2bit</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">OSD_BITMAP1</span><span class="p">,</span> <span class="n">OSD_BITMAP2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OSD_BITMAP4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OSD_BITMAP8</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">WaitUntilBmpLoaded</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmpq</span><span class="p">,</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmp_state</span> <span class="o">!=</span> <span class="n">BMP_LOADING</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: warning: timeout waiting in LoadBitmap: %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ret</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmp_state</span><span class="p">);</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmp_state</span> <span class="o">=</span> <span class="n">BMP_NONE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">LoadBitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">dx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">format</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">d</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">bpp2bit</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdbpp</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">]];</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmp_state</span> <span class="o">=</span> <span class="n">BMP_LOADING</span><span class="p">;</span>
	<span class="k">if</span>	<span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="n">OSD_BITMAP8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span><span class="o">=</span><span class="mi">8</span><span class="p">;</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="n">OSD_BITMAP4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="n">OSD_BITMAP2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="n">OSD_BITMAP1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmp_state</span> <span class="o">=</span> <span class="n">BMP_NONE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmplen</span> <span class="o">=</span> <span class="p">((</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmpp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmplen</span> <span class="o">&gt;</span> <span class="mi">32768</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmp_state</span> <span class="o">=</span> <span class="n">BMP_NONE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dy</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmpbuf</span> <span class="o">+</span> <span class="mi">1024</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dx</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">inc</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmp_state</span> <span class="o">=</span> <span class="n">BMP_NONE</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">!=</span> <span class="n">OSD_BITMAP8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">/</span> <span class="n">delta</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmpbuf</span><span class="p">)[</span><span class="mi">1024</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">d</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">d</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmpbuf</span><span class="p">)[</span><span class="mi">1024</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">d</span><span class="p">]</span>
				      <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">delta</span> <span class="o">-</span> <span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">));</span>
				<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmpbuf</span><span class="p">)[</span><span class="mi">1024</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmplen</span> <span class="o">+=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;av7110_fw_cmd: LoadBmp size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmplen</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">LoadBmp</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">WaitUntilBmpLoaded</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">BlitBitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u16</span> <span class="n">x</span><span class="p">,</span> <span class="n">u16</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">BlitBmp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ReleaseBitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmp_state</span> <span class="o">!=</span> <span class="n">BMP_LOADED</span> <span class="o">&amp;&amp;</span> <span class="n">FW_VERSION</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x261e</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmp_state</span> <span class="o">==</span> <span class="n">BMP_LOADING</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;ReleaseBitmap called while BMP_LOADING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmp_state</span> <span class="o">=</span> <span class="n">BMP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">ReleaseBmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">RGB2YUV</span><span class="p">(</span><span class="n">u16</span> <span class="n">R</span><span class="p">,</span> <span class="n">u16</span> <span class="n">G</span><span class="p">,</span> <span class="n">u16</span> <span class="n">B</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Cr</span><span class="p">,</span> <span class="n">Cb</span><span class="p">;</span>

	<span class="n">y</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="mi">77</span> <span class="o">+</span> <span class="n">G</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="mi">29</span><span class="p">;</span>	<span class="cm">/* Luma=0.299R+0.587G+0.114B 0..65535 */</span>
	<span class="n">u</span> <span class="o">=</span> <span class="mi">2048</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span><span class="p">(</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>	<span class="cm">/* Cr 0..4095 */</span>
	<span class="n">v</span> <span class="o">=</span> <span class="mi">2048</span> <span class="o">+</span> <span class="n">R</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span><span class="p">(</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>	<span class="cm">/* Cb 0..4095 */</span>

	<span class="n">Y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">Cb</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">Cr</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">Cr</span> <span class="o">|</span> <span class="p">(</span><span class="n">Cb</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Y</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">OSDSetColor</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="n">color</span><span class="p">,</span> <span class="n">u8</span> <span class="n">r</span><span class="p">,</span> <span class="n">u8</span> <span class="n">g</span><span class="p">,</span> <span class="n">u8</span> <span class="n">b</span><span class="p">,</span> <span class="n">u8</span> <span class="n">blend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">ch</span><span class="p">,</span> <span class="n">cl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">yuv</span><span class="p">;</span>

	<span class="n">yuv</span> <span class="o">=</span> <span class="n">blend</span> <span class="o">?</span> <span class="n">RGB2YUV</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cl</span> <span class="o">=</span> <span class="p">(</span><span class="n">yuv</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="p">((</span><span class="n">yuv</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">SetColor_</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="n">bpp2pal</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdbpp</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">]],</span>
			<span class="n">color</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">cl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SetBlend_</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="n">bpp2pal</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdbpp</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">]],</span>
				<span class="n">color</span><span class="p">,</span> <span class="p">((</span><span class="n">blend</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">OSDSetPalette</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">colors</span><span class="p">,</span> <span class="n">u8</span> <span class="n">first</span><span class="p">,</span> <span class="n">u8</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">last</span> <span class="o">-</span> <span class="n">first</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">DATA_BUFF3_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">color</span><span class="p">,</span> <span class="n">blend</span><span class="p">,</span> <span class="n">yuv</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">colors</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">blend</span> <span class="o">=</span> <span class="p">(</span><span class="n">color</span> <span class="o">&amp;</span> <span class="mh">0xF0000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="n">blend</span> <span class="o">?</span> <span class="n">RGB2YUV</span><span class="p">(</span><span class="n">color</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">color</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">color</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span> <span class="n">blend</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="p">((</span><span class="n">yuv</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">yuv</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">wdebi</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">DATA_BUFF3_BASE</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">yuv</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_OSD</span><span class="p">,</span> <span class="n">Set_Palette</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			    <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span>
			    <span class="n">bpp2pal</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdbpp</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">]],</span>
			    <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">OSDSetBlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y0</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">x1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">bpl</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">lpb</span><span class="p">,</span> <span class="n">bnum</span><span class="p">,</span> <span class="n">brest</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span><span class="n">release_rc</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inc</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">inc</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mi">720</span> <span class="o">||</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="mi">576</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">bpp</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdbpp</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bpl</span> <span class="o">=</span> <span class="p">((</span><span class="n">w</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">bpl</span><span class="p">;</span>
	<span class="n">lpb</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">/</span> <span class="n">bpl</span><span class="p">;</span>
	<span class="n">bnum</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">lpb</span> <span class="o">*</span> <span class="n">bpl</span><span class="p">);</span>
	<span class="n">brest</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">bnum</span> <span class="o">*</span> <span class="n">lpb</span> <span class="o">*</span> <span class="n">bpl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">bmp_state</span> <span class="o">==</span> <span class="n">BMP_LOADING</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* possible if syscall is repeated by -ERESTARTSYS and if firmware cannot abort */</span>
		<span class="n">BUG_ON</span> <span class="p">(</span><span class="n">FW_VERSION</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x261e</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">WaitUntilBmpLoaded</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="cm">/* just continue. This should work for all fw versions</span>
<span class="cm">		 * if bnum==1 &amp;&amp; !brest &amp;&amp; LoadBitmap was successful</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">LoadBitmap</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">lpb</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BlitBitmap</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">lpb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">lpb</span> <span class="o">*</span> <span class="n">inc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">brest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">LoadBitmap</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">brest</span> <span class="o">/</span> <span class="n">bpl</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">BlitBitmap</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">bnum</span> <span class="o">*</span> <span class="n">lpb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">release_rc</span> <span class="o">=</span> <span class="n">ReleaseBitmap</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">release_rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">av7110_osd_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">osd_cmd_t</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osd_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OSD_Close</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DestroyOSDWindow</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_Open</span>:
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdbpp</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">CreateOSDWindow</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span>
				<span class="n">bpp2bit</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdbpp</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">]],</span>
				<span class="n">dc</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">-</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">-</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">MoveWindowAbs</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">SetColorBlend</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_Show</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">MoveWindowRel</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_Hide</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">HideWindow</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_Clear</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DrawBlock</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_Fill</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DrawBlock</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_SetColor</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">OSDSetColor</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_SetPalette</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">FW_VERSION</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x2618</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">OSDSetPalette</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="o">-</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="n">colors</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">colors</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">get_user</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">colors</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">get_user</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">colors</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">get_user</span><span class="p">(</span><span class="n">blend</span><span class="p">,</span> <span class="n">colors</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				    <span class="p">}</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">OSDSetColor</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blend</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_SetPixel</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DrawLine</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span>
			 <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_SetRow</span>:
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">OSD_SetBlock</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">OSDSetBlock</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y1</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_FillRow</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DrawBlock</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">,</span>
			  <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x1</span><span class="o">-</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y1</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_FillBlock</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DrawBlock</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">,</span>
			  <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">-</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">-</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_Line</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DrawLine</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span>
			 <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">-</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">-</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_Text</span>:
	<span class="p">{</span>
		<span class="kt">char</span> <span class="n">textbuf</span><span class="p">[</span><span class="mi">240</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strncpy_from_user</span><span class="p">(</span><span class="n">textbuf</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">240</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">textbuf</span><span class="p">[</span><span class="mi">239</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">dc</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SetFont</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">),</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">FlushText</span><span class="p">(</span><span class="n">av7110</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">WriteText</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">,</span> <span class="n">textbuf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OSD_SetWindow</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_MoveWindow</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">MoveWindowAbs</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">SetColorBlend</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSD_OpenRaw</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">&lt;</span> <span class="n">OSD_BITMAP1</span> <span class="o">||</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">&gt;</span> <span class="n">OSD_CURSOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">&gt;=</span> <span class="n">OSD_BITMAP1</span> <span class="o">&amp;&amp;</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">&lt;=</span> <span class="n">OSD_BITMAP8HR</span><span class="p">)</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdbpp</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdbpp</span><span class="p">[</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">CreateOSDWindow</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="p">(</span><span class="n">osd_raw_window_t</span><span class="p">)</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">,</span>
				<span class="n">dc</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">-</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">-</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">MoveWindowAbs</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">SetColorBlend</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osdwin</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">osd_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="o">==-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;av7110_osd_cmd(%d) returns with -ERESTARTSYS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;av7110_osd_cmd(%d) returns with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">av7110_osd_capability</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">osd_cap_t</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OSD_CAP_MEMSIZE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">FW_4M_SDRAM</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">))</span>
			<span class="n">cap</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cap</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="mi">92000</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_DVB_AV7110_OSD */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
