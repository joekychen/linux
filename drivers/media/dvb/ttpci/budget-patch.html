<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › ttpci › budget-patch.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>budget-patch.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * budget-patch.c: driver for Budget Patch,</span>
<span class="cm"> * hardware modification of DVB-S cards enabling full TS</span>
<span class="cm"> *</span>
<span class="cm"> * Written by Emard &lt;emard@softhome.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Original idea by Roberto Deza &lt;rdeza@unav.es&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Special thanks to Holger Waechtler, Michael Hunold, Marian Durkovic</span>
<span class="cm"> * and Metzlerbros</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> * Or, point your browser to http://www.gnu.org/copyleft/gpl.html</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * the project&#39;s page is at http://www.linuxtv.org/ </span>
<span class="cm"> */</span>

<span class="cp">#include &quot;av7110.h&quot;</span>
<span class="cp">#include &quot;av7110_hw.h&quot;</span>
<span class="cp">#include &quot;budget.h&quot;</span>
<span class="cp">#include &quot;stv0299.h&quot;</span>
<span class="cp">#include &quot;ves1x93.h&quot;</span>
<span class="cp">#include &quot;tda8083.h&quot;</span>

<span class="cp">#include &quot;bsru6.h&quot;</span>

<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>

<span class="cp">#define budget_patch budget</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_extension</span> <span class="n">budget_extension</span><span class="p">;</span>

<span class="n">MAKE_BUDGET_INFO</span><span class="p">(</span><span class="n">ttbp</span><span class="p">,</span> <span class="s">&quot;TT-Budget/Patch DVB-S 1.x PCI&quot;</span><span class="p">,</span> <span class="n">BUDGET_PATCH</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>MAKE<em>BUDGET</em>INFO(satel,"TT-Budget/Patch SATELCO PCI", BUDGET<em>TT</em>HW_DISEQC);</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MAKE_EXTENSION_PCI</span><span class="p">(</span><span class="n">ttbp</span><span class="p">,</span><span class="mh">0x13c2</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">),</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><pre><code>   MAKE_EXTENSION_PCI(satel, 0x13c2, 0x1013),
</code></pre></td><td class="code"><div class="highlight"><pre>	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* those lines are for budget-patch to be tried</span>
<span class="cm">** on a true budget card and observe the</span>
<span class="cm">** behaviour of VSYNC generated by rps1.</span>
<span class="cm">** this code was shamelessly copy/pasted from budget.c</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gpio_Set22K</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="n">budget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="o">=</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;budget: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span> <span class="o">?</span> <span class="n">SAA7146_GPIO_OUTHI</span> <span class="o">:</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Diseqc functions only for TT Budget card */</span>
<span class="cm">/* taken from the Skyvision DVB driver by</span>
<span class="cm">   Ralph Metzler &lt;rjkm@metzlerbros.de&gt; */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DiseqcSendBit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="n">budget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="o">=</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;budget: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">data</span> <span class="o">?</span> <span class="mi">500</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">data</span> <span class="o">?</span> <span class="mi">1000</span> <span class="o">:</span> <span class="mi">500</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DiseqcSendByte</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="n">budget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;budget: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">par</span> <span class="o">^=</span> <span class="n">d</span><span class="p">;</span>
		<span class="n">DiseqcSendBit</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DiseqcSendBit</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SendDiSEqCMsg</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget</span> <span class="o">*</span><span class="n">budget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">burst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7146_dev</span> <span class="o">*</span><span class="n">dev</span><span class="o">=</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;budget: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DiseqcSendByte</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">burst</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">burst</span><span class="p">)</span>
			<span class="n">DiseqcSendByte</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
			<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* shamelessly copy/pasted from budget.c</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_set_tone</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_tone_mode_t</span> <span class="n">tone</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget</span><span class="o">*</span> <span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget</span><span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tone</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_TONE_ON</span>:
		<span class="n">gpio_Set22K</span> <span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SEC_TONE_OFF</span>:
		<span class="n">gpio_Set22K</span> <span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_diseqc_send_master_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_diseqc_master_cmd</span><span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget</span><span class="o">*</span> <span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget</span><span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">SendDiSEqCMsg</span> <span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_diseqc_send_burst</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_mini_cmd_t</span> <span class="n">minicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget</span><span class="o">*</span> <span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget</span><span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">SendDiSEqCMsg</span> <span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">minicmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_av7110_send_fw_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_patch</span> <span class="o">*</span><span class="n">budget</span><span class="p">,</span> <span class="n">u16</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;budget: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		  <span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COMMAND</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		  <span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span>
		  <span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COMMAND</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		  <span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COMMAND</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">ttpci_budget_debiwrite</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">DEBINOSWAP</span><span class="p">,</span> <span class="n">COMMAND</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">av7110_set22k</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_patch</span> <span class="o">*</span><span class="n">budget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{(</span> <span class="n">COMTYPE_AUDIODAC</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">state</span> <span class="o">?</span> <span class="n">ON22K</span> <span class="o">:</span> <span class="n">OFF22K</span><span class="p">),</span> <span class="mi">0</span><span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;budget: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>
	<span class="n">budget_av7110_send_fw_cmd</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">av7110_send_diseqc_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_patch</span> <span class="o">*</span><span class="n">budget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">burst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">((</span><span class="n">COMTYPE_AUDIODAC</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">SendDiSEqC</span><span class="p">),</span>
		<span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;budget: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">)</span>
		<span class="n">len</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">burst</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">burst</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">budget_av7110_send_fw_cmd</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_patch_set_tone</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_tone_mode_t</span> <span class="n">tone</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_patch</span><span class="o">*</span> <span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_patch</span><span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tone</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_TONE_ON</span>:
		<span class="n">av7110_set22k</span> <span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SEC_TONE_OFF</span>:
		<span class="n">av7110_set22k</span> <span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_patch_diseqc_send_master_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_diseqc_master_cmd</span><span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_patch</span><span class="o">*</span> <span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_patch</span><span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">av7110_send_diseqc_msg</span> <span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_patch_diseqc_send_burst</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_mini_cmd_t</span> <span class="n">minicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_patch</span><span class="o">*</span> <span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_patch</span><span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">av7110_send_diseqc_msg</span> <span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">minicmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_bsrv2_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">budget_patch</span><span class="o">*</span> <span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_patch</span><span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pwr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">479500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">125</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="mi">2000000</span><span class="p">)</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="mi">1800000</span><span class="p">)</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="mi">1600000</span><span class="p">)</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="mi">1200000</span><span class="p">)</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;=</span> <span class="mi">1100000</span><span class="p">)</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="n">pwr</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0x18000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x95</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pwr</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x30</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>NOTE: since we're using a prescaler of 2, we set the
divisor frequency to 62.5kHz and divide by 125 above</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ves1x93_config</span> <span class="n">alps_bsrv2_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xin</span> <span class="o">=</span> <span class="mi">90100000UL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert_pwm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grundig_29504_451_tuner_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">budget_patch</span><span class="o">*</span> <span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_patch</span><span class="o">*</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">};</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">125</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8e</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda8083_config</span> <span class="n">grundig_29504_451_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">frontend_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_patch</span><span class="o">*</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0000</span>: <span class="c1">// Hauppauge/TT WinTV DVB-S rev1.X</span>
	<span class="k">case</span> <span class="mh">0x1013</span>: <span class="c1">// SATELCO Multimedia PCI</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>try the ALPS BSRV2 first of all</p></td><td class="code"><div class="highlight"><pre>		<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">ves1x93_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alps_bsrv2_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">alps_bsrv2_tuner_set_params</span><span class="p">;</span>
			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_master_cmd</span> <span class="o">=</span> <span class="n">budget_patch_diseqc_send_master_cmd</span><span class="p">;</span>
			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_burst</span> <span class="o">=</span> <span class="n">budget_patch_diseqc_send_burst</span><span class="p">;</span>
			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_tone</span> <span class="o">=</span> <span class="n">budget_patch_set_tone</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>try the ALPS BSRU6 now</p></td><td class="code"><div class="highlight"><pre>		<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0299_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alps_bsru6_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">alps_bsru6_tuner_set_params</span><span class="p">;</span>
			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">;</span>

			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_master_cmd</span> <span class="o">=</span> <span class="n">budget_diseqc_send_master_cmd</span><span class="p">;</span>
			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_burst</span> <span class="o">=</span> <span class="n">budget_diseqc_send_burst</span><span class="p">;</span>
			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_tone</span> <span class="o">=</span> <span class="n">budget_set_tone</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Try the grundig 29504-451</p></td><td class="code"><div class="highlight"><pre>		<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda8083_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grundig_29504_451_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">grundig_29504_451_tuner_set_params</span><span class="p">;</span>
			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_master_cmd</span> <span class="o">=</span> <span class="n">budget_diseqc_send_master_cmd</span><span class="p">;</span>
			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_burst</span> <span class="o">=</span> <span class="n">budget_diseqc_send_burst</span><span class="p">;</span>
			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_tone</span> <span class="o">=</span> <span class="n">budget_set_tone</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-ttpci: A frontend driver was not found for device [%04x:%04x] subsystem [%04x:%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
		       <span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		       <span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
		       <span class="n">budget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb_register_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;budget-av: Frontend registration failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="p">);</span>
			<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* written by Emard */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_patch_attach</span> <span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7146_pci_extension_data</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_patch</span> <span class="o">*</span><span class="n">budget</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">detected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define PATCH_RESET 0</span>
<span class="cp">#define RPS_IRQ 0</span>
<span class="cp">#define HPS_SETUP 0</span>
<span class="cp">#if PATCH_RESET</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="n">MASK_31</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if HPS_SETUP</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>initialize registers. Better to have it like this
than leaving something unconfigured</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_STREAM_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>port B VSYNC at rising edge</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DD1_INIT</span><span class="p">,</span> <span class="mh">0x00000200</span><span class="p">);</span>  <span class="c1">// have this in budget-core too!</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BRS_CTRL</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>  <span class="c1">// VBI</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>debi config
saa7146<em>write(dev, DEBI</em>CONFIG, MASK<em>30|MASK</em>28|MASK_18);</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>zero all HPS registers</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HPS_H_PRESCALE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                  <span class="c1">// r68</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HPS_H_SCALE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                     <span class="c1">// r6c</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BCS_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                        <span class="c1">// r70</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HPS_V_SCALE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                     <span class="c1">// r60</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HPS_V_GAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                      <span class="c1">// r64</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CHROMA_KEY_RANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                <span class="c1">// r74</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CLIP_FORMAT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                <span class="c1">// r78</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Set HPS prescaler for port B input</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HPS_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">29</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC2</span><span class="p">,</span>
	  <span class="mi">0</span> <span class="o">*</span> <span class="p">(</span><span class="n">MASK_08</span> <span class="o">|</span> <span class="n">MASK_24</span><span class="p">)</span>  <span class="o">|</span>   <span class="c1">// BRS control</span>
	  <span class="mi">0</span> <span class="o">*</span> <span class="p">(</span><span class="n">MASK_09</span> <span class="o">|</span> <span class="n">MASK_25</span><span class="p">)</span>  <span class="o">|</span>   <span class="c1">// a</span>
	  <span class="mi">0</span> <span class="o">*</span> <span class="p">(</span><span class="n">MASK_10</span> <span class="o">|</span> <span class="n">MASK_26</span><span class="p">)</span>  <span class="o">|</span>   <span class="c1">// b</span>
	  <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">MASK_06</span> <span class="o">|</span> <span class="n">MASK_22</span><span class="p">)</span>  <span class="o">|</span>   <span class="c1">// HPS_CTRL1</span>
	  <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">MASK_05</span> <span class="o">|</span> <span class="n">MASK_21</span><span class="p">)</span>  <span class="o">|</span>   <span class="c1">// HPS_CTRL2</span>
	  <span class="mi">0</span> <span class="o">*</span> <span class="p">(</span><span class="n">MASK_01</span> <span class="o">|</span> <span class="n">MASK_15</span><span class="p">)</span>      <span class="c1">// DEBI</span>
	   <span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Disable RPS1 and RPS0</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="p">(</span> <span class="n">MASK_29</span> <span class="o">|</span> <span class="n">MASK_28</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>RPS1 timeout disable</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPS_TOV1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>code for autodetection
will wait for VBI<em>B event (vertical blank at port B)
and will reset GPIO3 after VBI</em>B is detected.
(GPIO3 should be raised high by CPU to
test if GPIO3 will generate vertical blank signal
in budget patch GPIO3 is connected to VSYNC_B</p></td><td class="code"><div class="highlight"><pre>	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	WRITE_RPS1(CMD_UPLOAD |</span>
<span class="c">	  MASK_10 | MASK_09 | MASK_08 | MASK_06 | MASK_05 | MASK_04 | MASK_03 | MASK_02 );</span>
<span class="cp">#endif</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_PAUSE</span> <span class="o">|</span> <span class="n">EVT_VBI_B</span><span class="p">);</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_WR_REG_MASK</span> <span class="o">|</span> <span class="p">(</span><span class="n">GPIO_CTRL</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">GPIO3_MSK</span><span class="p">);</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">SAA7146_GPIO_OUTLO</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">);</span>
<span class="cp">#if RPS_IRQ</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>issue RPS1 interrupt to increment counter</p></td><td class="code"><div class="highlight"><pre>	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>at least a NOP is neede between two interrupts</p></td><td class="code"><div class="highlight"><pre>	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_NOP</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>interrupt again</p></td><td class="code"><div class="highlight"><pre>	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_STOP</span><span class="p">);</span>

<span class="cp">#if RPS_IRQ</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>set event counter 1 source as RPS1 interrupt (0x03)          (rE4 p53)
use 0x03 to track RPS1 interrupts - increase by 1 every gpio3 is toggled
use 0x15 to track VPE  interrupts - increase by 1 every vpeirq() is called</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EC1SSR</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x03</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">3</span> <span class="p">);</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>set event counter 1 threshold to maximum allowed value        (rEC p55)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ECT1R</span><span class="p">,</span>  <span class="mh">0x3fff</span> <span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Fix VSYNC level</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Set RPS1 Address register to point to RPS code               (r108 p42)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPS_ADDR1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">d_rps1</span><span class="p">.</span><span class="n">dma_handle</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Enable RPS1,                                                 (rFC p33)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_13</span> <span class="o">|</span> <span class="n">MASK_29</span> <span class="p">));</span>


	<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTHI</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>


	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">saa7146_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GPIO_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10000000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">detected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#if RPS_IRQ</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Event Counter 1 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saa7146_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EC1R</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span> <span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Disable RPS1</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="p">(</span> <span class="n">MASK_29</span> <span class="p">));</span>

	<span class="k">if</span><span class="p">(</span><span class="n">detected</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;budget-patch not detected or saa7146 in non-default state.</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;try enabling ressetting of 7146 with MASK_31 in MC1 register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;BUDGET-PATCH DETECTED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


<span class="cm">/*      OLD (Original design by Roberto Deza):</span>
<span class="cm">**      This code will setup the SAA7146_RPS1 to generate a square</span>
<span class="cm">**      wave on GPIO3, changing when a field (TS_HEIGHT/2 &quot;lines&quot; of</span>
<span class="cm">**      TS_WIDTH packets) has been acquired on SAA7146_D1B video port;</span>
<span class="cm">**      then, this GPIO3 output which is connected to the D1B_VSYNC</span>
<span class="cm">**      input, will trigger the acquisition of the alternate field</span>
<span class="cm">**      and so on.</span>
<span class="cm">**      Currently, the TT_budget / WinTV_Nova cards have two ICs</span>
<span class="cm">**      (74HCT4040, LVC74) for the generation of this VSYNC signal,</span>
<span class="cm">**      which seems that can be done perfectly without this :-)).</span>
<span class="cm">*/</span>

<span class="cm">/*      New design (By Emard)</span>
<span class="cm">**      this rps1 code will copy internal HS event to GPIO3 pin.</span>
<span class="cm">**      GPIO3 is in budget-patch hardware connected to port B VSYNC</span>

<span class="cm">**      HS is an internal event of 7146, accessible with RPS</span>
<span class="cm">**      and temporarily raised high every n lines</span>
<span class="cm">**      (n in defined in the RPS_THRESH1 counter threshold)</span>
<span class="cm">**      I think HS is raised high on the beginning of the n-th line</span>
<span class="cm">**      and remains high until this n-th line that triggered</span>
<span class="cm">**      it is completely received. When the reception of n-th line</span>
<span class="cm">**      ends, HS is lowered.</span>

<span class="cm">**      To transmit data over DMA, 7146 needs changing state at</span>
<span class="cm">**      port B VSYNC pin. Any changing of port B VSYNC will</span>
<span class="cm">**      cause some DMA data transfer, with more or less packets loss.</span>
<span class="cm">**      It depends on the phase and frequency of VSYNC and</span>
<span class="cm">**      the way of 7146 is instructed to trigger on port B (defined</span>
<span class="cm">**      in DD1_INIT register, 3rd nibble from the right valid</span>
<span class="cm">**      numbers are 0-7, see datasheet)</span>
<span class="cm">**</span>
<span class="cm">**      The correct triggering can minimize packet loss,</span>
<span class="cm">**      dvbtraffic should give this stable bandwidths:</span>
<span class="cm">**        22k transponder = 33814 kbit/s</span>
<span class="cm">**      27.5k transponder = 38045 kbit/s</span>
<span class="cm">**      by experiment it is found that the best results</span>
<span class="cm">**      (stable bandwidths and almost no packet loss)</span>
<span class="cm">**      are obtained using DD1_INIT triggering number 2</span>
<span class="cm">**      (Va at rising edge of VS Fa = HS x VS-failing forced toggle)</span>
<span class="cm">**      and a VSYNC phase that occurs in the middle of DMA transfer</span>
<span class="cm">**      (about byte 188*512=96256 in the DMA window).</span>
<span class="cm">**</span>
<span class="cm">**      Phase of HS is still not clear to me how to control,</span>
<span class="cm">**      It just happens to be so. It can be seen if one enables</span>
<span class="cm">**      RPS_IRQ and print Event Counter 1 in vpeirq(). Every</span>
<span class="cm">**      time RPS_INTERRUPT is called, the Event Counter 1 will</span>
<span class="cm">**      increment. That&#39;s how the 7146 is programmed to do event</span>
<span class="cm">**      counting in this budget-patch.c</span>
<span class="cm">**      I *think* HPS setting has something to do with the phase</span>
<span class="cm">**      of HS but I can&#39;t be 100% sure in that.</span>

<span class="cm">**      hardware debug note: a working budget card (including budget patch)</span>
<span class="cm">**      with vpeirq() interrupt setup in mode &quot;0x90&quot; (every 64K) will</span>
<span class="cm">**      generate 3 interrupts per 25-Hz DMA frame of 2*188*512 bytes</span>
<span class="cm">**      and that means 3*25=75 Hz of interrupt frequency, as seen by</span>
<span class="cm">**      watch cat /proc/interrupts</span>
<span class="cm">**</span>
<span class="cm">**      If this frequency is 3x lower (and data received in the DMA</span>
<span class="cm">**      buffer don&#39;t start with 0x47, but in the middle of packets,</span>
<span class="cm">**      whose lengths appear to be like 188 292 188 104 etc.</span>
<span class="cm">**      this means VSYNC line is not connected in the hardware.</span>
<span class="cm">**      (check soldering pcb and pins)</span>
<span class="cm">**      The same behaviour of missing VSYNC can be duplicated on budget</span>
<span class="cm">**      cards, by setting DD1_INIT trigger mode 7 in 3rd nibble.</span>
<span class="cm">*/</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Setup RPS1 "program" (p35)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Wait Source Line Counter Threshold                           (p36)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_PAUSE</span> <span class="o">|</span> <span class="n">EVT_HS</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Set GPIO3=1                                                  (p42)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_WR_REG_MASK</span> <span class="o">|</span> <span class="p">(</span><span class="n">GPIO_CTRL</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">GPIO3_MSK</span><span class="p">);</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">SAA7146_GPIO_OUTHI</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">);</span>
<span class="cp">#if RPS_IRQ</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>issue RPS1 interrupt</p></td><td class="code"><div class="highlight"><pre>	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Wait reset Source Line Counter Threshold                     (p36)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_PAUSE</span> <span class="o">|</span> <span class="n">RPS_INV</span> <span class="o">|</span> <span class="n">EVT_HS</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Set GPIO3=0                                                  (p42)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_WR_REG_MASK</span> <span class="o">|</span> <span class="p">(</span><span class="n">GPIO_CTRL</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">GPIO3_MSK</span><span class="p">);</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">SAA7146_GPIO_OUTLO</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">);</span>
<span class="cp">#if RPS_IRQ</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>issue RPS1 interrupt</p></td><td class="code"><div class="highlight"><pre>	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_INTERRUPT</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Jump to begin of RPS program                                 (p37)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">CMD_JUMP</span><span class="p">);</span>
	<span class="n">WRITE_RPS1</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">d_rps1</span><span class="p">.</span><span class="n">dma_handle</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Fix VSYNC level</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_setgpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAA7146_GPIO_OUTLO</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Set RPS1 Address register to point to RPS code               (r108 p42)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPS_ADDR1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">d_rps1</span><span class="p">.</span><span class="n">dma_handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">budget</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">budget_patch</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;budget: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ttpci_budget_init</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">budget</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Set Source Line Counter Threshold, using BRS                 (rCC p43)
It generates HS event every TS<em>HEIGHT lines
this is related to TS</em>WIDTH set in register
NUM<em>LINE</em>BYTE3 in budget-core.c. If NUM<em>LINE</em>BYTE
low 16 bits are set to TS<em>WIDTH bytes (TS</em>WIDTH=2*188
,then RPS<em>THRESH1
should be set to trigger every TS</em>HEIGHT (512) lines.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPS_THRESH1</span><span class="p">,</span> <span class="n">budget</span><span class="o">-&gt;</span><span class="n">buffer_height</span> <span class="o">|</span> <span class="n">MASK_12</span> <span class="p">);</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>saa7146<em>write(dev, RPS</em>THRESH0, ((TS<em>HEIGHT/2)&lt;&lt;16) |MASK</em>28| (TS<em>HEIGHT/2) |MASK</em>12 );
Enable RPS1                                                  (rFC p33)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">saa7146_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MC1</span><span class="p">,</span> <span class="p">(</span><span class="n">MASK_13</span> <span class="o">|</span> <span class="n">MASK_29</span><span class="p">));</span>


	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>

	<span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>
	<span class="n">frontend_init</span><span class="p">(</span><span class="n">budget</span><span class="p">);</span>

	<span class="n">ttpci_budget_init_hooks</span><span class="p">(</span><span class="n">budget</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">budget_patch_detach</span> <span class="p">(</span><span class="k">struct</span> <span class="n">saa7146_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">budget_patch</span> <span class="o">*</span><span class="n">budget</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">budget_patch</span><span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ext_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvb_unregister_frontend</span><span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="p">);</span>
		<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">dvb_frontend</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ttpci_budget_deinit</span> <span class="p">(</span><span class="n">budget</span><span class="p">);</span>

	<span class="n">kfree</span> <span class="p">(</span><span class="n">budget</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">budget_patch_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">saa7146_register_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_extension</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">budget_patch_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">saa7146_unregister_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">budget_extension</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7146_extension</span> <span class="n">budget_extension</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;budget_patch dvb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

	<span class="p">.</span><span class="n">module</span>         <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pci_tbl</span>        <span class="o">=</span> <span class="n">pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>         <span class="o">=</span> <span class="n">budget_patch_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>         <span class="o">=</span> <span class="n">budget_patch_detach</span><span class="p">,</span>

	<span class="p">.</span><span class="n">irq_mask</span>       <span class="o">=</span> <span class="n">MASK_10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_func</span>       <span class="o">=</span> <span class="n">ttpci_budget_irq10_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">budget_patch_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">budget_patch_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Emard, Roberto Deza, Holger Waechtler, Michael Hunold, others&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for full TS modified DVB-S SAA7146+AV7110 &quot;</span>
		   <span class="s">&quot;based so-called Budget Patch cards&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
