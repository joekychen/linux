<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › ttpci › av7110_av.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>av7110_av.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * av7110_av.c: audio and video MPEG decoder stuff</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999-2002 Ralph  Metzler</span>
<span class="cm"> *                       &amp; Marcus Metzler for convergence integrated media GmbH</span>
<span class="cm"> *</span>
<span class="cm"> * originally based on code by:</span>
<span class="cm"> * Copyright (C) 1998,1999 Christian Theiss &lt;mistert@rz.fh-augsburg.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> * Or, point your browser to http://www.gnu.org/copyleft/gpl.html</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * the project&#39;s page is at http://www.linuxtv.org/ </span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>

<span class="cp">#include &quot;av7110.h&quot;</span>
<span class="cp">#include &quot;av7110_hw.h&quot;</span>
<span class="cp">#include &quot;av7110_av.h&quot;</span>
<span class="cp">#include &quot;av7110_ipack.h&quot;</span>

<span class="cm">/* MPEG-2 (ISO 13818 / H.222.0) stream types */</span>
<span class="cp">#define PROG_STREAM_MAP  0xBC</span>
<span class="cp">#define PRIVATE_STREAM1  0xBD</span>
<span class="cp">#define PADDING_STREAM	 0xBE</span>
<span class="cp">#define PRIVATE_STREAM2  0xBF</span>
<span class="cp">#define AUDIO_STREAM_S	 0xC0</span>
<span class="cp">#define AUDIO_STREAM_E	 0xDF</span>
<span class="cp">#define VIDEO_STREAM_S	 0xE0</span>
<span class="cp">#define VIDEO_STREAM_E	 0xEF</span>
<span class="cp">#define ECM_STREAM	 0xF0</span>
<span class="cp">#define EMM_STREAM	 0xF1</span>
<span class="cp">#define DSM_CC_STREAM	 0xF2</span>
<span class="cp">#define ISO13522_STREAM  0xF3</span>
<span class="cp">#define PROG_STREAM_DIR  0xFF</span>

<span class="cp">#define PTS_DTS_FLAGS	 0xC0</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>pts_dts flags</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define PTS_ONLY	 0x80</span>
<span class="cp">#define PTS_DTS		 0xC0</span>
<span class="cp">#define TS_SIZE		 188</span>
<span class="cp">#define TRANS_ERROR	 0x80</span>
<span class="cp">#define PAY_START	 0x40</span>
<span class="cp">#define TRANS_PRIO	 0x20</span>
<span class="cp">#define PID_MASK_HI	 0x1F</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>flags</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define TRANS_SCRMBL1	 0x80</span>
<span class="cp">#define TRANS_SCRMBL2	 0x40</span>
<span class="cp">#define ADAPT_FIELD	 0x20</span>
<span class="cp">#define PAYLOAD		 0x10</span>
<span class="cp">#define COUNT_MASK	 0x0F</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>adaptation flags</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define DISCON_IND	 0x80</span>
<span class="cp">#define RAND_ACC_IND	 0x40</span>
<span class="cp">#define ES_PRI_IND	 0x20</span>
<span class="cp">#define PCR_FLAG	 0x10</span>
<span class="cp">#define OPCR_FLAG	 0x08</span>
<span class="cp">#define SPLICE_FLAG	 0x04</span>
<span class="cp">#define TRANS_PRIV	 0x02</span>
<span class="cp">#define ADAP_EXT_FLAG	 0x01</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>adaptation extension flags</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define LTW_FLAG	 0x80</span>
<span class="cp">#define PIECE_RATE	 0x40</span>
<span class="cp">#define SEAM_SPLICE	 0x20</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">p_to_t</span><span class="p">(</span><span class="n">u8</span> <span class="k">const</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pid</span><span class="p">,</span>
		   <span class="n">u8</span> <span class="o">*</span><span class="n">counter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">write_ts_to_decoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">av7110_record_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_filter_pes2ts</span> <span class="o">*</span><span class="n">p2t</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">dvbdmxfeed</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="p">)</span> <span class="n">p2t</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_PACKET</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xe0</span><span class="p">)</span>	 <span class="c1">// video PES do not have a length in TS</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">ts_type</span> <span class="o">&amp;</span> <span class="n">TS_PAYLOAD_ONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">.</span><span class="n">ts</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">.</span><span class="n">ts</span><span class="p">,</span> <span class="n">DMX_OK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">dvb_filter_pes2ts</span><span class="p">(</span><span class="n">p2t</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_filter_pes2ts_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">dvbdmxfeed</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">.</span><span class="n">ts</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">.</span><span class="n">ts</span><span class="p">,</span> <span class="n">DMX_OK</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">av7110_av_start_record</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="kt">int</span> <span class="n">av</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">dvbdmxfeed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">dvbdmx</span> <span class="o">=</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, , dvb_demux_feed:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">,</span> <span class="n">dvbdmxfeed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">||</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">rec_mode</span> <span class="o">&amp;</span> <span class="n">av</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Stop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">recording</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">rec_mode</span> <span class="o">|=</span> <span class="n">av</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">rec_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RP_AUDIO</span>:
		<span class="n">dvb_filter_pes2ts_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">p2t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				       <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">pesfilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				       <span class="n">dvb_filter_pes2ts_cb</span><span class="p">,</span>
				       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">pesfilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Record</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AudioPES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RP_VIDEO</span>:
		<span class="n">dvb_filter_pes2ts_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">p2t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				       <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">pesfilter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				       <span class="n">dvb_filter_pes2ts_cb</span><span class="p">,</span>
				       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">pesfilter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Record</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">VideoPES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RP_AV</span>:
		<span class="n">dvb_filter_pes2ts_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">p2t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				       <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">pesfilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				       <span class="n">dvb_filter_pes2ts_cb</span><span class="p">,</span>
				       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">pesfilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">dvb_filter_pes2ts_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">p2t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				       <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">pesfilter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				       <span class="n">dvb_filter_pes2ts_cb</span><span class="p">,</span>
				       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dvbdmx</span><span class="o">-&gt;</span><span class="n">pesfilter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Record</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AV_PES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">av7110_av_start_play</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="kt">int</span> <span class="n">av</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">rec_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">&amp;</span> <span class="n">av</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Stop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">==</span> <span class="n">RP_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">av7110_ipack_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ipack</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">av7110_ipack_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ipack</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">|=</span> <span class="n">av</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RP_AUDIO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Play</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AudioPES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RP_VIDEO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Play</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">VideoPES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">sinfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RP_AV</span>:
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">sinfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Play</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AV_PES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">av7110_av_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="kt">int</span> <span class="n">av</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">&amp;</span> <span class="n">av</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">rec_mode</span> <span class="o">&amp;</span> <span class="n">av</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Stop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">av</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RP_AUDIO</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Play</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AudioPES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RP_VIDEO</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Play</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">VideoPES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RP_NONE</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_set_vidmode</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">vidmode</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">rec_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">av</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">rec_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RP_AUDIO</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Record</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AudioPES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RP_VIDEO</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Record</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">VideoPES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RP_NONE</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">av7110_pes_play</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_ringbuffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sync</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">blen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">dvb_ringbuffer_avail</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sync</span> <span class="o">=</span>  <span class="n">DVB_RINGBUFFER_PEEK</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">sync</span> <span class="o">|=</span> <span class="n">DVB_RINGBUFFER_PEEK</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">sync</span> <span class="o">|=</span> <span class="n">DVB_RINGBUFFER_PEEK</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sync</span> <span class="o">|=</span> <span class="n">DVB_RINGBUFFER_PEEK</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">sync</span> <span class="o">&amp;~</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x000001e0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">sync</span> <span class="o">&amp;~</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x000001c0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">sync</span> <span class="o">==</span> <span class="mh">0x000001bd</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;resync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DVB_RINGBUFFER_SKIP</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">blen</span> <span class="o">=</span>  <span class="n">DVB_RINGBUFFER_PEEK</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">blen</span> <span class="o">|=</span> <span class="n">DVB_RINGBUFFER_PEEK</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">blen</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">blen</span> <span class="o">||</span> <span class="n">blen</span> <span class="o">&gt;</span> <span class="n">dlen</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>printk("buffer empty - avail %d blen %u dlen %d\n", len, blen, dlen);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dvb_ringbuffer_read</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">blen</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;pread=0x%08lx, pwrite=0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">pread</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">pwrite</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">blen</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">av7110_set_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="kt">int</span> <span class="n">volleft</span><span class="p">,</span> <span class="kt">int</span> <span class="n">volright</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">balance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">.</span><span class="n">volume_left</span> <span class="o">=</span> <span class="n">volleft</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">.</span><span class="n">volume_right</span> <span class="o">=</span> <span class="n">volright</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DVB_ADAC_TI</span>:
		<span class="n">volleft</span> <span class="o">=</span> <span class="p">(</span><span class="n">volleft</span> <span class="o">*</span> <span class="mi">256</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1036</span><span class="p">;</span>
		<span class="n">volright</span> <span class="o">=</span> <span class="p">(</span><span class="n">volright</span> <span class="o">*</span> <span class="mi">256</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1036</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">volleft</span> <span class="o">&gt;</span> <span class="mh">0x3f</span><span class="p">)</span>
			<span class="n">volleft</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">volright</span> <span class="o">&gt;</span> <span class="mh">0x3f</span><span class="p">)</span>
			<span class="n">volright</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">SendDAC</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">+</span> <span class="n">volleft</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">SendDAC</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">volright</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">DVB_ADAC_CRYSTAL</span>:
		<span class="n">volleft</span> <span class="o">=</span> <span class="mi">127</span> <span class="o">-</span> <span class="n">volleft</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">volright</span> <span class="o">=</span> <span class="mi">127</span> <span class="o">-</span> <span class="n">volright</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">i2c_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">volleft</span><span class="p">);</span>
		<span class="n">i2c_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">volright</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DVB_ADAC_MSP34x0</span>:
		<span class="n">vol</span>  <span class="o">=</span> <span class="p">(</span><span class="n">volleft</span> <span class="o">&gt;</span> <span class="n">volright</span><span class="p">)</span> <span class="o">?</span> <span class="n">volleft</span> <span class="o">:</span> <span class="n">volright</span><span class="p">;</span>
		<span class="n">val</span>	<span class="o">=</span> <span class="p">(</span><span class="n">vol</span> <span class="o">*</span> <span class="mh">0x73</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		       <span class="n">balance</span> <span class="o">=</span> <span class="p">((</span><span class="n">volright</span> <span class="o">-</span> <span class="n">volleft</span><span class="p">)</span> <span class="o">*</span> <span class="mi">127</span><span class="p">)</span> <span class="o">/</span> <span class="n">vol</span><span class="p">;</span>
		<span class="n">msp_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">MSP_WR_DSP</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">balance</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">msp_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">MSP_WR_DSP</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span> <span class="cm">/* loudspeaker */</span>
		<span class="n">msp_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">MSP_WR_DSP</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span> <span class="cm">/* headphonesr */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DVB_ADAC_MSP34x5</span>:
		<span class="n">vol</span> <span class="o">=</span> <span class="p">(</span><span class="n">volleft</span> <span class="o">&gt;</span> <span class="n">volright</span><span class="p">)</span> <span class="o">?</span> <span class="n">volleft</span> <span class="o">:</span> <span class="n">volright</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">vol</span> <span class="o">*</span> <span class="mh">0x73</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">balance</span> <span class="o">=</span> <span class="p">((</span><span class="n">volright</span> <span class="o">-</span> <span class="n">volleft</span><span class="p">)</span> <span class="o">*</span> <span class="mi">127</span><span class="p">)</span> <span class="o">/</span> <span class="n">vol</span><span class="p">;</span>
		<span class="n">msp_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">MSP_WR_DSP</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">balance</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">msp_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">MSP_WR_DSP</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span> <span class="cm">/* loudspeaker */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">av7110_set_vidmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="k">enum</span> <span class="n">av7110_video_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_ENCODER</span><span class="p">,</span> <span class="n">LoadVidCode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ChangePIDs</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_VIDEO</span><span class="p">],</span>
			   <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_AUDIO</span><span class="p">],</span>
			   <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_TELETEXT</span><span class="p">],</span>
			   <span class="mi">0</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">pids</span><span class="p">[</span><span class="n">DMX_PES_PCR</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_PIDFILTER</span><span class="p">,</span> <span class="n">Scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">enum</span> <span class="n">av7110_video_mode</span> <span class="n">sw2mode</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AV7110_VIDEO_MODE_PAL</span><span class="p">,</span> <span class="n">AV7110_VIDEO_MODE_NTSC</span><span class="p">,</span>
	<span class="n">AV7110_VIDEO_MODE_NTSC</span><span class="p">,</span> <span class="n">AV7110_VIDEO_MODE_PAL</span><span class="p">,</span>
	<span class="n">AV7110_VIDEO_MODE_NTSC</span><span class="p">,</span> <span class="n">AV7110_VIDEO_MODE_NTSC</span><span class="p">,</span>
	<span class="n">AV7110_VIDEO_MODE_PAL</span><span class="p">,</span> <span class="n">AV7110_VIDEO_MODE_NTSC</span><span class="p">,</span>
	<span class="n">AV7110_VIDEO_MODE_PAL</span><span class="p">,</span> <span class="n">AV7110_VIDEO_MODE_PAL</span><span class="p">,</span>
	<span class="n">AV7110_VIDEO_MODE_PAL</span><span class="p">,</span> <span class="n">AV7110_VIDEO_MODE_PAL</span><span class="p">,</span>
	<span class="n">AV7110_VIDEO_MODE_PAL</span><span class="p">,</span> <span class="n">AV7110_VIDEO_MODE_PAL</span><span class="p">,</span>
	<span class="n">AV7110_VIDEO_MODE_PAL</span><span class="p">,</span> <span class="n">AV7110_VIDEO_MODE_PAL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_video_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hsize</span><span class="p">,</span> <span class="n">vsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">sinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x01</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xb3</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">hsize</span> <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span><span class="mh">0xF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">vsize</span> <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span><span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">sw</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_set_vidmode</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">sw2mode</span><span class="p">[</span><span class="n">sw</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;playback %dx%d fr=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hsize</span><span class="p">,</span> <span class="n">vsize</span><span class="p">,</span> <span class="n">sw</span><span class="p">);</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">sinfo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * I/O buffer management and control</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span> <span class="nf">aux_ring_buffer_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ringbuffer</span> <span class="o">*</span><span class="n">rbuf</span><span class="p">,</span>
					 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">todo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb_ringbuffer_free</span><span class="p">(</span><span class="n">rbuf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">rbuf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
						     <span class="p">(</span><span class="n">dvb_ringbuffer_free</span><span class="p">(</span><span class="n">rbuf</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">todo</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">free</span> <span class="o">=</span> <span class="n">dvb_ringbuffer_free</span><span class="p">(</span><span class="n">rbuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">free</span> <span class="o">&gt;</span> <span class="n">todo</span><span class="p">)</span>
			<span class="n">free</span> <span class="o">=</span> <span class="n">todo</span><span class="p">;</span>
		<span class="n">dvb_ringbuffer_write</span><span class="p">(</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>
		<span class="n">todo</span> <span class="o">-=</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">todo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">play_video_cb</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_video_format</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">aux_ring_buffer_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avout</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">aux_ring_buffer_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">play_audio_cb</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="n">aux_ring_buffer_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define FREE_COND_TS (dvb_ringbuffer_free(rb) &gt;= 4096)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ts_play</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nonblock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_ringbuffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">kb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: type %d cnt %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">rb</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avout</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">;</span>
	<span class="n">kb</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">kbuf</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">FREE_COND_TS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">todo</span> <span class="o">&gt;=</span> <span class="n">TS_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FREE_COND_TS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">todo</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">FREE_COND_TS</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">todo</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">kb</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">TS_SIZE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">write_ts_to_decoder</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">TS_SIZE</span><span class="p">);</span>
		<span class="n">todo</span> <span class="o">-=</span> <span class="n">TS_SIZE</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">TS_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">todo</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define FREE_COND (dvb_ringbuffer_free(&amp;av7110-&gt;avout) &gt;= 20 * 1024 &amp;&amp; \</span>
<span class="cp">		   dvb_ringbuffer_free(&amp;av7110-&gt;aout) &gt;= 20 * 1024)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dvb_play</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nonblock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">count</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">kbuf</span><span class="p">[</span><span class="n">type</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">FREE_COND</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">todo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FREE_COND</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">todo</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avout</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span>
						     <span class="n">FREE_COND</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">todo</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">todo</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">IPACKS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">IPACKS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">kbuf</span><span class="p">[</span><span class="n">type</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">av7110_ipack_instant_repack</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">kbuf</span><span class="p">[</span><span class="n">type</span><span class="p">],</span> <span class="n">n</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ipack</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
		<span class="n">todo</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">todo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dvb_play_kernel</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nonblock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">count</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">kbuf</span><span class="p">[</span><span class="n">type</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">FREE_COND</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">todo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FREE_COND</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">todo</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avout</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span>
						     <span class="n">FREE_COND</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">todo</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">todo</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">IPACKS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">IPACKS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">av7110_ipack_instant_repack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ipack</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
		<span class="n">todo</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">todo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dvb_aplay</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nonblock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">count</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">kbuf</span><span class="p">[</span><span class="n">type</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span> <span class="o">&amp;&amp;</span> <span class="n">dvb_ringbuffer_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">todo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb_ringbuffer_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">todo</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span>
					<span class="p">(</span><span class="n">dvb_ringbuffer_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">count</span><span class="o">-</span><span class="n">todo</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">todo</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">IPACKS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">IPACKS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">kbuf</span><span class="p">[</span><span class="n">type</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">av7110_ipack_instant_repack</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">kbuf</span><span class="p">[</span><span class="n">type</span><span class="p">],</span> <span class="n">n</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ipack</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
		<span class="n">todo</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">todo</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">av7110_p2t_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110_p2t</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TS_SIZE</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">feed</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">feed</span> <span class="o">=</span> <span class="n">feed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_p2t</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110_p2t</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TS_SIZE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>p->counter = 0;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">p</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_pes_header</span><span class="p">(</span><span class="n">u8</span> <span class="k">const</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">frags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">frags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
		    <span class="n">buf</span><span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span> <span class="n">buf</span><span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PROG_STREAM_MAP</span>:
			<span class="k">case</span> <span class="n">PRIVATE_STREAM2</span>:
			<span class="k">case</span> <span class="n">PROG_STREAM_DIR</span>:
			<span class="k">case</span> <span class="n">ECM_STREAM</span>     :
			<span class="k">case</span> <span class="n">EMM_STREAM</span>     :
			<span class="k">case</span> <span class="n">PADDING_STREAM</span> :
			<span class="k">case</span> <span class="n">DSM_CC_STREAM</span>  :
			<span class="k">case</span> <span class="n">ISO13522_STREAM</span>:
			<span class="k">case</span> <span class="n">PRIVATE_STREAM1</span>:
			<span class="k">case</span> <span class="n">AUDIO_STREAM_S</span> <span class="p">...</span> <span class="n">AUDIO_STREAM_E</span>:
			<span class="k">case</span> <span class="n">VIDEO_STREAM_S</span> <span class="p">...</span> <span class="n">VIDEO_STREAM_E</span>:
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">c</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">c</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
			<span class="o">*</span><span class="n">frags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
		    <span class="n">buf</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
			<span class="o">*</span><span class="n">frags</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
		    <span class="n">buf</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
		    <span class="n">buf</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="o">*</span><span class="n">frags</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">av7110_p2t_write</span><span class="p">(</span><span class="n">u8</span> <span class="k">const</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">av7110_p2t</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">add</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">check</span><span class="p">,</span> <span class="n">rest</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">){</span>
		<span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">c</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">c</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PROG_STREAM_MAP</span>:
			<span class="k">case</span> <span class="n">PRIVATE_STREAM2</span>:
			<span class="k">case</span> <span class="n">PROG_STREAM_DIR</span>:
			<span class="k">case</span> <span class="n">ECM_STREAM</span>     :
			<span class="k">case</span> <span class="n">EMM_STREAM</span>     :
			<span class="k">case</span> <span class="n">PADDING_STREAM</span> :
			<span class="k">case</span> <span class="n">DSM_CC_STREAM</span>  :
			<span class="k">case</span> <span class="n">ISO13522_STREAM</span>:
			<span class="k">case</span> <span class="n">PRIVATE_STREAM1</span>:
			<span class="k">case</span> <span class="n">AUDIO_STREAM_S</span> <span class="p">...</span> <span class="n">AUDIO_STREAM_E</span>:
			<span class="k">case</span> <span class="n">VIDEO_STREAM_S</span> <span class="p">...</span> <span class="n">VIDEO_STREAM_E</span>:
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">pes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">pes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">pes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">pes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pes</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="n">TS_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">);</span>
				<span class="n">c</span> <span class="o">+=</span> <span class="p">(</span><span class="n">TS_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
				<span class="n">p_to_t</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pes</span><span class="p">,</span> <span class="p">(</span><span class="n">TS_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">),</span> <span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">);</span>
				<span class="n">clear_p2t</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c2</span> <span class="o">=</span> <span class="n">find_pes_header</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c2</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">c2</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">TS_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">c2</span><span class="o">+</span><span class="n">c</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">TS_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pes</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="n">c</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">p_to_t</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pes</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">);</span>
		<span class="n">clear_p2t</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">add</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c2</span> <span class="o">=</span> <span class="n">find_pes_header</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="n">add</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="n">add</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c2</span> <span class="o">+=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">add</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c2</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">){</span>
				<span class="n">p_to_t</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">);</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">c2</span><span class="p">;</span>
				<span class="n">clear_p2t</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="n">add</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">add</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>
			<span class="n">rest</span> <span class="o">=</span> <span class="n">l</span> <span class="o">%</span> <span class="p">(</span><span class="n">TS_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">l</span> <span class="o">-=</span> <span class="n">rest</span><span class="p">;</span>
			<span class="n">p_to_t</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pes</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span> <span class="n">rest</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="n">rest</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_ts_header2</span><span class="p">(</span><span class="n">u16</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">counter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pes_start</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fill</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tshead</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">};</span>

	<span class="n">fill</span> <span class="o">=</span> <span class="p">(</span><span class="n">TS_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pes_start</span><span class="p">)</span>
		<span class="n">tshead</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fill</span><span class="p">)</span>
		<span class="n">tshead</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
	<span class="n">tshead</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">pid</span> <span class="o">&amp;</span> <span class="mh">0x1F00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">tshead</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">pid</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">);</span>
	<span class="n">tshead</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="o">*</span><span class="n">counter</span><span class="p">)</span><span class="o">++</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tshead</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fill</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">c</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fill</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">c</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">p_to_t</span><span class="p">(</span><span class="n">u8</span> <span class="k">const</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">counter</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">pes_start</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">obuf</span><span class="p">[</span><span class="n">TS_SIZE</span><span class="p">];</span>
	<span class="kt">long</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pes_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
	     <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PROG_STREAM_MAP</span>:
			<span class="k">case</span> <span class="n">PRIVATE_STREAM2</span>:
			<span class="k">case</span> <span class="n">PROG_STREAM_DIR</span>:
			<span class="k">case</span> <span class="n">ECM_STREAM</span>     :
			<span class="k">case</span> <span class="n">EMM_STREAM</span>     :
			<span class="k">case</span> <span class="n">PADDING_STREAM</span> :
			<span class="k">case</span> <span class="n">DSM_CC_STREAM</span>  :
			<span class="k">case</span> <span class="n">ISO13522_STREAM</span>:
			<span class="k">case</span> <span class="n">PRIVATE_STREAM1</span>:
			<span class="k">case</span> <span class="n">AUDIO_STREAM_S</span> <span class="p">...</span> <span class="n">AUDIO_STREAM_E</span>:
			<span class="k">case</span> <span class="n">VIDEO_STREAM_S</span> <span class="p">...</span> <span class="n">VIDEO_STREAM_E</span>:
				<span class="n">pes_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">obuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TS_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">TS_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)){</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">write_ts_header2</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">pes_start</span><span class="p">,</span>
					     <span class="n">obuf</span><span class="p">,</span> <span class="p">(</span><span class="n">TS_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">obuf</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">TS_SIZE</span> <span class="o">-</span> <span class="n">l</span><span class="p">);</span>
			<span class="n">c</span> <span class="o">+=</span> <span class="n">TS_SIZE</span> <span class="o">-</span> <span class="n">l</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">write_ts_header2</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">pes_start</span><span class="p">,</span>
					     <span class="n">obuf</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="n">c</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">obuf</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">TS_SIZE</span> <span class="o">-</span> <span class="n">l</span><span class="p">);</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">feed</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">.</span><span class="n">ts</span><span class="p">(</span><span class="n">obuf</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">feed</span><span class="p">.</span><span class="n">ts</span><span class="p">,</span> <span class="n">DMX_OK</span><span class="p">);</span>
		<span class="n">pes_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_ts_to_decoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipack</span> <span class="o">*</span><span class="n">ipack</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ipack</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TRANS_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">av7110_ipack_reset</span><span class="p">(</span><span class="n">ipack</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PAYLOAD</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PAY_START</span><span class="p">)</span>
		<span class="n">av7110_ipack_flush</span><span class="p">(</span><span class="n">ipack</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ADAPT_FIELD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">av7110_ipack_instant_repack</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ipack</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">av7110_write_to_decoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">feed</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_demux</span> <span class="o">*</span><span class="n">demux</span> <span class="o">=</span> <span class="n">feed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="p">)</span> <span class="n">demux</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">full_ts</span> <span class="o">&amp;&amp;</span> <span class="n">demux</span><span class="o">-&gt;</span><span class="n">dmx</span><span class="p">.</span><span class="n">frontend</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">!=</span> <span class="n">DMX_MEMORY_FE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">feed</span><span class="o">-&gt;</span><span class="n">pes_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">==</span> <span class="n">AUDIO_SOURCE_MEMORY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">==</span> <span class="n">VIDEO_SOURCE_MEMORY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">write_ts_to_decoder</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">feed</span><span class="o">-&gt;</span><span class="n">pes_type</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/******************************************************************************</span>
<span class="cm"> * Video MPEG decoder events</span>
<span class="cm"> ******************************************************************************/</span>
<span class="kt">void</span> <span class="nf">dvb_video_add_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="k">struct</span> <span class="n">video_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_video_events</span> <span class="o">*</span><span class="n">events</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_events</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wp</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">wp</span> <span class="o">=</span> <span class="p">(</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">eventw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MAX_VIDEO_EVENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wp</span> <span class="o">==</span> <span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">events</span><span class="o">-&gt;</span><span class="n">overflow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span> <span class="o">=</span> <span class="p">(</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MAX_VIDEO_EVENT</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>FIXME: timestamp?</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">eventw</span><span class="p">],</span> <span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_event</span><span class="p">));</span>
	<span class="n">events</span><span class="o">-&gt;</span><span class="n">eventw</span> <span class="o">=</span> <span class="n">wp</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_video_get_event</span> <span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="k">struct</span> <span class="n">video_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_video_events</span> <span class="o">*</span><span class="n">events</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_events</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">overflow</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">events</span><span class="o">-&gt;</span><span class="n">overflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">eventw</span> <span class="o">==</span> <span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">,</span>
					       <span class="n">events</span><span class="o">-&gt;</span><span class="n">eventw</span> <span class="o">!=</span> <span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span><span class="p">],</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_event</span><span class="p">));</span>
	<span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span> <span class="o">=</span> <span class="p">(</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MAX_VIDEO_EVENT</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/******************************************************************************</span>
<span class="cm"> * DVB device file operations</span>
<span class="cm"> ******************************************************************************/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dvb_video_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">O_RDONLY</span><span class="p">)</span>
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avout</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_events</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_events</span><span class="p">.</span><span class="n">eventw</span> <span class="o">!=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_events</span><span class="p">.</span><span class="n">eventr</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">POLLPRI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">O_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">FREE_COND</span><span class="p">)</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="cm">/* if not playing: may play if asked for */</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dvb_video_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">O_RDONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">!=</span> <span class="n">VIDEO_SOURCE_MEMORY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mh">0x47</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">%</span> <span class="n">TS_SIZE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ts_play</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">dvb_play</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dvb_audio_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb_ringbuffer_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* if not playing: may play if asked for */</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dvb_audio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">!=</span> <span class="n">AUDIO_SOURCE_MEMORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;not audio source memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mh">0x47</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">%</span> <span class="n">TS_SIZE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ts_play</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">dvb_aplay</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">iframe_header</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>

<span class="cp">#define MIN_IFRAME 400000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">play_iframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nonblock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">progressive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">&amp;</span> <span class="n">RP_VIDEO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110_av_start_play</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">RP_VIDEO</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* search in buf for instances of 00 00 01 b5 1? */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">progressive</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">match</span> <span class="o">=</span> <span class="p">(</span><span class="n">match</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">match</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">match</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mh">0xb5</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* setting n always &gt; 1, fixes problems when playing stillframes</span>
<span class="cm">	   consisting of I- and P-Frames */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">MIN_IFRAME</span> <span class="o">/</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* FIXME: nonblock? */</span>
	<span class="n">dvb_play_kernel</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">iframe_header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iframe_header</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dvb_play</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">av7110_ipack_flush</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ipack</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">progressive</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vidcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV_VIDEO_CMD_FREEZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_video_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">parg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">parg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;av7110:%p, cmd=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">,</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">O_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">VIDEO_GET_STATUS</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">VIDEO_GET_EVENT</span> <span class="o">&amp;&amp;</span>
		     <span class="n">cmd</span> <span class="o">!=</span> <span class="n">VIDEO_GET_SIZE</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VIDEO_STOP</span>:
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">=</span> <span class="n">VIDEO_STOPPED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">==</span> <span class="n">VIDEO_SOURCE_MEMORY</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_av_stop</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">RP_VIDEO</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vidcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV_VIDEO_CMD_STOP</span><span class="p">,</span>
			       <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">video_blank</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">trickmode</span> <span class="o">=</span> <span class="n">TRICK_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_PLAY</span>:
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">trickmode</span> <span class="o">=</span> <span class="n">TRICK_NONE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">==</span> <span class="n">VIDEO_FREEZED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">=</span> <span class="n">VIDEO_PLAYING</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vidcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV_VIDEO_CMD_PLAY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">==</span> <span class="n">VIDEO_SOURCE_MEMORY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">==</span> <span class="n">RP_AV</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Stop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RP_VIDEO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_av_start_play</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">RP_VIDEO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vidcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV_VIDEO_CMD_PLAY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">=</span> <span class="n">VIDEO_PLAYING</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_FREEZE</span>:
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">=</span> <span class="n">VIDEO_FREEZED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">&amp;</span> <span class="n">RP_VIDEO</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Pause</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vidcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV_VIDEO_CMD_FREEZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">trickmode</span> <span class="o">=</span> <span class="n">TRICK_FREEZE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_CONTINUE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">&amp;</span> <span class="n">RP_VIDEO</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Continue</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vidcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV_VIDEO_CMD_PLAY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">=</span> <span class="n">VIDEO_PLAYING</span><span class="p">;</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">trickmode</span> <span class="o">=</span> <span class="n">TRICK_NONE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_SELECT_SOURCE</span>:
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">=</span> <span class="p">(</span><span class="n">video_stream_source_t</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_SET_BLANK</span>:
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">video_blank</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_GET_STATUS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">parg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_status</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_GET_EVENT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_video_get_event</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">parg</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_GET_SIZE</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">parg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">video_size_t</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_SET_DISPLAY_FORMAT</span>:
	<span class="p">{</span>
		<span class="n">video_displayformat_t</span> <span class="n">format</span> <span class="o">=</span> <span class="p">(</span><span class="n">video_displayformat_t</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">VIDEO_PAN_SCAN</span>:
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">display_panscan</span> <span class="o">=</span> <span class="n">VID_PAN_SCAN_PREF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VIDEO_LETTER_BOX</span>:
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">display_panscan</span> <span class="o">=</span> <span class="n">VID_VC_AND_PS_PREF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VIDEO_CENTER_CUT_OUT</span>:
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">display_panscan</span> <span class="o">=</span> <span class="n">VID_CENTRE_CUT_PREF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">display_format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_ENCODER</span><span class="p">,</span> <span class="n">SetPanScanType</span><span class="p">,</span>
				    <span class="mi">1</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">display_panscan</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDEO_SET_FORMAT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">display_ar</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_ENCODER</span><span class="p">,</span> <span class="n">SetMonitorType</span><span class="p">,</span>
				    <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_STILLPICTURE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">video_still_picture</span> <span class="o">*</span><span class="n">pic</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">video_still_picture</span> <span class="o">*</span><span class="p">)</span> <span class="n">parg</span><span class="p">;</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">=</span> <span class="n">VIDEO_SOURCE_MEMORY</span><span class="p">;</span>
		<span class="n">dvb_ringbuffer_flush_spinlock_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avout</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">play_iframe</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">pic</span><span class="o">-&gt;</span><span class="n">iFrame</span><span class="p">,</span> <span class="n">pic</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				  <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDEO_FAST_FORWARD</span>:</pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>note: arg is ignored by firmware</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">&amp;</span> <span class="n">RP_VIDEO</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span>
					    <span class="n">__Scan_I</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AV_PES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vidcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV_VIDEO_CMD_FFWD</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">trickmode</span> <span class="o">=</span> <span class="n">TRICK_FAST</span><span class="p">;</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">=</span> <span class="n">VIDEO_PLAYING</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_SLOWMOTION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span><span class="o">&amp;</span><span class="n">RP_VIDEO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">trickmode</span> <span class="o">!=</span> <span class="n">TRICK_SLOW</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span> <span class="n">__Slow</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">vidcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV_VIDEO_CMD_SLOW</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vidcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV_VIDEO_CMD_PLAY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">vidcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV_VIDEO_CMD_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">vidcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV_VIDEO_CMD_SLOW</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">trickmode</span> <span class="o">=</span> <span class="n">TRICK_SLOW</span><span class="p">;</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">=</span> <span class="n">VIDEO_PLAYING</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_GET_CAPABILITIES</span>:
		<span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">parg</span> <span class="o">=</span> <span class="n">VIDEO_CAP_MPEG1</span> <span class="o">|</span> <span class="n">VIDEO_CAP_MPEG2</span> <span class="o">|</span>
			<span class="n">VIDEO_CAP_SYS</span> <span class="o">|</span> <span class="n">VIDEO_CAP_PROG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_CLEAR_BUFFER</span>:
		<span class="n">dvb_ringbuffer_flush_spinlock_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avout</span><span class="p">);</span>
		<span class="n">av7110_ipack_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ipack</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">==</span> <span class="n">RP_AV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span>
					    <span class="n">__Play</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AV_PES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">trickmode</span> <span class="o">==</span> <span class="n">TRICK_FAST</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span>
						    <span class="n">__Scan_I</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AV_PES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">trickmode</span> <span class="o">==</span> <span class="n">TRICK_SLOW</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span>
						    <span class="n">__Slow</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">vidcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV_VIDEO_CMD_SLOW</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">trickmode</span> <span class="o">==</span> <span class="n">TRICK_FREEZE</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">vidcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AV_VIDEO_CMD_STOP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDEO_SET_STREAMTYPE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_audio_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">parg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">parg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;av7110:%p, cmd=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">,</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">O_RDONLY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">AUDIO_GET_STATUS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AUDIO_STOP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">==</span> <span class="n">AUDIO_SOURCE_MEMORY</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_av_stop</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">RP_AUDIO</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">audcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AUDIO_CMD_MUTE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">=</span> <span class="n">AUDIO_STOPPED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_PLAY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">==</span> <span class="n">AUDIO_SOURCE_MEMORY</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_av_start_play</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">RP_AUDIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">audcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AUDIO_CMD_UNMUTE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">=</span> <span class="n">AUDIO_PLAYING</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_PAUSE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">audcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AUDIO_CMD_MUTE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">=</span> <span class="n">AUDIO_PAUSED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_CONTINUE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">==</span> <span class="n">AUDIO_PAUSED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">=</span> <span class="n">AUDIO_PLAYING</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">audcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AUDIO_CMD_UNMUTE</span> <span class="o">|</span> <span class="n">AUDIO_CMD_PCM16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_SELECT_SOURCE</span>:
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">=</span> <span class="p">(</span><span class="n">audio_stream_source_t</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_SET_MUTE</span>:
	<span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">audcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">arg</span> <span class="o">?</span> <span class="n">AUDIO_CMD_MUTE</span> <span class="o">:</span> <span class="n">AUDIO_CMD_UNMUTE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">mute_state</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">AUDIO_SET_AV_SYNC</span>:
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">AV_sync_state</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">audcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">arg</span> <span class="o">?</span> <span class="n">AUDIO_CMD_SYNC_ON</span> <span class="o">:</span> <span class="n">AUDIO_CMD_SYNC_OFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_SET_BYPASS_MODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">FW_VERSION</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x2621</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">bypass_mode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_CHANNEL_SELECT</span>:
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">channel_select</span> <span class="o">=</span> <span class="p">(</span><span class="n">audio_channel_select_t</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">channel_select</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AUDIO_STEREO</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">audcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AUDIO_CMD_STEREO</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span> <span class="o">==</span> <span class="n">DVB_ADAC_CRYSTAL</span><span class="p">)</span>
					<span class="n">i2c_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span> <span class="o">==</span> <span class="n">DVB_ADAC_MSP34x5</span><span class="p">)</span>
					<span class="n">msp_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">MSP_WR_DSP</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0220</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIO_MONO_LEFT</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">audcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AUDIO_CMD_MONO_L</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span> <span class="o">==</span> <span class="n">DVB_ADAC_CRYSTAL</span><span class="p">)</span>
					<span class="n">i2c_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span> <span class="o">==</span> <span class="n">DVB_ADAC_MSP34x5</span><span class="p">)</span>
					<span class="n">msp_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">MSP_WR_DSP</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIO_MONO_RIGHT</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">audcom</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">AUDIO_CMD_MONO_R</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span> <span class="o">==</span> <span class="n">DVB_ADAC_CRYSTAL</span><span class="p">)</span>
					<span class="n">i2c_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">adac_type</span> <span class="o">==</span> <span class="n">DVB_ADAC_MSP34x5</span><span class="p">)</span>
					<span class="n">msp_writereg</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">MSP_WR_DSP</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0210</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_GET_STATUS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">parg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audio_status</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_GET_CAPABILITIES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">FW_VERSION</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">arm_app</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x2621</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">parg</span> <span class="o">=</span> <span class="n">AUDIO_CAP_LPCM</span> <span class="o">|</span> <span class="n">AUDIO_CAP_MP1</span> <span class="o">|</span> <span class="n">AUDIO_CAP_MP2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">parg</span> <span class="o">=</span> <span class="n">AUDIO_CAP_LPCM</span> <span class="o">|</span> <span class="n">AUDIO_CAP_DTS</span> <span class="o">|</span> <span class="n">AUDIO_CAP_AC3</span> <span class="o">|</span>
						<span class="n">AUDIO_CAP_MP1</span> <span class="o">|</span> <span class="n">AUDIO_CAP_MP2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_CLEAR_BUFFER</span>:
		<span class="n">dvb_ringbuffer_flush_spinlock_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">);</span>
		<span class="n">av7110_ipack_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ipack</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">==</span> <span class="n">RP_AV</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_fw_cmd</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">COMTYPE_REC_PLAY</span><span class="p">,</span>
					    <span class="n">__Play</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AV_PES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_SET_ID</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_SET_MIXER</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">audio_mixer</span> <span class="o">*</span><span class="n">amix</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">audio_mixer</span> <span class="o">*</span><span class="p">)</span><span class="n">parg</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_set_volume</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">amix</span><span class="o">-&gt;</span><span class="n">volume_left</span><span class="p">,</span> <span class="n">amix</span><span class="o">-&gt;</span><span class="n">volume_right</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">AUDIO_SET_STREAMTYPE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_video_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">dvb_generic_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">O_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvb_ringbuffer_flush_spinlock_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">);</span>
		<span class="n">dvb_ringbuffer_flush_spinlock_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avout</span><span class="p">);</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_blank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">AV_sync_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">=</span> <span class="n">VIDEO_SOURCE_DEMUX</span><span class="p">;</span>

		<span class="cm">/*  empty event queue */</span>
		<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_events</span><span class="p">.</span><span class="n">eventr</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_events</span><span class="p">.</span><span class="n">eventw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_video_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">O_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">av7110_av_stop</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">RP_VIDEO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dvb_generic_release</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_audio_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">dvb_generic_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">dvb_ringbuffer_flush_spinlock_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">);</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">=</span> <span class="n">AUDIO_SOURCE_DEMUX</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_audio_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;av7110:%p, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">av7110</span><span class="p">);</span>

	<span class="n">av7110_av_stop</span><span class="p">(</span><span class="n">av7110</span><span class="p">,</span> <span class="n">RP_AUDIO</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dvb_generic_release</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/******************************************************************************</span>
<span class="cm"> * driver registration</span>
<span class="cm"> ******************************************************************************/</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dvb_video_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">dvb_video_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">dvb_generic_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dvb_video_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">dvb_video_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">dvb_video_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_device</span> <span class="n">dvbdev_video</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">priv</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readers</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/* arbitrary */</span>
	<span class="p">.</span><span class="n">writers</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_video_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kernel_ioctl</span>	<span class="o">=</span> <span class="n">dvb_video_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dvb_audio_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">dvb_audio_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">dvb_generic_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dvb_audio_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">dvb_audio_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">dvb_audio_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_device</span> <span class="n">dvbdev_audio</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">priv</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">writers</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_audio_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kernel_ioctl</span>	<span class="o">=</span> <span class="n">dvb_audio_ioctl</span><span class="p">,</span>
<span class="p">};</span>


<span class="kt">int</span> <span class="nf">av7110_av_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">AV_sync_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">mute_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">=</span> <span class="n">AUDIO_STOPPED</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">=</span> <span class="n">AUDIO_SOURCE_DEMUX</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">channel_select</span> <span class="o">=</span> <span class="n">AUDIO_STEREO</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audiostate</span><span class="p">.</span><span class="n">bypass_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">video_blank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">play_state</span> <span class="o">=</span> <span class="n">VIDEO_STOPPED</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">stream_source</span> <span class="o">=</span> <span class="n">VIDEO_SOURCE_DEMUX</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">video_format</span> <span class="o">=</span> <span class="n">VIDEO_FORMAT_4_3</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">videostate</span><span class="p">.</span><span class="n">display_format</span> <span class="o">=</span> <span class="n">VIDEO_LETTER_BOX</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">display_ar</span> <span class="o">=</span> <span class="n">VIDEO_FORMAT_4_3</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">display_panscan</span> <span class="o">=</span> <span class="n">VID_VC_AND_PS_PREF</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_events</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_events</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_events</span><span class="p">.</span><span class="n">eventw</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_events</span><span class="p">.</span><span class="n">eventr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_events</span><span class="p">.</span><span class="n">overflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">video_size_t</span><span class="p">));</span>

	<span class="n">dvb_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">dvbdev_video</span><span class="p">,</span> <span class="n">av7110</span><span class="p">,</span> <span class="n">DVB_DEVICE_VIDEO</span><span class="p">);</span>

	<span class="n">dvb_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audio_dev</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">dvbdev_audio</span><span class="p">,</span> <span class="n">av7110</span><span class="p">,</span> <span class="n">DVB_DEVICE_AUDIO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">av7110_av_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dvb_unregister_device</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">audio_dev</span><span class="p">);</span>
	<span class="n">dvb_unregister_device</span><span class="p">(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">av7110_av_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">play</span><span class="p">[])(</span><span class="n">u8</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="n">play_audio_cb</span><span class="p">,</span> <span class="n">play_video_cb</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ipack</span> <span class="o">*</span><span class="n">ipack</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ipack</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">av7110_ipack_init</span><span class="p">(</span><span class="n">ipack</span><span class="p">,</span> <span class="n">IPACKS</span><span class="p">,</span> <span class="n">play</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
				<span class="n">av7110_ipack_free</span><span class="p">(</span><span class="o">--</span><span class="n">ipack</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ipack</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">av7110</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dvb_ringbuffer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">avout</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">,</span> <span class="n">AVOUTLEN</span><span class="p">);</span>
	<span class="n">dvb_ringbuffer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">aout</span><span class="p">,</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">iobuf</span> <span class="o">+</span> <span class="n">AVOUTLEN</span><span class="p">,</span> <span class="n">AOUTLEN</span><span class="p">);</span>

	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">kbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">iobuf</span> <span class="o">+</span> <span class="n">AVOUTLEN</span> <span class="o">+</span> <span class="n">AOUTLEN</span> <span class="o">+</span> <span class="n">BMPLEN</span><span class="p">);</span>
	<span class="n">av7110</span><span class="o">-&gt;</span><span class="n">kbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">av7110</span><span class="o">-&gt;</span><span class="n">kbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">IPACKS</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">av7110_av_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">av7110</span> <span class="o">*</span><span class="n">av7110</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">av7110_ipack_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ipack</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">av7110_ipack_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av7110</span><span class="o">-&gt;</span><span class="n">ipack</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
