<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › dib7000p.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dib7000p.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux-DVB Driver for DiBcom&#39;s second generation DiB7000P (PC).</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-7 DiBcom (http://www.dibcom.fr/)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *	published by the Free Software Foundation, version 2.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &quot;dvb_math.h&quot;</span>
<span class="cp">#include &quot;dvb_frontend.h&quot;</span>

<span class="cp">#include &quot;dib7000p.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;turn on debugging (default: 0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">buggy_sfn_workaround</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">buggy_sfn_workaround</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">buggy_sfn_workaround</span><span class="p">,</span> <span class="s">&quot;Enable work-around for buggy SFNs (default: 0)&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(args...) do { if (debug) { printk(KERN_DEBUG &quot;DiB7000P: &quot;); printk(args); printk(&quot;\n&quot;); } } while (0)</span>

<span class="k">struct</span> <span class="n">i2c_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i2c_addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="n">demod</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib7000p_config</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">i2c_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dibx000_i2c_master</span> <span class="n">i2c_master</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">wbd_ref</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">current_band</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">current_bandwidth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dibx000_agc_config</span> <span class="o">*</span><span class="n">current_agc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timf</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">div_force_off</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">div_state</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">div_sync_wait</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">agc_state</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">gpio_dir</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gpio_val</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">sfn_workaround_active</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#define SOC7090 0x7090</span>
	<span class="n">u16</span> <span class="n">version</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">tuner_enable</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="n">dib7090_tuner_adap</span><span class="p">;</span>

	<span class="cm">/* for the I2C transfer */</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">i2c_buffer_lock</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">input_mode_mpeg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dib7000p_power_mode</span> <span class="p">{</span>
	<span class="n">DIB7000P_POWER_ALL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DIB7000P_POWER_ANALOG_ADC</span><span class="p">,</span>
	<span class="n">DIB7000P_POWER_INTERFACE_ONLY</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* dib7090 specific fonctions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dib7090_set_output_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dib7090_set_diversity_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dib7090_setDibTxMux</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dib7090_setHostBusMux</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dib7000p_read_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;i2c read error on %d&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_write_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">?</span>
			<span class="o">-</span><span class="n">EREMOTEIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000p_write_tab</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">n</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">n</span><span class="o">++</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="o">++</span><span class="p">);</span>
			<span class="n">r</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">l</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">n</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_set_output_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">outreg</span><span class="p">,</span> <span class="n">fifo_threshold</span><span class="p">,</span> <span class="n">smo_mode</span><span class="p">;</span>

	<span class="n">outreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fifo_threshold</span> <span class="o">=</span> <span class="mi">1792</span><span class="p">;</span>
	<span class="n">smo_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">235</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0050</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting output mode for demod %p to %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_GATED_CLK</span>:
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>	<span class="cm">/* 0x0400 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_CONT_CLK</span>:
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* 0x0440 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_SERIAL</span>:
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* 0x0480 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_DIVERSITY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">hostbus_diversity</span><span class="p">)</span>
			<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* 0x0500 */</span>
		<span class="k">else</span>
			<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_FIFO</span>:
		<span class="n">smo_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fifo_threshold</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_ANALOG_ADC</span>:
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_HIGH_Z</span>:
		<span class="n">outreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Unhandled output_mode passed to be set for demod %p&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mpeg2_in_188_bytes</span><span class="p">)</span>
		<span class="n">smo_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="n">smo_mode</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">236</span><span class="p">,</span> <span class="n">fifo_threshold</span><span class="p">);</span>	<span class="cm">/* synchronous fread */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">SOC7090</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1286</span><span class="p">,</span> <span class="n">outreg</span><span class="p">);</span>	<span class="cm">/* P_Div_active */</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_set_diversity_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">div_force_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;diversity combination deactivated - forced by COFDM parameters&quot;</span><span class="p">);</span>
		<span class="n">onoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">div_sync_wait</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">div_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">onoff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="cm">/* P_dvsy_sync_mode = 0, P_dvsy_sync_enable=1, P_dvcb_comb_mode=2 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_set_power_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dib7000p_power_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* by default everything is powered off */</span>
	<span class="n">u16</span> <span class="n">reg_774</span> <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">,</span> <span class="n">reg_775</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">reg_776</span> <span class="o">=</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="n">reg_899</span> <span class="o">=</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="n">reg_1280</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xfe00</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1280</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01ff</span><span class="p">);</span>

	<span class="cm">/* now, depending on the requested mode, we power on */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* power up everything in the demod */</span>
	<span class="k">case</span> <span class="n">DIB7000P_POWER_ALL</span>:
		<span class="n">reg_774</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">reg_775</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">reg_776</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">reg_899</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span>
			<span class="n">reg_1280</span> <span class="o">&amp;=</span> <span class="mh">0x001f</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg_1280</span> <span class="o">&amp;=</span> <span class="mh">0x01ff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIB7000P_POWER_ANALOG_ADC</span>:
		<span class="cm">/* dem, cfg, iqc, sad, agc */</span>
		<span class="n">reg_774</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">));</span>
		<span class="cm">/* nud */</span>
		<span class="n">reg_776</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
		<span class="cm">/* Dout */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">SOC7090</span><span class="p">)</span>
			<span class="n">reg_1280</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>
		<span class="n">reg_1280</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="cm">/* fall through wanted to enable the interfaces */</span>

		<span class="cm">/* just leave power on the control-interfaces: GPIO and (I2C or SDIO) */</span>
	<span class="k">case</span> <span class="n">DIB7000P_POWER_INTERFACE_ONLY</span>:	<span class="cm">/* TODO power up either SDIO or I2C */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span>
			<span class="n">reg_1280</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">reg_1280</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/* TODO following stuff is just converted from the dib7000-driver - check when is used what */</span>
	<span class="p">}</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">774</span><span class="p">,</span> <span class="n">reg_774</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">775</span><span class="p">,</span> <span class="n">reg_775</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">776</span><span class="p">,</span> <span class="n">reg_776</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="n">reg_1280</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">SOC7090</span><span class="p">)</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">899</span><span class="p">,</span> <span class="n">reg_899</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000p_set_adc_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dibx000_adc_states</span> <span class="n">no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg_908</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg_909</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">SOC7090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_908</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">908</span><span class="p">);</span>
		<span class="n">reg_909</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">909</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">no</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DIBX000_SLOW_ADC_ON</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1925</span><span class="p">);</span>

			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1925</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>	<span class="cm">/* en_slowAdc = 1 &amp; reset_sladc = 1 */</span>

			<span class="n">reg</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1925</span><span class="p">);</span>	<span class="cm">/* read acces to make it works... strange ... */</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1925</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>	<span class="cm">/* en_slowAdc = 1 &amp; reset_sladc = 0 */</span>

			<span class="n">reg</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">72</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mi">524</span><span class="p">);</span>	<span class="cm">/* ref = Vin1 =&gt; Vbg ; sel = Vin0 or Vin3 ; (Vin2 = Vcm) */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">reg_909</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">909</span><span class="p">,</span> <span class="n">reg_909</span><span class="p">);</span>
			<span class="n">reg_909</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIBX000_SLOW_ADC_OFF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1925</span><span class="p">);</span>
			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1925</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>	<span class="cm">/* reset_sladc = 1 en_slowAdc = 0 */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">reg_909</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIBX000_ADC_ON</span>:
		<span class="n">reg_908</span> <span class="o">&amp;=</span> <span class="mh">0x0fff</span><span class="p">;</span>
		<span class="n">reg_909</span> <span class="o">&amp;=</span> <span class="mh">0x0003</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIBX000_ADC_OFF</span>:
		<span class="n">reg_908</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">reg_909</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIBX000_VBG_ENABLE</span>:
		<span class="n">reg_908</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIBX000_VBG_DISABLE</span>:
		<span class="n">reg_908</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>dprintk( "908: %x, 909: %x\n", reg<em>908, reg</em>909);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">reg_909</span> <span class="o">|=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">disable_sample_and_hold</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">reg_908</span> <span class="o">|=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">enable_current_mirror</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">SOC7090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">908</span><span class="p">,</span> <span class="n">reg_908</span><span class="p">);</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">909</span><span class="p">,</span> <span class="n">reg_909</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_set_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">timf</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>store the current bandwidth for later use</p></td><td class="code"><div class="highlight"><pre>	<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_bandwidth</span> <span class="o">=</span> <span class="n">bw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;using default timf&quot;</span><span class="p">);</span>
		<span class="n">timf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">timf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;using updated timf&quot;</span><span class="p">);</span>
		<span class="n">timf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">timf</span> <span class="o">=</span> <span class="n">timf</span> <span class="o">*</span> <span class="p">(</span><span class="n">bw</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">160</span><span class="p">;</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">timf</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">timf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_sad_calib</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* internal */</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">2048</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">776</span><span class="p">);</span>

	<span class="cm">/* do the calibration */</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib7000p_set_wbd_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">4095</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="p">(</span><span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">105</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000p_set_wbd_ref</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib7000p_get_agc_values</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">agc_global</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">agc1</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">agc2</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">wbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agc_global</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">agc_global</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">394</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agc1</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">agc1</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">392</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agc2</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">agc2</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">393</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wbd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">wbd</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">397</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000p_get_agc_values</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000p_reset_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dibx000_bandwidth_config</span> <span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bw</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">clk_cfg0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1856</span><span class="p">,</span> <span class="p">(</span><span class="o">!</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_reset</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_range</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_ratio</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_prediv</span><span class="p">));</span>

		<span class="k">while</span> <span class="p">(((</span><span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1856</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="p">;</span>

		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1857</span><span class="p">,</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1857</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">!</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_bypass</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* force PLL bypass */</span>
		<span class="n">clk_cfg0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_ratio</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">modulo</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">ADClkSrc</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">IO_CLK_en_core</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">bypclk_div</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">enable_refdiv</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="n">clk_cfg0</span><span class="p">);</span>

		<span class="cm">/* P_pll_cfg */</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">903</span><span class="p">,</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_prediv</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_range</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_reset</span><span class="p">);</span>
		<span class="n">clk_cfg0</span> <span class="o">=</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_bypass</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">clk_cfg0</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">);</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="n">clk_cfg0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">ifreq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="n">bw</span><span class="o">-&gt;</span><span class="n">sad_cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dib7000p_get_internal_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">internal</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">internal</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
	<span class="n">internal</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">internal</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib7000p_update_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dibx000_bandwidth_config</span> <span class="o">*</span><span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_1857</span><span class="p">,</span> <span class="n">reg_1856</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1856</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">loopdiv</span><span class="p">,</span> <span class="n">prediv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">internal</span><span class="p">,</span> <span class="n">xtal</span><span class="p">;</span>

	<span class="cm">/* get back old values */</span>
	<span class="n">prediv</span> <span class="o">=</span> <span class="n">reg_1856</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">loopdiv</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg_1856</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bw</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_prediv</span> <span class="o">!=</span> <span class="n">prediv</span> <span class="o">||</span> <span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_ratio</span> <span class="o">!=</span> <span class="n">loopdiv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Updating pll (prediv: old =  %d new = %d ; loopdiv : old = %d new = %d)&quot;</span><span class="p">,</span> <span class="n">prediv</span><span class="p">,</span> <span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_prediv</span><span class="p">,</span> <span class="n">loopdiv</span><span class="p">,</span> <span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_ratio</span><span class="p">);</span>
		<span class="n">reg_1856</span> <span class="o">&amp;=</span> <span class="mh">0xf000</span><span class="p">;</span>
		<span class="n">reg_1857</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1857</span><span class="p">);</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1857</span><span class="p">,</span> <span class="n">reg_1857</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">));</span>

		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1856</span><span class="p">,</span> <span class="n">reg_1856</span> <span class="o">|</span> <span class="p">((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_ratio</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_prediv</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>

		<span class="cm">/* write new system clk into P_sec_len */</span>
		<span class="n">internal</span> <span class="o">=</span> <span class="n">dib7000p_get_internal_freq</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">xtal</span> <span class="o">=</span> <span class="p">(</span><span class="n">internal</span> <span class="o">/</span> <span class="n">loopdiv</span><span class="p">)</span> <span class="o">*</span> <span class="n">prediv</span><span class="p">;</span>
		<span class="n">internal</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="n">xtal</span> <span class="o">/</span> <span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_prediv</span><span class="p">)</span> <span class="o">*</span> <span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_ratio</span><span class="p">;</span>	<span class="cm">/* new internal */</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">internal</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">internal</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>

		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1857</span><span class="p">,</span> <span class="n">reg_1857</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">));</span>

		<span class="k">while</span> <span class="p">(((</span><span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1856</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Waiting for PLL to lock&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000p_update_pll</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_reset_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset the GPIOs */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;gpio dir: %x: val: %x, pwm_pos: %x&quot;</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_pwm_pos</span><span class="p">);</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1029</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1030</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="cm">/* TODO 1031 is P_gpio_od */</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1032</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_pwm_pos</span><span class="p">);</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1037</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pwm_freq_div</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_cfg_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">u8</span> <span class="n">num</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1029</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">);</span>	<span class="cm">/* reset the direction bit */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">;</span>	<span class="cm">/* set the new direction */</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1029</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">);</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1030</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">);</span>	<span class="cm">/* reset the direction bit */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">;</span>	<span class="cm">/* set the new value */</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1030</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib7000p_set_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">,</span> <span class="n">u8</span> <span class="n">num</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dib7000p_cfg_gpio</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000p_set_gpio</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">dib7000p_defaults</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>auto search configuration</p></td><td class="code"><div class="highlight"><pre>	<span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
	<span class="mh">0x0004</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">),</span>
	<span class="mh">0x0814</span><span class="p">,</span>			<span class="cm">/* Equal Lock */</span>

	<span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
	<span class="mh">0x001b</span><span class="p">,</span>
	<span class="mh">0x7740</span><span class="p">,</span>
	<span class="mh">0x005b</span><span class="p">,</span>
	<span class="mh">0x8d80</span><span class="p">,</span>
	<span class="mh">0x01c9</span><span class="p">,</span>
	<span class="mh">0xc380</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0080</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0090</span><span class="p">,</span>
	<span class="mh">0x0001</span><span class="p">,</span>
	<span class="mh">0xd4c0</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span>
	<span class="mh">0x6680</span><span class="p">,</span>

	<span class="cm">/* set ADC level to -16 */</span>
	<span class="mi">11</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">825</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">837</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">811</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">766</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">737</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">693</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">648</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">619</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">575</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">531</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">501</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span>
	<span class="mh">0x0410</span><span class="p">,</span>

	<span class="cm">/* disable power smoothing */</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span>
	<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span>
	<span class="mh">0x0ccd</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">183</span><span class="p">,</span>
	<span class="mh">0x200f</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span>
		<span class="mh">0x169</span><span class="p">,</span>

	<span class="mi">5</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span>
	<span class="mh">0x023d</span><span class="p">,</span>
	<span class="mh">0x00a4</span><span class="p">,</span>
	<span class="mh">0x00a4</span><span class="p">,</span>
	<span class="mh">0x7ff0</span><span class="p">,</span>
	<span class="mh">0x3ccc</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span>
	<span class="mh">0x800</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span>
	<span class="mh">0x0010</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span>
	<span class="mh">0x0062</span><span class="p">,</span>

	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_demod_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dib7000p_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB7000P_POWER_ALL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span>
		<span class="n">dibx000_reset_i2c_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">);</span>

	<span class="n">dib7000p_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_VBG_ENABLE</span><span class="p">);</span>

	<span class="cm">/* restart all parts */</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">771</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">772</span><span class="p">,</span> <span class="mh">0x001f</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mh">0x001f</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)));</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">771</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">772</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">SOC7090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="mi">898</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="mi">898</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* default */</span>
	<span class="n">dib7000p_reset_pll</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib7000p_reset_gpio</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;GPIO reset was not successful.&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">899</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* impulse noise */</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mi">3</span><span class="p">);</span> <span class="cm">/* P_iqc_thsat_ipc = 1 ; P_iqc_win2 = 3 */</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mh">0x2d4</span><span class="p">);</span> <span class="cm">/*-300 fag P_iqc_dect_min = -280 */</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span> <span class="cm">/* 300 fag P_iqc_dect_min = +280 */</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mi">30</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib7000p_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUTMODE_HIGH_Z</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;OUTPUT_MODE could not be reset.&quot;</span><span class="p">);</span>

	<span class="n">dib7000p_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_SLOW_ADC_ON</span><span class="p">);</span>
	<span class="n">dib7000p_sad_calib</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">dib7000p_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_SLOW_ADC_OFF</span><span class="p">);</span>

	<span class="cm">/* unforce divstr regardless whether i2c enumeration was done or not */</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1285</span><span class="p">,</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1285</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">dib7000p_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mh">0x0755</span><span class="p">);</span><span class="cm">/* P_iqc_impnc_on =1 &amp; P_iqc_corr_inh = 1 for impulsive noise */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">tuner_is_baseband</span><span class="p">)</span>
			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mh">0x0755</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mh">0x1f55</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dib7000p_write_tab</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dib7000p_defaults</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">SOC7090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">901</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">);</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">902</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">905</span><span class="p">,</span> <span class="mh">0x2c8e</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dib7000p_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB7000P_POWER_INTERFACE_ONLY</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000p_pll_clk_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">903</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">903</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">));</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">900</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000p_restart_agc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>P<em>restart</em>iqc &amp; P<em>restart</em>agc</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">));</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_update_lna</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dyn_gain</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">update_lna</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dyn_gain</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">394</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">update_lna</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">,</span> <span class="n">dyn_gain</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dib7000p_restart_agc</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_set_agc_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dibx000_agc_config</span> <span class="o">*</span><span class="n">agc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">band</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_config_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">band_caps</span> <span class="o">&amp;</span> <span class="n">band</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">agc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;no valid AGC configuration found for band 0x%02x&quot;</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span> <span class="o">=</span> <span class="n">agc</span><span class="p">;</span>

	<span class="cm">/* AGC */</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">inv_gain</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">time_stabiliz</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">alpha_level</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">thlock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Demod AGC loop configuration</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">alpha_mant</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">alpha_exp</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">beta_mant</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">beta_exp</span><span class="p">);</span>

	<span class="cm">/* AGC continued */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;WBD: ref: %d, sel: %d, active: %d, alpha: %d&quot;</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span> <span class="o">:</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_ref</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_sel</span><span class="p">,</span> <span class="o">!</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">perform_agc_softsplit</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_sel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_inv</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_inv</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_ref</span><span class="p">);</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_sel</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_alpha</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">perform_agc_softsplit</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_max</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_min</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_max</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_min</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_pt1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_pt2</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_pt3</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_slope1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_slope2</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_pt1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_pt2</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_slope1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_slope2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000p_set_dds</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">s32</span> <span class="n">offset_khz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">internal</span> <span class="o">=</span> <span class="n">dib7000p_get_internal_freq</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">s32</span> <span class="n">unit_khz_dds_val</span> <span class="o">=</span> <span class="mi">67108864</span> <span class="o">/</span> <span class="p">(</span><span class="n">internal</span><span class="p">);</span>	<span class="cm">/* 2**26 / Fsampling is the unit 1KHz offset */</span>
	<span class="n">u32</span> <span class="n">abs_offset_khz</span> <span class="o">=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">offset_khz</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">dds</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">&amp;</span> <span class="mh">0x1ffffff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">invert</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting a frequency offset of %dkHz internal freq = %d invert = %d&quot;</span><span class="p">,</span> <span class="n">offset_khz</span><span class="p">,</span> <span class="n">internal</span><span class="p">,</span> <span class="n">invert</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset_khz</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">unit_khz_dds_val</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* IF tuner */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">dds</span> <span class="o">-=</span> <span class="p">(</span><span class="n">abs_offset_khz</span> <span class="o">*</span> <span class="n">unit_khz_dds_val</span><span class="p">);</span>	<span class="cm">/* /100 because of /100 on the unit_khz_dds_val line calc for better accuracy */</span>
	<span class="k">else</span>
		<span class="n">dds</span> <span class="o">+=</span> <span class="p">(</span><span class="n">abs_offset_khz</span> <span class="o">*</span> <span class="n">unit_khz_dds_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">abs_offset_khz</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">internal</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* Max dds offset is the half of the demod freq */</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(((</span><span class="n">dds</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">invert</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)));</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">dds</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_agc_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">demod</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">agc_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">agc_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">agc_split</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">upd_demod_gain_period</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">agc_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">dib7000p_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB7000P_POWER_ALL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x79b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">;</span>
			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x79a</span><span class="p">,</span> <span class="n">upd_demod_gain_period</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>	<span class="cm">/* lsb */</span>
			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x79b</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">upd_demod_gain_period</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>

			<span class="cm">/* enable adc i &amp; q */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x780</span><span class="p">);</span>
			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x780</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dib7000p_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_ADC_ON</span><span class="p">);</span>
			<span class="n">dib7000p_pll_clk_cfg</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dib7000p_set_agc_config</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">BAND_OF_FREQUENCY</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">dib7000p_set_dds</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_control</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">32768</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">perform_agc_softsplit</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we are using the wbd - so slow AGC startup */</span>
			<span class="cm">/* force 0 split on WBD and restart AGC */</span>
			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">wbd_sel</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">wbd_alpha</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
			<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* default AGC startup */</span>
			<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="cm">/* wait AGC rough lock time */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dib7000p_restart_agc</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/* fast split search path after 5sec */</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>	<span class="cm">/* freeze AGC loop */</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">wbd_sel</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>	<span class="cm">/* fast split search 0.25kHz */</span>
		<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>:		<span class="cm">/* split search ended */</span>
		<span class="n">agc_split</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">396</span><span class="p">);</span>	<span class="cm">/* store the split value for the next time */</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">394</span><span class="p">));</span>	<span class="cm">/* set AGC gain start value */</span>

		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">);</span>	<span class="cm">/* std AGC loop */</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">wbd_sel</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">wbd_alpha</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc_split</span><span class="p">);</span>	<span class="cm">/* standard split search */</span>

		<span class="n">dib7000p_restart_agc</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SPLIT %p: %hd&quot;</span><span class="p">,</span> <span class="n">demod</span><span class="p">,</span> <span class="n">agc_split</span><span class="p">);</span>

		<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>:		<span class="cm">/* LNA startup */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dib7000p_update_lna</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_control</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000p_update_timf</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">timf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">427</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">428</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span> <span class="o">=</span> <span class="n">timf</span> <span class="o">*</span> <span class="mi">160</span> <span class="o">/</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_bandwidth</span> <span class="o">/</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">timf</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">timf</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;updated timf_frequency: %d (default: %d)&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">timf</span><span class="p">);</span>

<span class="p">}</span>

<span class="n">u32</span> <span class="nf">dib7000p_ctrl_timf</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">op</span><span class="p">,</span> <span class="n">u32</span> <span class="n">timf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEMOD_TIMF_SET</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span> <span class="o">=</span> <span class="n">timf</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEMOD_TIMF_UPDATE</span>:
		<span class="n">dib7000p_update_timf</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEMOD_TIMF_GET</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib7000p_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_bandwidth</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000p_ctrl_timf</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000p_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u8</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">est</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">dib7000p_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">BANDWIDTH_TO_KHZ</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">));</span>

	<span class="cm">/* nfft, guard, qam, alpha */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">guard_interval</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_32</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_16</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_4</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_8</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QPSK</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_16</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">QAM_64</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">HIERARCHY_1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HIERARCHY_2</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HIERARCHY_4</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">HIERARCHY_1</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">seq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* do not force tps, search list 0 */</span>

	<span class="cm">/* P_dintl_native, P_dintlv_inv, P_hrch, P_code_rate, P_select_hp */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">:</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FEC_2_3</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_3_4</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_5_6</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_7_8</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">FEC_1_2</span>:
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* offset loop parameters */</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mh">0x6680</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mh">0x1273</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>

	<span class="cm">/* P_dvsy_sync_wait */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
	<span class="nl">default:</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">guard_interval</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_16</span>:
		<span class="n">value</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_8</span>:
		<span class="n">value</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_4</span>:
		<span class="n">value</span> <span class="o">*=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_32</span>:
		<span class="n">value</span> <span class="o">*=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">diversity_delay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">div_sync_wait</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">48</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">div_sync_wait</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">diversity_delay</span><span class="p">;</span>

	<span class="cm">/* deactive the possibility of diversity reception if extended interleaver */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">div_force_off</span> <span class="o">=</span> <span class="o">!</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">!=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span>
	<span class="n">dib7000p_set_diversity_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">div_state</span><span class="p">);</span>

	<span class="cm">/* channel estimation fine configuration */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QAM_64</span>:
		<span class="n">est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0148</span><span class="p">;</span>	<span class="cm">/* P_adp_regul_cnt 0.04 */</span>
		<span class="n">est</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfff0</span><span class="p">;</span>	<span class="cm">/* P_adp_noise_cnt -0.002 */</span>
		<span class="n">est</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00a4</span><span class="p">;</span>	<span class="cm">/* P_adp_regul_ext 0.02 */</span>
		<span class="n">est</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfff8</span><span class="p">;</span>	<span class="cm">/* P_adp_noise_ext -0.001 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_16</span>:
		<span class="n">est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x023d</span><span class="p">;</span>	<span class="cm">/* P_adp_regul_cnt 0.07 */</span>
		<span class="n">est</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffdf</span><span class="p">;</span>	<span class="cm">/* P_adp_noise_cnt -0.004 */</span>
		<span class="n">est</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00a4</span><span class="p">;</span>	<span class="cm">/* P_adp_regul_ext 0.02 */</span>
		<span class="n">est</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfff0</span><span class="p">;</span>	<span class="cm">/* P_adp_noise_ext -0.002 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x099a</span><span class="p">;</span>	<span class="cm">/* P_adp_regul_cnt 0.3 */</span>
		<span class="n">est</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffae</span><span class="p">;</span>	<span class="cm">/* P_adp_noise_cnt -0.01 */</span>
		<span class="n">est</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0333</span><span class="p">;</span>	<span class="cm">/* P_adp_regul_ext 0.1 */</span>
		<span class="n">est</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfff8</span><span class="p">;</span>	<span class="cm">/* P_adp_noise_ext -0.002 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">value</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">187</span> <span class="o">+</span> <span class="n">value</span><span class="p">,</span> <span class="n">est</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_autosearch_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">demod</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="n">schan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">factor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">internal</span> <span class="o">=</span> <span class="n">dib7000p_get_internal_freq</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="n">schan</span> <span class="o">=</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="n">schan</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_64</span><span class="p">;</span>
	<span class="n">schan</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_32</span><span class="p">;</span>
	<span class="n">schan</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span>
	<span class="n">schan</span><span class="p">.</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
	<span class="n">schan</span><span class="p">.</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span>
	<span class="n">schan</span><span class="p">.</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dib7000p_set_channel</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schan</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">factor</span> <span class="o">=</span> <span class="n">BANDWIDTH_TO_KHZ</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">factor</span> <span class="o">&gt;=</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span>
			<span class="n">factor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">factor</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">internal</span> <span class="o">*</span> <span class="n">factor</span><span class="p">;</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">internal</span> <span class="o">*</span> <span class="n">factor</span><span class="p">;</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mi">500</span> <span class="o">*</span> <span class="n">internal</span> <span class="o">*</span> <span class="n">factor</span><span class="p">;</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">));</span>
	<span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1284</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_autosearch_is_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">irq_pending</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1284</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_pending</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_pending</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000p_spur_protect</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rf_khz</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">s16</span> <span class="n">notch</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">16143</span><span class="p">,</span> <span class="mi">14402</span><span class="p">,</span> <span class="mi">12238</span><span class="p">,</span> <span class="mi">9713</span><span class="p">,</span> <span class="mi">6902</span><span class="p">,</span> <span class="mi">3888</span><span class="p">,</span> <span class="mi">759</span><span class="p">,</span> <span class="o">-</span><span class="mi">2392</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">sine</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span>
		<span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span>
		<span class="mi">53</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span>
		<span class="mi">82</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span>
		<span class="mi">107</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span>
		<span class="mi">128</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">141</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span>
		<span class="mi">147</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">159</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span>
		<span class="mi">166</span><span class="p">,</span> <span class="mi">167</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">171</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span>
		<span class="mi">183</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">189</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span>
		<span class="mi">199</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">209</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span>
		<span class="mi">213</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">218</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">221</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="mi">223</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span>
		<span class="mi">225</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span>
		<span class="mi">235</span><span class="p">,</span> <span class="mi">236</span><span class="p">,</span> <span class="mi">237</span><span class="p">,</span> <span class="mi">237</span><span class="p">,</span> <span class="mi">238</span><span class="p">,</span> <span class="mi">238</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span>
		<span class="mi">244</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span>
		<span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="mi">254</span><span class="p">,</span>
		<span class="mi">254</span><span class="p">,</span> <span class="mi">254</span><span class="p">,</span> <span class="mi">254</span><span class="p">,</span> <span class="mi">254</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span>
		<span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span>
	<span class="p">};</span>

	<span class="n">u32</span> <span class="n">xtal</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">xtal_hz</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_rel</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">rf_khz</span><span class="p">,</span> <span class="n">xtal</span><span class="p">)</span> <span class="o">*</span> <span class="n">xtal</span> <span class="o">-</span> <span class="n">rf_khz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">coef_re</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">coef_im</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">bw_khz</span> <span class="o">=</span> <span class="n">bw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pha</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;relative position of the Spur: %dk (RF: %dk, XTAL: %dk)&quot;</span><span class="p">,</span> <span class="n">f_rel</span><span class="p">,</span> <span class="n">rf_khz</span><span class="p">,</span> <span class="n">xtal</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f_rel</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">bw_khz</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">f_rel</span> <span class="o">&gt;</span> <span class="n">bw_khz</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bw_khz</span> <span class="o">/=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mh">0x0610</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pha</span> <span class="o">=</span> <span class="p">((</span><span class="n">f_rel</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">112</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">/</span> <span class="n">bw_khz</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pha</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
			<span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pha</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sine</span><span class="p">[</span><span class="mi">256</span> <span class="o">-</span> <span class="p">(</span><span class="n">pha</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)];</span>
			<span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sine</span><span class="p">[</span><span class="n">pha</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pha</span> <span class="o">==</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pha</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sine</span><span class="p">[</span><span class="n">pha</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>
			<span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sine</span><span class="p">[</span><span class="mi">256</span> <span class="o">-</span> <span class="p">(</span><span class="n">pha</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pha</span> <span class="o">==</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">256</span><span class="p">;</span>
			<span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pha</span> <span class="o">&lt;</span> <span class="mi">768</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sine</span><span class="p">[</span><span class="mi">256</span> <span class="o">-</span> <span class="p">(</span><span class="n">pha</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)];</span>
			<span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sine</span><span class="p">[</span><span class="n">pha</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pha</span> <span class="o">==</span> <span class="mi">768</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">256</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sine</span><span class="p">[</span><span class="n">pha</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>
			<span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sine</span><span class="p">[</span><span class="mi">256</span> <span class="o">-</span> <span class="p">(</span><span class="n">pha</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)];</span>
		<span class="p">}</span>

		<span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*=</span> <span class="n">notch</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">))</span>
			<span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>

		<span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*=</span> <span class="n">notch</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">))</span>
			<span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;PALF COEF: %d re: %d im: %d&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>

		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">));</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="n">coef_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">);</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">coef_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_tune</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">demod</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dib7000p_set_channel</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>restart demod</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">45</span><span class="p">);</span>

	<span class="cm">/* P_ctrl_inh_cor=0, P_ctrl_alpha_cor=4, P_ctrl_inh_isi=0, P_ctrl_alpha_isi=3, P_ctrl_inh_cor4=1, P_ctrl_alpha_cor4=3 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">sfn_workaround_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SFN workaround is active&quot;</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>never achieved a lock with that bandwidth so far - wait for osc-freq to update</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="cm">/* offset loop parameters */</span>

	<span class="cm">/* P_timf_alpha, P_corm_alpha=6, P_corm_thres=0x80 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>	<span class="cm">/* timf_a(6xxx) */</span>

	<span class="cm">/* P_ctrl_freeze_pha_shift=0, P_ctrl_pha_off_max */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* P_ctrl_sfreq_inh=0, P_ctrl_sfreq_step */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">509</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* restart the fec */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">771</span><span class="p">);</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">771</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">771</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">509</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>we achieved a lock - it's time to update the osc freq</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib7000p_update_timf</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="cm">/* P_timf_alpha += 2 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">26</span><span class="p">);</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">|</span> <span class="p">((((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">spur_protect</span><span class="p">)</span>
		<span class="n">dib7000p_spur_protect</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">BANDWIDTH_TO_KHZ</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">));</span>

	<span class="n">dib7000p_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">BANDWIDTH_TO_KHZ</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">dib7000p_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB7000P_POWER_ALL</span><span class="p">);</span>
	<span class="n">dib7000p_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_SLOW_ADC_ON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span>
		<span class="n">dib7000p_sad_calib</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dib7000p_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB7000P_POWER_INTERFACE_ONLY</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dib7000p_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUTMODE_HIGH_Z</span><span class="p">)</span> <span class="o">|</span> <span class="n">dib7000p_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB7000P_POWER_INTERFACE_ONLY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_identify</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;checking demod on I2C address: %d (%x)&quot;</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">768</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x01b3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;wrong Vendor ID (read=0x%x)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">769</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;wrong Device ID (%x)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">fep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tps</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">463</span><span class="p">);</span>

	<span class="n">fep</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">INVERSION_AUTO</span><span class="p">;</span>

	<span class="n">fep</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="n">BANDWIDTH_TO_HZ</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_bandwidth</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">tps</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_2K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* case 2: fep-&gt;transmission_mode = TRANSMISSION_MODE_4K; break; */</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tps</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">tps</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QPSK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="nl">default:</span>
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* as long as the frontend_param structure is fixed for hierarchical transmission I refuse to use it */</span>
	<span class="cm">/* (tps &gt;&gt; 13) &amp; 0x1 == hrch is used, (tps &gt;&gt; 10) &amp; 0x7 == alpha */</span>

	<span class="n">fep</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_NONE</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">tps</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_1_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_5_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
	<span class="nl">default:</span>
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_7_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">tps</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_1_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_5_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
	<span class="nl">default:</span>
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_7_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* native interleaver: (dib7000p_read_word(state, 464) &gt;&gt;  5) &amp; 0x1 */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">fep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">time</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span>
		<span class="n">dib7090_set_diversity_in</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib7000p_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUTMODE_HIGH_Z</span><span class="p">);</span>

	<span class="cm">/* maybe the parameter has been changed */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">sfn_workaround_active</span> <span class="o">=</span> <span class="n">buggy_sfn_workaround</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="cm">/* start up the AGC */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">agc_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">time</span> <span class="o">=</span> <span class="n">dib7000p_agc_startup</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fep</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">==</span> <span class="n">TRANSMISSION_MODE_AUTO</span> <span class="o">||</span>
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">==</span> <span class="n">GUARD_INTERVAL_AUTO</span> <span class="o">||</span> <span class="n">fep</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_AUTO</span> <span class="o">||</span> <span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">==</span> <span class="n">FEC_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span> <span class="n">found</span><span class="p">;</span>

		<span class="n">dib7000p_autosearch_start</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">found</span> <span class="o">=</span> <span class="n">dib7000p_autosearch_is_irq</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">--</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;autosearch returns: %d&quot;</span><span class="p">,</span> <span class="n">found</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">found</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dib7000p_get_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dib7000p_tune</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="cm">/* make this a config parameter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib7090_set_output_mode</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">enMpegOutput</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dib7090_setDibTxMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MPEG_ON_DIBTX</span><span class="p">);</span>
			<span class="n">dib7090_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBTX_ON_HOSTBUS</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dib7000p_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">509</span><span class="p">);</span>

	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_SIGNAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_CARRIER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x0010</span><span class="p">)</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_SYNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x0038</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x38</span><span class="p">)</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">501</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_read_unc_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">unc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="o">*</span><span class="n">unc</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">506</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">394</span><span class="p">);</span>
	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">65535</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">signal_mant</span><span class="p">,</span> <span class="n">signal_exp</span><span class="p">,</span> <span class="n">noise_mant</span><span class="p">,</span> <span class="n">noise_exp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">479</span><span class="p">);</span>
	<span class="n">noise_mant</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">noise_exp</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">480</span><span class="p">);</span>
	<span class="n">noise_exp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">noise_exp</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">noise_exp</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="n">signal_mant</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">signal_exp</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">signal_exp</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">signal_exp</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_mant</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">intlog10</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">signal_exp</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">intlog10</span><span class="p">(</span><span class="n">signal_mant</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">intlog10</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">signal_exp</span> <span class="o">-</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">noise_mant</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">-=</span> <span class="n">intlog10</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">noise_exp</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">intlog10</span><span class="p">(</span><span class="n">noise_mant</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">result</span> <span class="o">-=</span> <span class="n">intlog10</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">noise_exp</span> <span class="o">-</span> <span class="mi">100</span><span class="p">;</span>

	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">result</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000p_fe_get_tune_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span> <span class="o">*</span><span class="n">tune</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tune</span><span class="o">-&gt;</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000p_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">dibx000_exit_i2c_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">);</span>
	<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">dib7090_tuner_adap</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib7000pc_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span> <span class="o">*</span><span class="n">rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">18</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">18</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">rx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rx_memory_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">tx</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">rx</span><span class="p">;</span>

	<span class="n">tx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">tx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">rx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xb3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;-D-  DiB7000PC detected&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">rx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xb3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;-D-  DiB7000PC detected&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;-D-  DiB7000PC not detected&quot;</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>
<span class="nl">rx_memory_error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000pc_detection</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="nf">dib7000p_get_i2c_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dibx000_i2c_interface</span> <span class="n">intf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gating</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dibx000_get_i2c_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">gating</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000p_get_i2c_master</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib7000p_pid_filter_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">235</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffef</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">onoff</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;PID filter enabled %d&quot;</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000p_pid_filter_ctrl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib7000p_pid_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;PID filter: index %x, PID %d, OnOff %d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">241</span> <span class="o">+</span> <span class="n">id</span><span class="p">,</span> <span class="n">onoff</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000p_pid_filter</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib7000p_i2c_enumeration</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">no_of_demods</span><span class="p">,</span> <span class="n">u8</span> <span class="n">default_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dib7000p_config</span> <span class="n">cfg</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">dpst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">new_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dpst</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dpst</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dpst</span><span class="o">-&gt;</span><span class="n">i2c_adap</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpst</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">no_of_demods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpst</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>

		<span class="cm">/* designated i2c address */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">default_i2c_addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">new_addr</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">default_i2c_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">new_addr</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x40</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dpst</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">new_addr</span><span class="p">;</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">dpst</span><span class="p">,</span> <span class="mi">1287</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>	<span class="cm">/* sram lead in, rdy */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dib7000p_identify</span><span class="p">(</span><span class="n">dpst</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dpst</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">default_addr</span><span class="p">;</span>
			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">dpst</span><span class="p">,</span> <span class="mi">1287</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>	<span class="cm">/* sram lead in, rdy */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dib7000p_identify</span><span class="p">(</span><span class="n">dpst</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;DiB7000P #%d: not identified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">dpst</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* start diversity to pull_down div_str - just for i2c-enumeration */</span>
		<span class="n">dib7000p_set_output_mode</span><span class="p">(</span><span class="n">dpst</span><span class="p">,</span> <span class="n">OUTMODE_DIVERSITY</span><span class="p">);</span>

		<span class="cm">/* set new i2c address and force divstart */</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">dpst</span><span class="p">,</span> <span class="mi">1285</span><span class="p">,</span> <span class="p">(</span><span class="n">new_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;IC %d initialized (to i2c_address 0x%x)&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">new_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">no_of_demods</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpst</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">default_i2c_addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dpst</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">default_i2c_addr</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dpst</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x40</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>unforce divstr</p></td><td class="code"><div class="highlight"><pre>		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">dpst</span><span class="p">,</span> <span class="mi">1285</span><span class="p">,</span> <span class="n">dpst</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

		<span class="cm">/* deactivate div - it was just for i2c-enumeration */</span>
		<span class="n">dib7000p_set_output_mode</span><span class="p">(</span><span class="n">dpst</span><span class="p">,</span> <span class="n">OUTMODE_HIGH_Z</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dpst</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000p_i2c_enumeration</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s32</span> <span class="n">lut_1000ln_mant</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">6908</span><span class="p">,</span> <span class="mi">6956</span><span class="p">,</span> <span class="mi">7003</span><span class="p">,</span> <span class="mi">7047</span><span class="p">,</span> <span class="mi">7090</span><span class="p">,</span> <span class="mi">7131</span><span class="p">,</span> <span class="mi">7170</span><span class="p">,</span> <span class="mi">7208</span><span class="p">,</span> <span class="mi">7244</span><span class="p">,</span> <span class="mi">7279</span><span class="p">,</span> <span class="mi">7313</span><span class="p">,</span> <span class="mi">7346</span><span class="p">,</span> <span class="mi">7377</span><span class="p">,</span> <span class="mi">7408</span><span class="p">,</span> <span class="mi">7438</span><span class="p">,</span> <span class="mi">7467</span><span class="p">,</span> <span class="mi">7495</span><span class="p">,</span> <span class="mi">7523</span><span class="p">,</span> <span class="mi">7549</span><span class="p">,</span> <span class="mi">7575</span><span class="p">,</span> <span class="mi">7600</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">dib7000p_get_adc_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">exp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mant</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">pow_i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x184</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x185</span><span class="p">);</span>
	<span class="n">pow_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;raw pow_i = %d&quot;</span><span class="p">,</span> <span class="n">pow_i</span><span class="p">);</span>

	<span class="n">tmp_val</span> <span class="o">=</span> <span class="n">pow_i</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tmp_val</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">exp</span><span class="o">++</span><span class="p">;</span>

	<span class="n">mant</span> <span class="o">=</span> <span class="p">(</span><span class="n">pow_i</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">exp</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot; mant = %d exp = %d&quot;</span><span class="p">,</span> <span class="n">mant</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">exp</span><span class="p">);</span>

	<span class="n">ix</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">mant</span> <span class="o">-</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>	<span class="cm">/* index of the LUT */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot; ix = %d&quot;</span><span class="p">,</span> <span class="n">ix</span><span class="p">);</span>

	<span class="n">pow_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">lut_1000ln_mant</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">+</span> <span class="mi">693</span> <span class="o">*</span> <span class="p">(</span><span class="n">exp</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-</span> <span class="mi">6908</span><span class="p">);</span>
	<span class="n">pow_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">pow_i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot; pow_i = %d&quot;</span><span class="p">,</span> <span class="n">pow_i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pow_i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">map_addr_to_serpar_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">))</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">17</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">19</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">21</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">28</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w7090p_tuner_write_serpar</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">n_overflow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">serpar_num</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n_overflow</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n_overflow</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1984</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Tuner ITF: write busy (overflow)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1985</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">serpar_num</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1986</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w7090p_tuner_read_serpar</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">n_overflow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">serpar_num</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">read_word</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n_overflow</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n_overflow</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1984</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;TunerITF: read busy (overflow)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1985</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">serpar_num</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n_empty</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n_empty</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1984</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;TunerITF: read busy (empty)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_word</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1987</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_word</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_word</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w7090p_tuner_rw_serpar</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map_addr_to_serpar_number</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* else = Tuner regs to ignore : DIG_CFG, CTRL_RF_LT, PLL_CFG, PWM1_REG, ADCCLK, DIG_CFG_3; SLEEP_EN... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* write */</span>
			<span class="k">return</span> <span class="n">w7090p_tuner_write_serpar</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* read */</span>
			<span class="k">return</span> <span class="n">w7090p_tuner_read_serpar</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7090p_rw_on_apb</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">u16</span> <span class="n">apb_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">word</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* write */</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">apb_address</span><span class="p">,</span> <span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">])));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">word</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">apb_address</span><span class="p">);</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7090_tuner_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">);</span>

	<span class="n">u16</span> <span class="n">apb_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x12</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1920</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x14</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1921</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x24</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1922</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1a</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1923</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x22</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1924</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x33</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1926</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1927</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x35</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1928</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x36</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1929</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x37</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1930</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x38</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1931</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x39</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1932</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2a</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1935</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2b</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1936</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2c</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1937</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2d</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1938</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2e</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1939</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2f</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1940</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x30</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1941</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x31</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1942</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x32</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1943</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3e</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1944</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3f</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1945</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x40</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1948</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x25</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">914</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x26</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">915</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x27</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">917</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x28</span>:
		<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">916</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1d</span>:
		<span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">72</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="n">word</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">384</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1f</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* write */</span>
			<span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">word</span> <span class="o">&amp;=</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">72</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
			<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>	<span class="cm">/* Set the proper input */</span>
			<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apb_address</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* R/W acces via APB */</span>
		<span class="k">return</span> <span class="n">dib7090p_rw_on_apb</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">apb_address</span><span class="p">);</span>
	<span class="k">else</span>			<span class="cm">/* R/W access via SERPAR  */</span>
		<span class="k">return</span> <span class="n">w7090p_tuner_rw_serpar</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dib7000p_i2c_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I2C_FUNC_I2C</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">dib7090_tuner_xfer_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span> <span class="o">=</span> <span class="n">dib7090_tuner_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span> <span class="o">=</span> <span class="n">dib7000p_i2c_func</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="nf">dib7090_get_i2c_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">dib7090_tuner_adap</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7090_get_i2c_tuner</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7090_host_bus_drive</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* drive host bus 2, 3, 4 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1798</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">drive</span><span class="p">;</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1798</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* drive host bus 5,6 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1799</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1799</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* drive host bus 7, 8, 9 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1800</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">drive</span><span class="p">;</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* drive host bus 10, 11 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1801</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1801</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* drive host bus 12, 13, 14 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1802</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">drive</span><span class="p">;</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1802</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dib7090_calcSyncFreq</span><span class="p">(</span><span class="n">u32</span> <span class="n">P_Kin</span><span class="p">,</span> <span class="n">u32</span> <span class="n">P_Kout</span><span class="p">,</span> <span class="n">u32</span> <span class="n">insertExtSynchro</span><span class="p">,</span> <span class="n">u32</span> <span class="n">syncSize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">quantif</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nom</span> <span class="o">=</span> <span class="p">(</span><span class="n">insertExtSynchro</span> <span class="o">*</span> <span class="n">P_Kin</span> <span class="o">+</span> <span class="n">syncSize</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">denom</span> <span class="o">=</span> <span class="n">P_Kout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">syncFreq</span> <span class="o">=</span> <span class="p">((</span><span class="n">nom</span> <span class="o">&lt;&lt;</span> <span class="n">quantif</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">syncFreq</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">quantif</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">syncFreq</span> <span class="o">=</span> <span class="p">(</span><span class="n">syncFreq</span> <span class="o">&gt;&gt;</span> <span class="n">quantif</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">syncFreq</span> <span class="o">=</span> <span class="p">(</span><span class="n">syncFreq</span> <span class="o">&gt;&gt;</span> <span class="n">quantif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">syncFreq</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">syncFreq</span> <span class="o">=</span> <span class="n">syncFreq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">syncFreq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7090_cfg_DibTx</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">P_Kin</span><span class="p">,</span> <span class="n">u32</span> <span class="n">P_Kout</span><span class="p">,</span> <span class="n">u32</span> <span class="n">insertExtSynchro</span><span class="p">,</span> <span class="n">u32</span> <span class="n">synchroMode</span><span class="p">,</span> <span class="n">u32</span> <span class="n">syncWord</span><span class="p">,</span> <span class="n">u32</span> <span class="n">syncSize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Configure DibStream Tx&quot;</span><span class="p">);</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1615</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1603</span><span class="p">,</span> <span class="n">P_Kin</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1605</span><span class="p">,</span> <span class="n">P_Kout</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1606</span><span class="p">,</span> <span class="n">insertExtSynchro</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1608</span><span class="p">,</span> <span class="n">synchroMode</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1609</span><span class="p">,</span> <span class="p">(</span><span class="n">syncWord</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1610</span><span class="p">,</span> <span class="n">syncWord</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1612</span><span class="p">,</span> <span class="n">syncSize</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1615</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7090_cfg_DibRx</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">P_Kin</span><span class="p">,</span> <span class="n">u32</span> <span class="n">P_Kout</span><span class="p">,</span> <span class="n">u32</span> <span class="n">synchroMode</span><span class="p">,</span> <span class="n">u32</span> <span class="n">insertExtSynchro</span><span class="p">,</span> <span class="n">u32</span> <span class="n">syncWord</span><span class="p">,</span> <span class="n">u32</span> <span class="n">syncSize</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">dataOutRate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">syncFreq</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Configure DibStream Rx&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">P_Kin</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">P_Kout</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">syncFreq</span> <span class="o">=</span> <span class="n">dib7090_calcSyncFreq</span><span class="p">(</span><span class="n">P_Kin</span><span class="p">,</span> <span class="n">P_Kout</span><span class="p">,</span> <span class="n">insertExtSynchro</span><span class="p">,</span> <span class="n">syncSize</span><span class="p">);</span>
		<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1542</span><span class="p">,</span> <span class="n">syncFreq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1554</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1536</span><span class="p">,</span> <span class="n">P_Kin</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1537</span><span class="p">,</span> <span class="n">P_Kout</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1539</span><span class="p">,</span> <span class="n">synchroMode</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1540</span><span class="p">,</span> <span class="p">(</span><span class="n">syncWord</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1541</span><span class="p">,</span> <span class="n">syncWord</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1543</span><span class="p">,</span> <span class="n">syncSize</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1544</span><span class="p">,</span> <span class="n">dataOutRate</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1554</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7090_enMpegMux</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg_1287</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1287</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">reg_1287</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">reg_1287</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1287</span><span class="p">,</span> <span class="n">reg_1287</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7090_configMpegMux</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">pulseWidth</span><span class="p">,</span> <span class="n">u16</span> <span class="n">enSerialMode</span><span class="p">,</span> <span class="n">u16</span> <span class="n">enSerialClkDiv2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Enable Mpeg mux&quot;</span><span class="p">);</span>

	<span class="n">dib7090_enMpegMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* If the input mode is MPEG do not divide the serial clock */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">enSerialMode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">input_mode_mpeg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">enSerialClkDiv2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1287</span><span class="p">,</span> <span class="p">((</span><span class="n">pulseWidth</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">((</span><span class="n">enSerialMode</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">enSerialClkDiv2</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">));</span>

	<span class="n">dib7090_enMpegMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7090_setDibTxMux</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg_1288</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1288</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPEG_ON_DIBTX</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SET MPEG ON DIBSTREAM TX&quot;</span><span class="p">);</span>
			<span class="n">dib7090_cfg_DibTx</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">reg_1288</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIV_ON_DIBTX</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SET DIV_OUT ON DIBSTREAM TX&quot;</span><span class="p">);</span>
			<span class="n">dib7090_cfg_DibTx</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">reg_1288</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_ON_DIBTX</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SET ADC_OUT ON DIBSTREAM TX&quot;</span><span class="p">);</span>
			<span class="n">dib7090_cfg_DibTx</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">reg_1288</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1288</span><span class="p">,</span> <span class="n">reg_1288</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7090_setHostBusMux</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg_1288</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1288</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEMOUT_ON_HOSTBUS</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SET DEM OUT OLD INTERF ON HOST BUS&quot;</span><span class="p">);</span>
			<span class="n">dib7090_enMpegMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">reg_1288</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIBTX_ON_HOSTBUS</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SET DIBSTREAM TX ON HOST BUS&quot;</span><span class="p">);</span>
			<span class="n">dib7090_enMpegMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">reg_1288</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPEG_ON_HOSTBUS</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SET MPEG MUX ON HOST BUS&quot;</span><span class="p">);</span>
			<span class="n">reg_1288</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1288</span><span class="p">,</span> <span class="n">reg_1288</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib7090_set_diversity_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_1287</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* only use the internal way - not the diversity input */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s mode OFF : by default Enable Mpeg INPUT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">dib7090_cfg_DibRx</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* Do not divide the serial clock of MPEG MUX */</span>
			<span class="cm">/* in SERIAL MODE in case input mode MPEG is used */</span>
			<span class="n">reg_1287</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1287</span><span class="p">);</span>
			<span class="cm">/* enSerialClkDiv2 == 1 ? */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">reg_1287</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* force enSerialClkDiv2 = 0 */</span>
				<span class="n">reg_1287</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
				<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1287</span><span class="p">,</span> <span class="n">reg_1287</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">input_mode_mpeg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* both ways */</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* only the diversity input */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s ON : Enable diversity INPUT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">dib7090_cfg_DibRx</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">input_mode_mpeg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dib7000p_set_diversity_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7090_set_output_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">outreg</span><span class="p">,</span> <span class="n">smo_mode</span><span class="p">,</span> <span class="n">fifo_threshold</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">prefer_mpeg_mux_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dib7090_host_bus_drive</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">fifo_threshold</span> <span class="o">=</span> <span class="mi">1792</span><span class="p">;</span>
	<span class="n">smo_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">235</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0050</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outreg</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1286</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OUTMODE_HIGH_Z</span>:
		<span class="n">outreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_SERIAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">prefer_mpeg_mux_use</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting output mode TS_SERIAL using Mpeg Mux&quot;</span><span class="p">);</span>
			<span class="n">dib7090_configMpegMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">dib7090_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MPEG_ON_HOSTBUS</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="cm">/* Use Smooth block */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting output mode TS_SERIAL using Smooth bloc&quot;</span><span class="p">);</span>
			<span class="n">dib7090_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOUT_ON_HOSTBUS</span><span class="p">);</span>
			<span class="n">outreg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_GATED_CLK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">prefer_mpeg_mux_use</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting output mode TS_PARALLEL_GATED using Mpeg Mux&quot;</span><span class="p">);</span>
			<span class="n">dib7090_configMpegMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dib7090_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MPEG_ON_HOSTBUS</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Use Smooth block */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting output mode TS_PARALLEL_GATED using Smooth block&quot;</span><span class="p">);</span>
			<span class="n">dib7090_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOUT_ON_HOSTBUS</span><span class="p">);</span>
			<span class="n">outreg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_CONT_CLK</span>:	<span class="cm">/* Using Smooth block only */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting output mode TS_PARALLEL_CONT using Smooth block&quot;</span><span class="p">);</span>
		<span class="n">dib7090_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOUT_ON_HOSTBUS</span><span class="p">);</span>
		<span class="n">outreg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_FIFO</span>:	<span class="cm">/* Using Smooth block because not supported by new Mpeg Mux bloc */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting output mode TS_FIFO using Smooth block&quot;</span><span class="p">);</span>
		<span class="n">dib7090_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOUT_ON_HOSTBUS</span><span class="p">);</span>
		<span class="n">outreg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">5</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">);</span>
		<span class="n">smo_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fifo_threshold</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OUTMODE_DIVERSITY</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting output mode MODE_DIVERSITY&quot;</span><span class="p">);</span>
		<span class="n">dib7090_setDibTxMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIV_ON_DIBTX</span><span class="p">);</span>
		<span class="n">dib7090_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBTX_ON_HOSTBUS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OUTMODE_ANALOG_ADC</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting output mode MODE_ANALOG_ADC&quot;</span><span class="p">);</span>
		<span class="n">dib7090_setDibTxMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ADC_ON_DIBTX</span><span class="p">);</span>
		<span class="n">dib7090_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBTX_ON_HOSTBUS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">OUTMODE_HIGH_Z</span><span class="p">)</span>
		<span class="n">outreg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mpeg2_in_188_bytes</span><span class="p">)</span>
		<span class="n">smo_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="n">smo_mode</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">236</span><span class="p">,</span> <span class="n">fifo_threshold</span><span class="p">);</span>	<span class="cm">/* synchronous fread */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1286</span><span class="p">,</span> <span class="n">outreg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib7090_tuner_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">en_cur_state</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;sleep dib7090: %d&quot;</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>

	<span class="n">en_cur_state</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1922</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">en_cur_state</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_enable</span> <span class="o">=</span> <span class="n">en_cur_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span>
		<span class="n">en_cur_state</span> <span class="o">&amp;=</span> <span class="mh">0x00ff</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_enable</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">en_cur_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_enable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1922</span><span class="p">,</span> <span class="n">en_cur_state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7090_tuner_sleep</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib7090_get_adc_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dib7000p_get_adc_power</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7090_get_adc_power</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib7090_slave_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1794</span><span class="p">);</span>
	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1794</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1032</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7090_slave_reset</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">dib7000p_ops</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">dib7000p_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">u8</span> <span class="n">i2c_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dib7000p_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib7000p_state</span> <span class="o">*</span><span class="n">st</span><span class="p">;</span>
	<span class="n">st</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000p_config</span><span class="p">));</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_adap</span> <span class="o">=</span> <span class="n">i2c_adap</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">i2c_addr</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">;</span>

	<span class="cm">/* Ensure the output mode remains at the previous default if it&#39;s</span>
<span class="cm">	 * not specifically set by the caller.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span> <span class="o">!=</span> <span class="n">OUTMODE_MPEG2_SERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span> <span class="o">!=</span> <span class="n">OUTMODE_MPEG2_PAR_GATED_CLK</span><span class="p">))</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span> <span class="o">=</span> <span class="n">OUTMODE_MPEG2_FIFO</span><span class="p">;</span>

	<span class="n">demod</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">;</span>
	<span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dib7000p_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>

	<span class="n">dib7000p_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1287</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>	<span class="cm">/* sram lead in, rdy */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib7000p_identify</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">dib7000p_read_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">897</span><span class="p">);</span>

	<span class="cm">/* FIXME: make sure the dev.parent field is initialized, or else</span>
<span class="cm">	   request_firmware() will hit an OOPS (this should be moved somewhere</span>
<span class="cm">	   more common) */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">.</span><span class="n">gated_tuner_i2c_adap</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">i2c_adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">dibx000_init_i2c_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">,</span> <span class="n">DIB7000P</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">);</span>

	<span class="cm">/* init 7090 tuner adapter */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">dib7090_tuner_adap</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;DiB7090 tuner interface&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">dib7090_tuner_adap</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">dib7090_tuner_adap</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dib7090_tuner_xfer_algo</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">dib7090_tuner_adap</span><span class="p">.</span><span class="n">algo_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">dib7090_tuner_adap</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">i2c_set_adapdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">dib7090_tuner_adap</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
	<span class="n">i2c_add_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">dib7090_tuner_adap</span><span class="p">);</span>

	<span class="n">dib7000p_demod_reset</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC7090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib7090_set_output_mode</span><span class="p">(</span><span class="n">demod</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span><span class="p">);</span>
		<span class="n">dib7090_set_diversity_in</span><span class="p">(</span><span class="n">demod</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">demod</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000p_attach</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">dib7000p_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBT</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DiBcom 7000PC&quot;</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">44250000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">867250000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">=</span> <span class="mi">62500</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">FE_CAN_INVERSION_AUTO</span> <span class="o">|</span>
		 <span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span>
		 <span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
		 <span class="n">FE_CAN_QPSK</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_AUTO</span> <span class="o">|</span>
		 <span class="n">FE_CAN_TRANSMISSION_MODE_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_GUARD_INTERVAL_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_RECOVER</span> <span class="o">|</span> <span class="n">FE_CAN_HIERARCHY_AUTO</span><span class="p">,</span>
		 <span class="p">},</span>

	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">dib7000p_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">dib7000p_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">dib7000p_sleep</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">dib7000p_set_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">=</span> <span class="n">dib7000p_fe_get_tune_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend</span> <span class="o">=</span> <span class="n">dib7000p_get_frontend</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">dib7000p_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">dib7000p_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">dib7000p_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">dib7000p_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">dib7000p_read_unc_blocks</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Olivier Grenie &lt;ogrenie@dibcom.fr&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Patrick Boettcher &lt;pboettcher@dibcom.fr&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for the DiBcom 7000PC COFDM demodulator&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
