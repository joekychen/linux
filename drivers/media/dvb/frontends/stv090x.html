<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › stv090x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>stv090x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	STV0900/0903 Multistandard Broadcast Frontend driver</span>
<span class="cm">	Copyright (C) Manu Abraham &lt;abraham.manu@gmail.com&gt;</span>

<span class="cm">	Copyright (C) ST Microelectronics</span>

<span class="cm">	This program is free software; you can redistribute it and/or modify</span>
<span class="cm">	it under the terms of the GNU General Public License as published by</span>
<span class="cm">	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">	(at your option) any later version.</span>

<span class="cm">	This program is distributed in the hope that it will be useful,</span>
<span class="cm">	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">	GNU General Public License for more details.</span>

<span class="cm">	You should have received a copy of the GNU General Public License</span>
<span class="cm">	along with this program; if not, write to the Free Software</span>
<span class="cm">	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;linux/dvb/frontend.h&gt;</span>
<span class="cp">#include &quot;dvb_frontend.h&quot;</span>

<span class="cp">#include &quot;stv6110x.h&quot; </span><span class="cm">/* for demodulator internal modes */</span><span class="cp"></span>

<span class="cp">#include &quot;stv090x_reg.h&quot;</span>
<span class="cp">#include &quot;stv090x.h&quot;</span>
<span class="cp">#include &quot;stv090x_priv.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">verbose</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/* internal params node */</span>
<span class="k">struct</span> <span class="n">stv090x_dev</span> <span class="p">{</span>
	<span class="cm">/* pointer for internal params, one for each pair of demods */</span>
	<span class="k">struct</span> <span class="n">stv090x_internal</span>		<span class="o">*</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv090x_dev</span>		<span class="o">*</span><span class="n">next_dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* first internal params */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_dev</span> <span class="o">*</span><span class="n">stv090x_first_dev</span><span class="p">;</span>

<span class="cm">/* find chip by i2c adapter and i2c address */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_dev</span> <span class="o">*</span><span class="nf">find_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">i2c_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_dev</span> <span class="o">*</span><span class="n">temp_dev</span> <span class="o">=</span> <span class="n">stv090x_first_dev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 Search of the last stv0900 chip or</span>
<span class="cm">	 find it by i2c adapter and i2c address */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">temp_dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">temp_dev</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">i2c_adap</span> <span class="o">!=</span> <span class="n">i2c_adap</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">temp_dev</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">!=</span> <span class="n">i2c_addr</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">temp_dev</span> <span class="o">=</span> <span class="n">temp_dev</span><span class="o">-&gt;</span><span class="n">next_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">temp_dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* deallocating chip */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_internal</span> <span class="o">*</span><span class="n">internal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_dev</span> <span class="o">*</span><span class="n">prev_dev</span> <span class="o">=</span> <span class="n">stv090x_first_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv090x_dev</span> <span class="o">*</span><span class="n">del_dev</span> <span class="o">=</span> <span class="n">find_dev</span><span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
						<span class="n">internal</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">del_dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">del_dev</span> <span class="o">==</span> <span class="n">stv090x_first_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stv090x_first_dev</span> <span class="o">=</span> <span class="n">del_dev</span><span class="o">-&gt;</span><span class="n">next_dev</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">prev_dev</span><span class="o">-&gt;</span><span class="n">next_dev</span> <span class="o">!=</span> <span class="n">del_dev</span><span class="p">)</span>
				<span class="n">prev_dev</span> <span class="o">=</span> <span class="n">prev_dev</span><span class="o">-&gt;</span><span class="n">next_dev</span><span class="p">;</span>

			<span class="n">prev_dev</span><span class="o">-&gt;</span><span class="n">next_dev</span> <span class="o">=</span> <span class="n">del_dev</span><span class="o">-&gt;</span><span class="n">next_dev</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">del_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* allocating new chip */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_dev</span> <span class="o">*</span><span class="nf">append_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_internal</span> <span class="o">*</span><span class="n">internal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_dev</span> <span class="o">*</span><span class="n">new_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv090x_dev</span> <span class="o">*</span><span class="n">temp_dev</span><span class="p">;</span>

	<span class="n">new_dev</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_dev</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">=</span> <span class="n">internal</span><span class="p">;</span>
		<span class="n">new_dev</span><span class="o">-&gt;</span><span class="n">next_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* append to list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_first_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stv090x_first_dev</span> <span class="o">=</span> <span class="n">new_dev</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">temp_dev</span> <span class="o">=</span> <span class="n">stv090x_first_dev</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">temp_dev</span><span class="o">-&gt;</span><span class="n">next_dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">temp_dev</span> <span class="o">=</span> <span class="n">temp_dev</span><span class="o">-&gt;</span><span class="n">next_dev</span><span class="p">;</span>

			<span class="n">temp_dev</span><span class="o">-&gt;</span><span class="n">next_dev</span> <span class="o">=</span> <span class="n">new_dev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">new_dev</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* DVBS1 and DSS C/N Lookup table */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stv090x_tab</span> <span class="n">stv090x_s1cn_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">8917</span> <span class="p">},</span> <span class="cm">/*  0.0dB */</span>
	<span class="p">{</span>   <span class="mi">5</span><span class="p">,</span> <span class="mi">8801</span> <span class="p">},</span> <span class="cm">/*  0.5dB */</span>
	<span class="p">{</span>  <span class="mi">10</span><span class="p">,</span> <span class="mi">8667</span> <span class="p">},</span> <span class="cm">/*  1.0dB */</span>
	<span class="p">{</span>  <span class="mi">15</span><span class="p">,</span> <span class="mi">8522</span> <span class="p">},</span> <span class="cm">/*  1.5dB */</span>
	<span class="p">{</span>  <span class="mi">20</span><span class="p">,</span> <span class="mi">8355</span> <span class="p">},</span> <span class="cm">/*  2.0dB */</span>
	<span class="p">{</span>  <span class="mi">25</span><span class="p">,</span> <span class="mi">8175</span> <span class="p">},</span> <span class="cm">/*  2.5dB */</span>
	<span class="p">{</span>  <span class="mi">30</span><span class="p">,</span> <span class="mi">7979</span> <span class="p">},</span> <span class="cm">/*  3.0dB */</span>
	<span class="p">{</span>  <span class="mi">35</span><span class="p">,</span> <span class="mi">7763</span> <span class="p">},</span> <span class="cm">/*  3.5dB */</span>
	<span class="p">{</span>  <span class="mi">40</span><span class="p">,</span> <span class="mi">7530</span> <span class="p">},</span> <span class="cm">/*  4.0dB */</span>
	<span class="p">{</span>  <span class="mi">45</span><span class="p">,</span> <span class="mi">7282</span> <span class="p">},</span> <span class="cm">/*  4.5dB */</span>
	<span class="p">{</span>  <span class="mi">50</span><span class="p">,</span> <span class="mi">7026</span> <span class="p">},</span> <span class="cm">/*  5.0dB */</span>
	<span class="p">{</span>  <span class="mi">55</span><span class="p">,</span> <span class="mi">6781</span> <span class="p">},</span> <span class="cm">/*  5.5dB */</span>
	<span class="p">{</span>  <span class="mi">60</span><span class="p">,</span> <span class="mi">6514</span> <span class="p">},</span> <span class="cm">/*  6.0dB */</span>
	<span class="p">{</span>  <span class="mi">65</span><span class="p">,</span> <span class="mi">6241</span> <span class="p">},</span> <span class="cm">/*  6.5dB */</span>
	<span class="p">{</span>  <span class="mi">70</span><span class="p">,</span> <span class="mi">5965</span> <span class="p">},</span> <span class="cm">/*  7.0dB */</span>
	<span class="p">{</span>  <span class="mi">75</span><span class="p">,</span> <span class="mi">5690</span> <span class="p">},</span> <span class="cm">/*  7.5dB */</span>
	<span class="p">{</span>  <span class="mi">80</span><span class="p">,</span> <span class="mi">5424</span> <span class="p">},</span> <span class="cm">/*  8.0dB */</span>
	<span class="p">{</span>  <span class="mi">85</span><span class="p">,</span> <span class="mi">5161</span> <span class="p">},</span> <span class="cm">/*  8.5dB */</span>
	<span class="p">{</span>  <span class="mi">90</span><span class="p">,</span> <span class="mi">4902</span> <span class="p">},</span> <span class="cm">/*  9.0dB */</span>
	<span class="p">{</span>  <span class="mi">95</span><span class="p">,</span> <span class="mi">4654</span> <span class="p">},</span> <span class="cm">/*  9.5dB */</span>
	<span class="p">{</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">4417</span> <span class="p">},</span> <span class="cm">/* 10.0dB */</span>
	<span class="p">{</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">4186</span> <span class="p">},</span> <span class="cm">/* 10.5dB */</span>
	<span class="p">{</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">3968</span> <span class="p">},</span> <span class="cm">/* 11.0dB */</span>
	<span class="p">{</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">3757</span> <span class="p">},</span> <span class="cm">/* 11.5dB */</span>
	<span class="p">{</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">3558</span> <span class="p">},</span> <span class="cm">/* 12.0dB */</span>
	<span class="p">{</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">3366</span> <span class="p">},</span> <span class="cm">/* 12.5dB */</span>
	<span class="p">{</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">3185</span> <span class="p">},</span> <span class="cm">/* 13.0dB */</span>
	<span class="p">{</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">3012</span> <span class="p">},</span> <span class="cm">/* 13.5dB */</span>
	<span class="p">{</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">2850</span> <span class="p">},</span> <span class="cm">/* 14.0dB */</span>
	<span class="p">{</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">2698</span> <span class="p">},</span> <span class="cm">/* 14.5dB */</span>
	<span class="p">{</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">2550</span> <span class="p">},</span> <span class="cm">/* 15.0dB */</span>
	<span class="p">{</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">2283</span> <span class="p">},</span> <span class="cm">/* 16.0dB */</span>
	<span class="p">{</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">2042</span> <span class="p">},</span> <span class="cm">/* 17.0dB */</span>
	<span class="p">{</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">1827</span> <span class="p">},</span> <span class="cm">/* 18.0dB */</span>
	<span class="p">{</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">1636</span> <span class="p">},</span> <span class="cm">/* 19.0dB */</span>
	<span class="p">{</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">1466</span> <span class="p">},</span> <span class="cm">/* 20.0dB */</span>
	<span class="p">{</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">1315</span> <span class="p">},</span> <span class="cm">/* 21.0dB */</span>
	<span class="p">{</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">1181</span> <span class="p">},</span> <span class="cm">/* 22.0dB */</span>
	<span class="p">{</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">1064</span> <span class="p">},</span> <span class="cm">/* 23.0dB */</span>
	<span class="p">{</span> <span class="mi">240</span><span class="p">,</span>	<span class="mi">960</span> <span class="p">},</span> <span class="cm">/* 24.0dB */</span>
	<span class="p">{</span> <span class="mi">250</span><span class="p">,</span>	<span class="mi">869</span> <span class="p">},</span> <span class="cm">/* 25.0dB */</span>
	<span class="p">{</span> <span class="mi">260</span><span class="p">,</span>	<span class="mi">792</span> <span class="p">},</span> <span class="cm">/* 26.0dB */</span>
	<span class="p">{</span> <span class="mi">270</span><span class="p">,</span>	<span class="mi">724</span> <span class="p">},</span> <span class="cm">/* 27.0dB */</span>
	<span class="p">{</span> <span class="mi">280</span><span class="p">,</span>	<span class="mi">665</span> <span class="p">},</span> <span class="cm">/* 28.0dB */</span>
	<span class="p">{</span> <span class="mi">290</span><span class="p">,</span>	<span class="mi">616</span> <span class="p">},</span> <span class="cm">/* 29.0dB */</span>
	<span class="p">{</span> <span class="mi">300</span><span class="p">,</span>	<span class="mi">573</span> <span class="p">},</span> <span class="cm">/* 30.0dB */</span>
	<span class="p">{</span> <span class="mi">310</span><span class="p">,</span>	<span class="mi">537</span> <span class="p">},</span> <span class="cm">/* 31.0dB */</span>
	<span class="p">{</span> <span class="mi">320</span><span class="p">,</span>	<span class="mi">507</span> <span class="p">},</span> <span class="cm">/* 32.0dB */</span>
	<span class="p">{</span> <span class="mi">330</span><span class="p">,</span>	<span class="mi">483</span> <span class="p">},</span> <span class="cm">/* 33.0dB */</span>
	<span class="p">{</span> <span class="mi">400</span><span class="p">,</span>	<span class="mi">398</span> <span class="p">},</span> <span class="cm">/* 40.0dB */</span>
	<span class="p">{</span> <span class="mi">450</span><span class="p">,</span>	<span class="mi">381</span> <span class="p">},</span> <span class="cm">/* 45.0dB */</span>
	<span class="p">{</span> <span class="mi">500</span><span class="p">,</span>	<span class="mi">377</span> <span class="p">}</span>  <span class="cm">/* 50.0dB */</span>
<span class="p">};</span>

<span class="cm">/* DVBS2 C/N Lookup table */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stv090x_tab</span> <span class="n">stv090x_s2cn_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">13348</span> <span class="p">},</span> <span class="cm">/* -3.0dB */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">12640</span> <span class="p">},</span> <span class="cm">/* -2d.0B */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11883</span> <span class="p">},</span> <span class="cm">/* -1.0dB */</span>
	<span class="p">{</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">11101</span> <span class="p">},</span> <span class="cm">/* -0.0dB */</span>
	<span class="p">{</span>   <span class="mi">5</span><span class="p">,</span> <span class="mi">10718</span> <span class="p">},</span> <span class="cm">/*  0.5dB */</span>
	<span class="p">{</span>  <span class="mi">10</span><span class="p">,</span> <span class="mi">10339</span> <span class="p">},</span> <span class="cm">/*  1.0dB */</span>
	<span class="p">{</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">9947</span> <span class="p">},</span> <span class="cm">/*  1.5dB */</span>
	<span class="p">{</span>  <span class="mi">20</span><span class="p">,</span>  <span class="mi">9552</span> <span class="p">},</span> <span class="cm">/*  2.0dB */</span>
	<span class="p">{</span>  <span class="mi">25</span><span class="p">,</span>  <span class="mi">9183</span> <span class="p">},</span> <span class="cm">/*  2.5dB */</span>
	<span class="p">{</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">8799</span> <span class="p">},</span> <span class="cm">/*  3.0dB */</span>
	<span class="p">{</span>  <span class="mi">35</span><span class="p">,</span>  <span class="mi">8422</span> <span class="p">},</span> <span class="cm">/*  3.5dB */</span>
	<span class="p">{</span>  <span class="mi">40</span><span class="p">,</span>  <span class="mi">8062</span> <span class="p">},</span> <span class="cm">/*  4.0dB */</span>
	<span class="p">{</span>  <span class="mi">45</span><span class="p">,</span>  <span class="mi">7707</span> <span class="p">},</span> <span class="cm">/*  4.5dB */</span>
	<span class="p">{</span>  <span class="mi">50</span><span class="p">,</span>  <span class="mi">7353</span> <span class="p">},</span> <span class="cm">/*  5.0dB */</span>
	<span class="p">{</span>  <span class="mi">55</span><span class="p">,</span>  <span class="mi">7025</span> <span class="p">},</span> <span class="cm">/*  5.5dB */</span>
	<span class="p">{</span>  <span class="mi">60</span><span class="p">,</span>  <span class="mi">6684</span> <span class="p">},</span> <span class="cm">/*  6.0dB */</span>
	<span class="p">{</span>  <span class="mi">65</span><span class="p">,</span>  <span class="mi">6331</span> <span class="p">},</span> <span class="cm">/*  6.5dB */</span>
	<span class="p">{</span>  <span class="mi">70</span><span class="p">,</span>  <span class="mi">6036</span> <span class="p">},</span> <span class="cm">/*  7.0dB */</span>
	<span class="p">{</span>  <span class="mi">75</span><span class="p">,</span>  <span class="mi">5727</span> <span class="p">},</span> <span class="cm">/*  7.5dB */</span>
	<span class="p">{</span>  <span class="mi">80</span><span class="p">,</span>  <span class="mi">5437</span> <span class="p">},</span> <span class="cm">/*  8.0dB */</span>
	<span class="p">{</span>  <span class="mi">85</span><span class="p">,</span>  <span class="mi">5164</span> <span class="p">},</span> <span class="cm">/*  8.5dB */</span>
	<span class="p">{</span>  <span class="mi">90</span><span class="p">,</span>  <span class="mi">4902</span> <span class="p">},</span> <span class="cm">/*  9.0dB */</span>
	<span class="p">{</span>  <span class="mi">95</span><span class="p">,</span>  <span class="mi">4653</span> <span class="p">},</span> <span class="cm">/*  9.5dB */</span>
	<span class="p">{</span> <span class="mi">100</span><span class="p">,</span>  <span class="mi">4408</span> <span class="p">},</span> <span class="cm">/* 10.0dB */</span>
	<span class="p">{</span> <span class="mi">105</span><span class="p">,</span>  <span class="mi">4187</span> <span class="p">},</span> <span class="cm">/* 10.5dB */</span>
	<span class="p">{</span> <span class="mi">110</span><span class="p">,</span>  <span class="mi">3961</span> <span class="p">},</span> <span class="cm">/* 11.0dB */</span>
	<span class="p">{</span> <span class="mi">115</span><span class="p">,</span>  <span class="mi">3751</span> <span class="p">},</span> <span class="cm">/* 11.5dB */</span>
	<span class="p">{</span> <span class="mi">120</span><span class="p">,</span>  <span class="mi">3558</span> <span class="p">},</span> <span class="cm">/* 12.0dB */</span>
	<span class="p">{</span> <span class="mi">125</span><span class="p">,</span>  <span class="mi">3368</span> <span class="p">},</span> <span class="cm">/* 12.5dB */</span>
	<span class="p">{</span> <span class="mi">130</span><span class="p">,</span>  <span class="mi">3191</span> <span class="p">},</span> <span class="cm">/* 13.0dB */</span>
	<span class="p">{</span> <span class="mi">135</span><span class="p">,</span>  <span class="mi">3017</span> <span class="p">},</span> <span class="cm">/* 13.5dB */</span>
	<span class="p">{</span> <span class="mi">140</span><span class="p">,</span>  <span class="mi">2862</span> <span class="p">},</span> <span class="cm">/* 14.0dB */</span>
	<span class="p">{</span> <span class="mi">145</span><span class="p">,</span>  <span class="mi">2710</span> <span class="p">},</span> <span class="cm">/* 14.5dB */</span>
	<span class="p">{</span> <span class="mi">150</span><span class="p">,</span>  <span class="mi">2565</span> <span class="p">},</span> <span class="cm">/* 15.0dB */</span>
	<span class="p">{</span> <span class="mi">160</span><span class="p">,</span>  <span class="mi">2300</span> <span class="p">},</span> <span class="cm">/* 16.0dB */</span>
	<span class="p">{</span> <span class="mi">170</span><span class="p">,</span>  <span class="mi">2058</span> <span class="p">},</span> <span class="cm">/* 17.0dB */</span>
	<span class="p">{</span> <span class="mi">180</span><span class="p">,</span>  <span class="mi">1849</span> <span class="p">},</span> <span class="cm">/* 18.0dB */</span>
	<span class="p">{</span> <span class="mi">190</span><span class="p">,</span>  <span class="mi">1663</span> <span class="p">},</span> <span class="cm">/* 19.0dB */</span>
	<span class="p">{</span> <span class="mi">200</span><span class="p">,</span>  <span class="mi">1495</span> <span class="p">},</span> <span class="cm">/* 20.0dB */</span>
	<span class="p">{</span> <span class="mi">210</span><span class="p">,</span>  <span class="mi">1349</span> <span class="p">},</span> <span class="cm">/* 21.0dB */</span>
	<span class="p">{</span> <span class="mi">220</span><span class="p">,</span>  <span class="mi">1222</span> <span class="p">},</span> <span class="cm">/* 22.0dB */</span>
	<span class="p">{</span> <span class="mi">230</span><span class="p">,</span>  <span class="mi">1110</span> <span class="p">},</span> <span class="cm">/* 23.0dB */</span>
	<span class="p">{</span> <span class="mi">240</span><span class="p">,</span>  <span class="mi">1011</span> <span class="p">},</span> <span class="cm">/* 24.0dB */</span>
	<span class="p">{</span> <span class="mi">250</span><span class="p">,</span>   <span class="mi">925</span> <span class="p">},</span> <span class="cm">/* 25.0dB */</span>
	<span class="p">{</span> <span class="mi">260</span><span class="p">,</span>   <span class="mi">853</span> <span class="p">},</span> <span class="cm">/* 26.0dB */</span>
	<span class="p">{</span> <span class="mi">270</span><span class="p">,</span>   <span class="mi">789</span> <span class="p">},</span> <span class="cm">/* 27.0dB */</span>
	<span class="p">{</span> <span class="mi">280</span><span class="p">,</span>   <span class="mi">734</span> <span class="p">},</span> <span class="cm">/* 28.0dB */</span>
	<span class="p">{</span> <span class="mi">290</span><span class="p">,</span>   <span class="mi">690</span> <span class="p">},</span> <span class="cm">/* 29.0dB */</span>
	<span class="p">{</span> <span class="mi">300</span><span class="p">,</span>   <span class="mi">650</span> <span class="p">},</span> <span class="cm">/* 30.0dB */</span>
	<span class="p">{</span> <span class="mi">310</span><span class="p">,</span>   <span class="mi">619</span> <span class="p">},</span> <span class="cm">/* 31.0dB */</span>
	<span class="p">{</span> <span class="mi">320</span><span class="p">,</span>   <span class="mi">593</span> <span class="p">},</span> <span class="cm">/* 32.0dB */</span>
	<span class="p">{</span> <span class="mi">330</span><span class="p">,</span>   <span class="mi">571</span> <span class="p">},</span> <span class="cm">/* 33.0dB */</span>
	<span class="p">{</span> <span class="mi">400</span><span class="p">,</span>   <span class="mi">498</span> <span class="p">},</span> <span class="cm">/* 40.0dB */</span>
	<span class="p">{</span> <span class="mi">450</span><span class="p">,</span>	 <span class="mi">484</span> <span class="p">},</span> <span class="cm">/* 45.0dB */</span>
	<span class="p">{</span> <span class="mi">500</span><span class="p">,</span>	 <span class="mi">481</span> <span class="p">}</span>	<span class="cm">/* 50.0dB */</span>
<span class="p">};</span>

<span class="cm">/* RF level C/N lookup table */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stv090x_tab</span> <span class="n">stv090x_rf_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>  <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mh">0xcaa1</span> <span class="p">},</span> <span class="cm">/*  -5dBm */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mh">0xc229</span> <span class="p">},</span> <span class="cm">/* -10dBm */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mh">0xbb08</span> <span class="p">},</span> <span class="cm">/* -15dBm */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mh">0xb4bc</span> <span class="p">},</span> <span class="cm">/* -20dBm */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mh">0xad5a</span> <span class="p">},</span> <span class="cm">/* -25dBm */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mh">0xa298</span> <span class="p">},</span> <span class="cm">/* -30dBm */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">35</span><span class="p">,</span> <span class="mh">0x98a8</span> <span class="p">},</span> <span class="cm">/* -35dBm */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mh">0x8389</span> <span class="p">},</span> <span class="cm">/* -40dBm */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="mh">0x59be</span> <span class="p">},</span> <span class="cm">/* -45dBm */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mh">0x3a14</span> <span class="p">},</span> <span class="cm">/* -50dBm */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="mh">0x2d11</span> <span class="p">},</span> <span class="cm">/* -55dBm */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mh">0x210d</span> <span class="p">},</span> <span class="cm">/* -60dBm */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">65</span><span class="p">,</span> <span class="mh">0xa14f</span> <span class="p">},</span> <span class="cm">/* -65dBm */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="mh">0x07aa</span> <span class="p">}</span>	 <span class="cm">/* -70dBm */</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_reg</span> <span class="n">stv0900_initval</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">{</span> <span class="n">STV090x_OUTCFG</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_MODECFG</span><span class="p">,</span>		<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_AGCRF1CFG</span><span class="p">,</span>		<span class="mh">0x11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_AGCRF2CFG</span><span class="p">,</span>		<span class="mh">0x13</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_TSGENERAL1X</span><span class="p">,</span>		<span class="mh">0x14</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_TSTTNR2</span><span class="p">,</span>		<span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_TSTTNR4</span><span class="p">,</span>		<span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_DISTXCTL</span><span class="p">,</span>		<span class="mh">0x22</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_F22TX</span><span class="p">,</span>		<span class="mh">0xc0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_F22RX</span><span class="p">,</span>		<span class="mh">0xc0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_DISRXCTL</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_DMDCFGMD</span><span class="p">,</span>		<span class="mh">0xF9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_DEMOD</span><span class="p">,</span>		<span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_DMDCFG3</span><span class="p">,</span>		<span class="mh">0xc4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_CARFREQ</span><span class="p">,</span>		<span class="mh">0xed</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_LDT</span><span class="p">,</span>		<span class="mh">0xd0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_LDT2</span><span class="p">,</span>		<span class="mh">0xb8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_TMGCFG</span><span class="p">,</span>		<span class="mh">0xd2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_TMGTHRISE</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_TMGCFG</span><span class="p">,</span>		<span class="mh">0xd2</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">STV090x_P2_TMGTHFALL</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_FECSPY</span><span class="p">,</span>		<span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_FSPYDATA</span><span class="p">,</span>		<span class="mh">0x3a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_FBERCPT4</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_FSPYBER</span><span class="p">,</span>		<span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_ERRCTRL1</span><span class="p">,</span>		<span class="mh">0x35</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_ERRCTRL2</span><span class="p">,</span>		<span class="mh">0xc1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_CFRICFG</span><span class="p">,</span>		<span class="mh">0xf8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_NOSCFG</span><span class="p">,</span>		<span class="mh">0x1c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_DMDTOM</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_CORRELMANT</span><span class="p">,</span>	<span class="mh">0x70</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_CORRELABS</span><span class="p">,</span>		<span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_AGC2O</span><span class="p">,</span>		<span class="mh">0x5b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_AGC2REF</span><span class="p">,</span>		<span class="mh">0x38</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_CARCFG</span><span class="p">,</span>		<span class="mh">0xe4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_ACLC</span><span class="p">,</span>		<span class="mh">0x1A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_BCLC</span><span class="p">,</span>		<span class="mh">0x09</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_CARHDR</span><span class="p">,</span>		<span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_KREFTMG</span><span class="p">,</span>		<span class="mh">0xc1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_SFRUPRATIO</span><span class="p">,</span>	<span class="mh">0xf0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_SFRLOWRATIO</span><span class="p">,</span>	<span class="mh">0x70</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_SFRSTEP</span><span class="p">,</span>		<span class="mh">0x58</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_TMGCFG2</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_CAR2CFG</span><span class="p">,</span>		<span class="mh">0x26</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_BCLC2S2Q</span><span class="p">,</span>		<span class="mh">0x86</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_BCLC2S28</span><span class="p">,</span>		<span class="mh">0x86</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_SMAPCOEF7</span><span class="p">,</span>		<span class="mh">0x77</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_SMAPCOEF6</span><span class="p">,</span>		<span class="mh">0x85</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_SMAPCOEF5</span><span class="p">,</span>		<span class="mh">0x77</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_TSCFGL</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_DMDCFG2</span><span class="p">,</span>		<span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLST0</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLST1</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLST2</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLST3</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLST4</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLST5</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLST6</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLST7</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLST8</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLST9</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLSTA</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLSTB</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLSTC</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLSTD</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLSTE</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_MODCODLSTF</span><span class="p">,</span>	<span class="mh">0xcf</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DISTXCTL</span><span class="p">,</span>		<span class="mh">0x22</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_F22TX</span><span class="p">,</span>		<span class="mh">0xc0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_F22RX</span><span class="p">,</span>		<span class="mh">0xc0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DISRXCTL</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DMDCFGMD</span><span class="p">,</span>		<span class="mh">0xf9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DEMOD</span><span class="p">,</span>		<span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DMDCFG3</span><span class="p">,</span>		<span class="mh">0xc4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DMDTOM</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CARFREQ</span><span class="p">,</span>		<span class="mh">0xed</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_LDT</span><span class="p">,</span>		<span class="mh">0xd0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_LDT2</span><span class="p">,</span>		<span class="mh">0xb8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_TMGCFG</span><span class="p">,</span>		<span class="mh">0xd2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_TMGTHRISE</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_TMGTHFALL</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SFRUPRATIO</span><span class="p">,</span>	<span class="mh">0xf0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SFRLOWRATIO</span><span class="p">,</span>	<span class="mh">0x70</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_TSCFGL</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_FECSPY</span><span class="p">,</span>		<span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_FSPYDATA</span><span class="p">,</span>		<span class="mh">0x3a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_FBERCPT4</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_FSPYBER</span><span class="p">,</span>		<span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_ERRCTRL1</span><span class="p">,</span>		<span class="mh">0x35</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_ERRCTRL2</span><span class="p">,</span>		<span class="mh">0xc1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CFRICFG</span><span class="p">,</span>		<span class="mh">0xf8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_NOSCFG</span><span class="p">,</span>		<span class="mh">0x1c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CORRELMANT</span><span class="p">,</span>	<span class="mh">0x70</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CORRELABS</span><span class="p">,</span>		<span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_AGC2O</span><span class="p">,</span>		<span class="mh">0x5b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_AGC2REF</span><span class="p">,</span>		<span class="mh">0x38</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CARCFG</span><span class="p">,</span>		<span class="mh">0xe4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_ACLC</span><span class="p">,</span>		<span class="mh">0x1A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_BCLC</span><span class="p">,</span>		<span class="mh">0x09</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CARHDR</span><span class="p">,</span>		<span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_KREFTMG</span><span class="p">,</span>		<span class="mh">0xc1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SFRSTEP</span><span class="p">,</span>		<span class="mh">0x58</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_TMGCFG2</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CAR2CFG</span><span class="p">,</span>		<span class="mh">0x26</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_BCLC2S2Q</span><span class="p">,</span>		<span class="mh">0x86</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_BCLC2S28</span><span class="p">,</span>		<span class="mh">0x86</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SMAPCOEF7</span><span class="p">,</span>		<span class="mh">0x77</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SMAPCOEF6</span><span class="p">,</span>		<span class="mh">0x85</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SMAPCOEF5</span><span class="p">,</span>		<span class="mh">0x77</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DMDCFG2</span><span class="p">,</span>		<span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST0</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST1</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST2</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST3</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST4</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST5</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST6</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST7</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST8</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST9</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLSTA</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLSTB</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLSTC</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLSTD</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLSTE</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLSTF</span><span class="p">,</span>	<span class="mh">0xcf</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GENCFG</span><span class="p">,</span>		<span class="mh">0x1d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF4</span><span class="p">,</span>		<span class="mh">0x37</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF5</span><span class="p">,</span>		<span class="mh">0x29</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF6</span><span class="p">,</span>		<span class="mh">0x37</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF7</span><span class="p">,</span>		<span class="mh">0x33</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF8</span><span class="p">,</span>		<span class="mh">0x31</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF9</span><span class="p">,</span>		<span class="mh">0x2f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF10</span><span class="p">,</span>		<span class="mh">0x39</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF11</span><span class="p">,</span>		<span class="mh">0x3a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF12</span><span class="p">,</span>		<span class="mh">0x29</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF13</span><span class="p">,</span>		<span class="mh">0x37</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF14</span><span class="p">,</span>		<span class="mh">0x33</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF15</span><span class="p">,</span>		<span class="mh">0x2f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF16</span><span class="p">,</span>		<span class="mh">0x39</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF17</span><span class="p">,</span>		<span class="mh">0x3a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITERNOERR</span><span class="p">,</span>		<span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF4</span><span class="p">,</span>		<span class="mh">0x0C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF5</span><span class="p">,</span>		<span class="mh">0x0F</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF6</span><span class="p">,</span>		<span class="mh">0x11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF7</span><span class="p">,</span>		<span class="mh">0x14</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF8</span><span class="p">,</span>		<span class="mh">0x17</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF9</span><span class="p">,</span>		<span class="mh">0x19</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF10</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF11</span><span class="p">,</span>		<span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF12</span><span class="p">,</span>		<span class="mh">0x0D</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF13</span><span class="p">,</span>		<span class="mh">0x0F</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF14</span><span class="p">,</span>		<span class="mh">0x13</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF15</span><span class="p">,</span>		<span class="mh">0x1A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF16</span><span class="p">,</span>		<span class="mh">0x1F</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF17</span><span class="p">,</span>		<span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_RCCFGH</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_FECM</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span> <span class="cm">/* disable DSS modes */</span>
	<span class="p">{</span> <span class="n">STV090x_P2_FECM</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span> <span class="cm">/* disable DSS modes */</span>
	<span class="p">{</span> <span class="n">STV090x_P1_PRVIT</span><span class="p">,</span>		<span class="mh">0x2F</span> <span class="p">},</span> <span class="cm">/* disable PR 6/7 */</span>
	<span class="p">{</span> <span class="n">STV090x_P2_PRVIT</span><span class="p">,</span>		<span class="mh">0x2F</span> <span class="p">},</span> <span class="cm">/* disable PR 6/7 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_reg</span> <span class="n">stv0903_initval</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">STV090x_OUTCFG</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_AGCRF1CFG</span><span class="p">,</span>		<span class="mh">0x11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_STOPCLK1</span><span class="p">,</span>		<span class="mh">0x48</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_STOPCLK2</span><span class="p">,</span>		<span class="mh">0x14</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_TSTTNR1</span><span class="p">,</span>		<span class="mh">0x27</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_TSTTNR2</span><span class="p">,</span>		<span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DISTXCTL</span><span class="p">,</span>		<span class="mh">0x22</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_F22TX</span><span class="p">,</span>		<span class="mh">0xc0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_F22RX</span><span class="p">,</span>		<span class="mh">0xc0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DISRXCTL</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DMDCFGMD</span><span class="p">,</span>		<span class="mh">0xF9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DEMOD</span><span class="p">,</span>		<span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DMDCFG3</span><span class="p">,</span>		<span class="mh">0xc4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CARFREQ</span><span class="p">,</span>		<span class="mh">0xed</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_TNRCFG2</span><span class="p">,</span>		<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_LDT</span><span class="p">,</span>		<span class="mh">0xd0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_LDT2</span><span class="p">,</span>		<span class="mh">0xb8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_TMGCFG</span><span class="p">,</span>		<span class="mh">0xd2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_TMGTHRISE</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_TMGTHFALL</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SFRUPRATIO</span><span class="p">,</span>	<span class="mh">0xf0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SFRLOWRATIO</span><span class="p">,</span>	<span class="mh">0x70</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_TSCFGL</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_FECSPY</span><span class="p">,</span>		<span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_FSPYDATA</span><span class="p">,</span>		<span class="mh">0x3a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_FBERCPT4</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_FSPYBER</span><span class="p">,</span>		<span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_ERRCTRL1</span><span class="p">,</span>		<span class="mh">0x35</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_ERRCTRL2</span><span class="p">,</span>		<span class="mh">0xc1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CFRICFG</span><span class="p">,</span>		<span class="mh">0xf8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_NOSCFG</span><span class="p">,</span>		<span class="mh">0x1c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DMDTOM</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CORRELMANT</span><span class="p">,</span>	<span class="mh">0x70</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CORRELABS</span><span class="p">,</span>		<span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_AGC2O</span><span class="p">,</span>		<span class="mh">0x5b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_AGC2REF</span><span class="p">,</span>		<span class="mh">0x38</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CARCFG</span><span class="p">,</span>		<span class="mh">0xe4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_ACLC</span><span class="p">,</span>		<span class="mh">0x1A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_BCLC</span><span class="p">,</span>		<span class="mh">0x09</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CARHDR</span><span class="p">,</span>		<span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_KREFTMG</span><span class="p">,</span>		<span class="mh">0xc1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SFRSTEP</span><span class="p">,</span>		<span class="mh">0x58</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_TMGCFG2</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CAR2CFG</span><span class="p">,</span>		<span class="mh">0x26</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_BCLC2S2Q</span><span class="p">,</span>		<span class="mh">0x86</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_BCLC2S28</span><span class="p">,</span>		<span class="mh">0x86</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SMAPCOEF7</span><span class="p">,</span>		<span class="mh">0x77</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SMAPCOEF6</span><span class="p">,</span>		<span class="mh">0x85</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SMAPCOEF5</span><span class="p">,</span>		<span class="mh">0x77</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DMDCFG2</span><span class="p">,</span>		<span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST0</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST1</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST2</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST3</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST4</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST5</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST6</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST7</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST8</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLST9</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLSTA</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLSTB</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLSTC</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLSTD</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLSTE</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_MODCODLSTF</span><span class="p">,</span>	<span class="mh">0xcf</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GENCFG</span><span class="p">,</span>		<span class="mh">0x1c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF4</span><span class="p">,</span>		<span class="mh">0x37</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF5</span><span class="p">,</span>		<span class="mh">0x29</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF6</span><span class="p">,</span>		<span class="mh">0x37</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF7</span><span class="p">,</span>		<span class="mh">0x33</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF8</span><span class="p">,</span>		<span class="mh">0x31</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF9</span><span class="p">,</span>		<span class="mh">0x2f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF10</span><span class="p">,</span>		<span class="mh">0x39</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF11</span><span class="p">,</span>		<span class="mh">0x3a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF12</span><span class="p">,</span>		<span class="mh">0x29</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF13</span><span class="p">,</span>		<span class="mh">0x37</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF14</span><span class="p">,</span>		<span class="mh">0x33</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF15</span><span class="p">,</span>		<span class="mh">0x2f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF16</span><span class="p">,</span>		<span class="mh">0x39</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITER_NF17</span><span class="p">,</span>		<span class="mh">0x3a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_NBITERNOERR</span><span class="p">,</span>		<span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF4</span><span class="p">,</span>		<span class="mh">0x0C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF5</span><span class="p">,</span>		<span class="mh">0x0F</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF6</span><span class="p">,</span>		<span class="mh">0x11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF7</span><span class="p">,</span>		<span class="mh">0x14</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF8</span><span class="p">,</span>		<span class="mh">0x17</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF9</span><span class="p">,</span>		<span class="mh">0x19</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF10</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF11</span><span class="p">,</span>		<span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF12</span><span class="p">,</span>		<span class="mh">0x0D</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF13</span><span class="p">,</span>		<span class="mh">0x0F</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF14</span><span class="p">,</span>		<span class="mh">0x13</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF15</span><span class="p">,</span>		<span class="mh">0x1A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF16</span><span class="p">,</span>		<span class="mh">0x1F</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF17</span><span class="p">,</span>		<span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_RCCFGH</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_FECM</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span> <span class="cm">/*disable the DSS mode */</span>
	<span class="p">{</span> <span class="n">STV090x_P1_PRVIT</span><span class="p">,</span>		<span class="mh">0x2f</span> <span class="p">}</span>  <span class="cm">/*disable puncture rate 6/7*/</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_reg</span> <span class="n">stv0900_cut20_val</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">{</span> <span class="n">STV090x_P2_DMDCFG3</span><span class="p">,</span>		<span class="mh">0xe8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_DMDCFG4</span><span class="p">,</span>		<span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_CARFREQ</span><span class="p">,</span>		<span class="mh">0x38</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_CARHDR</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_KREFTMG</span><span class="p">,</span>		<span class="mh">0x5a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_SMAPCOEF7</span><span class="p">,</span>		<span class="mh">0x06</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_SMAPCOEF6</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_SMAPCOEF5</span><span class="p">,</span>		<span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P2_NOSCFG</span><span class="p">,</span>		<span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DMDCFG3</span><span class="p">,</span>		<span class="mh">0xe8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DMDCFG4</span><span class="p">,</span>		<span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CARFREQ</span><span class="p">,</span>		<span class="mh">0x38</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CARHDR</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_KREFTMG</span><span class="p">,</span>		<span class="mh">0x5a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SMAPCOEF7</span><span class="p">,</span>		<span class="mh">0x06</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SMAPCOEF6</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SMAPCOEF5</span><span class="p">,</span>		<span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_NOSCFG</span><span class="p">,</span>		<span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF4</span><span class="p">,</span>		<span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF5</span><span class="p">,</span>		<span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF6</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF7</span><span class="p">,</span>		<span class="mh">0x1F</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF8</span><span class="p">,</span>		<span class="mh">0x1E</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF9</span><span class="p">,</span>		<span class="mh">0x1E</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF10</span><span class="p">,</span>		<span class="mh">0x1D</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF11</span><span class="p">,</span>		<span class="mh">0x1B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF12</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF13</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF14</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF15</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF16</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF17</span><span class="p">,</span>		<span class="mh">0x21</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_reg</span> <span class="n">stv0903_cut20_val</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DMDCFG3</span><span class="p">,</span>		<span class="mh">0xe8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_DMDCFG4</span><span class="p">,</span>		<span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CARFREQ</span><span class="p">,</span>		<span class="mh">0x38</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_CARHDR</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_KREFTMG</span><span class="p">,</span>		<span class="mh">0x5a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SMAPCOEF7</span><span class="p">,</span>		<span class="mh">0x06</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SMAPCOEF6</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_SMAPCOEF5</span><span class="p">,</span>		<span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_P1_NOSCFG</span><span class="p">,</span>		<span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF4</span><span class="p">,</span>		<span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF5</span><span class="p">,</span>		<span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF6</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF7</span><span class="p">,</span>		<span class="mh">0x1F</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF8</span><span class="p">,</span>		<span class="mh">0x1E</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF9</span><span class="p">,</span>		<span class="mh">0x1E</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF10</span><span class="p">,</span>		<span class="mh">0x1D</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF11</span><span class="p">,</span>		<span class="mh">0x1B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF12</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF13</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF14</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF15</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF16</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_GAINLLR_NF17</span><span class="p">,</span>		<span class="mh">0x21</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Cut 2.0 Long Frame Tracking CR loop */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_long_frame_crloop</span> <span class="n">stv090x_s2_crl_cut20</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MODCOD  2MPon 2MPoff 5MPon 5MPoff 10MPon 10MPoff 20MPon 20MPoff 30MPon 30MPoff */</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_12</span><span class="p">,</span>  <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x1e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_35</span><span class="p">,</span>  <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x0e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_23</span><span class="p">,</span>  <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_34</span><span class="p">,</span>  <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_45</span><span class="p">,</span>  <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_56</span><span class="p">,</span>  <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_89</span><span class="p">,</span>  <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_910</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK_35</span><span class="p">,</span>  <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK_23</span><span class="p">,</span>  <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x1d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK_34</span><span class="p">,</span>  <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK_56</span><span class="p">,</span>  <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x1d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK_89</span><span class="p">,</span>  <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x1d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK_910</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x1d</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Cut 3.0 Long Frame Tracking CR loop */</span>
<span class="k">static</span>	<span class="k">struct</span> <span class="n">stv090x_long_frame_crloop</span> <span class="n">stv090x_s2_crl_cut30</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MODCOD  2MPon 2MPoff 5MPon 5MPoff 10MPon 10MPoff 20MPon 20MPoff 30MPon 30MPoff */</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_12</span><span class="p">,</span>  <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_35</span><span class="p">,</span>  <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_23</span><span class="p">,</span>  <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_34</span><span class="p">,</span>  <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_45</span><span class="p">,</span>  <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_56</span><span class="p">,</span>  <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_89</span><span class="p">,</span>  <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_910</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK_35</span><span class="p">,</span>  <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x19</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK_23</span><span class="p">,</span>  <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK_34</span><span class="p">,</span>  <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x3a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK_56</span><span class="p">,</span>  <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x1b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK_89</span><span class="p">,</span>  <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x1b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK_910</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x1b</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Cut 2.0 Long Frame Tracking CR Loop */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_long_frame_crloop</span> <span class="n">stv090x_s2_apsk_crl_cut20</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MODCOD  2MPon 2MPoff 5MPon 5MPoff 10MPon 10MPoff 20MPon 20MPoff 30MPon 30MPoff */</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK_23</span><span class="p">,</span>  <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK_34</span><span class="p">,</span>  <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK_45</span><span class="p">,</span>  <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK_56</span><span class="p">,</span>  <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK_89</span><span class="p">,</span>  <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK_910</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_32APSK_34</span><span class="p">,</span>  <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_32APSK_45</span><span class="p">,</span>  <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_32APSK_56</span><span class="p">,</span>  <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_32APSK_89</span><span class="p">,</span>  <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_32APSK_910</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Cut 3.0 Long Frame Tracking CR Loop */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_long_frame_crloop</span>	<span class="n">stv090x_s2_apsk_crl_cut30</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MODCOD  2MPon 2MPoff 5MPon 5MPoff 10MPon 10MPoff 20MPon 20MPoff 30MPon 30MPoff */</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK_23</span><span class="p">,</span>  <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK_34</span><span class="p">,</span>  <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK_45</span><span class="p">,</span>  <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK_56</span><span class="p">,</span>  <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK_89</span><span class="p">,</span>  <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK_910</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_32APSK_34</span><span class="p">,</span>  <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_32APSK_45</span><span class="p">,</span>  <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_32APSK_56</span><span class="p">,</span>  <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_32APSK_89</span><span class="p">,</span>  <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_32APSK_910</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_long_frame_crloop</span> <span class="n">stv090x_s2_lowqpsk_crl_cut20</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MODCOD  2MPon 2MPoff 5MPon 5MPoff 10MPon 10MPoff 20MPon 20MPoff 30MPon 30MPoff */</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_14</span><span class="p">,</span>  <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_13</span><span class="p">,</span>  <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x2e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_25</span><span class="p">,</span>  <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x2e</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_long_frame_crloop</span>	<span class="n">stv090x_s2_lowqpsk_crl_cut30</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MODCOD  2MPon 2MPoff 5MPon 5MPoff 10MPon 10MPoff 20MPon 20MPoff 30MPon 30MPoff */</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_14</span><span class="p">,</span>  <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_13</span><span class="p">,</span>  <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x2b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK_25</span><span class="p">,</span>  <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x2b</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Cut 2.0 Short Frame Tracking CR Loop */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_short_frame_crloop</span> <span class="n">stv090x_s2_short_crl_cut20</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MODCOD	  2M    5M    10M   20M   30M */</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK</span><span class="p">,</span>   <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x3d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK</span><span class="p">,</span>   <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x3c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x2d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_32APSK</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x2d</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Cut 3.0 Short Frame Tracking CR Loop */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_short_frame_crloop</span> <span class="n">stv090x_s2_short_crl_cut30</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MODCOD  	  2M	5M    10M   20M	  30M */</span>
	<span class="p">{</span> <span class="n">STV090x_QPSK</span><span class="p">,</span>   <span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x3A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_8PSK</span><span class="p">,</span>   <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x39</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_16APSK</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x2A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STV090x_32APSK</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x2A</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">s32</span> <span class="nf">comp2</span><span class="p">(</span><span class="n">s32</span> <span class="n">__x</span><span class="p">,</span> <span class="n">s32</span> <span class="n">__width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__width</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">__x</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">__x</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">__width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">?</span> <span class="p">(</span><span class="n">__x</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">__width</span><span class="p">))</span> <span class="o">:</span> <span class="n">__x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stv090x_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">b0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 		<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b0</span><span class="p">,</span>   <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>	<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="s">&quot;Read error, Reg=[0x%02x], Status=%d&quot;</span><span class="p">,</span>
				<span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">FE_DEBUGREG</span><span class="p">))</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Reg=[0x%02x], data=%02x&quot;</span><span class="p">,</span>
			<span class="n">reg</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_write_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stv090x_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">count</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">i2c_msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">count</span> <span class="p">};</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">FE_DEBUGREG</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s [0x%04x]:&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Reg=[0x%04x], Data=[0x%02x ...], Count=%u, Status=%d&quot;</span><span class="p">,</span>
				<span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">stv090x_write_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE! A lock is used as a FSM to control the state in which</span>
<span class="cm">	 * access is serialized between two tuners on the same demod.</span>
<span class="cm">	 * This has nothing to do with a lock to protect a critical section</span>
<span class="cm">	 * which may in some other cases be confused with protecting I/O</span>
<span class="cm">	 * access to the demodulator gate.</span>
<span class="cm">	 * In case of any error, the lock is unlocked and exit within the</span>
<span class="cm">	 * relevant operations themselves.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_i2c_lock</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_i2c_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">tuner_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">I2CRPT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Enable Gate&quot;</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">I2CT_ON_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">I2CRPT</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Disable Gate&quot;</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">I2CT_ON_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">I2CRPT</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_i2c_lock</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_i2c_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">tuner_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_i2c_lock</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_i2c_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">tuner_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv090x_get_lock_tmg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_BLIND_SEARCH</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Blind Search&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">1500000</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/*10Msps&lt; SR &lt;=15Msps*/</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">FecTimeout</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">5000000</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/*10Msps&lt; SR &lt;=15Msps*/</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">FecTimeout</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="cm">/*SR &gt;20Msps*/</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span> <span class="o">=</span> <span class="mi">700</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">FecTimeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_COLD_SEARCH</span>:
	<span class="k">case</span> <span class="n">STV090x_WARM_SEARCH</span>:
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Normal Search&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/*SR &lt;=1Msps*/</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span> <span class="o">=</span> <span class="mi">4500</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">FecTimeout</span> <span class="o">=</span> <span class="mi">1700</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">2000000</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/*1Msps &lt; SR &lt;= 2Msps */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span> <span class="o">=</span> <span class="mi">2500</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">FecTimeout</span> <span class="o">=</span> <span class="mi">1100</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">5000000</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/*2Msps &lt; SR &lt;= 5Msps */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">FecTimeout</span> <span class="o">=</span> <span class="mi">550</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">10000000</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/*5Msps &lt; SR &lt;= 10Msps */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span> <span class="o">=</span> <span class="mi">700</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">FecTimeout</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">20000000</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/*10Msps &lt; SR &lt;= 20Msps */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">FecTimeout</span> <span class="o">=</span> <span class="mi">130</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>   <span class="cm">/*SR &gt;20Msps*/</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">FecTimeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">==</span> <span class="n">STV090x_WARM_SEARCH</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_set_srate</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">srate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sym</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&gt;</span> <span class="mi">60000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span> <span class="cm">/* SR * 2^16 / master_clk */</span>
		<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&gt;</span> <span class="mi">6000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRINIT1</span><span class="p">,</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* MSB */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRINIT0</span><span class="p">,</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* LSB */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_set_max_srate</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">srate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sym</span><span class="p">;</span>

	<span class="n">srate</span> <span class="o">=</span> <span class="mi">105</span> <span class="o">*</span> <span class="p">(</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&gt;</span> <span class="mi">60000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span> <span class="cm">/* SR * 2^16 / master_clk */</span>
		<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&gt;</span> <span class="mi">6000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&lt;</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRUP1</span><span class="p">,</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* MSB */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRUP0</span><span class="p">,</span> <span class="n">sym</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* LSB */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRUP1</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* MSB */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRUP0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* LSB */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_set_min_srate</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">srate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sym</span><span class="p">;</span>

	<span class="n">srate</span> <span class="o">=</span> <span class="mi">95</span> <span class="o">*</span> <span class="p">(</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&gt;</span> <span class="mi">60000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span> <span class="cm">/* SR * 2^16 / master_clk */</span>
		<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&gt;</span> <span class="mi">6000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRLOW1</span><span class="p">,</span> <span class="p">((</span><span class="n">sym</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* MSB */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRLOW0</span><span class="p">,</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* LSB */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv090x_car_width</span><span class="p">(</span><span class="n">u32</span> <span class="n">srate</span><span class="p">,</span> <span class="k">enum</span> <span class="n">stv090x_rolloff</span> <span class="n">rolloff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ro</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rolloff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_RO_20</span>:
		<span class="n">ro</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV090x_RO_25</span>:
		<span class="n">ro</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV090x_RO_35</span>:
	<span class="nl">default:</span>
		<span class="n">ro</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">srate</span> <span class="o">+</span> <span class="p">(</span><span class="n">srate</span> <span class="o">*</span> <span class="n">ro</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_set_vit_thacq</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VTH12</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VTH23</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VTH34</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VTH56</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VTH67</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VTH78</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_set_vit_thtracq</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VTH12</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VTH23</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VTH34</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VTH56</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VTH67</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VTH78</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_set_viterbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_SEARCH_AUTO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FECM</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* DVB-S and DVB-S2 */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PRVIT</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* all puncture rate */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV090x_SEARCH_DVBS1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FECM</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* disable DSS */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STV090x_PR12</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PRVIT</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STV090x_PR23</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PRVIT</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STV090x_PR34</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PRVIT</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STV090x_PR56</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PRVIT</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STV090x_PR78</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PRVIT</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PRVIT</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* all */</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV090x_SEARCH_DSS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FECM</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STV090x_PR12</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PRVIT</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STV090x_PR23</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PRVIT</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STV090x_PR67</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PRVIT</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PRVIT</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* 1/2, 2/3, 6/7 */</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_stop_modcod</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST2</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST3</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST4</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST5</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST6</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST7</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST8</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST9</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTA</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTB</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTC</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTD</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTE</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTF</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_activate_modcod</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST1</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST2</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST3</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST4</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST5</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST6</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST7</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST8</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST9</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTA</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTB</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTC</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTD</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTE</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTF</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_activate_modcod_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST1</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST6</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST9</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTA</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTF</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_vitclk_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_DEMODULATOR_0</span>:
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK2</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKVIT1_FIELD</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK2</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_DEMODULATOR_1</span>:
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK2</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKVIT2_FIELD</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK2</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Wrong demodulator!&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_dvbs_track_crl</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set ACLC BCLC optimised value vs SR */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&gt;=</span> <span class="mi">15000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">BCLC</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&gt;=</span> <span class="mi">7000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">15000000</span> <span class="o">&gt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">BCLC</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">7000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">BCLC</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Cut 2.0 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">BCLC</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_delivery_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_SEARCH_DVBS1</span>:
	<span class="k">case</span> <span class="n">STV090x_SEARCH_DSS</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS1_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS2_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* Activate Viterbi decoder in legacy search,</span>
<span class="cm">		 * do not use FRESVIT1, might impact VITERBI2</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_vitclk_ctl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_dvbs_track_crl</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CAR2CFG</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* disable DVB-S2 */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_set_vit_thacq</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_set_viterbi</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_SEARCH_DVBS2</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS1_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS2_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS1_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS2_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_vitclk_ctl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* stop DVB-S CR loop */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">BCLC</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&lt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* enable S2 carrier loop */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CAR2CFG</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* &gt; Cut 3: Stop carrier 3 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CAR2CFG</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_mode</span> <span class="o">!=</span> <span class="n">STV090x_SINGLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Cut 2: enable link during search */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_activate_modcod</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Single demodulator</span>
<span class="cm">			 * Authorize SHORT and LONG frames,</span>
<span class="cm">			 * QPSK, 8PSK, 16APSK and 32APSK</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_activate_modcod_single</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_set_vit_thtracq</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_SEARCH_AUTO</span>:
	<span class="nl">default:</span>
		<span class="cm">/* enable DVB-S2 and DVB-S2 in Auto MODE */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS1_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS2_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS1_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS2_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_vitclk_ctl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_dvbs_track_crl</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&lt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* enable S2 carrier loop */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CAR2CFG</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* &gt; Cut 3: Stop carrier 3 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CAR2CFG</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_mode</span> <span class="o">!=</span> <span class="n">STV090x_SINGLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Cut 2: enable link during search */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_activate_modcod</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Single demodulator</span>
<span class="cm">			 * Authorize SHORT and LONG frames,</span>
<span class="cm">			 * QPSK, 8PSK, 16APSK and 32APSK</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_activate_modcod_single</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_set_vit_thacq</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_set_viterbi</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_start_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">freq_abs</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">freq</span><span class="p">;</span>

	<span class="cm">/* Reset demodulator */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">I2C_DEMOD_MODE_FIELD</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&lt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">5000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARCFG</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRUP1</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRUP0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRLOW1</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRLOW0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="cm">/*enlarge the timing bandwidth for Low SR*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">RTCS2</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* If the symbol rate is &gt;5 Msps</span>
<span class="cm">			Set The carrier search up and low to auto mode */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARCFG</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="cm">/*reduce the timing bandwidth for high SR*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">RTCS2</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* &gt;= Cut 3 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">5000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* enlarge the timing bandwidth for Low SR */</span>
			<span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">RTCS2</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* reduce timing bandwidth for high SR */</span>
			<span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">RTCS2</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Set CFR min and max to manual mode */</span>
		<span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARCFG</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">==</span> <span class="n">STV090x_WARM_SEARCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* WARM Start</span>
<span class="cm">			 * CFR min = -1MHz,</span>
<span class="cm">			 * CFR max = +1MHz</span>
<span class="cm">			 */</span>
			<span class="n">freq_abs</span>  <span class="o">=</span> <span class="mi">1000</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">freq_abs</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="n">freq</span>      <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="n">freq_abs</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* COLD Start</span>
<span class="cm">			 * CFR min =- (SearchRange / 2 + 600KHz)</span>
<span class="cm">			 * CFR max = +(SearchRange / 2 + 600KHz)</span>
<span class="cm">			 * (600KHz for the tuner step size)</span>
<span class="cm">			 */</span>
			<span class="n">freq_abs</span>  <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">600</span><span class="p">;</span>
			<span class="n">freq_abs</span>  <span class="o">=</span> <span class="n">freq_abs</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">freq_abs</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="n">freq</span>      <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="n">freq_abs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRUP1</span><span class="p">,</span> <span class="n">MSB</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRUP0</span><span class="p">,</span> <span class="n">LSB</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">freq</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRLOW1</span><span class="p">,</span> <span class="n">MSB</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRLOW0</span><span class="p">,</span> <span class="n">LSB</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQUALCFG</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FFECFG</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_mode</span> <span class="o">==</span> <span class="n">STV090x_SEARCH_DVBS1</span><span class="p">)</span>	<span class="o">||</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_mode</span> <span class="o">==</span> <span class="n">STV090x_SEARCH_DSS</span><span class="p">)</span>	<span class="o">||</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_mode</span> <span class="o">==</span> <span class="n">STV090x_SEARCH_AUTO</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VITSCALE</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VAVSRVIT</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRSTEP</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGTHRISE</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGTHFALL</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">SCAN_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">CFR_AUTOSCAN_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFG2</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">S1S2_SEQUENTIAL_FIELD</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFG2</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">RTC</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*Frequency offset detector setting*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&lt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Cut 2 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Cut 3 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARHDR</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARHDR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARHDR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_WARM_SEARCH</span>:
		<span class="cm">/* The symbol rate and the exact</span>
<span class="cm">		 * carrier Frequency are known</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_COLD_SEARCH</span>:
		<span class="cm">/* The symbol rate is known */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_get_agc2_min_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">agc2_min</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">agc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">freq_init</span><span class="p">,</span> <span class="n">freq_step</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">dir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2REF</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">SCAN_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">CFR_AUTOSCAN_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRUP1</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* SR = 65 Msps Max */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRUP0</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRLOW1</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* SR= 400 ksps Min */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRLOW0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDTOM</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* stop acq @ coarse carrier state */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_set_srate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">steps</span>  <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">steps</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">steps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">freq_step</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">*</span> <span class="mi">256</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">freq_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">steps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">freq_init</span> <span class="o">=</span> <span class="n">freq_init</span> <span class="o">+</span> <span class="p">(</span><span class="n">freq_step</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">freq_init</span> <span class="o">=</span> <span class="n">freq_init</span> <span class="o">-</span> <span class="p">(</span><span class="n">freq_step</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">dir</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* Demod RESET */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT1</span><span class="p">,</span> <span class="p">(</span><span class="n">freq_init</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT0</span><span class="p">,</span> <span class="n">freq_init</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* Demod RESET */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">agc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">agc2</span> <span class="o">+=</span> <span class="p">(</span><span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2I1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2I0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">agc2</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">agc2</span> <span class="o">&lt;</span> <span class="n">agc2_min</span><span class="p">)</span>
			<span class="n">agc2_min</span> <span class="o">=</span> <span class="n">agc2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">agc2_min</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv090x_get_srate</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">srate</span><span class="p">,</span> <span class="n">int_1</span><span class="p">,</span> <span class="n">int_2</span><span class="p">,</span> <span class="n">tmp_1</span><span class="p">,</span> <span class="n">tmp_2</span><span class="p">;</span>

	<span class="n">r3</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFR3</span><span class="p">);</span>
	<span class="n">r2</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFR2</span><span class="p">);</span>
	<span class="n">r1</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFR1</span><span class="p">);</span>
	<span class="n">r0</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFR0</span><span class="p">);</span>

	<span class="n">srate</span> <span class="o">=</span> <span class="p">((</span><span class="n">r3</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">r2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">r1</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">r0</span><span class="p">);</span>

	<span class="n">int_1</span> <span class="o">=</span> <span class="n">clk</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">int_2</span> <span class="o">=</span> <span class="n">srate</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">tmp_1</span> <span class="o">=</span> <span class="n">clk</span> <span class="o">%</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">tmp_2</span> <span class="o">=</span> <span class="n">srate</span> <span class="o">%</span> <span class="mh">0x10000</span><span class="p">;</span>

	<span class="n">srate</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_1</span> <span class="o">*</span> <span class="n">int_2</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">int_1</span> <span class="o">*</span> <span class="n">tmp_2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">int_2</span> <span class="o">*</span> <span class="n">tmp_1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">srate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv090x_srate_srch_coarse</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">tmg_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">tmg_cpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">cur_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">srate_coarse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">agc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">car_step</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">agc2th</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span>
		<span class="n">agc2th</span> <span class="o">=</span> <span class="mh">0x2e00</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">agc2th</span> <span class="o">=</span> <span class="mh">0x1f00</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">I2C_DEMOD_MODE_FIELD</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span> <span class="cm">/* Demod RESET */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGCFG</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGCFG2</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGTHRISE</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGTHFALL</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">SCAN_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">CFR_AUTOSCAN_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRUP1</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRUP0</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRLOW1</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRLOW0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDTOM</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2REF</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRSTEP</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRSTEP</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">2000000</span><span class="p">)</span>
		<span class="n">car_step</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">5000000</span><span class="p">)</span>
		<span class="n">car_step</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">12000000</span><span class="p">)</span>
		<span class="n">car_step</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">car_step</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>

	<span class="n">steps</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">car_step</span><span class="p">);</span>
	<span class="n">steps</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">steps</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">steps</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">steps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">steps</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">car_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cur_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">tmg_lock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur_step</span> <span class="o">&lt;</span> <span class="n">steps</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* Demod RESET */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRINIT1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRINIT0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="cm">/* trigger acquisition */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DSTATUS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TMGLOCK_QUALITY_FIELD</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">tmg_cpt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">agc2</span> <span class="o">+=</span> <span class="p">(</span><span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2I1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2I0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">agc2</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">srate_coarse</span> <span class="o">=</span> <span class="n">stv090x_get_srate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>
		<span class="n">cur_step</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmg_cpt</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">agc2</span> <span class="o">&lt;</span> <span class="n">agc2th</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srate_coarse</span> <span class="o">&lt;</span> <span class="mi">50000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">srate_coarse</span> <span class="o">&gt;</span> <span class="mi">850000</span><span class="p">))</span>
			<span class="n">tmg_lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur_step</span> <span class="o">&lt;</span> <span class="n">steps</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">freq</span> <span class="o">+=</span> <span class="n">cur_step</span> <span class="o">*</span> <span class="n">car_step</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">freq</span> <span class="o">-=</span> <span class="n">cur_step</span> <span class="o">*</span> <span class="n">car_step</span><span class="p">;</span>

			<span class="cm">/* Setup tuner */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_frequency</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_frequency</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bandwidth</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_bw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_status</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_status</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Tuner phase locked&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Tuner unlocked&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmg_lock</span><span class="p">)</span>
		<span class="n">srate_coarse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">srate_coarse</span> <span class="o">=</span> <span class="n">stv090x_get_srate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">srate_coarse</span><span class="p">;</span>

<span class="nl">err_gateoff:</span>
	<span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv090x_srate_srch_fine</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">srate_coarse</span><span class="p">,</span> <span class="n">freq_coarse</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">srate_coarse</span> <span class="o">=</span> <span class="n">stv090x_get_srate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>
	<span class="n">freq_coarse</span>  <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFR2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">freq_coarse</span> <span class="o">|=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFR1</span><span class="p">);</span>
	<span class="n">sym</span> <span class="o">=</span> <span class="mi">13</span> <span class="o">*</span> <span class="p">(</span><span class="n">srate_coarse</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span> <span class="cm">/* SFRUP = SFR + 30% */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&lt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">)</span>
		<span class="n">srate_coarse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* Demod RESET */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGCFG2</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGTHRISE</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGTHFALL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGCFG</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">CFR_AUTOSCAN_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2REF</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">srate_coarse</span> <span class="o">&gt;</span> <span class="mi">3000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sym</span>  <span class="o">=</span> <span class="mi">13</span> <span class="o">*</span> <span class="p">(</span><span class="n">srate_coarse</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span> <span class="cm">/* SFRUP = SFR + 30% */</span>
			<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">sym</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65536</span><span class="p">;</span>
			<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRUP1</span><span class="p">,</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRUP0</span><span class="p">,</span> <span class="n">sym</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">sym</span>  <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="n">srate_coarse</span> <span class="o">/</span> <span class="mi">13</span><span class="p">);</span> <span class="cm">/* SFRLOW = SFR - 30% */</span>
			<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">sym</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65536</span><span class="p">;</span>
			<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRLOW1</span><span class="p">,</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRLOW0</span><span class="p">,</span> <span class="n">sym</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">srate_coarse</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65536</span><span class="p">;</span>
			<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRINIT1</span><span class="p">,</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRINIT0</span><span class="p">,</span> <span class="n">sym</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sym</span>  <span class="o">=</span> <span class="mi">13</span> <span class="o">*</span> <span class="p">(</span><span class="n">srate_coarse</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span> <span class="cm">/* SFRUP = SFR + 30% */</span>
			<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">sym</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65536</span><span class="p">;</span>
			<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRUP1</span><span class="p">,</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRUP0</span><span class="p">,</span> <span class="n">sym</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">sym</span>  <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="n">srate_coarse</span> <span class="o">/</span> <span class="mi">14</span><span class="p">);</span> <span class="cm">/* SFRLOW = SFR - 30% */</span>
			<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">sym</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65536</span><span class="p">;</span>
			<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRLOW1</span><span class="p">,</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRLOW0</span><span class="p">,</span> <span class="n">sym</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">sym</span>  <span class="o">=</span> <span class="p">(</span><span class="n">srate_coarse</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65536</span><span class="p">;</span>
			<span class="n">sym</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRINIT1</span><span class="p">,</span> <span class="p">(</span><span class="n">sym</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRINIT0</span><span class="p">,</span> <span class="n">sym</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDTOM</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT1</span><span class="p">,</span> <span class="p">(</span><span class="n">freq_coarse</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT0</span><span class="p">,</span> <span class="n">freq_coarse</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* trigger acquisition */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">srate_coarse</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_get_dmdlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">s32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">timer</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDSTATE</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">HEADER_MODE_FIELD</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* searching */</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* first PLH detected */</span>
		<span class="nl">default:</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Demodulator searching ..&quot;</span><span class="p">);</span>
			<span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* DVB-S2 mode */</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* DVB-S1/legacy mode */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DSTATUS</span><span class="p">);</span>
			<span class="n">lock</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LOCK_DEFINITIF_FIELD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Demodulator acquired LOCK&quot;</span><span class="p">);</span>

		<span class="n">timer</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_blind_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">agc2</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">srate_coarse</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">cpt_fail</span><span class="p">,</span> <span class="n">agc2_ovflw</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">k_ref</span><span class="p">,</span> <span class="n">k_max</span><span class="p">,</span> <span class="n">k_min</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">coarse_fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lock</span><span class="p">;</span>

	<span class="n">k_max</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
	<span class="n">k_min</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">agc2</span> <span class="o">=</span> <span class="n">stv090x_get_agc2_min_level</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agc2</span> <span class="o">&gt;</span> <span class="n">STV090x_SEARCH_AGC2_TH</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&lt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARCFG</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* &gt; Cut 3 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARCFG</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">RTCS2</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQUALCFG</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FFECFG</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VITSCALE</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VAVSRVIT</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* set viterbi hysteresis */</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">k_ref</span> <span class="o">=</span> <span class="n">k_max</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">KREFTMG</span><span class="p">,</span> <span class="n">k_ref</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_srate_srch_coarse</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">srate_coarse</span> <span class="o">=</span> <span class="n">stv090x_srate_srch_fine</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">srate_coarse</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">stv090x_get_lock_tmg</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
					<span class="n">lock</span> <span class="o">=</span> <span class="n">stv090x_get_dmdlock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
							<span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cpt_fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">agc2_ovflw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">agc2</span> <span class="o">+=</span> <span class="p">(</span><span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2I1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
						<span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2I0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">agc2</span> <span class="o">&gt;=</span> <span class="mh">0xff00</span><span class="p">)</span>
						<span class="n">agc2_ovflw</span><span class="o">++</span><span class="p">;</span>
					<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DSTATUS2</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">CFR_OVERFLOW_FIELD</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					    <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DEMOD_DELOCK_FIELD</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">))</span>

						<span class="n">cpt_fail</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">cpt_fail</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">agc2_ovflw</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span>
					<span class="n">coarse_fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">k_ref</span> <span class="o">-=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">k_ref</span> <span class="o">&gt;=</span> <span class="n">k_min</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">coarse_fail</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">lock</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_chk_tmg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">tmg_cpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">freq</span><span class="p">,</span> <span class="n">tmg_thh</span><span class="p">,</span> <span class="n">tmg_thl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmg_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">);</span>
	<span class="n">tmg_thh</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGTHRISE</span><span class="p">);</span>
	<span class="n">tmg_thl</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGTHFALL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGTHRISE</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGTHFALL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">CFR_AUTOSCAN_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* stop carrier offset search */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">RTC</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">RTCS2</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* set car ofset to 0 */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2REF</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* trigger acquisition */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DSTATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TMGLOCK_QUALITY_FIELD</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">tmg_cpt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmg_cpt</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">tmg_lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2REF</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">RTC</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* DVB-S1 timing */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">RTCS2</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* DVB-S2 timing */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGTHRISE</span><span class="p">,</span> <span class="n">tmg_thh</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGTHFALL</span><span class="p">,</span> <span class="n">tmg_thl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span>	<span class="n">tmg_lock</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_get_coldlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">s32</span> <span class="n">timeout_dmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">car_step</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">cur_step</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">timeout_lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&gt;=</span> <span class="mi">10000000</span><span class="p">)</span>
		<span class="n">timeout_lock</span> <span class="o">=</span> <span class="n">timeout_dmd</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">timeout_lock</span> <span class="o">=</span> <span class="n">timeout_dmd</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">lock</span> <span class="o">=</span> <span class="n">stv090x_get_dmdlock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">timeout_lock</span><span class="p">);</span> <span class="cm">/* cold start wait */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&gt;=</span> <span class="mi">10000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_chk_tmg</span><span class="p">(</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">lock</span> <span class="o">=</span> <span class="n">stv090x_get_dmdlock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">timeout_dmd</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">4000000</span><span class="p">)</span>
				<span class="n">car_step</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
				<span class="n">car_step</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">10000000</span><span class="p">)</span>
				<span class="n">car_step</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">car_step</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>

			<span class="n">steps</span>  <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">car_step</span><span class="p">;</span>
			<span class="n">steps</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">steps</span>  <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">steps</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">steps</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span>
				<span class="n">steps</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

			<span class="n">cur_step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">freq</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_bw</span> <span class="o">=</span> <span class="n">stv090x_car_width</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">)</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">cur_step</span> <span class="o">&lt;=</span> <span class="n">steps</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">freq</span> <span class="o">+=</span> <span class="n">cur_step</span> <span class="o">*</span> <span class="n">car_step</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">freq</span> <span class="o">-=</span> <span class="n">cur_step</span> <span class="o">*</span> <span class="n">car_step</span><span class="p">;</span>

					<span class="cm">/* Setup tuner */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_frequency</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_frequency</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
							<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bandwidth</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_bw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
							<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

					<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_status</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_status</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
							<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span>
						<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Tuner phase locked&quot;</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Tuner unlocked&quot;</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

					<span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
					<span class="n">lock</span> <span class="o">=</span> <span class="n">stv090x_get_dmdlock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">timeout_dmd</span> <span class="o">/</span> <span class="mi">3</span><span class="p">));</span>

					<span class="n">dir</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="n">cur_step</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">lock</span><span class="p">;</span>

<span class="nl">err_gateoff:</span>
	<span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_get_loop_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">freq_inc</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">timeout_sw</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">steps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">steps_max</span><span class="p">,</span> <span class="n">srate</span><span class="p">,</span> <span class="n">car_max</span><span class="p">;</span>

	<span class="n">srate</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">;</span>
	<span class="n">car_max</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">car_max</span> <span class="o">+=</span> <span class="n">car_max</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">car_max</span>  <span class="o">=</span> <span class="mi">65536</span> <span class="o">*</span> <span class="p">(</span><span class="n">car_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">car_max</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">car_max</span> <span class="o">&gt;</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="n">car_max</span> <span class="o">=</span> <span class="mh">0x4000</span> <span class="p">;</span> <span class="cm">/* maxcarrier should be&lt;= +-1/4 Mclk */</span>

	<span class="n">inc</span>  <span class="o">=</span> <span class="n">srate</span><span class="p">;</span>
	<span class="n">inc</span> <span class="o">/=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">inc</span> <span class="o">*=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">inc</span> <span class="o">*=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">inc</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_SEARCH_DVBS1</span>:
	<span class="k">case</span> <span class="n">STV090x_SEARCH_DSS</span>:
		<span class="n">inc</span> <span class="o">*=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* freq step = 3% of srate */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_SEARCH_DVBS2</span>:
		<span class="n">inc</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_SEARCH_AUTO</span>:
	<span class="nl">default:</span>
		<span class="n">inc</span> <span class="o">*=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">inc</span> <span class="o">/=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inc</span> <span class="o">&gt;</span> <span class="n">car_max</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">inc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">inc</span> <span class="o">=</span> <span class="n">car_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* increment &lt;= 1/8 Mclk */</span>

	<span class="n">timeout</span> <span class="o">*=</span> <span class="mi">27500</span><span class="p">;</span> <span class="cm">/* 27.5 Msps reference */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">/=</span> <span class="p">(</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">steps_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">car_max</span> <span class="o">/</span> <span class="n">inc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* min steps = 3 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">steps_max</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">steps_max</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">steps_max</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="cm">/* max steps &lt;= 100 */</span>
		<span class="n">inc</span> <span class="o">=</span> <span class="n">car_max</span> <span class="o">/</span> <span class="n">steps_max</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">freq_inc</span> <span class="o">=</span> <span class="n">inc</span><span class="p">;</span>
	<span class="o">*</span><span class="n">timeout_sw</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="o">*</span><span class="n">steps</span> <span class="o">=</span> <span class="n">steps_max</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_chk_signal</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">offst_car</span><span class="p">,</span> <span class="n">agc2</span><span class="p">,</span> <span class="n">car_max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">no_signal</span><span class="p">;</span>

	<span class="n">offst_car</span>  <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFR2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">offst_car</span> <span class="o">|=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFR1</span><span class="p">);</span>
	<span class="n">offst_car</span> <span class="o">=</span> <span class="n">comp2</span><span class="p">(</span><span class="n">offst_car</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">agc2</span>  <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2I1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">agc2</span> <span class="o">|=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2I0</span><span class="p">);</span>
	<span class="n">car_max</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">car_max</span> <span class="o">+=</span> <span class="p">(</span><span class="n">car_max</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span> <span class="cm">/* 10% margin */</span>
	<span class="n">car_max</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">65536</span> <span class="o">*</span> <span class="n">car_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">car_max</span> <span class="o">/=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">car_max</span> <span class="o">&gt;</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="n">car_max</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">agc2</span> <span class="o">&gt;</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">offst_car</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">car_max</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">offst_car</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">car_max</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">no_signal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;No Signal&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">no_signal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Found Signal&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">no_signal</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_search_car_loop</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">s32</span> <span class="n">inc</span><span class="p">,</span> <span class="n">s32</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">zigzag</span><span class="p">,</span> <span class="n">s32</span> <span class="n">steps_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">no_signal</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">cpt_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offst_freq</span><span class="p">,</span> <span class="n">car_max</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">car_max</span>  <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">car_max</span> <span class="o">+=</span> <span class="p">(</span><span class="n">car_max</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">car_max</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">65536</span> <span class="o">*</span> <span class="n">car_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">car_max</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">car_max</span> <span class="o">&gt;</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="n">car_max</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zigzag</span><span class="p">)</span>
		<span class="n">offst_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">offst_freq</span> <span class="o">=</span> <span class="o">-</span><span class="n">car_max</span> <span class="o">+</span> <span class="n">inc</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT1</span><span class="p">,</span> <span class="p">((</span><span class="n">offst_freq</span> <span class="o">/</span> <span class="mi">256</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT0</span><span class="p">,</span> <span class="n">offst_freq</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PDELCTRL1</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ALGOSWRST_FIELD</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span> <span class="cm">/* stop DVB-S2 packet delin */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PDELCTRL1</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">zigzag</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offst_freq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">offst_freq</span> <span class="o">=</span> <span class="o">-</span><span class="n">offst_freq</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">inc</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">offst_freq</span> <span class="o">=</span> <span class="o">-</span><span class="n">offst_freq</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">offst_freq</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">inc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cpt_step</span><span class="o">++</span><span class="p">;</span>

		<span class="n">lock</span> <span class="o">=</span> <span class="n">stv090x_get_dmdlock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="n">no_signal</span> <span class="o">=</span> <span class="n">stv090x_chk_signal</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="o">!</span><span class="n">no_signal</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">((</span><span class="n">offst_freq</span> <span class="o">-</span> <span class="n">inc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">car_max</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">((</span><span class="n">offst_freq</span> <span class="o">+</span> <span class="n">inc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">car_max</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="n">cpt_step</span> <span class="o">&lt;</span> <span class="n">steps_max</span><span class="p">));</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PDELCTRL1</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ALGOSWRST_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PDELCTRL1</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">lock</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_sw_algo</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">no_signal</span><span class="p">,</span> <span class="n">zigzag</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">s32</span> <span class="n">dvbs2_fly_wheel</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">inc</span><span class="p">,</span> <span class="n">timeout_step</span><span class="p">,</span> <span class="n">trials</span><span class="p">,</span> <span class="n">steps_max</span><span class="p">;</span>

	<span class="cm">/* get params */</span>
	<span class="n">stv090x_get_loop_params</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout_step</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">steps_max</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_SEARCH_DVBS1</span>:
	<span class="k">case</span> <span class="n">STV090x_SEARCH_DSS</span>:
		<span class="cm">/* accelerate the frequency detector */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">zigzag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_SEARCH_DVBS2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CORRELABS</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">zigzag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_SEARCH_AUTO</span>:
	<span class="nl">default:</span>
		<span class="cm">/* accelerate the frequency detector */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CORRELABS</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">zigzag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trials</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">stv090x_search_car_loop</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">timeout_step</span><span class="p">,</span> <span class="n">zigzag</span><span class="p">,</span> <span class="n">steps_max</span><span class="p">);</span>
		<span class="n">no_signal</span> <span class="o">=</span> <span class="n">stv090x_chk_signal</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">trials</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/*run the SW search 2 times maximum*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">||</span> <span class="n">no_signal</span> <span class="o">||</span> <span class="p">(</span><span class="n">trials</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*Check if the demod is not losing lock in DVBS2*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CORRELABS</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDSTATE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">lock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">HEADER_MODE_FIELD</span><span class="p">)</span> <span class="o">==</span> <span class="n">STV090x_DVBS2</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*Check if the demod is not losing lock in DVBS2*/</span>
				<span class="n">msleep</span><span class="p">(</span><span class="n">timeout_step</span><span class="p">);</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDFLYW</span><span class="p">);</span>
				<span class="n">dvbs2_fly_wheel</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FLYWHEEL_CPT_FIELD</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dvbs2_fly_wheel</span> <span class="o">&lt;</span> <span class="mh">0xd</span><span class="p">)</span> <span class="p">{</span>	 <span class="cm">/*if correct frames is decrementing */</span>
					<span class="n">msleep</span><span class="p">(</span><span class="n">timeout_step</span><span class="p">);</span>
					<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDFLYW</span><span class="p">);</span>
					<span class="n">dvbs2_fly_wheel</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FLYWHEEL_CPT_FIELD</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dvbs2_fly_wheel</span> <span class="o">&lt;</span> <span class="mh">0xd</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*FALSE lock, The demod is losing lock */</span>
					<span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">trials</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CORRELABS</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
								<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
						<span class="p">}</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
							<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">trials</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">no_signal</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">lock</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">stv090x_delsys</span> <span class="nf">stv090x_get_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">stv090x_delsys</span> <span class="n">delsys</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDSTATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">HEADER_MODE_FIELD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">delsys</span> <span class="o">=</span> <span class="n">STV090x_DVBS2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">HEADER_MODE_FIELD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FECM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DSS_DVB_FIELD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">delsys</span> <span class="o">=</span> <span class="n">STV090x_DSS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">delsys</span> <span class="o">=</span> <span class="n">STV090x_DVBS1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">delsys</span> <span class="o">=</span> <span class="n">STV090x_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">delsys</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* in Hz */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">stv090x_get_car_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mclk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">derot</span><span class="p">,</span> <span class="n">int_1</span><span class="p">,</span> <span class="n">int_2</span><span class="p">,</span> <span class="n">tmp_1</span><span class="p">,</span> <span class="n">tmp_2</span><span class="p">;</span>

	<span class="n">derot</span>  <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFR2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">derot</span> <span class="o">|=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">;</span>
	<span class="n">derot</span> <span class="o">|=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFR0</span><span class="p">);</span>

	<span class="n">derot</span> <span class="o">=</span> <span class="n">comp2</span><span class="p">(</span><span class="n">derot</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">int_1</span> <span class="o">=</span> <span class="n">mclk</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">int_2</span> <span class="o">=</span> <span class="n">derot</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>

	<span class="cm">/* carrier_frequency = MasterClock * Reg / 2^24 */</span>
	<span class="n">tmp_1</span> <span class="o">=</span> <span class="n">mclk</span> <span class="o">%</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="n">tmp_2</span> <span class="o">=</span> <span class="n">derot</span> <span class="o">%</span> <span class="mh">0x1000</span><span class="p">;</span>

	<span class="n">derot</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_1</span> <span class="o">*</span> <span class="n">int_2</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">int_1</span> <span class="o">*</span> <span class="n">tmp_2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">int_2</span> <span class="o">*</span> <span class="n">tmp_1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">derot</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_get_viterbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VITCURPUN</span><span class="p">);</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">VIT_CURPUN_FIELD</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">13</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fec</span> <span class="o">=</span> <span class="n">STV090x_PR12</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">18</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fec</span> <span class="o">=</span> <span class="n">STV090x_PR23</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">21</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fec</span> <span class="o">=</span> <span class="n">STV090x_PR34</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fec</span> <span class="o">=</span> <span class="n">STV090x_PR56</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">25</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fec</span> <span class="o">=</span> <span class="n">STV090x_PR67</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">26</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fec</span> <span class="o">=</span> <span class="n">STV090x_PR78</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fec</span> <span class="o">=</span> <span class="n">STV090x_PRERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">stv090x_signal_state</span> <span class="nf">stv090x_get_sig_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">tmg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offst_freq</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">==</span> <span class="n">STV090x_BLIND_SEARCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGREG2</span><span class="p">);</span>
		<span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRSTEP</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmg</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGREG2</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span> <span class="o">=</span> <span class="n">stv090x_get_std</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_frequency</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_frequency</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">offst_freq</span> <span class="o">=</span> <span class="n">stv090x_get_car_freq</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+=</span> <span class="n">offst_freq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_get_viterbi</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDMODCOD</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">modcod</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DEMOD_MODCOD_FIELD</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">pilots</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DEMOD_TYPE_FIELD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frame_len</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DEMOD_TYPE_FIELD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGOBS</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">rolloff</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ROLLOFF_STATUS_FIELD</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FECM</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">IQINV_FIELD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">==</span> <span class="n">STV090x_BLIND_SEARCH</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_frequency</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_frequency</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">offst_freq</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">500</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">STV090x_RANGEOK</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">offst_freq</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">stv090x_car_width</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">STV090x_RANGEOK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">STV090x_OUTOFRANGE</span><span class="p">;</span> <span class="cm">/* Out of Range */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">offst_freq</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">500</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">STV090x_RANGEOK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">STV090x_OUTOFRANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STV090x_OUTOFRANGE</span><span class="p">;</span>

<span class="nl">err_gateoff:</span>
	<span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv090x_get_tmgoffst</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">srate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">offst_tmg</span><span class="p">;</span>

	<span class="n">offst_tmg</span>  <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGREG2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">offst_tmg</span> <span class="o">|=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGREG1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">;</span>
	<span class="n">offst_tmg</span> <span class="o">|=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGREG0</span><span class="p">);</span>

	<span class="n">offst_tmg</span> <span class="o">=</span> <span class="n">comp2</span><span class="p">(</span><span class="n">offst_tmg</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span> <span class="cm">/* 2&#39;s complement */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">offst_tmg</span><span class="p">)</span>
		<span class="n">offst_tmg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">offst_tmg</span>  <span class="o">=</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span> <span class="n">srate</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span> <span class="mh">0x1000000</span> <span class="o">/</span> <span class="n">offst_tmg</span><span class="p">);</span>
	<span class="n">offst_tmg</span> <span class="o">/=</span> <span class="mi">320</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">offst_tmg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">stv090x_optimize_carloop</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">stv090x_modcod</span> <span class="n">modcod</span><span class="p">,</span> <span class="n">s32</span> <span class="n">pilots</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">aclc</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv090x_long_frame_crloop</span> <span class="o">*</span><span class="n">car_loop</span><span class="p">,</span> <span class="o">*</span><span class="n">car_loop_qpsk_low</span><span class="p">,</span> <span class="o">*</span><span class="n">car_loop_apsk_low</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">car_loop</span>		<span class="o">=</span> <span class="n">stv090x_s2_crl_cut20</span><span class="p">;</span>
		<span class="n">car_loop_qpsk_low</span>	<span class="o">=</span> <span class="n">stv090x_s2_lowqpsk_crl_cut20</span><span class="p">;</span>
		<span class="n">car_loop_apsk_low</span>	<span class="o">=</span> <span class="n">stv090x_s2_apsk_crl_cut20</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* &gt;= Cut 3 */</span>
		<span class="n">car_loop</span>		<span class="o">=</span> <span class="n">stv090x_s2_crl_cut30</span><span class="p">;</span>
		<span class="n">car_loop_qpsk_low</span>	<span class="o">=</span> <span class="n">stv090x_s2_lowqpsk_crl_cut30</span><span class="p">;</span>
		<span class="n">car_loop_apsk_low</span>	<span class="o">=</span> <span class="n">stv090x_s2_apsk_crl_cut30</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modcod</span> <span class="o">&lt;</span> <span class="n">STV090x_QPSK_12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">modcod</span> <span class="o">!=</span> <span class="n">car_loop_qpsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modcod</span><span class="p">))</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">modcod</span> <span class="o">!=</span> <span class="n">car_loop</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modcod</span><span class="p">))</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">modcod</span> <span class="o">!=</span> <span class="n">car_loop_apsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modcod</span><span class="p">))</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modcod</span> <span class="o">&lt;=</span> <span class="n">STV090x_QPSK_25</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pilots</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_qpsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_qpsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_5</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_qpsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_10</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_qpsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_20</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_qpsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_30</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_qpsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_off_2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_qpsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_off_5</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_qpsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_off_10</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_qpsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_off_20</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_qpsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_off_30</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">modcod</span> <span class="o">&lt;=</span> <span class="n">STV090x_8PSK_910</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pilots</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_5</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_10</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_20</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_30</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_off_2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_off_5</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_off_10</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_off_20</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_off_30</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* 16APSK and 32APSK */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
			<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_apsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
			<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_apsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_5</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
			<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_apsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
			<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_apsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_20</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">aclc</span> <span class="o">=</span> <span class="n">car_loop_apsk_low</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crl_pilots_on_30</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">aclc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">stv090x_optimize_carloop_short</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_short_frame_crloop</span> <span class="o">*</span><span class="n">short_crl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">aclc</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_QPSK</span>:
	<span class="nl">default:</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV090x_8PSK</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV090x_16APSK</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV090x_32APSK</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Cut 3.0 and up */</span>
		<span class="n">short_crl</span> <span class="o">=</span> <span class="n">stv090x_s2_short_crl_cut30</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Cut 2.0 and up: we don&#39;t support cuts older than 2.0 */</span>
		<span class="n">short_crl</span> <span class="o">=</span> <span class="n">stv090x_s2_short_crl_cut20</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
		<span class="n">aclc</span> <span class="o">=</span> <span class="n">short_crl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">crl_2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
		<span class="n">aclc</span> <span class="o">=</span> <span class="n">short_crl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">crl_5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
		<span class="n">aclc</span> <span class="o">=</span> <span class="n">short_crl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">crl_10</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
		<span class="n">aclc</span> <span class="o">=</span> <span class="n">short_crl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">crl_20</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">aclc</span> <span class="o">=</span> <span class="n">short_crl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">crl_30</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">aclc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_optimize_track</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">stv090x_modcod</span> <span class="n">modcod</span><span class="p">;</span>

	<span class="n">s32</span> <span class="n">srate</span><span class="p">,</span> <span class="n">pilots</span><span class="p">,</span> <span class="n">aclc</span><span class="p">,</span> <span class="n">f_1</span><span class="p">,</span> <span class="n">f_0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blind_tune</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">srate</span>  <span class="o">=</span> <span class="n">stv090x_get_srate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>
	<span class="n">srate</span> <span class="o">+=</span> <span class="n">stv090x_get_tmgoffst</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">srate</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_DVBS1</span>:
	<span class="k">case</span> <span class="n">STV090x_DSS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_mode</span> <span class="o">==</span> <span class="n">STV090x_SEARCH_AUTO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">);</span>
			<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS1_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS2_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOD</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ROLLOFF_CONTROL_FIELD</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">MANUAL_SXROLLOFF_FIELD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_get_viterbi</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fec</span> <span class="o">==</span> <span class="n">STV090x_PR12</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">GAUSSR0</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CCIR0</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">GAUSSR0</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CCIR0</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ERRCTRL1</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_DVBS2</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS1_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS2_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">BCLC</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frame_len</span> <span class="o">==</span> <span class="n">STV090x_LONG_FRAME</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDMODCOD</span><span class="p">);</span>
			<span class="n">modcod</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DEMOD_MODCOD_FIELD</span><span class="p">);</span>
			<span class="n">pilots</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DEMOD_TYPE_FIELD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">aclc</span> <span class="o">=</span> <span class="n">stv090x_optimize_carloop</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">modcod</span><span class="p">,</span> <span class="n">pilots</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">modcod</span> <span class="o">&lt;=</span> <span class="n">STV090x_QPSK_910</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S2Q</span><span class="p">,</span> <span class="n">aclc</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">modcod</span> <span class="o">&lt;=</span> <span class="n">STV090x_8PSK_910</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S2Q</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S28</span><span class="p">,</span> <span class="n">aclc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_mode</span> <span class="o">==</span> <span class="n">STV090x_SINGLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">modcod</span> <span class="o">&gt;</span> <span class="n">STV090x_8PSK_910</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">modcod</span> <span class="o">&lt;=</span> <span class="n">STV090x_16APSK_910</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S2Q</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S216A</span><span class="p">,</span> <span class="n">aclc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S2Q</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S232A</span><span class="p">,</span> <span class="n">aclc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*Carrier loop setting for short frame*/</span>
			<span class="n">aclc</span> <span class="o">=</span> <span class="n">stv090x_optimize_carloop_short</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">STV090x_QPSK</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S2Q</span><span class="p">,</span> <span class="n">aclc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">STV090x_8PSK</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S2Q</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S28</span><span class="p">,</span> <span class="n">aclc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">STV090x_16APSK</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S2Q</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S216A</span><span class="p">,</span> <span class="n">aclc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">STV090x_32APSK</span><span class="p">)</span>  <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S2Q</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ACLC2S232A</span><span class="p">,</span> <span class="n">aclc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ERRCTRL1</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">);</span> <span class="cm">/* PER */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_ERROR</span>:
	<span class="nl">default:</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS1_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DVBS2_ENABLE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">f_1</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFR2</span><span class="p">);</span>
	<span class="n">f_0</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFR1</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGOBS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">==</span> <span class="n">STV090x_BLIND_SEARCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRSTEP</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">SCAN_ENABLE_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">CFR_AUTOSCAN_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDCFGMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGCFG2</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_set_srate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">srate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">blind_tune</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_dvbs_track_crl</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_mode</span> <span class="o">==</span> <span class="n">STV090x_SEARCH_DVBS1</span><span class="p">)</span>	<span class="o">||</span>
		    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_mode</span> <span class="o">==</span> <span class="n">STV090x_SEARCH_DSS</span><span class="p">)</span>		<span class="o">||</span>
		    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">search_mode</span> <span class="o">==</span> <span class="n">STV090x_SEARCH_AUTO</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VAVSRVIT</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VITSCALE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2REF</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* AUTO tracking MODE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRUP1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* AUTO tracking MODE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SFRLOW1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">blind_tune</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* update initial carrier freq with the found freq offset */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT1</span><span class="p">,</span> <span class="n">f_1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT0</span><span class="p">,</span> <span class="n">f_0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_bw</span> <span class="o">=</span> <span class="n">stv090x_car_width</span><span class="p">(</span><span class="n">srate</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10000000</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">blind_tune</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">!=</span> <span class="n">STV090x_WARM_SEARCH</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bandwidth</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_bw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">==</span> <span class="n">STV090x_BLIND_SEARCH</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="p">))</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span> <span class="cm">/* blind search: wait 50ms for SR stabilization */</span>
		<span class="k">else</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">stv090x_get_lock_tmg</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stv090x_get_dmdlock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT1</span><span class="p">,</span> <span class="n">f_1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT0</span><span class="p">,</span> <span class="n">f_0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">stv090x_get_dmdlock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT1</span><span class="p">,</span> <span class="n">f_1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CFRINIT0</span><span class="p">,</span> <span class="n">f_0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span> <span class="o">==</span> <span class="n">STV090x_DVBS1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span> <span class="o">==</span> <span class="n">STV090x_DSS</span><span class="p">))</span>
		<span class="n">stv090x_set_vit_thtracq</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_gateoff:</span>
	<span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_get_feclock</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">s32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">timer</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDSTATE</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">HEADER_MODE_FIELD</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* searching */</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* first PLH detected */</span>
		<span class="nl">default:</span>
			<span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* DVB-S2 mode */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PDELSTATUS1</span><span class="p">);</span>
			<span class="n">lock</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">PKTDELIN_LOCK_FIELD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* DVB-S1/legacy mode */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VSTATUSVIT</span><span class="p">);</span>
			<span class="n">lock</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LOCKEDVIT_FIELD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">timer</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_get_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">s32</span> <span class="n">timeout_dmd</span><span class="p">,</span> <span class="n">s32</span> <span class="n">timeout_fec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lock</span><span class="p">;</span>

	<span class="n">lock</span> <span class="o">=</span> <span class="n">stv090x_get_dmdlock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">timeout_dmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">stv090x_get_feclock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">timeout_fec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">timer</span> <span class="o">&lt;</span> <span class="n">timeout_fec</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TSSTATUS</span><span class="p">);</span>
			<span class="n">lock</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_LINEOK_FIELD</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">timer</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_set_s2rolloff</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&lt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* rolloff to auto mode if DVBS2 */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOD</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">MANUAL_SXROLLOFF_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* DVB-S2 rolloff to auto mode if DVBS2 */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOD</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">MANUAL_S2ROLLOFF_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">enum</span> <span class="n">stv090x_signal_state</span> <span class="nf">stv090x_algo</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">stv090x_signal_state</span> <span class="n">signal_state</span> <span class="o">=</span> <span class="n">STV090x_NOCARRIER</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">agc1_power</span><span class="p">,</span> <span class="n">power_iq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">low_sr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">no_signal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TSCFGH</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RST_HWARE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Stop path 1 stream merger */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* Demod stop */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&gt;</span> <span class="mi">5000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CORRELABS</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CORRELABS</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">stv090x_get_lock_tmg</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">==</span> <span class="n">STV090x_BLIND_SEARCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_bw</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">36000000</span><span class="p">;</span> <span class="cm">/* wide bw for unknown srate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGCFG2</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* wider srate scan */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CORRELMANT</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_set_srate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* initial srate = 1Msps */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* known srate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDTOM</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGCFG</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* SR &lt; 2MSPS */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CORRELMANT</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* SR &gt;= 2Msps */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CORRELMANT</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGC2REF</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">KREFTMG</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">==</span> <span class="n">STV090x_COLD_SEARCH</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_bw</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="p">(</span><span class="n">stv090x_car_width</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10000000</span><span class="p">))</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">==</span> <span class="n">STV090x_WARM_SEARCH</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_bw</span> <span class="o">=</span> <span class="n">stv090x_car_width</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10000000</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* if cold start or warm  (Symbolrate is known)</span>
<span class="cm">		 * use a Narrow symbol rate scan range</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TMGCFG2</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* narrow srate scan */</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_set_srate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_set_max_srate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">,</span>
					  <span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_set_min_srate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">,</span>
					  <span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&gt;=</span> <span class="mi">10000000</span><span class="p">)</span>
			<span class="n">low_sr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">low_sr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup tuner */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bbgain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_bbgain</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* default: 10dB */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bbgain</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_frequency</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_frequency</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bandwidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_bw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_status</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Tuner phase locked&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Tuner unlocked&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">STV090x_NOCARRIER</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">agc1_power</span> <span class="o">=</span> <span class="n">MAKEWORD16</span><span class="p">(</span><span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGCIQIN1</span><span class="p">),</span>
				<span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGCIQIN0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agc1_power</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If AGC1 integrator value is 0</span>
<span class="cm">		 * then read POWERI, POWERQ</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">power_iq</span> <span class="o">+=</span> <span class="p">(</span><span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">POWERI</span><span class="p">)</span> <span class="o">+</span>
				     <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">POWERQ</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">power_iq</span> <span class="o">/=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">agc1_power</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">power_iq</span> <span class="o">&lt;</span> <span class="n">STV090x_IQPOWER_THRESHOLD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;No Signal: POWER_IQ=0x%02x&quot;</span><span class="p">,</span> <span class="n">power_iq</span><span class="p">);</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">signal_state</span> <span class="o">=</span> <span class="n">STV090x_NOAGC1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOD</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">SPECINV_CONTROL_FIELD</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&lt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* rolloff to auto mode if DVBS2 */</span>
			<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">MANUAL_SXROLLOFF_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* DVB-S2 rolloff to auto mode if DVBS2 */</span>
			<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">MANUAL_S2ROLLOFF_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_delivery_search</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">!=</span> <span class="n">STV090x_BLIND_SEARCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_start_search</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_state</span> <span class="o">==</span> <span class="n">STV090x_NOAGC1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">signal_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">==</span> <span class="n">STV090x_BLIND_SEARCH</span><span class="p">)</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">stv090x_blind_search</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">==</span> <span class="n">STV090x_COLD_SEARCH</span><span class="p">)</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">stv090x_get_coldlock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span><span class="p">);</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">==</span> <span class="n">STV090x_WARM_SEARCH</span><span class="p">)</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">stv090x_get_dmdlock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">DemodTimeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">==</span> <span class="n">STV090x_COLD_SEARCH</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">low_sr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_chk_tmg</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
				<span class="n">lock</span> <span class="o">=</span> <span class="n">stv090x_sw_algo</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">signal_state</span> <span class="o">=</span> <span class="n">stv090x_get_sig_params</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">signal_state</span> <span class="o">==</span> <span class="n">STV090x_RANGEOK</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* signal within Range */</span>
		<span class="n">stv090x_optimize_track</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* &gt;= Cut 2.0 :release TS reset after</span>
<span class="cm">			 * demod lock and optimized Tracking</span>
<span class="cm">			 */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TSCFGH</span><span class="p">);</span>
			<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RST_HWARE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* release merger reset */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

			<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RST_HWARE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* merger reset */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RST_HWARE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* release merger reset */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">lock</span> <span class="o">=</span> <span class="n">stv090x_get_lock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">FecTimeout</span><span class="p">,</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">FecTimeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span> <span class="o">==</span> <span class="n">STV090x_DVBS2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stv090x_set_s2rolloff</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

				<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PDELCTRL2</span><span class="p">);</span>
				<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RESET_UPKO_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PDELCTRL2</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="cm">/* Reset DVBS2 packet delinator error counter */</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PDELCTRL2</span><span class="p">);</span>
				<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RESET_UPKO_COUNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PDELCTRL2</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ERRCTRL1</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* PER */</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ERRCTRL1</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Reset the Total packet counter */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FBERCPT4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="cm">/* Reset the packet Error counter2 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ERRCTRL2</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">signal_state</span> <span class="o">=</span> <span class="n">STV090x_NODATA</span><span class="p">;</span>
			<span class="n">no_signal</span> <span class="o">=</span> <span class="n">stv090x_chk_signal</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">signal_state</span><span class="p">;</span>

<span class="nl">err_gateoff:</span>
	<span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">dvbfe_search</span> <span class="nf">stv090x_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">props</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">props</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DVBFE_ALGO_SEARCH_INVALID</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span> <span class="o">=</span> <span class="n">props</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">props</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">=</span> <span class="n">props</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">search_mode</span> <span class="o">=</span> <span class="n">STV090x_SEARCH_AUTO</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">=</span> <span class="n">STV090x_COLD_SEARCH</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">fec</span> <span class="o">=</span> <span class="n">STV090x_PRERR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&gt;</span> <span class="mi">10000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Search range: 10 MHz&quot;</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Search range: 5 MHz&quot;</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">=</span> <span class="mi">5000000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_algo</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">STV090x_RANGEOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Search success!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">DVBFE_ALGO_SEARCH_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Search failed!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">DVBFE_ALGO_SEARCH_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">DVBFE_ALGO_SEARCH_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fe_status</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">dstatus</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">search_state</span><span class="p">;</span>

	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dstatus</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DSTATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">dstatus</span><span class="p">,</span> <span class="n">CAR_LOCK_FIELD</span><span class="p">))</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_SIGNAL</span> <span class="o">|</span> <span class="n">FE_HAS_CARRIER</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DMDSTATE</span><span class="p">);</span>
	<span class="n">search_state</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">HEADER_MODE_FIELD</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">search_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* searching */</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* first PLH detected */</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Status: Unlocked (Searching ..)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* DVB-S2 mode */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Delivery system: DVB-S2&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">dstatus</span><span class="p">,</span> <span class="n">LOCK_DEFINITIF_FIELD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PDELSTATUS1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">PKTDELIN_LOCK_FIELD</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TSSTATUS</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_LINEOK_FIELD</span><span class="p">))</span>
					<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_SYNC</span> <span class="o">|</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* DVB-S1/legacy mode */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Delivery system: DVB-S&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">dstatus</span><span class="p">,</span> <span class="n">LOCK_DEFINITIF_FIELD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">VSTATUSVIT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LOCKEDVIT_FIELD</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TSSTATUS</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_LINEOK_FIELD</span><span class="p">))</span>
					<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_SYNC</span> <span class="o">|</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_read_per</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">per</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">s32</span> <span class="n">count_4</span><span class="p">,</span> <span class="n">count_3</span><span class="p">,</span> <span class="n">count_2</span><span class="p">,</span> <span class="n">count_1</span><span class="p">,</span> <span class="n">count_0</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">stv090x_read_status</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">per</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">;</span> <span class="cm">/* Max PER */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Counter 2 */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ERRCNT22</span><span class="p">);</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ERR_CNT2_FIELD</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ERRCNT21</span><span class="p">);</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ERR_CNT21_FIELD</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ERRCNT20</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ERR_CNT20_FIELD</span><span class="p">);</span>

		<span class="o">*</span><span class="n">per</span> <span class="o">=</span> <span class="p">((</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">l</span><span class="p">);</span>

		<span class="n">count_4</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FBERCPT4</span><span class="p">);</span>
		<span class="n">count_3</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FBERCPT3</span><span class="p">);</span>
		<span class="n">count_2</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FBERCPT2</span><span class="p">);</span>
		<span class="n">count_1</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FBERCPT1</span><span class="p">);</span>
		<span class="n">count_0</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FBERCPT0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">count_4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">count_3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">count</span>  <span class="o">=</span> <span class="p">(</span><span class="n">count_2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">|=</span> <span class="p">(</span><span class="n">count_1</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">|=</span>  <span class="n">count_0</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">per</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FBERCPT4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ERRCTRL2</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_table_lookup</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">stv090x_tab</span> <span class="o">*</span><span class="n">tab</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">med</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">read</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">read</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">tab</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">read</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">read</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">max</span> <span class="o">-</span> <span class="n">min</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">med</span> <span class="o">=</span> <span class="p">(</span><span class="n">max</span> <span class="o">+</span> <span class="n">min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">read</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="p">[</span><span class="n">med</span><span class="p">].</span><span class="n">read</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">tab</span><span class="p">[</span><span class="n">med</span><span class="p">].</span><span class="n">read</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">read</span><span class="p">))</span>
				<span class="n">max</span> <span class="o">=</span> <span class="n">med</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">min</span> <span class="o">=</span> <span class="n">med</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">-</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">read</span><span class="p">)</span> <span class="o">*</span>
		       <span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">real</span> <span class="o">-</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">real</span><span class="p">)</span> <span class="o">/</span>
		       <span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">read</span> <span class="o">-</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">read</span><span class="p">))</span> <span class="o">+</span>
			<span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">real</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">read</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">read</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">real</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">tab</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">read</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">real</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">read</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">real</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">read</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">real</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">agc_0</span><span class="p">,</span> <span class="n">agc_1</span><span class="p">,</span> <span class="n">agc</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">str</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGCIQIN1</span><span class="p">);</span>
	<span class="n">agc_1</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">AGCIQ_VALUE_FIELD</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AGCIQIN0</span><span class="p">);</span>
	<span class="n">agc_0</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">AGCIQ_VALUE_FIELD</span><span class="p">);</span>
	<span class="n">agc</span> <span class="o">=</span> <span class="n">MAKEWORD16</span><span class="p">(</span><span class="n">agc_1</span><span class="p">,</span> <span class="n">agc_0</span><span class="p">);</span>

	<span class="n">str</span> <span class="o">=</span> <span class="n">stv090x_table_lookup</span><span class="p">(</span><span class="n">stv090x_rf_tab</span><span class="p">,</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stv090x_rf_tab</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">agc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agc</span> <span class="o">&gt;</span> <span class="n">stv090x_rf_tab</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">read</span><span class="p">)</span>
		<span class="n">str</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">agc</span> <span class="o">&lt;</span> <span class="n">stv090x_rf_tab</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stv090x_rf_tab</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">read</span><span class="p">)</span>
		<span class="n">str</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">;</span>
	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0xFFFF</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_read_cnr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">cnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_0</span><span class="p">,</span> <span class="n">reg_1</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">val_0</span><span class="p">,</span> <span class="n">val_1</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lock_f</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_DVBS2</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DSTATUS</span><span class="p">);</span>
		<span class="n">lock_f</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LOCK_DEFINITIF_FIELD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_f</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reg_1</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">NNOSPLHT1</span><span class="p">);</span>
				<span class="n">val_1</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg_1</span><span class="p">,</span> <span class="n">NOSPLHT_NORMED_FIELD</span><span class="p">);</span>
				<span class="n">reg_0</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">NNOSPLHT0</span><span class="p">);</span>
				<span class="n">val_0</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg_0</span><span class="p">,</span> <span class="n">NOSPLHT_NORMED_FIELD</span><span class="p">);</span>
				<span class="n">val</span>  <span class="o">+=</span> <span class="n">MAKEWORD16</span><span class="p">(</span><span class="n">val_1</span><span class="p">,</span> <span class="n">val_0</span><span class="p">);</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">val</span> <span class="o">/=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">last</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stv090x_s2cn_tab</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">div</span> <span class="o">=</span> <span class="n">stv090x_s2cn_tab</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">read</span> <span class="o">-</span>
			      <span class="n">stv090x_s2cn_tab</span><span class="p">[</span><span class="n">last</span><span class="p">].</span><span class="n">read</span><span class="p">;</span>
			<span class="o">*</span><span class="n">cnr</span> <span class="o">=</span> <span class="mh">0xFFFF</span> <span class="o">-</span> <span class="p">((</span><span class="n">val</span> <span class="o">*</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">/</span> <span class="n">div</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_DVBS1</span>:
	<span class="k">case</span> <span class="n">STV090x_DSS</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DSTATUS</span><span class="p">);</span>
		<span class="n">lock_f</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LOCK_DEFINITIF_FIELD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_f</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reg_1</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">NOSDATAT1</span><span class="p">);</span>
				<span class="n">val_1</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg_1</span><span class="p">,</span> <span class="n">NOSDATAT_UNNORMED_FIELD</span><span class="p">);</span>
				<span class="n">reg_0</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">NOSDATAT0</span><span class="p">);</span>
				<span class="n">val_0</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg_0</span><span class="p">,</span> <span class="n">NOSDATAT_UNNORMED_FIELD</span><span class="p">);</span>
				<span class="n">val</span>  <span class="o">+=</span> <span class="n">MAKEWORD16</span><span class="p">(</span><span class="n">val_1</span><span class="p">,</span> <span class="n">val_0</span><span class="p">);</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">val</span> <span class="o">/=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">last</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stv090x_s1cn_tab</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">div</span> <span class="o">=</span> <span class="n">stv090x_s1cn_tab</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">read</span> <span class="o">-</span>
			      <span class="n">stv090x_s1cn_tab</span><span class="p">[</span><span class="n">last</span><span class="p">].</span><span class="n">read</span><span class="p">;</span>
			<span class="o">*</span><span class="n">cnr</span> <span class="o">=</span> <span class="mh">0xFFFF</span> <span class="o">-</span> <span class="p">((</span><span class="n">val</span> <span class="o">*</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">/</span> <span class="n">div</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_set_tone</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_tone_mode_t</span> <span class="n">tone</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tone</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_TONE_ON</span>:
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISTX_MODE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISEQC_RESET_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISEQC_RESET_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SEC_TONE_OFF</span>:
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISTX_MODE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISEQC_RESET_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">enum</span> <span class="n">dvbfe_algo</span> <span class="nf">stv090x_frontend_algo</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">DVBFE_ALGO_CUSTOM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_send_diseqc_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_diseqc_master_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fifo_full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">);</span>

	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISTX_MODE_FIELD</span><span class="p">,</span>
		<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">diseqc_envelope_mode</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISEQC_RESET_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISEQC_RESET_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DIS_PRECHARGE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">fifo_full</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXSTATUS</span><span class="p">);</span>
			<span class="n">fifo_full</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FIFO_FULL_FIELD</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXDATA</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DIS_PRECHARGE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">idle</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXSTATUS</span><span class="p">);</span>
		<span class="n">idle</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_IDLE_FIELD</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_send_diseqc_burst</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_mini_cmd_t</span> <span class="n">burst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fifo_full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">burst</span> <span class="o">==</span> <span class="n">SEC_MINI_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">diseqc_envelope_mode</span><span class="p">)</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">diseqc_envelope_mode</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISTX_MODE_FIELD</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISEQC_RESET_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISEQC_RESET_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DIS_PRECHARGE_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">fifo_full</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXSTATUS</span><span class="p">);</span>
		<span class="n">fifo_full</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FIFO_FULL_FIELD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXDATA</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DIS_PRECHARGE_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">idle</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISTXSTATUS</span><span class="p">);</span>
		<span class="n">idle</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_IDLE_FIELD</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_recv_slave_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_diseqc_slave_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rx_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">rx_end</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISRX_ST0</span><span class="p">);</span>
		<span class="n">rx_end</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_END_FIELD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reply</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FIFO_BYTENBR_FIELD</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">reply</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DISRXDATA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">full_standby</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_sleep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_sleep</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Set %s(%d) to sleep&quot;</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">STV0900</span> <span class="o">?</span> <span class="s">&quot;STV0900&quot;</span> <span class="o">:</span> <span class="s">&quot;STV0903&quot;</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_DEMODULATOR_0</span>:
		<span class="cm">/* power off ADC 1 */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR1</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ADC1_PON_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR1</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="cm">/* power off DiSEqC 1 */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR2</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISEQC1_PON_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR2</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* check whether path 2 is already sleeping, that is when</span>
<span class="cm">		   ADC2 is off */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ADC2_PON_FIELD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">full_standby</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* stop clocks */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK1</span><span class="p">);</span>
		<span class="cm">/* packet delineator 1 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKPKDT1_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* ADC 1 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKADCI1_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* FEC clock is shared between the two paths, only stop it</span>
<span class="cm">		   when full standby is possible */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">full_standby</span><span class="p">)</span>
			<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKFEC_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK1</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK2</span><span class="p">);</span>
		<span class="cm">/* sampling 1 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKSAMP1_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* viterbi 1 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKVIT1_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* TS clock is shared between the two paths, only stop it</span>
<span class="cm">		   when full standby is possible */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">full_standby</span><span class="p">)</span>
			<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKTS_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK2</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_DEMODULATOR_1</span>:
		<span class="cm">/* power off ADC 2 */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR3</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ADC2_PON_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR3</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="cm">/* power off DiSEqC 2 */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR4</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISEQC2_PON_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR4</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* check whether path 1 is already sleeping, that is when</span>
<span class="cm">		   ADC1 is off */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_GETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ADC1_PON_FIELD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">full_standby</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* stop clocks */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK1</span><span class="p">);</span>
		<span class="cm">/* packet delineator 2 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKPKDT2_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* ADC 2 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKADCI2_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* FEC clock is shared between the two paths, only stop it</span>
<span class="cm">		   when full standby is possible */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">full_standby</span><span class="p">)</span>
			<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKFEC_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK1</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK2</span><span class="p">);</span>
		<span class="cm">/* sampling 2 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKSAMP2_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* viterbi 2 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKVIT2_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* TS clock is shared between the two paths, only stop it</span>
<span class="cm">		   when full standby is possible */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">full_standby</span><span class="p">)</span>
			<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKTS_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK2</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Wrong demodulator!&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">full_standby</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* general power off */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_SYNTCTRL</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STANDBY_FIELD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_SYNTCTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_gateoff:</span>
	<span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Wake %s(%d) from standby&quot;</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">STV0900</span> <span class="o">?</span> <span class="s">&quot;STV0900&quot;</span> <span class="o">:</span> <span class="s">&quot;STV0903&quot;</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>

	<span class="cm">/* general power on */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_SYNTCTRL</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STANDBY_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_SYNTCTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_DEMODULATOR_0</span>:
		<span class="cm">/* power on ADC 1 */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR1</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ADC1_PON_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR1</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="cm">/* power on DiSEqC 1 */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR2</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISEQC1_PON_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR2</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* activate clocks */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK1</span><span class="p">);</span>
		<span class="cm">/* packet delineator 1 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKPKDT1_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* ADC 1 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKADCI1_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* FEC clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKFEC_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK1</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK2</span><span class="p">);</span>
		<span class="cm">/* sampling 1 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKSAMP1_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* viterbi 1 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKVIT1_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* TS clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKTS_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK2</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_DEMODULATOR_1</span>:
		<span class="cm">/* power on ADC 2 */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR3</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ADC2_PON_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR3</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="cm">/* power on DiSEqC 2 */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR4</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DISEQC2_PON_FIELD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR4</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* activate clocks */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK1</span><span class="p">);</span>
		<span class="cm">/* packet delineator 2 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKPKDT2_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* ADC 2 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKADCI2_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* FEC clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKFEC_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK1</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK2</span><span class="p">);</span>
		<span class="cm">/* sampling 2 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKSAMP2_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* viterbi 2 clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKVIT2_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* TS clock */</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">STOP_CLKTS_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_STOPCLK2</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Wrong demodulator!&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv090x_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">num_used</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">num_used</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Actually removing&quot;</span><span class="p">);</span>

		<span class="n">remove_dev</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_ldpc_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">stv090x_mode</span> <span class="n">ldpc_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_GENCFG</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ldpc_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_DUAL</span>:
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_mode</span> <span class="o">!=</span> <span class="n">STV090x_DUAL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">STV090x_GETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">DDEMOD_FIELD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* set LDPC to dual mode */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_GENCFG</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_mode</span> <span class="o">=</span> <span class="n">STV090x_DUAL</span><span class="p">;</span>

			<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTRES0</span><span class="p">);</span>
			<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRESFEC_FIELD</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTRES0</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRESFEC_FIELD</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTRES0</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST2</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST3</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST4</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST5</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST6</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST7</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST8</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLST9</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTA</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTB</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTC</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTD</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTE</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MODCODLSTF</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_SINGLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_stop_modcod</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_activate_modcod_single</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span> <span class="o">==</span> <span class="n">STV090x_DEMODULATOR_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_GENCFG</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* path 2 */</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_GENCFG</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* path 1 */</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTRES0</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRESFEC_FIELD</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTRES0</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">FRESFEC_FIELD</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTRES0</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PDELCTRL1</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ALGOSWRST_FIELD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PDELCTRL1</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ALGOSWRST_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PDELCTRL1</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return (Hz), clk in Hz*/</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv090x_get_mclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stv090x_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ratio</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_NCOARSE</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_SYNTCTRL</span><span class="p">);</span>
	<span class="n">ratio</span> <span class="o">=</span> <span class="n">STV090x_GETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">SELX1RATIO_FIELD</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">div</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">xtal</span> <span class="o">/</span> <span class="n">ratio</span><span class="p">;</span> <span class="cm">/* kHz */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_set_mclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mclk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stv090x_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">clk_sel</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_SYNTCTRL</span><span class="p">);</span>
	<span class="n">clk_sel</span> <span class="o">=</span> <span class="p">((</span><span class="n">STV090x_GETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">SELX1RATIO_FIELD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">((</span><span class="n">clk_sel</span> <span class="o">*</span> <span class="n">mclk</span><span class="p">)</span> <span class="o">/</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">xtal</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_NCOARSE</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">M_DIV_FIELD</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_NCOARSE</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">stv090x_get_mclk</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/*Set the DiseqC frequency to 22KHz */</span>
	<span class="n">div</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">704000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F22TX</span><span class="p">,</span> <span class="n">div</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F22RX</span><span class="p">,</span> <span class="n">div</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_set_tspath</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts1_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STV090x_TSMODE_PARALLEL_PUNCTURED</span>:
		<span class="k">case</span> <span class="n">STV090x_TSMODE_DVBCI</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts2_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_PUNCTURED</span>:
			<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_CONTINUOUS</span>:
			<span class="nl">default:</span>
				<span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSGENERAL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">STV090x_TSMODE_PARALLEL_PUNCTURED</span>:
			<span class="k">case</span> <span class="n">STV090x_TSMODE_DVBCI</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSGENERAL</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* Mux&#39;d stream mode */</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGM</span><span class="p">);</span>
				<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_MANSPEED_FIELD</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGM</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGM</span><span class="p">);</span>
				<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_MANSPEED_FIELD</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGM</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSSPEED</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSSPEED</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_PUNCTURED</span>:
		<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_CONTINUOUS</span>:
		<span class="nl">default:</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts2_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_PUNCTURED</span>:
			<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_CONTINUOUS</span>:
			<span class="nl">default:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSGENERAL</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">STV090x_TSMODE_PARALLEL_PUNCTURED</span>:
			<span class="k">case</span> <span class="n">STV090x_TSMODE_DVBCI</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSGENERAL</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts1_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STV090x_TSMODE_PARALLEL_PUNCTURED</span>:
		<span class="k">case</span> <span class="n">STV090x_TSMODE_DVBCI</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts2_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_PUNCTURED</span>:
			<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_CONTINUOUS</span>:
			<span class="nl">default:</span>
				<span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSGENERAL1X</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">STV090x_TSMODE_PARALLEL_PUNCTURED</span>:
			<span class="k">case</span> <span class="n">STV090x_TSMODE_DVBCI</span>:
				<span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSGENERAL1X</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGM</span><span class="p">);</span>
				<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_MANSPEED_FIELD</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGM</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGM</span><span class="p">);</span>
				<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_MANSPEED_FIELD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGM</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSSPEED</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSSPEED</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_PUNCTURED</span>:
		<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_CONTINUOUS</span>:
		<span class="nl">default:</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts2_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_PUNCTURED</span>:
			<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_CONTINUOUS</span>:
			<span class="nl">default:</span>
				<span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSGENERAL1X</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">STV090x_TSMODE_PARALLEL_PUNCTURED</span>:
			<span class="k">case</span> <span class="n">STV090x_TSMODE_DVBCI</span>:
				<span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSGENERAL1X</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts1_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_TSMODE_PARALLEL_PUNCTURED</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGH</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_TEIUPDATE_FIELD</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts1_tei</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_SERIAL_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_DVBCI_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_TSMODE_DVBCI</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGH</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_TEIUPDATE_FIELD</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts1_tei</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_SERIAL_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_DVBCI_FIELD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_PUNCTURED</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGH</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_TEIUPDATE_FIELD</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts1_tei</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_SERIAL_FIELD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_DVBCI_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_CONTINUOUS</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGH</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_TEIUPDATE_FIELD</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts1_tei</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_SERIAL_FIELD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_DVBCI_FIELD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts2_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV090x_TSMODE_PARALLEL_PUNCTURED</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGH</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_TEIUPDATE_FIELD</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts2_tei</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_SERIAL_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_DVBCI_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_TSMODE_DVBCI</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGH</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_TEIUPDATE_FIELD</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts2_tei</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_SERIAL_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_DVBCI_FIELD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_PUNCTURED</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGH</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_TEIUPDATE_FIELD</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts2_tei</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_SERIAL_FIELD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_DVBCI_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_CONTINUOUS</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGH</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_TEIUPDATE_FIELD</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts2_tei</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_SERIAL_FIELD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_DVBCI_FIELD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts1_clk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">speed</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts1_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STV090x_TSMODE_PARALLEL_PUNCTURED</span>:
		<span class="k">case</span> <span class="n">STV090x_TSMODE_DVBCI</span>:
		<span class="nl">default:</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span>
				<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts1_clk</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mh">0x08</span><span class="p">)</span>
				<span class="n">speed</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mh">0xFF</span><span class="p">)</span>
				<span class="n">speed</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_PUNCTURED</span>:
		<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_CONTINUOUS</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span>
				<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts1_clk</span> <span class="o">/</span> <span class="mi">32</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">)</span>
				<span class="n">speed</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mh">0xFF</span><span class="p">)</span>
				<span class="n">speed</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGM</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_MANSPEED_FIELD</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGM</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSSPEED</span><span class="p">,</span> <span class="n">speed</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts2_clk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">speed</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts2_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STV090x_TSMODE_PARALLEL_PUNCTURED</span>:
		<span class="k">case</span> <span class="n">STV090x_TSMODE_DVBCI</span>:
		<span class="nl">default:</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span>
				<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts2_clk</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mh">0x08</span><span class="p">)</span>
				<span class="n">speed</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mh">0xFF</span><span class="p">)</span>
				<span class="n">speed</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_PUNCTURED</span>:
		<span class="k">case</span> <span class="n">STV090x_TSMODE_SERIAL_CONTINUOUS</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span>
				<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts2_clk</span> <span class="o">/</span> <span class="mi">32</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">)</span>
				<span class="n">speed</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mh">0xFF</span><span class="p">)</span>
				<span class="n">speed</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGM</span><span class="p">);</span>
		<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSFIFO_MANSPEED_FIELD</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGM</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSSPEED</span><span class="p">,</span> <span class="n">speed</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGH</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RST_HWARE_FIELD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RST_HWARE_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGH</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RST_HWARE_FIELD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RST_HWARE_FIELD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TSCFGH</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stv090x_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* call tuner init to configure the tuner&#39;s clock output</span>
<span class="cm">		   divider directly before setting up the master clock of</span>
<span class="cm">		   the stv090x. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_init</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_init</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">stv090x_set_mclk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">135000000</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">xtal</span><span class="p">);</span> <span class="cm">/* 135 Mhz */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_SYNTCTRL</span><span class="p">,</span>
				      <span class="mh">0x20</span> <span class="o">|</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">clk_mode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">stv090x_get_mclk</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_wakeup</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error waking device&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_ldpc_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_mode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TNRCFG2</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TUN_IQSWAP_FIELD</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TNRCFG2</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STV090x_READ_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOD</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ROLLOFF_CONTROL_FIELD</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STV090x_WRITE_DEMOD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_mode</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">TUNER_WAKE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_init</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_gateoff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_set_tspath</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_gateoff:</span>
	<span class="n">stv090x_i2c_gate_ctrl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv090x_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stv090x_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stv090x_reg</span> <span class="o">*</span><span class="n">stv090x_initval</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stv090x_reg</span> <span class="o">*</span><span class="n">stv090x_cut20_val</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t1_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">t2_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">STV0900</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Initializing STV0900&quot;</span><span class="p">);</span>
		<span class="n">stv090x_initval</span> <span class="o">=</span> <span class="n">stv0900_initval</span><span class="p">;</span>
		<span class="n">t1_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stv0900_initval</span><span class="p">);</span>
		<span class="n">stv090x_cut20_val</span> <span class="o">=</span> <span class="n">stv0900_cut20_val</span><span class="p">;</span>
		<span class="n">t2_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stv0900_cut20_val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">STV0903</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Initializing STV0903&quot;</span><span class="p">);</span>
		<span class="n">stv090x_initval</span> <span class="o">=</span> <span class="n">stv0903_initval</span><span class="p">;</span>
		<span class="n">t1_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stv0903_initval</span><span class="p">);</span>
		<span class="n">stv090x_cut20_val</span> <span class="o">=</span> <span class="n">stv0903_cut20_val</span><span class="p">;</span>
		<span class="n">t2_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stv0903_cut20_val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* STV090x init */</span>

	<span class="cm">/* Stop Demod */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_DMDISTATE</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_DMDISTATE</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Set No Tuner Mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_TNRCFG</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_TNRCFG</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* I2C repeater OFF */</span>
	<span class="n">STV090x_SETFIELD_Px</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ENARPT_LEVEL_FIELD</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">repeater_level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P1_I2CRPT</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_P2_I2CRPT</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_NCOARSE</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* set PLL divider */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_I2CCFG</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* 1/41 oversampling */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_SYNTCTRL</span><span class="p">,</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">clk_mode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* enable PLL */</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* write initval */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Setting up initial values&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">t1_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">stv090x_initval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">stv090x_initval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_MID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSGENERAL</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* write cut20_val*/</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Setting up Cut 2.0 initial values&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">t2_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">stv090x_cut20_val</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">stv090x_cut20_val</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ERROR: Unsupported Cut: 0x%02x!&quot;</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">&gt;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we shouldn&#39;t bail out from here */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;INFO: Cut: 0x%02x probably incomplete support!&quot;</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ADC1 range */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR1</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ADC1_INMODE_FIELD</span><span class="p">,</span>
		<span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">adc1_range</span> <span class="o">==</span> <span class="n">STV090x_ADC_1Vpp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR1</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* ADC2 range */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stv090x_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR3</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ADC2_INMODE_FIELD</span><span class="p">,</span>
		<span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">adc2_range</span> <span class="o">==</span> <span class="n">STV090x_ADC_1Vpp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTTNR3</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTRES0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_TSTRES0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I/O error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stv090x_set_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">gpio</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">xor_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIOx_OPD_FIELD</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIOx_CONFIG_FIELD</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">STV090x_SETFIELD</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIOx_XOR_FIELD</span><span class="p">,</span> <span class="n">xor_value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">stv090x_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STV090x_GPIOxCFG</span><span class="p">(</span><span class="n">gpio</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">stv090x_set_gpio</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">stv090x_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">SYS_DSS</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;STV090x Multistandard&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span>		<span class="o">=</span> <span class="mi">950000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span> 		<span class="o">=</span> <span class="mi">2150000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_tolerance</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">symbol_rate_min</span> 	<span class="o">=</span> <span class="mi">1000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">symbol_rate_max</span> 	<span class="o">=</span> <span class="mi">45000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">caps</span>			<span class="o">=</span> <span class="n">FE_CAN_INVERSION_AUTO</span> <span class="o">|</span>
					  <span class="n">FE_CAN_FEC_AUTO</span>       <span class="o">|</span>
					  <span class="n">FE_CAN_QPSK</span>           <span class="o">|</span>
					  <span class="n">FE_CAN_2G_MODULATION</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">release</span>			<span class="o">=</span> <span class="n">stv090x_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>				<span class="o">=</span> <span class="n">stv090x_init</span><span class="p">,</span>

	<span class="p">.</span><span class="n">sleep</span>				<span class="o">=</span> <span class="n">stv090x_sleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend_algo</span>		<span class="o">=</span> <span class="n">stv090x_frontend_algo</span><span class="p">,</span>

	<span class="p">.</span><span class="n">diseqc_send_master_cmd</span>		<span class="o">=</span> <span class="n">stv090x_send_diseqc_msg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">diseqc_send_burst</span>		<span class="o">=</span> <span class="n">stv090x_send_diseqc_burst</span><span class="p">,</span>
	<span class="p">.</span><span class="n">diseqc_recv_slave_reply</span>	<span class="o">=</span> <span class="n">stv090x_recv_slave_reply</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tone</span>			<span class="o">=</span> <span class="n">stv090x_set_tone</span><span class="p">,</span>

	<span class="p">.</span><span class="n">search</span>				<span class="o">=</span> <span class="n">stv090x_search</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>			<span class="o">=</span> <span class="n">stv090x_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span>			<span class="o">=</span> <span class="n">stv090x_read_per</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span>		<span class="o">=</span> <span class="n">stv090x_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span>			<span class="o">=</span> <span class="n">stv090x_read_cnr</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">stv090x_attach</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">stv090x_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">stv090x_demodulator</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv090x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv090x_dev</span> <span class="o">*</span><span class="n">temp_int</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span>				<span class="o">=</span> <span class="o">&amp;</span><span class="n">verbose</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span>				<span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span>				<span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span>			<span class="o">=</span> <span class="n">stv090x_ops</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">demodulator_priv</span>	<span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span>				<span class="o">=</span> <span class="n">demod</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_mode</span> 			<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_mode</span><span class="p">;</span> <span class="cm">/* Single or Dual mode */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">device</span>				<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">rolloff</span>				<span class="o">=</span> <span class="n">STV090x_RO_35</span><span class="p">;</span> <span class="cm">/* default */</span>

	<span class="n">temp_int</span> <span class="o">=</span> <span class="n">find_dev</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">temp_int</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_mode</span> <span class="o">==</span> <span class="n">STV090x_DUAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">=</span> <span class="n">temp_int</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">num_used</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_INFO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Found Internal Structure!&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv090x_internal</span><span class="p">),</span>
					  <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">temp_int</span> <span class="o">=</span> <span class="n">append_internal</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp_int</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">num_used</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">i2c_adap</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_INFO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Create New Internal Structure!&quot;</span><span class="p">);</span>

		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">tuner_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error setting up device&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_remove</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* workaround for stuck DiSEqC output */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">diseqc_envelope_mode</span><span class="p">)</span>
		<span class="n">stv090x_send_diseqc_burst</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="n">SEC_MINI_A</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Attaching %s demodulator(%d) Cut=0x%02x&quot;</span><span class="p">,</span>
	       <span class="n">state</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">STV0900</span> <span class="o">?</span> <span class="s">&quot;STV0900&quot;</span> <span class="o">:</span> <span class="s">&quot;STV0903&quot;</span><span class="p">,</span>
	       <span class="n">demod</span><span class="p">,</span>
	       <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dev_ver</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

<span class="nl">err_remove:</span>
	<span class="n">remove_dev</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">stv090x_attach</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="s">&quot;Set Verbosity level&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Manu Abraham&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;STV090x Multi-Std Broadcast frontend&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
