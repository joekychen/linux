<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › drxk_hard.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>drxk_hard.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drxk_hard: DRX-K DVB-C/T demodulator driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010-2011 Digital Devices GmbH</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 only, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA</span>
<span class="cm"> * Or, point your browser to http://www.gnu.org/copyleft/gpl.html</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>

<span class="cp">#include &quot;dvb_frontend.h&quot;</span>
<span class="cp">#include &quot;drxk.h&quot;</span>
<span class="cp">#include &quot;drxk_hard.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">PowerDownDVBT</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">bool</span> <span class="n">setPowerMode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">PowerDownQAM</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">SetDVBTStandard</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">OperationMode</span> <span class="n">oMode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">SetQAMStandard</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">OperationMode</span> <span class="n">oMode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">SetQAM</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">IntermediateFreqkHz</span><span class="p">,</span>
		  <span class="n">s32</span> <span class="n">tunerFreqOffset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">SetDVBTStandard</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">OperationMode</span> <span class="n">oMode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">DVBTStart</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">SetDVBT</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">IntermediateFreqkHz</span><span class="p">,</span>
		   <span class="n">s32</span> <span class="n">tunerFreqOffset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">GetQAMLockStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pLockStatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">GetDVBTLockStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pLockStatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">SwitchAntennaToQAM</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">SwitchAntennaToDVBT</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">IsDVBT</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">==</span> <span class="n">OM_DVBT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">IsQAM</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">==</span> <span class="n">OM_QAM_ITU_A</span> <span class="o">||</span>
	    <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">==</span> <span class="n">OM_QAM_ITU_B</span> <span class="o">||</span>
	    <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">==</span> <span class="n">OM_QAM_ITU_C</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">IsA1WithPatchCode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DRXK_A1_PATCH_CODE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">IsA1WithRomCode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DRXK_A1_ROM_CODE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NOA1ROM 0</span>

<span class="cp">#define DRXDAP_FASI_SHORT_FORMAT(addr) (((addr) &amp; 0xFC30FF80) == 0)</span>
<span class="cp">#define DRXDAP_FASI_LONG_FORMAT(addr)  (((addr) &amp; 0xFC30FF80) != 0)</span>

<span class="cp">#define DEFAULT_MER_83  165</span>
<span class="cp">#define DEFAULT_MER_93  250</span>

<span class="cp">#ifndef DRXK_MPEG_SERIAL_OUTPUT_PIN_DRIVE_STRENGTH</span>
<span class="cp">#define DRXK_MPEG_SERIAL_OUTPUT_PIN_DRIVE_STRENGTH (0x02)</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef DRXK_MPEG_PARALLEL_OUTPUT_PIN_DRIVE_STRENGTH</span>
<span class="cp">#define DRXK_MPEG_PARALLEL_OUTPUT_PIN_DRIVE_STRENGTH (0x03)</span>
<span class="cp">#endif</span>

<span class="cp">#define DEFAULT_DRXK_MPEG_LOCK_TIMEOUT 700</span>
<span class="cp">#define DEFAULT_DRXK_DEMOD_LOCK_TIMEOUT 500</span>

<span class="cp">#ifndef DRXK_KI_RAGC_ATV</span>
<span class="cp">#define DRXK_KI_RAGC_ATV   4</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef DRXK_KI_IAGC_ATV</span>
<span class="cp">#define DRXK_KI_IAGC_ATV   6</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef DRXK_KI_DAGC_ATV</span>
<span class="cp">#define DRXK_KI_DAGC_ATV   7</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef DRXK_KI_RAGC_QAM</span>
<span class="cp">#define DRXK_KI_RAGC_QAM   3</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef DRXK_KI_IAGC_QAM</span>
<span class="cp">#define DRXK_KI_IAGC_QAM   4</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef DRXK_KI_DAGC_QAM</span>
<span class="cp">#define DRXK_KI_DAGC_QAM   7</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef DRXK_KI_RAGC_DVBT</span>
<span class="cp">#define DRXK_KI_RAGC_DVBT  (IsA1WithPatchCode(state) ? 3 : 2)</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef DRXK_KI_IAGC_DVBT</span>
<span class="cp">#define DRXK_KI_IAGC_DVBT  (IsA1WithPatchCode(state) ? 4 : 2)</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef DRXK_KI_DAGC_DVBT</span>
<span class="cp">#define DRXK_KI_DAGC_DVBT  (IsA1WithPatchCode(state) ? 10 : 7)</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef DRXK_AGC_DAC_OFFSET</span>
<span class="cp">#define DRXK_AGC_DAC_OFFSET (0x800)</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef DRXK_BANDWIDTH_8MHZ_IN_HZ</span>
<span class="cp">#define DRXK_BANDWIDTH_8MHZ_IN_HZ  (0x8B8249L)</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef DRXK_BANDWIDTH_7MHZ_IN_HZ</span>
<span class="cp">#define DRXK_BANDWIDTH_7MHZ_IN_HZ  (0x7A1200L)</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef DRXK_BANDWIDTH_6MHZ_IN_HZ</span>
<span class="cp">#define DRXK_BANDWIDTH_6MHZ_IN_HZ  (0x68A1B6L)</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef DRXK_QAM_SYMBOLRATE_MAX</span>
<span class="cp">#define DRXK_QAM_SYMBOLRATE_MAX         (7233000)</span>
<span class="cp">#endif</span>

<span class="cp">#define DRXK_BL_ROM_OFFSET_TAPS_DVBT    56</span>
<span class="cp">#define DRXK_BL_ROM_OFFSET_TAPS_ITU_A   64</span>
<span class="cp">#define DRXK_BL_ROM_OFFSET_TAPS_ITU_C   0x5FE0</span>
<span class="cp">#define DRXK_BL_ROM_OFFSET_TAPS_BG      24</span>
<span class="cp">#define DRXK_BL_ROM_OFFSET_TAPS_DKILLP  32</span>
<span class="cp">#define DRXK_BL_ROM_OFFSET_TAPS_NTSC    40</span>
<span class="cp">#define DRXK_BL_ROM_OFFSET_TAPS_FM      48</span>
<span class="cp">#define DRXK_BL_ROM_OFFSET_UCODE        0</span>

<span class="cp">#define DRXK_BLC_TIMEOUT                100</span>

<span class="cp">#define DRXK_BLCC_NR_ELEMENTS_TAPS      2</span>
<span class="cp">#define DRXK_BLCC_NR_ELEMENTS_UCODE     6</span>

<span class="cp">#define DRXK_BLDC_NR_ELEMENTS_TAPS      28</span>

<span class="cp">#ifndef DRXK_OFDM_NE_NOTCH_WIDTH</span>
<span class="cp">#define DRXK_OFDM_NE_NOTCH_WIDTH             (4)</span>
<span class="cp">#endif</span>

<span class="cp">#define DRXK_QAM_SL_SIG_POWER_QAM16       (40960)</span>
<span class="cp">#define DRXK_QAM_SL_SIG_POWER_QAM32       (20480)</span>
<span class="cp">#define DRXK_QAM_SL_SIG_POWER_QAM64       (43008)</span>
<span class="cp">#define DRXK_QAM_SL_SIG_POWER_QAM128      (20992)</span>
<span class="cp">#define DRXK_QAM_SL_SIG_POWER_QAM256      (43520)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;enable debug messages&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(level, fmt, arg...) do {			\</span>
<span class="cp">if (debug &gt;= level)						\</span>
<span class="cp">	printk(KERN_DEBUG &quot;drxk: %s&quot; fmt, __func__, ## arg);	\</span>
<span class="cp">} while (0)</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">MulDiv32</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">,</span> <span class="n">u32</span> <span class="n">b</span><span class="p">,</span> <span class="n">u32</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tmp64</span><span class="p">;</span>

	<span class="n">tmp64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">b</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">tmp64</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">tmp64</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">u32</span> <span class="nf">Frac28a</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">,</span> <span class="n">u32</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">Q1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">R0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">R0</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* 32-28 == 4 shifts possible at max */</span>
	<span class="n">Q1</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">c</span><span class="p">;</span>		<span class="cm">/* integer part, only the 4 least significant bits</span>
<span class="cm">				   will be visible in the result */</span>

	<span class="cm">/* division using radix 16, 7 nibbles in the result */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Q1</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">R0</span> <span class="o">/</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">R0</span> <span class="o">=</span> <span class="p">(</span><span class="n">R0</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* rounding */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">R0</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="p">)</span>
		<span class="n">Q1</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">Q1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">Log10Times100</span><span class="p">(</span><span class="n">u32</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">scale</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">indexWidth</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   log2lut[n] = (1&lt;&lt;scale) * 200 * log2(1.0 + ((1.0/(1&lt;&lt;INDEXWIDTH)) * n))</span>
<span class="cm">	   0 &lt;= n &lt; ((1&lt;&lt;INDEXWIDTH)+1)</span>
<span class="cm">	 */</span>

	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">log2lut</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span>		<span class="cm">/* 0.000000 */</span>
		<span class="mi">290941</span><span class="p">,</span>		<span class="cm">/* 290941.300628 */</span>
		<span class="mi">573196</span><span class="p">,</span>		<span class="cm">/* 573196.476418 */</span>
		<span class="mi">847269</span><span class="p">,</span>		<span class="cm">/* 847269.179851 */</span>
		<span class="mi">1113620</span><span class="p">,</span>	<span class="cm">/* 1113620.489452 */</span>
		<span class="mi">1372674</span><span class="p">,</span>	<span class="cm">/* 1372673.576986 */</span>
		<span class="mi">1624818</span><span class="p">,</span>	<span class="cm">/* 1624817.752104 */</span>
		<span class="mi">1870412</span><span class="p">,</span>	<span class="cm">/* 1870411.981536 */</span>
		<span class="mi">2109788</span><span class="p">,</span>	<span class="cm">/* 2109787.962654 */</span>
		<span class="mi">2343253</span><span class="p">,</span>	<span class="cm">/* 2343252.817465 */</span>
		<span class="mi">2571091</span><span class="p">,</span>	<span class="cm">/* 2571091.461923 */</span>
		<span class="mi">2793569</span><span class="p">,</span>	<span class="cm">/* 2793568.696416 */</span>
		<span class="mi">3010931</span><span class="p">,</span>	<span class="cm">/* 3010931.055901 */</span>
		<span class="mi">3223408</span><span class="p">,</span>	<span class="cm">/* 3223408.452106 */</span>
		<span class="mi">3431216</span><span class="p">,</span>	<span class="cm">/* 3431215.635215 */</span>
		<span class="mi">3634553</span><span class="p">,</span>	<span class="cm">/* 3634553.498355 */</span>
		<span class="mi">3833610</span><span class="p">,</span>	<span class="cm">/* 3833610.244726 */</span>
		<span class="mi">4028562</span><span class="p">,</span>	<span class="cm">/* 4028562.434393 */</span>
		<span class="mi">4219576</span><span class="p">,</span>	<span class="cm">/* 4219575.925308 */</span>
		<span class="mi">4406807</span><span class="p">,</span>	<span class="cm">/* 4406806.721144 */</span>
		<span class="mi">4590402</span><span class="p">,</span>	<span class="cm">/* 4590401.736809 */</span>
		<span class="mi">4770499</span><span class="p">,</span>	<span class="cm">/* 4770499.491025 */</span>
		<span class="mi">4947231</span><span class="p">,</span>	<span class="cm">/* 4947230.734179 */</span>
		<span class="mi">5120719</span><span class="p">,</span>	<span class="cm">/* 5120719.018555 */</span>
		<span class="mi">5291081</span><span class="p">,</span>	<span class="cm">/* 5291081.217197 */</span>
		<span class="mi">5458428</span><span class="p">,</span>	<span class="cm">/* 5458427.996830 */</span>
		<span class="mi">5622864</span><span class="p">,</span>	<span class="cm">/* 5622864.249668 */</span>
		<span class="mi">5784489</span><span class="p">,</span>	<span class="cm">/* 5784489.488298 */</span>
		<span class="mi">5943398</span><span class="p">,</span>	<span class="cm">/* 5943398.207380 */</span>
		<span class="mi">6099680</span><span class="p">,</span>	<span class="cm">/* 6099680.215452 */</span>
		<span class="mi">6253421</span><span class="p">,</span>	<span class="cm">/* 6253420.939751 */</span>
		<span class="mi">6404702</span><span class="p">,</span>	<span class="cm">/* 6404701.706649 */</span>
		<span class="mi">6553600</span><span class="p">,</span>	<span class="cm">/* 6553600.000000 */</span>
	<span class="p">};</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Scale x (normalize) */</span>
	<span class="cm">/* computing y in log(x/y) = log(x) - log(y) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">scale</span><span class="p">;</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">scale</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">x</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">scale</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Now x has binary point between bit[scale] and bit[scale-1]</span>
<span class="cm">	   and 1.0 &lt;= x &lt; 2.0 */</span>

	<span class="cm">/* correction for divison: log(x) = log(x/y)+log(y) */</span>
	<span class="n">y</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="p">((((</span><span class="n">u32</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="mi">200</span><span class="p">);</span>

	<span class="cm">/* remove integer part */</span>
	<span class="n">x</span> <span class="o">&amp;=</span> <span class="p">((((</span><span class="n">u32</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">scale</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* get index */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">scale</span> <span class="o">-</span> <span class="n">indexWidth</span><span class="p">));</span>
	<span class="cm">/* compute delta (x - a) */</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="p">((((</span><span class="n">u32</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">scale</span> <span class="o">-</span> <span class="n">indexWidth</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* compute log, multiplication (d* (..)) must be within range ! */</span>
	<span class="n">y</span> <span class="o">+=</span> <span class="n">log2lut</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
	    <span class="p">((</span><span class="n">d</span> <span class="o">*</span> <span class="p">(</span><span class="n">log2lut</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log2lut</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">scale</span> <span class="o">-</span> <span class="n">indexWidth</span><span class="p">));</span>
	<span class="cm">/* Conver to log10() */</span>
	<span class="n">y</span> <span class="o">/=</span> <span class="mi">108853</span><span class="p">;</span>		<span class="cm">/* (log2(10) &lt;&lt; scale) */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* rounding */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">r</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* I2C **********************************************************************/</span>
<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_read1</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adr</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
				    <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">val</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="n">u8</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
	    <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adr</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: i2c write error at addr 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">answ</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adr</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">msg</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adr</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">answ</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">alen</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;: ERROR!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: i2c read error at addr 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;: read from&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;, value = &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">alen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">answ</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read16_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">adr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="n">mm1</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mm2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">single_master</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="mh">0xC0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DRXDAP_FASI_LONG_FORMAT</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mm1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">mm1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">mm1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">mm1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mm1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">mm1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(0x%08x, 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_read</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">mm1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">mm2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mm2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">mm2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read16_flags</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read32_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">adr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="n">mm1</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mm2</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">single_master</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="mh">0xC0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DRXDAP_FASI_LONG_FORMAT</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mm1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">mm1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">mm1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">mm1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mm1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">mm1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(0x%08x, 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_read</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">mm1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">mm2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mm2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">mm2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">mm2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mm2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read32_flags</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write16_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">adr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="n">mm</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">single_master</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="mh">0xC0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DRXDAP_FASI_LONG_FORMAT</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">mm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">mm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">mm</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">mm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mm</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">mm</span><span class="p">[</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(0x%08x, 0x%04x, 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i2c_write</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">write16_flags</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write32_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">adr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="n">mm</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">single_master</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="mh">0xC0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DRXDAP_FASI_LONG_FORMAT</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">mm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">mm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">mm</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">mm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mm</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">mm</span><span class="p">[</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">mm</span><span class="p">[</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">mm</span><span class="p">[</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(0x%08x, 0x%08x, 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i2c_write</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">write32_flags</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">Address</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">int</span> <span class="n">BlockSize</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pBlock</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BlkSize</span> <span class="o">=</span> <span class="n">BlockSize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">single_master</span><span class="p">)</span>
		<span class="n">Flags</span> <span class="o">|=</span> <span class="mh">0xC0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">BlkSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">Chunk</span> <span class="o">=</span> <span class="n">BlkSize</span> <span class="o">&gt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_ChunkSize</span> <span class="o">?</span>
		    <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_ChunkSize</span> <span class="o">:</span> <span class="n">BlkSize</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">AdrBuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">u32</span> <span class="n">AdrLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">DRXDAP_FASI_LONG_FORMAT</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">Flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">AdrBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">Address</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
			<span class="n">AdrBuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">Address</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="n">AdrBuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">Address</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="n">AdrBuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">Address</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="n">AdrBuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Flags</span><span class="p">;</span>
			<span class="n">AdrLength</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Chunk</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_ChunkSize</span><span class="p">)</span>
				<span class="n">Chunk</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">AdrBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">Address</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="n">AdrBuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">Address</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span>
				     <span class="p">((</span><span class="n">Address</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">));</span>
			<span class="n">AdrLength</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Chunk</span><span class="p">[</span><span class="n">AdrLength</span><span class="p">],</span> <span class="n">pBlock</span><span class="p">,</span> <span class="n">Chunk</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(0x%08x, 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">Flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pBlock</span><span class="p">)</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Chunk</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">pBlock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_write</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Chunk</span> <span class="o">+</span> <span class="n">AdrLength</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: %s: i2c write error at addr 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">Address</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pBlock</span> <span class="o">+=</span> <span class="n">Chunk</span><span class="p">;</span>
		<span class="n">Address</span> <span class="o">+=</span> <span class="p">(</span><span class="n">Chunk</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">BlkSize</span> <span class="o">-=</span> <span class="n">Chunk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef DRXK_MAX_RETRIES_POWERUP</span>
<span class="cp">#define DRXK_MAX_RETRIES_POWERUP 20</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">PowerUpDevice</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_read1</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_write</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">retryCount</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_read1</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">retryCount</span> <span class="o">&lt;</span> <span class="n">DRXK_MAX_RETRIES_POWERUP</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">retryCount</span> <span class="o">&gt;=</span> <span class="n">DRXK_MAX_RETRIES_POWERUP</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure all clk domains are active */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_CC_PWD_MODE__A</span><span class="p">,</span> <span class="n">SIO_CC_PWD_MODE_LEVEL_NONE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_CC_UPDATE__A</span><span class="p">,</span> <span class="n">SIO_CC_UPDATE_KEY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* Enable pll lock tests */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_CC_PLL_LOCK__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_currentPowerMode</span> <span class="o">=</span> <span class="n">DRX_POWER_UP</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIXME: most (all?) of the values bellow should be moved into</span>
<span class="cm">	 * struct drxk_config, as they are probably board-specific</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">ulVSBIfAgcMode</span> <span class="o">=</span> <span class="n">DRXK_AGC_CTRL_AUTO</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulVSBIfAgcOutputLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulVSBIfAgcMinLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulVSBIfAgcMaxLevel</span> <span class="o">=</span> <span class="mh">0x7FFF</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulVSBIfAgcSpeed</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">ulVSBRfAgcMode</span> <span class="o">=</span> <span class="n">DRXK_AGC_CTRL_AUTO</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulVSBRfAgcOutputLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulVSBRfAgcMinLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulVSBRfAgcMaxLevel</span> <span class="o">=</span> <span class="mh">0x7FFF</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulVSBRfAgcSpeed</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulVSBRfAgcTop</span> <span class="o">=</span> <span class="mi">9500</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulVSBRfAgcCutOffCurrent</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">ulATVIfAgcMode</span> <span class="o">=</span> <span class="n">DRXK_AGC_CTRL_AUTO</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulATVIfAgcOutputLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulATVIfAgcMinLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulATVIfAgcMaxLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulATVIfAgcSpeed</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">ulATVRfAgcMode</span> <span class="o">=</span> <span class="n">DRXK_AGC_CTRL_OFF</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulATVRfAgcOutputLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulATVRfAgcMinLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulATVRfAgcMaxLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulATVRfAgcTop</span> <span class="o">=</span> <span class="mi">9500</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulATVRfAgcCutOffCurrent</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulATVRfAgcSpeed</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">ulQual83</span> <span class="o">=</span> <span class="n">DEFAULT_MER_83</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulQual93</span> <span class="o">=</span> <span class="n">DEFAULT_MER_93</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">ulMpegLockTimeOut</span> <span class="o">=</span> <span class="n">DEFAULT_DRXK_MPEG_LOCK_TIMEOUT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulDemodLockTimeOut</span> <span class="o">=</span> <span class="n">DEFAULT_DRXK_DEMOD_LOCK_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/* io_pad_cfg register (8 bit reg.) MSB bit is 1 (default value) */</span>
	<span class="cm">/* io_pad_cfg_mode output mode is drive always */</span>
	<span class="cm">/* io_pad_cfg_drive is set to power 2 (23 mA) */</span>
	<span class="n">u32</span> <span class="n">ulGPIOCfg</span> <span class="o">=</span> <span class="mh">0x0113</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulInvertTSClock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulTSDataStrength</span> <span class="o">=</span> <span class="n">DRXK_MPEG_SERIAL_OUTPUT_PIN_DRIVE_STRENGTH</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulDVBTBitrate</span> <span class="o">=</span> <span class="mi">50000000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulDVBCBitrate</span> <span class="o">=</span> <span class="n">DRXK_QAM_SYMBOLRATE_MAX</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">ulInsertRSByte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">ulRfMirror</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulPowerDown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasLNA</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBT</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBC</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasATV</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasOOB</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasAudio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_ChunkSize</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_ChunkSize</span> <span class="o">=</span> <span class="mi">124</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_oscClockFreq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_smartAntInverted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_bPDownOpenBridge</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* real system clock frequency in kHz */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_sysClockFreq</span> <span class="o">=</span> <span class="mi">151875</span><span class="p">;</span>
	<span class="cm">/* Timing div, 250ns/Psys */</span>
	<span class="cm">/* Timing div, = (delay (nano seconds) * sysclk (kHz))/ 1000 */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgTimingDiv</span> <span class="o">=</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_sysClockFreq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span>
				   <span class="n">HI_I2C_DELAY</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="cm">/* Clipping */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgTimingDiv</span> <span class="o">&gt;</span> <span class="n">SIO_HI_RA_RAM_PAR_2_CFG_DIV__M</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgTimingDiv</span> <span class="o">=</span> <span class="n">SIO_HI_RA_RAM_PAR_2_CFG_DIV__M</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgWakeUpKey</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_address</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* port/bridge/power down ctrl */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgCtrl</span> <span class="o">=</span> <span class="n">SIO_HI_RA_RAM_PAR_5_CFG_SLV0_SLAVE</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_bPowerDown</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulPowerDown</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DRXK_A1_PATCH_CODE</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DRXK_A1_ROM_CODE</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DRXK_A2_ROM_CODE</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DRXK_A3_ROM_CODE</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DRXK_A2_PATCH_CODE</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DRXK_A3_PATCH_CODE</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Init AGC and PGA parameters */</span>
	<span class="cm">/* VSB IF */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbIfAgcCfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulVSBIfAgcMode</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbIfAgcCfg</span><span class="p">.</span><span class="n">outputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulVSBIfAgcOutputLevel</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbIfAgcCfg</span><span class="p">.</span><span class="n">minOutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulVSBIfAgcMinLevel</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbIfAgcCfg</span><span class="p">.</span><span class="n">maxOutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulVSBIfAgcMaxLevel</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbIfAgcCfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulVSBIfAgcSpeed</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbPgaCfg</span> <span class="o">=</span> <span class="mi">140</span><span class="p">;</span>

	<span class="cm">/* VSB RF */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbRfAgcCfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulVSBRfAgcMode</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbRfAgcCfg</span><span class="p">.</span><span class="n">outputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulVSBRfAgcOutputLevel</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbRfAgcCfg</span><span class="p">.</span><span class="n">minOutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulVSBRfAgcMinLevel</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbRfAgcCfg</span><span class="p">.</span><span class="n">maxOutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulVSBRfAgcMaxLevel</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbRfAgcCfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulVSBRfAgcSpeed</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbRfAgcCfg</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulVSBRfAgcTop</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbRfAgcCfg</span><span class="p">.</span><span class="n">cutOffCurrent</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulVSBRfAgcCutOffCurrent</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbPreSawCfg</span><span class="p">.</span><span class="n">reference</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_vsbPreSawCfg</span><span class="p">.</span><span class="n">usePreSaw</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_Quality83percent</span> <span class="o">=</span> <span class="n">DEFAULT_MER_83</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_Quality93percent</span> <span class="o">=</span> <span class="n">DEFAULT_MER_93</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ulQual93</span> <span class="o">&lt;=</span> <span class="mi">500</span> <span class="o">&amp;&amp;</span> <span class="n">ulQual83</span> <span class="o">&lt;</span> <span class="n">ulQual93</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_Quality83percent</span> <span class="o">=</span> <span class="n">ulQual83</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_Quality93percent</span> <span class="o">=</span> <span class="n">ulQual93</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ATV IF */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvIfAgcCfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulATVIfAgcMode</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvIfAgcCfg</span><span class="p">.</span><span class="n">outputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulATVIfAgcOutputLevel</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvIfAgcCfg</span><span class="p">.</span><span class="n">minOutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulATVIfAgcMinLevel</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvIfAgcCfg</span><span class="p">.</span><span class="n">maxOutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulATVIfAgcMaxLevel</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvIfAgcCfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulATVIfAgcSpeed</span><span class="p">);</span>

	<span class="cm">/* ATV RF */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvRfAgcCfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulATVRfAgcMode</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvRfAgcCfg</span><span class="p">.</span><span class="n">outputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulATVRfAgcOutputLevel</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvRfAgcCfg</span><span class="p">.</span><span class="n">minOutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulATVRfAgcMinLevel</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvRfAgcCfg</span><span class="p">.</span><span class="n">maxOutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulATVRfAgcMaxLevel</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvRfAgcCfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulATVRfAgcSpeed</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvRfAgcCfg</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulATVRfAgcTop</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvRfAgcCfg</span><span class="p">.</span><span class="n">cutOffCurrent</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulATVRfAgcCutOffCurrent</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvPreSawCfg</span><span class="p">.</span><span class="n">reference</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvPreSawCfg</span><span class="p">.</span><span class="n">usePreSaw</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>


	<span class="cm">/* DVBT RF */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtRfAgcCfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="n">DRXK_AGC_CTRL_OFF</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtRfAgcCfg</span><span class="p">.</span><span class="n">outputLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtRfAgcCfg</span><span class="p">.</span><span class="n">minOutputLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtRfAgcCfg</span><span class="p">.</span><span class="n">maxOutputLevel</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtRfAgcCfg</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mh">0x2100</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtRfAgcCfg</span><span class="p">.</span><span class="n">cutOffCurrent</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtRfAgcCfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>


	<span class="cm">/* DVBT IF */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtIfAgcCfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="n">DRXK_AGC_CTRL_AUTO</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtIfAgcCfg</span><span class="p">.</span><span class="n">outputLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtIfAgcCfg</span><span class="p">.</span><span class="n">minOutputLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtIfAgcCfg</span><span class="p">.</span><span class="n">maxOutputLevel</span> <span class="o">=</span> <span class="mi">9000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtIfAgcCfg</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">13424</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtIfAgcCfg</span><span class="p">.</span><span class="n">cutOffCurrent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtIfAgcCfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtIfAgcCfg</span><span class="p">.</span><span class="n">FastClipCtrlDelay</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtIfAgcCfg</span><span class="p">.</span><span class="n">IngainTgtMax</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">;</span>
	<span class="cm">/* state-&gt;m_dvbtPgaCfg = 140; */</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtPreSawCfg</span><span class="p">.</span><span class="n">reference</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtPreSawCfg</span><span class="p">.</span><span class="n">usePreSaw</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* QAM RF */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamRfAgcCfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="n">DRXK_AGC_CTRL_OFF</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamRfAgcCfg</span><span class="p">.</span><span class="n">outputLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamRfAgcCfg</span><span class="p">.</span><span class="n">minOutputLevel</span> <span class="o">=</span> <span class="mi">6023</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamRfAgcCfg</span><span class="p">.</span><span class="n">maxOutputLevel</span> <span class="o">=</span> <span class="mi">27000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamRfAgcCfg</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mh">0x2380</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamRfAgcCfg</span><span class="p">.</span><span class="n">cutOffCurrent</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamRfAgcCfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* QAM IF */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamIfAgcCfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="n">DRXK_AGC_CTRL_AUTO</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamIfAgcCfg</span><span class="p">.</span><span class="n">outputLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamIfAgcCfg</span><span class="p">.</span><span class="n">minOutputLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamIfAgcCfg</span><span class="p">.</span><span class="n">maxOutputLevel</span> <span class="o">=</span> <span class="mi">9000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamIfAgcCfg</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mh">0x0511</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamIfAgcCfg</span><span class="p">.</span><span class="n">cutOffCurrent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamIfAgcCfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamIfAgcCfg</span><span class="p">.</span><span class="n">IngainTgtMax</span> <span class="o">=</span> <span class="mi">5119</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamIfAgcCfg</span><span class="p">.</span><span class="n">FastClipCtrlDelay</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamPgaCfg</span> <span class="o">=</span> <span class="mi">140</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamPreSawCfg</span><span class="p">.</span><span class="n">reference</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamPreSawCfg</span><span class="p">.</span><span class="n">usePreSaw</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">=</span> <span class="n">OM_NONE</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DrxkState</span> <span class="o">=</span> <span class="n">DRXK_UNINITIALIZED</span><span class="p">;</span>

	<span class="cm">/* MPEG output configuration */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_enableMPEGOutput</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>	<span class="cm">/* If TRUE; enable MPEG ouput */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_insertRSByte</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* If TRUE; insert RS byte */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_invertDATA</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* If TRUE; invert DATA signals */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_invertERR</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* If TRUE; invert ERR signal */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_invertSTR</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* If TRUE; invert STR signals */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_invertVAL</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* If TRUE; invert VAL signals */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_invertCLK</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulInvertTSClock</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* If TRUE; invert CLK signals */</span>

	<span class="cm">/* If TRUE; static MPEG clockrate will be used;</span>
<span class="cm">	   otherwise clockrate will adapt to the bitrate of the TS */</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DVBTBitrate</span> <span class="o">=</span> <span class="n">ulDVBTBitrate</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DVBCBitrate</span> <span class="o">=</span> <span class="n">ulDVBCBitrate</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_TSDataStrength</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulTSDataStrength</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>

	<span class="cm">/* Maximum bitrate in b/s in case static clockrate is selected */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_mpegTsStaticBitrate</span> <span class="o">=</span> <span class="mi">19392658</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_disableTEIhandling</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ulInsertRSByte</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_insertRSByte</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_MpegLockTimeOut</span> <span class="o">=</span> <span class="n">DEFAULT_DRXK_MPEG_LOCK_TIMEOUT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ulMpegLockTimeOut</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_MpegLockTimeOut</span> <span class="o">=</span> <span class="n">ulMpegLockTimeOut</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DemodLockTimeOut</span> <span class="o">=</span> <span class="n">DEFAULT_DRXK_DEMOD_LOCK_TIMEOUT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ulDemodLockTimeOut</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DemodLockTimeOut</span> <span class="o">=</span> <span class="n">ulDemodLockTimeOut</span><span class="p">;</span>

	<span class="cm">/* QAM defaults */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_Constellation</span> <span class="o">=</span> <span class="n">DRX_CONSTELLATION_AUTO</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamInterleaveMode</span> <span class="o">=</span> <span class="n">DRXK_QAM_I12_J17</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_fecRsPlen</span> <span class="o">=</span> <span class="mi">204</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* fecRsPlen  annex A */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_fecRsPrescale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_sqiSpeed</span> <span class="o">=</span> <span class="n">DRXK_DVBT_SQI_SPEED_MEDIUM</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_agcFastClipCtrlDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIOCfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulGPIOCfg</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_bPowerDown</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_currentPowerMode</span> <span class="o">=</span> <span class="n">DRX_POWER_DOWN</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_rfmirror</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulRfMirror</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_IfAgcPol</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DRXX_Open</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">jtag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* stop lock indicator process */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_GPIO__A</span><span class="p">,</span> <span class="n">SCU_RAM_GPIO_HW_LOCK_IND_DISABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* Check device id */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_TOP_COMM_KEY__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_TOP_COMM_KEY__A</span><span class="p">,</span> <span class="n">SIO_TOP_COMM_KEY_KEY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read32</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_TOP_JTAGID_LO__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jtag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_UIO_IN_HI__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_TOP_COMM_KEY__A</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">GetDeviceCapabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">sioPdrOhwCfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sioTopJtagidLo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">spin</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* driver 0.9.0 */</span>
	<span class="cm">/* stop lock indicator process */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_GPIO__A</span><span class="p">,</span> <span class="n">SCU_RAM_GPIO_HW_LOCK_IND_DISABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_TOP_COMM_KEY__A</span><span class="p">,</span> <span class="mh">0xFABA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_OHW_CFG__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sioPdrOhwCfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_TOP_COMM_KEY__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">sioPdrOhwCfg</span> <span class="o">&amp;</span> <span class="n">SIO_PDR_OHW_CFG_FREF_SEL__M</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* ignore (bypass ?) */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* 27 MHz */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_oscClockFreq</span> <span class="o">=</span> <span class="mi">27000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/* 20.25 MHz */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_oscClockFreq</span> <span class="o">=</span> <span class="mi">20250</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/* 4 MHz */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_oscClockFreq</span> <span class="o">=</span> <span class="mi">20250</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Clock Frequency is unkonwn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">		Determine device capabilities</span>
<span class="cm">		Based on pinning v14</span>
<span class="cm">		*/</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read32</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_TOP_JTAGID_LO__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sioTopJtagidLo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: status = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sioTopJtagidLo</span><span class="p">);</span>

	<span class="cm">/* driver 0.9.0 */</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">sioTopJtagidLo</span> <span class="o">&gt;&gt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_deviceSpin</span> <span class="o">=</span> <span class="n">DRXK_SPIN_A1</span><span class="p">;</span>
		<span class="n">spin</span> <span class="o">=</span> <span class="s">&quot;A1&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_deviceSpin</span> <span class="o">=</span> <span class="n">DRXK_SPIN_A2</span><span class="p">;</span>
		<span class="n">spin</span> <span class="o">=</span> <span class="s">&quot;A2&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_deviceSpin</span> <span class="o">=</span> <span class="n">DRXK_SPIN_A3</span><span class="p">;</span>
		<span class="n">spin</span> <span class="o">=</span> <span class="s">&quot;A3&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_deviceSpin</span> <span class="o">=</span> <span class="n">DRXK_SPIN_UNKNOWN</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Spin %d unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">sioTopJtagidLo</span> <span class="o">&gt;&gt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">sioTopJtagidLo</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x13</span>:
		<span class="cm">/* typeId = DRX3913K_TYPE_ID */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasLNA</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasOOB</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasATV</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasAudio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBT</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBC</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasSAWSW</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO2</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO1</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasIRQN</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x15</span>:
		<span class="cm">/* typeId = DRX3915K_TYPE_ID */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasLNA</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasOOB</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasATV</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasAudio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBT</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBC</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasSAWSW</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO2</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO1</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasIRQN</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x16</span>:
		<span class="cm">/* typeId = DRX3916K_TYPE_ID */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasLNA</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasOOB</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasATV</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasAudio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBT</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBC</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasSAWSW</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO2</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO1</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasIRQN</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x18</span>:
		<span class="cm">/* typeId = DRX3918K_TYPE_ID */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasLNA</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasOOB</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasATV</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasAudio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBT</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBC</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasSAWSW</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO2</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO1</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasIRQN</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x21</span>:
		<span class="cm">/* typeId = DRX3921K_TYPE_ID */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasLNA</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasOOB</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasATV</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasAudio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBT</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBC</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasSAWSW</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO2</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO1</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasIRQN</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x23</span>:
		<span class="cm">/* typeId = DRX3923K_TYPE_ID */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasLNA</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasOOB</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasATV</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasAudio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBT</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBC</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasSAWSW</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO2</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO1</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasIRQN</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x25</span>:
		<span class="cm">/* typeId = DRX3925K_TYPE_ID */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasLNA</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasOOB</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasATV</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasAudio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBT</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBC</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasSAWSW</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO2</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO1</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasIRQN</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x26</span>:
		<span class="cm">/* typeId = DRX3926K_TYPE_ID */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasLNA</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasOOB</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasATV</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasAudio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBT</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBC</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasSAWSW</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO2</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasGPIO1</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasIRQN</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: DeviceID 0x%02x not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">((</span><span class="n">sioTopJtagidLo</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;drxk: detected a drx-39%02xk, spin %s, xtal %d.%03d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">sioTopJtagidLo</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span> <span class="n">spin</span><span class="p">,</span>
	       <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_oscClockFreq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
	       <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_oscClockFreq</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

<span class="nl">error2:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">HI_Command</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">pResult</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">powerdown_cmd</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Write command */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_CMD__A</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIO_HI_RA_RAM_CMD_RESET</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">powerdown_cmd</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIO_HI_RA_RAM_CMD_CONFIG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgCtrl</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="n">SIO_HI_RA_RAM_PAR_5_CFG_SLEEP__M</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">SIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">powerdown_cmd</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Wait until command rdy */</span>
		<span class="n">u32</span> <span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">waitCmd</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">retryCount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_CMD__A</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">waitCmd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">retryCount</span> <span class="o">&lt;</span> <span class="n">DRXK_MAX_RETRIES</span><span class="p">)</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">waitCmd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_RES__A</span><span class="p">,</span> <span class="n">pResult</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">HI_CfgCommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_PAR_6__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgTimeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_PAR_5__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgCtrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_PAR_4__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgWakeUpKey</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_PAR_3__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgBridgeDelay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_PAR_2__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgTimingDiv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_PAR_1__A</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_PAR_1_PAR1_SEC_KEY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">HI_Command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_CMD_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgCtrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">InitHI</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgWakeUpKey</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_address</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgTimeout</span> <span class="o">=</span> <span class="mh">0x96FF</span><span class="p">;</span>
	<span class="cm">/* port/bridge/power down ctrl */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgCtrl</span> <span class="o">=</span> <span class="n">SIO_HI_RA_RAM_PAR_5_CFG_SLV0_SLAVE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">HI_CfgCommand</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MPEGTSConfigurePins</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mpegEnable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sioPdrMclkCfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sioPdrMdxCfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">err_cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;: mpeg %s, %s mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mpegEnable</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_enableParallel</span> <span class="o">?</span> <span class="s">&quot;parallel&quot;</span> <span class="o">:</span> <span class="s">&quot;serial&quot;</span><span class="p">);</span>

	<span class="cm">/* stop lock indicator process */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_GPIO__A</span><span class="p">,</span> <span class="n">SCU_RAM_GPIO_HW_LOCK_IND_DISABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*  MPEG TS pad configuration */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_TOP_COMM_KEY__A</span><span class="p">,</span> <span class="mh">0xFABA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpegEnable</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  Set MPEG TS pads to inputmode */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MSTRT_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MERR_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MCLK_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MVAL_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD0_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD1_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD2_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD3_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD4_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD5_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD6_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD7_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Enable MPEG output */</span>
		<span class="n">sioPdrMdxCfg</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_TSDataStrength</span> <span class="o">&lt;&lt;</span>
			<span class="n">SIO_PDR_MD0_CFG_DRIVE__B</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0003</span><span class="p">);</span>
		<span class="n">sioPdrMclkCfg</span> <span class="o">=</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_TSClockkStrength</span> <span class="o">&lt;&lt;</span>
					<span class="n">SIO_PDR_MCLK_CFG_DRIVE__B</span><span class="p">)</span> <span class="o">|</span>
					<span class="mh">0x0003</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MSTRT_CFG__A</span><span class="p">,</span> <span class="n">sioPdrMdxCfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">enable_merr_cfg</span><span class="p">)</span>
			<span class="n">err_cfg</span> <span class="o">=</span> <span class="n">sioPdrMdxCfg</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MERR_CFG__A</span><span class="p">,</span> <span class="n">err_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MVAL_CFG__A</span><span class="p">,</span> <span class="n">err_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_enableParallel</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* paralel -&gt; enable MD1 to MD7 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD1_CFG__A</span><span class="p">,</span> <span class="n">sioPdrMdxCfg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD2_CFG__A</span><span class="p">,</span> <span class="n">sioPdrMdxCfg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD3_CFG__A</span><span class="p">,</span> <span class="n">sioPdrMdxCfg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD4_CFG__A</span><span class="p">,</span> <span class="n">sioPdrMdxCfg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD5_CFG__A</span><span class="p">,</span> <span class="n">sioPdrMdxCfg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD6_CFG__A</span><span class="p">,</span> <span class="n">sioPdrMdxCfg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD7_CFG__A</span><span class="p">,</span> <span class="n">sioPdrMdxCfg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sioPdrMdxCfg</span> <span class="o">=</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_TSDataStrength</span> <span class="o">&lt;&lt;</span>
						<span class="n">SIO_PDR_MD0_CFG_DRIVE__B</span><span class="p">)</span>
					<span class="o">|</span> <span class="mh">0x0003</span><span class="p">);</span>
			<span class="cm">/* serial -&gt; disable MD1 to MD7 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD1_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD2_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD3_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD4_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD5_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD6_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD7_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MCLK_CFG__A</span><span class="p">,</span> <span class="n">sioPdrMclkCfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MD0_CFG__A</span><span class="p">,</span> <span class="n">sioPdrMdxCfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  Enable MB output over MPEG pads and ctl input */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_MON_CFG__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/*  Write nomagic word to enable pdr reg write */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_TOP_COMM_KEY__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MPEGTSDisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">MPEGTSConfigurePins</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">BLChainCmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		      <span class="n">u16</span> <span class="n">romOffset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">nrOfElements</span><span class="p">,</span> <span class="n">u32</span> <span class="n">timeOut</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">blStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_BL_MODE__A</span><span class="p">,</span> <span class="n">SIO_BL_MODE_CHAIN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_BL_CHAIN_ADDR__A</span><span class="p">,</span> <span class="n">romOffset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_BL_CHAIN_LEN__A</span><span class="p">,</span> <span class="n">nrOfElements</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_BL_ENABLE__A</span><span class="p">,</span> <span class="n">SIO_BL_ENABLE_ON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeOut</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_BL_STATUS__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blStatus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">blStatus</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">time_is_after_jiffies</span><span class="p">(</span><span class="n">end</span><span class="p">))));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blStatus</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: SIO not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="nl">error2:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">DownloadMicrocode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			     <span class="k">const</span> <span class="n">u8</span> <span class="n">pMCImage</span><span class="p">[],</span> <span class="n">u32</span> <span class="n">Length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pSrc</span> <span class="o">=</span> <span class="n">pMCImage</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">Address</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">nBlocks</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">BlockSize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* down the drain (we don&#39;t care about MAGIC_WORD) */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* For future reference */</span>
<span class="c">	Drain = (pSrc[0] &lt;&lt; 8) | pSrc[1];</span>
<span class="cp">#endif</span>
	<span class="n">pSrc</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
	<span class="n">nBlocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">pSrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pSrc</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">pSrc</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nBlocks</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Address</span> <span class="o">=</span> <span class="p">(</span><span class="n">pSrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pSrc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">pSrc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pSrc</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">pSrc</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

		<span class="n">BlockSize</span> <span class="o">=</span> <span class="p">((</span><span class="n">pSrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pSrc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		<span class="n">pSrc</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		/* For future reference */</span>
<span class="c">		Flags = (pSrc[0] &lt;&lt; 8) | pSrc[1];</span>
<span class="cp">#endif</span>
		<span class="n">pSrc</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		/* For future reference */</span>
<span class="c">		BlockCRC = (pSrc[0] &lt;&lt; 8) | pSrc[1];</span>
<span class="cp">#endif</span>
		<span class="n">pSrc</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">BlockSize</span> <span class="o">&gt;</span> <span class="n">Length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Firmware is corrupted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">write_block</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">BlockSize</span><span class="p">,</span> <span class="n">pSrc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d while loading firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pSrc</span> <span class="o">+=</span> <span class="n">BlockSize</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">BlockSize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DVBTEnableOFDMTokenRing</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">desiredCtrl</span> <span class="o">=</span> <span class="n">SIO_OFDM_SH_OFDM_RING_ENABLE_ON</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">desiredStatus</span> <span class="o">=</span> <span class="n">SIO_OFDM_SH_OFDM_RING_STATUS_ENABLED</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desiredCtrl</span> <span class="o">=</span> <span class="n">SIO_OFDM_SH_OFDM_RING_ENABLE_OFF</span><span class="p">;</span>
		<span class="n">desiredStatus</span> <span class="o">=</span> <span class="n">SIO_OFDM_SH_OFDM_RING_STATUS_DOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_OFDM_SH_OFDM_RING_STATUS__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">data</span> <span class="o">==</span> <span class="n">desiredStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* tokenring already has correct status */</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Disable/enable dvbt tokenring bridge   */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_OFDM_SH_OFDM_RING_ENABLE__A</span><span class="p">,</span> <span class="n">desiredCtrl</span><span class="p">);</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">DRXK_OFDM_TR_SHUTDOWN_TIMEOUT</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_OFDM_SH_OFDM_RING_STATUS__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">data</span> <span class="o">==</span> <span class="n">desiredStatus</span><span class="p">)</span> <span class="o">||</span> <span class="n">time_is_after_jiffies</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">desiredStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: SIO not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MPEGTSStop</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fecOcSncMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fecOcIprMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Gracefull shutdown (byte boundaries) */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_SNC_MODE__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fecOcSncMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">fecOcSncMode</span> <span class="o">|=</span> <span class="n">FEC_OC_SNC_MODE_SHUTDOWN__M</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_SNC_MODE__A</span><span class="p">,</span> <span class="n">fecOcSncMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Suppress MCLK during absence of data */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_IPR_MODE__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fecOcIprMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">fecOcIprMode</span> <span class="o">|=</span> <span class="n">FEC_OC_IPR_MODE_MCLK_DIS_DAT_ABS__M</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_IPR_MODE__A</span><span class="p">,</span> <span class="n">fecOcIprMode</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scu_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">parameterLen</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="o">*</span><span class="n">parameter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">resultLen</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if (SCU_RAM_PARAM_0__A - SCU_RAM_PARAM_15__A) != 15</span>
<span class="cp">#error DRXK register mapping no longer compatible with this routine!</span>
<span class="cp">#endif</span>
	<span class="n">u16</span> <span class="n">curCmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">34</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">errname</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">parameterLen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">parameter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">resultLen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* assume that the command register is ready</span>
<span class="cm">		since it is checked afterwards */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="n">parameterLen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span><span class="p">[</span><span class="n">cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameter</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">buffer</span><span class="p">[</span><span class="n">cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">parameter</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="n">write_block</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_PARAM_0__A</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">parameterLen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="cm">/* Wait until SCU has processed command */</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">DRXK_MAX_WAITTIME</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_COMMAND__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">curCmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">curCmd</span> <span class="o">==</span> <span class="n">DRX_SCU_READY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">time_is_after_jiffies</span><span class="p">(</span><span class="n">end</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">curCmd</span> <span class="o">!=</span> <span class="n">DRX_SCU_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: SCU not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* read results */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">resultLen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">s16</span> <span class="n">err</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="n">resultLen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_PARAM_0__A</span> <span class="o">-</span> <span class="n">ii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check if an error was reported by SCU */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* check for the known error codes */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SCU_RESULT_UNKCMD</span>:
			<span class="n">p</span> <span class="o">=</span> <span class="s">&quot;SCU_RESULT_UNKCMD&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCU_RESULT_UNKSTD</span>:
			<span class="n">p</span> <span class="o">=</span> <span class="s">&quot;SCU_RESULT_UNKSTD&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCU_RESULT_SIZE</span>:
			<span class="n">p</span> <span class="o">=</span> <span class="s">&quot;SCU_RESULT_SIZE&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCU_RESULT_INVPAR</span>:
			<span class="n">p</span> <span class="o">=</span> <span class="s">&quot;SCU_RESULT_INVPAR&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="cm">/* Other negative values are errors */</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">errname</span><span class="p">,</span> <span class="s">&quot;ERROR: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">errname</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: %s while sending cmd 0x%04x with params:&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;drxk: &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="nl">error2:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetIqmAf</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">bool</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Configure IQM */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IQM_AF_STDBY_STDBY_ADC_STANDBY</span>
				<span class="o">|</span> <span class="n">IQM_AF_STDBY_STDBY_AMP_STANDBY</span>
				<span class="o">|</span> <span class="n">IQM_AF_STDBY_STDBY_PD_STANDBY</span>
				<span class="o">|</span> <span class="n">IQM_AF_STDBY_STDBY_TAGC_IF_STANDBY</span>
				<span class="o">|</span> <span class="n">IQM_AF_STDBY_STDBY_TAGC_RF_STANDBY</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="o">~</span><span class="n">IQM_AF_STDBY_STDBY_ADC_STANDBY</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">IQM_AF_STDBY_STDBY_AMP_STANDBY</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">IQM_AF_STDBY_STDBY_PD_STANDBY</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">IQM_AF_STDBY_STDBY_TAGC_IF_STANDBY</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">IQM_AF_STDBY_STDBY_TAGC_RF_STANDBY</span><span class="p">)</span>
			<span class="p">);</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">CtrlPowerMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">DRXPowerMode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sioCcPwdMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Check arguments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRX_POWER_UP</span>:
		<span class="n">sioCcPwdMode</span> <span class="o">=</span> <span class="n">SIO_CC_PWD_MODE_LEVEL_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRXK_POWER_DOWN_OFDM</span>:
		<span class="n">sioCcPwdMode</span> <span class="o">=</span> <span class="n">SIO_CC_PWD_MODE_LEVEL_OFDM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRXK_POWER_DOWN_CORE</span>:
		<span class="n">sioCcPwdMode</span> <span class="o">=</span> <span class="n">SIO_CC_PWD_MODE_LEVEL_CLOCK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRXK_POWER_DOWN_PLL</span>:
		<span class="n">sioCcPwdMode</span> <span class="o">=</span> <span class="n">SIO_CC_PWD_MODE_LEVEL_PLL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRX_POWER_DOWN</span>:
		<span class="n">sioCcPwdMode</span> <span class="o">=</span> <span class="n">SIO_CC_PWD_MODE_LEVEL_OSC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Unknow sleep mode */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If already in requested power mode, do nothing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_currentPowerMode</span> <span class="o">==</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* For next steps make sure to start from DRX_POWER_UP mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_currentPowerMode</span> <span class="o">!=</span> <span class="n">DRX_POWER_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">PowerUpDevice</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">DVBTEnableOFDMTokenRing</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DRX_POWER_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Restore analog &amp; pin configuartion */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Power down to requested mode */</span>
		<span class="cm">/* Backup some register settings */</span>
		<span class="cm">/* Set pins with possible pull-ups connected</span>
<span class="cm">		   to them in input mode */</span>
		<span class="cm">/* Analog power down */</span>
		<span class="cm">/* ADC power down */</span>
		<span class="cm">/* Power down device */</span>
		<span class="cm">/* stop all comm_exec */</span>
		<span class="cm">/* Stop and power down previous standard */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OM_DVBT</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSStop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">PowerDownDVBT</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OM_QAM_ITU_A</span>:
		<span class="k">case</span> <span class="n">OM_QAM_ITU_C</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSStop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">PowerDownQAM</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">DVBTEnableOFDMTokenRing</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_CC_PWD_MODE__A</span><span class="p">,</span> <span class="n">sioCcPwdMode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_CC_UPDATE__A</span><span class="p">,</span> <span class="n">SIO_CC_UPDATE_KEY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">DRXK_POWER_DOWN_OFDM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgCtrl</span> <span class="o">|=</span>
				<span class="n">SIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">HI_CfgCommand</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_currentPowerMode</span> <span class="o">=</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">PowerDownDVBT</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">bool</span> <span class="n">setPowerMode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">DRXPowerMode</span> <span class="n">powerMode</span> <span class="o">=</span> <span class="n">DRXK_POWER_DOWN_OFDM</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmdResult</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">SCU_COMM_EXEC_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Send OFDM stop command */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">scu_command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_COMMAND_STANDARD_OFDM</span> <span class="o">|</span> <span class="n">SCU_RAM_COMMAND_CMD_DEMOD_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdResult</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="cm">/* Send OFDM reset command */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">scu_command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_COMMAND_STANDARD_OFDM</span> <span class="o">|</span> <span class="n">SCU_RAM_COMMAND_CMD_DEMOD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdResult</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset datapath for OFDM, processors first */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">OFDM_SC_COMM_EXEC_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_LC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">OFDM_LC_COMM_EXEC_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_COMM_EXEC__A</span><span class="p">,</span> <span class="n">IQM_COMM_EXEC_B_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* powerdown AFE                   */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">SetIqmAf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* powerdown to OFDM mode          */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setPowerMode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">CtrlPowerMode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">powerMode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetOperationMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">OperationMode</span> <span class="n">oMode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Stop and power down previous standard</span>
<span class="cm">	   TODO investigate total power down instead of partial</span>
<span class="cm">	   power down depending on &quot;previous&quot; standard.</span>
<span class="cm">	 */</span>

	<span class="cm">/* disable HW lock indicator */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_GPIO__A</span><span class="p">,</span> <span class="n">SCU_RAM_GPIO_HW_LOCK_IND_DISABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Device is already at the required mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">==</span> <span class="n">oMode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* OM_NONE was added for start up */</span>
	<span class="k">case</span> <span class="n">OM_NONE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OM_DVBT</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSStop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">PowerDownDVBT</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">=</span> <span class="n">OM_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OM_QAM_ITU_A</span>:	<span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">OM_QAM_ITU_C</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSStop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">PowerDownQAM</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">=</span> <span class="n">OM_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OM_QAM_ITU_B</span>:
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">		Power up new standard</span>
<span class="cm">		*/</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">oMode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OM_DVBT</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;: DVB-T</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">=</span> <span class="n">oMode</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SetDVBTStandard</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">oMode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OM_QAM_ITU_A</span>:	<span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">OM_QAM_ITU_C</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;: DVB-C Annex %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">==</span> <span class="n">OM_QAM_ITU_A</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;A&#39;</span> <span class="o">:</span> <span class="sc">&#39;C&#39;</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">=</span> <span class="n">oMode</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SetQAMStandard</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">oMode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OM_QAM_ITU_B</span>:
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">Start</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">s32</span> <span class="n">offsetFreq</span><span class="p">,</span>
		 <span class="n">s32</span> <span class="n">IntermediateFrequency</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">IFreqkHz</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">OffsetkHz</span> <span class="o">=</span> <span class="n">offsetFreq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DrxkState</span> <span class="o">!=</span> <span class="n">DRXK_STOPPED</span> <span class="o">&amp;&amp;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DrxkState</span> <span class="o">!=</span> <span class="n">DRXK_DTV_STARTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_bMirrorFreqSpect</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">inversion</span> <span class="o">==</span> <span class="n">INVERSION_ON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IntermediateFrequency</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_bMirrorFreqSpect</span> <span class="o">=</span> <span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_bMirrorFreqSpect</span><span class="p">;</span>
		<span class="n">IntermediateFrequency</span> <span class="o">=</span> <span class="o">-</span><span class="n">IntermediateFrequency</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OM_QAM_ITU_A</span>:
	<span class="k">case</span> <span class="n">OM_QAM_ITU_C</span>:
		<span class="n">IFreqkHz</span> <span class="o">=</span> <span class="p">(</span><span class="n">IntermediateFrequency</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SetQAM</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IFreqkHz</span><span class="p">,</span> <span class="n">OffsetkHz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DrxkState</span> <span class="o">=</span> <span class="n">DRXK_DTV_STARTED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OM_DVBT</span>:
		<span class="n">IFreqkHz</span> <span class="o">=</span> <span class="p">(</span><span class="n">IntermediateFrequency</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSStop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SetDVBT</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IFreqkHz</span><span class="p">,</span> <span class="n">OffsetkHz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">DVBTStart</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DrxkState</span> <span class="o">=</span> <span class="n">DRXK_DTV_STARTED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ShutDown</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">MPEGTSStop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">GetLockStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pLockStatus</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">Time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pLockStatus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">=</span> <span class="n">NOT_LOCKED</span><span class="p">;</span>

	<span class="cm">/* define the SCU command code */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OM_QAM_ITU_A</span>:
	<span class="k">case</span> <span class="n">OM_QAM_ITU_B</span>:
	<span class="k">case</span> <span class="n">OM_QAM_ITU_C</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">GetQAMLockStatus</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">pLockStatus</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OM_DVBT</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">GetDVBTLockStatus</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">pLockStatus</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MPEGTSStart</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">fecOcSncMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allow OC to sync again */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_SNC_MODE__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fecOcSncMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">fecOcSncMode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FEC_OC_SNC_MODE_SHUTDOWN__M</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_SNC_MODE__A</span><span class="p">,</span> <span class="n">fecOcSncMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_SNC_UNLOCK__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MPEGTSDtoInit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Rate integration settings */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_RCN_CTL_STEP_LO__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_RCN_CTL_STEP_HI__A</span><span class="p">,</span> <span class="mh">0x000C</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_RCN_GAIN__A</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_AVR_PARM_A__A</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_AVR_PARM_B__A</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_TMD_HI_MARGIN__A</span><span class="p">,</span> <span class="mh">0x0680</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_TMD_LO_MARGIN__A</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_TMD_COUNT__A</span><span class="p">,</span> <span class="mh">0x03F4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Additional configuration */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_OCR_INVERT__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_SNC_LWM__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_SNC_HWM__A</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MPEGTSDtoSetup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">OperationMode</span> <span class="n">oMode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">fecOcRegMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* FEC_OC_MODE       register value */</span>
	<span class="n">u16</span> <span class="n">fecOcRegIprMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* FEC_OC_IPR_MODE   register value */</span>
	<span class="n">u16</span> <span class="n">fecOcDtoMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* FEC_OC_IPR_INVERT register value */</span>
	<span class="n">u16</span> <span class="n">fecOcFctMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* FEC_OC_IPR_INVERT register value */</span>
	<span class="n">u16</span> <span class="n">fecOcDtoPeriod</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* FEC_OC_IPR_INVERT register value */</span>
	<span class="n">u16</span> <span class="n">fecOcDtoBurstLen</span> <span class="o">=</span> <span class="mi">188</span><span class="p">;</span>	<span class="cm">/* FEC_OC_IPR_INVERT register value */</span>
	<span class="n">u32</span> <span class="n">fecOcRcnCtlRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* FEC_OC_IPR_INVERT register value */</span>
	<span class="n">u16</span> <span class="n">fecOcTmdMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fecOcTmdIntUpdRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">maxBitRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">staticCLK</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Check insertion of the Reed-Solomon parity bytes */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_MODE__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fecOcRegMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_IPR_MODE__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fecOcRegIprMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">fecOcRegMode</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">FEC_OC_MODE_PARITY__M</span><span class="p">);</span>
	<span class="n">fecOcRegIprMode</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">FEC_OC_IPR_MODE_MVAL_DIS_PAR__M</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_insertRSByte</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable parity symbol forward */</span>
		<span class="n">fecOcRegMode</span> <span class="o">|=</span> <span class="n">FEC_OC_MODE_PARITY__M</span><span class="p">;</span>
		<span class="cm">/* MVAL disable during parity bytes */</span>
		<span class="n">fecOcRegIprMode</span> <span class="o">|=</span> <span class="n">FEC_OC_IPR_MODE_MVAL_DIS_PAR__M</span><span class="p">;</span>
		<span class="cm">/* TS burst length to 204 */</span>
		<span class="n">fecOcDtoBurstLen</span> <span class="o">=</span> <span class="mi">204</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check serial or parrallel output */</span>
	<span class="n">fecOcRegIprMode</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">FEC_OC_IPR_MODE_SERIAL__M</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_enableParallel</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MPEG data output is serial -&gt; set ipr_mode[0] */</span>
		<span class="n">fecOcRegIprMode</span> <span class="o">|=</span> <span class="n">FEC_OC_IPR_MODE_SERIAL__M</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">oMode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OM_DVBT</span>:
		<span class="n">maxBitRate</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DVBTBitrate</span><span class="p">;</span>
		<span class="n">fecOcTmdMode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">fecOcRcnCtlRate</span> <span class="o">=</span> <span class="mh">0xC00000</span><span class="p">;</span>
		<span class="n">staticCLK</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DVBTStaticCLK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OM_QAM_ITU_A</span>:	<span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">OM_QAM_ITU_C</span>:
		<span class="n">fecOcTmdMode</span> <span class="o">=</span> <span class="mh">0x0004</span><span class="p">;</span>
		<span class="n">fecOcRcnCtlRate</span> <span class="o">=</span> <span class="mh">0xD2B4EE</span><span class="p">;</span>	<span class="cm">/* good for &gt;63 Mb/s */</span>
		<span class="n">maxBitRate</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DVBCBitrate</span><span class="p">;</span>
		<span class="n">staticCLK</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DVBCStaticCLK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>		<span class="cm">/* switch (standard) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Configure DTO&#39;s */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">staticCLK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">bitRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Rational DTO for MCLK source (static MCLK rate),</span>
<span class="cm">			Dynamic DTO for optimal grouping</span>
<span class="cm">			(avoid intra-packet gaps),</span>
<span class="cm">			DTO offset enable to sync TS burst with MSTRT */</span>
		<span class="n">fecOcDtoMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">FEC_OC_DTO_MODE_DYNAMIC__M</span> <span class="o">|</span>
				<span class="n">FEC_OC_DTO_MODE_OFFSET_ENABLE__M</span><span class="p">);</span>
		<span class="n">fecOcFctMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">FEC_OC_FCT_MODE_RAT_ENA__M</span> <span class="o">|</span>
				<span class="n">FEC_OC_FCT_MODE_VIRT_ENA__M</span><span class="p">);</span>

		<span class="cm">/* Check user defined bitrate */</span>
		<span class="n">bitRate</span> <span class="o">=</span> <span class="n">maxBitRate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitRate</span> <span class="o">&gt;</span> <span class="mi">75900000UL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* max is 75.9 Mb/s */</span>
			<span class="n">bitRate</span> <span class="o">=</span> <span class="mi">75900000UL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Rational DTO period:</span>
<span class="cm">			dto_period = (Fsys / bitrate) - 2</span>

<span class="cm">			Result should be floored,</span>
<span class="cm">			to make sure &gt;= requested bitrate</span>
<span class="cm">			*/</span>
		<span class="n">fecOcDtoPeriod</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_sysClockFreq</span><span class="p">)</span>
						<span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">bitRate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fecOcDtoPeriod</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">fecOcDtoPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fecOcDtoPeriod</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">fecOcTmdIntUpdRate</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* (commonAttr-&gt;staticCLK == false) =&gt; dynamic mode */</span>
		<span class="n">fecOcDtoMode</span> <span class="o">=</span> <span class="n">FEC_OC_DTO_MODE_DYNAMIC__M</span><span class="p">;</span>
		<span class="n">fecOcFctMode</span> <span class="o">=</span> <span class="n">FEC_OC_FCT_MODE__PRE</span><span class="p">;</span>
		<span class="n">fecOcTmdIntUpdRate</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write appropriate registers with requested configuration */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_DTO_BURST_LEN__A</span><span class="p">,</span> <span class="n">fecOcDtoBurstLen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_DTO_PERIOD__A</span><span class="p">,</span> <span class="n">fecOcDtoPeriod</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_DTO_MODE__A</span><span class="p">,</span> <span class="n">fecOcDtoMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_FCT_MODE__A</span><span class="p">,</span> <span class="n">fecOcFctMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_MODE__A</span><span class="p">,</span> <span class="n">fecOcRegMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_IPR_MODE__A</span><span class="p">,</span> <span class="n">fecOcRegIprMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Rate integration settings */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write32</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_RCN_CTL_RATE_LO__A</span><span class="p">,</span> <span class="n">fecOcRcnCtlRate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_TMD_INT_UPD_RATE__A</span><span class="p">,</span> <span class="n">fecOcTmdIntUpdRate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_TMD_MODE__A</span><span class="p">,</span> <span class="n">fecOcTmdMode</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MPEGTSConfigurePolarity</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fecOcRegIprInvert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Data mask for the output data byte */</span>
	<span class="n">u16</span> <span class="n">InvertDataMask</span> <span class="o">=</span>
	    <span class="n">FEC_OC_IPR_INVERT_MD7__M</span> <span class="o">|</span> <span class="n">FEC_OC_IPR_INVERT_MD6__M</span> <span class="o">|</span>
	    <span class="n">FEC_OC_IPR_INVERT_MD5__M</span> <span class="o">|</span> <span class="n">FEC_OC_IPR_INVERT_MD4__M</span> <span class="o">|</span>
	    <span class="n">FEC_OC_IPR_INVERT_MD3__M</span> <span class="o">|</span> <span class="n">FEC_OC_IPR_INVERT_MD2__M</span> <span class="o">|</span>
	    <span class="n">FEC_OC_IPR_INVERT_MD1__M</span> <span class="o">|</span> <span class="n">FEC_OC_IPR_INVERT_MD0__M</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Control selective inversion of output bits */</span>
	<span class="n">fecOcRegIprInvert</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">InvertDataMask</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_invertDATA</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">fecOcRegIprInvert</span> <span class="o">|=</span> <span class="n">InvertDataMask</span><span class="p">;</span>
	<span class="n">fecOcRegIprInvert</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">FEC_OC_IPR_INVERT_MERR__M</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_invertERR</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">fecOcRegIprInvert</span> <span class="o">|=</span> <span class="n">FEC_OC_IPR_INVERT_MERR__M</span><span class="p">;</span>
	<span class="n">fecOcRegIprInvert</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">FEC_OC_IPR_INVERT_MSTRT__M</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_invertSTR</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">fecOcRegIprInvert</span> <span class="o">|=</span> <span class="n">FEC_OC_IPR_INVERT_MSTRT__M</span><span class="p">;</span>
	<span class="n">fecOcRegIprInvert</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">FEC_OC_IPR_INVERT_MVAL__M</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_invertVAL</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">fecOcRegIprInvert</span> <span class="o">|=</span> <span class="n">FEC_OC_IPR_INVERT_MVAL__M</span><span class="p">;</span>
	<span class="n">fecOcRegIprInvert</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">FEC_OC_IPR_INVERT_MCLK__M</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_invertCLK</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">fecOcRegIprInvert</span> <span class="o">|=</span> <span class="n">FEC_OC_IPR_INVERT_MCLK__M</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_IPR_INVERT__A</span><span class="p">,</span> <span class="n">fecOcRegIprInvert</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define   SCU_RAM_AGC_KI_INV_RF_POL__M 0x4000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetAgcRf</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">SCfgAgc</span> <span class="o">*</span><span class="n">pAgcCfg</span><span class="p">,</span> <span class="n">bool</span> <span class="n">isDTV</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">SCfgAgc</span> <span class="o">*</span><span class="n">pIfAgcSettings</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pAgcCfg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pAgcCfg</span><span class="o">-&gt;</span><span class="n">ctrlMode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRXK_AGC_CTRL_AUTO</span>:
		<span class="cm">/* Enable RF AGC DAC */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IQM_AF_STDBY_STDBY_TAGC_RF_STANDBY</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CONFIG__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Enable SCU RF AGC loop */</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCU_RAM_AGC_CONFIG_DISABLE_RF_AGC__M</span><span class="p">;</span>

		<span class="cm">/* Polarity */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_RfAgcPol</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">SCU_RAM_AGC_CONFIG_INV_RF_POL__M</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCU_RAM_AGC_CONFIG_INV_RF_POL__M</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CONFIG__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Set speed (using complementary reduction value) */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_KI_RED__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCU_RAM_AGC_KI_RED_RAGC_RED__M</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">pAgcCfg</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&lt;&lt;</span>
				<span class="n">SCU_RAM_AGC_KI_RED_RAGC_RED__B</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="n">SCU_RAM_AGC_KI_RED_RAGC_RED__M</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_KI_RED__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IsDVBT</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
			<span class="n">pIfAgcSettings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtIfAgcCfg</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IsQAM</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
			<span class="n">pIfAgcSettings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamIfAgcCfg</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pIfAgcSettings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvIfAgcCfg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pIfAgcSettings</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Set TOP, only if IF-AGC is in AUTO mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pIfAgcSettings</span><span class="o">-&gt;</span><span class="n">ctrlMode</span> <span class="o">==</span> <span class="n">DRXK_AGC_CTRL_AUTO</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A</span><span class="p">,</span> <span class="n">pAgcCfg</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Cut-Off current */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_RF_IACCU_HI_CO__A</span><span class="p">,</span> <span class="n">pAgcCfg</span><span class="o">-&gt;</span><span class="n">cutOffCurrent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Max. output level */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_RF_MAX__A</span><span class="p">,</span> <span class="n">pAgcCfg</span><span class="o">-&gt;</span><span class="n">maxOutputLevel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DRXK_AGC_CTRL_USER</span>:
		<span class="cm">/* Enable RF AGC DAC */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IQM_AF_STDBY_STDBY_TAGC_RF_STANDBY</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Disable SCU RF AGC loop */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CONFIG__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">SCU_RAM_AGC_CONFIG_DISABLE_RF_AGC__M</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_RfAgcPol</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">SCU_RAM_AGC_CONFIG_INV_RF_POL__M</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCU_RAM_AGC_CONFIG_INV_RF_POL__M</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CONFIG__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* SCU c.o.c. to 0, enabling full control range */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_RF_IACCU_HI_CO__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Write value to output pin */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_RF_IACCU_HI__A</span><span class="p">,</span> <span class="n">pAgcCfg</span><span class="o">-&gt;</span><span class="n">outputLevel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DRXK_AGC_CTRL_OFF</span>:
		<span class="cm">/* Disable RF AGC DAC */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">IQM_AF_STDBY_STDBY_TAGC_RF_STANDBY</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Disable SCU RF AGC loop */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CONFIG__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">SCU_RAM_AGC_CONFIG_DISABLE_RF_AGC__M</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CONFIG__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="p">}</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SCU_RAM_AGC_KI_INV_IF_POL__M 0x2000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetAgcIf</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">SCfgAgc</span> <span class="o">*</span><span class="n">pAgcCfg</span><span class="p">,</span> <span class="n">bool</span> <span class="n">isDTV</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">SCfgAgc</span> <span class="o">*</span><span class="n">pRfAgcSettings</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pAgcCfg</span><span class="o">-&gt;</span><span class="n">ctrlMode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRXK_AGC_CTRL_AUTO</span>:

		<span class="cm">/* Enable IF AGC DAC */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IQM_AF_STDBY_STDBY_TAGC_IF_STANDBY</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CONFIG__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Enable SCU IF AGC loop */</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCU_RAM_AGC_CONFIG_DISABLE_IF_AGC__M</span><span class="p">;</span>

		<span class="cm">/* Polarity */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_IfAgcPol</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">SCU_RAM_AGC_CONFIG_INV_IF_POL__M</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCU_RAM_AGC_CONFIG_INV_IF_POL__M</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CONFIG__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Set speed (using complementary reduction value) */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_KI_RED__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCU_RAM_AGC_KI_RED_IAGC_RED__M</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">pAgcCfg</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&lt;&lt;</span>
				<span class="n">SCU_RAM_AGC_KI_RED_IAGC_RED__B</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="n">SCU_RAM_AGC_KI_RED_IAGC_RED__M</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_KI_RED__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IsQAM</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
			<span class="n">pRfAgcSettings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamRfAgcCfg</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pRfAgcSettings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_atvRfAgcCfg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pRfAgcSettings</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Restore TOP */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A</span><span class="p">,</span> <span class="n">pRfAgcSettings</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DRXK_AGC_CTRL_USER</span>:

		<span class="cm">/* Enable IF AGC DAC */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IQM_AF_STDBY_STDBY_TAGC_IF_STANDBY</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CONFIG__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Disable SCU IF AGC loop */</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">SCU_RAM_AGC_CONFIG_DISABLE_IF_AGC__M</span><span class="p">;</span>

		<span class="cm">/* Polarity */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_IfAgcPol</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">SCU_RAM_AGC_CONFIG_INV_IF_POL__M</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCU_RAM_AGC_CONFIG_INV_IF_POL__M</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CONFIG__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Write value to output pin */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A</span><span class="p">,</span> <span class="n">pAgcCfg</span><span class="o">-&gt;</span><span class="n">outputLevel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DRXK_AGC_CTRL_OFF</span>:

		<span class="cm">/* Disable If AGC DAC */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">IQM_AF_STDBY_STDBY_TAGC_IF_STANDBY</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_STDBY__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Disable SCU IF AGC loop */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CONFIG__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">SCU_RAM_AGC_CONFIG_DISABLE_IF_AGC__M</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CONFIG__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>		<span class="cm">/* switch (agcSettingsIf-&gt;ctrlMode) */</span>

	<span class="cm">/* always set the top to support</span>
<span class="cm">		configurations without if-loop */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_INGAIN_TGT_MIN__A</span><span class="p">,</span> <span class="n">pAgcCfg</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ReadIFAgc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">agcDacLvl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">Level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_AGC_IF__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">agcDacLvl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">pValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agcDacLvl</span> <span class="o">&gt;</span> <span class="n">DRXK_AGC_DAC_OFFSET</span><span class="p">)</span>
		<span class="n">Level</span> <span class="o">=</span> <span class="n">agcDacLvl</span> <span class="o">-</span> <span class="n">DRXK_AGC_DAC_OFFSET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Level</span> <span class="o">&lt;</span> <span class="mi">14000</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pValue</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14000</span> <span class="o">-</span> <span class="n">Level</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">pValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">GetQAMSignalToNoise</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			       <span class="n">s32</span> <span class="o">*</span><span class="n">pSignalToNoise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qamSlErrPower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* accum. error between</span>
<span class="cm">					raw and sliced symbols */</span>
	<span class="n">u32</span> <span class="n">qamSlSigPower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* used for MER, depends of</span>
<span class="cm">					QAM modulation */</span>
	<span class="n">u32</span> <span class="n">qamSlMer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* QAM MER */</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* MER calculation */</span>

	<span class="cm">/* get the register value needed for MER */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SL_ERR_POWER__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qamSlErrPower</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QAM_16</span>:
		<span class="n">qamSlSigPower</span> <span class="o">=</span> <span class="n">DRXK_QAM_SL_SIG_POWER_QAM16</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_32</span>:
		<span class="n">qamSlSigPower</span> <span class="o">=</span> <span class="n">DRXK_QAM_SL_SIG_POWER_QAM32</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_64</span>:
		<span class="n">qamSlSigPower</span> <span class="o">=</span> <span class="n">DRXK_QAM_SL_SIG_POWER_QAM64</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_128</span>:
		<span class="n">qamSlSigPower</span> <span class="o">=</span> <span class="n">DRXK_QAM_SL_SIG_POWER_QAM128</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">QAM_256</span>:
		<span class="n">qamSlSigPower</span> <span class="o">=</span> <span class="n">DRXK_QAM_SL_SIG_POWER_QAM256</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qamSlErrPower</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qamSlMer</span> <span class="o">=</span> <span class="n">Log10Times100</span><span class="p">(</span><span class="n">qamSlSigPower</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">Log10Times100</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">qamSlErrPower</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">pSignalToNoise</span> <span class="o">=</span> <span class="n">qamSlMer</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">GetDVBTSignalToNoise</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
				<span class="n">s32</span> <span class="o">*</span><span class="n">pSignalToNoise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">regData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">EqRegTdSqrErrI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">EqRegTdSqrErrQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">EqRegTdSqrErrExp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">EqRegTdTpsPwrOfs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">EqRegTdReqSmbCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tpsCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">SqrErrIQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iMER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">transmissionParams</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_EQ_TOP_TD_TPS_PWR_OFS__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">EqRegTdTpsPwrOfs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_EQ_TOP_TD_REQ_SMB_CNT__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">EqRegTdReqSmbCnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_EQ_TOP_TD_SQR_ERR_EXP__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">EqRegTdSqrErrExp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_EQ_TOP_TD_SQR_ERR_I__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regData</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* Extend SQR_ERR_I operational range */</span>
	<span class="n">EqRegTdSqrErrI</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">regData</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">EqRegTdSqrErrExp</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">EqRegTdSqrErrI</span> <span class="o">&lt;</span> <span class="mh">0x00000FFFUL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EqRegTdSqrErrI</span> <span class="o">+=</span> <span class="mh">0x00010000UL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_EQ_TOP_TD_SQR_ERR_Q__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regData</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* Extend SQR_ERR_Q operational range */</span>
	<span class="n">EqRegTdSqrErrQ</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">regData</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">EqRegTdSqrErrExp</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">EqRegTdSqrErrQ</span> <span class="o">&lt;</span> <span class="mh">0x00000FFFUL</span><span class="p">))</span>
		<span class="n">EqRegTdSqrErrQ</span> <span class="o">+=</span> <span class="mh">0x00010000UL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">transmissionParams</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Check input data for MER */</span>

	<span class="cm">/* MER calculation (in 0.1 dB) without math.h */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">EqRegTdTpsPwrOfs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">EqRegTdReqSmbCnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">iMER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">EqRegTdSqrErrI</span> <span class="o">+</span> <span class="n">EqRegTdSqrErrQ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No error at all, this must be the HW reset value</span>
<span class="cm">			* Apparently no first measurement yet</span>
<span class="cm">			* Set MER to 0.0 */</span>
		<span class="n">iMER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SqrErrIQ</span> <span class="o">=</span> <span class="p">(</span><span class="n">EqRegTdSqrErrI</span> <span class="o">+</span> <span class="n">EqRegTdSqrErrQ</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">EqRegTdSqrErrExp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">transmissionParams</span> <span class="o">&amp;</span>
			<span class="n">OFDM_SC_RA_RAM_OP_PARAM_MODE__M</span><span class="p">)</span>
			<span class="o">==</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_MODE_2K</span><span class="p">)</span>
			<span class="n">tpsCnt</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tpsCnt</span> <span class="o">=</span> <span class="mi">68</span><span class="p">;</span>

		<span class="cm">/* IMER = 100 * log10 (x)</span>
<span class="cm">			where x = (EqRegTdTpsPwrOfs^2 *</span>
<span class="cm">			EqRegTdReqSmbCnt * tpsCnt)/SqrErrIQ</span>

<span class="cm">			=&gt; IMER = a + b -c</span>
<span class="cm">			where a = 100 * log10 (EqRegTdTpsPwrOfs^2)</span>
<span class="cm">			b = 100 * log10 (EqRegTdReqSmbCnt * tpsCnt)</span>
<span class="cm">			c = 100 * log10 (SqrErrIQ)</span>
<span class="cm">			*/</span>

		<span class="cm">/* log(x) x = 9bits * 9bits-&gt;18 bits  */</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">Log10Times100</span><span class="p">(</span><span class="n">EqRegTdTpsPwrOfs</span> <span class="o">*</span>
					<span class="n">EqRegTdTpsPwrOfs</span><span class="p">);</span>
		<span class="cm">/* log(x) x = 16bits * 7bits-&gt;23 bits  */</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">Log10Times100</span><span class="p">(</span><span class="n">EqRegTdReqSmbCnt</span> <span class="o">*</span> <span class="n">tpsCnt</span><span class="p">);</span>
		<span class="cm">/* log(x) x = (16bits + 16bits) &lt;&lt; 15 -&gt;32 bits  */</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">Log10Times100</span><span class="p">(</span><span class="n">SqrErrIQ</span><span class="p">);</span>

		<span class="n">iMER</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
		<span class="cm">/* No negative MER, clip to zero */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iMER</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">)</span>
			<span class="n">iMER</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">iMER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">pSignalToNoise</span> <span class="o">=</span> <span class="n">iMER</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">GetSignalToNoise</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">pSignalToNoise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">pSignalToNoise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OM_DVBT</span>:
		<span class="k">return</span> <span class="n">GetDVBTSignalToNoise</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">pSignalToNoise</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">OM_QAM_ITU_A</span>:
	<span class="k">case</span> <span class="n">OM_QAM_ITU_C</span>:
		<span class="k">return</span> <span class="n">GetQAMSignalToNoise</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">pSignalToNoise</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int GetDVBTQuality(struct drxk_state *state, s32 *pQuality)</span>
<span class="c">{</span>
<span class="c">	/* SNR Values for quasi errorfree reception rom Nordig 2.2 */</span>
<span class="c">	int status = 0;</span>

<span class="c">	dprintk(1, &quot;\n&quot;);</span>

<span class="c">	static s32 QE_SN[] = {</span>
<span class="c">		51,		/* QPSK 1/2 */</span>
<span class="c">		69,		/* QPSK 2/3 */</span>
<span class="c">		79,		/* QPSK 3/4 */</span>
<span class="c">		89,		/* QPSK 5/6 */</span>
<span class="c">		97,		/* QPSK 7/8 */</span>
<span class="c">		108,		/* 16-QAM 1/2 */</span>
<span class="c">		131,		/* 16-QAM 2/3 */</span>
<span class="c">		146,		/* 16-QAM 3/4 */</span>
<span class="c">		156,		/* 16-QAM 5/6 */</span>
<span class="c">		160,		/* 16-QAM 7/8 */</span>
<span class="c">		165,		/* 64-QAM 1/2 */</span>
<span class="c">		187,		/* 64-QAM 2/3 */</span>
<span class="c">		202,		/* 64-QAM 3/4 */</span>
<span class="c">		216,		/* 64-QAM 5/6 */</span>
<span class="c">		225,		/* 64-QAM 7/8 */</span>
<span class="c">	};</span>

<span class="c">	*pQuality = 0;</span>

<span class="c">	do {</span>
<span class="c">		s32 SignalToNoise = 0;</span>
<span class="c">		u16 Constellation = 0;</span>
<span class="c">		u16 CodeRate = 0;</span>
<span class="c">		u32 SignalToNoiseRel;</span>
<span class="c">		u32 BERQuality;</span>

<span class="c">		status = GetDVBTSignalToNoise(state, &amp;SignalToNoise);</span>
<span class="c">		if (status &lt; 0)</span>
<span class="c">			break;</span>
<span class="c">		status = read16(state, OFDM_EQ_TOP_TD_TPS_CONST__A, &amp;Constellation);</span>
<span class="c">		if (status &lt; 0)</span>
<span class="c">			break;</span>
<span class="c">		Constellation &amp;= OFDM_EQ_TOP_TD_TPS_CONST__M;</span>

<span class="c">		status = read16(state, OFDM_EQ_TOP_TD_TPS_CODE_HP__A, &amp;CodeRate);</span>
<span class="c">		if (status &lt; 0)</span>
<span class="c">			break;</span>
<span class="c">		CodeRate &amp;= OFDM_EQ_TOP_TD_TPS_CODE_HP__M;</span>

<span class="c">		if (Constellation &gt; OFDM_EQ_TOP_TD_TPS_CONST_64QAM ||</span>
<span class="c">		    CodeRate &gt; OFDM_EQ_TOP_TD_TPS_CODE_LP_7_8)</span>
<span class="c">			break;</span>
<span class="c">		SignalToNoiseRel = SignalToNoise -</span>
<span class="c">		    QE_SN[Constellation * 5 + CodeRate];</span>
<span class="c">		BERQuality = 100;</span>

<span class="c">		if (SignalToNoiseRel &lt; -70)</span>
<span class="c">			*pQuality = 0;</span>
<span class="c">		else if (SignalToNoiseRel &lt; 30)</span>
<span class="c">			*pQuality = ((SignalToNoiseRel + 70) *</span>
<span class="c">				     BERQuality) / 100;</span>
<span class="c">		else</span>
<span class="c">			*pQuality = BERQuality;</span>
<span class="c">	} while (0);</span>
<span class="c">	return 0;</span>
<span class="c">};</span>

<span class="c">static int GetDVBCQuality(struct drxk_state *state, s32 *pQuality)</span>
<span class="c">{</span>
<span class="c">	int status = 0;</span>
<span class="c">	*pQuality = 0;</span>

<span class="c">	dprintk(1, &quot;\n&quot;);</span>

<span class="c">	do {</span>
<span class="c">		u32 SignalToNoise = 0;</span>
<span class="c">		u32 BERQuality = 100;</span>
<span class="c">		u32 SignalToNoiseRel = 0;</span>

<span class="c">		status = GetQAMSignalToNoise(state, &amp;SignalToNoise);</span>
<span class="c">		if (status &lt; 0)</span>
<span class="c">			break;</span>

<span class="c">		switch (state-&gt;props.modulation) {</span>
<span class="c">		case QAM_16:</span>
<span class="c">			SignalToNoiseRel = SignalToNoise - 200;</span>
<span class="c">			break;</span>
<span class="c">		case QAM_32:</span>
<span class="c">			SignalToNoiseRel = SignalToNoise - 230;</span>
<span class="c">			break;	/* Not in NorDig */</span>
<span class="c">		case QAM_64:</span>
<span class="c">			SignalToNoiseRel = SignalToNoise - 260;</span>
<span class="c">			break;</span>
<span class="c">		case QAM_128:</span>
<span class="c">			SignalToNoiseRel = SignalToNoise - 290;</span>
<span class="c">			break;</span>
<span class="c">		default:</span>
<span class="c">		case QAM_256:</span>
<span class="c">			SignalToNoiseRel = SignalToNoise - 320;</span>
<span class="c">			break;</span>
<span class="c">		}</span>

<span class="c">		if (SignalToNoiseRel &lt; -70)</span>
<span class="c">			*pQuality = 0;</span>
<span class="c">		else if (SignalToNoiseRel &lt; 30)</span>
<span class="c">			*pQuality = ((SignalToNoiseRel + 70) *</span>
<span class="c">				     BERQuality) / 100;</span>
<span class="c">		else</span>
<span class="c">			*pQuality = BERQuality;</span>
<span class="c">	} while (0);</span>

<span class="c">	return status;</span>
<span class="c">}</span>

<span class="c">static int GetQuality(struct drxk_state *state, s32 *pQuality)</span>
<span class="c">{</span>
<span class="c">	dprintk(1, &quot;\n&quot;);</span>

<span class="c">	switch (state-&gt;m_OperationMode) {</span>
<span class="c">	case OM_DVBT:</span>
<span class="c">		return GetDVBTQuality(state, pQuality);</span>
<span class="c">	case OM_QAM_ITU_A:</span>
<span class="c">		return GetDVBCQuality(state, pQuality);</span>
<span class="c">	default:</span>
<span class="c">		break;</span>
<span class="c">	}</span>

<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Free data ram in SIO HI */</span>
<span class="cp">#define SIO_HI_RA_RAM_USR_BEGIN__A 0x420040</span>
<span class="cp">#define SIO_HI_RA_RAM_USR_END__A   0x420060</span>

<span class="cp">#define DRXK_HI_ATOMIC_BUF_START (SIO_HI_RA_RAM_USR_BEGIN__A)</span>
<span class="cp">#define DRXK_HI_ATOMIC_BUF_END   (SIO_HI_RA_RAM_USR_BEGIN__A + 7)</span>
<span class="cp">#define DRXK_HI_ATOMIC_READ      SIO_HI_RA_RAM_PAR_3_ACP_RW_READ</span>
<span class="cp">#define DRXK_HI_ATOMIC_WRITE     SIO_HI_RA_RAM_PAR_3_ACP_RW_WRITE</span>

<span class="cp">#define DRXDAP_FASI_ADDR2BLOCK(addr)  (((addr) &gt;&gt; 22) &amp; 0x3F)</span>
<span class="cp">#define DRXDAP_FASI_ADDR2BANK(addr)   (((addr) &gt;&gt; 16) &amp; 0x3F)</span>
<span class="cp">#define DRXDAP_FASI_ADDR2OFFSET(addr) ((addr) &amp; 0x7FFF)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ConfigureI2CBridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">bool</span> <span class="n">bEnableBridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DrxkState</span> <span class="o">==</span> <span class="n">DRXK_UNINITIALIZED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DrxkState</span> <span class="o">==</span> <span class="n">DRXK_POWERED_DOWN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">no_i2c_bridge</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_PAR_1__A</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_PAR_1_PAR1_SEC_KEY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bEnableBridge</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_PAR_2__A</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_PAR_2_BRD_CFG_CLOSED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_PAR_2__A</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_PAR_2_BRD_CFG_OPEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">HI_Command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_HI_RA_RAM_CMD_BRDCTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetPreSaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">SCfgPreSaw</span> <span class="o">*</span><span class="n">pPreSawCfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pPreSawCfg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">pPreSawCfg</span><span class="o">-&gt;</span><span class="n">reference</span> <span class="o">&gt;</span> <span class="n">IQM_AF_PDREF__M</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_PDREF__A</span><span class="p">,</span> <span class="n">pPreSawCfg</span><span class="o">-&gt;</span><span class="n">reference</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">BLDirectCmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">targetAddr</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">romOffset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">nrOfElements</span><span class="p">,</span> <span class="n">u32</span> <span class="n">timeOut</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">blStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">targetAddr</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FFFF</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">blockbank</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">targetAddr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000FFF</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_BL_MODE__A</span><span class="p">,</span> <span class="n">SIO_BL_MODE_DIRECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_BL_TGT_HDR__A</span><span class="p">,</span> <span class="n">blockbank</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_BL_TGT_ADDR__A</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_BL_SRC_ADDR__A</span><span class="p">,</span> <span class="n">romOffset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_BL_SRC_LEN__A</span><span class="p">,</span> <span class="n">nrOfElements</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_BL_ENABLE__A</span><span class="p">,</span> <span class="n">SIO_BL_ENABLE_ON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeOut</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_BL_STATUS__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blStatus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">blStatus</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">time_is_after_jiffies</span><span class="p">(</span><span class="n">end</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blStatus</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: SIO not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="nl">error2:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ADCSyncMeasurement</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Start measurement */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_COMM_EXEC__A</span><span class="p">,</span> <span class="n">IQM_AF_COMM_EXEC_ACTIVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_START_LOCK__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_PHASE0__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mi">127</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_PHASE1__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mi">127</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_PHASE2__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mi">127</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ADCSynchronization</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ADCSyncMeasurement</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Try sampling on a diffrent edge */</span>
		<span class="n">u16</span> <span class="n">clkNeg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_CLKNEG__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clkNeg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">clkNeg</span> <span class="o">|</span> <span class="n">IQM_AF_CLKNEG_CLKNEGDATA__M</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">IQM_AF_CLKNEG_CLKNEGDATA_CLK_ADC_DATA_POS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clkNeg</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">IQM_AF_CLKNEG_CLKNEGDATA__M</span><span class="p">));</span>
			<span class="n">clkNeg</span> <span class="o">|=</span>
				<span class="n">IQM_AF_CLKNEG_CLKNEGDATA_CLK_ADC_DATA_NEG</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">clkNeg</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">IQM_AF_CLKNEG_CLKNEGDATA__M</span><span class="p">));</span>
			<span class="n">clkNeg</span> <span class="o">|=</span>
				<span class="n">IQM_AF_CLKNEG_CLKNEGDATA_CLK_ADC_DATA_POS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_CLKNEG__A</span><span class="p">,</span> <span class="n">clkNeg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ADCSyncMeasurement</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetFrequencyShifter</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">intermediateFreqkHz</span><span class="p">,</span>
			       <span class="n">s32</span> <span class="n">tunerFreqOffset</span><span class="p">,</span> <span class="n">bool</span> <span class="n">isDTV</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">selectPosImage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rfFreqResidual</span> <span class="o">=</span> <span class="n">tunerFreqOffset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fmFrequencyShift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tunerMirror</span> <span class="o">=</span> <span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_bMirrorFreqSpect</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">adcFreq</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">adcFlip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ifFreqActual</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">samplingFrequency</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_sysClockFreq</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">frequencyShift</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">imageToSelect</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	   Program frequency shifter</span>
<span class="cm">	   No need to account for mirroring on RF</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isDTV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">==</span> <span class="n">OM_QAM_ITU_A</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">==</span> <span class="n">OM_QAM_ITU_C</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">==</span> <span class="n">OM_DVBT</span><span class="p">))</span>
			<span class="n">selectPosImage</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">selectPosImage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tunerMirror</span><span class="p">)</span>
		<span class="cm">/* tuner doesn&#39;t mirror */</span>
		<span class="n">ifFreqActual</span> <span class="o">=</span> <span class="n">intermediateFreqkHz</span> <span class="o">+</span>
		    <span class="n">rfFreqResidual</span> <span class="o">+</span> <span class="n">fmFrequencyShift</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* tuner mirrors */</span>
		<span class="n">ifFreqActual</span> <span class="o">=</span> <span class="n">intermediateFreqkHz</span> <span class="o">-</span>
		    <span class="n">rfFreqResidual</span> <span class="o">-</span> <span class="n">fmFrequencyShift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifFreqActual</span> <span class="o">&gt;</span> <span class="n">samplingFrequency</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* adc mirrors */</span>
		<span class="n">adcFreq</span> <span class="o">=</span> <span class="n">samplingFrequency</span> <span class="o">-</span> <span class="n">ifFreqActual</span><span class="p">;</span>
		<span class="n">adcFlip</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* adc doesn&#39;t mirror */</span>
		<span class="n">adcFreq</span> <span class="o">=</span> <span class="n">ifFreqActual</span><span class="p">;</span>
		<span class="n">adcFlip</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frequencyShift</span> <span class="o">=</span> <span class="n">adcFreq</span><span class="p">;</span>
	<span class="n">imageToSelect</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_rfmirror</span> <span class="o">^</span> <span class="n">tunerMirror</span> <span class="o">^</span>
	    <span class="n">adcFlip</span> <span class="o">^</span> <span class="n">selectPosImage</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_IqmFsRateOfs</span> <span class="o">=</span>
	    <span class="n">Frac28a</span><span class="p">((</span><span class="n">frequencyShift</span><span class="p">),</span> <span class="n">samplingFrequency</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imageToSelect</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_IqmFsRateOfs</span> <span class="o">=</span> <span class="o">~</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_IqmFsRateOfs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Program frequency shifter with tuner offset compensation */</span>
	<span class="cm">/* frequencyShift += tunerFreqOffset; TODO */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write32</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_FS_RATE_OFS_LO__A</span><span class="p">,</span>
			 <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_IqmFsRateOfs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">InitAGC</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">bool</span> <span class="n">isDTV</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ingainTgt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ingainTgtMin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ingainTgtMax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clpCyclen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clpSumMin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clpDirTo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">snsSumMin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">snsSumMax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clpSumMax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">snsDirTo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">kiInnergainMin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ifIaccuHiTgt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ifIaccuHiTgtMin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ifIaccuHiTgtMax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fastClpCtrlDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clpCtrlMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Common settings */</span>
	<span class="n">snsSumMax</span> <span class="o">=</span> <span class="mi">1023</span><span class="p">;</span>
	<span class="n">ifIaccuHiTgtMin</span> <span class="o">=</span> <span class="mi">2047</span><span class="p">;</span>
	<span class="n">clpCyclen</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="n">clpSumMax</span> <span class="o">=</span> <span class="mi">1023</span><span class="p">;</span>

	<span class="cm">/* AGCInit() not available for DVBT; init done in microcode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsQAM</span><span class="p">(</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: %s: mode %d is not DVB-C</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: Analog TV AGC require different settings */</span>

	<span class="cm">/* Standard specific settings */</span>
	<span class="n">clpSumMin</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">clpDirTo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">9</span><span class="p">;</span>
	<span class="n">clpCtrlMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snsSumMin</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">snsDirTo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">9</span><span class="p">;</span>
	<span class="n">kiInnergainMin</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">1030</span><span class="p">;</span>
	<span class="n">ifIaccuHiTgtMax</span> <span class="o">=</span> <span class="mh">0x2380</span><span class="p">;</span>
	<span class="n">ifIaccuHiTgt</span> <span class="o">=</span> <span class="mh">0x2380</span><span class="p">;</span>
	<span class="n">ingainTgtMin</span> <span class="o">=</span> <span class="mh">0x0511</span><span class="p">;</span>
	<span class="n">ingainTgt</span> <span class="o">=</span> <span class="mh">0x0511</span><span class="p">;</span>
	<span class="n">ingainTgtMax</span> <span class="o">=</span> <span class="mi">5119</span><span class="p">;</span>
	<span class="n">fastClpCtrlDelay</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamIfAgcCfg</span><span class="p">.</span><span class="n">FastClipCtrlDelay</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_FAST_CLP_CTRL_DELAY__A</span><span class="p">,</span> <span class="n">fastClpCtrlDelay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CLP_CTRL_MODE__A</span><span class="p">,</span> <span class="n">clpCtrlMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_INGAIN_TGT__A</span><span class="p">,</span> <span class="n">ingainTgt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_INGAIN_TGT_MIN__A</span><span class="p">,</span> <span class="n">ingainTgtMin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_INGAIN_TGT_MAX__A</span><span class="p">,</span> <span class="n">ingainTgtMax</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_IF_IACCU_HI_TGT_MIN__A</span><span class="p">,</span> <span class="n">ifIaccuHiTgtMin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A</span><span class="p">,</span> <span class="n">ifIaccuHiTgtMax</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_IF_IACCU_HI__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_IF_IACCU_LO__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_RF_IACCU_HI__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_RF_IACCU_LO__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CLP_SUM_MAX__A</span><span class="p">,</span> <span class="n">clpSumMax</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_SNS_SUM_MAX__A</span><span class="p">,</span> <span class="n">snsSumMax</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_KI_INNERGAIN_MIN__A</span><span class="p">,</span> <span class="n">kiInnergainMin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_IF_IACCU_HI_TGT__A</span><span class="p">,</span> <span class="n">ifIaccuHiTgt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CLP_CYCLEN__A</span><span class="p">,</span> <span class="n">clpCyclen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_RF_SNS_DEV_MAX__A</span><span class="p">,</span> <span class="mi">1023</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_RF_SNS_DEV_MIN__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">1023</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_FAST_SNS_CTRL_DELAY__A</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_KI_MAXMINGAIN_TH__A</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CLP_SUM_MIN__A</span><span class="p">,</span> <span class="n">clpSumMin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_SNS_SUM_MIN__A</span><span class="p">,</span> <span class="n">snsSumMin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CLP_DIR_TO__A</span><span class="p">,</span> <span class="n">clpDirTo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_SNS_DIR_TO__A</span><span class="p">,</span> <span class="n">snsDirTo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_KI_MINGAIN__A</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_KI_MAXGAIN__A</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_KI_MIN__A</span><span class="p">,</span> <span class="mh">0x0117</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_KI_MAX__A</span><span class="p">,</span> <span class="mh">0x0657</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CLP_SUM__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CLP_CYCCNT__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CLP_DIR_WD__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_CLP_DIR_STP__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_SNS_SUM__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_SNS_CYCCNT__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_SNS_DIR_WD__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_SNS_DIR_STP__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_SNS_CYCLEN__A</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_KI_CYCLEN__A</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Initialize inner-loop KI gain factors */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_KI__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="mh">0x0657</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCU_RAM_AGC_KI_RF__M</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DRXK_KI_RAGC_QAM</span> <span class="o">&lt;&lt;</span> <span class="n">SCU_RAM_AGC_KI_RF__B</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCU_RAM_AGC_KI_IF__M</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DRXK_KI_IAGC_QAM</span> <span class="o">&lt;&lt;</span> <span class="n">SCU_RAM_AGC_KI_IF__B</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_KI__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DVBTQAMGetAccPktErr</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">packetErr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packetErr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_FEC_ACCUM_PKT_FAILURES__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_FEC_ACCUM_PKT_FAILURES__A</span><span class="p">,</span> <span class="n">packetErr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DVBTScCommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">subcmd</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">param0</span><span class="p">,</span> <span class="n">u16</span> <span class="n">param1</span><span class="p">,</span> <span class="n">u16</span> <span class="n">param2</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">param3</span><span class="p">,</span> <span class="n">u16</span> <span class="n">param4</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">curCmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">errCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">retryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">scExec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_COMM_EXEC__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scExec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scExec</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SC is not running */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Wait until sc is ready to receive command */</span>
	<span class="n">retryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_CMD__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">curCmd</span><span class="p">);</span>
		<span class="n">retryCnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">curCmd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">retryCnt</span> <span class="o">&lt;</span> <span class="n">DRXK_MAX_RETRIES</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retryCnt</span> <span class="o">&gt;=</span> <span class="n">DRXK_MAX_RETRIES</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Write sub-command */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* All commands using sub-cmd */</span>
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_PROC_START</span>:
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_SET_PREF_PARAM</span>:
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_PROGRAM_PARAM</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_CMD_ADDR__A</span><span class="p">,</span> <span class="n">subcmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Do nothing */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write needed parameters and the command */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* All commands using 5 parameters */</span>
		<span class="cm">/* All commands using 4 parameters */</span>
		<span class="cm">/* All commands using 3 parameters */</span>
		<span class="cm">/* All commands using 2 parameters */</span>
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_PROC_START</span>:
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_SET_PREF_PARAM</span>:
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_PROGRAM_PARAM</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_PARAM1__A</span><span class="p">,</span> <span class="n">param1</span><span class="p">);</span>
		<span class="cm">/* All commands using 1 parameters */</span>
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_SET_ECHO_TIMING</span>:
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_USER_IO</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_PARAM0__A</span><span class="p">,</span> <span class="n">param0</span><span class="p">);</span>
		<span class="cm">/* All commands using 0 parameters */</span>
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_GET_OP_PARAM</span>:
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_NULL</span>:
		<span class="cm">/* Write command */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_CMD__A</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Unknown command */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Wait until sc is ready processing command */</span>
	<span class="n">retryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_CMD__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">curCmd</span><span class="p">);</span>
		<span class="n">retryCnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">curCmd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">retryCnt</span> <span class="o">&lt;</span> <span class="n">DRXK_MAX_RETRIES</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retryCnt</span> <span class="o">&gt;=</span> <span class="n">DRXK_MAX_RETRIES</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Check for illegal cmd */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_CMD_ADDR__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">errCode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errCode</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* illegal command */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Retreive results parameters from SC */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* All commands yielding 5 results */</span>
		<span class="cm">/* All commands yielding 4 results */</span>
		<span class="cm">/* All commands yielding 3 results */</span>
		<span class="cm">/* All commands yielding 2 results */</span>
		<span class="cm">/* All commands yielding 1 result */</span>
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_USER_IO</span>:
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_GET_OP_PARAM</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_PARAM0__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">param0</span><span class="p">));</span>
		<span class="cm">/* All commands yielding 0 results */</span>
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_SET_ECHO_TIMING</span>:
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_SET_TIMER</span>:
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_PROC_START</span>:
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_SET_PREF_PARAM</span>:
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_PROGRAM_PARAM</span>:
	<span class="k">case</span> <span class="n">OFDM_SC_RA_RAM_CMD_NULL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Unknown command */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>			<span class="cm">/* switch (cmd-&gt;cmd) */</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">PowerUpDVBT</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">DRXPowerMode</span> <span class="n">powerMode</span> <span class="o">=</span> <span class="n">DRX_POWER_UP</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">CtrlPowerMode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">powerMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DVBTCtrlSetIncEnable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">enabled</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_BYPASSDET__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_BYPASSDET__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DEFAULT_FR_THRES_8K     4000</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">DVBTCtrlSetFrEnable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">enabled</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* write mask to 1 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_FR_THRES_8K__A</span><span class="p">,</span>
				   <span class="n">DEFAULT_FR_THRES_8K</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* write mask to 0 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_FR_THRES_8K__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DVBTCtrlSetEchoThreshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">DRXKCfgDvbtEchoThres_t</span> <span class="o">*</span><span class="n">echoThres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_ECHO_THRES__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">echoThres</span><span class="o">-&gt;</span><span class="n">fftMode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRX_FFTMODE_2K</span>:
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OFDM_SC_RA_RAM_ECHO_THRES_2K__M</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">((</span><span class="n">echoThres</span><span class="o">-&gt;</span><span class="n">threshold</span> <span class="o">&lt;&lt;</span>
			<span class="n">OFDM_SC_RA_RAM_ECHO_THRES_2K__B</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="p">(</span><span class="n">OFDM_SC_RA_RAM_ECHO_THRES_2K__M</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRX_FFTMODE_8K</span>:
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OFDM_SC_RA_RAM_ECHO_THRES_8K__M</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">((</span><span class="n">echoThres</span><span class="o">-&gt;</span><span class="n">threshold</span> <span class="o">&lt;&lt;</span>
			<span class="n">OFDM_SC_RA_RAM_ECHO_THRES_8K__B</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="p">(</span><span class="n">OFDM_SC_RA_RAM_ECHO_THRES_8K__M</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_ECHO_THRES__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DVBTCtrlSetSqiSpeed</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">DRXKCfgDvbtSqiSpeed</span> <span class="o">*</span><span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRXK_DVBT_SQI_SPEED_FAST</span>:
	<span class="k">case</span> <span class="n">DRXK_DVBT_SQI_SPEED_MEDIUM</span>:
	<span class="k">case</span> <span class="n">DRXK_DVBT_SQI_SPEED_SLOW</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_FEC_PRE_RS_BER_FILTER_SH__A</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span><span class="n">speed</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm">* \brief Activate DVBT specific presets</span>
<span class="cm">* \param demod instance of demodulator.</span>
<span class="cm">* \return DRXStatus_t.</span>
<span class="cm">*</span>
<span class="cm">* Called in DVBTSetStandard</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">DVBTActivatePresets</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">setincenable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">setfrenable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">DRXKCfgDvbtEchoThres_t</span> <span class="n">echoThres2k</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DRX_FFTMODE_2K</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">DRXKCfgDvbtEchoThres_t</span> <span class="n">echoThres8k</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DRX_FFTMODE_8K</span> <span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">DVBTCtrlSetIncEnable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setincenable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">DVBTCtrlSetFrEnable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setfrenable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">DVBTCtrlSetEchoThreshold</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">echoThres2k</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">DVBTCtrlSetEchoThreshold</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">echoThres8k</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_INGAIN_TGT_MAX__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtIfAgcCfg</span><span class="p">.</span><span class="n">IngainTgtMax</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm">* \brief Initialize channelswitch-independent settings for DVBT.</span>
<span class="cm">* \param demod instance of demodulator.</span>
<span class="cm">* \return DRXStatus_t.</span>
<span class="cm">*</span>
<span class="cm">* For ROM code channel filter taps are loaded from the bootloader. For microcode</span>
<span class="cm">* the DVB-T taps from the drxk_filters.h are used.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetDVBTStandard</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">OperationMode</span> <span class="n">oMode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cmdResult</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">PowerUpDVBT</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="cm">/* added antenna switch */</span>
	<span class="n">SwitchAntennaToDVBT</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="cm">/* send OFDM reset command */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">scu_command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_COMMAND_STANDARD_OFDM</span> <span class="o">|</span> <span class="n">SCU_RAM_COMMAND_CMD_DEMOD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdResult</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* send OFDM setenv command */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">scu_command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_COMMAND_STANDARD_OFDM</span> <span class="o">|</span> <span class="n">SCU_RAM_COMMAND_CMD_DEMOD_SET_ENV</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdResult</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* reset datapath for OFDM, processors first */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">OFDM_SC_COMM_EXEC_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_LC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">OFDM_LC_COMM_EXEC_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_COMM_EXEC__A</span><span class="p">,</span> <span class="n">IQM_COMM_EXEC_B_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* IQM setup */</span>
	<span class="cm">/* synchronize on ofdstate-&gt;m_festart */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_UPD_SEL__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* window size for clipping ADC detection */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_CLP_LEN__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* window size for for sense pre-SAW detection */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_SNS_LEN__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* sense threshold for sense pre-SAW detection */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_AMUX__A</span><span class="p">,</span> <span class="n">IQM_AF_AMUX_SIGNAL2ADC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">SetIqmAf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_AGC_RF__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Impulse noise cruncher setup */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_INC_LCT__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* crunch in IQM_CF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_DET_LCT__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* detect in IQM_CF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_WND_LEN__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* peak detector window length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_RC_STRETCH__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_OUT_ENA__A</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>	<span class="cm">/* enable output 2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_DS_ENA__A</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>	<span class="cm">/* decimate output 2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_SCALE__A</span><span class="p">,</span> <span class="mi">1600</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_SCALE_SH__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* virtual clipping threshold for clipping ADC detection */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_CLP_TH__A</span><span class="p">,</span> <span class="mi">448</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_DATATH__A</span><span class="p">,</span> <span class="mi">495</span><span class="p">);</span>	<span class="cm">/* crunching threshold */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">BLChainCmd</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DRXK_BL_ROM_OFFSET_TAPS_DVBT</span><span class="p">,</span> <span class="n">DRXK_BLCC_NR_ELEMENTS_TAPS</span><span class="p">,</span> <span class="n">DRXK_BLC_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_PKDTH__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* peak detector threshold */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_POW_MEAS_LEN__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* enable power measurement interrupt */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_COMM_INT_MSK__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_COMM_EXEC__A</span><span class="p">,</span> <span class="n">IQM_COMM_EXEC_B_ACTIVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* IQM will not be reset from here, sync ADC and update/init AGC */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ADCSynchronization</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">SetPreSaw</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtPreSawCfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Halt SCU to enable safe non-atomic accesses */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC_HOLD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">SetAgcRf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtRfAgcCfg</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">SetAgcIf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtIfAgcCfg</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Set Noise Estimation notch width and enable DC fix */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_CONFIG__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_CONFIG_NE_FIX_ENABLE__M</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_CONFIG__A</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Activate SCU to enable SCU commands */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC_ACTIVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DRXK_A3_ROM_CODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* AGCInit() is not done for DVBT, so set agcFastClipCtrlDelay  */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_AGC_FAST_CLP_CTRL_DELAY__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_dvbtIfAgcCfg</span><span class="p">.</span><span class="n">FastClipCtrlDelay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* OFDM_SC setup */</span>
<span class="cp">#ifdef COMPILE_FOR_NONRT</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_BE_OPT_DELAY__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_BE_OPT_INIT_DELAY__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* FEC setup */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_DI_INPUT_CTL__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* OFDM input */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


<span class="cp">#ifdef COMPILE_FOR_NONRT</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_RS_MEASUREMENT_PERIOD__A</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_RS_MEASUREMENT_PERIOD__A</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_RS_MEASUREMENT_PRESCALE__A</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Setup MPEG bus */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSDtoSetup</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OM_DVBT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* Set DVBT Presets */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">DVBTActivatePresets</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*============================================================================*/</span>
<span class="cm">/**</span>
<span class="cm">* \brief Start dvbt demodulating for channel.</span>
<span class="cm">* \param demod instance of demodulator.</span>
<span class="cm">* \return DRXStatus_t.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">DVBTStart</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">param1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/* DRXKOfdmScCmd_t scCmd; */</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Start correct processes to get in lock */</span>
	<span class="cm">/* DRXK: OFDM_SC_RA_RAM_PROC_LOCKTRACK is no longer in mapfile! */</span>
	<span class="n">param1</span> <span class="o">=</span> <span class="n">OFDM_SC_RA_RAM_LOCKTRACK_MIN</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">DVBTScCommand</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_CMD_PROC_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_SW_EVENT_RUN_NMASK__M</span><span class="p">,</span> <span class="n">param1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* Start FEC OC */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSStart</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">FEC_COMM_EXEC_ACTIVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm">* \brief Set up dvbt demodulator for channel.</span>
<span class="cm">* \param demod instance of demodulator.</span>
<span class="cm">* \return DRXStatus_t.</span>
<span class="cm">* // original DVBTSetChannel()</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetDVBT</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">IntermediateFreqkHz</span><span class="p">,</span>
		   <span class="n">s32</span> <span class="n">tunerFreqOffset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cmdResult</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">transmissionParams</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">operationMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iqmRcRateOfs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bandwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">param1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;IF =%d, TFO = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IntermediateFreqkHz</span><span class="p">,</span> <span class="n">tunerFreqOffset</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">scu_command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_COMMAND_STANDARD_OFDM</span> <span class="o">|</span> <span class="n">SCU_RAM_COMMAND_CMD_DEMOD_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdResult</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Halt SCU to enable safe non-atomic accesses */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC_HOLD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Stop processors */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">OFDM_SC_COMM_EXEC_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_LC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">OFDM_LC_COMM_EXEC_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Mandatory fix, always stop CP, required to set spl offset back to</span>
<span class="cm">		hardware default (is set to 0 by ucode during pilot detection */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_CP_COMM_EXEC__A</span><span class="p">,</span> <span class="n">OFDM_CP_COMM_EXEC_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*== Write channel settings to device =====================================*/</span>

	<span class="cm">/* mode */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_AUTO</span>:
	<span class="nl">default:</span>
		<span class="n">operationMode</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_AUTO_MODE__M</span><span class="p">;</span>
		<span class="cm">/* fall through , try first guess DRX_FFTMODE_8K */</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_MODE_8K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_MODE_2K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* guard */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">guard_interval</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_AUTO</span>:
		<span class="n">operationMode</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_AUTO_GUARD__M</span><span class="p">;</span>
		<span class="cm">/* fall through , try first guess DRX_GUARD_1DIV4 */</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_4</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_GUARD_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_32</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_GUARD_32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_16</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_GUARD_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_8</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_GUARD_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* hierarchy */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">hierarchy</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HIERARCHY_AUTO</span>:
	<span class="k">case</span> <span class="n">HIERARCHY_NONE</span>:
	<span class="nl">default:</span>
		<span class="n">operationMode</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_AUTO_HIER__M</span><span class="p">;</span>
		<span class="cm">/* fall through , try first guess SC_RA_RAM_OP_PARAM_HIER_NO */</span>
		<span class="cm">/* transmissionParams |= OFDM_SC_RA_RAM_OP_PARAM_HIER_NO; */</span>
		<span class="cm">/* break; */</span>
	<span class="k">case</span> <span class="n">HIERARCHY_1</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_HIER_A1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HIERARCHY_2</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_HIER_A2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HIERARCHY_4</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_HIER_A4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* modulation */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QAM_AUTO</span>:
	<span class="nl">default:</span>
		<span class="n">operationMode</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_AUTO_CONST__M</span><span class="p">;</span>
		<span class="cm">/* fall through , try first guess DRX_CONSTELLATION_QAM64 */</span>
	<span class="k">case</span> <span class="n">QAM_64</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_CONST_QAM64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QPSK</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_CONST_QPSK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_16</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_CONST_QAM16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* No hierachical channels support in BDA */</span>
<span class="c">	/* Priority (only for hierarchical channels) */</span>
<span class="c">	switch (channel-&gt;priority) {</span>
<span class="c">	case DRX_PRIORITY_LOW:</span>
<span class="c">		transmissionParams |= OFDM_SC_RA_RAM_OP_PARAM_PRIO_LO;</span>
<span class="c">		WR16(devAddr, OFDM_EC_SB_PRIOR__A,</span>
<span class="c">			OFDM_EC_SB_PRIOR_LO);</span>
<span class="c">		break;</span>
<span class="c">	case DRX_PRIORITY_HIGH:</span>
<span class="c">		transmissionParams |= OFDM_SC_RA_RAM_OP_PARAM_PRIO_HI;</span>
<span class="c">		WR16(devAddr, OFDM_EC_SB_PRIOR__A,</span>
<span class="c">			OFDM_EC_SB_PRIOR_HI));</span>
<span class="c">		break;</span>
<span class="c">	case DRX_PRIORITY_UNKNOWN:	/* fall through */</span>
<span class="c">	default:</span>
<span class="c">		status = -EINVAL;</span>
<span class="c">		goto error;</span>
<span class="c">	}</span>
<span class="cp">#else</span>
	<span class="cm">/* Set Priorty high */</span>
	<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_PRIO_HI</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_EC_SB_PRIOR__A</span><span class="p">,</span> <span class="n">OFDM_EC_SB_PRIOR_HI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* coderate */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">code_rate_HP</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FEC_AUTO</span>:
	<span class="nl">default:</span>
		<span class="n">operationMode</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_AUTO_RATE__M</span><span class="p">;</span>
		<span class="cm">/* fall through , try first guess DRX_CODERATE_2DIV3 */</span>
	<span class="k">case</span> <span class="n">FEC_2_3</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_RATE_2_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_1_2</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_RATE_1_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_3_4</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_RATE_3_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_5_6</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_RATE_5_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_7_8</span>:
		<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">OFDM_SC_RA_RAM_OP_PARAM_RATE_7_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SAW filter selection: normaly not necesarry, but if wanted</span>
<span class="cm">		the application can select a SAW filter via the driver by using UIOs */</span>
	<span class="cm">/* First determine real bandwidth (Hz) */</span>
	<span class="cm">/* Also set delay for impulse noise cruncher */</span>
	<span class="cm">/* Also set parameters for EC_OC fix, note EC_OC_REG_TMD_HIL_MAR is changed</span>
<span class="cm">		by SC for fix for some 8K,1/8 guard but is restored by InitEC and ResetEC</span>
<span class="cm">		functions */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">bandwidth_hz</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">8000000</span><span class="p">;</span>
		<span class="cm">/* fall though */</span>
	<span class="k">case</span> <span class="mi">8000000</span>:
		<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">DRXK_BANDWIDTH_8MHZ_IN_HZ</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_SRMM_FIX_FACT_8K__A</span><span class="p">,</span> <span class="mi">3052</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="cm">/* cochannel protection for PAL 8 MHz */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_NI_INIT_8K_PER_LEFT__A</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_NI_INIT_8K_PER_RIGHT__A</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_NI_INIT_2K_PER_LEFT__A</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_NI_INIT_2K_PER_RIGHT__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7000000</span>:
		<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">DRXK_BANDWIDTH_7MHZ_IN_HZ</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_SRMM_FIX_FACT_8K__A</span><span class="p">,</span> <span class="mi">3491</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="cm">/* cochannel protection for PAL 7 MHz */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_NI_INIT_8K_PER_LEFT__A</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_NI_INIT_8K_PER_RIGHT__A</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_NI_INIT_2K_PER_LEFT__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_NI_INIT_2K_PER_RIGHT__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6000000</span>:
		<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">DRXK_BANDWIDTH_6MHZ_IN_HZ</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_SRMM_FIX_FACT_8K__A</span><span class="p">,</span> <span class="mi">4073</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="cm">/* cochannel protection for NTSC 6 MHz */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_NI_INIT_8K_PER_LEFT__A</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_NI_INIT_8K_PER_RIGHT__A</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_NI_INIT_2K_PER_LEFT__A</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_NI_INIT_2K_PER_RIGHT__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iqmRcRateOfs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Now compute IQM_RC_RATE_OFS</span>
<span class="cm">			(((SysFreq/BandWidth)/2)/2) -1) * 2^23)</span>
<span class="cm">			=&gt;</span>
<span class="cm">			((SysFreq / BandWidth) * (2^21)) - (2^23)</span>
<span class="cm">			*/</span>
		<span class="cm">/* (SysFreq / BandWidth) * (2^28)  */</span>
		<span class="cm">/* assert (MAX(sysClk)/MIN(bandwidth) &lt; 16)</span>
<span class="cm">			=&gt; assert(MAX(sysClk) &lt; 16*MIN(bandwidth))</span>
<span class="cm">			=&gt; assert(109714272 &gt; 48000000) = true so Frac 28 can be used  */</span>
		<span class="n">iqmRcRateOfs</span> <span class="o">=</span> <span class="n">Frac28a</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span>
					<span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_sysClockFreq</span> <span class="o">*</span>
						<span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">),</span> <span class="n">bandwidth</span><span class="p">);</span>
		<span class="cm">/* (SysFreq / BandWidth) * (2^21), rounding before truncating  */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">iqmRcRateOfs</span> <span class="o">&amp;</span> <span class="mh">0x7fL</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="n">iqmRcRateOfs</span> <span class="o">+=</span> <span class="mh">0x80L</span><span class="p">;</span>
		<span class="n">iqmRcRateOfs</span> <span class="o">=</span> <span class="n">iqmRcRateOfs</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="cm">/* ((SysFreq / BandWidth) * (2^21)) - (2^23)  */</span>
		<span class="n">iqmRcRateOfs</span> <span class="o">=</span> <span class="n">iqmRcRateOfs</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iqmRcRateOfs</span> <span class="o">&amp;=</span>
		<span class="p">((((</span><span class="n">u32</span><span class="p">)</span> <span class="n">IQM_RC_RATE_OFS_HI__M</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">IQM_RC_RATE_OFS_LO__W</span><span class="p">)</span> <span class="o">|</span> <span class="n">IQM_RC_RATE_OFS_LO__M</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write32</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_RC_RATE_OFS_LO__A</span><span class="p">,</span> <span class="n">iqmRcRateOfs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Bandwidth setting done */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	status = DVBTSetFrequencyShift(demod, channel, tunerOffset);</span>
<span class="c">	if (status &lt; 0)</span>
<span class="c">		goto error;</span>
<span class="cp">#endif</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">SetFrequencyShifter</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IntermediateFreqkHz</span><span class="p">,</span> <span class="n">tunerFreqOffset</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*== Start SC, write channel settings to SC ===============================*/</span>

	<span class="cm">/* Activate SCU to enable SCU commands */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC_ACTIVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Enable SC after setting all other parameters */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_COMM_STATE__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_COMM_EXEC__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="n">status</span> <span class="o">=</span> <span class="n">scu_command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_COMMAND_STANDARD_OFDM</span> <span class="o">|</span> <span class="n">SCU_RAM_COMMAND_CMD_DEMOD_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdResult</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Write SC parameter registers, set all AUTO flags in operation mode */</span>
	<span class="n">param1</span> <span class="o">=</span> <span class="p">(</span><span class="n">OFDM_SC_RA_RAM_OP_AUTO_MODE__M</span> <span class="o">|</span>
			<span class="n">OFDM_SC_RA_RAM_OP_AUTO_GUARD__M</span> <span class="o">|</span>
			<span class="n">OFDM_SC_RA_RAM_OP_AUTO_CONST__M</span> <span class="o">|</span>
			<span class="n">OFDM_SC_RA_RAM_OP_AUTO_HIER__M</span> <span class="o">|</span>
			<span class="n">OFDM_SC_RA_RAM_OP_AUTO_RATE__M</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">DVBTScCommand</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_CMD_SET_PREF_PARAM</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">transmissionParams</span><span class="p">,</span> <span class="n">param1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DRXK_A3_ROM_CODE</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">DVBTCtrlSetSqiSpeed</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_sqiSpeed</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm">* \brief Retreive lock status .</span>
<span class="cm">* \param demod    Pointer to demodulator instance.</span>
<span class="cm">* \param lockStat Pointer to lock status structure.</span>
<span class="cm">* \return DRXStatus_t.</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">GetDVBTLockStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pLockStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">mpeg_lock_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">OFDM_SC_RA_RAM_LOCK_MPEG__M</span> <span class="o">|</span>
				    <span class="n">OFDM_SC_RA_RAM_LOCK_FEC__M</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">fec_lock_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">OFDM_SC_RA_RAM_LOCK_FEC__M</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">demod_lock_mask</span> <span class="o">=</span> <span class="n">OFDM_SC_RA_RAM_LOCK_DEMOD__M</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">ScRaRamLock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ScCommExec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">=</span> <span class="n">NOT_LOCKED</span><span class="p">;</span>
	<span class="cm">/* driver 0.9.0 */</span>
	<span class="cm">/* Check if SC is running */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_COMM_EXEC__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ScCommExec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ScCommExec</span> <span class="o">==</span> <span class="n">OFDM_SC_COMM_EXEC_STOP</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OFDM_SC_RA_RAM_LOCK__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ScRaRamLock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ScRaRamLock</span> <span class="o">&amp;</span> <span class="n">mpeg_lock_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">mpeg_lock_mask</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">=</span> <span class="n">MPEG_LOCK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ScRaRamLock</span> <span class="o">&amp;</span> <span class="n">fec_lock_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">fec_lock_mask</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">=</span> <span class="n">FEC_LOCK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ScRaRamLock</span> <span class="o">&amp;</span> <span class="n">demod_lock_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">demod_lock_mask</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">=</span> <span class="n">DEMOD_LOCK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ScRaRamLock</span> <span class="o">&amp;</span> <span class="n">OFDM_SC_RA_RAM_LOCK_NODVBT__M</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">=</span> <span class="n">NEVER_LOCK</span><span class="p">;</span>
<span class="nl">end:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">PowerUpQAM</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">DRXPowerMode</span> <span class="n">powerMode</span> <span class="o">=</span> <span class="n">DRXK_POWER_DOWN_OFDM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">CtrlPowerMode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">powerMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/** Power Down QAM */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">PowerDownQAM</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmdResult</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">SCU_COMM_EXEC_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">			STOP demodulator</span>
<span class="cm">			QAM and HW blocks</span>
<span class="cm">			*/</span>
		<span class="cm">/* stop all comstate-&gt;m_exec */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_COMM_EXEC__A</span><span class="p">,</span> <span class="n">QAM_COMM_EXEC_STOP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">scu_command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_COMMAND_STANDARD_QAM</span> <span class="o">|</span> <span class="n">SCU_RAM_COMMAND_CMD_DEMOD_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdResult</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* powerdown AFE                   */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">SetIqmAf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm">* \brief Setup of the QAM Measurement intervals for signal quality</span>
<span class="cm">* \param demod instance of demod.</span>
<span class="cm">* \param modulation current modulation.</span>
<span class="cm">* \return DRXStatus_t.</span>
<span class="cm">*</span>
<span class="cm">*  NOTE:</span>
<span class="cm">*  Take into account that for certain settings the errorcounters can overflow.</span>
<span class="cm">*  The implementation does not check this.</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetQAMMeasurement</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">EDrxkConstellation</span> <span class="n">modulation</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">symbolRate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fecBitsDesired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* BER accounting period */</span>
	<span class="n">u32</span> <span class="n">fecRsPeriodTotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Total period */</span>
	<span class="n">u16</span> <span class="n">fecRsPrescale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* ReedSolomon Measurement Prescale */</span>
	<span class="n">u16</span> <span class="n">fecRsPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Value for corresponding I2C register */</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">fecRsPrescale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* fecBitsDesired = symbolRate [kHz] *</span>
<span class="cm">		FrameLenght [ms] *</span>
<span class="cm">		(modulation + 1) *</span>
<span class="cm">		SyncLoss (== 1) *</span>
<span class="cm">		ViterbiLoss (==1)</span>
<span class="cm">		*/</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRX_CONSTELLATION_QAM16</span>:
		<span class="n">fecBitsDesired</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">symbolRate</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRX_CONSTELLATION_QAM32</span>:
		<span class="n">fecBitsDesired</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">symbolRate</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRX_CONSTELLATION_QAM64</span>:
		<span class="n">fecBitsDesired</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">symbolRate</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRX_CONSTELLATION_QAM128</span>:
		<span class="n">fecBitsDesired</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">symbolRate</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRX_CONSTELLATION_QAM256</span>:
		<span class="n">fecBitsDesired</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">symbolRate</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">fecBitsDesired</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* symbolRate [Hz] -&gt; symbolRate [kHz]  */</span>
	<span class="n">fecBitsDesired</span> <span class="o">*=</span> <span class="mi">500</span><span class="p">;</span>	<span class="cm">/* meas. period [ms] */</span>

	<span class="cm">/* Annex A/C: bits/RsPeriod = 204 * 8 = 1632 */</span>
	<span class="cm">/* fecRsPeriodTotal = fecBitsDesired / 1632 */</span>
	<span class="n">fecRsPeriodTotal</span> <span class="o">=</span> <span class="p">(</span><span class="n">fecBitsDesired</span> <span class="o">/</span> <span class="mi">1632UL</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* roughly ceil */</span>

	<span class="cm">/* fecRsPeriodTotal =  fecRsPrescale * fecRsPeriod  */</span>
	<span class="n">fecRsPrescale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">fecRsPeriodTotal</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fecRsPrescale</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Divide by zero (though impossible) */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fecRsPeriod</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">fecRsPeriodTotal</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">fecRsPrescale</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">fecRsPrescale</span><span class="p">;</span>

	<span class="cm">/* write corresponding registers */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_RS_MEASUREMENT_PERIOD__A</span><span class="p">,</span> <span class="n">fecRsPeriod</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_RS_MEASUREMENT_PRESCALE__A</span><span class="p">,</span> <span class="n">fecRsPrescale</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_OC_SNC_FAIL_PERIOD__A</span><span class="p">,</span> <span class="n">fecRsPeriod</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetQAM16</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* QAM Equalizer Setup */</span>
	<span class="cm">/* Equalizer */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD0__A</span><span class="p">,</span> <span class="mi">13517</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD1__A</span><span class="p">,</span> <span class="mi">13517</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD2__A</span><span class="p">,</span> <span class="mi">13517</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD3__A</span><span class="p">,</span> <span class="mi">13517</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD4__A</span><span class="p">,</span> <span class="mi">13517</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD5__A</span><span class="p">,</span> <span class="mi">13517</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* Decision Feedback Equalizer */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN0__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN1__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN2__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN3__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN4__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN5__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_HWM__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_AWM__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_LWM__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* QAM Slicer Settings */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_SL_SIG_POWER__A</span><span class="p">,</span> <span class="n">DRXK_QAM_SL_SIG_POWER_QAM16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* QAM Loop Controller Coeficients */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CA_FINE__A</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CA_COARSE__A</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_FINE__A</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_MEDIUM__A</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_COARSE__A</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_FINE__A</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_MEDIUM__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_COARSE__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_MEDIUM__A</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_COARSE__A</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_MEDIUM__A</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_COARSE__A</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_FINE__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_MEDIUM__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_COARSE__A</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_MEDIUM__A</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_COARSE__A</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM State Machine (FSM) Thresholds */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RTH__A</span><span class="p">,</span> <span class="mi">140</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_FTH__A</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_CTH__A</span><span class="p">,</span> <span class="mi">95</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_PTH__A</span><span class="p">,</span> <span class="mi">120</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_QTH__A</span><span class="p">,</span> <span class="mi">230</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_MTH__A</span><span class="p">,</span> <span class="mi">105</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RATE_LIM__A</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_COUNT_LIM__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_FREQ_LIM__A</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM FSM Tracking Parameters */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">220</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">25</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">65</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">127</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm">* \brief QAM32 specific setup</span>
<span class="cm">* \param demod instance of demod.</span>
<span class="cm">* \return DRXStatus_t.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetQAM32</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* QAM Equalizer Setup */</span>
	<span class="cm">/* Equalizer */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD0__A</span><span class="p">,</span> <span class="mi">6707</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD1__A</span><span class="p">,</span> <span class="mi">6707</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD2__A</span><span class="p">,</span> <span class="mi">6707</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD3__A</span><span class="p">,</span> <span class="mi">6707</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD4__A</span><span class="p">,</span> <span class="mi">6707</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD5__A</span><span class="p">,</span> <span class="mi">6707</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Decision Feedback Equalizer */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN0__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN1__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN2__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN3__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN4__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN5__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_HWM__A</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_AWM__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_LWM__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* QAM Slicer Settings */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_SL_SIG_POWER__A</span><span class="p">,</span> <span class="n">DRXK_QAM_SL_SIG_POWER_QAM32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM Loop Controller Coeficients */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CA_FINE__A</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CA_COARSE__A</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_FINE__A</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_MEDIUM__A</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_COARSE__A</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_FINE__A</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_MEDIUM__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_COARSE__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_MEDIUM__A</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_COARSE__A</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_MEDIUM__A</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_COARSE__A</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_FINE__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_MEDIUM__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_COARSE__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_MEDIUM__A</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_COARSE__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM State Machine (FSM) Thresholds */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RTH__A</span><span class="p">,</span> <span class="mi">90</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_FTH__A</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_CTH__A</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_PTH__A</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_QTH__A</span><span class="p">,</span> <span class="mi">170</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_MTH__A</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RATE_LIM__A</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_COUNT_LIM__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_FREQ_LIM__A</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM FSM Tracking Parameters */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">140</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">26</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">56</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">86</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm">* \brief QAM64 specific setup</span>
<span class="cm">* \param demod instance of demod.</span>
<span class="cm">* \return DRXStatus_t.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetQAM64</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* QAM Equalizer Setup */</span>
	<span class="cm">/* Equalizer */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD0__A</span><span class="p">,</span> <span class="mi">13336</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD1__A</span><span class="p">,</span> <span class="mi">12618</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD2__A</span><span class="p">,</span> <span class="mi">11988</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD3__A</span><span class="p">,</span> <span class="mi">13809</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD4__A</span><span class="p">,</span> <span class="mi">13809</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD5__A</span><span class="p">,</span> <span class="mi">15609</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Decision Feedback Equalizer */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN0__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN1__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN2__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN3__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN4__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN5__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_HWM__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_AWM__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_LWM__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* QAM Slicer Settings */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_SL_SIG_POWER__A</span><span class="p">,</span> <span class="n">DRXK_QAM_SL_SIG_POWER_QAM64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM Loop Controller Coeficients */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CA_FINE__A</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CA_COARSE__A</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_FINE__A</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_MEDIUM__A</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_COARSE__A</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_FINE__A</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_MEDIUM__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_COARSE__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_MEDIUM__A</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_COARSE__A</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_MEDIUM__A</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_COARSE__A</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_FINE__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_MEDIUM__A</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_COARSE__A</span><span class="p">,</span> <span class="mi">48</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_MEDIUM__A</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_COARSE__A</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM State Machine (FSM) Thresholds */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RTH__A</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_FTH__A</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_CTH__A</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_PTH__A</span><span class="p">,</span> <span class="mi">110</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_QTH__A</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_MTH__A</span><span class="p">,</span> <span class="mi">95</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RATE_LIM__A</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_COUNT_LIM__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_FREQ_LIM__A</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM FSM Tracking Parameters */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">141</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">15</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">45</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">80</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm">* \brief QAM128 specific setup</span>
<span class="cm">* \param demod: instance of demod.</span>
<span class="cm">* \return DRXStatus_t.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetQAM128</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* QAM Equalizer Setup */</span>
	<span class="cm">/* Equalizer */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD0__A</span><span class="p">,</span> <span class="mi">6564</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD1__A</span><span class="p">,</span> <span class="mi">6598</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD2__A</span><span class="p">,</span> <span class="mi">6394</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD3__A</span><span class="p">,</span> <span class="mi">6409</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD4__A</span><span class="p">,</span> <span class="mi">6656</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD5__A</span><span class="p">,</span> <span class="mi">7238</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Decision Feedback Equalizer */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN0__A</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN1__A</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN2__A</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN3__A</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN4__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN5__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_HWM__A</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_AWM__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_LWM__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM Slicer Settings */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_SL_SIG_POWER__A</span><span class="p">,</span> <span class="n">DRXK_QAM_SL_SIG_POWER_QAM128</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM Loop Controller Coeficients */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CA_FINE__A</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CA_COARSE__A</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_FINE__A</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_MEDIUM__A</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_COARSE__A</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_FINE__A</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_MEDIUM__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_COARSE__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_MEDIUM__A</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_COARSE__A</span><span class="p">,</span> <span class="mi">120</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_MEDIUM__A</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_COARSE__A</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_FINE__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_MEDIUM__A</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_COARSE__A</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_MEDIUM__A</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_COARSE__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM State Machine (FSM) Thresholds */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RTH__A</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_FTH__A</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_CTH__A</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_PTH__A</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_QTH__A</span><span class="p">,</span> <span class="mi">140</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_MTH__A</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RATE_LIM__A</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_COUNT_LIM__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_FREQ_LIM__A</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* QAM FSM Tracking Parameters */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">65</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">23</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm">* \brief QAM256 specific setup</span>
<span class="cm">* \param demod: instance of demod.</span>
<span class="cm">* \return DRXStatus_t.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetQAM256</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* QAM Equalizer Setup */</span>
	<span class="cm">/* Equalizer */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD0__A</span><span class="p">,</span> <span class="mi">11502</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD1__A</span><span class="p">,</span> <span class="mi">12084</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD2__A</span><span class="p">,</span> <span class="mi">12543</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD3__A</span><span class="p">,</span> <span class="mi">12931</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD4__A</span><span class="p">,</span> <span class="mi">13629</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_EQ_CMA_RAD5__A</span><span class="p">,</span> <span class="mi">15385</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Decision Feedback Equalizer */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN0__A</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN1__A</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN2__A</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN3__A</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN4__A</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_DQ_QUAL_FUN5__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_HWM__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_AWM__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SYNC_LWM__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* QAM Slicer Settings */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_SL_SIG_POWER__A</span><span class="p">,</span> <span class="n">DRXK_QAM_SL_SIG_POWER_QAM256</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM Loop Controller Coeficients */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CA_FINE__A</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CA_COARSE__A</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_FINE__A</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_MEDIUM__A</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EP_COARSE__A</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_FINE__A</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_MEDIUM__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_EI_COARSE__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_MEDIUM__A</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CP_COARSE__A</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_MEDIUM__A</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CI_COARSE__A</span><span class="p">,</span> <span class="mi">125</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_FINE__A</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_MEDIUM__A</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF_COARSE__A</span><span class="p">,</span> <span class="mi">48</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_FINE__A</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_MEDIUM__A</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_LC_CF1_COARSE__A</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM State Machine (FSM) Thresholds */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RTH__A</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_FTH__A</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_CTH__A</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_PTH__A</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_QTH__A</span><span class="p">,</span> <span class="mi">150</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_MTH__A</span><span class="p">,</span> <span class="mi">110</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RATE_LIM__A</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_COUNT_LIM__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_FREQ_LIM__A</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>


	<span class="cm">/* QAM FSM Tracking Parameters */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">74</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">18</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">13</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">8</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*============================================================================*/</span>
<span class="cm">/**</span>
<span class="cm">* \brief Reset QAM block.</span>
<span class="cm">* \param demod:   instance of demod.</span>
<span class="cm">* \param channel: pointer to channel data.</span>
<span class="cm">* \return DRXStatus_t.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">QAMResetQAM</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmdResult</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Stop QAM comstate-&gt;m_exec */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_COMM_EXEC__A</span><span class="p">,</span> <span class="n">QAM_COMM_EXEC_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">scu_command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_COMMAND_STANDARD_QAM</span> <span class="o">|</span> <span class="n">SCU_RAM_COMMAND_CMD_DEMOD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdResult</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm">* \brief Set QAM symbolrate.</span>
<span class="cm">* \param demod:   instance of demod.</span>
<span class="cm">* \param channel: pointer to channel data.</span>
<span class="cm">* \return DRXStatus_t.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">QAMSetSymbolrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">adcFrequency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">symbFreq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iqmRcRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ratesel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lcSymbRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Select &amp; calculate correct IQM rate */</span>
	<span class="n">adcFrequency</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_sysClockFreq</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">ratesel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* printk(KERN_DEBUG &quot;drxk: SR %d\n&quot;, state-&gt;props.symbol_rate); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">symbol_rate</span> <span class="o">&lt;=</span> <span class="mi">1188750</span><span class="p">)</span>
		<span class="n">ratesel</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">symbol_rate</span> <span class="o">&lt;=</span> <span class="mi">2377500</span><span class="p">)</span>
		<span class="n">ratesel</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">symbol_rate</span> <span class="o">&lt;=</span> <span class="mi">4755000</span><span class="p">)</span>
		<span class="n">ratesel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_FD_RATESEL__A</span><span class="p">,</span> <span class="n">ratesel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">		IqmRcRate = ((Fadc / (symbolrate * (4&lt;&lt;ratesel))) - 1) * (1&lt;&lt;23)</span>
<span class="cm">		*/</span>
	<span class="n">symbFreq</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">symbol_rate</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ratesel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">symbFreq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Divide by zero */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iqmRcRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">adcFrequency</span> <span class="o">/</span> <span class="n">symbFreq</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">Frac28a</span><span class="p">((</span><span class="n">adcFrequency</span> <span class="o">%</span> <span class="n">symbFreq</span><span class="p">),</span> <span class="n">symbFreq</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write32</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_RC_RATE_OFS_LO__A</span><span class="p">,</span> <span class="n">iqmRcRate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_iqmRcRate</span> <span class="o">=</span> <span class="n">iqmRcRate</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">		LcSymbFreq = round (.125 *  symbolrate / adcFreq * (1&lt;&lt;15))</span>
<span class="cm">		*/</span>
	<span class="n">symbFreq</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">symbol_rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adcFrequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Divide by zero */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lcSymbRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">symbFreq</span> <span class="o">/</span> <span class="n">adcFrequency</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">Frac28a</span><span class="p">((</span><span class="n">symbFreq</span> <span class="o">%</span> <span class="n">adcFrequency</span><span class="p">),</span> <span class="n">adcFrequency</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcSymbRate</span> <span class="o">&gt;</span> <span class="mi">511</span><span class="p">)</span>
		<span class="n">lcSymbRate</span> <span class="o">=</span> <span class="mi">511</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_SYMBOL_FREQ__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">lcSymbRate</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm">* \brief Get QAM lock status.</span>
<span class="cm">* \param demod:   instance of demod.</span>
<span class="cm">* \param channel: pointer to channel data.</span>
<span class="cm">* \return DRXStatus_t.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">GetQAMLockStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pLockStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">Result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">=</span> <span class="n">NOT_LOCKED</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">scu_command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
			<span class="n">SCU_RAM_COMMAND_STANDARD_QAM</span> <span class="o">|</span>
			<span class="n">SCU_RAM_COMMAND_CMD_DEMOD_GET_LOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			<span class="n">Result</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: %s status = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">SCU_RAM_QAM_LOCKED_LOCKED_DEMOD_LOCKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 0x0000 NOT LOCKED */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">SCU_RAM_QAM_LOCKED_LOCKED_LOCKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 0x4000 DEMOD LOCKED */</span>
		<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">=</span> <span class="n">DEMOD_LOCK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">SCU_RAM_QAM_LOCKED_LOCKED_NEVER_LOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 0x8000 DEMOD + FEC LOCKED (system lock) */</span>
		<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">=</span> <span class="n">MPEG_LOCK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* 0xC000 NEVER LOCKED */</span>
		<span class="cm">/* (system will never be able to lock to the signal) */</span>
		<span class="cm">/* TODO: check this, intermediate &amp; standard specific lock states are not</span>
<span class="cm">		   taken into account here */</span>
		<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">=</span> <span class="n">NEVER_LOCK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define QAM_MIRROR__M         0x03</span>
<span class="cp">#define QAM_MIRROR_NORMAL     0x00</span>
<span class="cp">#define QAM_MIRRORED          0x01</span>
<span class="cp">#define QAM_MIRROR_AUTO_ON    0x02</span>
<span class="cp">#define QAM_LOCKRANGE__M      0x10</span>
<span class="cp">#define QAM_LOCKRANGE_NORMAL  0x10</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetQAM</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">IntermediateFreqkHz</span><span class="p">,</span>
		  <span class="n">s32</span> <span class="n">tunerFreqOffset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">setParamParameters</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u16</span> <span class="n">cmdResult</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * STEP 1: reset demodulator</span>
<span class="cm">	 *	resets FEC DI and FEC RS</span>
<span class="cm">	 *	resets QAM block</span>
<span class="cm">	 *	resets SCU variables</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_DI_COMM_EXEC__A</span><span class="p">,</span> <span class="n">FEC_DI_COMM_EXEC_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_RS_COMM_EXEC__A</span><span class="p">,</span> <span class="n">FEC_RS_COMM_EXEC_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">QAMResetQAM</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * STEP 2: configure demodulator</span>
<span class="cm">	 *	-set params; resets IQM,QAM,FEC HW; initializes some</span>
<span class="cm">	 *       SCU variables</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">QAMSetSymbolrate</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Set params */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QAM_256</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_Constellation</span> <span class="o">=</span> <span class="n">DRX_CONSTELLATION_QAM256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_AUTO</span>:
	<span class="k">case</span> <span class="n">QAM_64</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_Constellation</span> <span class="o">=</span> <span class="n">DRX_CONSTELLATION_QAM64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_16</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_Constellation</span> <span class="o">=</span> <span class="n">DRX_CONSTELLATION_QAM16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_32</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_Constellation</span> <span class="o">=</span> <span class="n">DRX_CONSTELLATION_QAM32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_128</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_Constellation</span> <span class="o">=</span> <span class="n">DRX_CONSTELLATION_QAM128</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">setParamParameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_Constellation</span><span class="p">;</span>	<span class="cm">/* modulation     */</span>
	<span class="n">setParamParameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DRXK_QAM_I12_J17</span><span class="p">;</span>	<span class="cm">/* interleave mode   */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">==</span> <span class="n">OM_QAM_ITU_C</span><span class="p">)</span>
		<span class="n">setParamParameters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">QAM_TOP_ANNEX_C</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">setParamParameters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">QAM_TOP_ANNEX_A</span><span class="p">;</span>
	<span class="n">setParamParameters</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">QAM_MIRROR_AUTO_ON</span><span class="p">);</span>
	<span class="cm">/* Env parameters */</span>
	<span class="cm">/* check for LOCKRANGE Extented */</span>
	<span class="cm">/* setParamParameters[3] |= QAM_LOCKRANGE_NORMAL; */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">scu_command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_COMMAND_STANDARD_QAM</span> <span class="o">|</span> <span class="n">SCU_RAM_COMMAND_CMD_DEMOD_SET_PARAM</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">setParamParameters</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdResult</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fall-back to the simpler call */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span> <span class="o">==</span> <span class="n">OM_QAM_ITU_C</span><span class="p">)</span>
			<span class="n">setParamParameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QAM_TOP_ANNEX_C</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">setParamParameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QAM_TOP_ANNEX_A</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">scu_command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_COMMAND_STANDARD_QAM</span> <span class="o">|</span> <span class="n">SCU_RAM_COMMAND_CMD_DEMOD_SET_ENV</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">setParamParameters</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdResult</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">setParamParameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_Constellation</span><span class="p">;</span> <span class="cm">/* modulation     */</span>
		<span class="n">setParamParameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DRXK_QAM_I12_J17</span><span class="p">;</span>       <span class="cm">/* interleave mode   */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">scu_command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_COMMAND_STANDARD_QAM</span> <span class="o">|</span> <span class="n">SCU_RAM_COMMAND_CMD_DEMOD_SET_PARAM</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">setParamParameters</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdResult</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * STEP 3: enable the system in a mode where the ADC provides valid</span>
<span class="cm">	 * signal setup modulation independent registers</span>
<span class="cm">	 */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	status = SetFrequency(channel, tunerFreqOffset));</span>
<span class="c">	if (status &lt; 0)</span>
<span class="c">		goto error;</span>
<span class="cp">#endif</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">SetFrequencyShifter</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IntermediateFreqkHz</span><span class="p">,</span> <span class="n">tunerFreqOffset</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Setup BER measurement */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">SetQAMMeasurement</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_Constellation</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">symbol_rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Reset default values */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_SCALE_SH__A</span><span class="p">,</span> <span class="n">IQM_CF_SCALE_SH__PRE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_TIMEOUT__A</span><span class="p">,</span> <span class="n">QAM_SY_TIMEOUT__PRE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Reset default LC values */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_RATE_LIMIT__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_LPF_FACTORP__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_LPF_FACTORI__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_MODE__A</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB0__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB1__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB2__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB3__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB4__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB5__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB6__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB8__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB9__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB10__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB12__A</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB15__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB16__A</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB20__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_LC_QUAL_TAB25__A</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Mirroring, QAM-block starting point not inverted */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_SY_SP_INV__A</span><span class="p">,</span> <span class="n">QAM_SY_SP_INV_SPECTRUM_INV_DIS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Halt SCU to enable safe non-atomic accesses */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC_HOLD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* STEP 4: modulation specific setup */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QAM_16</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">SetQAM16</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_32</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">SetQAM32</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_AUTO</span>:
	<span class="k">case</span> <span class="n">QAM_64</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">SetQAM64</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_128</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">SetQAM128</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_256</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">SetQAM256</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Activate SCU to enable SCU commands */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC_ACTIVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Re-configure MPEG output, requires knowledge of channel bitrate */</span>
	<span class="cm">/* extAttr-&gt;currentChannel.modulation = channel-&gt;modulation; */</span>
	<span class="cm">/* extAttr-&gt;currentChannel.symbolrate    = channel-&gt;symbolrate; */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSDtoSetup</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_OperationMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Start processes */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSStart</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">FEC_COMM_EXEC_ACTIVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">QAM_COMM_EXEC__A</span><span class="p">,</span> <span class="n">QAM_COMM_EXEC_ACTIVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_COMM_EXEC__A</span><span class="p">,</span> <span class="n">IQM_COMM_EXEC_B_ACTIVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* STEP 5: start QAM demodulator (starts FEC, QAM and IQM HW) */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">scu_command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_COMMAND_STANDARD_QAM</span> <span class="o">|</span> <span class="n">SCU_RAM_COMMAND_CMD_DEMOD_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdResult</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* update global DRXK data container */</span>
<span class="cm">/*?     extAttr-&gt;qamInterleaveMode = DRXK_QAM_I12_J17; */</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetQAMStandard</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">OperationMode</span> <span class="n">oMode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
<span class="cp">#ifdef DRXK_QAM_TAPS</span>
<span class="cp">#define DRXK_QAMA_TAPS_SELECT</span>
<span class="cp">#include &quot;drxk_filters.h&quot;</span>
<span class="cp">#undef DRXK_QAMA_TAPS_SELECT</span>
<span class="cp">#endif</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* added antenna switch */</span>
	<span class="n">SwitchAntennaToQAM</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* Ensure correct power-up mode */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">PowerUpQAM</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* Reset QAM block */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">QAMResetQAM</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Setup IQM */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_COMM_EXEC__A</span><span class="p">,</span> <span class="n">IQM_COMM_EXEC_B_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_AMUX__A</span><span class="p">,</span> <span class="n">IQM_AF_AMUX_SIGNAL2ADC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Upload IQM Channel Filter settings by</span>
<span class="cm">		boot loader from ROM table */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">oMode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OM_QAM_ITU_A</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">BLChainCmd</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DRXK_BL_ROM_OFFSET_TAPS_ITU_A</span><span class="p">,</span> <span class="n">DRXK_BLCC_NR_ELEMENTS_TAPS</span><span class="p">,</span> <span class="n">DRXK_BLC_TIMEOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OM_QAM_ITU_C</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">BLDirectCmd</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_TAP_RE0__A</span><span class="p">,</span> <span class="n">DRXK_BL_ROM_OFFSET_TAPS_ITU_C</span><span class="p">,</span> <span class="n">DRXK_BLDC_NR_ELEMENTS_TAPS</span><span class="p">,</span> <span class="n">DRXK_BLC_TIMEOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">BLDirectCmd</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_TAP_IM0__A</span><span class="p">,</span> <span class="n">DRXK_BL_ROM_OFFSET_TAPS_ITU_C</span><span class="p">,</span> <span class="n">DRXK_BLDC_NR_ELEMENTS_TAPS</span><span class="p">,</span> <span class="n">DRXK_BLC_TIMEOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_OUT_ENA__A</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IQM_CF_OUT_ENA_QAM__B</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_SYMMETRIC__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_MIDTAP__A</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IQM_CF_MIDTAP_RE__B</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IQM_CF_MIDTAP_IM__B</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_RC_STRETCH__A</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_CLP_LEN__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_CLP_TH__A</span><span class="p">,</span> <span class="mi">448</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_SNS_LEN__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_POW_MEAS_LEN__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_FS_ADJ_SEL__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_RC_ADJ_SEL__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_ADJ_SEL__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_UPD_SEL__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* IQM Impulse Noise Processing Unit */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_CLP_VAL__A</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_DATATH__A</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_BYPASSDET__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_DET_LCT__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_WND_LEN__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_CF_PKDTH__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_INC_BYPASS__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* turn on IQMAF. Must be done before setAgc**() */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">SetIqmAf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IQM_AF_START_LOCK__A</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* IQM will not be reset from here, sync ADC and update/init AGC */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ADCSynchronization</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Set the FSM step period */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_QAM_FSM_STEP_PERIOD__A</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Halt SCU to enable safe non-atomic accesses */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC_HOLD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* No more resets of the IQM, current standard correctly set =&gt;</span>
<span class="cm">		now AGCs can be configured. */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">InitAGC</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">SetPreSaw</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamPreSawCfg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Configure AGC&#39;s */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">SetAgcRf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamRfAgcCfg</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">SetAgcIf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_qamIfAgcCfg</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Activate SCU to enable SCU commands */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC_ACTIVE</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">WriteGPIO</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* stop lock indicator process */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_GPIO__A</span><span class="p">,</span> <span class="n">SCU_RAM_GPIO_HW_LOCK_IND_DISABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*  Write magic word to enable pdr reg write               */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_TOP_COMM_KEY__A</span><span class="p">,</span> <span class="n">SIO_TOP_COMM_KEY_KEY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasSAWSW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">UIO_mask</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* UIO-1 */</span>
			<span class="cm">/* write to io pad configuration register - output mode */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_SMA_TX_CFG__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIOCfg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="cm">/* use corresponding bit in io data output registar */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_UIO_OUT_LO__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIO</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">&amp;=</span> <span class="mh">0x7FFF</span><span class="p">;</span>	<span class="cm">/* write zero to 15th bit - 1st UIO */</span>
			<span class="k">else</span>
				<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>	<span class="cm">/* write one to 15th bit - 1st UIO */</span>
			<span class="cm">/* write back to io data output register */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_UIO_OUT_LO__A</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">UIO_mask</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* UIO-2 */</span>
			<span class="cm">/* write to io pad configuration register - output mode */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_SMA_RX_CFG__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIOCfg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="cm">/* use corresponding bit in io data output registar */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_UIO_OUT_LO__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIO</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">&amp;=</span> <span class="mh">0xBFFF</span><span class="p">;</span>	<span class="cm">/* write zero to 14th bit - 2st UIO */</span>
			<span class="k">else</span>
				<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x4000</span><span class="p">;</span>	<span class="cm">/* write one to 14th bit - 2st UIO */</span>
			<span class="cm">/* write back to io data output register */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_UIO_OUT_LO__A</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">UIO_mask</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* UIO-3 */</span>
			<span class="cm">/* write to io pad configuration register - output mode */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_GPIO_CFG__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIOCfg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="cm">/* use corresponding bit in io data output registar */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_UIO_OUT_LO__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIO</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">&amp;=</span> <span class="mh">0xFFFB</span><span class="p">;</span>            <span class="cm">/* write zero to 2nd bit - 3rd UIO */</span>
			<span class="k">else</span>
				<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x0004</span><span class="p">;</span>            <span class="cm">/* write one to 2nd bit - 3rd UIO */</span>
			<span class="cm">/* write back to io data output register */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_PDR_UIO_OUT_LO__A</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*  Write magic word to disable pdr reg write               */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_TOP_COMM_KEY__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SwitchAntennaToQAM</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">gpio_state</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gpio_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIO</span> <span class="o">&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_dvbt</span> <span class="o">^</span> <span class="n">gpio_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Antenna is on DVB-T mode. Switch */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_dvbt</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIO</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIO</span> <span class="o">|=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">WriteGPIO</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SwitchAntennaToDVBT</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">gpio_state</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gpio_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIO</span> <span class="o">&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_dvbt</span> <span class="o">^</span> <span class="n">gpio_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Antenna is on DVB-C mode. Switch */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_dvbt</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIO</span> <span class="o">|=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIO</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">WriteGPIO</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">PowerDownDevice</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Power down to requested mode */</span>
	<span class="cm">/* Backup some register settings */</span>
	<span class="cm">/* Set pins with possible pull-ups connected to them in input mode */</span>
	<span class="cm">/* Analog power down */</span>
	<span class="cm">/* ADC power down */</span>
	<span class="cm">/* Power down device */</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_bPDownOpenBridge</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Open I2C bridge before power down of DRXK */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ConfigureI2CBridge</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* driver 0.9.0 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">DVBTEnableOFDMTokenRing</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_CC_PWD_MODE__A</span><span class="p">,</span> <span class="n">SIO_CC_PWD_MODE_LEVEL_CLOCK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_CC_UPDATE__A</span><span class="p">,</span> <span class="n">SIO_CC_UPDATE_KEY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgCtrl</span> <span class="o">|=</span> <span class="n">SIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">HI_CfgCommand</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_microcode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mc_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">mc_name</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;drxk: Could not load firmware file %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mc_name</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;drxk: Copy %s to your hotplug directory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mc_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">DownloadMicrocode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_drxk</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">DRXPowerMode</span> <span class="n">powerMode</span> <span class="o">=</span> <span class="n">DRXK_POWER_DOWN_OFDM</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">driverVersion</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DrxkState</span> <span class="o">==</span> <span class="n">DRXK_UNINITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">PowerUpDevice</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">DRXX_Open</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="cm">/* Soft reset of OFDM-, sys- and osc-clockdomain */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_CC_SOFT_RST__A</span><span class="p">,</span> <span class="n">SIO_CC_SOFT_RST_OFDM__M</span> <span class="o">|</span> <span class="n">SIO_CC_SOFT_RST_SYS__M</span> <span class="o">|</span> <span class="n">SIO_CC_SOFT_RST_OSC__M</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_CC_UPDATE__A</span><span class="p">,</span> <span class="n">SIO_CC_UPDATE_KEY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="cm">/* TODO is this needed, if yes how much delay in worst case scenario */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DRXK_A3_PATCH_CODE</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">GetDeviceCapabilities</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Bridge delay, uses oscilator clock */</span>
		<span class="cm">/* Delay = (delay (nano seconds) * oscclk (kHz))/ 1000 */</span>
		<span class="cm">/* SDA brdige delay */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgBridgeDelay</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_oscClockFreq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">HI_I2C_BRIDGE_DELAY</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="cm">/* Clipping */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgBridgeDelay</span> <span class="o">&gt;</span>
			<span class="n">SIO_HI_RA_RAM_PAR_3_CFG_DBL_SDA__M</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgBridgeDelay</span> <span class="o">=</span>
				<span class="n">SIO_HI_RA_RAM_PAR_3_CFG_DBL_SDA__M</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* SCL bridge delay, same as SDA for now */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgBridgeDelay</span> <span class="o">+=</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HICfgBridgeDelay</span> <span class="o">&lt;&lt;</span>
			<span class="n">SIO_HI_RA_RAM_PAR_3_CFG_DBL_SCL__B</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">InitHI</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="cm">/* disable various processes */</span>
<span class="cp">#if NOA1ROM</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DRXK_A1_ROM_CODE</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DRXK_A2_ROM_CODE</span><span class="p">))</span>
<span class="cp">#endif</span>
		<span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_GPIO__A</span><span class="p">,</span> <span class="n">SCU_RAM_GPIO_HW_LOCK_IND_DISABLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* disable MPEG port */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSDisable</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Stop AUD and SCU */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AUD_COMM_EXEC__A</span><span class="p">,</span> <span class="n">AUD_COMM_EXEC_STOP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC_STOP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* enable token-ring bus through OFDM block for possible ucode upload */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_OFDM_SH_OFDM_RING_ENABLE__A</span><span class="p">,</span> <span class="n">SIO_OFDM_SH_OFDM_RING_ENABLE_ON</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* include boot loader section */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_BL_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SIO_BL_COMM_EXEC_ACTIVE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">BLChainCmd</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">microcode_name</span><span class="p">)</span>
			<span class="n">load_microcode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">microcode_name</span><span class="p">);</span>

		<span class="cm">/* disable token-ring bus through OFDM block for possible ucode upload */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SIO_OFDM_SH_OFDM_RING_ENABLE__A</span><span class="p">,</span> <span class="n">SIO_OFDM_SH_OFDM_RING_ENABLE_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Run SCU for a little while to initialize microcode version numbers */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SCU_COMM_EXEC_ACTIVE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">DRXX_Open</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="cm">/* added for test */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

		<span class="n">powerMode</span> <span class="o">=</span> <span class="n">DRXK_POWER_DOWN_OFDM</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">CtrlPowerMode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">powerMode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Stamp driver version number in SCU data RAM in BCD code</span>
<span class="cm">			Done to enable field application engineers to retreive drxdriver version</span>
<span class="cm">			via I2C from SCU RAM.</span>
<span class="cm">			Not using SCU command interface for SCU register access since no</span>
<span class="cm">			microcode may be present.</span>
<span class="cm">			*/</span>
		<span class="n">driverVersion</span> <span class="o">=</span>
			<span class="p">(((</span><span class="n">DRXK_VERSION_MAJOR</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(((</span><span class="n">DRXK_VERSION_MAJOR</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">DRXK_VERSION_MAJOR</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">DRXK_VERSION_MINOR</span> <span class="o">%</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_DRIVER_VER_HI__A</span><span class="p">,</span> <span class="n">driverVersion</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">driverVersion</span> <span class="o">=</span>
			<span class="p">(((</span><span class="n">DRXK_VERSION_PATCH</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(((</span><span class="n">DRXK_VERSION_PATCH</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(((</span><span class="n">DRXK_VERSION_PATCH</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">DRXK_VERSION_PATCH</span> <span class="o">%</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_DRIVER_VER_LO__A</span><span class="p">,</span> <span class="n">driverVersion</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DRXK driver version %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">DRXK_VERSION_MAJOR</span><span class="p">,</span> <span class="n">DRXK_VERSION_MINOR</span><span class="p">,</span>
			<span class="n">DRXK_VERSION_PATCH</span><span class="p">);</span>

		<span class="cm">/* Dirty fix of default values for ROM/PATCH microcode</span>
<span class="cm">			Dirty because this fix makes it impossible to setup suitable values</span>
<span class="cm">			before calling DRX_Open. This solution requires changes to RF AGC speed</span>
<span class="cm">			to be done via the CTRL function after calling DRX_Open */</span>

		<span class="cm">/* m_dvbtRfAgcCfg.speed = 3; */</span>

		<span class="cm">/* Reset driver debug flags to 0 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SCU_RAM_DRIVER_DEBUG__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="cm">/* driver 0.9.0 */</span>
		<span class="cm">/* Setup FEC OC:</span>
<span class="cm">			NOTE: No more full FEC resets allowed afterwards!! */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FEC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">FEC_COMM_EXEC_STOP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="cm">/* MPEGTS functions are still the same */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSDtoInit</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSStop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSConfigurePolarity</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MPEGTSConfigurePins</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_enableMPEGOutput</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="cm">/* added: configure GPIO */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">WriteGPIO</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DrxkState</span> <span class="o">=</span> <span class="n">DRXK_STOPPED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_bPowerDown</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">PowerDownDevice</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DrxkState</span> <span class="o">=</span> <span class="n">DRXK_POWERED_DOWN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DrxkState</span> <span class="o">=</span> <span class="n">DRXK_STOPPED</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: Error %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drxk_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxk_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ShutDown</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxk_gate_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ConfigureI2CBridge</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxk_set_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">delsys</span>  <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">,</span> <span class="n">old_delsys</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">IF</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">get_if_frequency</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;drxk: Error: get_if_frequency() not defined at tuner. Can&#39;t work without it!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">old_delsys</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">delivery_system</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_delsys</span> <span class="o">!=</span> <span class="n">delsys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ShutDown</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">delsys</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_A</span>:
		<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_C</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBC</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_itut_annex_c</span> <span class="o">=</span> <span class="p">(</span><span class="n">delsys</span> <span class="o">==</span> <span class="n">SYS_DVBC_ANNEX_C</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_itut_annex_c</span><span class="p">)</span>
				<span class="n">SetOperationMode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OM_QAM_ITU_C</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">SetOperationMode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OM_QAM_ITU_A</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SYS_DVBT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBT</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">SetOperationMode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OM_DVBT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">get_if_frequency</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">IF</span><span class="p">);</span>
	<span class="n">Start</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IF</span><span class="p">);</span>

	<span class="cm">/* printk(KERN_DEBUG &quot;drxk: %s IF=%d done\n&quot;, __func__, IF); */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxk_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">GetLockStatus</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">==</span> <span class="n">MPEG_LOCK</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">==</span> <span class="n">FEC_LOCK</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">==</span> <span class="n">DEMOD_LOCK</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxk_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxk_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ReadIFAgc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxk_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">snr2</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">GetSignalToNoise</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snr2</span><span class="p">);</span>
	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">snr2</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxk_read_ucblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ucblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DVBTQAMGetAccPktErr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ucblocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxk_get_tune_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span>
				    <span class="o">*</span><span class="n">sets</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_A</span>:
	<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_C</span>:
	<span class="k">case</span> <span class="n">SYS_DVBT</span>:
		<span class="n">sets</span><span class="o">-&gt;</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
		<span class="n">sets</span><span class="o">-&gt;</span><span class="n">max_drift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sets</span><span class="o">-&gt;</span><span class="n">step_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">drxk_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* .delsys will be filled dynamically */</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DRXK&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">47000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">865000000</span><span class="p">,</span>
		 <span class="cm">/* For DVB-C */</span>
		<span class="p">.</span><span class="n">symbol_rate_min</span> <span class="o">=</span> <span class="mi">870000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">symbol_rate_max</span> <span class="o">=</span> <span class="mi">11700000</span><span class="p">,</span>
		<span class="cm">/* For DVB-T */</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">=</span> <span class="mi">166667</span><span class="p">,</span>

		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_32</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span>
			<span class="n">FE_CAN_QAM_128</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_256</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span>
			<span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_MUTE_TS</span> <span class="o">|</span>
			<span class="n">FE_CAN_TRANSMISSION_MODE_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_RECOVER</span> <span class="o">|</span>
			<span class="n">FE_CAN_GUARD_INTERVAL_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_HIERARCHY_AUTO</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">drxk_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">drxk_sleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">i2c_gate_ctrl</span> <span class="o">=</span> <span class="n">drxk_gate_ctrl</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">drxk_set_parameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">=</span> <span class="n">drxk_get_tune_settings</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">drxk_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">drxk_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">drxk_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">drxk_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">drxk_read_ucblocks</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">drxk_attach</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">drxk_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">drxk_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">adr</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxk_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_address</span> <span class="o">=</span> <span class="n">adr</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">single_master</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">single_master</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">microcode_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">microcode_name</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">no_i2c_bridge</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">no_i2c_bridge</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_dvbt</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">antenna_dvbt</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_ChunkSize</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">chunk_size</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">enable_merr_cfg</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">enable_merr_cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">dynamic_clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DVBTStaticCLK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DVBCStaticCLK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DVBTStaticCLK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DVBCStaticCLK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">mpeg_out_clk_strength</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_TSClockkStrength</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">mpeg_out_clk_strength</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_TSClockkStrength</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">parallel_ts</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_enableParallel</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_enableParallel</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* NOTE: as more UIO bits will be used, add them to the mask */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">UIO_mask</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span><span class="p">;</span>

	<span class="cm">/* Default gpio to DVB-C */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_dvbt</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIO</span> <span class="o">|=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_GPIO</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">antenna_gpio</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drxk_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drxk_ops</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">init_state</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_drxk</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Initialize the supported delivery systems */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SYS_DVBC_ANNEX_A</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SYS_DVBC_ANNEX_C</span><span class="p">;</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot; DVB-C&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_hasDVBT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SYS_DVBT</span><span class="p">;</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot; DVB-T&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;drxk: frontend initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxk: not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drxk_attach</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;DRX-K driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ralph Metzler&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
