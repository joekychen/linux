<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › stv0900_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>stv0900_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * stv0900_core.c</span>
<span class="cm"> *</span>
<span class="cm"> * Driver for ST STV0900 satellite demodulator IC.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) ST Microelectronics.</span>
<span class="cm"> * Copyright (C) 2009 NetUP Inc.</span>
<span class="cm"> * Copyright (C) 2009 Igor M. Liplianin &lt;liplianin@netup.ru&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>

<span class="cp">#include &quot;stv0900.h&quot;</span>
<span class="cp">#include &quot;stv0900_reg.h&quot;</span>
<span class="cp">#include &quot;stv0900_priv.h&quot;</span>
<span class="cp">#include &quot;stv0900_init.h&quot;</span>

<span class="kt">int</span> <span class="n">stvdebug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">stvdebug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/* internal params node */</span>
<span class="k">struct</span> <span class="n">stv0900_inode</span> <span class="p">{</span>
	<span class="cm">/* pointer for internal params, one for each pair of demods */</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span>		<span class="o">*</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_inode</span>		<span class="o">*</span><span class="n">next_inode</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* first internal params */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0900_inode</span> <span class="o">*</span><span class="n">stv0900_first_inode</span><span class="p">;</span>

<span class="cm">/* find chip by i2c adapter and i2c address */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0900_inode</span> <span class="o">*</span><span class="nf">find_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span>
							<span class="n">u8</span> <span class="n">i2c_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_inode</span> <span class="o">*</span><span class="n">temp_chip</span> <span class="o">=</span> <span class="n">stv0900_first_inode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp_chip</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 Search of the last stv0900 chip or</span>
<span class="cm">		 find it by i2c adapter and i2c address */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">temp_chip</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">temp_chip</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">i2c_adap</span> <span class="o">!=</span> <span class="n">i2c_adap</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">temp_chip</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">!=</span> <span class="n">i2c_addr</span><span class="p">)))</span>

			<span class="n">temp_chip</span> <span class="o">=</span> <span class="n">temp_chip</span><span class="o">-&gt;</span><span class="n">next_inode</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">temp_chip</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* deallocating chip */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">internal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_inode</span> <span class="o">*</span><span class="n">prev_node</span> <span class="o">=</span> <span class="n">stv0900_first_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_inode</span> <span class="o">*</span><span class="n">del_node</span> <span class="o">=</span> <span class="n">find_inode</span><span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
						<span class="n">internal</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">del_node</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">del_node</span> <span class="o">==</span> <span class="n">stv0900_first_inode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stv0900_first_inode</span> <span class="o">=</span> <span class="n">del_node</span><span class="o">-&gt;</span><span class="n">next_inode</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">prev_node</span><span class="o">-&gt;</span><span class="n">next_inode</span> <span class="o">!=</span> <span class="n">del_node</span><span class="p">)</span>
				<span class="n">prev_node</span> <span class="o">=</span> <span class="n">prev_node</span><span class="o">-&gt;</span><span class="n">next_inode</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">del_node</span><span class="o">-&gt;</span><span class="n">next_inode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">prev_node</span><span class="o">-&gt;</span><span class="n">next_inode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">prev_node</span><span class="o">-&gt;</span><span class="n">next_inode</span> <span class="o">=</span>
					<span class="n">prev_node</span><span class="o">-&gt;</span><span class="n">next_inode</span><span class="o">-&gt;</span><span class="n">next_inode</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">del_node</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* allocating new chip */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0900_inode</span> <span class="o">*</span><span class="nf">append_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">internal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_inode</span> <span class="o">*</span><span class="n">new_node</span> <span class="o">=</span> <span class="n">stv0900_first_inode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_inode</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">stv0900_first_inode</span> <span class="o">=</span> <span class="n">new_node</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next_inode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">new_node</span> <span class="o">=</span> <span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next_inode</span><span class="p">;</span>

		<span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next_inode</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_inode</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next_inode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">new_node</span> <span class="o">=</span> <span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next_inode</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">new_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_node</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_node</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">=</span> <span class="n">internal</span><span class="p">;</span>
		<span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next_inode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">new_node</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">s32</span> <span class="nf">ge2comp</span><span class="p">(</span><span class="n">s32</span> <span class="n">a</span><span class="p">,</span> <span class="n">s32</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">?</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">width</span><span class="p">))</span> <span class="o">:</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">stv0900_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg_addr</span><span class="p">,</span>
								<span class="n">u8</span> <span class="n">reg_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">i2cmsg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span>  <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span>   <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span>   <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSB</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_data</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2cmsg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: i2c error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">stv0900_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">MSB</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span> <span class="n">LSB</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">};</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: i2c error %d, reg[0x%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">extract_mask_pos</span><span class="p">(</span><span class="n">u32</span> <span class="n">label</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">mask</span><span class="p">)</span> <span class="o">=</span> <span class="n">label</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">position</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">stv0900_write_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">label</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">extract_mask_pos</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">pos</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">))</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

<span class="p">}</span>

<span class="n">u8</span> <span class="nf">stv0900_get_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">label</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">extract_mask_pos</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">label</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">pos</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">fe_stv0900_error</span> <span class="nf">stv0900_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">STV0900_INVALID_HANDLE</span><span class="p">;</span>

	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_MID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">errs</span> <span class="o">!=</span> <span class="n">STV0900_NO_ERROR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">errs</span><span class="p">;</span>

	<span class="cm">/*Startup sequence*/</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_DMDISTATE</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_DMDISTATE</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_TNRCFG</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_TNRCFG</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_I2CRPT</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_I2CRPT</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_NCOARSE</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_I2CCFG</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">clkmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_SYNTCTRL</span><span class="p">,</span> <span class="mh">0x20</span>
				<span class="o">|</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">clkmode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* preserve SELOSCI bit */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mh">0x02</span> <span class="o">&amp;</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_SYNTCTRL</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_SYNTCTRL</span><span class="p">,</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">181</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">STV0900_InitVal</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">STV0900_InitVal</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_MID</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_TSGENERAL</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">STV0900_Cut20_AddOnVal</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">STV0900_Cut20_AddOnVal</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_FSPYCFG</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_FSPYCFG</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">);</span>

	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_PDELCTRL2</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_PDELCTRL2</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>

	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_PDELCTRL3</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_PDELCTRL3</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_TSTRES0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_TSTRES0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STV0900_NO_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv0900_get_mclk_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ext_clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mclk</span> <span class="o">=</span> <span class="mi">90000000</span><span class="p">,</span> <span class="n">div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ad_div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_M_DIV</span><span class="p">);</span>
	<span class="n">ad_div</span> <span class="o">=</span> <span class="p">((</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_SELX1RATIO</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">mclk</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ext_clk</span> <span class="o">/</span> <span class="n">ad_div</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Calculated Mclk = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mclk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mclk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">fe_stv0900_error</span> <span class="nf">stv0900_set_mclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mclk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">m_div</span><span class="p">,</span> <span class="n">clk_sel</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Mclk set to %d, Quartz = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mclk</span><span class="p">,</span>
			<span class="n">intp</span><span class="o">-&gt;</span><span class="n">quartz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">STV0900_INVALID_HANDLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">errs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">STV0900_I2C_ERROR</span><span class="p">;</span>

	<span class="n">clk_sel</span> <span class="o">=</span> <span class="p">((</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_SELX1RATIO</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">m_div</span> <span class="o">=</span> <span class="p">((</span><span class="n">clk_sel</span> <span class="o">*</span> <span class="n">mclk</span><span class="p">)</span> <span class="o">/</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">quartz</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_M_DIV</span><span class="p">,</span> <span class="n">m_div</span><span class="p">);</span>
	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">stv0900_get_mclk_freq</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
					<span class="n">intp</span><span class="o">-&gt;</span><span class="n">quartz</span><span class="p">);</span>

	<span class="cm">/*Set the DiseqC frequency to 22KHz */</span>
	<span class="cm">/*</span>
<span class="cm">		Formula:</span>
<span class="cm">		DiseqC_TX_Freq= MasterClock/(32*F22TX_Reg)</span>
<span class="cm">		DiseqC_RX_Freq= MasterClock/(32*F22RX_Reg)</span>
<span class="cm">	*/</span>
	<span class="n">m_div</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">704000</span><span class="p">;</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_F22TX</span><span class="p">,</span> <span class="n">m_div</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_F22RX</span><span class="p">,</span> <span class="n">m_div</span><span class="p">);</span>

	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_F22TX</span><span class="p">,</span> <span class="n">m_div</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_F22RX</span><span class="p">,</span> <span class="n">m_div</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">errs</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">STV0900_I2C_ERROR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">STV0900_NO_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv0900_get_err_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cntr</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lsb</span><span class="p">,</span> <span class="n">msb</span><span class="p">,</span> <span class="n">hsb</span><span class="p">,</span> <span class="n">err_val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cntr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="nl">default:</span>
		<span class="n">hsb</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">ERR_CNT12</span><span class="p">);</span>
		<span class="n">msb</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">ERR_CNT11</span><span class="p">);</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">ERR_CNT10</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">hsb</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">ERR_CNT22</span><span class="p">);</span>
		<span class="n">msb</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">ERR_CNT21</span><span class="p">);</span>
		<span class="n">lsb</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">ERR_CNT20</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsb</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">msb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">lsb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_i2c_gate_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">;</span>

	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">I2CT_ON</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv0900_set_ts_parallel_serial</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">fe_stv0900_clock_type</span> <span class="n">path1_ts</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">fe_stv0900_clock_type</span> <span class="n">path2_ts</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">path1_ts</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STV0900_PARALLEL_PUNCT_CLOCK</span>:
		<span class="k">case</span> <span class="n">STV0900_DVBCI_CLOCK</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">path2_ts</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">STV0900_SERIAL_PUNCT_CLOCK</span>:
			<span class="k">case</span> <span class="n">STV0900_SERIAL_CONT_CLOCK</span>:
			<span class="nl">default:</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_TSGENERAL</span><span class="p">,</span>
							<span class="mh">0x00</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STV0900_PARALLEL_PUNCT_CLOCK</span>:
			<span class="k">case</span> <span class="n">STV0900_DVBCI_CLOCK</span>:
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_TSGENERAL</span><span class="p">,</span>
							<span class="mh">0x06</span><span class="p">);</span>
				<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
						<span class="n">F0900_P1_TSFIFO_MANSPEED</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
				<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
						<span class="n">F0900_P2_TSFIFO_MANSPEED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
						<span class="n">R0900_P1_TSSPEED</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
						<span class="n">R0900_P2_TSSPEED</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STV0900_SERIAL_PUNCT_CLOCK</span>:
		<span class="k">case</span> <span class="n">STV0900_SERIAL_CONT_CLOCK</span>:
		<span class="nl">default:</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">path2_ts</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">STV0900_SERIAL_PUNCT_CLOCK</span>:
			<span class="k">case</span> <span class="n">STV0900_SERIAL_CONT_CLOCK</span>:
			<span class="nl">default:</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
						<span class="n">R0900_TSGENERAL</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STV0900_PARALLEL_PUNCT_CLOCK</span>:
			<span class="k">case</span> <span class="n">STV0900_DVBCI_CLOCK</span>:
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
						<span class="n">R0900_TSGENERAL</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">);</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: 0x0a</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">path1_ts</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STV0900_PARALLEL_PUNCT_CLOCK</span>:
		<span class="k">case</span> <span class="n">STV0900_DVBCI_CLOCK</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">path2_ts</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">STV0900_SERIAL_PUNCT_CLOCK</span>:
			<span class="k">case</span> <span class="n">STV0900_SERIAL_CONT_CLOCK</span>:
			<span class="nl">default:</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_TSGENERAL1X</span><span class="p">,</span>
							<span class="mh">0x10</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STV0900_PARALLEL_PUNCT_CLOCK</span>:
			<span class="k">case</span> <span class="n">STV0900_DVBCI_CLOCK</span>:
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_TSGENERAL1X</span><span class="p">,</span>
							<span class="mh">0x16</span><span class="p">);</span>
				<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
						<span class="n">F0900_P1_TSFIFO_MANSPEED</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
				<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
						<span class="n">F0900_P2_TSFIFO_MANSPEED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_TSSPEED</span><span class="p">,</span>
							<span class="mh">0x14</span><span class="p">);</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_TSSPEED</span><span class="p">,</span>
							<span class="mh">0x28</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STV0900_SERIAL_PUNCT_CLOCK</span>:
		<span class="k">case</span> <span class="n">STV0900_SERIAL_CONT_CLOCK</span>:
		<span class="nl">default:</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">path2_ts</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">STV0900_SERIAL_PUNCT_CLOCK</span>:
			<span class="k">case</span> <span class="n">STV0900_SERIAL_CONT_CLOCK</span>:
			<span class="nl">default:</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_TSGENERAL1X</span><span class="p">,</span>
							<span class="mh">0x14</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STV0900_PARALLEL_PUNCT_CLOCK</span>:
			<span class="k">case</span> <span class="n">STV0900_DVBCI_CLOCK</span>:
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_TSGENERAL1X</span><span class="p">,</span>
							<span class="mh">0x12</span><span class="p">);</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: 0x12</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">path1_ts</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV0900_PARALLEL_PUNCT_CLOCK</span>:
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_TSFIFO_SERIAL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_TSFIFO_DVBCI</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_DVBCI_CLOCK</span>:
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_TSFIFO_SERIAL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_TSFIFO_DVBCI</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_SERIAL_PUNCT_CLOCK</span>:
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_TSFIFO_SERIAL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_TSFIFO_DVBCI</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_SERIAL_CONT_CLOCK</span>:
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_TSFIFO_SERIAL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_TSFIFO_DVBCI</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">path2_ts</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV0900_PARALLEL_PUNCT_CLOCK</span>:
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_TSFIFO_SERIAL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_TSFIFO_DVBCI</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_DVBCI_CLOCK</span>:
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_TSFIFO_SERIAL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_TSFIFO_DVBCI</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_SERIAL_PUNCT_CLOCK</span>:
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_TSFIFO_SERIAL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_TSFIFO_DVBCI</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_SERIAL_CONT_CLOCK</span>:
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_TSFIFO_SERIAL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_TSFIFO_DVBCI</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_RST_HWARE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_RST_HWARE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_RST_HWARE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_RST_HWARE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">stv0900_set_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">frequency</span><span class="p">,</span>
							<span class="n">u32</span> <span class="n">bandwidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="o">*</span><span class="n">frontend_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="o">*</span><span class="n">tuner_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
		<span class="n">frontend_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">frontend_ops</span><span class="o">-&gt;</span><span class="n">tuner_ops</span><span class="p">)</span>
		<span class="n">tuner_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frontend_ops</span><span class="o">-&gt;</span><span class="n">tuner_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tuner_ops</span><span class="o">-&gt;</span><span class="n">set_frequency</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tuner_ops</span><span class="o">-&gt;</span><span class="n">set_frequency</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">frequency</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Invalid parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Frequency=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">frequency</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tuner_ops</span><span class="o">-&gt;</span><span class="n">set_bandwidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tuner_ops</span><span class="o">-&gt;</span><span class="n">set_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Invalid parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Bandwidth=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">stv0900_set_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bandwidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="o">*</span><span class="n">frontend_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="o">*</span><span class="n">tuner_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
		<span class="n">frontend_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">frontend_ops</span><span class="o">-&gt;</span><span class="n">tuner_ops</span><span class="p">)</span>
		<span class="n">tuner_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frontend_ops</span><span class="o">-&gt;</span><span class="n">tuner_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tuner_ops</span><span class="o">-&gt;</span><span class="n">set_bandwidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tuner_ops</span><span class="o">-&gt;</span><span class="n">set_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Invalid parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Bandwidth=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">stv0900_get_freq_auto</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">,</span> <span class="n">round</span><span class="p">;</span>
	<span class="cm">/*	Formulat :</span>
<span class="cm">	Tuner_Frequency(MHz)	= Regs / 64</span>
<span class="cm">	Tuner_granularity(MHz)	= Regs / 2048</span>
<span class="cm">	real_Tuner_Frequency	= Tuner_Frequency(MHz) - Tuner_granularity(MHz)</span>
<span class="cm">	*/</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TUN_RFFREQ2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TUN_RFFREQ1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TUN_RFFREQ0</span><span class="p">);</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>

	<span class="n">round</span> <span class="o">=</span> <span class="p">(</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TUN_RFRESTE1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TUN_RFRESTE0</span><span class="p">);</span>

	<span class="n">round</span> <span class="o">=</span> <span class="p">(</span><span class="n">round</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2048</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">freq</span> <span class="o">+</span> <span class="n">round</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">stv0900_set_tuner_auto</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">Frequency</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">Bandwidth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tunerFrequency</span><span class="p">;</span>
	<span class="cm">/* Formulat:</span>
<span class="cm">	Tuner_frequency_reg= Frequency(MHz)*64</span>
<span class="cm">	*/</span>
	<span class="n">tunerFrequency</span> <span class="o">=</span> <span class="p">(</span><span class="n">Frequency</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TUN_RFFREQ2</span><span class="p">,</span> <span class="p">(</span><span class="n">tunerFrequency</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TUN_RFFREQ1</span><span class="p">,</span> <span class="p">(</span><span class="n">tunerFrequency</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TUN_RFFREQ0</span><span class="p">,</span> <span class="p">(</span><span class="n">tunerFrequency</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">));</span>
	<span class="cm">/* Low Pass Filter = BW /2 (MHz)*/</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TUN_BW</span><span class="p">,</span> <span class="n">Bandwidth</span> <span class="o">/</span> <span class="mi">2000000</span><span class="p">);</span>
	<span class="cm">/* Tuner Write trig */</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TNRLD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">stv0900_get_rf_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">stv0900_table</span> <span class="o">*</span><span class="n">lookup</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">agc_gain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">imin</span><span class="p">,</span>
		<span class="n">imax</span><span class="p">,</span>
		<span class="n">i</span><span class="p">,</span>
		<span class="n">rf_lvl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lookup</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">agc_gain</span> <span class="o">=</span> <span class="n">MAKEWORD</span><span class="p">(</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">AGCIQ_VALUE1</span><span class="p">),</span>
				<span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">AGCIQ_VALUE0</span><span class="p">));</span>

	<span class="n">imin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">imax</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INRANGE</span><span class="p">(</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imin</span><span class="p">].</span><span class="n">regval</span><span class="p">,</span> <span class="n">agc_gain</span><span class="p">,</span>
					<span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imax</span><span class="p">].</span><span class="n">regval</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">imax</span> <span class="o">-</span> <span class="n">imin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">imax</span> <span class="o">+</span> <span class="n">imin</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">INRANGE</span><span class="p">(</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imin</span><span class="p">].</span><span class="n">regval</span><span class="p">,</span>
					<span class="n">agc_gain</span><span class="p">,</span>
					<span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">regval</span><span class="p">))</span>
				<span class="n">imax</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">imin</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rf_lvl</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">agc_gain</span> <span class="o">-</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imin</span><span class="p">].</span><span class="n">regval</span><span class="p">;</span>
		<span class="n">rf_lvl</span> <span class="o">*=</span> <span class="p">(</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imax</span><span class="p">].</span><span class="n">realval</span> <span class="o">-</span>
				<span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imin</span><span class="p">].</span><span class="n">realval</span><span class="p">);</span>
		<span class="n">rf_lvl</span> <span class="o">/=</span> <span class="p">(</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imax</span><span class="p">].</span><span class="n">regval</span> <span class="o">-</span>
				<span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imin</span><span class="p">].</span><span class="n">regval</span><span class="p">);</span>
		<span class="n">rf_lvl</span> <span class="o">+=</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imin</span><span class="p">].</span><span class="n">realval</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">agc_gain</span> <span class="o">&gt;</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">regval</span><span class="p">)</span>
		<span class="n">rf_lvl</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">agc_gain</span> <span class="o">&lt;</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">regval</span><span class="p">)</span>
		<span class="n">rf_lvl</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: RFLevel = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rf_lvl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rf_lvl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rflevel</span> <span class="o">=</span> <span class="n">stv0900_get_rf_level</span><span class="p">(</span><span class="n">internal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stv0900_rf</span><span class="p">,</span>
								<span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">);</span>

	<span class="n">rflevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">rflevel</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">65535</span> <span class="o">/</span> <span class="mi">70</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rflevel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rflevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rflevel</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span>
		<span class="n">rflevel</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="n">rflevel</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">stv0900_carr_get_quality</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">stv0900_table</span> <span class="o">*</span><span class="n">lookup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">;</span>

	<span class="n">s32</span>	<span class="n">c_n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span>
		<span class="n">regval</span><span class="p">,</span>
		<span class="n">imin</span><span class="p">,</span>
		<span class="n">imax</span><span class="p">,</span>
		<span class="n">i</span><span class="p">,</span>
		<span class="n">noise_field1</span><span class="p">,</span>
		<span class="n">noise_field0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv0900_get_standard</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">demod</span><span class="p">)</span> <span class="o">==</span> <span class="n">STV0900_DVBS2_STANDARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">noise_field1</span> <span class="o">=</span> <span class="n">NOSPLHT_NORMED1</span><span class="p">;</span>
		<span class="n">noise_field0</span> <span class="o">=</span> <span class="n">NOSPLHT_NORMED0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">noise_field1</span> <span class="o">=</span> <span class="n">NOSDATAT_NORMED1</span><span class="p">;</span>
		<span class="n">noise_field0</span> <span class="o">=</span> <span class="n">NOSDATAT_NORMED0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">LOCK_DEFINITIF</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lookup</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">regval</span> <span class="o">+=</span> <span class="n">MAKEWORD</span><span class="p">(</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
								<span class="n">noise_field1</span><span class="p">),</span>
						<span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
								<span class="n">noise_field0</span><span class="p">));</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">regval</span> <span class="o">/=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">imin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">imax</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">INRANGE</span><span class="p">(</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imin</span><span class="p">].</span><span class="n">regval</span><span class="p">,</span>
					<span class="n">regval</span><span class="p">,</span>
					<span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imax</span><span class="p">].</span><span class="n">regval</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">imax</span> <span class="o">-</span> <span class="n">imin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">imax</span> <span class="o">+</span> <span class="n">imin</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">INRANGE</span><span class="p">(</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imin</span><span class="p">].</span><span class="n">regval</span><span class="p">,</span>
						    <span class="n">regval</span><span class="p">,</span>
						    <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">regval</span><span class="p">))</span>
						<span class="n">imax</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">imin</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">c_n</span> <span class="o">=</span> <span class="p">((</span><span class="n">regval</span> <span class="o">-</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imin</span><span class="p">].</span><span class="n">regval</span><span class="p">)</span>
						<span class="o">*</span> <span class="p">(</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imax</span><span class="p">].</span><span class="n">realval</span>
						<span class="o">-</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imin</span><span class="p">].</span><span class="n">realval</span><span class="p">)</span>
						<span class="o">/</span> <span class="p">(</span><span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imax</span><span class="p">].</span><span class="n">regval</span>
						<span class="o">-</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imin</span><span class="p">].</span><span class="n">regval</span><span class="p">))</span>
						<span class="o">+</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imin</span><span class="p">].</span><span class="n">realval</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&lt;</span> <span class="n">lookup</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">imin</span><span class="p">].</span><span class="n">regval</span><span class="p">)</span>
				<span class="n">c_n</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">c_n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_read_ucblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">ucblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">err_val1</span><span class="p">,</span> <span class="n">err_val0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">header_err_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ucblocks</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv0900_get_standard</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">demod</span><span class="p">)</span> <span class="o">==</span> <span class="n">STV0900_DVBS2_STANDARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DVB-S2 delineator errors count */</span>

		<span class="cm">/* retreiving number for errnous headers */</span>
		<span class="n">err_val1</span> <span class="o">=</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">BBFCRCKO1</span><span class="p">);</span>
		<span class="n">err_val0</span> <span class="o">=</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">BBFCRCKO0</span><span class="p">);</span>
		<span class="n">header_err_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">err_val1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">err_val0</span><span class="p">;</span>

		<span class="cm">/* retreiving number for errnous packets */</span>
		<span class="n">err_val1</span> <span class="o">=</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">UPCRCKO1</span><span class="p">);</span>
		<span class="n">err_val0</span> <span class="o">=</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">UPCRCKO0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ucblocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">err_val1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">err_val0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ucblocks</span> <span class="o">+=</span> <span class="n">header_err_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">snrlcl</span> <span class="o">=</span> <span class="n">stv0900_carr_get_quality</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span>
			<span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">stv0900_table</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">stv0900_s2_cn</span><span class="p">);</span>
	<span class="n">snrlcl</span> <span class="o">=</span> <span class="p">(</span><span class="n">snrlcl</span> <span class="o">+</span> <span class="mi">30</span><span class="p">)</span> <span class="o">*</span> <span class="mi">384</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snrlcl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snrlcl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snrlcl</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span>
		<span class="n">snrlcl</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">snrlcl</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv0900_get_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ber</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">demod_state</span><span class="p">;</span>

	<span class="n">demod_state</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">HEADER_MODE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">demod_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV0900_SEARCH</span>:
	<span class="k">case</span> <span class="n">STV0900_PLH_DETECTED</span>:
	<span class="nl">default:</span>
		<span class="n">ber</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_DVBS_FOUND</span>:
		<span class="n">ber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">ber</span> <span class="o">+=</span> <span class="n">stv0900_get_err_count</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">demod</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ber</span> <span class="o">/=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">PRFVIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ber</span> <span class="o">*=</span> <span class="mi">9766</span><span class="p">;</span>
			<span class="n">ber</span> <span class="o">=</span> <span class="n">ber</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_DVBS2_FOUND</span>:
		<span class="n">ber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">ber</span> <span class="o">+=</span> <span class="n">stv0900_get_err_count</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">demod</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ber</span> <span class="o">/=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">PKTDELIN_LOCK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ber</span> <span class="o">*=</span> <span class="mi">9766</span><span class="p">;</span>
			<span class="n">ber</span> <span class="o">=</span> <span class="n">ber</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ber</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="n">stv0900_get_ber</span><span class="p">(</span><span class="n">internal</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stv0900_get_demod_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span><span class="p">,</span> <span class="n">s32</span> <span class="n">time_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">fe_stv0900_search_state</span>	<span class="n">dmd_state</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">timer</span> <span class="o">&lt;</span> <span class="n">time_out</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dmd_state</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">HEADER_MODE</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Demod State = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dmd_state</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dmd_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STV0900_SEARCH</span>:
		<span class="k">case</span> <span class="n">STV0900_PLH_DETECTED</span>:
		<span class="nl">default:</span>
			<span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STV0900_DVBS2_FOUND</span>:
		<span class="k">case</span> <span class="n">STV0900_DVBS_FOUND</span>:
			<span class="n">lock</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">LOCK_DEFINITIF</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">timer</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;DEMOD LOCK OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;DEMOD LOCK FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">stv0900_stop_all_s2_modcod</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">regflist</span><span class="p">,</span>
	<span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">regflist</span> <span class="o">=</span> <span class="n">MODCODLST0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">regflist</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">stv0900_activate_s2_modcod</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">matype</span><span class="p">,</span>
		<span class="n">mod_code</span><span class="p">,</span>
		<span class="n">fmod</span><span class="p">,</span>
		<span class="n">reg_index</span><span class="p">,</span>
		<span class="n">field_index</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&lt;=</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">mod_code</span> <span class="o">=</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">PLHMODCOD</span><span class="p">);</span>
		<span class="n">matype</span> <span class="o">=</span> <span class="n">mod_code</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">mod_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">mod_code</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">reg_index</span> <span class="o">=</span> <span class="n">MODCODLSTF</span> <span class="o">-</span> <span class="n">mod_code</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">field_index</span> <span class="o">=</span> <span class="n">mod_code</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">matype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
		<span class="nl">default:</span>
			<span class="n">fmod</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">fmod</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">fmod</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">fmod</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">INRANGE</span><span class="p">(</span><span class="n">STV0900_QPSK_12</span><span class="p">,</span> <span class="n">mod_code</span><span class="p">,</span> <span class="n">STV0900_8PSK_910</span><span class="p">))</span>
						<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">matype</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">field_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">reg_index</span><span class="p">,</span>
							<span class="mh">0xf0</span> <span class="o">|</span> <span class="n">fmod</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">reg_index</span><span class="p">,</span>
							<span class="p">(</span><span class="n">fmod</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="mh">0x12</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">reg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg_index</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">reg_index</span><span class="o">++</span><span class="p">)</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">MODCODLST0</span> <span class="o">+</span> <span class="n">reg_index</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">MODCODLSTE</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">MODCODLSTF</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">reg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg_index</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">reg_index</span><span class="o">++</span><span class="p">)</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">MODCODLST7</span> <span class="o">+</span> <span class="n">reg_index</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">);</span>


	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">stv0900_activate_s2_modcod_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_index</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">MODCODLST0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">MODCODLST1</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">MODCODLSTF</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">reg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg_index</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="n">reg_index</span><span class="o">++</span><span class="p">)</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">MODCODLST2</span> <span class="o">+</span> <span class="n">reg_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">dvbfe_algo</span> <span class="nf">stv0900_frontend_algo</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">DVBFE_ALGO_CUSTOM</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">stv0900_start_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">freq_s16</span> <span class="p">;</span>

	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DEMOD_MODE</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CORRELEXP</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CARHDR</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&lt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">5000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CARCFG</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CFRUP1</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CFRUP0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CFRLOW1</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CFRLOW0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">RTCS2</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CARCFG</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">);</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">RTCS2</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/*cut 3.0 above*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">5000000</span><span class="p">)</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">RTCS2</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">RTCS2</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>

		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CARCFG</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">srch_algo</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">==</span> <span class="n">STV0900_WARM_START</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">freq</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">freq</span> <span class="o">/=</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="n">freq_s16</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">freq</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">srch_range</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">5000000</span><span class="p">)</span>
				<span class="n">freq</span> <span class="o">+=</span> <span class="mi">80</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">freq</span> <span class="o">+=</span> <span class="mi">600</span><span class="p">;</span>

			<span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">freq</span> <span class="o">/=</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="n">freq_s16</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">freq</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CFR_UP1</span><span class="p">,</span> <span class="n">MSB</span><span class="p">(</span><span class="n">freq_s16</span><span class="p">));</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CFR_UP0</span><span class="p">,</span> <span class="n">LSB</span><span class="p">(</span><span class="n">freq_s16</span><span class="p">));</span>
		<span class="n">freq_s16</span> <span class="o">*=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CFR_LOW1</span><span class="p">,</span> <span class="n">MSB</span><span class="p">(</span><span class="n">freq_s16</span><span class="p">));</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CFR_LOW0</span><span class="p">,</span> <span class="n">LSB</span><span class="p">(</span><span class="n">freq_s16</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CFRINIT1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CFRINIT0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">EQUALCFG</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">FFECFG</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">srch_standard</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">==</span> <span class="n">STV0900_SEARCH_DVBS1</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">srch_standard</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">==</span> <span class="n">STV0900_SEARCH_DSS</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">srch_standard</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">==</span> <span class="n">STV0900_AUTO_SEARCH</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">VITSCALE</span><span class="p">,</span>
								<span class="mh">0x82</span><span class="p">);</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">VAVSRVIT</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">SFRSTEP</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TMGTHRISE</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TMGTHFALL</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">SCAN_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CFR_AUTOSCAN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">S1S2_SEQUENTIAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">RTC</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&lt;=</span> <span class="mh">0x20</span><span class="p">)</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
			<span class="k">else</span>  <span class="cm">/*cut 3.0*/</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">);</span>

			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CARHDR</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">);</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CARHDR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">);</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CARHDR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="p">)</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">CARFREQ</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">srch_algo</span><span class="p">[</span><span class="n">demod</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV0900_WARM_START</span>:
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_COLD_START</span>:
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DMDISTATE</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">stv0900_get_optim_carr_loop</span><span class="p">(</span><span class="n">s32</span> <span class="n">srate</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fe_stv0900_modcode</span> <span class="n">modcode</span><span class="p">,</span>
							<span class="n">s32</span> <span class="n">pilot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">chip_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">aclc_value</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stv0900_car_loop_optim</span> <span class="o">*</span><span class="n">cls2</span><span class="p">,</span> <span class="o">*</span><span class="n">cllqs2</span><span class="p">,</span> <span class="o">*</span><span class="n">cllas2</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">&lt;=</span> <span class="mh">0x12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cls2</span> <span class="o">=</span> <span class="n">FE_STV0900_S2CarLoop</span><span class="p">;</span>
		<span class="n">cllqs2</span> <span class="o">=</span> <span class="n">FE_STV0900_S2LowQPCarLoopCut30</span><span class="p">;</span>
		<span class="n">cllas2</span> <span class="o">=</span> <span class="n">FE_STV0900_S2APSKCarLoopCut30</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cls2</span> <span class="o">=</span> <span class="n">FE_STV0900_S2CarLoopCut20</span><span class="p">;</span>
		<span class="n">cllqs2</span> <span class="o">=</span> <span class="n">FE_STV0900_S2LowQPCarLoopCut20</span><span class="p">;</span>
		<span class="n">cllas2</span> <span class="o">=</span> <span class="n">FE_STV0900_S2APSKCarLoopCut20</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cls2</span> <span class="o">=</span> <span class="n">FE_STV0900_S2CarLoopCut30</span><span class="p">;</span>
		<span class="n">cllqs2</span> <span class="o">=</span> <span class="n">FE_STV0900_S2LowQPCarLoopCut30</span><span class="p">;</span>
		<span class="n">cllas2</span> <span class="o">=</span> <span class="n">FE_STV0900_S2APSKCarLoopCut30</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modcode</span> <span class="o">&lt;</span> <span class="n">STV0900_QPSK_12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">modcode</span> <span class="o">!=</span> <span class="n">cllqs2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modcode</span><span class="p">))</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">modcode</span> <span class="o">!=</span> <span class="n">cls2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modcode</span><span class="p">))</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">modcode</span> <span class="o">!=</span> <span class="n">cllas2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modcode</span><span class="p">))</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modcode</span> <span class="o">&lt;=</span> <span class="n">STV0900_QPSK_25</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pilot</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllqs2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllqs2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_5</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllqs2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_10</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllqs2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_20</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllqs2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_30</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllqs2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_off_2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllqs2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_off_5</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllqs2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_off_10</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllqs2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_off_20</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllqs2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_off_30</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">modcode</span> <span class="o">&lt;=</span> <span class="n">STV0900_8PSK_910</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pilot</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cls2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cls2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_5</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cls2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_10</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cls2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_20</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cls2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_30</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cls2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_off_2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cls2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_off_5</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cls2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_off_10</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cls2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_off_20</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cls2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_off_30</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllas2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllas2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_5</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllas2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllas2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_20</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">cllas2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">car_loop_pilots_on_30</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">aclc_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">stv0900_get_optim_short_carr_loop</span><span class="p">(</span><span class="n">s32</span> <span class="n">srate</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">fe_stv0900_modulation</span> <span class="n">modulation</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">chip_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stv0900_short_frames_car_loop_optim</span> <span class="o">*</span><span class="n">s2scl</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stv0900_short_frames_car_loop_optim_vs_mod</span> <span class="o">*</span><span class="n">s2sclc30</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">mod_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">aclc_value</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">s2scl</span> <span class="o">=</span> <span class="n">FE_STV0900_S2ShortCarLoop</span><span class="p">;</span>
	<span class="n">s2sclc30</span> <span class="o">=</span> <span class="n">FE_STV0900_S2ShortCarLoopCut30</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV0900_QPSK</span>:
	<span class="nl">default:</span>
		<span class="n">mod_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_8PSK</span>:
		<span class="n">mod_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_16APSK</span>:
		<span class="n">mod_index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_32APSK</span>:
		<span class="n">mod_index</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2sclc30</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2sclc30</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_5</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2sclc30</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2sclc30</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_20</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2sclc30</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_30</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2scl</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_cut20_2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2scl</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_cut20_5</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2scl</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_cut20_10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2scl</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_cut20_20</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2scl</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_cut20_30</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">3000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2scl</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_cut12_2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">7000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2scl</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_cut12_5</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2scl</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_cut12_10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2scl</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_cut12_20</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">aclc_value</span> <span class="o">=</span> <span class="n">s2scl</span><span class="p">[</span><span class="n">mod_index</span><span class="p">].</span><span class="n">car_loop_cut12_30</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">aclc_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="k">enum</span> <span class="n">fe_stv0900_error</span> <span class="nf">stv0900_st_dvbs2_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">fe_stv0900_demod_mode</span> <span class="n">LDPC_Mode</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_error</span> <span class="n">error</span> <span class="o">=</span> <span class="n">STV0900_NO_ERROR</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">reg_ind</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">LDPC_Mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV0900_DUAL</span>:
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">demod_mode</span> <span class="o">!=</span> <span class="n">STV0900_DUAL</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_DDEMOD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_GENCFG</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">);</span>

			<span class="n">intp</span><span class="o">-&gt;</span><span class="n">demod_mode</span> <span class="o">=</span> <span class="n">STV0900_DUAL</span><span class="p">;</span>

			<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_FRESFEC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_FRESFEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">reg_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg_ind</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">reg_ind</span><span class="o">++</span><span class="p">)</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
						<span class="n">R0900_P1_MODCODLST0</span> <span class="o">+</span> <span class="n">reg_ind</span><span class="p">,</span>
						<span class="mh">0xff</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">reg_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg_ind</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">reg_ind</span><span class="o">++</span><span class="p">)</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
						<span class="n">R0900_P1_MODCODLST7</span> <span class="o">+</span> <span class="n">reg_ind</span><span class="p">,</span>
						<span class="mh">0xcc</span><span class="p">);</span>

			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_MODCODLSTE</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_MODCODLSTF</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">reg_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg_ind</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">reg_ind</span><span class="o">++</span><span class="p">)</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
						<span class="n">R0900_P2_MODCODLST0</span> <span class="o">+</span> <span class="n">reg_ind</span><span class="p">,</span>
						<span class="mh">0xff</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">reg_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg_ind</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">reg_ind</span><span class="o">++</span><span class="p">)</span>
				<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
						<span class="n">R0900_P2_MODCODLST7</span> <span class="o">+</span> <span class="n">reg_ind</span><span class="p">,</span>
						<span class="mh">0xcc</span><span class="p">);</span>

			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_MODCODLSTE</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_MODCODLSTF</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_SINGLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">demod</span> <span class="o">==</span> <span class="n">STV0900_DEMOD_2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stv0900_stop_all_s2_modcod</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">STV0900_DEMOD_1</span><span class="p">);</span>
			<span class="n">stv0900_activate_s2_modcod_single</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
							<span class="n">STV0900_DEMOD_2</span><span class="p">);</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_GENCFG</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">stv0900_stop_all_s2_modcod</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">STV0900_DEMOD_2</span><span class="p">);</span>
			<span class="n">stv0900_activate_s2_modcod_single</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
							<span class="n">STV0900_DEMOD_1</span><span class="p">);</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_GENCFG</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">intp</span><span class="o">-&gt;</span><span class="n">demod_mode</span> <span class="o">=</span> <span class="n">STV0900_SINGLE</span><span class="p">;</span>

		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_FRESFEC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_FRESFEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_ALGOSWRST</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_ALGOSWRST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_ALGOSWRST</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_ALGOSWRST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">fe_stv0900_error</span> <span class="nf">stv0900_init_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">stv0900_init_params</span> <span class="o">*</span><span class="n">p_init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_error</span> <span class="n">error</span> <span class="o">=</span> <span class="n">STV0900_NO_ERROR</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_error</span> <span class="n">demodError</span> <span class="o">=</span> <span class="n">STV0900_NO_ERROR</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">selosci</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">stv0900_inode</span> <span class="o">*</span><span class="n">temp_int</span> <span class="o">=</span> <span class="n">find_inode</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
						<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">temp_int</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p_init</span><span class="o">-&gt;</span><span class="n">demod_mode</span> <span class="o">==</span> <span class="n">STV0900_DUAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">=</span> <span class="n">temp_int</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
		<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dmds_used</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Find Internal Structure!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STV0900_NO_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">STV0900_INVALID_HANDLE</span><span class="p">;</span>
		<span class="n">temp_int</span> <span class="o">=</span> <span class="n">append_internal</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp_int</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">);</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">STV0900_INVALID_HANDLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dmds_used</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">i2c_adap</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">clkmode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">clkmode</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">errs</span> <span class="o">=</span> <span class="n">STV0900_NO_ERROR</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Create New Internal Structure!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">STV0900_INVALID_HANDLE</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">demodError</span> <span class="o">=</span> <span class="n">stv0900_initialize</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">demodError</span> <span class="o">==</span> <span class="n">STV0900_NO_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">STV0900_NO_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">demodError</span> <span class="o">==</span> <span class="n">STV0900_INVALID_HANDLE</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">STV0900_INVALID_HANDLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">STV0900_I2C_ERROR</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intp</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>

	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">demod_mode</span> <span class="o">=</span> <span class="n">p_init</span><span class="o">-&gt;</span><span class="n">demod_mode</span><span class="p">;</span>
	<span class="n">stv0900_st_dvbs2_single</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">demod_mode</span><span class="p">,</span>	<span class="n">STV0900_DEMOD_1</span><span class="p">);</span>
	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_MID</span><span class="p">);</span>
	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">rolloff</span> <span class="o">=</span> <span class="n">p_init</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">;</span>
	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">quartz</span> <span class="o">=</span> <span class="n">p_init</span><span class="o">-&gt;</span><span class="n">dmd_ref_clk</span><span class="p">;</span>

	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_ROLLOFF_CONTROL</span><span class="p">,</span> <span class="n">p_init</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">);</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_ROLLOFF_CONTROL</span><span class="p">,</span> <span class="n">p_init</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">);</span>

	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">ts_config</span> <span class="o">=</span> <span class="n">p_init</span><span class="o">-&gt;</span><span class="n">ts_config</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">ts_config</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">stv0900_set_ts_parallel_serial</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
				<span class="n">p_init</span><span class="o">-&gt;</span><span class="n">path1_ts_clock</span><span class="p">,</span>
				<span class="n">p_init</span><span class="o">-&gt;</span><span class="n">path2_ts_clock</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">ts_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span>
					<span class="n">intp</span><span class="o">-&gt;</span><span class="n">ts_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
					<span class="n">intp</span><span class="o">-&gt;</span><span class="n">ts_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">);</span>

		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_RST_HWARE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_RST_HWARE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_RST_HWARE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_RST_HWARE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">tuner_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_init</span><span class="o">-&gt;</span><span class="n">tuner1_type</span><span class="p">;</span>
	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">tuner_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_init</span><span class="o">-&gt;</span><span class="n">tuner2_type</span><span class="p">;</span>
	<span class="cm">/* tuner init */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p_init</span><span class="o">-&gt;</span><span class="n">tuner1_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/*FE_AUTO_STB6100:*/</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_TNRCFG</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_TNRCFG2</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_TNRCFG3</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_TNRXTAL</span><span class="p">,</span> <span class="mi">27</span><span class="p">);</span> <span class="cm">/* 27MHz */</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_TNRSTEPS</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_TNRGAIN</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_TNRADJ</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_TNRCTL2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_TUN_TYPE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* case FE_SW_TUNER: */</span>
	<span class="nl">default:</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_TUN_TYPE</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_TUN_MADDRESS</span><span class="p">,</span> <span class="n">p_init</span><span class="o">-&gt;</span><span class="n">tun1_maddress</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p_init</span><span class="o">-&gt;</span><span class="n">tuner1_adc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_TSTTNR1</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P1_TNRLD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* hw tuner */</span>

	<span class="cm">/* tuner init */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p_init</span><span class="o">-&gt;</span><span class="n">tuner2_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/*FE_AUTO_STB6100:*/</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_TNRCFG</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_TNRCFG2</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_TNRCFG3</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_TNRXTAL</span><span class="p">,</span> <span class="mi">27</span><span class="p">);</span> <span class="cm">/* 27MHz */</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_TNRSTEPS</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_TNRGAIN</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_TNRADJ</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_TNRCTL2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_TUN_TYPE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* case FE_SW_TUNER: */</span>
	<span class="nl">default:</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_TUN_TYPE</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_TUN_MADDRESS</span><span class="p">,</span> <span class="n">p_init</span><span class="o">-&gt;</span><span class="n">tun2_maddress</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p_init</span><span class="o">-&gt;</span><span class="n">tuner2_adc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_TSTTNR3</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_P2_TNRLD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* hw tuner */</span>

	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P1_TUN_IQSWAP</span><span class="p">,</span> <span class="n">p_init</span><span class="o">-&gt;</span><span class="n">tun1_iq_inv</span><span class="p">);</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">F0900_P2_TUN_IQSWAP</span><span class="p">,</span> <span class="n">p_init</span><span class="o">-&gt;</span><span class="n">tun2_iq_inv</span><span class="p">);</span>
	<span class="n">stv0900_set_mclk</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="mi">135000000</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">clkmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_SYNTCTRL</span><span class="p">,</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">clkmode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">selosci</span> <span class="o">=</span> <span class="mh">0x02</span> <span class="o">&amp;</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_SYNTCTRL</span><span class="p">);</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">R0900_SYNTCTRL</span><span class="p">,</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="n">selosci</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">stv0900_get_mclk_freq</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">quartz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">errs</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">STV0900_I2C_ERROR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_search_state</span> <span class="n">demod_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">locked</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tsbitrate0_val</span><span class="p">,</span> <span class="n">tsbitrate1_val</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">bitrate</span><span class="p">;</span>

	<span class="n">demod_state</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">HEADER_MODE</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">demod_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV0900_SEARCH</span>:
	<span class="k">case</span> <span class="n">STV0900_PLH_DETECTED</span>:
	<span class="nl">default:</span>
		<span class="n">locked</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_DVBS2_FOUND</span>:
		<span class="n">locked</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">LOCK_DEFINITIF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">PKTDELIN_LOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TSFIFO_LINEOK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0900_DVBS_FOUND</span>:
		<span class="n">locked</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">LOCK_DEFINITIF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">LOCKEDVIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TSFIFO_LINEOK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: locked = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">locked</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stvdebug</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Print TS bitrate */</span>
		<span class="n">tsbitrate0_val</span> <span class="o">=</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TSBITRATE0</span><span class="p">);</span>
		<span class="n">tsbitrate1_val</span> <span class="o">=</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TSBITRATE1</span><span class="p">);</span>
		<span class="cm">/* Formula Bit rate = Mclk * px_tsfifo_bitrate / 16384 */</span>
		<span class="n">bitrate</span> <span class="o">=</span> <span class="p">(</span><span class="n">stv0900_get_mclk_freq</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">quartz</span><span class="p">)</span><span class="o">/</span><span class="mi">1000000</span><span class="p">)</span>
			<span class="o">*</span> <span class="p">(</span><span class="n">tsbitrate1_val</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">tsbitrate0_val</span><span class="p">);</span>
		<span class="n">bitrate</span> <span class="o">/=</span> <span class="mi">16384</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;TS bitrate = %d Mbit/sec </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">);</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">locked</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">dvbfe_search</span> <span class="nf">stv0900_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">stv0900_search_params</span> <span class="n">p_search</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_signal_info</span> <span class="n">p_result</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">demod</span><span class="p">];</span>

	<span class="k">enum</span> <span class="n">fe_stv0900_error</span> <span class="n">error</span> <span class="o">=</span> <span class="n">STV0900_NO_ERROR</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">INRANGE</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">,</span> <span class="mi">70000000</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">DVBFE_ALGO_SEARCH_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_ts_params</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_ts_params</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">p_result</span><span class="p">.</span><span class="n">locked</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">p_search</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">demod</span><span class="p">;</span>
	<span class="n">p_search</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">p_search</span><span class="p">.</span><span class="n">symbol_rate</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">;</span>
	<span class="n">p_search</span><span class="p">.</span><span class="n">search_range</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
	<span class="n">p_search</span><span class="p">.</span><span class="n">fec</span> <span class="o">=</span> <span class="n">STV0900_FEC_UNKNOWN</span><span class="p">;</span>
	<span class="n">p_search</span><span class="p">.</span><span class="n">standard</span> <span class="o">=</span> <span class="n">STV0900_AUTO_SEARCH</span><span class="p">;</span>
	<span class="n">p_search</span><span class="p">.</span><span class="n">iq_inversion</span> <span class="o">=</span> <span class="n">STV0900_IQ_AUTO</span><span class="p">;</span>
	<span class="n">p_search</span><span class="p">.</span><span class="n">search_algo</span> <span class="o">=</span> <span class="n">STV0900_BLIND_SEARCH</span><span class="p">;</span>
	<span class="cm">/* Speeds up DVB-S searching */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span> <span class="o">==</span> <span class="n">SYS_DVBS</span><span class="p">)</span>
		<span class="n">p_search</span><span class="p">.</span><span class="n">standard</span> <span class="o">=</span> <span class="n">STV0900_SEARCH_DVBS1</span><span class="p">;</span>

	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">srch_standard</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_search</span><span class="p">.</span><span class="n">standard</span><span class="p">;</span>
	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_search</span><span class="p">.</span><span class="n">symbol_rate</span><span class="p">;</span>
	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">srch_range</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_search</span><span class="p">.</span><span class="n">search_range</span><span class="p">;</span>
	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_search</span><span class="p">.</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">srch_algo</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_search</span><span class="p">.</span><span class="n">search_algo</span><span class="p">;</span>
	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">srch_iq_inv</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_search</span><span class="p">.</span><span class="n">iq_inversion</span><span class="p">;</span>
	<span class="n">intp</span><span class="o">-&gt;</span><span class="n">fec</span><span class="p">[</span><span class="n">demod</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_search</span><span class="p">.</span><span class="n">fec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stv0900_algo</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="o">==</span> <span class="n">STV0900_RANGEOK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">errs</span> <span class="o">==</span> <span class="n">STV0900_NO_ERROR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p_result</span><span class="p">.</span><span class="n">locked</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">demod</span><span class="p">].</span><span class="n">locked</span><span class="p">;</span>
		<span class="n">p_result</span><span class="p">.</span><span class="n">standard</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">demod</span><span class="p">].</span><span class="n">standard</span><span class="p">;</span>
		<span class="n">p_result</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">demod</span><span class="p">].</span><span class="n">frequency</span><span class="p">;</span>
		<span class="n">p_result</span><span class="p">.</span><span class="n">symbol_rate</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">demod</span><span class="p">].</span><span class="n">symbol_rate</span><span class="p">;</span>
		<span class="n">p_result</span><span class="p">.</span><span class="n">fec</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">demod</span><span class="p">].</span><span class="n">fec</span><span class="p">;</span>
		<span class="n">p_result</span><span class="p">.</span><span class="n">modcode</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">demod</span><span class="p">].</span><span class="n">modcode</span><span class="p">;</span>
		<span class="n">p_result</span><span class="p">.</span><span class="n">pilot</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">demod</span><span class="p">].</span><span class="n">pilot</span><span class="p">;</span>
		<span class="n">p_result</span><span class="p">.</span><span class="n">frame_len</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">demod</span><span class="p">].</span><span class="n">frame_len</span><span class="p">;</span>
		<span class="n">p_result</span><span class="p">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">demod</span><span class="p">].</span><span class="n">spectrum</span><span class="p">;</span>
		<span class="n">p_result</span><span class="p">.</span><span class="n">rolloff</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">demod</span><span class="p">].</span><span class="n">rolloff</span><span class="p">;</span>
		<span class="n">p_result</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">demod</span><span class="p">].</span><span class="n">modulation</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">p_result</span><span class="p">.</span><span class="n">locked</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">intp</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">[</span><span class="n">demod</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STV0900_I2C_ERROR</span>:
			<span class="n">error</span> <span class="o">=</span> <span class="n">STV0900_I2C_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STV0900_NO_ERROR</span>:
		<span class="nl">default:</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">STV0900_SEARCH_FAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p_result</span><span class="p">.</span><span class="n">locked</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">STV0900_NO_ERROR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Search Success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">DVBFE_ALGO_SEARCH_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Search Fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">DVBFE_ALGO_SEARCH_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fe_status</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">stv0900_status</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">))</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;DEMOD LOCK OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">FE_HAS_CARRIER</span>
			<span class="o">|</span> <span class="n">FE_HAS_VITERBI</span>
			<span class="o">|</span> <span class="n">FE_HAS_SYNC</span>
			<span class="o">|</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_lock_led</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_lock_led</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_lock_led</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_lock_led</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;DEMOD LOCK FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_stop_ts</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stop_ts</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stop_ts</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">RST_HWARE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">RST_HWARE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_diseqc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">;</span>

	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DISTX_MODE</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">diseqc_mode</span><span class="p">);</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DISEQC_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DISEQC_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">stv0900_stop_ts</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stv0900_diseqc_init</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_diseqc_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span> <span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">NbData</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DIS_PRECHARGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">NbData</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">FIFO_FULL</span><span class="p">))</span>
			<span class="p">;</span><span class="cm">/* checkpatch complains */</span>
		<span class="n">stv0900_write_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DISTXDATA</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DIS_PRECHARGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">TX_IDLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_send_master_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">dvb_diseqc_master_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">stv0900_diseqc_send</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">,</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_send_burst</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_mini_cmd_t</span> <span class="n">burst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">burst</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_MINI_A</span>:
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DISTX_MODE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span><span class="cm">/* Unmodulated */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">stv0900_diseqc_send</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_MINI_B</span>:
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DISTX_MODE</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span><span class="cm">/* Modulated */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">stv0900_diseqc_send</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_recv_slave_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">dvb_diseqc_slave_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">RX_END</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">RX_END</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reply</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">stv0900_get_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">FIFO_BYTENBR</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">reply</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">stv0900_read_reg</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DISRXDATA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_set_tone</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_tone_mode_t</span> <span class="n">toneoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">((</span><span class="n">toneoff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;On&quot;</span> <span class="o">:</span> <span class="s">&quot;Off&quot;</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">toneoff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_TONE_ON</span>:
		<span class="cm">/*Set the DiseqC mode to 22Khz _continues_ tone*/</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DISTX_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DISEQC_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/*release DiseqC reset to enable the 22KHz tone*/</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DISEQC_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_TONE_OFF</span>:
		<span class="cm">/*return diseqc mode to config-&gt;diseqc_mode.</span>
<span class="cm">		Usually it&#39;s without _continues_ tone */</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DISTX_MODE</span><span class="p">,</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">diseqc_mode</span><span class="p">);</span>
		<span class="cm">/*maintain the DiseqC reset to disable the 22KHz tone*/</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DISEQC_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0900_write_bits</span><span class="p">(</span><span class="n">intp</span><span class="p">,</span> <span class="n">DISEQC_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv0900_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_lock_led</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_lock_led</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">--</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">dmds_used</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Actually removing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">remove_inode</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_lock_led</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_lock_led</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0900_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_internal</span> <span class="o">*</span><span class="n">intp</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_demod_num</span> <span class="n">demod</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_signal_info</span> <span class="n">p_result</span> <span class="o">=</span> <span class="n">intp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">demod</span><span class="p">];</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">p_result</span><span class="p">.</span><span class="n">locked</span> <span class="o">?</span> <span class="n">p_result</span><span class="p">.</span><span class="n">frequency</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">=</span> <span class="n">p_result</span><span class="p">.</span><span class="n">locked</span> <span class="o">?</span> <span class="n">p_result</span><span class="p">.</span><span class="n">symbol_rate</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">stv0900_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">SYS_DSS</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;STV0900 frontend&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span>		<span class="o">=</span> <span class="mi">950000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span>		<span class="o">=</span> <span class="mi">2150000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span>	<span class="o">=</span> <span class="mi">125</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_tolerance</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">symbol_rate_min</span>	<span class="o">=</span> <span class="mi">1000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">symbol_rate_max</span>	<span class="o">=</span> <span class="mi">45000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">symbol_rate_tolerance</span>	<span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">caps</span>			<span class="o">=</span> <span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span>
					  <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span>
					  <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_QPSK</span>    <span class="o">|</span>
					  <span class="n">FE_CAN_2G_MODULATION</span> <span class="o">|</span>
					  <span class="n">FE_CAN_FEC_AUTO</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">release</span>			<span class="o">=</span> <span class="n">stv0900_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>				<span class="o">=</span> <span class="n">stv0900_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend</span>                   <span class="o">=</span> <span class="n">stv0900_get_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span>				<span class="o">=</span> <span class="n">stv0900_sleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend_algo</span>		<span class="o">=</span> <span class="n">stv0900_frontend_algo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">i2c_gate_ctrl</span>			<span class="o">=</span> <span class="n">stv0900_i2c_gate_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">diseqc_send_master_cmd</span>		<span class="o">=</span> <span class="n">stv0900_send_master_cmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">diseqc_send_burst</span>		<span class="o">=</span> <span class="n">stv0900_send_burst</span><span class="p">,</span>
	<span class="p">.</span><span class="n">diseqc_recv_slave_reply</span>	<span class="o">=</span> <span class="n">stv0900_recv_slave_reply</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tone</span>			<span class="o">=</span> <span class="n">stv0900_set_tone</span><span class="p">,</span>
	<span class="p">.</span><span class="n">search</span>				<span class="o">=</span> <span class="n">stv0900_search</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>			<span class="o">=</span> <span class="n">stv0900_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span>			<span class="o">=</span> <span class="n">stv0900_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span>		<span class="o">=</span> <span class="n">stv0900_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span>			<span class="o">=</span> <span class="n">stv0900_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span>                  <span class="o">=</span> <span class="n">stv0900_read_ucblocks</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">stv0900_attach</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">stv0900_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0900_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0900_init_params</span> <span class="n">init_params</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fe_stv0900_error</span> <span class="n">err_stv0900</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0900_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span>		<span class="o">=</span> <span class="n">demod</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span>		<span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span>		<span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stv0900_ops</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">demod</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">init_params</span><span class="p">.</span><span class="n">dmd_ref_clk</span>  	<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">xtal</span><span class="p">;</span>
		<span class="n">init_params</span><span class="p">.</span><span class="n">demod_mode</span>		<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_mode</span><span class="p">;</span>
		<span class="n">init_params</span><span class="p">.</span><span class="n">rolloff</span>		<span class="o">=</span> <span class="n">STV0900_35</span><span class="p">;</span>
		<span class="n">init_params</span><span class="p">.</span><span class="n">path1_ts_clock</span>	<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">path1_mode</span><span class="p">;</span>
		<span class="n">init_params</span><span class="p">.</span><span class="n">tun1_maddress</span>	<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tun1_maddress</span><span class="p">;</span>
		<span class="n">init_params</span><span class="p">.</span><span class="n">tun1_iq_inv</span>		<span class="o">=</span> <span class="n">STV0900_IQ_NORMAL</span><span class="p">;</span>
		<span class="n">init_params</span><span class="p">.</span><span class="n">tuner1_adc</span>		<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tun1_adc</span><span class="p">;</span>
		<span class="n">init_params</span><span class="p">.</span><span class="n">tuner1_type</span>		<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tun1_type</span><span class="p">;</span>
		<span class="n">init_params</span><span class="p">.</span><span class="n">path2_ts_clock</span>	<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">path2_mode</span><span class="p">;</span>
		<span class="n">init_params</span><span class="p">.</span><span class="n">ts_config</span>		<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">ts_config_regs</span><span class="p">;</span>
		<span class="n">init_params</span><span class="p">.</span><span class="n">tun2_maddress</span>	<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tun2_maddress</span><span class="p">;</span>
		<span class="n">init_params</span><span class="p">.</span><span class="n">tuner2_adc</span>		<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tun2_adc</span><span class="p">;</span>
		<span class="n">init_params</span><span class="p">.</span><span class="n">tuner2_type</span>		<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tun2_type</span><span class="p">;</span>
		<span class="n">init_params</span><span class="p">.</span><span class="n">tun2_iq_inv</span>		<span class="o">=</span> <span class="n">STV0900_IQ_SWAPPED</span><span class="p">;</span>

		<span class="n">err_stv0900</span> <span class="o">=</span> <span class="n">stv0900_init_internal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">init_params</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err_stv0900</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Attaching STV0900 demodulator(%d) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">demod</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Failed to attach STV0900 demodulator(%d) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">demod</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">stv0900_attach</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Set debug&quot;</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Igor M. Liplianin&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ST STV0900 frontend&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
