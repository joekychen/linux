<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › dib9000.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dib9000.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux-DVB Driver for DiBcom&#39;s DiB9000 and demodulator-family.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-10 DiBcom (http://www.dibcom.fr/)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *	published by the Free Software Foundation, version 2.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &quot;dvb_math.h&quot;</span>
<span class="cp">#include &quot;dvb_frontend.h&quot;</span>

<span class="cp">#include &quot;dib9000.h&quot;</span>
<span class="cp">#include &quot;dibx000_common.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;turn on debugging (default: 0)&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(args...) do { if (debug) { printk(KERN_DEBUG &quot;DiB9000: &quot;); printk(args); printk(&quot;\n&quot;); } } while (0)</span>
<span class="cp">#define MAX_NUMBER_OF_FRONTENDS 6</span>

<span class="k">struct</span> <span class="n">i2c_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i2c_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">i2c_read_buffer</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dib9000_pid_ctrl</span> <span class="p">{</span>
<span class="cp">#define DIB9000_PID_FILTER_CTRL 0</span>
<span class="cp">#define DIB9000_PID_FILTER      1</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">onoff</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_device</span> <span class="n">i2c</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dibx000_i2c_master</span> <span class="n">i2c_master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="n">tuner_adap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="n">component_bus</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">revision</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_offs</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="n">tune_state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_parametersContext</span> <span class="n">channel_status</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">fe_id</span><span class="p">;</span>

<span class="cp">#define DIB9000_GPIO_DEFAULT_DIRECTIONS 0xffff</span>
	<span class="n">u16</span> <span class="n">gpio_dir</span><span class="p">;</span>
<span class="cp">#define DIB9000_GPIO_DEFAULT_VALUES     0x0000</span>
	<span class="n">u16</span> <span class="n">gpio_val</span><span class="p">;</span>
<span class="cp">#define DIB9000_GPIO_DEFAULT_PWM_POS    0xffff</span>
	<span class="n">u16</span> <span class="n">gpio_pwm_pos</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>			<span class="cm">/* common for all chips */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">mobile_mode</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">host</span><span class="p">;</span>

		<span class="k">struct</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dib9000_fe_memory_map</span> <span class="p">{</span>
				<span class="n">u16</span> <span class="n">addr</span><span class="p">;</span>
				<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
			<span class="p">}</span> <span class="n">fe_mm</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
			<span class="n">u8</span> <span class="n">memcmd</span><span class="p">;</span>

			<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mbx_if_lock</span><span class="p">;</span>	<span class="cm">/* to protect read/write operations */</span>
			<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mbx_lock</span><span class="p">;</span>	<span class="cm">/* to protect the whole mailbox handling */</span>

			<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mem_lock</span><span class="p">;</span>	<span class="cm">/* to protect the memory accesses */</span>
			<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mem_mbx_lock</span><span class="p">;</span>	<span class="cm">/* to protect the memory-based mailbox */</span>

<span class="cp">#define MBX_MAX_WORDS (256 - 200 - 2)</span>
<span class="cp">#define DIB9000_MSG_CACHE_SIZE 2</span>
			<span class="n">u16</span> <span class="n">message_cache</span><span class="p">[</span><span class="n">DIB9000_MSG_CACHE_SIZE</span><span class="p">][</span><span class="n">MBX_MAX_WORDS</span><span class="p">];</span>
			<span class="n">u8</span> <span class="n">fw_is_running</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">risc</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">platform</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>			<span class="cm">/* common for all platforms */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dib9000_config</span> <span class="n">cfg</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">d9</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">chip</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">[</span><span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">component_bus_speed</span><span class="p">;</span>

	<span class="cm">/* for the I2C transfer */</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">demod_lock</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">get_frontend_internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib9000_pid_ctrl</span> <span class="n">pid_ctrl</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">s8</span> <span class="n">pid_ctrl_index</span><span class="p">;</span> <span class="cm">/* -1: empty list; -2: do not use the list */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">fe_info</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dib9000_power_mode</span> <span class="p">{</span>
	<span class="n">DIB9000_POWER_ALL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

	<span class="n">DIB9000_POWER_NO</span><span class="p">,</span>
	<span class="n">DIB9000_POWER_INTERF_ANALOG_AGC</span><span class="p">,</span>
	<span class="n">DIB9000_POWER_COR4_DINTLV_ICIRM_EQUAL_CFROD</span><span class="p">,</span>
	<span class="n">DIB9000_POWER_COR4_CRY_ESRAM_MOUT_NUD</span><span class="p">,</span>
	<span class="n">DIB9000_POWER_INTERFACE_ONLY</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dib9000_out_messages</span> <span class="p">{</span>
	<span class="n">OUT_MSG_HBM_ACK</span><span class="p">,</span>
	<span class="n">OUT_MSG_HOST_BUF_FAIL</span><span class="p">,</span>
	<span class="n">OUT_MSG_REQ_VERSION</span><span class="p">,</span>
	<span class="n">OUT_MSG_BRIDGE_I2C_W</span><span class="p">,</span>
	<span class="n">OUT_MSG_BRIDGE_I2C_R</span><span class="p">,</span>
	<span class="n">OUT_MSG_BRIDGE_APB_W</span><span class="p">,</span>
	<span class="n">OUT_MSG_BRIDGE_APB_R</span><span class="p">,</span>
	<span class="n">OUT_MSG_SCAN_CHANNEL</span><span class="p">,</span>
	<span class="n">OUT_MSG_MONIT_DEMOD</span><span class="p">,</span>
	<span class="n">OUT_MSG_CONF_GPIO</span><span class="p">,</span>
	<span class="n">OUT_MSG_DEBUG_HELP</span><span class="p">,</span>
	<span class="n">OUT_MSG_SUBBAND_SEL</span><span class="p">,</span>
	<span class="n">OUT_MSG_ENABLE_TIME_SLICE</span><span class="p">,</span>
	<span class="n">OUT_MSG_FE_FW_DL</span><span class="p">,</span>
	<span class="n">OUT_MSG_FE_CHANNEL_SEARCH</span><span class="p">,</span>
	<span class="n">OUT_MSG_FE_CHANNEL_TUNE</span><span class="p">,</span>
	<span class="n">OUT_MSG_FE_SLEEP</span><span class="p">,</span>
	<span class="n">OUT_MSG_FE_SYNC</span><span class="p">,</span>
	<span class="n">OUT_MSG_CTL_MONIT</span><span class="p">,</span>

	<span class="n">OUT_MSG_CONF_SVC</span><span class="p">,</span>
	<span class="n">OUT_MSG_SET_HBM</span><span class="p">,</span>
	<span class="n">OUT_MSG_INIT_DEMOD</span><span class="p">,</span>
	<span class="n">OUT_MSG_ENABLE_DIVERSITY</span><span class="p">,</span>
	<span class="n">OUT_MSG_SET_OUTPUT_MODE</span><span class="p">,</span>
	<span class="n">OUT_MSG_SET_PRIORITARY_CHANNEL</span><span class="p">,</span>
	<span class="n">OUT_MSG_ACK_FRG</span><span class="p">,</span>
	<span class="n">OUT_MSG_INIT_PMU</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dib9000_in_messages</span> <span class="p">{</span>
	<span class="n">IN_MSG_DATA</span><span class="p">,</span>
	<span class="n">IN_MSG_FRAME_INFO</span><span class="p">,</span>
	<span class="n">IN_MSG_CTL_MONIT</span><span class="p">,</span>
	<span class="n">IN_MSG_ACK_FREE_ITEM</span><span class="p">,</span>
	<span class="n">IN_MSG_DEBUG_BUF</span><span class="p">,</span>
	<span class="n">IN_MSG_MPE_MONITOR</span><span class="p">,</span>
	<span class="n">IN_MSG_RAWTS_MONITOR</span><span class="p">,</span>
	<span class="n">IN_MSG_END_BRIDGE_I2C_RW</span><span class="p">,</span>
	<span class="n">IN_MSG_END_BRIDGE_APB_RW</span><span class="p">,</span>
	<span class="n">IN_MSG_VERSION</span><span class="p">,</span>
	<span class="n">IN_MSG_END_OF_SCAN</span><span class="p">,</span>
	<span class="n">IN_MSG_MONIT_DEMOD</span><span class="p">,</span>
	<span class="n">IN_MSG_ERROR</span><span class="p">,</span>
	<span class="n">IN_MSG_FE_FW_DL_DONE</span><span class="p">,</span>
	<span class="n">IN_MSG_EVENT</span><span class="p">,</span>
	<span class="n">IN_MSG_ACK_CHANGE_SVC</span><span class="p">,</span>
	<span class="n">IN_MSG_HBM_PROF</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* memory_access requests */</span>
<span class="cp">#define FE_MM_W_CHANNEL                   0</span>
<span class="cp">#define FE_MM_W_FE_INFO                   1</span>
<span class="cp">#define FE_MM_RW_SYNC                     2</span>

<span class="cp">#define FE_SYNC_CHANNEL          1</span>
<span class="cp">#define FE_SYNC_W_GENERIC_MONIT	 2</span>
<span class="cp">#define FE_SYNC_COMPONENT_ACCESS 3</span>

<span class="cp">#define FE_MM_R_CHANNEL_SEARCH_STATE      3</span>
<span class="cp">#define FE_MM_R_CHANNEL_UNION_CONTEXT     4</span>
<span class="cp">#define FE_MM_R_FE_INFO                   5</span>
<span class="cp">#define FE_MM_R_FE_MONITOR                6</span>

<span class="cp">#define FE_MM_W_CHANNEL_HEAD              7</span>
<span class="cp">#define FE_MM_W_CHANNEL_UNION             8</span>
<span class="cp">#define FE_MM_W_CHANNEL_CONTEXT           9</span>
<span class="cp">#define FE_MM_R_CHANNEL_UNION            10</span>
<span class="cp">#define FE_MM_R_CHANNEL_CONTEXT          11</span>
<span class="cp">#define FE_MM_R_CHANNEL_TUNE_STATE       12</span>

<span class="cp">#define FE_MM_R_GENERIC_MONITORING_SIZE	 13</span>
<span class="cp">#define FE_MM_W_GENERIC_MONITORING	     14</span>
<span class="cp">#define FE_MM_R_GENERIC_MONITORING	     15</span>

<span class="cp">#define FE_MM_W_COMPONENT_ACCESS         16</span>
<span class="cp">#define FE_MM_RW_COMPONENT_ACCESS_BUFFER 17</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dib9000_risc_apb_access_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attribute</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">tx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">txlen</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dib9000_risc_apb_access_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attribute</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">to_fw_output_mode</span><span class="p">(</span><span class="n">u16</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OUTMODE_HIGH_Z</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_GATED_CLK</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_CONT_CLK</span>:
		<span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_SERIAL</span>:
		<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_DIVERSITY</span>:
		<span class="k">return</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_FIFO</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_ANALOG_ADC</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dib9000_read16_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attribute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">126</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fw_is_running</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">dib9000_risc_apb_access_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attribute</span> <span class="o">&amp;</span> <span class="n">DATA_BUS_ACCESS_MODE_8BIT</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attribute</span> <span class="o">&amp;</span> <span class="n">DATA_BUS_ACCESS_MODE_NO_ADDRESS_INCREMENT</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">chunk_size</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="n">chunk_size</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">?</span> <span class="o">-</span><span class="n">EREMOTEIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;i2c read error on %d&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">b</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">l</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">attribute</span> <span class="o">&amp;</span> <span class="n">DATA_BUS_ACCESS_MODE_NO_ADDRESS_INCREMENT</span><span class="p">))</span>
			<span class="n">reg</span> <span class="o">+=</span> <span class="n">l</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dib9000_i2c_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_device</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;read register %x error&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">dib9000_read_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_read16_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">dib9000_read_word_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attribute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_read16_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">attribute</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="cp">#define dib9000_read16_noinc_attr(state, reg, b, len, attribute) dib9000_read16_attr(state, reg, b, len, (attribute) | DATA_BUS_ACCESS_MODE_NO_ADDRESS_INCREMENT)</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dib9000_write16_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attribute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">126</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fw_is_running</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_risc_apb_access_write</span>
		    <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">DATA_BUS_ACCESS_MODE_16BIT</span> <span class="o">|</span> <span class="n">DATA_BUS_ACCESS_MODE_NO_ADDRESS_INCREMENT</span> <span class="o">|</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attribute</span> <span class="o">&amp;</span> <span class="n">DATA_BUS_ACCESS_MODE_8BIT</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attribute</span> <span class="o">&amp;</span> <span class="n">DATA_BUS_ACCESS_MODE_NO_ADDRESS_INCREMENT</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">chunk_size</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="n">chunk_size</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">?</span> <span class="o">-</span><span class="n">EREMOTEIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">l</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">attribute</span> <span class="o">&amp;</span> <span class="n">DATA_BUS_ACCESS_MODE_NO_ADDRESS_INCREMENT</span><span class="p">))</span>
			<span class="n">reg</span> <span class="o">+=</span> <span class="n">l</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_i2c_write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_device</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span>
	<span class="p">};</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">?</span> <span class="o">-</span><span class="n">EREMOTEIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dib9000_write_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="p">};</span>
	<span class="k">return</span> <span class="n">dib9000_write16_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dib9000_write_word_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attribute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="p">};</span>
	<span class="k">return</span> <span class="n">dib9000_write16_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">attribute</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define dib9000_write(state, reg, buf, len) dib9000_write16_attr(state, reg, buf, len, 0)</span>
<span class="cp">#define dib9000_write16_noinc(state, reg, buf, len) dib9000_write16_attr(state, reg, buf, len, DATA_BUS_ACCESS_MODE_NO_ADDRESS_INCREMENT)</span>
<span class="cp">#define dib9000_write16_noinc_attr(state, reg, buf, len, attribute) dib9000_write16_attr(state, reg, buf, len, DATA_BUS_ACCESS_MODE_NO_ADDRESS_INCREMENT | (attribute))</span>

<span class="cp">#define dib9000_mbx_send(state, id, data, len) dib9000_mbx_send_attr(state, id, data, len, 0)</span>
<span class="cp">#define dib9000_mbx_get_message(state, id, msg, len) dib9000_mbx_get_message_attr(state, id, msg, len, 0)</span>

<span class="cp">#define MAC_IRQ      (1 &lt;&lt; 1)</span>
<span class="cp">#define IRQ_POL_MSK  (1 &lt;&lt; 4)</span>

<span class="cp">#define dib9000_risc_mem_read_chunks(state, b, len) dib9000_read16_attr(state, 1063, b, len, DATA_BUS_ACCESS_MODE_8BIT | DATA_BUS_ACCESS_MODE_NO_ADDRESS_INCREMENT)</span>
<span class="cp">#define dib9000_risc_mem_write_chunks(state, buf, len) dib9000_write16_attr(state, 1063, buf, len, DATA_BUS_ACCESS_MODE_8BIT | DATA_BUS_ACCESS_MODE_NO_ADDRESS_INCREMENT)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib9000_risc_mem_setup_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reading</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

<span class="cm">/*      dprintk(&quot;%d memcmd: %d %d %d\n&quot;, state-&gt;fe_id, addr, addr+len, len); */</span>
<span class="cm">/*      b[0] = 0 &lt;&lt; 7; */</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/*      b[2] = 0; */</span>
<span class="cm">/*      b[3] = 0; */</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

<span class="cm">/*      b[10] = 0; */</span>
<span class="cm">/*      b[11] = 0; */</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<span class="cm">/*      b[6] = 0; */</span>
<span class="cm">/*      b[7] = 0; */</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">dib9000_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1056</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reading</span><span class="p">)</span>
		<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1056</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">memcmd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* if it was called directly reset it - to force a future setup-call to set it */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib9000_risc_mem_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_fe_memory_map</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fe_mm</span><span class="p">[</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">];</span>
	<span class="cm">/* decide whether we need to &quot;refresh&quot; the memory controller */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">memcmd</span> <span class="o">==</span> <span class="n">cmd</span> <span class="o">&amp;&amp;</span>	<span class="cm">/* same command */</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0x80</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">67</span><span class="p">))</span>	<span class="cm">/* and we do not want to read something with less than 67 bytes looping - working around a bug in the memory controller */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dib9000_risc_mem_setup_cmd</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">memcmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_risc_mem_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fw_is_running</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib9000_risc_mem_setup</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">dib9000_risc_mem_read_chunks</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_risc_mem_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_fe_memory_map</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fe_mm</span><span class="p">[</span><span class="n">cmd</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fw_is_running</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib9000_risc_mem_setup</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">dib9000_risc_mem_write_chunks</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_firmware_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">risc_id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">code</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">offs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">risc_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">offs</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* config crtl reg */</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1024</span> <span class="o">+</span> <span class="n">offs</span><span class="p">,</span> <span class="mh">0x000f</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1025</span> <span class="o">+</span> <span class="n">offs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1031</span> <span class="o">+</span> <span class="n">offs</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;going to download %dB of microcode&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_write16_noinc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1026</span> <span class="o">+</span> <span class="n">offs</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;error while downloading microcode for RISC %c&quot;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">risc_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Microcode for RISC %c loaded&quot;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">risc_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_mbx_host_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">risc_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">mbox_offs</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reset_reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tries</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">risc_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mbox_offs</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mbox_offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reset mailbox  */</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1027</span> <span class="o">+</span> <span class="n">mbox_offs</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>

	<span class="cm">/* Read reset status */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">reset_reg</span> <span class="o">=</span> <span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1027</span> <span class="o">+</span> <span class="n">mbox_offs</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">reset_reg</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">tries</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset_reg</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;MBX: init ERROR, no response from RISC %c&quot;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">risc_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;MBX: initialized&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_MAILBOX_TRY 100</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_mbx_send_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fw_is_running</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mbx_if_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">MAX_MAILBOX_TRY</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">dib9000_read_word_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1043</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MBX_MAX_WORDS</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;MBX: RISC mbx full, retrying&quot;</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*dprintk( &quot;MBX: size: %d&quot;, size); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef DUMP_MSG</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %02x %d &quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%04x &quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* byte-order conversion - works on big (where it is not necessary) or little endian */</span>
	<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write msg */</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_write16_noinc_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1045</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dib9000_write16_noinc_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1045</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update register nb_mes_in_RX */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">dib9000_write_word_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1043</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mbx_if_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">dib9000_mbx_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">risc_id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DUMP_MSG</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">u16</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mc_base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fw_is_running</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mbx_if_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">risc_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mc_base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mc_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Length and type in the first word */</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dib9000_read_word_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1029</span> <span class="o">+</span> <span class="n">mc_base</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">MBX_MAX_WORDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">++</span><span class="p">;</span>
		<span class="n">size</span><span class="o">--</span><span class="p">;</span>		<span class="cm">/* Initial word already read */</span>

		<span class="n">dib9000_read16_noinc_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1029</span> <span class="o">+</span> <span class="n">mc_base</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

		<span class="cm">/* to word conversion */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">data</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifdef DUMP_MSG</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%04x &quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;MBX: message is too big for message cache (%d), flushing message&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">size</span><span class="o">--</span><span class="p">;</span>		<span class="cm">/* Initial word already read */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="o">--</span><span class="p">)</span>
			<span class="n">dib9000_read16_noinc_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1029</span> <span class="o">+</span> <span class="n">mc_base</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Update register nb_mes_in_TX */</span>
	<span class="n">dib9000_write_word_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1028</span> <span class="o">+</span> <span class="n">mc_base</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mbx_if_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_risc_debug_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">b</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>	<span class="cm">/* Bullet proof the buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">b</span> <span class="o">==</span> <span class="sc">&#39;~&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RISC%d: %d.%04d %s&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe_id</span><span class="p">,</span> <span class="n">ts</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">ts</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span> <span class="o">?</span> <span class="n">b</span> <span class="o">:</span> <span class="s">&quot;&lt;emtpy&gt;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_mbx_fetch_to_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="cm">/* find a free slot */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DIB9000_MSG_CACHE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">message_cache</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">block</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">dib9000_mbx_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

<span class="cm">/*                      dprintk( &quot;MBX: fetched %04x message to cache&quot;, *block); */</span>

			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IN_MSG_DEBUG_BUF</span>:
				<span class="n">dib9000_risc_debug_buf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>	<span class="cm">/* debug-messages are going to be printed right away */</span>
				<span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* free the block */</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			case IN_MSG_DATA:	/* FE-TRACE */</span>
<span class="c">				dib9000_risc_data_process(state, block + 1, size);</span>
<span class="c">				*block = 0;</span>
<span class="c">				break;</span>
<span class="cp">#endif</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;MBX: no free cache-slot found for new message...&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">dib9000_mbx_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">risc_id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">risc_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">dib9000_read_word_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1028</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>	<span class="cm">/* 5 bit field */</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">dib9000_read_word_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1044</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>	<span class="cm">/* 7 bit field */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_mbx_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fw_is_running</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mbx_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_mbx_count</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>	<span class="cm">/* 1=RiscB */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dib9000_mbx_fetch_to_cache</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

	<span class="n">dib9000_read_word_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1229</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>	<span class="cm">/* Clear the IRQ */</span>
<span class="cm">/*      if (tmp) */</span>
<span class="cm">/*              dprintk( &quot;cleared IRQ: %x&quot;, tmp); */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mbx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_mbx_get_message_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">id</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">size</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* dib9000_mbx_get_from_cache(); */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DIB9000_MSG_CACHE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">block</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">message_cache</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">block</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
				<span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* free the block */</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* signal that we found a message */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_mbx_process</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>	<span class="cm">/* try to fetch one message - if any */</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;waiting for message %d timed out&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_risc_check_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fw_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_mbx_send</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUT_MSG_REQ_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_version</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_mbx_get_message</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IN_MSG_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">fw_version</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RISC: ver: %d.%02d (IC: %d)&quot;</span><span class="p">,</span> <span class="n">fw_version</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">fw_version</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fw_version</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fw_version</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">11</span>:
	<span class="k">case</span> <span class="mi">12</span>:
	<span class="k">case</span> <span class="mi">14</span>:
	<span class="k">case</span> <span class="mi">15</span>:
	<span class="k">case</span> <span class="mi">16</span>:
	<span class="k">case</span> <span class="mi">17</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RISC: invalid firmware version&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;RISC: valid firmware version&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_fw_boot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">codeA</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lenA</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">codeB</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lenB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Reconfig pool mac ram */</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1225</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>	<span class="cm">/* A: 8k C, 4 k D - B: 32k C 6 k D - IRAM 96k */</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1226</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>

	<span class="cm">/* Toggles IP crypto to Host APB interface. */</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1542</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Set jump and no jump in the dma box */</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1074</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1075</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set MAC as APB Master. */</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1237</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Reset the RISCs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codeA</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codeB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1040</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codeA</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dib9000_firmware_download</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1234</span><span class="p">,</span> <span class="n">codeA</span><span class="p">,</span> <span class="n">lenA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codeB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dib9000_firmware_download</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x1234</span><span class="p">,</span> <span class="n">codeB</span><span class="p">,</span> <span class="n">lenB</span><span class="p">);</span>

	<span class="cm">/* Run the RISCs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codeA</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codeB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1040</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">codeA</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_mbx_host_init</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codeB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_mbx_host_init</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fw_is_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_risc_check_version</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">memcmd</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dib9000_identify</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_device</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">dib9000_i2c_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">896</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mh">0x01b3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;wrong Vendor ID (0x%x)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">dib9000_i2c_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">897</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mh">0x4000</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="mh">0x4001</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="mh">0x4002</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="mh">0x4003</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="mh">0x4004</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="mh">0x4005</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;wrong Device ID (0x%x)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* protect this driver to be used with 7000PC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mh">0x4000</span> <span class="o">&amp;&amp;</span> <span class="n">dib9000_i2c_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">769</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;this driver does not work with DiB7000PC&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x4000</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found DiB7000MA/PA/MB/PB&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4001</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found DiB7000HC&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4002</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found DiB7000MC&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4003</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found DiB9000A&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4004</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found DiB9000H&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4005</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found DiB9000M&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib9000_set_power_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dib9000_power_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* by default everything is going to be powered off */</span>
	<span class="n">u16</span> <span class="n">reg_903</span> <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">,</span> <span class="n">reg_904</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">reg_905</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">reg_906</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x4003</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x4004</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x4005</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg_906</span> <span class="o">=</span> <span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">906</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">;</span>	<span class="cm">/* keep settings for RISC */</span>

	<span class="cm">/* now, depending on the requested mode, we power on */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* power up everything in the demod */</span>
	<span class="k">case</span> <span class="n">DIB9000_POWER_ALL</span>:
		<span class="n">reg_903</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">reg_904</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">reg_905</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">reg_906</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* just leave power on the control-interfaces: GPIO and (I2C or SDIO or SRAM) */</span>
	<span class="k">case</span> <span class="n">DIB9000_POWER_INTERFACE_ONLY</span>:	<span class="cm">/* TODO power up either SDIO or I2C or SRAM */</span>
		<span class="n">reg_905</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIB9000_POWER_INTERF_ANALOG_AGC</span>:
		<span class="n">reg_903</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>
		<span class="n">reg_905</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">reg_906</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIB9000_POWER_COR4_DINTLV_ICIRM_EQUAL_CFROD</span>:
		<span class="n">reg_903</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">reg_904</span> <span class="o">=</span> <span class="mh">0x801f</span><span class="p">;</span>
		<span class="n">reg_905</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">reg_906</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIB9000_POWER_COR4_CRY_ESRAM_MOUT_NUD</span>:
		<span class="n">reg_903</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">reg_904</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="n">reg_905</span> <span class="o">=</span> <span class="mh">0x010b</span><span class="p">;</span>
		<span class="n">reg_906</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">DIB9000_POWER_NO</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* always power down unused parts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">host</span><span class="p">.</span><span class="n">mobile_mode</span><span class="p">)</span>
		<span class="n">reg_904</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* P_sdio_select_clk = 0 on MC and after */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="n">reg_906</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">903</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg_903</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">904</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg_904</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">905</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg_905</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">906</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg_906</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_fw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1817</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>

	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1227</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1227</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">dib9000_identify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">)))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x4003</span>:
	<span class="k">case</span> <span class="mh">0x4004</span>:
	<span class="k">case</span> <span class="mh">0x4005</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset the i2c-master to use the host interface */</span>
	<span class="n">dibx000_reset_i2c_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">);</span>

	<span class="n">dib9000_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB9000_POWER_ALL</span><span class="p">);</span>

	<span class="cm">/* unforce divstr regardless whether i2c enumeration was done or not */</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1794</span><span class="p">,</span> <span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1794</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1796</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1805</span><span class="p">,</span> <span class="mh">0x805</span><span class="p">);</span>

	<span class="cm">/* restart all parts */</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">898</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">899</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">901</span><span class="p">,</span> <span class="mh">0xff19</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">902</span><span class="p">,</span> <span class="mh">0x003c</span><span class="p">);</span>

	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">898</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">899</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">901</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">902</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">911</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">if_drives</span><span class="p">);</span>

	<span class="n">dib9000_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB9000_POWER_INTERFACE_ONLY</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_risc_apb_access_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attribute</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">tx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">txlen</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="mi">1024</span> <span class="o">||</span> <span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fw_is_running</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* dprintk( &quot;APB access thru rd fw %d %x&quot;, address, attribute); */</span>

	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">dib9000_mbx_send_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUT_MSG_BRIDGE_APB_R</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">attribute</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dib9000_mbx_get_message_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IN_MSG_END_BRIDGE_APB_RW</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">attribute</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">s</span><span class="o">--</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">b</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_risc_apb_access_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">attribute</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="mi">1024</span> <span class="o">||</span> <span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fw_is_running</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* dprintk( &quot;APB access thru wr fw %d %x&quot;, address, attribute); */</span>

	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">address</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>

	<span class="n">dib9000_mbx_send_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUT_MSG_BRIDGE_APB_W</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">attribute</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dib9000_mbx_get_message_attr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IN_MSG_END_BRIDGE_APB_RW</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_fw_memmbx_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">index_loop</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fw_is_running</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dib9000_risc_mem_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_RW_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dib9000_risc_mem_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_RW_SYNC</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">index_loop</span><span class="o">--</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index_loop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_fw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dibGPIOFunction</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">b</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_fw_boot</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">microcode_B_fe_buffer</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">microcode_B_fe_size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* initialize the firmware */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_function</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_function</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">BOARD_GPIO_FUNCTION_COMPONENT_ON</span>:
				<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">;</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BOARD_GPIO_FUNCTION_COMPONENT_OFF</span>:
				<span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">;</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_mbx_send</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUT_MSG_CONF_GPIO</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* subband */</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">subband</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>	<span class="cm">/* type == 0 -&gt; GPIO - PWM not yet supported */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">subband</span><span class="p">.</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">subband</span><span class="p">.</span><span class="n">subband</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">f_mhz</span><span class="p">;</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">subband</span><span class="p">.</span><span class="n">subband</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span><span class="p">.</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">subband</span><span class="p">.</span><span class="n">subband</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span><span class="p">.</span><span class="n">direction</span><span class="p">;</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">subband</span><span class="p">.</span><span class="n">subband</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* fe_id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_mbx_send</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUT_MSG_SUBBAND_SEL</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* 0 - id, 1 - no_of_frontends */</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* 0 = i2c-address demod, 0 = tuner */</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">xtal_clock_khz</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">xtal_clock_khz</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">vcxo_timer</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">vcxo_timer</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">timing_frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">timing_frequency</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">if_drives</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_mbx_send</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUT_MSG_INIT_DEMOD</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_mbx_send</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUT_MSG_FE_FW_DL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_mbx_get_message</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IN_MSG_FE_FW_DL_DONE</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;error : firmware returned %dbytes needed but the used buffer has only %dbytes</span><span class="se">\n</span><span class="s"> Firmware init ABORTED&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fe_mm</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fe_mm</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib9000_fw_set_channel_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe_id</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">+=</span> <span class="mi">101</span><span class="p">;</span>

	<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">freq</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">freq</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">freq</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">freq</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>		<span class="cm">/* do not wait for CELL ID when doing autosearch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">==</span> <span class="n">SYS_DVBT</span><span class="p">)</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dib9000_risc_mem_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_W_CHANNEL_HEAD</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_fw_get_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dibDVBTChannel</span> <span class="p">{</span>
		<span class="n">s8</span> <span class="n">spectrum_inversion</span><span class="p">;</span>

		<span class="n">s8</span> <span class="n">nfft</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">guard</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">constellation</span><span class="p">;</span>

		<span class="n">s8</span> <span class="n">hrch</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">alpha</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">code_rate_hp</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">code_rate_lp</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">select_hp</span><span class="p">;</span>

		<span class="n">s8</span> <span class="n">intlv_native</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">dibDVBTChannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_fw_memmbx_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_SYNC_CHANNEL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dib9000_risc_mem_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_R_CHANNEL_UNION</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dibDVBTChannel</span><span class="p">));</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dibDVBTChannel</span> <span class="o">*</span><span class="p">)</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">;</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">spectrum_inversion</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">INVERSION_ON</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">INVERSION_OFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">INVERSION_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">nfft</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_2K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_4K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">constellation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QPSK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">hrch</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">code_rate_hp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_1_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_5_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_7_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">code_rate_lp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_1_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_5_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_7_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_fw_set_channel_union</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dibDVBTChannel</span> <span class="p">{</span>
		<span class="n">s8</span> <span class="n">spectrum_inversion</span><span class="p">;</span>

		<span class="n">s8</span> <span class="n">nfft</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">guard</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">constellation</span><span class="p">;</span>

		<span class="n">s8</span> <span class="n">hrch</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">alpha</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">code_rate_hp</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">code_rate_lp</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">select_hp</span><span class="p">;</span>

		<span class="n">s8</span> <span class="n">intlv_native</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">dibDVBTChannel</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INVERSION_ON</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">spectrum_inversion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INVERSION_OFF</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">spectrum_inversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">INVERSION_AUTO</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">spectrum_inversion</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">nfft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">nfft</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">nfft</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_AUTO</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">nfft</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_32</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_16</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">guard</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_8</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">guard</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_4</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">guard</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_AUTO</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">guard</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QAM_64</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">constellation</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_16</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">constellation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QPSK</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">constellation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">QAM_AUTO</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">constellation</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">hierarchy</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HIERARCHY_NONE</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">hrch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HIERARCHY_1</span>:
	<span class="k">case</span> <span class="n">HIERARCHY_2</span>:
	<span class="k">case</span> <span class="n">HIERARCHY_4</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">hrch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">HIERARCHY_AUTO</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">hrch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ch</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_HP</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FEC_1_2</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">code_rate_hp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_2_3</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">code_rate_hp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_3_4</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">code_rate_hp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_5_6</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">code_rate_hp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_7_8</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">code_rate_hp</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">FEC_AUTO</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">code_rate_hp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_LP</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FEC_1_2</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">code_rate_lp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_2_3</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">code_rate_lp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_3_4</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">code_rate_lp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_5_6</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">code_rate_lp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_7_8</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">code_rate_lp</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">FEC_AUTO</span>:
		<span class="n">ch</span><span class="p">.</span><span class="n">code_rate_lp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ch</span><span class="p">.</span><span class="n">select_hp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ch</span><span class="p">.</span><span class="n">intlv_native</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dib9000_risc_mem_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_W_CHANNEL_UNION</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_fw_tune</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">search</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">channel_status</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">CHANNEL_STATUS_PARAMETERS_UNKNOWN</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CT_DEMOD_START</span>:
		<span class="n">dib9000_fw_set_channel_head</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="cm">/* write the channel context - a channel is initialized to 0, so it is OK */</span>
		<span class="n">dib9000_risc_mem_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_W_CHANNEL_CONTEXT</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe_info</span><span class="p">);</span>
		<span class="n">dib9000_risc_mem_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_W_FE_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">fe_info</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">search</span><span class="p">)</span>
			<span class="n">dib9000_mbx_send</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUT_MSG_FE_CHANNEL_SEARCH</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dib9000_fw_set_channel_union</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
			<span class="n">dib9000_mbx_send</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUT_MSG_FE_CHANNEL_TUNE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_DEMOD_STEP_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CT_DEMOD_STEP_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">search</span><span class="p">)</span>
			<span class="n">dib9000_risc_mem_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_R_CHANNEL_SEARCH_STATE</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dib9000_risc_mem_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_R_CHANNEL_TUNE_STATE</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* something happened */</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="mi">2</span>:	<span class="cm">/* tps locks are &quot;slower&quot; than MPEG locks -&gt; even in autosearch data is OK here */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">search</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">FE_STATUS_DEMOD_SUCCESS</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_DEMOD_STOP</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">FE_STATUS_LOCKED</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">FE_STATUS_TUNE_FAILED</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_DEMOD_STOP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_fw_set_diversity_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">onoff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dib9000_mbx_send</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUT_MSG_ENABLE_DIVERSITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_fw_set_output_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">outreg</span><span class="p">,</span> <span class="n">smo_mode</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting output mode for demod %p to %d&quot;</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_GATED_CLK</span>:
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>	<span class="cm">/* 0x0400 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_CONT_CLK</span>:
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* 0x0440 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_SERIAL</span>:
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* 0x0482 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_DIVERSITY</span>:
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* 0x0500 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_FIFO</span>:
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_HIGH_Z</span>:
		<span class="n">outreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Unhandled output_mode passed to be set for demod %p&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1795</span><span class="p">,</span> <span class="n">outreg</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_GATED_CLK</span>:
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_CONT_CLK</span>:
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_SERIAL</span>:
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_FIFO</span>:
		<span class="n">smo_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">295</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0010</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mpeg2_in_188_bytes</span><span class="p">)</span>
			<span class="n">smo_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">295</span><span class="p">,</span> <span class="n">smo_mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outreg</span> <span class="o">=</span> <span class="n">to_fw_output_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dib9000_mbx_send</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUT_MSG_SET_OUTPUT_MODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outreg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_tuner_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">index_msg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index_msg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index_msg</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">index_msg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">index_msg</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* read */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">index_msg</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">790</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;TunerITF: read busy&quot;</span><span class="p">);</span>

			<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">784</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">index_msg</span><span class="p">].</span><span class="n">addr</span><span class="p">));</span>
			<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">787</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">786</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* start read */</span>

			<span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">790</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;TunerITF: read failed&quot;</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">785</span><span class="p">);</span>
				<span class="n">msg</span><span class="p">[</span><span class="n">index_msg</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="n">msg</span><span class="p">[</span><span class="n">index_msg</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">790</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;TunerITF: read more data than expected&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">789</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;TunerITF: write busy&quot;</span><span class="p">);</span>

			<span class="n">len</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">index_msg</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">785</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">index_msg</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">msg</span><span class="p">[</span><span class="n">index_msg</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
			<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">784</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">msg</span><span class="p">[</span><span class="n">index_msg</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">787</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">786</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* start write */</span>

			<span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">791</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;TunerITF: write failed&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib9000_fw_set_component_bus_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">component_bus_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_fw_set_component_bus_speed</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_fw_component_bus_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* I2C */</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">DIBX000_I2C_INTERFACE_GPIO_3_4</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">scl</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">component_bus_speed</span><span class="p">;</span>	<span class="cm">/* SCL frequency */</span>
	<span class="k">struct</span> <span class="n">dib9000_fe_memory_map</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">fe_mm</span><span class="p">[</span><span class="n">FE_MM_RW_COMPONENT_ACCESS_BUFFER</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">p</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">scl</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>	<span class="cm">/* scl */</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">scl</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dib9000_risc_mem_write</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_W_COMPONENT_ACCESS</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="p">{</span>			<span class="cm">/* write-part */</span>
		<span class="n">dib9000_risc_mem_setup_cmd</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dib9000_risc_mem_write_chunks</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* do the transaction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_fw_memmbx_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_SYNC_COMPONENT_ACCESS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read back any possible result */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">))</span>
		<span class="n">dib9000_risc_mem_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_RW_COMPONENT_ACCESS_BUFFER</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dib9000_i2c_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I2C_FUNC_I2C</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">dib9000_tuner_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span> <span class="o">=</span> <span class="n">dib9000_tuner_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span> <span class="o">=</span> <span class="n">dib9000_i2c_func</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">dib9000_component_bus_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span> <span class="o">=</span> <span class="n">dib9000_fw_component_bus_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span> <span class="o">=</span> <span class="n">dib9000_i2c_func</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="nf">dib9000_get_tuner_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_adap</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_get_tuner_interface</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="nf">dib9000_get_component_bus_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">component_bus</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_get_component_bus_interface</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="nf">dib9000_get_i2c_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dibx000_i2c_interface</span> <span class="n">intf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gating</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dibx000_get_i2c_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">gating</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_get_i2c_master</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib9000_set_i2c_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_adap</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_set_i2c_adapter</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_cfg_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">u8</span> <span class="n">num</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">=</span> <span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">773</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">);</span>	<span class="cm">/* reset the direction bit */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">;</span>	<span class="cm">/* set the new direction */</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">773</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">);</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">=</span> <span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">774</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">);</span>	<span class="cm">/* reset the direction bit */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">;</span>	<span class="cm">/* set the new value */</span>
	<span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">774</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;gpio dir: %04x: gpio val: %04x&quot;</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib9000_set_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">num</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dib9000_cfg_gpio</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_set_gpio</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib9000_fw_pid_filter_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* postpone the pid filtering cmd */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;pid filter cmd postpone&quot;</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span><span class="o">++</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span><span class="p">].</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">DIB9000_PID_FILTER_CTRL</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span><span class="p">].</span><span class="n">onoff</span> <span class="o">=</span> <span class="n">onoff</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">294</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffef</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">onoff</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;PID filter enabled %d&quot;</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">294</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_fw_pid_filter_ctrl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib9000_fw_pid_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* postpone the pid filtering cmd */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;pid filter postpone&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span><span class="o">++</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span><span class="p">].</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">DIB9000_PID_FILTER</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span><span class="p">].</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span><span class="p">].</span><span class="n">onoff</span> <span class="o">=</span> <span class="n">onoff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;can not add any more pid ctrl cmd&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Index %x, PID %d, OnOff %d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dib9000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">300</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">id</span><span class="p">,</span>
			<span class="n">onoff</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_fw_pid_filter</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib9000_firmware_post_pll_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dib9000_fw_init</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_firmware_post_pll_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib9000_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>

	<span class="n">dibx000_exit_i2c_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">);</span>

	<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_adap</span><span class="p">);</span>
	<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">component_bus</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dib9000_mbx_send</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUT_MSG_FE_SLEEP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_fe_get_tune_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span> <span class="o">*</span><span class="n">tune</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tune</span><span class="o">-&gt;</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span><span class="p">,</span> <span class="n">sub_index_frontend</span><span class="p">;</span>
	<span class="n">fe_status_t</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">get_frontend_internal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_status</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">FE_HAS_SYNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;TPS lock on the slave%i&quot;</span><span class="p">,</span> <span class="n">index_frontend</span><span class="p">);</span>

			<span class="cm">/* synchronize the cache with the other frontends */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_frontend</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">sub_index_frontend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">sub_index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
			     <span class="n">sub_index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sub_index_frontend</span> <span class="o">!=</span> <span class="n">index_frontend</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span>
					    <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">modulation</span><span class="p">;</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span> <span class="o">=</span>
					    <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span><span class="p">;</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span>
					    <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span><span class="p">;</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span>
					    <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span><span class="p">;</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">hierarchy</span> <span class="o">=</span>
					    <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">hierarchy</span><span class="p">;</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_HP</span> <span class="o">=</span>
					    <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_HP</span><span class="p">;</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_LP</span> <span class="o">=</span>
					    <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_LP</span><span class="p">;</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">rolloff</span> <span class="o">=</span>
					    <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">rolloff</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">return_value</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* get the channel from master chip */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dib9000_fw_get_channel</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">return_value</span><span class="p">;</span>

	<span class="cm">/* synchronize the cache with the other frontends */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">modulation</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">hierarchy</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_HP</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_LP</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">rolloff</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">rolloff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">return_value:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">get_frontend_internal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_set_tune_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="n">tune_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">tune_state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_DEMOD_START</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">FE_STATUS_TUNE_PENDING</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dib9000_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_set_channel_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_frontend_parametersContext</span> <span class="o">*</span><span class="n">channel_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">channel_status</span><span class="p">,</span> <span class="n">channel_status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_parametersContext</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sleep_time</span><span class="p">,</span> <span class="n">sleep_time_slave</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frontend_status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nbr_pending</span><span class="p">,</span> <span class="n">exit_condition</span><span class="p">,</span> <span class="n">index_frontend</span><span class="p">,</span> <span class="n">index_frontend_success</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_parametersContext</span> <span class="n">channel_status</span><span class="p">;</span>

	<span class="cm">/* check that the correct parameters are set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib9000: must specify frequency &quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib9000: must specify bandwidth &quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* postpone the pid filtering cmd */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">=</span> <span class="n">SYS_DVBT</span><span class="p">;</span>

	<span class="cm">/* set the master status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">==</span> <span class="n">TRANSMISSION_MODE_AUTO</span> <span class="o">||</span>
	    <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">==</span> <span class="n">GUARD_INTERVAL_AUTO</span> <span class="o">||</span>
	    <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_AUTO</span> <span class="o">||</span>
	    <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">code_rate_HP</span> <span class="o">==</span> <span class="n">FEC_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no channel specified, autosearch the channel */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">channel_status</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CHANNEL_STATUS_PARAMETERS_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">channel_status</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CHANNEL_STATUS_PARAMETERS_SET</span><span class="p">;</span>

	<span class="cm">/* set mode and status for the different frontends */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib9000_fw_set_diversity_in</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* synchronization of the cache */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dtv_frontend_properties</span><span class="p">));</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">=</span> <span class="n">SYS_DVBT</span><span class="p">;</span>
		<span class="n">dib9000_fw_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="n">OUTMODE_HIGH_Z</span><span class="p">);</span>

		<span class="n">dib9000_set_channel_status</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">channel_status</span><span class="p">);</span>
		<span class="n">dib9000_set_tune_state</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="n">CT_DEMOD_START</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* actual tune */</span>
	<span class="n">exit_condition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* 0: tune pending; 1: tune failed; 2:tune success */</span>
	<span class="n">index_frontend_success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">sleep_time</span> <span class="o">=</span> <span class="n">dib9000_fw_tune</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sleep_time_slave</span> <span class="o">=</span> <span class="n">dib9000_fw_tune</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sleep_time</span> <span class="o">==</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">)</span>
				<span class="n">sleep_time</span> <span class="o">=</span> <span class="n">sleep_time_slave</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sleep_time_slave</span> <span class="o">!=</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sleep_time_slave</span> <span class="o">&gt;</span> <span class="n">sleep_time</span><span class="p">))</span>
				<span class="n">sleep_time</span> <span class="o">=</span> <span class="n">sleep_time_slave</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleep_time</span> <span class="o">!=</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">sleep_time</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">nbr_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">exit_condition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">index_frontend_success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frontend_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">dib9000_get_status</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frontend_status</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">FE_STATUS_TUNE_PENDING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">exit_condition</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* tune success */</span>
				<span class="n">index_frontend_success</span> <span class="o">=</span> <span class="n">index_frontend</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frontend_status</span> <span class="o">==</span> <span class="o">-</span><span class="n">FE_STATUS_TUNE_PENDING</span><span class="p">)</span>
				<span class="n">nbr_pending</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* some frontends are still tuning */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">exit_condition</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nbr_pending</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">exit_condition</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* if all tune are done and no success, exit: tune failed */</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exit_condition</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* check the tune result */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exit_condition</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* tune failed */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;tune failed&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
		<span class="cm">/* tune failed; put all the pid filtering cmd to junk */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;tune success on frontend%i&quot;</span><span class="p">,</span> <span class="n">index_frontend_success</span><span class="p">);</span>

	<span class="cm">/* synchronize all the channel cache */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">get_frontend_internal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dib9000_get_frontend</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">get_frontend_internal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* retune the other frontends with the found channel */</span>
	<span class="n">channel_status</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CHANNEL_STATUS_PARAMETERS_SET</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only retune the frontends which was not tuned success */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">!=</span> <span class="n">index_frontend_success</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dib9000_set_channel_status</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">channel_status</span><span class="p">);</span>
			<span class="n">dib9000_set_tune_state</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="n">CT_DEMOD_START</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">sleep_time</span> <span class="o">=</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">!=</span> <span class="n">index_frontend_success</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sleep_time_slave</span> <span class="o">=</span> <span class="n">dib9000_fw_tune</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sleep_time</span> <span class="o">==</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">)</span>
					<span class="n">sleep_time</span> <span class="o">=</span> <span class="n">sleep_time_slave</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sleep_time_slave</span> <span class="o">!=</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sleep_time_slave</span> <span class="o">&gt;</span> <span class="n">sleep_time</span><span class="p">))</span>
					<span class="n">sleep_time</span> <span class="o">=</span> <span class="n">sleep_time_slave</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleep_time</span> <span class="o">!=</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">sleep_time</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">nbr_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">!=</span> <span class="n">index_frontend_success</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">frontend_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">dib9000_get_status</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">index_frontend</span> <span class="o">!=</span> <span class="n">index_frontend_success</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">frontend_status</span> <span class="o">==</span> <span class="o">-</span><span class="n">FE_STATUS_TUNE_PENDING</span><span class="p">))</span>
					<span class="n">nbr_pending</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* some frontends are still tuning */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">nbr_pending</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* set the output mode */</span>
	<span class="n">dib9000_fw_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dib9000_fw_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="n">OUTMODE_DIVERSITY</span><span class="p">);</span>

	<span class="cm">/* turn off the diversity for the last frontend */</span>
	<span class="n">dib9000_fw_set_diversity_in</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">index_pid_filter_cmd</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">pid_ctrl_index</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span><span class="p">;</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index_pid_filter_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">index_pid_filter_cmd</span> <span class="o">&lt;=</span> <span class="n">pid_ctrl_index</span><span class="p">;</span>
				<span class="n">index_pid_filter_cmd</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl</span><span class="p">[</span><span class="n">index_pid_filter_cmd</span><span class="p">].</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">DIB9000_PID_FILTER_CTRL</span><span class="p">)</span>
				<span class="n">dib9000_fw_pid_filter_ctrl</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl</span><span class="p">[</span><span class="n">index_pid_filter_cmd</span><span class="p">].</span><span class="n">onoff</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl</span><span class="p">[</span><span class="n">index_pid_filter_cmd</span><span class="p">].</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">DIB9000_PID_FILTER</span><span class="p">)</span>
				<span class="n">dib9000_fw_pid_filter</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl</span><span class="p">[</span><span class="n">index_pid_filter_cmd</span><span class="p">].</span><span class="n">id</span><span class="p">,</span>
						<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl</span><span class="p">[</span><span class="n">index_pid_filter_cmd</span><span class="p">].</span><span class="n">pid</span><span class="p">,</span>
						<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl</span><span class="p">[</span><span class="n">index_pid_filter_cmd</span><span class="p">].</span><span class="n">onoff</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* do not postpone any more the pid filtering */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dib9000_read_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">535</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lock_slave</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lock_slave</span> <span class="o">|=</span> <span class="n">dib9000_read_lock</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>

	<span class="n">lock</span> <span class="o">=</span> <span class="n">dib9000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">535</span><span class="p">);</span>

	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lock_slave</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_SIGNAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lock_slave</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">))</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_CARRIER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lock_slave</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">))</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x0038</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">lock_slave</span> <span class="o">&amp;</span> <span class="mh">0x0038</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x38</span><span class="p">))</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_SYNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x0008</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lock_slave</span> <span class="o">&amp;</span> <span class="mh">0x0008</span><span class="p">))</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_fw_memmbx_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_SYNC_CHANNEL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib9000_risc_mem_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_R_FE_MONITOR</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">);</span>

	<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">c</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>

<span class="nl">error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_signal_strength</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">65535</span> <span class="o">-</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
			<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">strength</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_fw_memmbx_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_SYNC_CHANNEL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib9000_risc_mem_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_R_FE_MONITOR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">65535</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">65535</span> <span class="o">-</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
		<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">strength</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dib9000_get_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">exp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_fw_memmbx_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_SYNC_CHANNEL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib9000_risc_mem_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_R_FE_MONITOR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">exp</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">exp</span> <span class="o">+=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">exp</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">exp</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">&lt;&lt;=</span> <span class="n">exp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">exp</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">exp</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">exp</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">&lt;&lt;=</span> <span class="n">exp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">t</span> <span class="o">+</span> <span class="p">((</span><span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mh">0xffffffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">snr_master</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snr_master</span> <span class="o">=</span> <span class="n">dib9000_get_snr</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snr_master</span> <span class="o">+=</span> <span class="n">dib9000_get_snr</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">snr_master</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snr_master</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">intlog10</span><span class="p">(</span><span class="n">snr_master</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">snr_master</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib9000_read_unc_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">unc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not get the lock&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_fw_memmbx_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_SYNC_CHANNEL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib9000_risc_mem_read</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_MM_R_FE_MONITOR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">);</span>

	<span class="o">*</span><span class="n">unc</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>

<span class="nl">error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib9000_i2c_enumeration</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">no_of_demods</span><span class="p">,</span> <span class="n">u8</span> <span class="n">default_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">first_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">new_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_device</span> <span class="n">client</span> <span class="o">=</span> <span class="p">{.</span><span class="n">i2c_adap</span> <span class="o">=</span> <span class="n">i2c</span> <span class="p">};</span>

	<span class="n">client</span><span class="p">.</span><span class="n">i2c_write_buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">i2c_write_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: not enough memory&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">client</span><span class="p">.</span><span class="n">i2c_read_buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">i2c_read_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: not enough memory&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_memory</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">client</span><span class="p">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">default_addr</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">dib9000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1796</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">no_of_demods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* designated i2c address */</span>
		<span class="n">new_addr</span> <span class="o">=</span> <span class="n">first_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">client</span><span class="p">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">default_addr</span><span class="p">;</span>

		<span class="n">dib9000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1817</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">dib9000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1796</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dib9000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1227</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dib9000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1227</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">client</span><span class="p">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">new_addr</span><span class="p">;</span>
		<span class="n">dib9000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1817</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">dib9000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1796</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dib9000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1227</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dib9000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1227</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_identify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">client</span><span class="p">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">default_addr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_identify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;DiB9000 #%d: not identified&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">dib9000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1795</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">dib9000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1794</span><span class="p">,</span> <span class="p">(</span><span class="n">new_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;IC %d initialized (to i2c_address 0x%x)&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">new_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">no_of_demods</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_addr</span> <span class="o">=</span> <span class="n">first_addr</span> <span class="o">|</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">client</span><span class="p">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">new_addr</span><span class="p">;</span>

		<span class="n">dib9000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1794</span><span class="p">,</span> <span class="p">(</span><span class="n">new_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">dib9000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1795</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">i2c_read_buffer</span><span class="p">);</span>
<span class="nl">error_memory:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">i2c_write_buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_i2c_enumeration</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib9000_set_slave_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe_slave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">index_frontend</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;set slave fe %p to index %i&quot;</span><span class="p">,</span> <span class="n">fe_slave</span><span class="p">,</span> <span class="n">index_frontend</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe_slave</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;too many slave frontend&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_set_slave_frontend</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib9000_remove_slave_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">index_frontend</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;remove slave fe %p (index %i)&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">index_frontend</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;no frontend to be removed&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_remove_slave_frontend</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">dib9000_get_slave_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slave_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slave_index</span> <span class="o">&gt;=</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">slave_index</span><span class="p">];</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_get_slave_frontend</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">dib9000_ops</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">dib9000_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">u8</span> <span class="n">i2c_addr</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib9000_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib9000_state</span> <span class="o">*</span><span class="n">st</span><span class="p">;</span>
	<span class="n">st</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fe</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib9000_config</span><span class="p">));</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_adap</span> <span class="o">=</span> <span class="n">i2c_adap</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">i2c_addr</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_write_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_read_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">=</span> <span class="n">DIB9000_GPIO_DEFAULT_DIRECTIONS</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">=</span> <span class="n">DIB9000_GPIO_DEFAULT_VALUES</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">gpio_pwm_pos</span> <span class="o">=</span> <span class="n">DIB9000_GPIO_DEFAULT_PWM_POS</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mbx_if_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mbx_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">.</span><span class="n">risc</span><span class="p">.</span><span class="n">mem_mbx_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">demod_lock</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">get_frontend_internal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">pid_ctrl_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe</span><span class="p">;</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dib9000_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>

	<span class="cm">/* Ensure the output mode remains at the previous default if it&#39;s</span>
<span class="cm">	 * not specifically set by the caller.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span> <span class="o">!=</span> <span class="n">OUTMODE_MPEG2_SERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span> <span class="o">!=</span> <span class="n">OUTMODE_MPEG2_PAR_GATED_CLK</span><span class="p">))</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">d9</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span> <span class="o">=</span> <span class="n">OUTMODE_MPEG2_FIFO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib9000_identify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dibx000_init_i2c_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">,</span> <span class="n">DIB7000MC</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_addr</span><span class="p">);</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_adap</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">i2c_adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_adap</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;DIB9000_FW TUNER ACCESS&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_adap</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_adap</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dib9000_tuner_algo</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_adap</span><span class="p">.</span><span class="n">algo_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">i2c_set_adapdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_adap</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_add_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_adap</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">component_bus</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">i2c_adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">component_bus</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;DIB9000_FW COMPONENT BUS ACCESS&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">component_bus</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">component_bus</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dib9000_component_bus_algo</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">component_bus</span><span class="p">.</span><span class="n">algo_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">component_bus_speed</span> <span class="o">=</span> <span class="mi">340</span><span class="p">;</span>
	<span class="n">i2c_set_adapdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">component_bus</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_add_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">component_bus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">component_bus_add_error</span><span class="p">;</span>

	<span class="n">dib9000_fw_reset</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fe</span><span class="p">;</span>

<span class="nl">component_bus_add_error:</span>
	<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_adap</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib9000_attach</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">dib9000_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBT</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DiBcom 9000&quot;</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">44250000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">867250000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">=</span> <span class="mi">62500</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">FE_CAN_INVERSION_AUTO</span> <span class="o">|</span>
		 <span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span>
		 <span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
		 <span class="n">FE_CAN_QPSK</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_AUTO</span> <span class="o">|</span>
		 <span class="n">FE_CAN_TRANSMISSION_MODE_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_GUARD_INTERVAL_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_RECOVER</span> <span class="o">|</span> <span class="n">FE_CAN_HIERARCHY_AUTO</span><span class="p">,</span>
		 <span class="p">},</span>

	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">dib9000_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">dib9000_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">dib9000_sleep</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">dib9000_set_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">=</span> <span class="n">dib9000_fe_get_tune_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend</span> <span class="o">=</span> <span class="n">dib9000_get_frontend</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">dib9000_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">dib9000_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">dib9000_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">dib9000_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">dib9000_read_unc_blocks</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Patrick Boettcher &lt;pboettcher@dibcom.fr&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Olivier Grenie &lt;ogrenie@dibcom.fr&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for the DiBcom 9000 COFDM demodulator&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
