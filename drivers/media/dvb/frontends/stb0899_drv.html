<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › stb0899_drv.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>stb0899_drv.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	STB0899 Multistandard Frontend driver</span>
<span class="cm">	Copyright (C) Manu Abraham (abraham.manu@gmail.com)</span>

<span class="cm">	Copyright (C) ST Microelectronics</span>

<span class="cm">	This program is free software; you can redistribute it and/or modify</span>
<span class="cm">	it under the terms of the GNU General Public License as published by</span>
<span class="cm">	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">	(at your option) any later version.</span>

<span class="cm">	This program is distributed in the hope that it will be useful,</span>
<span class="cm">	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">	GNU General Public License for more details.</span>

<span class="cm">	You should have received a copy of the GNU General Public License</span>
<span class="cm">	along with this program; if not, write to the Free Software</span>
<span class="cm">	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>

<span class="cp">#include &lt;linux/dvb/frontend.h&gt;</span>
<span class="cp">#include &quot;dvb_frontend.h&quot;</span>

<span class="cp">#include &quot;stb0899_drv.h&quot;</span>
<span class="cp">#include &quot;stb0899_priv.h&quot;</span>
<span class="cp">#include &quot;stb0899_reg.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//1;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/* C/N in dB/10, NIRM/NIRL */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stb0899_tab</span> <span class="n">stb0899_cn_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">200</span><span class="p">,</span>	<span class="mi">2600</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">190</span><span class="p">,</span>	<span class="mi">2700</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">180</span><span class="p">,</span>	<span class="mi">2860</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">170</span><span class="p">,</span>	<span class="mi">3020</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">160</span><span class="p">,</span>	<span class="mi">3210</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">150</span><span class="p">,</span>	<span class="mi">3440</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">140</span><span class="p">,</span>	<span class="mi">3710</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">130</span><span class="p">,</span>	<span class="mi">4010</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">120</span><span class="p">,</span>	<span class="mi">4360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">110</span><span class="p">,</span>	<span class="mi">4740</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">100</span><span class="p">,</span>	<span class="mi">5190</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">90</span><span class="p">,</span>	<span class="mi">5670</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">80</span><span class="p">,</span>	<span class="mi">6200</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">70</span><span class="p">,</span>	<span class="mi">6770</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">60</span><span class="p">,</span>	<span class="mi">7360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">50</span><span class="p">,</span>	<span class="mi">7970</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">40</span><span class="p">,</span>	<span class="mi">8250</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">30</span><span class="p">,</span>	<span class="mi">9000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">20</span><span class="p">,</span>	<span class="mi">9450</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">15</span><span class="p">,</span>	<span class="mi">9600</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* DVB-S AGCIQ_VALUE vs. signal level in dBm/10.</span>
<span class="cm"> * As measured, connected to a modulator.</span>
<span class="cm"> * -8.0 to -50.0 dBm directly connected,</span>
<span class="cm"> * -52.0 to -74.8 with extra attenuation.</span>
<span class="cm"> * Cut-off to AGCIQ_VALUE = 0x80 below -74.8dBm.</span>
<span class="cm"> * Crude linear extrapolation below -84.8dBm and above -8.0dBm.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stb0899_tab</span> <span class="n">stb0899_dvbsrf_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">750</span><span class="p">,</span>	<span class="o">-</span><span class="mi">128</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">748</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">94</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">745</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">92</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">735</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">90</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">720</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">87</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">670</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">77</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">640</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">70</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">610</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">62</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">600</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">590</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">56</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">560</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">41</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">540</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">530</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">17</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">520</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">500</span><span class="p">,</span>	   <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">490</span><span class="p">,</span>	   <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">480</span><span class="p">,</span>	  <span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">440</span><span class="p">,</span>	  <span class="mi">22</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">420</span><span class="p">,</span>	  <span class="mi">27</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">400</span><span class="p">,</span>	  <span class="mi">31</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">380</span><span class="p">,</span>	  <span class="mi">34</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">340</span><span class="p">,</span>	  <span class="mi">40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">320</span><span class="p">,</span>	  <span class="mi">43</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">280</span><span class="p">,</span>	  <span class="mi">48</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">250</span><span class="p">,</span>	  <span class="mi">52</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">230</span><span class="p">,</span>	  <span class="mi">55</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span>	  <span class="mi">61</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">140</span><span class="p">,</span>	  <span class="mi">66</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="o">-</span><span class="mi">90</span><span class="p">,</span>	  <span class="mi">73</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="o">-</span><span class="mi">80</span><span class="p">,</span>	  <span class="mi">74</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">500</span><span class="p">,</span>	 <span class="mi">127</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* DVB-S2 IF_AGC_GAIN vs. signal level in dBm/10.</span>
<span class="cm"> * As measured, connected to a modulator.</span>
<span class="cm"> * -8.0 to -50.1 dBm directly connected,</span>
<span class="cm"> * -53.0 to -76.6 with extra attenuation.</span>
<span class="cm"> * Cut-off to IF_AGC_GAIN = 0x3fff below -76.6dBm.</span>
<span class="cm"> * Crude linear extrapolation below -76.6dBm and above -8.0dBm.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stb0899_tab</span> <span class="n">stb0899_dvbs2rf_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>  <span class="mi">700</span><span class="p">,</span>	    <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="o">-</span><span class="mi">80</span><span class="p">,</span>	 <span class="mi">3217</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span>	 <span class="mi">3893</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">190</span><span class="p">,</span>	 <span class="mi">4217</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">240</span><span class="p">,</span>	 <span class="mi">4621</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">280</span><span class="p">,</span>	 <span class="mi">4945</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">320</span><span class="p">,</span>	 <span class="mi">5273</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">350</span><span class="p">,</span>	 <span class="mi">5545</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">370</span><span class="p">,</span>	 <span class="mi">5741</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">410</span><span class="p">,</span>	 <span class="mi">6147</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">450</span><span class="p">,</span>	 <span class="mi">6671</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">490</span><span class="p">,</span>	 <span class="mi">7413</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">501</span><span class="p">,</span>	 <span class="mi">7665</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">530</span><span class="p">,</span>	 <span class="mi">8767</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">560</span><span class="p">,</span>	<span class="mi">10219</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">580</span><span class="p">,</span>	<span class="mi">10939</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">590</span><span class="p">,</span>	<span class="mi">11518</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">600</span><span class="p">,</span>	<span class="mi">11723</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">650</span><span class="p">,</span>	<span class="mi">12659</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">690</span><span class="p">,</span>	<span class="mi">13219</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">730</span><span class="p">,</span>	<span class="mi">13645</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">750</span><span class="p">,</span>	<span class="mi">13909</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">766</span><span class="p">,</span>	<span class="mi">14153</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">950</span><span class="p">,</span>	<span class="mi">16383</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* DVB-S2 Es/N0 quant in dB/100 vs read value * 100*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stb0899_tab</span> <span class="n">stb0899_quant_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>    <span class="mi">0</span><span class="p">,</span>	    <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span>    <span class="mi">0</span><span class="p">,</span>	  <span class="mi">100</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">600</span><span class="p">,</span>	  <span class="mi">200</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">950</span><span class="p">,</span>	  <span class="mi">299</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1200</span><span class="p">,</span>	  <span class="mi">398</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1400</span><span class="p">,</span>	  <span class="mi">501</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1560</span><span class="p">,</span>	  <span class="mi">603</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1690</span><span class="p">,</span>	  <span class="mi">700</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1810</span><span class="p">,</span>	  <span class="mi">804</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1910</span><span class="p">,</span>	  <span class="mi">902</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2000</span><span class="p">,</span>	 <span class="mi">1000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2080</span><span class="p">,</span>	 <span class="mi">1096</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2160</span><span class="p">,</span>	 <span class="mi">1202</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2230</span><span class="p">,</span>	 <span class="mi">1303</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2350</span><span class="p">,</span>	 <span class="mi">1496</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2410</span><span class="p">,</span>	 <span class="mi">1603</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2460</span><span class="p">,</span>	 <span class="mi">1698</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2510</span><span class="p">,</span>	 <span class="mi">1799</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2600</span><span class="p">,</span>	 <span class="mi">1995</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2650</span><span class="p">,</span>	 <span class="mi">2113</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2690</span><span class="p">,</span>  <span class="mi">2213</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2720</span><span class="p">,</span>	 <span class="mi">2291</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2760</span><span class="p">,</span>	 <span class="mi">2399</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2800</span><span class="p">,</span>	 <span class="mi">2512</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2860</span><span class="p">,</span>	 <span class="mi">2692</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2930</span><span class="p">,</span>	 <span class="mi">2917</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2960</span><span class="p">,</span>	 <span class="mi">3020</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3010</span><span class="p">,</span>	 <span class="mi">3199</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3040</span><span class="p">,</span>	 <span class="mi">3311</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3060</span><span class="p">,</span>	 <span class="mi">3388</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3120</span><span class="p">,</span>	 <span class="mi">3631</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3190</span><span class="p">,</span>	 <span class="mi">3936</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3400</span><span class="p">,</span>	 <span class="mi">5012</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3610</span><span class="p">,</span>	 <span class="mi">6383</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3800</span><span class="p">,</span>	 <span class="mi">7943</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4210</span><span class="p">,</span>	<span class="mi">12735</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4500</span><span class="p">,</span>	<span class="mi">17783</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4690</span><span class="p">,</span>	<span class="mi">22131</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4810</span><span class="p">,</span>	<span class="mi">25410</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* DVB-S2 Es/N0 estimate in dB/100 vs read value */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stb0899_tab</span> <span class="n">stb0899_est_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>    <span class="mi">0</span><span class="p">,</span>	     <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span>    <span class="mi">0</span><span class="p">,</span>	     <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">301</span><span class="p">,</span>	     <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1204</span><span class="p">,</span>	    <span class="mi">16</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1806</span><span class="p">,</span>	    <span class="mi">64</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2408</span><span class="p">,</span>	   <span class="mi">256</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2709</span><span class="p">,</span>	   <span class="mi">512</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3010</span><span class="p">,</span>	  <span class="mi">1023</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3311</span><span class="p">,</span>	  <span class="mi">2046</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3612</span><span class="p">,</span>	  <span class="mi">4093</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3823</span><span class="p">,</span>	  <span class="mi">6653</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3913</span><span class="p">,</span>	  <span class="mi">8185</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4010</span><span class="p">,</span>	 <span class="mi">10233</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4107</span><span class="p">,</span>	 <span class="mi">12794</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4214</span><span class="p">,</span>	 <span class="mi">16368</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4266</span><span class="p">,</span>	 <span class="mi">18450</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4311</span><span class="p">,</span>	 <span class="mi">20464</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4353</span><span class="p">,</span>	 <span class="mi">22542</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4391</span><span class="p">,</span>	 <span class="mi">24604</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4425</span><span class="p">,</span>	 <span class="mi">26607</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4457</span><span class="p">,</span>	 <span class="mi">28642</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4487</span><span class="p">,</span>	 <span class="mi">30690</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4515</span><span class="p">,</span>	 <span class="mi">32734</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4612</span><span class="p">,</span>	 <span class="mi">40926</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4692</span><span class="p">,</span>	 <span class="mi">49204</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4816</span><span class="p">,</span>	 <span class="mi">65464</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4913</span><span class="p">,</span>	 <span class="mi">81846</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4993</span><span class="p">,</span>	 <span class="mi">98401</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5060</span><span class="p">,</span>	<span class="mi">114815</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5118</span><span class="p">,</span>	<span class="mi">131220</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5200</span><span class="p">,</span>	<span class="mi">158489</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5300</span><span class="p">,</span>	<span class="mi">199526</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5400</span><span class="p">,</span>	<span class="mi">251189</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5500</span><span class="p">,</span>	<span class="mi">316228</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5600</span><span class="p">,</span>	<span class="mi">398107</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5720</span><span class="p">,</span>	<span class="mi">524807</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5721</span><span class="p">,</span>	<span class="mi">526017</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_stb0899_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">b0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="n">b0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="mi">2</span>
		<span class="p">},{</span>
			<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="mi">1</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="s">&quot;Read error, Reg=[0x%02x], Status=%d&quot;</span><span class="p">,</span>
				<span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">FE_DEBUGREG</span><span class="p">))</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Reg=[0x%02x], data=%02x&quot;</span><span class="p">,</span>
			<span class="n">reg</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stb0899_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">_stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Bug ID 9:</span>
<span class="cm">	 * access to 0xf2xx/0xf6xx</span>
<span class="cm">	 * must be followed by read from 0xf2ff/0xf6ff.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">!=</span> <span class="mh">0xf2ff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="mh">0xf6ff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf200</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf600</span><span class="p">)))</span>
		<span class="n">_stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">|</span> <span class="mh">0x00ff</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">_stb0899_read_s2reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">stb0899_i2cdev</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">stb0899_base_addr</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">stb0899_reg_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u16</span> <span class="n">tmpaddr</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">buf_0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_i2cdev</span><span class="p">,</span> <span class="n">BYTE1</span><span class="p">),</span>		<span class="cm">/* 0xf3	S2 Base Address (MSB)	*/</span>
		<span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_i2cdev</span><span class="p">,</span> <span class="n">BYTE0</span><span class="p">),</span>		<span class="cm">/* 0xfc	S2 Base Address (LSB)	*/</span>
		<span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">BYTE0</span><span class="p">),</span>	<span class="cm">/* 0x00	Base Address (LSB)	*/</span>
		<span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">BYTE1</span><span class="p">),</span>	<span class="cm">/* 0x04	Base Address (LSB)	*/</span>
		<span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">BYTE2</span><span class="p">),</span>	<span class="cm">/* 0x00	Base Address (MSB)	*/</span>
		<span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">BYTE3</span><span class="p">),</span>	<span class="cm">/* 0x00	Base Address (MSB)	*/</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">buf_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* 0xf3	Reg Offset	*/</span>
		<span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* 0x44	Reg Offset	*/</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg_0</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="n">buf_0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="mi">6</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg_1</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="n">buf_1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="mi">2</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg_r</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="mi">4</span>
	<span class="p">};</span>

	<span class="n">tmpaddr</span> <span class="o">=</span> <span class="n">stb0899_reg_offset</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stb0899_reg_offset</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">))</span>
		<span class="n">tmpaddr</span> <span class="o">=</span> <span class="n">stb0899_reg_offset</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="n">buf_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GETBYTE</span><span class="p">(</span><span class="n">tmpaddr</span><span class="p">,</span> <span class="n">BYTE1</span><span class="p">);</span>
	<span class="n">buf_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">GETBYTE</span><span class="p">(</span><span class="n">tmpaddr</span><span class="p">,</span> <span class="n">BYTE0</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s ERR(1), Device=[0x%04x], Base address=[0x%08x], Offset=[0x%04x], Status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">stb0899_i2cdev</span><span class="p">,</span> <span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">stb0899_reg_offset</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Dummy	*/</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_r</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">buf_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_reg_offset</span><span class="p">,</span> <span class="n">BYTE1</span><span class="p">);</span>
	<span class="n">buf_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_reg_offset</span><span class="p">,</span> <span class="n">BYTE0</span><span class="p">);</span>

	<span class="cm">/* Actual	*/</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s ERR(2), Device=[0x%04x], Base address=[0x%08x], Offset=[0x%04x], Status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">stb0899_i2cdev</span><span class="p">,</span> <span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">stb0899_reg_offset</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_r</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s ERR(3), Device=[0x%04x], Base address=[0x%08x], Offset=[0x%04x], Status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">stb0899_i2cdev</span><span class="p">,</span> <span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">stb0899_reg_offset</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">status</span> <span class="o">:</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">MAKEWORD32</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">FE_DEBUGREG</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s Device=[0x%04x], Base address=[0x%08x], Offset=[0x%04x], Data=[0x%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">stb0899_i2cdev</span><span class="p">,</span> <span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">stb0899_reg_offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">status</span> <span class="o">:</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stb0899_write_s2reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">stb0899_i2cdev</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">stb0899_base_addr</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">stb0899_reg_offset</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">stb0899_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Base Address Setup	*/</span>
	<span class="n">u8</span> <span class="n">buf_0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_i2cdev</span><span class="p">,</span> <span class="n">BYTE1</span><span class="p">),</span>		<span class="cm">/* 0xf3	S2 Base Address (MSB)	*/</span>
		<span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_i2cdev</span><span class="p">,</span> <span class="n">BYTE0</span><span class="p">),</span>		<span class="cm">/* 0xfc	S2 Base Address (LSB)	*/</span>
		<span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">BYTE0</span><span class="p">),</span>	<span class="cm">/* 0x00	Base Address (LSB)	*/</span>
		<span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">BYTE1</span><span class="p">),</span>	<span class="cm">/* 0x04	Base Address (LSB)	*/</span>
		<span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">BYTE2</span><span class="p">),</span>	<span class="cm">/* 0x00	Base Address (MSB)	*/</span>
		<span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">BYTE3</span><span class="p">),</span>	<span class="cm">/* 0x00	Base Address (MSB)	*/</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">buf_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* 0xf3	Reg Offset	*/</span>
		<span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* 0x44	Reg Offset	*/</span>
		<span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* data			*/</span>
		<span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* data			*/</span>
		<span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* data			*/</span>
		<span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* data			*/</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg_0</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="n">buf_0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="mi">6</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg_1</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="n">buf_1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="mi">6</span>
	<span class="p">};</span>

	<span class="n">buf_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_reg_offset</span><span class="p">,</span> <span class="n">BYTE1</span><span class="p">);</span>
	<span class="n">buf_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_reg_offset</span><span class="p">,</span> <span class="n">BYTE0</span><span class="p">);</span>
	<span class="n">buf_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_data</span><span class="p">,</span> <span class="n">BYTE0</span><span class="p">);</span>
	<span class="n">buf_1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_data</span><span class="p">,</span> <span class="n">BYTE1</span><span class="p">);</span>
	<span class="n">buf_1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_data</span><span class="p">,</span> <span class="n">BYTE2</span><span class="p">);</span>
	<span class="n">buf_1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">GETBYTE</span><span class="p">(</span><span class="n">stb0899_data</span><span class="p">,</span> <span class="n">BYTE3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">FE_DEBUGREG</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s Device=[0x%04x], Base Address=[0x%08x], Offset=[0x%04x], Data=[0x%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">stb0899_i2cdev</span><span class="p">,</span> <span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">stb0899_reg_offset</span><span class="p">,</span> <span class="n">stb0899_data</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s ERR (1), Device=[0x%04x], Base Address=[0x%08x], Offset=[0x%04x], Data=[0x%08x], status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">stb0899_i2cdev</span><span class="p">,</span> <span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">stb0899_reg_offset</span><span class="p">,</span> <span class="n">stb0899_data</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s ERR (2), Device=[0x%04x], Base Address=[0x%08x], Offset=[0x%04x], Data=[0x%08x], status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">stb0899_i2cdev</span><span class="p">,</span> <span class="n">stb0899_base_addr</span><span class="p">,</span> <span class="n">stb0899_reg_offset</span><span class="p">,</span> <span class="n">stb0899_data</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">status</span> <span class="o">:</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">status</span> <span class="o">:</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stb0899_read_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">b0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="p">};</span>

	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="n">b0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="mi">2</span>
		<span class="p">},{</span>
			<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="n">count</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s Read error, Reg=[0x%04x], Count=%u, Status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Bug ID 9:</span>
<span class="cm">	 * access to 0xf2xx/0xf6xx</span>
<span class="cm">	 * must be followed by read from 0xf2ff/0xf6ff.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">!=</span> <span class="mh">0xf2ff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="mh">0xf6ff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf200</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf600</span><span class="p">)))</span>
		<span class="n">_stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">|</span> <span class="mh">0x00ff</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">FE_DEBUGREG</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s [0x%04x]:&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">status</span> <span class="o">:</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stb0899_write_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">count</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">i2c_msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span>	<span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span>	<span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">count</span>
	<span class="p">};</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">FE_DEBUGREG</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s [0x%04x]:&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bug ID 9:</span>
<span class="cm">	 * access to 0xf2xx/0xf6xx</span>
<span class="cm">	 * must be followed by read from 0xf2ff/0xf6ff.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf200</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf600</span><span class="p">)))</span>
		<span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">|</span> <span class="mh">0x00ff</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Reg=[0x%04x], Data=[0x%02x ...], Count=%u, Status=%d&quot;</span><span class="p">,</span>
				<span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stb0899_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">stb0899_write_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_get_mclk</span>
<span class="cm"> * Get STB0899 master clock frequency</span>
<span class="cm"> * ExtClk: external clock frequency (Hz)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">stb0899_get_mclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_NCOARSE</span><span class="p">);</span>
	<span class="n">mclk</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">xtal_freq</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;div=%d, mclk=%d&quot;</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">mclk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mclk</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_set_mclk</span>
<span class="cm"> * Set STB0899 master Clock frequency</span>
<span class="cm"> * Mclk: demodulator master clock</span>
<span class="cm"> * ExtClk: external clock frequency (Hz)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_set_mclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">Mclk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mdiv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;state-&gt;config=%p&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">mdiv</span> <span class="o">=</span> <span class="p">((</span><span class="mi">6</span> <span class="o">*</span> <span class="n">Mclk</span><span class="p">)</span> <span class="o">/</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">xtal_freq</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mdiv=%d&quot;</span><span class="p">,</span> <span class="n">mdiv</span><span class="p">);</span>

	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_NCOARSE</span><span class="p">,</span> <span class="n">mdiv</span><span class="p">);</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">=</span> <span class="n">stb0899_get_mclk</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;MasterCLOCK=%d&quot;</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_postproc</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ctl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_config</span> <span class="o">*</span><span class="n">config</span>		<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stb0899_postproc</span> <span class="o">*</span><span class="n">postproc</span>	<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">postproc</span><span class="p">;</span>

	<span class="cm">/* post process event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">postproc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">postproc</span><span class="p">[</span><span class="n">ctl</span><span class="p">].</span><span class="n">level</span> <span class="o">==</span> <span class="n">STB0899_GPIOPULLUP</span><span class="p">)</span>
				<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">postproc</span><span class="p">[</span><span class="n">ctl</span><span class="p">].</span><span class="n">gpio</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">postproc</span><span class="p">[</span><span class="n">ctl</span><span class="p">].</span><span class="n">gpio</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">postproc</span><span class="p">[</span><span class="n">ctl</span><span class="p">].</span><span class="n">level</span> <span class="o">==</span> <span class="n">STB0899_GPIOPULLUP</span><span class="p">)</span>
				<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">postproc</span><span class="p">[</span><span class="n">ctl</span><span class="p">].</span><span class="n">gpio</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">postproc</span><span class="p">[</span><span class="n">ctl</span><span class="p">].</span><span class="n">gpio</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Release Frontend&quot;</span><span class="p">);</span>
	<span class="cm">/* post process event */</span>
	<span class="n">stb0899_postproc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_POSTPROC_GPIO_POWER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_get_alpha</span>
<span class="cm"> * return: rolloff</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_get_alpha</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode_coeff</span><span class="p">;</span>

	<span class="n">mode_coeff</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DEMOD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">MODECOEFF</span><span class="p">,</span> <span class="n">mode_coeff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">35</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_init_calc</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_init_calc</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">master_clk</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">agc</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* Read registers (in burst mode)	*/</span>
	<span class="n">stb0899_read_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_AGC1REF</span><span class="p">,</span> <span class="n">agc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* AGC1R and AGC2O	*/</span>

	<span class="cm">/* Initial calculations	*/</span>
	<span class="n">master_clk</span>			<span class="o">=</span> <span class="n">stb0899_get_mclk</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">t_agc1</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">t_agc2</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span>		<span class="o">=</span> <span class="n">master_clk</span><span class="p">;</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span>			<span class="o">=</span> <span class="n">master_clk</span> <span class="o">/</span> <span class="mi">65536L</span><span class="p">;</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">rolloff</span>		<span class="o">=</span> <span class="n">stb0899_get_alpha</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* DVBS2 Initial calculations	*/</span>
	<span class="cm">/* Set AGC value to the middle	*/</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">agc_gain</span>		<span class="o">=</span> <span class="mi">8154</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">IF_AGC_CNTRL</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">IF_GAIN_INIT</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">agc_gain</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_IF_AGC_CNTRL</span><span class="p">,</span> <span class="n">STB0899_OFF0_IF_AGC_CNTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">RRC_ALPHA</span><span class="p">);</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">rrc_alpha</span>		<span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">RRC_ALPHA</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">center_freq</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">av_frame_coarse</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">av_frame_fine</span>		<span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">step_size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">	if ((pParams-&gt;SpectralInv == FE_IQ_NORMAL) || (pParams-&gt;SpectralInv == FE_IQ_AUTO))</span>
<span class="cm">		pParams-&gt;IQLocked = 0;</span>
<span class="cm">	else</span>
<span class="cm">		pParams-&gt;IQLocked = 1;</span>
<span class="cm">*/</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_wait_diseqc_fifo_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISSTATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">FIFOFULL</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;timed out !!&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_send_diseqc_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_diseqc_master_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* enable FIFO precharge	*/</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">DISPRECHARGE</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wait for FIFO empty	*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_wait_diseqc_fifo_empty</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISFIFO</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">DISPRECHARGE</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_wait_diseqc_rxidle</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">RXEND</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISRX_ST0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;timed out!!&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_recv_slave_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_diseqc_slave_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_wait_diseqc_rxidle</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISRX_ST0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">RXEND</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISRX_ST1</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">FIFOBYTENBR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reply</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

		<span class="cm">/* extract data */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">reply</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISFIFO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">exit:</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_wait_diseqc_txidle</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">TXIDLE</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISSTATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;timed out!!&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_send_diseqc_burst</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_mini_cmd_t</span> <span class="n">burst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">old_state</span><span class="p">;</span>

	<span class="cm">/* wait for diseqc idle	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_wait_diseqc_txidle</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">);</span>
	<span class="n">old_state</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="cm">/* set to burst mode	*/</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">DISEQCMODE</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">DISPRECHARGE</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">burst</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_MINI_A</span>:
		<span class="cm">/* unmodulated	*/</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISFIFO</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_MINI_B</span>:
		<span class="cm">/* modulated	*/</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISFIFO</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">DISPRECHARGE</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="cm">/* wait for diseqc idle	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_wait_diseqc_txidle</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="cm">/* restore state	*/</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">,</span> <span class="n">old_state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_diseqc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">	struct dvb_diseqc_slave_reply rx_data;</span>
<span class="cm">*/</span>
	<span class="n">u8</span> <span class="n">f22_tx</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">mclk</span><span class="p">,</span> <span class="n">tx_freq</span> <span class="o">=</span> <span class="mi">22000</span><span class="p">;</span><span class="cm">/* count = 0, i; */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL2</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">ONECHIP_TRX</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* disable Tx spy	*/</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">DISEQCRESET</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">DISEQCRESET</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">mclk</span> <span class="o">=</span> <span class="n">stb0899_get_mclk</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">f22_tx</span> <span class="o">=</span> <span class="n">mclk</span> <span class="o">/</span> <span class="p">(</span><span class="n">tx_freq</span> <span class="o">*</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISF22</span><span class="p">,</span> <span class="n">f22_tx</span><span class="p">);</span> <span class="cm">/* DiSEqC Tx freq	*/</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">rx_freq</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">	u8 reg;</span>
<span class="cm">*/</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Going to Sleep .. (Really tired .. :-))&quot;</span><span class="p">);</span>
	<span class="cm">/* post process event */</span>
	<span class="n">stb0899_postproc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_POSTPROC_GPIO_POWER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_SYNTCTRL</span><span class="p">,</span> <span class="n">STB0899_SELOSCI</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* Activate all clocks; DVB-S2 registers are inaccessible otherwise. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_STOPCLK1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_STOPCLK2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* post process event */</span>
	<span class="n">stb0899_postproc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_POSTPROC_GPIO_POWER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Initializing STB0899 ... &quot;</span><span class="p">);</span>

	<span class="cm">/* init device		*/</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;init device&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;init S2 demod&quot;</span><span class="p">);</span>
	<span class="cm">/* init S2 demod	*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_s2_demod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span>
				    <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_s2_demod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base_address</span><span class="p">,</span>
				    <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_s2_demod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span>
				    <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_s2_demod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;init S1 demod&quot;</span><span class="p">);</span>
	<span class="cm">/* init S1 demod	*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_s1_demod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_s1_demod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_s1_demod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;init S2 FEC&quot;</span><span class="p">);</span>
	<span class="cm">/* init S2 fec		*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_s2_fec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2FEC</span><span class="p">,</span>
				    <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_s2_fec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base_address</span><span class="p">,</span>
				    <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_s2_fec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span>
				    <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_s2_fec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;init TST&quot;</span><span class="p">);</span>
	<span class="cm">/* init test		*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_tst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_tst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_tst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>

	<span class="n">stb0899_init_calc</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">stb0899_diseqc_init</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_table_lookup</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">stb0899_tab</span> <span class="o">*</span><span class="n">tab</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">med</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">read</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">real</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">tab</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">read</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">real</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">max</span> <span class="o">-</span> <span class="n">min</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">med</span> <span class="o">=</span> <span class="p">(</span><span class="n">max</span> <span class="o">+</span> <span class="n">min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">read</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="p">[</span><span class="n">med</span><span class="p">].</span><span class="n">read</span><span class="p">)</span>
				<span class="n">max</span> <span class="o">=</span> <span class="n">med</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">min</span> <span class="o">=</span> <span class="n">med</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">-</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">read</span><span class="p">)</span> <span class="o">*</span>
		       <span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">real</span> <span class="o">-</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">real</span><span class="p">)</span> <span class="o">/</span>
		       <span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">read</span> <span class="o">-</span> <span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">read</span><span class="p">))</span> <span class="o">+</span>
			<span class="n">tab</span><span class="p">[</span><span class="n">min</span><span class="p">].</span><span class="n">real</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span>		<span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_DVBS</span>:
	<span class="k">case</span> <span class="n">SYS_DSS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span>  <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_VSTATUS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">VSTATUS_LOCKEDVIT</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_AGCIQIN</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)(</span><span class="n">s8</span><span class="p">)</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">AGCIQVALUE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

				<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="n">stb0899_table_lookup</span><span class="p">(</span><span class="n">stb0899_dvbsrf_tab</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stb0899_dvbsrf_tab</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="o">*</span><span class="n">strength</span> <span class="o">+=</span> <span class="mi">750</span><span class="p">;</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;AGCIQVALUE = 0x%02x, C = %d * 0.1 dBm&quot;</span><span class="p">,</span>
					<span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="o">*</span><span class="n">strength</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_DVBS2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">IF_AGC_GAIN</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">IF_AGC_GAIN</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

			<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="n">stb0899_table_lookup</span><span class="p">(</span><span class="n">stb0899_dvbs2rf_tab</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stb0899_dvbs2rf_tab</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="o">*</span><span class="n">strength</span> <span class="o">+=</span> <span class="mi">950</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;IF_AGC_GAIN = 0x%04x, C = %d * 0.1 dBm&quot;</span><span class="p">,</span>
				<span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">,</span> <span class="o">*</span><span class="n">strength</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unsupported delivery system&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span>		<span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="n">quantn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">est</span><span class="p">,</span> <span class="n">estn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reg</span>  <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_VSTATUS</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_DVBS</span>:
	<span class="k">case</span> <span class="n">SYS_DSS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">VSTATUS_LOCKEDVIT</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">stb0899_read_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_NIRM</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">MAKEWORD16</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

				<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">stb0899_table_lookup</span><span class="p">(</span><span class="n">stb0899_cn_tab</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stb0899_cn_tab</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;NIR = 0x%02x%02x = %u, C/N = %d * 0.1 dBm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="o">*</span><span class="n">snr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_DVBS2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">UWP_CNTRL1</span><span class="p">);</span>
			<span class="n">quant</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">UWP_ESN0_QUANT</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">UWP_STAT2</span><span class="p">);</span>
			<span class="n">est</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">ESN0_EST</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">est</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="mi">301</span><span class="p">;</span> <span class="cm">/* C/N = 30.1 dB */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">est</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="mi">270</span><span class="p">;</span> <span class="cm">/* C/N = 27.0 dB */</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* quantn = 100 * log(quant^2) */</span>
				<span class="n">quantn</span> <span class="o">=</span> <span class="n">stb0899_table_lookup</span><span class="p">(</span><span class="n">stb0899_quant_tab</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stb0899_quant_tab</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">quant</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
				<span class="cm">/* estn = 100 * log(est) */</span>
				<span class="n">estn</span> <span class="o">=</span> <span class="n">stb0899_table_lookup</span><span class="p">(</span><span class="n">stb0899_est_tab</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stb0899_est_tab</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">est</span><span class="p">);</span>
				<span class="cm">/* snr(dBm/10) = -10*(log(est)-log(quant^2)) =&gt; snr(dBm/10) = (100*log(quant^2)-100*log(est))/10 */</span>
				<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">quantn</span> <span class="o">-</span> <span class="n">estn</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Es/N0 quant = %d (%d) estimate = %u (%d), C/N = %d * 0.1 dBm&quot;</span><span class="p">,</span>
				<span class="n">quant</span><span class="p">,</span> <span class="n">quantn</span><span class="p">,</span> <span class="n">est</span><span class="p">,</span> <span class="n">estn</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unsupported delivery system&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fe_status</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span>		<span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_DVBS</span>:
	<span class="k">case</span> <span class="n">SYS_DSS</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Delivery system DVB-S/DSS&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span>  <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_VSTATUS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">VSTATUS_LOCKEDVIT</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;--------&gt; FE_HAS_CARRIER | FE_HAS_LOCK&quot;</span><span class="p">);</span>
				<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_SIGNAL</span> <span class="o">|</span> <span class="n">FE_HAS_CARRIER</span> <span class="o">|</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>

				<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_PLPARM</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">VITCURPUN</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;--------&gt; FE_HAS_VITERBI | FE_HAS_SYNC&quot;</span><span class="p">);</span>
					<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span> <span class="o">|</span> <span class="n">FE_HAS_SYNC</span><span class="p">;</span>
					<span class="cm">/* post process event */</span>
					<span class="n">stb0899_postproc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_POSTPROC_GPIO_LOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_DVBS2</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Delivery system DVB-S2&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">DMD_STAT2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">UWP_LOCK</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">CSM_LOCK</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_CARRIER</span><span class="p">;</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					<span class="s">&quot;UWP &amp; CSM Lock ! ---&gt; DVB-S2 FE_HAS_CARRIER&quot;</span><span class="p">);</span>

				<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFGPDELSTATUS1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">CFGPDELSTATUS_LOCK</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						<span class="s">&quot;Packet Delineator Locked ! -----&gt; DVB-S2 FE_HAS_LOCK&quot;</span><span class="p">);</span>

				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">CONTINUOUS_STREAM</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						<span class="s">&quot;Packet Delineator found VITERBI ! -----&gt; DVB-S2 FE_HAS_VITERBI&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">ACCEPTED_STREAM</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_SYNC</span><span class="p">;</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						<span class="s">&quot;Packet Delineator found SYNC ! -----&gt; DVB-S2 FE_HAS_SYNC&quot;</span><span class="p">);</span>
					<span class="cm">/* post process event */</span>
					<span class="n">stb0899_postproc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_POSTPROC_GPIO_LOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unsupported delivery system&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_get_error</span>
<span class="cm"> * viterbi error for DVB-S/DSS</span>
<span class="cm"> * packet error for DVB-S2</span>
<span class="cm"> * Bit Error Rate or Packet Error Rate * 10 ^ 7</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span>		<span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>

	<span class="n">u8</span>  <span class="n">lsb</span><span class="p">,</span> <span class="n">msb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_DVBS</span>:
	<span class="k">case</span> <span class="n">SYS_DSS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* average 5 BER values	*/</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
				<span class="n">lsb</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_ECNT1L</span><span class="p">);</span>
				<span class="n">msb</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_ECNT1M</span><span class="p">);</span>
				<span class="o">*</span><span class="n">ber</span> <span class="o">+=</span> <span class="n">MAKEWORD16</span><span class="p">(</span><span class="n">msb</span><span class="p">,</span> <span class="n">lsb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">ber</span> <span class="o">/=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="cm">/* Viterbi Check	*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">VSTATUS_PRFVIT</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">v_status</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Error Rate		*/</span>
				<span class="o">*</span><span class="n">ber</span> <span class="o">*=</span> <span class="mi">9766</span><span class="p">;</span>
				<span class="cm">/* ber = ber * 10 ^ 7	*/</span>
				<span class="o">*</span><span class="n">ber</span> <span class="o">/=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">NOE</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">err_ctrl</span><span class="p">))));</span>
				<span class="o">*</span><span class="n">ber</span> <span class="o">/=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_DVBS2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Average 5 PER values	*/</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
				<span class="n">lsb</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_ECNT1L</span><span class="p">);</span>
				<span class="n">msb</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_ECNT1M</span><span class="p">);</span>
				<span class="o">*</span><span class="n">ber</span> <span class="o">+=</span> <span class="n">MAKEWORD16</span><span class="p">(</span><span class="n">msb</span><span class="p">,</span> <span class="n">lsb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* ber = ber * 10 ^ 7	*/</span>
			<span class="o">*</span><span class="n">ber</span> <span class="o">*=</span> <span class="mi">10000000</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ber</span> <span class="o">/=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">NOE</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">err_ctrl</span><span class="p">))));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unsupported delivery system&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_set_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_voltage_t</span> <span class="n">voltage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">voltage</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_VOLTAGE_13</span>:
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_GPIO00CFG</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_GPIO01CFG</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_GPIO02CFG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_VOLTAGE_18</span>:
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_GPIO00CFG</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_GPIO01CFG</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_GPIO02CFG</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_VOLTAGE_OFF</span>:
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_GPIO00CFG</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_GPIO01CFG</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_GPIO02CFG</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_set_tone</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_tone_mode_t</span> <span class="n">tone</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">div</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* wait for diseqc idle	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_wait_diseqc_txidle</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tone</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_TONE_ON</span>:
		<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5632</span><span class="p">;</span>
		<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISEQCOCFG</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_ACRPRESC</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">ACRPRESC</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_ACRPRESC</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_ACRDIV1</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_TONE_OFF</span>:
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DISEQCOCFG</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stb0899_i2c_gate_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i2c_stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">i2c_stat</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_I2CRPT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_stat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Enabling I2C Repeater ...&quot;</span><span class="p">);</span>
		<span class="n">i2c_stat</span> <span class="o">|=</span>  <span class="n">STB0899_I2CTON</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_I2CRPT</span><span class="p">,</span> <span class="n">i2c_stat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Disabling I2C Repeater ...&quot;</span><span class="p">);</span>
		<span class="n">i2c_stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STB0899_I2CTON</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_I2CRPT</span><span class="p">,</span> <span class="n">i2c_stat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;I2C Repeater control failed&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">CONVERT32</span><span class="p">(</span><span class="n">u32</span> <span class="n">x</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">str</span><span class="o">++</span>	<span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">str</span><span class="o">++</span>	<span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">str</span><span class="o">++</span>	<span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">str</span><span class="o">++</span>	<span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">str</span>	<span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stb0899_get_dev_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">chip_id</span><span class="p">,</span> <span class="n">release</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">demod_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fec_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">demod_str</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">char</span> <span class="n">fec_str</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DEV_ID</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ID reg=[0x%02x]&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">chip_id</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">CHIP_ID</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">release</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">CHIP_REL</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Device ID=[%d], Release=[%d]&quot;</span><span class="p">,</span>
		<span class="n">chip_id</span><span class="p">,</span> <span class="n">release</span><span class="p">);</span>

	<span class="n">CONVERT32</span><span class="p">(</span><span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">DMD_CORE_ID</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">demod_str</span><span class="p">);</span>

	<span class="n">demod_ver</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">DMD_VERSION_ID</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Demodulator Core ID=[%s], Version=[%d]&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">demod_str</span><span class="p">,</span> <span class="n">demod_ver</span><span class="p">);</span>
	<span class="n">CONVERT32</span><span class="p">(</span><span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2FEC</span><span class="p">,</span> <span class="n">FEC_CORE_ID_REG</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fec_str</span><span class="p">);</span>
	<span class="n">fec_ver</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2FEC</span><span class="p">,</span> <span class="n">FEC_VER_ID_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t find a STB 0899&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FEC Core ID=[%s], Version=[%d]&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fec_str</span><span class="p">,</span> <span class="n">fec_ver</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_set_delivery</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_STOPCLK1</span><span class="p">);</span>
	<span class="n">stop_clk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_STOPCLK2</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_DVBS</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Delivery System -- DVB-S&quot;</span><span class="p">);</span>
		<span class="cm">/* FECM/Viterbi ON	*/</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_FECM</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FECM_RSVD0</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FECM_VITERBI_ON</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_FECM</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_RSULC</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSULC</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_RSLLC</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSLPL</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FRESLDPC</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CHK8PSK</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKFEC108</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKFEC216</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKPKDLIN108</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKPKDLIN216</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKINTBUF216</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKCORE216</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKS2DMD108</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_DVBS2</span>:
		<span class="cm">/* FECM/Viterbi OFF	*/</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_FECM</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FECM_RSVD0</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FECM_VITERBI_ON</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_FECM</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_RSULC</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSULC</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_RSLLC</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSLPL</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FRESLDPC</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CHK8PSK</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKFEC108</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKFEC216</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKPKDLIN108</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKPKDLIN216</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKINTBUF216</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKCORE216</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKS2DMD108</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_DSS</span>:
		<span class="cm">/* FECM/Viterbi ON	*/</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_FECM</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FECM_RSVD0</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FECM_VITERBI_ON</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_FECM</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_RSULC</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSULC</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_RSLLC</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FRESLDPC</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CHK8PSK</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKFEC108</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKFEC216</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKPKDLIN108</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKPKDLIN216</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKCORE216</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKS2DMD108</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unsupported delivery system&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">STOP_CKADCI108</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stb0899_write_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_STOPCLK1</span><span class="p">,</span> <span class="n">stop_clk</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_set_iterations</span>
<span class="cm"> * set the LDPC iteration scale function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_set_iterations</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="n">s32</span> <span class="n">iter_scale</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">iter_scale</span> <span class="o">=</span> <span class="mi">17</span> <span class="o">*</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">iter_scale</span> <span class="o">+=</span> <span class="mi">410000</span><span class="p">;</span>
	<span class="n">iter_scale</span> <span class="o">/=</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">);</span>
	<span class="n">iter_scale</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iter_scale</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">ldpc_max_iter</span><span class="p">)</span>
		<span class="n">iter_scale</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">ldpc_max_iter</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2FEC</span><span class="p">,</span> <span class="n">MAX_ITER</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">MAX_ITERATIONS</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">iter_scale</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2FEC</span><span class="p">,</span> <span class="n">STB0899_BASE_MAX_ITER</span><span class="p">,</span> <span class="n">STB0899_OFF0_MAX_ITER</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">dvbfe_search</span> <span class="nf">stb0899_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_params</span> <span class="o">*</span><span class="n">i_params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">props</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">SearchRange</span><span class="p">,</span> <span class="n">gain</span><span class="p">;</span>

	<span class="n">i_params</span><span class="o">-&gt;</span><span class="n">freq</span>	<span class="o">=</span> <span class="n">props</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">i_params</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">=</span> <span class="n">props</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span> <span class="o">=</span> <span class="n">props</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;delivery system=%d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span><span class="p">);</span>

	<span class="n">SearchRange</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Frequency=%d, Srate=%d&quot;</span><span class="p">,</span> <span class="n">i_params</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">,</span> <span class="n">i_params</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">);</span>
	<span class="cm">/* checking Search Range is meaningless for a fixed 3 Mhz			*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INRANGE</span><span class="p">(</span><span class="n">i_params</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">45000000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Parameters IN RANGE&quot;</span><span class="p">);</span>
		<span class="n">stb0899_set_delivery</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_rfsiggain</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&gt;</span> <span class="mi">15000000</span><span class="p">)</span>
				<span class="n">gain</span> <span class="o">=</span>  <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 15Mb &lt; srate &lt; 45Mb, gain = 8dB	*/</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&gt;</span> <span class="mi">5000000</span><span class="p">)</span>
				<span class="n">gain</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span> <span class="cm">/*  5Mb &lt; srate &lt; 15Mb, gain = 12dB	*/</span>
			<span class="k">else</span>
				<span class="n">gain</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span> <span class="cm">/*  1Mb &lt; srate &lt;  5Mb, gain = 14db	*/</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_rfsiggain</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">gain</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i_params</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">5000000</span><span class="p">)</span>
			<span class="n">stb0899_set_mclk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">lo_clk</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">stb0899_set_mclk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">hi_clk</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delsys</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SYS_DVBS</span>:
		<span class="k">case</span> <span class="n">SYS_DSS</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;DVB-S delivery system&quot;</span><span class="p">);</span>
			<span class="n">internal</span><span class="o">-&gt;</span><span class="n">freq</span>	<span class="o">=</span> <span class="n">i_params</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">;</span>
			<span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span>	<span class="o">=</span> <span class="n">i_params</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * search = user search range +</span>
<span class="cm">			 *	    500Khz +</span>
<span class="cm">			 *	    2 * Tuner_step_size +</span>
<span class="cm">			 *	    10% of the symbol rate</span>
<span class="cm">			 */</span>
			<span class="n">internal</span><span class="o">-&gt;</span><span class="n">srch_range</span>	<span class="o">=</span> <span class="n">SearchRange</span> <span class="o">+</span> <span class="mi">1500000</span> <span class="o">+</span> <span class="p">(</span><span class="n">i_params</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">5</span><span class="p">);</span>
			<span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_percent</span>	<span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

			<span class="cm">/* What to do for tuners having no bandwidth setup ?	*/</span>
			<span class="cm">/* enable tuner I/O */</span>
			<span class="n">stb0899_i2c_gate_ctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bandwidth</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="p">(</span><span class="n">stb0899_carr_width</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">+</span> <span class="n">SearchRange</span><span class="p">))</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_bandwidth</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">tuner_bw</span><span class="p">);</span>

			<span class="cm">/* disable tuner I/O */</span>
			<span class="n">stb0899_i2c_gate_ctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* Set DVB-S1 AGC		*/</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_AGCRFCFG</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>

			<span class="cm">/* Run the search algorithm	*/</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;running DVB-S search algo ..&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_dvbs_algo</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>	<span class="o">==</span> <span class="n">RANGEOK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">internal</span><span class="o">-&gt;</span><span class="n">lock</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					<span class="s">&quot;-------------------------------------&gt; DVB-S LOCK !&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><pre><code>        stb0899_write_reg(state, STB0899_ERRCTRL1, 0x3d); /* Viterbi Errors */
        internal-&gt;v_status = stb0899_read_reg(state, STB0899_VSTATUS);
        internal-&gt;err_ctrl = stb0899_read_reg(state, STB0899_ERRCTRL1);
        dprintk(state-&gt;verbose, FE_DEBUG, 1, "VSTATUS=0x%02x", internal-&gt;v_status);
        dprintk(state-&gt;verbose, FE_DEBUG, 1, "ERR_CTRL=0x%02x", internal-&gt;err_ctrl);
</code></pre></td><td class="code"><div class="highlight"><pre>				<span class="k">return</span> <span class="n">DVBFE_ALGO_SEARCH_SUCCESS</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">internal</span><span class="o">-&gt;</span><span class="n">lock</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">return</span> <span class="n">DVBFE_ALGO_SEARCH_FAILED</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SYS_DVBS2</span>:
			<span class="n">internal</span><span class="o">-&gt;</span><span class="n">freq</span>			<span class="o">=</span> <span class="n">i_params</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">;</span>
			<span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span>			<span class="o">=</span> <span class="n">i_params</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">;</span>
			<span class="n">internal</span><span class="o">-&gt;</span><span class="n">srch_range</span>		<span class="o">=</span> <span class="n">SearchRange</span><span class="p">;</span>

			<span class="cm">/* enable tuner I/O */</span>
			<span class="n">stb0899_i2c_gate_ctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bandwidth</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="n">stb0899_carr_width</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">+</span> <span class="n">SearchRange</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_bandwidth</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">tuner_bw</span><span class="p">);</span>

			<span class="cm">/* disable tuner I/O */</span>
			<span class="n">stb0899_i2c_gate_ctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><pre><code>    pParams-&gt;SpectralInv        = pSearch-&gt;IQ_Inversion;
</code></pre></td><td class="code"><div class="highlight"><pre>			<span class="cm">/* Set DVB-S2 AGC		*/</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_AGCRFCFG</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">);</span>

			<span class="cm">/* Set IterScale =f(MCLK,SYMB)	*/</span>
			<span class="n">stb0899_set_iterations</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

			<span class="cm">/* Run the search algorithm	*/</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;running DVB-S2 search algo ..&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_dvbs2_algo</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>	<span class="o">==</span> <span class="n">DVBS2_FEC_LOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">internal</span><span class="o">-&gt;</span><span class="n">lock</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					<span class="s">&quot;-------------------------------------&gt; DVB-S2 LOCK !&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><pre><code>        stb0899_write_reg(state, STB0899_ERRCTRL1, 0xb6); /* Packet Errors  */
        internal-&gt;v_status = stb0899_read_reg(state, STB0899_VSTATUS);
        internal-&gt;err_ctrl = stb0899_read_reg(state, STB0899_ERRCTRL1);
</code></pre></td><td class="code"><div class="highlight"><pre>				<span class="k">return</span> <span class="n">DVBFE_ALGO_SEARCH_SUCCESS</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">internal</span><span class="o">-&gt;</span><span class="n">lock</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">return</span> <span class="n">DVBFE_ALGO_SEARCH_FAILED</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unsupported delivery system&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">DVBFE_ALGO_SEARCH_INVALID</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">DVBFE_ALGO_SEARCH_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span>		<span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Get params&quot;</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">dvbfe_algo</span> <span class="nf">stb0899_frontend_algo</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">DVBFE_ALGO_CUSTOM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">stb0899_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">SYS_DSS</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> 			<span class="o">=</span> <span class="s">&quot;STB0899 Multistandard&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span>		<span class="o">=</span> <span class="mi">950000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span> 		<span class="o">=</span> <span class="mi">2150000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_tolerance</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">symbol_rate_min</span> 	<span class="o">=</span>  <span class="mi">5000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">symbol_rate_max</span> 	<span class="o">=</span> <span class="mi">45000000</span><span class="p">,</span>

		<span class="p">.</span><span class="n">caps</span> 			<span class="o">=</span> <span class="n">FE_CAN_INVERSION_AUTO</span>	<span class="o">|</span>
					  <span class="n">FE_CAN_FEC_AUTO</span>	<span class="o">|</span>
					  <span class="n">FE_CAN_2G_MODULATION</span>	<span class="o">|</span>
					  <span class="n">FE_CAN_QPSK</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">release</span>			<span class="o">=</span> <span class="n">stb0899_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>				<span class="o">=</span> <span class="n">stb0899_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span>				<span class="o">=</span> <span class="n">stb0899_sleep</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>.wakeup                = stb0899_wakeup,</p></td><td class="code"><div class="highlight"><pre>	<span class="p">.</span><span class="n">i2c_gate_ctrl</span>			<span class="o">=</span> <span class="n">stb0899_i2c_gate_ctrl</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_frontend_algo</span>		<span class="o">=</span> <span class="n">stb0899_frontend_algo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">search</span>				<span class="o">=</span> <span class="n">stb0899_search</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend</span>                   <span class="o">=</span> <span class="n">stb0899_get_frontend</span><span class="p">,</span>


	<span class="p">.</span><span class="n">read_status</span>			<span class="o">=</span> <span class="n">stb0899_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span>			<span class="o">=</span> <span class="n">stb0899_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span>		<span class="o">=</span> <span class="n">stb0899_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span>			<span class="o">=</span> <span class="n">stb0899_read_ber</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_voltage</span>			<span class="o">=</span> <span class="n">stb0899_set_voltage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tone</span>			<span class="o">=</span> <span class="n">stb0899_set_tone</span><span class="p">,</span>

	<span class="p">.</span><span class="n">diseqc_send_master_cmd</span>		<span class="o">=</span> <span class="n">stb0899_send_diseqc_msg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">diseqc_recv_slave_reply</span>	<span class="o">=</span> <span class="n">stb0899_recv_slave_reply</span><span class="p">,</span>
	<span class="p">.</span><span class="n">diseqc_send_burst</span>		<span class="o">=</span> <span class="n">stb0899_send_diseqc_burst</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">stb0899_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">stb0899_inversion</span> <span class="n">inversion</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">inversion</span>				<span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span>				<span class="o">=</span> <span class="o">&amp;</span><span class="n">verbose</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span>				<span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span>				<span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span>			<span class="o">=</span> <span class="n">stb0899_ops</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">demodulator_priv</span>	<span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">.</span><span class="n">inversion</span>		<span class="o">=</span> <span class="n">inversion</span><span class="p">;</span>

	<span class="n">stb0899_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_get_dev_id</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Exiting .. !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Attaching STB0899 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">stb0899_attach</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="s">&quot;Set Verbosity level&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Manu Abraham&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;STB0899 Multi-Std frontend&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
