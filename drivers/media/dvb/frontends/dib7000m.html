<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › dib7000m.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dib7000m.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux-DVB Driver for DiBcom&#39;s DiB7000M and</span>
<span class="cm"> *              first generation DiB7000P-demodulator-family.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-7 DiBcom (http://www.dibcom.fr/)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *	published by the Free Software Foundation, version 2.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &quot;dvb_frontend.h&quot;</span>

<span class="cp">#include &quot;dib7000m.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;turn on debugging (default: 0)&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(args...) do { if (debug) { printk(KERN_DEBUG &quot;DiB7000M: &quot;); printk(args); printk(&quot;\n&quot;); } } while (0)</span>

<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="n">demod</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dib7000m_config</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">i2c_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span>   <span class="o">*</span><span class="n">i2c_adap</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dibx000_i2c_master</span> <span class="n">i2c_master</span><span class="p">;</span>

<span class="cm">/* offset is 1 in case of the 7000MC */</span>
	<span class="n">u8</span> <span class="n">reg_offs</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">wbd_ref</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">current_band</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">current_bandwidth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dibx000_agc_config</span> <span class="o">*</span><span class="n">current_agc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timf_default</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">internal_clk</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">div_force_off</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">div_state</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">div_sync_wait</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">revision</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">agc_state</span><span class="p">;</span>

	<span class="cm">/* for the I2C transfer */</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">i2c_buffer_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dib7000m_power_mode</span> <span class="p">{</span>
	<span class="n">DIB7000M_POWER_ALL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

	<span class="n">DIB7000M_POWER_NO</span><span class="p">,</span>
	<span class="n">DIB7000M_POWER_INTERF_ANALOG_AGC</span><span class="p">,</span>
	<span class="n">DIB7000M_POWER_COR4_DINTLV_ICIRM_EQUAL_CFROD</span><span class="p">,</span>
	<span class="n">DIB7000M_POWER_COR4_CRY_ESRAM_MOUT_NUD</span><span class="p">,</span>
	<span class="n">DIB7000M_POWER_INTERFACE_ONLY</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dib7000m_read_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;i2c read error on %d&quot;</span><span class="p">,</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_write_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">?</span>
			<span class="o">-</span><span class="n">EREMOTEIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000m_write_tab</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">n</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">n</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">112</span> <span class="o">&amp;&amp;</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="mi">331</span><span class="p">))</span> <span class="c1">// compensate for 7000MC</span>
			<span class="n">r</span><span class="o">++</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="o">++</span><span class="p">);</span>
			<span class="n">r</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">l</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">n</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_set_output_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">outreg</span><span class="p">,</span> <span class="n">fifo_threshold</span><span class="p">,</span> <span class="n">smo_mode</span><span class="p">,</span>
		<span class="n">sram</span> <span class="o">=</span> <span class="mh">0x0005</span><span class="p">;</span> <span class="cm">/* by default SRAM output is disabled */</span>

	<span class="n">outreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fifo_threshold</span> <span class="o">=</span> <span class="mi">1792</span><span class="p">;</span>
	<span class="n">smo_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">294</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0010</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;setting output mode for demod %p to %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_GATED_CLK</span>:   <span class="c1">// STBs with parallel gated clock</span>
			<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>  <span class="cm">/* 0x0400 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_CONT_CLK</span>:    <span class="c1">// STBs with parallel continues clock</span>
			<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span> <span class="cm">/* 0x0440 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OUTMODE_MPEG2_SERIAL</span>:          <span class="c1">// STBs with serial input</span>
			<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* 0x0482 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OUTMODE_DIVERSITY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">hostbus_diversity</span><span class="p">)</span>
				<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span> <span class="cm">/* 0x0500 */</span>
			<span class="k">else</span>
				<span class="n">sram</span>   <span class="o">|=</span> <span class="mh">0x0c00</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OUTMODE_MPEG2_FIFO</span>:            <span class="c1">// e.g. USB feeding</span>
			<span class="n">smo_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">fifo_threshold</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
			<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OUTMODE_HIGH_Z</span>:  <span class="c1">// disable</span>
			<span class="n">outreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;Unhandled output_mode passed to be set for demod %p&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mpeg2_in_188_bytes</span><span class="p">)</span>
		<span class="n">smo_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="mi">294</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">,</span> <span class="n">smo_mode</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="mi">295</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">,</span> <span class="n">fifo_threshold</span><span class="p">);</span> <span class="cm">/* synchronous fread */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1795</span><span class="p">,</span> <span class="n">outreg</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1805</span><span class="p">,</span> <span class="n">sram</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x4003</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">clk_cfg1</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">909</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OUTMODE_DIVERSITY</span><span class="p">)</span>
			<span class="n">clk_cfg1</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// P_O_CLK_en</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">909</span><span class="p">,</span> <span class="n">clk_cfg1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000m_set_power_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dib7000m_power_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* by default everything is going to be powered off */</span>
	<span class="n">u16</span> <span class="n">reg_903</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">reg_904</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">reg_905</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">reg_906</span>  <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* now, depending on the requested mode, we power on */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* power up everything in the demod */</span>
		<span class="k">case</span> <span class="n">DIB7000M_POWER_ALL</span>:
			<span class="n">reg_903</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span> <span class="n">reg_904</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span> <span class="n">reg_905</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span> <span class="n">reg_906</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* just leave power on the control-interfaces: GPIO and (I2C or SDIO or SRAM) */</span>
		<span class="k">case</span> <span class="n">DIB7000M_POWER_INTERFACE_ONLY</span>: <span class="cm">/* TODO power up either SDIO or I2C or SRAM */</span>
			<span class="n">reg_905</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DIB7000M_POWER_INTERF_ANALOG_AGC</span>:
			<span class="n">reg_903</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>
			<span class="n">reg_905</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
			<span class="n">reg_906</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DIB7000M_POWER_COR4_DINTLV_ICIRM_EQUAL_CFROD</span>:
			<span class="n">reg_903</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span> <span class="n">reg_904</span> <span class="o">=</span> <span class="mh">0x801f</span><span class="p">;</span> <span class="n">reg_905</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span> <span class="n">reg_906</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DIB7000M_POWER_COR4_CRY_ESRAM_MOUT_NUD</span>:
			<span class="n">reg_903</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span> <span class="n">reg_904</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span> <span class="n">reg_905</span> <span class="o">=</span> <span class="mh">0x010b</span><span class="p">;</span> <span class="n">reg_906</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DIB7000M_POWER_NO</span>:
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* always power down unused parts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mobile_mode</span><span class="p">)</span>
		<span class="n">reg_904</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* P_sdio_select_clk = 0 on MC and after*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="n">reg_906</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x4003</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">903</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg_903</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">904</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg_904</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">905</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg_905</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">906</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg_906</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_set_adc_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dibx000_adc_states</span> <span class="n">no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_913</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">913</span><span class="p">),</span>
	       <span class="n">reg_914</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">914</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">no</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DIBX000_SLOW_ADC_ON</span>:
			<span class="n">reg_914</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">914</span><span class="p">,</span> <span class="n">reg_914</span><span class="p">);</span>
			<span class="n">reg_914</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DIBX000_SLOW_ADC_OFF</span>:
			<span class="n">reg_914</span> <span class="o">|=</span>  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DIBX000_ADC_ON</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// workaround for PA/MA</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>power-up ADC</p></td><td class="code"><div class="highlight"><pre>				<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">913</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">914</span><span class="p">,</span> <span class="n">reg_914</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>power-down bandgag</p></td><td class="code"><div class="highlight"><pre>				<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">913</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">));</span>
				<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">914</span><span class="p">,</span> <span class="n">reg_914</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">reg_913</span> <span class="o">&amp;=</span> <span class="mh">0x0fff</span><span class="p">;</span>
			<span class="n">reg_914</span> <span class="o">&amp;=</span> <span class="mh">0x0003</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DIBX000_ADC_OFF</span>: <span class="c1">// leave the VBG voltage on</span>
			<span class="n">reg_913</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
			<span class="n">reg_914</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DIBX000_VBG_ENABLE</span>:
			<span class="n">reg_913</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DIBX000_VBG_DISABLE</span>:
			<span class="n">reg_913</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>dprintk( "913: %x, 914: %x", reg<em>913, reg</em>914);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">913</span><span class="p">,</span> <span class="n">reg_913</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">914</span><span class="p">,</span> <span class="n">reg_914</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_set_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">timf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bw</span><span class="p">)</span>
		<span class="n">bw</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>store the current bandwidth for later use</p></td><td class="code"><div class="highlight"><pre>	<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_bandwidth</span> <span class="o">=</span> <span class="n">bw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;using default timf&quot;</span><span class="p">);</span>
		<span class="n">timf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">timf_default</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;using updated timf&quot;</span><span class="p">);</span>
		<span class="n">timf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">timf</span> <span class="o">=</span> <span class="n">timf</span> <span class="o">*</span> <span class="p">(</span><span class="n">bw</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">160</span><span class="p">;</span>

	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">timf</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">timf</span>      <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_set_diversity_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">div_force_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;diversity combination deactivated - forced by COFDM parameters&quot;</span><span class="p">);</span>
		<span class="n">onoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">div_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">onoff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">263</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">264</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">266</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">div_sync_wait</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">263</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">264</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">266</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_sad_calib</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>

<span class="cm">/* internal */</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>dib7000m<em>write</em>word(state, 928, (3 &lt;&lt; 14) | (1 &lt;&lt; 12) | (524 &lt;&lt; 0)); // sampling clock of the SAD is writting in set_bandwidth</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">929</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">930</span><span class="p">,</span> <span class="mi">776</span><span class="p">);</span> <span class="c1">// 0.625*3.3 / 4096</span>

	<span class="cm">/* do the calibration */</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">929</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">929</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000m_reset_pll_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dibx000_bandwidth_config</span> <span class="o">*</span><span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">internal</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>        <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">ifreq</span>          <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span>  <span class="n">bw</span><span class="o">-&gt;</span><span class="n">ifreq</span>                 <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>

	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">928</span><span class="p">,</span> <span class="n">bw</span><span class="o">-&gt;</span><span class="n">sad_cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000m_reset_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dibx000_bandwidth_config</span> <span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bw</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_907</span><span class="p">,</span><span class="n">reg_910</span><span class="p">;</span>

	<span class="cm">/* default */</span>
	<span class="n">reg_907</span> <span class="o">=</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_bypass</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">modulo</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">ADClkSrc</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">IO_CLK_en_core</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">bypclk_div</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">enable_refdiv</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">reg_910</span> <span class="o">=</span> <span class="p">(((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_range</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_reset</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>for this oscillator frequency should be 30 MHz for the Master (default values in the board_parameters give that value)
this is only working only for 30 MHz crystals</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">quartz_direct</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_910</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>  <span class="c1">// forcing the predivider to 1</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>if the previous front-end is baseband, its output frequency is 15 MHz (prev freq divided by 2)</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">input_clk_is_div_2</span><span class="p">)</span>
			<span class="n">reg_907</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="k">else</span> <span class="c1">// otherwise the previous front-end puts out its input (default 30MHz) - no extra division necessary</span>
			<span class="n">reg_907</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg_907</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_ratio</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">reg_910</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_prediv</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">910</span><span class="p">,</span> <span class="n">reg_910</span><span class="p">);</span> <span class="c1">// pll cfg</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">907</span><span class="p">,</span> <span class="n">reg_907</span><span class="p">);</span> <span class="c1">// clk cfg0</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">908</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">);</span>  <span class="c1">// clk_cfg1</span>

	<span class="n">dib7000m_reset_pll_common</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000mc_reset_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dibx000_bandwidth_config</span> <span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bw</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clk_cfg1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>clk_cfg0</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">907</span><span class="p">,</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_prediv</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_ratio</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>clk<em>cfg1
dib7000m</em>write_word(state, 908, (1 &lt;&lt; 14) | (3 &lt;&lt; 12) |(0 &lt;&lt; 11) |</p></td><td class="code"><div class="highlight"><pre>	<span class="n">clk_cfg1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">IO_CLK_en_core</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">bypclk_div</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">enable_refdiv</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_range</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_reset</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">908</span><span class="p">,</span> <span class="n">clk_cfg1</span><span class="p">);</span>
	<span class="n">clk_cfg1</span> <span class="o">=</span> <span class="p">(</span><span class="n">clk_cfg1</span> <span class="o">&amp;</span> <span class="mh">0xfff7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">pll_bypass</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">908</span><span class="p">,</span> <span class="n">clk_cfg1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>smpl_cfg</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">910</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">modulo</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">ADClkSrc</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">));</span>

	<span class="n">dib7000m_reset_pll_common</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_reset_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset the GPIOs */</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">773</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_dir</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">774</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="cm">/* TODO 782 is P_gpio_od */</span>

	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">775</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_pwm_pos</span><span class="p">);</span>

	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">780</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pwm_freq_div</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">dib7000m_defaults_common</span><span class="p">[]</span> <span class="o">=</span>

<span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>auto search configuration</p></td><td class="code"><div class="highlight"><pre>	<span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		<span class="mh">0x0004</span><span class="p">,</span>
		<span class="mh">0x1000</span><span class="p">,</span>
		<span class="mh">0x0814</span><span class="p">,</span>

	<span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
		<span class="mh">0x001b</span><span class="p">,</span>
		<span class="mh">0x7740</span><span class="p">,</span>
		<span class="mh">0x005b</span><span class="p">,</span>
		<span class="mh">0x8d80</span><span class="p">,</span>
		<span class="mh">0x01c9</span><span class="p">,</span>
		<span class="mh">0xc380</span><span class="p">,</span>
		<span class="mh">0x0000</span><span class="p">,</span>
		<span class="mh">0x0080</span><span class="p">,</span>
		<span class="mh">0x0000</span><span class="p">,</span>
		<span class="mh">0x0090</span><span class="p">,</span>
		<span class="mh">0x0001</span><span class="p">,</span>
		<span class="mh">0xd4c0</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span>
		<span class="mh">0x6680</span><span class="p">,</span> <span class="c1">// P_corm_thres Lock algorithms configuration</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span>
		<span class="mh">0x0410</span><span class="p">,</span> <span class="c1">// P_palf_alpha_regul, P_palf_filter_freeze, P_palf_filter_on</span>

	<span class="mi">8</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span>
		<span class="mi">8192</span><span class="p">,</span> <span class="c1">// P_fft_nb_to_cut</span>

	<span class="mi">2</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span>
		<span class="mh">0x0ccd</span><span class="p">,</span> <span class="c1">// P_pha3_thres</span>
		<span class="mi">0</span><span class="p">,</span>      <span class="c1">// P_cti_use_cpe, P_cti_use_prog</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span>
		<span class="mh">0x200f</span><span class="p">,</span> <span class="c1">// P_cspu_regul, P_cspu_win_cut</span>

	<span class="mi">5</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span>
		<span class="mh">0x023d</span><span class="p">,</span> <span class="c1">// P_adp_regul_cnt</span>
		<span class="mh">0x00a4</span><span class="p">,</span> <span class="c1">// P_adp_noise_cnt</span>
		<span class="mh">0x00a4</span><span class="p">,</span> <span class="c1">// P_adp_regul_ext</span>
		<span class="mh">0x7ff0</span><span class="p">,</span> <span class="c1">// P_adp_noise_ext</span>
		<span class="mh">0x3ccc</span><span class="p">,</span> <span class="c1">// P_adp_fil</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="c1">// P_2d_byp_ti_num</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span>
		<span class="mh">0x800</span><span class="p">,</span> <span class="c1">// P_equal_thres_wgn</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">263</span><span class="p">,</span>
		<span class="mh">0x0001</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">281</span><span class="p">,</span>
		<span class="mh">0x0010</span><span class="p">,</span> <span class="c1">// P_fec_*</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">294</span><span class="p">,</span>
		<span class="mh">0x0062</span><span class="p">,</span> <span class="c1">// P_smo_mode, P_smo_rs_discard, P_smo_fifo_flush, P_smo_pid_parse, P_smo_error_discard</span>

	<span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">dib7000m_defaults</span><span class="p">[]</span> <span class="o">=</span>

<span class="p">{</span>
	<span class="cm">/* set ADC level to -16 */</span>
	<span class="mi">11</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">825</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">837</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">811</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">766</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">737</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">693</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">648</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">619</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">575</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">531</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">501</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Tuner IO bank: max drive (14mA)</p></td><td class="code"><div class="highlight"><pre>	<span class="mi">1</span><span class="p">,</span> <span class="mi">912</span><span class="p">,</span>
		<span class="mh">0x2c8a</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">1817</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span>

	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_demod_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dib7000m_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB7000M_POWER_ALL</span><span class="p">);</span>

	<span class="cm">/* always leave the VBG voltage on - it consumes almost nothing but takes a long time to start */</span>
	<span class="n">dib7000m_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_VBG_ENABLE</span><span class="p">);</span>

	<span class="cm">/* restart all parts */</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="mi">898</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="mi">899</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="mi">900</span><span class="p">,</span> <span class="mh">0xff0f</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="mi">901</span><span class="p">,</span> <span class="mh">0xfffc</span><span class="p">);</span>

	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="mi">898</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="mi">899</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="mi">900</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="mi">901</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="n">dib7000m_reset_pll</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib7000mc_reset_pll</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib7000m_reset_gpio</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;GPIO reset was not successful.&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib7000m_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUTMODE_HIGH_Z</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;OUTPUT_MODE could not be reset.&quot;</span><span class="p">);</span>

	<span class="cm">/* unforce divstr regardless whether i2c enumeration was done or not */</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1794</span><span class="p">,</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1794</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">);</span>

	<span class="n">dib7000m_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>

	<span class="n">dib7000m_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_SLOW_ADC_ON</span><span class="p">);</span>
	<span class="n">dib7000m_sad_calib</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">dib7000m_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_SLOW_ADC_OFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">dvbt_mode</span><span class="p">)</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1796</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span> <span class="c1">// select DVB-T output</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">mobile_mode</span><span class="p">)</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">261</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">224</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>P<em>iqc</em>alpha<em>pha, P</em>iqc<em>alpha</em>amp, P<em>iqc</em>dcc_alpha, ...</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">tuner_is_baseband</span><span class="p">)</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mh">0x0755</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mh">0x1f55</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>P<em>divclksel=3 P</em>divbitsel=1</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">909</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">909</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dib7000m_write_tab</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dib7000m_defaults_common</span><span class="p">);</span>
	<span class="n">dib7000m_write_tab</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dib7000m_defaults</span><span class="p">);</span>

	<span class="n">dib7000m_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB7000M_POWER_INTERFACE_ONLY</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">internal_clk</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000m_restart_agc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>P<em>restart</em>iqc &amp; P<em>restart</em>agc</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">898</span><span class="p">,</span> <span class="mh">0x0c00</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">898</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_agc_soft_split</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">agc</span><span class="p">,</span><span class="n">split_offset</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span> <span class="o">||</span> <span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">perform_agc_softsplit</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>n<em>agc</em>global</p></td><td class="code"><div class="highlight"><pre>	<span class="n">agc</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">390</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agc</span> <span class="o">&gt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">min_thres</span><span class="p">)</span>
		<span class="n">split_offset</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">agc</span> <span class="o">&lt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">max_thres</span><span class="p">)</span>
		<span class="n">split_offset</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">split_offset</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">max</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">agc</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">min_thres</span><span class="p">)</span> <span class="o">/</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">max_thres</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">min_thres</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;AGC split_offset: %d&quot;</span><span class="p">,</span><span class="n">split_offset</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>P<em>agc</em>force<em>split and P</em>agc<em>split</em>offset</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="p">(</span><span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">103</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">|</span> <span class="n">split_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_update_lna</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dyn_gain</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">update_lna</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>read dyn_gain here (because it is demod-dependent and not fe)</p></td><td class="code"><div class="highlight"><pre>		<span class="n">dyn_gain</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">390</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">update_lna</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">,</span><span class="n">dyn_gain</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// LNA has changed</span>
			<span class="n">dib7000m_restart_agc</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_set_agc_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dibx000_agc_config</span> <span class="o">*</span><span class="n">agc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">band</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_config_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">band_caps</span> <span class="o">&amp;</span> <span class="n">band</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">agc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;no valid AGC configuration found for band 0x%02x&quot;</span><span class="p">,</span><span class="n">band</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span> <span class="o">=</span> <span class="n">agc</span><span class="p">;</span>

	<span class="cm">/* AGC */</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">72</span> <span class="p">,</span>  <span class="n">agc</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">73</span> <span class="p">,</span>  <span class="n">agc</span><span class="o">-&gt;</span><span class="n">inv_gain</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">74</span> <span class="p">,</span>  <span class="n">agc</span><span class="o">-&gt;</span><span class="n">time_stabiliz</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">97</span> <span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">alpha_level</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">thlock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Demod AGC loop configuration</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">alpha_mant</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">alpha_exp</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">beta_mant</span>  <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">beta_exp</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;WBD: ref: %d, sel: %d, active: %d, alpha: %d&quot;</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span> <span class="o">:</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_ref</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_sel</span><span class="p">,</span> <span class="o">!</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">perform_agc_softsplit</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_sel</span><span class="p">);</span>

	<span class="cm">/* AGC continued */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span><span class="p">);</span>
	<span class="k">else</span> <span class="c1">// use default</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_ref</span><span class="p">);</span>

	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_alpha</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">perform_agc_softsplit</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span>  <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_max</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span>  <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_min</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span>  <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_max</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span>  <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_min</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_pt1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_pt2</span> <span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_slope1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_slope2</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_pt1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_pt2</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_slope1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_slope2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// settings for the MC</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span>   <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_pt3</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><pre><code>dprintk( "929: %x %d %d",
    (dib7000m_read_word(state, 929) &amp; 0xffe3) | (agc-&gt;wbd_inv &lt;&lt; 4) | (agc-&gt;wbd_sel &lt;&lt; 2), agc-&gt;wbd_inv, agc-&gt;wbd_sel);
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">929</span><span class="p">,</span> <span class="p">(</span><span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">929</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffe3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_inv</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_sel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>wrong default values</p></td><td class="code"><div class="highlight"><pre>		<span class="n">u16</span> <span class="n">b</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">676</span><span class="p">,</span> <span class="mi">696</span><span class="p">,</span> <span class="mi">717</span><span class="p">,</span> <span class="mi">737</span><span class="p">,</span> <span class="mi">758</span><span class="p">,</span> <span class="mi">778</span><span class="p">,</span> <span class="mi">799</span><span class="p">,</span> <span class="mi">819</span><span class="p">,</span> <span class="mi">840</span> <span class="p">};</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">88</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000m_update_timf</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">timf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">436</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">437</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span> <span class="o">=</span> <span class="n">timf</span> <span class="o">*</span> <span class="mi">160</span> <span class="o">/</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_bandwidth</span> <span class="o">/</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">timf</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">timf</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;updated timf_frequency: %d (default: %d)&quot;</span><span class="p">,</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">timf_default</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_agc_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">demod</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cfg_72</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">72</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">agc_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">agc_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">agc_split</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">agc_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:</pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>set power-up level: interf+analog+AGC</p></td><td class="code"><div class="highlight"><pre>			<span class="n">dib7000m_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB7000M_POWER_INTERF_ANALOG_AGC</span><span class="p">);</span>
			<span class="n">dib7000m_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_ADC_ON</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dib7000m_set_agc_config</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">BAND_OF_FREQUENCY</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="o">/</span><span class="mi">1000</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* ADC power up */</span>
			<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* AGC initialization */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_control</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">32768</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">perform_agc_softsplit</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* we are using the wbd - so slow AGC startup */</span>
				<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span> <span class="cm">/* force 0 split on WBD and restart AGC */</span>
				<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* default AGC startup */</span>
				<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="cm">/* wait AGC rough lock time */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dib7000m_restart_agc</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* fast split search path after 5sec */</span>
			<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="mi">72</span><span class="p">,</span> <span class="n">cfg_72</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span> <span class="cm">/* freeze AGC loop */</span>
			<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>            <span class="cm">/* fast split search 0.25kHz */</span>
			<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* split search ended */</span>
			<span class="n">agc_split</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">392</span><span class="p">);</span> <span class="cm">/* store the split value for the next time */</span>
			<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">390</span><span class="p">));</span> <span class="cm">/* set AGC gain start value */</span>

			<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span>  <span class="n">cfg_72</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>   <span class="cm">/* std AGC loop */</span>
			<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">wbd_alpha</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc_split</span><span class="p">);</span> <span class="cm">/* standard split search */</span>

			<span class="n">dib7000m_restart_agc</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

			<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;SPLIT %p: %hd&quot;</span><span class="p">,</span> <span class="n">demod</span><span class="p">,</span> <span class="n">agc_split</span><span class="p">);</span>

			<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* LNA startup */</span>
			<span class="cm">/* wait AGC accurate lock time */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dib7000m_update_lna</span><span class="p">(</span><span class="n">state</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>wait only AGC rough lock time</p></td><td class="code"><div class="highlight"><pre>				<span class="n">ret</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">dib7000m_agc_soft_split</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_control</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="p">(</span><span class="o">*</span><span class="n">agc_state</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000m_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">est</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">dib7000m_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">BANDWIDTH_TO_KHZ</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">));</span>

	<span class="cm">/* nfft, guard, qam, alpha */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">guard_interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_32</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_16</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_4</span>:  <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_8</span>:  <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QPSK</span>:  <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QAM_16</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">QAM_64</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">HIERARCHY_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HIERARCHY_2</span>: <span class="n">value</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HIERARCHY_4</span>: <span class="n">value</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">HIERARCHY_1</span>: <span class="n">value</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">seq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>

	<span class="cm">/* P_dintl_native, P_dintlv_inv, P_hrch, P_code_rate, P_select_hp */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">:</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FEC_2_3</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_3_4</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_5_6</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_7_8</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">FEC_1_2</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">267</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* offset loop parameters */</span>

	<span class="cm">/* P_timf_alpha = 6, P_corm_alpha=6, P_corm_thres=0x80 */</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="cm">/* P_ctrl_inh_cor=0, P_ctrl_alpha_cor=4, P_ctrl_inh_isi=1, P_ctrl_alpha_isi=3, P_ctrl_inh_cor4=1, P_ctrl_alpha_cor4=3 */</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x3</span><span class="p">));</span>

	<span class="cm">/* P_ctrl_freeze_pha_shift=0, P_ctrl_pha_off_max=3 */</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>

	<span class="cm">/* P_ctrl_sfreq_inh=0, P_ctrl_sfreq_step=5 */</span>
	<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x5</span><span class="p">);</span>

	<span class="cm">/* P_dvsy_sync_wait */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>: <span class="n">value</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>: <span class="n">value</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
		<span class="nl">default:</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">guard_interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_16</span>: <span class="n">value</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_8</span>:  <span class="n">value</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_4</span>:  <span class="n">value</span> <span class="o">*=</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_32</span>: <span class="n">value</span> <span class="o">*=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">div_sync_wait</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span> <span class="c1">// add 50% SFN margin + compensate for one DVSY-fifo TODO</span>

	<span class="cm">/* deactive the possibility of diversity reception if extended interleave - not for 7000MC */</span>
	<span class="cm">/* P_dvsy_sync_mode = 0, P_dvsy_sync_enable=1, P_dvcb_comb_mode=2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">div_force_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">div_force_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dib7000m_set_diversity_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">div_state</span><span class="p">);</span>

	<span class="cm">/* channel estimation fine configuration */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QAM_64</span>:
			<span class="n">est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0148</span><span class="p">;</span>       <span class="cm">/* P_adp_regul_cnt 0.04 */</span>
			<span class="n">est</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfff0</span><span class="p">;</span>       <span class="cm">/* P_adp_noise_cnt -0.002 */</span>
			<span class="n">est</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00a4</span><span class="p">;</span>       <span class="cm">/* P_adp_regul_ext 0.02 */</span>
			<span class="n">est</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfff8</span><span class="p">;</span>       <span class="cm">/* P_adp_noise_ext -0.001 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QAM_16</span>:
			<span class="n">est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x023d</span><span class="p">;</span>       <span class="cm">/* P_adp_regul_cnt 0.07 */</span>
			<span class="n">est</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffdf</span><span class="p">;</span>       <span class="cm">/* P_adp_noise_cnt -0.004 */</span>
			<span class="n">est</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00a4</span><span class="p">;</span>       <span class="cm">/* P_adp_regul_ext 0.02 */</span>
			<span class="n">est</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfff0</span><span class="p">;</span>       <span class="cm">/* P_adp_noise_ext -0.002 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x099a</span><span class="p">;</span>       <span class="cm">/* P_adp_regul_cnt 0.3 */</span>
			<span class="n">est</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffae</span><span class="p">;</span>       <span class="cm">/* P_adp_noise_cnt -0.01 */</span>
			<span class="n">est</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0333</span><span class="p">;</span>       <span class="cm">/* P_adp_regul_ext 0.1 */</span>
			<span class="n">est</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfff8</span><span class="p">;</span>       <span class="cm">/* P_adp_noise_ext -0.002 */</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">value</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">214</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">,</span> <span class="n">est</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>set power-up level: autosearch</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib7000m_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB7000M_POWER_COR4_DINTLV_ICIRM_EQUAL_CFROD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_autosearch_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">demod</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="n">schan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">factor</span><span class="p">;</span>

	<span class="n">schan</span> <span class="o">=</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="n">schan</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_64</span><span class="p">;</span>
	<span class="n">schan</span><span class="p">.</span><span class="n">guard_interval</span>        <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_32</span><span class="p">;</span>
	<span class="n">schan</span><span class="p">.</span><span class="n">transmission_mode</span>         <span class="o">=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span>
	<span class="n">schan</span><span class="p">.</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
	<span class="n">schan</span><span class="p">.</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span>
	<span class="n">schan</span><span class="p">.</span><span class="n">hierarchy</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dib7000m_set_channel</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schan</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">factor</span> <span class="o">=</span> <span class="n">BANDWIDTH_TO_KHZ</span><span class="p">(</span><span class="n">schan</span><span class="p">.</span><span class="n">bandwidth_hz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">factor</span> <span class="o">&gt;=</span> <span class="mi">5000</span><span class="p">)</span>
		<span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">factor</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>always use the setting for 8MHz here lock_time for 7,6 MHz are longer</p></td><td class="code"><div class="highlight"><pre>	<span class="n">value</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal_clk</span> <span class="o">*</span> <span class="n">factor</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>  <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span> <span class="c1">// lock0 wait time</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">(</span><span class="n">u16</span><span class="p">)</span>  <span class="p">(</span><span class="n">value</span>        <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span> <span class="c1">// lock0 wait time</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal_clk</span> <span class="o">*</span> <span class="n">factor</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span> <span class="c1">// lock1 wait time</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>  <span class="p">(</span><span class="n">u16</span><span class="p">)</span>  <span class="p">(</span><span class="n">value</span>        <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span> <span class="c1">// lock1 wait time</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mi">500</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">internal_clk</span> <span class="o">*</span> <span class="n">factor</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span> <span class="c1">// lock2 wait time</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span>  <span class="p">(</span><span class="n">value</span>        <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span> <span class="c1">// lock2 wait time</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>start search</p></td><td class="code"><div class="highlight"><pre>	<span class="n">value</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">value</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)));</span>

	<span class="cm">/* clear n_irq_pending */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1793</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">537</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_autosearch_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">irq_pending</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_pending</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// failed</span>
		<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;autosearch failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_pending</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// succeeded</span>
		<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;autosearch succeeded&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// still pending</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_autosearch_is_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dib7000m_autosearch_irq</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1793</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">dib7000m_autosearch_irq</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">537</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_tune</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">demod</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>we are already tuned - just resuming from suspend</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dib7000m_set_channel</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>restart demod</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">898</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">898</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">45</span><span class="p">);</span>

	<span class="n">dib7000m_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB7000M_POWER_COR4_CRY_ESRAM_MOUT_NUD</span><span class="p">);</span>
	<span class="cm">/* P_ctrl_inh_cor=0, P_ctrl_alpha_cor=4, P_ctrl_inh_isi=0, P_ctrl_alpha_isi=3, P_ctrl_inh_cor4=1, P_ctrl_alpha_cor4=3 */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x3</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>never achieved a lock before - wait for timfreq to update</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>dump_reg(state);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* P_timf_alpha, P_corm_alpha=6, P_corm_thres=0x80 */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>: <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">9</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* P_ctrl_freeze_pha_shift=0, P_ctrl_pha_off_max */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>: <span class="n">value</span> <span class="o">|=</span> <span class="mh">0x6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>: <span class="n">value</span> <span class="o">|=</span> <span class="mh">0x7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>: <span class="n">value</span> <span class="o">|=</span> <span class="mh">0x8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* P_ctrl_sfreq_inh=0, P_ctrl_sfreq_step */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>: <span class="n">value</span> <span class="o">|=</span> <span class="mh">0x6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>: <span class="n">value</span> <span class="o">|=</span> <span class="mh">0x7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>: <span class="n">value</span> <span class="o">|=</span> <span class="mh">0x8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span>  <span class="n">value</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>we achieved a lock - it's time to update the timf freq</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">535</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">dib7000m_update_timf</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="n">dib7000m_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">BANDWIDTH_TO_KHZ</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dib7000m_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB7000M_POWER_ALL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib7000m_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_SLOW_ADC_ON</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;could not start Slow ADC&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">dib7000m_set_output_mode</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">OUTMODE_HIGH_Z</span><span class="p">);</span>
	<span class="n">dib7000m_set_power_mode</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">DIB7000M_POWER_INTERFACE_ONLY</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dib7000m_set_adc_state</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">DIBX000_SLOW_ADC_OFF</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">dib7000m_set_adc_state</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">DIBX000_ADC_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_identify</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">896</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x01b3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;wrong Vendor ID (0x%x)&quot;</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">897</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x4000</span> <span class="o">&amp;&amp;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x4001</span> <span class="o">&amp;&amp;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x4002</span> <span class="o">&amp;&amp;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x4003</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;wrong Device ID (0x%x)&quot;</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* protect this driver to be used with 7000PC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x4000</span> <span class="o">&amp;&amp;</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">769</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;this driver does not work with DiB7000PC&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x4000</span>: <span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;found DiB7000MA/PA/MB/PB&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x4001</span>: <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;found DiB7000HC&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x4002</span>: <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;found DiB7000MC&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x4003</span>: <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">dprintk</span><span class="p">(</span> <span class="s">&quot;found DiB9000&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">fep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tps</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="mi">480</span><span class="p">);</span>

	<span class="n">fep</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">INVERSION_AUTO</span><span class="p">;</span>

	<span class="n">fep</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="n">BANDWIDTH_TO_HZ</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_bandwidth</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">tps</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_2K</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="cm">/* case 2: fep-&gt;transmission_mode = TRANSMISSION_MODE_4K; break; */</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tps</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_32</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_16</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">tps</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QPSK</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_16</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
		<span class="nl">default:</span> <span class="n">fep</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_64</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* as long as the frontend_param structure is fixed for hierarchical transmission I refuse to use it */</span>
	<span class="cm">/* (tps &gt;&gt; 13) &amp; 0x1 == hrch is used, (tps &gt;&gt; 10) &amp; 0x7 == alpha */</span>

	<span class="n">fep</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_NONE</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">tps</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_1_2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_5_6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:
		<span class="nl">default:</span> <span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_7_8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">tps</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_1_2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>: <span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_5_6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:
		<span class="nl">default:</span> <span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_7_8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* native interleaver: (dib7000m_read_word(state, 481) &gt;&gt;  5) &amp; 0x1 */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">fep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">time</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dib7000m_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUTMODE_HIGH_Z</span><span class="p">);</span>

	<span class="n">dib7000m_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">BANDWIDTH_TO_KHZ</span><span class="p">(</span><span class="n">fep</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="cm">/* start up the AGC */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">agc_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">time</span> <span class="o">=</span> <span class="n">dib7000m_agc_startup</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fep</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">==</span> <span class="n">TRANSMISSION_MODE_AUTO</span> <span class="o">||</span>
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">guard_interval</span>    <span class="o">==</span> <span class="n">GUARD_INTERVAL_AUTO</span> <span class="o">||</span>
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">modulation</span>        <span class="o">==</span> <span class="n">QAM_AUTO</span> <span class="o">||</span>
		<span class="n">fep</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span>      <span class="o">==</span> <span class="n">FEC_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span> <span class="n">found</span><span class="p">;</span>

		<span class="n">dib7000m_autosearch_start</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">found</span> <span class="o">=</span> <span class="n">dib7000m_autosearch_is_irq</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">--</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;autosearch returns: %d&quot;</span><span class="p">,</span><span class="n">found</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">found</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// no channel found</span>

		<span class="n">dib7000m_get_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dib7000m_tune</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="cm">/* make this a config parameter */</span>
	<span class="n">dib7000m_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OUTMODE_MPEG2_FIFO</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span><span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">535</span><span class="p">);</span>

	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_SIGNAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_CARRIER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x0010</span><span class="p">)</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_SYNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x0008</span><span class="p">)</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">526</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">527</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_read_unc_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">unc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="o">*</span><span class="n">unc</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">534</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">390</span><span class="p">);</span>
	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">65535</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib7000m_fe_get_tune_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span> <span class="o">*</span><span class="n">tune</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tune</span><span class="o">-&gt;</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib7000m_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">dibx000_exit_i2c_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span> <span class="nf">dib7000m_get_i2c_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dibx000_i2c_interface</span> <span class="n">intf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gating</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dibx000_get_i2c_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">gating</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000m_get_i2c_master</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib7000m_pid_filter_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">dib7000m_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">294</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffef</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">onoff</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;PID filter enabled %d&quot;</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">294</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000m_pid_filter_ctrl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib7000m_pid_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;PID filter: index %x, PID %d, OnOff %d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dib7000m_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">300</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reg_offs</span> <span class="o">+</span> <span class="n">id</span><span class="p">,</span>
			<span class="n">onoff</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000m_pid_filter</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* used with some prototype boards */</span>
<span class="c">int dib7000m_i2c_enumeration(struct i2c_adapter *i2c, int no_of_demods,</span>
<span class="c">		u8 default_addr, struct dib7000m_config cfg[])</span>
<span class="c">{</span>
<span class="c">	struct dib7000m_state st = { .i2c_adap = i2c };</span>
<span class="c">	int k = 0;</span>
<span class="c">	u8 new_addr = 0;</span>

<span class="c">	for (k = no_of_demods-1; k &gt;= 0; k--) {</span>
<span class="c">		st.cfg = cfg[k];</span>

<span class="c">		/* designated i2c address */</span>
<span class="c">		new_addr          = (0x40 + k) &lt;&lt; 1;</span>
<span class="c">		st.i2c_addr = new_addr;</span>
<span class="c">		if (dib7000m_identify(&amp;st) != 0) {</span>
<span class="c">			st.i2c_addr = default_addr;</span>
<span class="c">			if (dib7000m_identify(&amp;st) != 0) {</span>
<span class="c">				dprintk(&quot;DiB7000M #%d: not identified&quot;, k);</span>
<span class="c">				return -EIO;</span>
<span class="c">			}</span>
<span class="c">		}</span>

<span class="c">		/* start diversity to pull_down div_str - just for i2c-enumeration */</span>
<span class="c">		dib7000m_set_output_mode(&amp;st, OUTMODE_DIVERSITY);</span>

<span class="c">		dib7000m_write_word(&amp;st, 1796, 0x0); // select DVB-T output</span>

<span class="c">		/* set new i2c address and force divstart */</span>
<span class="c">		dib7000m_write_word(&amp;st, 1794, (new_addr &lt;&lt; 2) | 0x2);</span>

<span class="c">		dprintk(&quot;IC %d initialized (to i2c_address 0x%x)&quot;, k, new_addr);</span>
<span class="c">	}</span>

<span class="c">	for (k = 0; k &lt; no_of_demods; k++) {</span>
<span class="c">		st.cfg = cfg[k];</span>
<span class="c">		st.i2c_addr = (0x40 + k) &lt;&lt; 1;</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>unforce divstr</p></td><td class="code"><div class="highlight"><pre><span class="c">		dib7000m_write_word(&amp;st,1794, st.i2c_addr &lt;&lt; 2);</span>

<span class="c">		/* deactivate div - it was just for i2c-enumeration */</span>
<span class="c">		dib7000m_set_output_mode(&amp;st, OUTMODE_HIGH_Z);</span>
<span class="c">	}</span>

<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="c">EXPORT_SYMBOL(dib7000m_i2c_enumeration);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">dib7000m_ops</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span> <span class="nf">dib7000m_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">u8</span> <span class="n">i2c_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dib7000m_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">demod</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib7000m_state</span> <span class="o">*</span><span class="n">st</span><span class="p">;</span>
	<span class="n">st</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib7000m_config</span><span class="p">));</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_adap</span> <span class="o">=</span> <span class="n">i2c_adap</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">i2c_addr</span><span class="p">;</span>

	<span class="n">demod</span>                   <span class="o">=</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">;</span>
	<span class="n">demod</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">demod</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dib7000m_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">timf_default</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">timf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib7000m_identify</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="n">dibx000_init_i2c_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">,</span> <span class="n">DIB7000</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dibx000_init_i2c_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">,</span> <span class="n">DIB7000MC</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">);</span>

	<span class="n">dib7000m_demod_reset</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">demod</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib7000m_attach</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">dib7000m_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBT</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DiBcom 7000MA/MB/PA/PB/MC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span>      <span class="o">=</span> <span class="mi">44250000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span>      <span class="o">=</span> <span class="mi">867250000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">=</span> <span class="mi">62500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">FE_CAN_INVERSION_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span>
			<span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_QPSK</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_TRANSMISSION_MODE_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_GUARD_INTERVAL_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_RECOVER</span> <span class="o">|</span>
			<span class="n">FE_CAN_HIERARCHY_AUTO</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">release</span>              <span class="o">=</span> <span class="n">dib7000m_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init</span>                 <span class="o">=</span> <span class="n">dib7000m_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span>                <span class="o">=</span> <span class="n">dib7000m_sleep</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_frontend</span>         <span class="o">=</span> <span class="n">dib7000m_set_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span>    <span class="o">=</span> <span class="n">dib7000m_fe_get_tune_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend</span>         <span class="o">=</span> <span class="n">dib7000m_get_frontend</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_status</span>          <span class="o">=</span> <span class="n">dib7000m_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span>             <span class="o">=</span> <span class="n">dib7000m_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">dib7000m_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span>             <span class="o">=</span> <span class="n">dib7000m_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span>        <span class="o">=</span> <span class="n">dib7000m_read_unc_blocks</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Patrick Boettcher &lt;pboettcher@dibcom.fr&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for the DiBcom 7000MA/MB/PA/PB/MC COFDM demodulator&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
