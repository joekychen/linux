<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › stv0367.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>stv0367.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * stv0367.c</span>
<span class="cm"> *</span>
<span class="cm"> * Driver for ST STV0367 DVB-T &amp; DVB-C demodulator IC.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) ST Microelectronics.</span>
<span class="cm"> * Copyright (C) 2010,2011 NetUP Inc.</span>
<span class="cm"> * Copyright (C) 2010,2011 Igor M. Liplianin &lt;liplianin@netup.ru&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>

<span class="cp">#include &quot;stv0367.h&quot;</span>
<span class="cp">#include &quot;stv0367_regs.h&quot;</span>
<span class="cp">#include &quot;stv0367_priv.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">stvdebug</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">stvdebug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">i2cdebug</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">i2c_debug</span><span class="p">,</span> <span class="n">i2cdebug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cp">#define dprintk(args...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (stvdebug) \</span>
<span class="cp">			printk(KERN_DEBUG args); \</span>
<span class="cp">	} while (0)</span>
	<span class="cm">/* DVB-C */</span>

<span class="k">struct</span> <span class="n">stv0367cab_state</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">stv0367_cab_signal_type</span>	<span class="n">state</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">mclk</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">adc_clk</span><span class="p">;</span>
	<span class="n">s32</span>	<span class="n">search_range</span><span class="p">;</span>
	<span class="n">s32</span>	<span class="n">derot_offset</span><span class="p">;</span>
	<span class="cm">/* results */</span>
	<span class="kt">int</span> <span class="n">locked</span><span class="p">;</span>			<span class="cm">/* channel found		*/</span>
	<span class="n">u32</span> <span class="n">freq_khz</span><span class="p">;</span>			<span class="cm">/* found frequency (in kHz)	*/</span>
	<span class="n">u32</span> <span class="n">symbol_rate</span><span class="p">;</span>		<span class="cm">/* found symbol rate (in Bds)	*/</span>
	<span class="k">enum</span> <span class="n">stv0367cab_mod</span> <span class="n">modulation</span><span class="p">;</span>	<span class="cm">/* modulation			*/</span>
	<span class="n">fe_spectral_inversion_t</span>	<span class="n">spect_inv</span><span class="p">;</span> <span class="cm">/* Spectrum Inversion	*/</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">stv0367ter_state</span> <span class="p">{</span>
	<span class="cm">/* DVB-T */</span>
	<span class="k">enum</span> <span class="n">stv0367_ter_signal_type</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">stv0367_ter_if_iq_mode</span> <span class="n">if_iq_mode</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">stv0367_ter_mode</span> <span class="n">mode</span><span class="p">;</span><span class="cm">/* mode 2K or 8K */</span>
	<span class="n">fe_guard_interval_t</span> <span class="n">guard</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">stv0367_ter_hierarchy</span> <span class="n">hierarchy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="n">fe_spectral_inversion_t</span>  <span class="n">sense</span><span class="p">;</span> <span class="cm">/*  current search spectrum */</span>
	<span class="n">u8</span>  <span class="n">force</span><span class="p">;</span> <span class="cm">/* force mode/guard */</span>
	<span class="n">u8</span>  <span class="n">bw</span><span class="p">;</span> <span class="cm">/* channel width 6, 7 or 8 in MHz */</span>
	<span class="n">u8</span>  <span class="n">pBW</span><span class="p">;</span> <span class="cm">/* channel width used during previous lock */</span>
	<span class="n">u32</span> <span class="n">pBER</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pPER</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ucblocks</span><span class="p">;</span>
	<span class="n">s8</span>  <span class="n">echo_pos</span><span class="p">;</span> <span class="cm">/* echo position */</span>
	<span class="n">u8</span>  <span class="n">first_lock</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">unlock_counter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">agc_val</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="n">fe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">;</span>
	<span class="cm">/* config settings */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stv0367_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">chip_id</span><span class="p">;</span>
	<span class="cm">/* DVB-C */</span>
	<span class="k">struct</span> <span class="n">stv0367cab_state</span> <span class="o">*</span><span class="n">cab_state</span><span class="p">;</span>
	<span class="cm">/* DVB-T */</span>
	<span class="k">struct</span> <span class="n">stv0367ter_state</span> <span class="o">*</span><span class="n">ter_state</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">st_register</span> <span class="p">{</span>
	<span class="n">u16</span>	<span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">value</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* values for STV4100 XTAL=30M int clk=53.125M*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">st_register</span> <span class="n">def0367ter</span><span class="p">[</span><span class="n">STV0367TER_NBREGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">R367TER_ID</span><span class="p">,</span>		<span class="mh">0x60</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_I2CRPT</span><span class="p">,</span>	<span class="mh">0xa0</span><span class="p">},</span>
	<span class="cm">/* {R367TER_I2CRPT,	0x22},*/</span>
	<span class="p">{</span><span class="n">R367TER_TOPCTRL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span><span class="cm">/* for xc5000; was 0x02 */</span>
	<span class="p">{</span><span class="n">R367TER_IOCFG0</span><span class="p">,</span>	<span class="mh">0x40</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DAC0R</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_IOCFG1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DAC1R</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_IOCFG2</span><span class="p">,</span>	<span class="mh">0x62</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SDFR</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_STATUS</span><span class="p">,</span>	<span class="mh">0xf8</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AUX_CLK</span><span class="p">,</span>	<span class="mh">0x0a</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FREESYS1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FREESYS2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FREESYS3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_GPIO_CFG</span><span class="p">,</span>	<span class="mh">0x55</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_GPIO_CMD</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC2MAX</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC2MIN</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC1MAX</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC1MIN</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGCR</span><span class="p">,</span>		<span class="mh">0xbc</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC2TH</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC12C</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGCCTRL1</span><span class="p">,</span>	<span class="mh">0x85</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGCCTRL2</span><span class="p">,</span>	<span class="mh">0x1f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC1VAL1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC1VAL2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC2VAL1</span><span class="p">,</span>	<span class="mh">0x6f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC2VAL2</span><span class="p">,</span>	<span class="mh">0x05</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC2PGA</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_OVF_RATE1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_OVF_RATE2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_GAIN_SRC1</span><span class="p">,</span>	<span class="mh">0xaa</span><span class="p">},</span><span class="cm">/* for xc5000; was 0x2b */</span>
	<span class="p">{</span><span class="n">R367TER_GAIN_SRC2</span><span class="p">,</span>	<span class="mh">0xd6</span><span class="p">},</span><span class="cm">/* for xc5000; was 0x04 */</span>
	<span class="p">{</span><span class="n">R367TER_INC_DEROT1</span><span class="p">,</span>	<span class="mh">0x55</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_INC_DEROT2</span><span class="p">,</span>	<span class="mh">0x55</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PPM_CPAMP_DIR</span><span class="p">,</span>	<span class="mh">0x2c</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PPM_CPAMP_INV</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FREESTFE_1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FREESTFE_2</span><span class="p">,</span>	<span class="mh">0x1c</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DCOFFSET</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_EN_PROCESS</span><span class="p">,</span>	<span class="mh">0x05</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SDI_SMOOTHER</span><span class="p">,</span>	<span class="mh">0x80</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FE_LOOP_OPEN</span><span class="p">,</span>	<span class="mh">0x1c</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FREQOFF1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FREQOFF2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FREQOFF3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TIMOFF1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TIMOFF2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_EPQ</span><span class="p">,</span>		<span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_EPQAUTO</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_UPDATE</span><span class="p">,</span>	<span class="mh">0xf5</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CHPFREE</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PPM_STATE_MAC</span><span class="p">,</span>	<span class="mh">0x23</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_INR_THRESHOLD</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_EPQ_TPS_ID_CELL</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_EPQ_CFG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_EPQ_STATUS</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AUTORELOCK</span><span class="p">,</span>	<span class="mh">0x81</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_BER_THR_VMSB</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_BER_THR_MSB</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_BER_THR_LSB</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CCD</span><span class="p">,</span>		<span class="mh">0x83</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SPECTR_CFG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CHC_DUMMY</span><span class="p">,</span>	<span class="mh">0x18</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_INC_CTL</span><span class="p">,</span>	<span class="mh">0x88</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_INCTHRES_COR1</span><span class="p">,</span>	<span class="mh">0xb4</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_INCTHRES_COR2</span><span class="p">,</span>	<span class="mh">0x96</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_INCTHRES_DET1</span><span class="p">,</span>	<span class="mh">0x0e</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_INCTHRES_DET2</span><span class="p">,</span>	<span class="mh">0x11</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_IIR_CELLNB</span><span class="p">,</span>	<span class="mh">0x8d</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_IIRCX_COEFF1_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_IIRCX_COEFF1_LSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_IIRCX_COEFF2_MSB</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_IIRCX_COEFF2_LSB</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_IIRCX_COEFF3_MSB</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_IIRCX_COEFF3_LSB</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_IIRCX_COEFF4_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_IIRCX_COEFF4_LSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_IIRCX_COEFF5_MSB</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_IIRCX_COEFF5_LSB</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FEPATH_CFG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PMC1_FUNC</span><span class="p">,</span>	<span class="mh">0x65</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PMC1_FOR</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PMC2_FUNC</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_STATUS_ERR_DA</span><span class="p">,</span>	<span class="mh">0xe0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DIG_AGC_R</span><span class="p">,</span>	<span class="mh">0xfe</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_COMAGC_TARMSB</span><span class="p">,</span>	<span class="mh">0x0b</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_COM_AGC_TAR_ENMODE</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_COM_AGC_CFG</span><span class="p">,</span>	<span class="mh">0x3e</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_COM_AGC_GAIN1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AUT_AGC_TARGETMSB</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_LOCK_DET_MSB</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGCTAR_LOCK_LSBS</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AUT_GAIN_EN</span><span class="p">,</span>	<span class="mh">0xf4</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AUT_CFG</span><span class="p">,</span>	<span class="mh">0xf0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_LOCKN</span><span class="p">,</span>		<span class="mh">0x23</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_INT_X_3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_INT_X_2</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_INT_X_1</span><span class="p">,</span>	<span class="mh">0x8d</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_INT_X_0</span><span class="p">,</span>	<span class="mh">0xa0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_MIN_ERRX_MSB</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_COR_CTL</span><span class="p">,</span>	<span class="mh">0x23</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_COR_STAT</span><span class="p">,</span>	<span class="mh">0xf6</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_COR_INTEN</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_COR_INTSTAT</span><span class="p">,</span>	<span class="mh">0x3f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_COR_MODEGUARD</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC_CTL</span><span class="p">,</span>	<span class="mh">0x08</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC_MANUAL1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC_MANUAL2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC_TARG</span><span class="p">,</span>	<span class="mh">0x16</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC_GAIN1</span><span class="p">,</span>	<span class="mh">0x53</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_AGC_GAIN2</span><span class="p">,</span>	<span class="mh">0x1d</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RESERVED_1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RESERVED_2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RESERVED_3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CAS_CTL</span><span class="p">,</span>	<span class="mh">0x44</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CAS_FREQ</span><span class="p">,</span>	<span class="mh">0xb3</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CAS_DAGCGAIN</span><span class="p">,</span>	<span class="mh">0x12</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_CTL</span><span class="p">,</span>	<span class="mh">0x04</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_STAT</span><span class="p">,</span>	<span class="mh">0x10</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_NCO1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_NCO2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_OFFSET1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_OFFSET2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FFT_CTL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SCR_CTL</span><span class="p">,</span>	<span class="mh">0x70</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PPM_CTL1</span><span class="p">,</span>	<span class="mh">0xf8</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TRL_CTL</span><span class="p">,</span>	<span class="mh">0x14</span><span class="p">},</span><span class="cm">/* for xc5000; was 0xac */</span>
	<span class="p">{</span><span class="n">R367TER_TRL_NOMRATE1</span><span class="p">,</span>	<span class="mh">0xae</span><span class="p">},</span><span class="cm">/* for xc5000; was 0x1e */</span>
	<span class="p">{</span><span class="n">R367TER_TRL_NOMRATE2</span><span class="p">,</span>	<span class="mh">0x56</span><span class="p">},</span><span class="cm">/* for xc5000; was 0x58 */</span>
	<span class="p">{</span><span class="n">R367TER_TRL_TIME1</span><span class="p">,</span>	<span class="mh">0x1d</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TRL_TIME2</span><span class="p">,</span>	<span class="mh">0xfc</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CRL_CTL</span><span class="p">,</span>	<span class="mh">0x24</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CRL_FREQ1</span><span class="p">,</span>	<span class="mh">0xad</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CRL_FREQ2</span><span class="p">,</span>	<span class="mh">0x9d</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CRL_FREQ3</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CHC_CTL</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CHC_SNR</span><span class="p">,</span>	<span class="mh">0xf0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_BDI_CTL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DMP_CTL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TPS_RCVD1</span><span class="p">,</span>	<span class="mh">0x30</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TPS_RCVD2</span><span class="p">,</span>	<span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TPS_RCVD3</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TPS_RCVD4</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TPS_ID_CELL1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TPS_ID_CELL2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TPS_RCVD5_SET1</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TPS_SET2</span><span class="p">,</span>	<span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TPS_SET3</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TPS_CTL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CTL_FFTOSNUM</span><span class="p">,</span>	<span class="mh">0x34</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TESTSELECT</span><span class="p">,</span>	<span class="mh">0x09</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_MSC_REV</span><span class="p">,</span>	<span class="mh">0x0a</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PIR_CTL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SNR_CARRIER1</span><span class="p">,</span>	<span class="mh">0xa1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SNR_CARRIER2</span><span class="p">,</span>	<span class="mh">0x9a</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PPM_CPAMP</span><span class="p">,</span>	<span class="mh">0x2c</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSM_AP0</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSM_AP1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSM_AP2</span> <span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSM_AP3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSM_AP4</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSM_AP5</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSM_AP6</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSM_AP7</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTRES</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ANACTRL</span><span class="p">,</span>	<span class="mh">0x0D</span><span class="p">},</span><span class="cm">/* PLL stoped, restart at init!!! */</span>
	<span class="p">{</span><span class="n">R367TER_TSTBUS</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTRATE</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CONSTMODE</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CONSTCARR1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CONSTCARR2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ICONSTEL</span><span class="p">,</span>	<span class="mh">0x0a</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_QCONSTEL</span><span class="p">,</span>	<span class="mh">0x15</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTBISTRES0</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTBISTRES1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTBISTRES2</span><span class="p">,</span>	<span class="mh">0x28</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTBISTRES3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RF_AGC1</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RF_AGC2</span><span class="p">,</span>	<span class="mh">0x83</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ANADIGCTRL</span><span class="p">,</span>	<span class="mh">0x19</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PLLMDIV</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span><span class="cm">/* for xc5000; was 0x0c */</span>
	<span class="p">{</span><span class="n">R367TER_PLLNDIV</span><span class="p">,</span>	<span class="mh">0x06</span><span class="p">},</span><span class="cm">/* for xc5000; was 0x55 */</span>
	<span class="p">{</span><span class="n">R367TER_PLLSETUP</span><span class="p">,</span>	<span class="mh">0x18</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DUAL_AD12</span><span class="p">,</span>	<span class="mh">0x0C</span><span class="p">},</span><span class="cm">/* for xc5000 AGC voltage 1.6V */</span>
	<span class="p">{</span><span class="n">R367TER_TSTBIST</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PAD_COMP_CTRL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PAD_COMP_WR</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PAD_COMP_RD</span><span class="p">,</span>	<span class="mh">0xe0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_TARGET_FFTADJT_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_TARGET_FFTADJT_LSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_TARGET_CHCADJT_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_TARGET_CHCADJT_LSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_FLAG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CRL_TARGET1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CRL_TARGET2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CRL_TARGET3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CRL_TARGET4</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CRL_FLAG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TRL_TARGET1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TRL_TARGET2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TRL_CHC</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_CHC_SNR_TARG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TOP_TRACK</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TRACKER_FREE1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ERROR_CRL1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ERROR_CRL2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ERROR_CRL3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ERROR_CRL4</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEC_NCO1</span><span class="p">,</span>	<span class="mh">0x2c</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEC_NCO2</span><span class="p">,</span>	<span class="mh">0x0f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEC_NCO3</span><span class="p">,</span>	<span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SNR</span><span class="p">,</span>		<span class="mh">0xf1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_FFTADJ1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_FFTADJ2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_CHCADJ1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_CHCADJ2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYR_OFF</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PPM_OFFSET1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PPM_OFFSET2</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TRACKER_FREE2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT10</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT11</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT12</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT13</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT14</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT15</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT16</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT17</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT18</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT19</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT1A</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT1B</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT1C</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT1D</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT1E</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBG_LT1F</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCCFGH</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCCFGM</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCCFGL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCINSDELH</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCINSDELM</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCINSDELL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCSTATUS</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCSPEED</span><span class="p">,</span>	<span class="mh">0x6f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCDEBUGM</span><span class="p">,</span>	<span class="mh">0xe7</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCDEBUGL</span><span class="p">,</span>	<span class="mh">0x9b</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCOBSCFG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCOBSM</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCOBSL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFECSPY</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYCFG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYDATA</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYOUT</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSTATUS</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFGOODPACK</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFPACKCNT</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYMISC</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFBERCPT4</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFBERCPT3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFBERCPT2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFBERCPT1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFBERCPT0</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFBERERR2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFBERERR1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFBERERR0</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSTATESM</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSTATESL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYBER</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYDISTM</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYDISTL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYOBS7</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYOBS6</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYOBS5</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYOBS4</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYOBS3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYOBS2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYOBS1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RCFSPYOBS0</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSGENERAL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_RC1SPEED</span><span class="p">,</span>	<span class="mh">0x6f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSGSTATUS</span><span class="p">,</span>	<span class="mh">0x18</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FECM</span><span class="p">,</span>		<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_VTH12</span><span class="p">,</span>		<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_VTH23</span><span class="p">,</span>		<span class="mh">0xa1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_VTH34</span><span class="p">,</span>		<span class="mh">0x64</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_VTH56</span><span class="p">,</span>		<span class="mh">0x40</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_VTH67</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_VTH78</span><span class="p">,</span>		<span class="mh">0x2c</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_VITCURPUN</span><span class="p">,</span>	<span class="mh">0x12</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_VERROR</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_PRVIT</span><span class="p">,</span>		<span class="mh">0x3f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_VAVSRVIT</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_VSTATUSVIT</span><span class="p">,</span>	<span class="mh">0xbd</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_VTHINUSE</span><span class="p">,</span>	<span class="mh">0xa1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_KDIV12</span><span class="p">,</span>	<span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_KDIV23</span><span class="p">,</span>	<span class="mh">0x40</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_KDIV34</span><span class="p">,</span>	<span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_KDIV56</span><span class="p">,</span>	<span class="mh">0x30</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_KDIV67</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_KDIV78</span><span class="p">,</span>	<span class="mh">0x30</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SIGPOWER</span><span class="p">,</span>	<span class="mh">0x54</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEMAPVIT</span><span class="p">,</span>	<span class="mh">0x40</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_VITSCALE</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FFEC1PRG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FVITCURPUN</span><span class="p">,</span>	<span class="mh">0x12</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FVERROR</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FVSTATUSVIT</span><span class="p">,</span>	<span class="mh">0xbd</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBUG_LT1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBUG_LT2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBUG_LT3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTSFMET</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SELOUT</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSYNC</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTERR</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSFSYNC</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTSFERR</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTTSSF1</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTTSSF2</span><span class="p">,</span>	<span class="mh">0x1f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTTSSF3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTTS1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTTS2</span><span class="p">,</span>	<span class="mh">0x1f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTTS3</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTTS4</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTTSRC</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSTTSRS</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSSTATEM</span><span class="p">,</span>	<span class="mh">0xb0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSSTATEL</span><span class="p">,</span>	<span class="mh">0x40</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSCFGH</span><span class="p">,</span>	<span class="mh">0xC0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSCFGM</span><span class="p">,</span>	<span class="mh">0xc0</span><span class="p">},</span><span class="cm">/* for xc5000; was 0x00 */</span>
	<span class="p">{</span><span class="n">R367TER_TSCFGL</span><span class="p">,</span>	<span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSSYNC</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSINSDELH</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSINSDELM</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSINSDELL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDIVN</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDIVPM</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDIVPL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDIVQM</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDIVQL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDILSTKM</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDILSTKL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSSPEED</span><span class="p">,</span>	<span class="mh">0x40</span><span class="p">},</span><span class="cm">/* for xc5000; was 0x6f */</span>
	<span class="p">{</span><span class="n">R367TER_TSSTATUS</span><span class="p">,</span>	<span class="mh">0x81</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSSTATUS2</span><span class="p">,</span>	<span class="mh">0x6a</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSBITRATEM</span><span class="p">,</span>	<span class="mh">0x0f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSBITRATEL</span><span class="p">,</span>	<span class="mh">0xc6</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSPACKLENM</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSPACKLENL</span><span class="p">,</span>	<span class="mh">0xfc</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSBLOCLENM</span><span class="p">,</span>	<span class="mh">0x0a</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSBLOCLENL</span><span class="p">,</span>	<span class="mh">0x80</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDLYH</span><span class="p">,</span>	<span class="mh">0x90</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDLYM</span><span class="p">,</span>	<span class="mh">0x68</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDLYL</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSNPDAV</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSBUFSTATH</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSBUFSTATM</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSBUFSTATL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDEBUGM</span><span class="p">,</span>	<span class="mh">0xcf</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDEBUGL</span><span class="p">,</span>	<span class="mh">0x1e</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDLYSETH</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDLYSETM</span><span class="p">,</span>	<span class="mh">0x68</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSDLYSETL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSOBSCFG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSOBSM</span><span class="p">,</span>	<span class="mh">0x47</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_TSOBSL</span><span class="p">,</span>	<span class="mh">0x1f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ERRCTRL1</span><span class="p">,</span>	<span class="mh">0x95</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ERRCNT1H</span><span class="p">,</span>	<span class="mh">0x80</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ERRCNT1M</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ERRCNT1L</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ERRCTRL2</span><span class="p">,</span>	<span class="mh">0x95</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ERRCNT2H</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ERRCNT2M</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_ERRCNT2L</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FECSPY</span><span class="p">,</span>	<span class="mh">0x88</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYCFG</span><span class="p">,</span>	<span class="mh">0x2c</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYDATA</span><span class="p">,</span>	<span class="mh">0x3a</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYOUT</span><span class="p">,</span>	<span class="mh">0x06</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSTATUS</span><span class="p">,</span>	<span class="mh">0x61</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FGOODPACK</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FPACKCNT</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYMISC</span><span class="p">,</span>	<span class="mh">0x66</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FBERCPT4</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FBERCPT3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FBERCPT2</span><span class="p">,</span>	<span class="mh">0x36</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FBERCPT1</span><span class="p">,</span>	<span class="mh">0x36</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FBERCPT0</span><span class="p">,</span>	<span class="mh">0x14</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FBERERR2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FBERERR1</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FBERERR0</span><span class="p">,</span>	<span class="mh">0x28</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSTATESM</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSTATESL</span><span class="p">,</span>	<span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYBER</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYDISTM</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYDISTL</span><span class="p">,</span>	<span class="mh">0x9f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYOBS7</span><span class="p">,</span>	<span class="mh">0xc9</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYOBS6</span><span class="p">,</span>	<span class="mh">0x99</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYOBS5</span><span class="p">,</span>	<span class="mh">0x08</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYOBS4</span><span class="p">,</span>	<span class="mh">0xec</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYOBS3</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYOBS2</span><span class="p">,</span>	<span class="mh">0x0f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYOBS1</span><span class="p">,</span>	<span class="mh">0xf5</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_FSPYOBS0</span><span class="p">,</span>	<span class="mh">0x08</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFDEMAP</span><span class="p">,</span>	<span class="mh">0x40</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFERROR</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFAVSR</span><span class="p">,</span>	<span class="mh">0x30</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFECSTATUS</span><span class="p">,</span>	<span class="mh">0xcc</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFKDIV12</span><span class="p">,</span>	<span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFKDIV23</span><span class="p">,</span>	<span class="mh">0x40</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFKDIV34</span><span class="p">,</span>	<span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFKDIV56</span><span class="p">,</span>	<span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFKDIV67</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFKDIV78</span><span class="p">,</span>	<span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFDILSTKM</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFDILSTKL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFSTATUS</span><span class="p">,</span>	<span class="mh">0xb5</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFDLYH</span><span class="p">,</span>	<span class="mh">0x90</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFDLYM</span><span class="p">,</span>	<span class="mh">0x60</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFDLYL</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFDLYSETH</span><span class="p">,</span>	<span class="mh">0xc0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFDLYSETM</span><span class="p">,</span>	<span class="mh">0x60</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFDLYSETL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFOBSCFG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFOBSM</span><span class="p">,</span>	<span class="mh">0x47</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFOBSL</span><span class="p">,</span>	<span class="mh">0x05</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFECINFO</span><span class="p">,</span>	<span class="mh">0x40</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFERRCTRL</span><span class="p">,</span>	<span class="mh">0x74</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFERRCNTH</span><span class="p">,</span>	<span class="mh">0x80</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFERRCNTM</span> <span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SFERRCNTL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYMBRATEM</span><span class="p">,</span>	<span class="mh">0x2f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYMBRATEL</span><span class="p">,</span>	<span class="mh">0x50</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYMBSTATUS</span><span class="p">,</span>	<span class="mh">0x7f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYMBCFG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYMBFIFOM</span><span class="p">,</span>	<span class="mh">0xf4</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYMBFIFOL</span><span class="p">,</span>	<span class="mh">0x0d</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYMBOFFSM</span><span class="p">,</span>	<span class="mh">0xf0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_SYMBOFFSL</span><span class="p">,</span>	<span class="mh">0x2d</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBUG_LT4</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBUG_LT5</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBUG_LT6</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBUG_LT7</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBUG_LT8</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367TER_DEBUG_LT9</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define RF_LOOKUP_TABLE_SIZE  31</span>
<span class="cp">#define RF_LOOKUP_TABLE2_SIZE 16</span>
<span class="cm">/* RF Level (for RF AGC-&gt;AGC1) Lookup Table, depends on the board and tuner.*/</span>
<span class="n">s32</span> <span class="n">stv0367cab_RF_LookUp1</span><span class="p">[</span><span class="n">RF_LOOKUP_TABLE_SIZE</span><span class="p">][</span><span class="n">RF_LOOKUP_TABLE_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="cm">/*AGC1*/</span>
		<span class="mi">48</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span>
		<span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span>
		<span class="mi">76</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span><span class="cm">/*RF(dbm)*/</span>
		<span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span>
		<span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span>
		<span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="cm">/* RF Level (for IF AGC-&gt;AGC2) Lookup Table, depends on the board and tuner.*/</span>
<span class="n">s32</span> <span class="n">stv0367cab_RF_LookUp2</span><span class="p">[</span><span class="n">RF_LOOKUP_TABLE2_SIZE</span><span class="p">][</span><span class="n">RF_LOOKUP_TABLE2_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="cm">/*AGC2*/</span>
		<span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span>
		<span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span><span class="cm">/*RF(dbm)*/</span>
		<span class="mi">57</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span>
		<span class="mi">65</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">st_register</span> <span class="n">def0367cab</span><span class="p">[</span><span class="n">STV0367CAB_NBREGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">R367CAB_ID</span><span class="p">,</span>		<span class="mh">0x60</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_I2CRPT</span><span class="p">,</span>	<span class="mh">0xa0</span><span class="p">},</span>
	<span class="cm">/*{R367CAB_I2CRPT,	0x22},*/</span>
	<span class="p">{</span><span class="n">R367CAB_TOPCTRL</span><span class="p">,</span>	<span class="mh">0x10</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IOCFG0</span><span class="p">,</span>	<span class="mh">0x80</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_DAC0R</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IOCFG1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_DAC1R</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IOCFG2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_SDFR</span><span class="p">,</span>		<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AUX_CLK</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FREESYS1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FREESYS2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FREESYS3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_GPIO_CFG</span><span class="p">,</span>	<span class="mh">0x55</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_GPIO_CMD</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TSTRES</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_ANACTRL</span><span class="p">,</span>	<span class="mh">0x0d</span><span class="p">},</span><span class="cm">/* was 0x00 need to check - I.M.L.*/</span>
	<span class="p">{</span><span class="n">R367CAB_TSTBUS</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_RF_AGC1</span><span class="p">,</span>	<span class="mh">0xea</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_RF_AGC2</span><span class="p">,</span>	<span class="mh">0x82</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_ANADIGCTRL</span><span class="p">,</span>	<span class="mh">0x0b</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_PLLMDIV</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_PLLNDIV</span><span class="p">,</span>	<span class="mh">0x08</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_PLLSETUP</span><span class="p">,</span>	<span class="mh">0x18</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_DUAL_AD12</span><span class="p">,</span>	<span class="mh">0x0C</span><span class="p">},</span> <span class="cm">/* for xc5000 AGC voltage 1.6V */</span>
	<span class="p">{</span><span class="n">R367CAB_TSTBIST</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_CTRL_1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_CTRL_2</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IT_STATUS1</span><span class="p">,</span>	<span class="mh">0x2b</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IT_STATUS2</span><span class="p">,</span>	<span class="mh">0x08</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IT_EN1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IT_EN2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_CTRL_STATUS</span><span class="p">,</span>	<span class="mh">0x04</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TEST_CTL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_CTL</span><span class="p">,</span>	<span class="mh">0x73</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_IF_CFG</span><span class="p">,</span>	<span class="mh">0x50</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_RF_CFG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_PWM_CFG</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_PWR_REF_L</span><span class="p">,</span>	<span class="mh">0x5a</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_PWR_REF_H</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_RF_TH_L</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_RF_TH_H</span><span class="p">,</span>	<span class="mh">0x07</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_IF_LTH_L</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_IF_LTH_H</span><span class="p">,</span>	<span class="mh">0x08</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_IF_HTH_L</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_IF_HTH_H</span><span class="p">,</span>	<span class="mh">0x07</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_PWR_RD_L</span><span class="p">,</span>	<span class="mh">0xa0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_PWR_RD_M</span><span class="p">,</span>	<span class="mh">0xe9</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_PWR_RD_H</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_PWM_IFCMD_L</span><span class="p">,</span>	<span class="mh">0xe4</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_PWM_IFCMD_H</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_PWM_RFCMD_L</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_AGC_PWM_RFCMD_H</span><span class="p">,</span>	<span class="mh">0x07</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_CFG</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_MIX_NCO_LL</span><span class="p">,</span>	<span class="mh">0x22</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_MIX_NCO_HL</span><span class="p">,</span>	<span class="mh">0x96</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_MIX_NCO_HH</span><span class="p">,</span>	<span class="mh">0x55</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_SRC_NCO_LL</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_SRC_NCO_LH</span><span class="p">,</span>	<span class="mh">0x0c</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_SRC_NCO_HL</span><span class="p">,</span>	<span class="mh">0xf5</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_SRC_NCO_HH</span><span class="p">,</span>	<span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_GAIN_SRC_L</span><span class="p">,</span>	<span class="mh">0x06</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_GAIN_SRC_H</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_DCRM_CFG_LL</span><span class="p">,</span>	<span class="mh">0xfe</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_DCRM_CFG_LH</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_DCRM_CFG_HL</span><span class="p">,</span>	<span class="mh">0x0f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_DCRM_CFG_HH</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_ADJ_COEFF0</span><span class="p">,</span>	<span class="mh">0x34</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_ADJ_COEFF1</span><span class="p">,</span>	<span class="mh">0xae</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_ADJ_COEFF2</span><span class="p">,</span>	<span class="mh">0x46</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_ADJ_COEFF3</span><span class="p">,</span>	<span class="mh">0x77</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_ADJ_COEFF4</span><span class="p">,</span>	<span class="mh">0x96</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_ADJ_COEFF5</span><span class="p">,</span>	<span class="mh">0x69</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_ADJ_COEFF6</span><span class="p">,</span>	<span class="mh">0xc7</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_ADJ_COEFF7</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_ADJ_EN</span><span class="p">,</span>	<span class="mh">0x04</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQDEM_ADJ_AGC_REF</span><span class="p">,</span>	<span class="mh">0x94</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_ALLPASSFILT1</span><span class="p">,</span>	<span class="mh">0xc9</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_ALLPASSFILT2</span><span class="p">,</span>	<span class="mh">0x2d</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_ALLPASSFILT3</span><span class="p">,</span>	<span class="mh">0xa3</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_ALLPASSFILT4</span><span class="p">,</span>	<span class="mh">0xfb</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_ALLPASSFILT5</span><span class="p">,</span>	<span class="mh">0xf6</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_ALLPASSFILT6</span><span class="p">,</span>	<span class="mh">0x45</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_ALLPASSFILT7</span><span class="p">,</span>	<span class="mh">0x6f</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_ALLPASSFILT8</span><span class="p">,</span>	<span class="mh">0x7e</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_ALLPASSFILT9</span><span class="p">,</span>	<span class="mh">0x05</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_ALLPASSFILT10</span><span class="p">,</span>	<span class="mh">0x0a</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_ALLPASSFILT11</span><span class="p">,</span>	<span class="mh">0x51</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TRL_AGC_CFG</span><span class="p">,</span>	<span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TRL_LPF_CFG</span><span class="p">,</span>	<span class="mh">0x28</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TRL_LPF_ACQ_GAIN</span><span class="p">,</span>	<span class="mh">0x44</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TRL_LPF_TRK_GAIN</span><span class="p">,</span>	<span class="mh">0x22</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TRL_LPF_OUT_GAIN</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TRL_LOCKDET_LTH</span><span class="p">,</span>	<span class="mh">0x04</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TRL_LOCKDET_HTH</span><span class="p">,</span>	<span class="mh">0x11</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TRL_LOCKDET_TRGVAL</span><span class="p">,</span>	<span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_IQ_QAM</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FSM_STATE</span><span class="p">,</span>	<span class="mh">0xa0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FSM_CTL</span><span class="p">,</span>	<span class="mh">0x08</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FSM_STS</span><span class="p">,</span>	<span class="mh">0x0c</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FSM_SNR0_HTH</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FSM_SNR1_HTH</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FSM_SNR2_HTH</span><span class="p">,</span>	<span class="mh">0x23</span><span class="p">},</span><span class="cm">/* 0x00 */</span>
	<span class="p">{</span><span class="n">R367CAB_FSM_SNR0_LTH</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FSM_SNR1_LTH</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FSM_EQA1_HTH</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FSM_TEMPO</span><span class="p">,</span>	<span class="mh">0x32</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FSM_CONFIG</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_I_TESTTAP_L</span><span class="p">,</span>	<span class="mh">0x11</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_I_TESTTAP_M</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_I_TESTTAP_H</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_TESTAP_CFG</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_Q_TESTTAP_L</span><span class="p">,</span>	<span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_Q_TESTTAP_M</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_Q_TESTTAP_H</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_TAP_CTRL</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_CTR_CRL_CONTROL_L</span><span class="p">,</span>	<span class="mh">0x11</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_CTR_CRL_CONTROL_H</span><span class="p">,</span>	<span class="mh">0x05</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_CTR_HIPOW_L</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_CTR_HIPOW_H</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_I_EQU_LO</span><span class="p">,</span>	<span class="mh">0xef</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_I_EQU_HI</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_Q_EQU_LO</span><span class="p">,</span>	<span class="mh">0xee</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_Q_EQU_HI</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_MAPPER</span><span class="p">,</span>	<span class="mh">0xc5</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_SWEEP_RATE</span><span class="p">,</span>	<span class="mh">0x80</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_SNR_LO</span><span class="p">,</span>	<span class="mh">0x64</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_SNR_HI</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_GAMMA_LO</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_GAMMA_HI</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_ERR_GAIN</span><span class="p">,</span>	<span class="mh">0x36</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_RADIUS</span><span class="p">,</span>	<span class="mh">0xaa</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_FFE_MAINTAP</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_FFE_LEAKAGE</span><span class="p">,</span>	<span class="mh">0x63</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_FFE_MAINTAP_POS</span><span class="p">,</span>	<span class="mh">0xdf</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_GAIN_WIDE</span><span class="p">,</span>	<span class="mh">0x88</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_GAIN_NARROW</span><span class="p">,</span>	<span class="mh">0x41</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_CTR_LPF_GAIN</span><span class="p">,</span>	<span class="mh">0xd1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_CRL_LPF_GAIN</span><span class="p">,</span>	<span class="mh">0xa7</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_GLOBAL_GAIN</span><span class="p">,</span>	<span class="mh">0x06</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_CRL_LD_SEN</span><span class="p">,</span>	<span class="mh">0x85</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_CRL_LD_VAL</span><span class="p">,</span>	<span class="mh">0xe2</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_CRL_TFR</span><span class="p">,</span>	<span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_CRL_BISTH_LO</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_CRL_BISTH_HI</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_SWEEP_RANGE_LO</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_SWEEP_RANGE_HI</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_CRL_LIMITER</span><span class="p">,</span>	<span class="mh">0x40</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_MODULUS_MAP</span><span class="p">,</span>	<span class="mh">0x90</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_EQU_PNT_GAIN</span><span class="p">,</span>	<span class="mh">0xa7</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FEC_AC_CTR_0</span><span class="p">,</span>	<span class="mh">0x16</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FEC_AC_CTR_1</span><span class="p">,</span>	<span class="mh">0x0b</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FEC_AC_CTR_2</span><span class="p">,</span>	<span class="mh">0x88</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FEC_AC_CTR_3</span><span class="p">,</span>	<span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_FEC_STATUS</span><span class="p">,</span>	<span class="mh">0x12</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_RS_COUNTER_0</span><span class="p">,</span>	<span class="mh">0x7d</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_RS_COUNTER_1</span><span class="p">,</span>	<span class="mh">0xd0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_RS_COUNTER_2</span><span class="p">,</span>	<span class="mh">0x19</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_RS_COUNTER_3</span><span class="p">,</span>	<span class="mh">0x0b</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_RS_COUNTER_4</span><span class="p">,</span>	<span class="mh">0xa3</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_RS_COUNTER_5</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_BERT_0</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_BERT_1</span><span class="p">,</span>	<span class="mh">0x25</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_BERT_2</span><span class="p">,</span>	<span class="mh">0x41</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_BERT_3</span><span class="p">,</span>	<span class="mh">0x39</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_OUTFORMAT_0</span><span class="p">,</span>	<span class="mh">0xc2</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_OUTFORMAT_1</span><span class="p">,</span>	<span class="mh">0x22</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_SMOOTHER_2</span><span class="p">,</span>	<span class="mh">0x28</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TSMF_CTRL_0</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TSMF_CTRL_1</span><span class="p">,</span>	<span class="mh">0xc6</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TSMF_CTRL_3</span><span class="p">,</span>	<span class="mh">0x43</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TS_ON_ID_0</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TS_ON_ID_1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TS_ON_ID_2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TS_ON_ID_3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_RE_STATUS_0</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_RE_STATUS_1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_RE_STATUS_2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_RE_STATUS_3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TS_STATUS_0</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TS_STATUS_1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TS_STATUS_2</span><span class="p">,</span>	<span class="mh">0xa0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_TS_STATUS_3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_T_O_ID_0</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_T_O_ID_1</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_T_O_ID_2</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="n">R367CAB_T_O_ID_3</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span>
<span class="kt">int</span> <span class="nf">stv0367_writeregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSB</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2cdebug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %02x: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: i2c write error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EREMOTEIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367_writereg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">stv0367_writeregs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">stv0367_readreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">b1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span>
		<span class="p">},</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">b0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSB</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">b0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: i2c read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2cdebug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %02x: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">b1</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">b1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">extract_mask_pos</span><span class="p">(</span><span class="n">u32</span> <span class="n">label</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">mask</span><span class="p">)</span> <span class="o">=</span> <span class="n">label</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">position</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv0367_writebits</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">label</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">extract_mask_pos</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">pos</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">))</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv0367_setbits</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">label</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">extract_mask_pos</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">pos</span><span class="p">);</span>

	<span class="p">(</span><span class="o">*</span><span class="n">reg</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">))</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">stv0367_readbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">label</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">extract_mask_pos</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">label</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">pos</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">stv0367_getbits</span><span class="p">(</span><span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">label</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">extract_mask_pos</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367ter_gate_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_I2CRPT</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stv0367_setbits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">F367TER_STOP_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_setbits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">F367TER_I2CT_ON</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stv0367_setbits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">F367TER_STOP_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0367_setbits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">F367TER_I2CT_ON</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_I2CRPT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv0367_get_tuner_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_ops</span>	<span class="o">*</span><span class="n">frontend_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_tuner_ops</span>	<span class="o">*</span><span class="n">tuner_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
		<span class="n">frontend_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">frontend_ops</span><span class="o">-&gt;</span><span class="n">tuner_ops</span><span class="p">)</span>
		<span class="n">tuner_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frontend_ops</span><span class="o">-&gt;</span><span class="n">tuner_ops</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tuner_ops</span><span class="o">-&gt;</span><span class="n">get_frequency</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tuner_ops</span><span class="o">-&gt;</span><span class="n">get_frequency</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: frequency=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">freq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">CellsCoeffs_8MHz_367cofdm</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">6</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">{</span><span class="mh">0x10EF</span><span class="p">,</span> <span class="mh">0xE205</span><span class="p">,</span> <span class="mh">0x10EF</span><span class="p">,</span> <span class="mh">0xCE49</span><span class="p">,</span> <span class="mh">0x6DA7</span><span class="p">},</span> <span class="cm">/* CELL 1 COEFFS 27M*/</span>
		<span class="p">{</span><span class="mh">0x2151</span><span class="p">,</span> <span class="mh">0xc557</span><span class="p">,</span> <span class="mh">0x2151</span><span class="p">,</span> <span class="mh">0xc705</span><span class="p">,</span> <span class="mh">0x6f93</span><span class="p">},</span> <span class="cm">/* CELL 2 COEFFS */</span>
		<span class="p">{</span><span class="mh">0x2503</span><span class="p">,</span> <span class="mh">0xc000</span><span class="p">,</span> <span class="mh">0x2503</span><span class="p">,</span> <span class="mh">0xc375</span><span class="p">,</span> <span class="mh">0x7194</span><span class="p">},</span> <span class="cm">/* CELL 3 COEFFS */</span>
		<span class="p">{</span><span class="mh">0x20E9</span><span class="p">,</span> <span class="mh">0xca94</span><span class="p">,</span> <span class="mh">0x20e9</span><span class="p">,</span> <span class="mh">0xc153</span><span class="p">,</span> <span class="mh">0x7194</span><span class="p">},</span> <span class="cm">/* CELL 4 COEFFS */</span>
		<span class="p">{</span><span class="mh">0x06EF</span><span class="p">,</span> <span class="mh">0xF852</span><span class="p">,</span> <span class="mh">0x06EF</span><span class="p">,</span> <span class="mh">0xC057</span><span class="p">,</span> <span class="mh">0x7207</span><span class="p">},</span> <span class="cm">/* CELL 5 COEFFS */</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0ECC</span><span class="p">,</span> <span class="mh">0x0ECC</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x3647</span><span class="p">}</span> <span class="cm">/* CELL 6 COEFFS */</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x10A0</span><span class="p">,</span> <span class="mh">0xE2AF</span><span class="p">,</span> <span class="mh">0x10A1</span><span class="p">,</span> <span class="mh">0xCE76</span><span class="p">,</span> <span class="mh">0x6D6D</span><span class="p">},</span> <span class="cm">/* CELL 1 COEFFS 25M*/</span>
		<span class="p">{</span><span class="mh">0x20DC</span><span class="p">,</span> <span class="mh">0xC676</span><span class="p">,</span> <span class="mh">0x20D9</span><span class="p">,</span> <span class="mh">0xC80A</span><span class="p">,</span> <span class="mh">0x6F29</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x2532</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x251D</span><span class="p">,</span> <span class="mh">0xC391</span><span class="p">,</span> <span class="mh">0x706F</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x1F7A</span><span class="p">,</span> <span class="mh">0xCD2B</span><span class="p">,</span> <span class="mh">0x2032</span><span class="p">,</span> <span class="mh">0xC15E</span><span class="p">,</span> <span class="mh">0x711F</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0698</span><span class="p">,</span> <span class="mh">0xFA5E</span><span class="p">,</span> <span class="mh">0x0568</span><span class="p">,</span> <span class="mh">0xC059</span><span class="p">,</span> <span class="mh">0x7193</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0918</span><span class="p">,</span> <span class="mh">0x149C</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x3642</span><span class="p">}</span> <span class="cm">/* CELL 6 COEFFS */</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span> <span class="cm">/* 30M */</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">CellsCoeffs_7MHz_367cofdm</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">6</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">{</span><span class="mh">0x12CA</span><span class="p">,</span> <span class="mh">0xDDAF</span><span class="p">,</span> <span class="mh">0x12CA</span><span class="p">,</span> <span class="mh">0xCCEB</span><span class="p">,</span> <span class="mh">0x6FB1</span><span class="p">},</span> <span class="cm">/* CELL 1 COEFFS 27M*/</span>
		<span class="p">{</span><span class="mh">0x2329</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x2329</span><span class="p">,</span> <span class="mh">0xC6B0</span><span class="p">,</span> <span class="mh">0x725F</span><span class="p">},</span> <span class="cm">/* CELL 2 COEFFS */</span>
		<span class="p">{</span><span class="mh">0x2394</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x2394</span><span class="p">,</span> <span class="mh">0xC2C7</span><span class="p">,</span> <span class="mh">0x7410</span><span class="p">},</span> <span class="cm">/* CELL 3 COEFFS */</span>
		<span class="p">{</span><span class="mh">0x251C</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x251C</span><span class="p">,</span> <span class="mh">0xC103</span><span class="p">,</span> <span class="mh">0x74D9</span><span class="p">},</span> <span class="cm">/* CELL 4 COEFFS */</span>
		<span class="p">{</span><span class="mh">0x0804</span><span class="p">,</span> <span class="mh">0xF546</span><span class="p">,</span> <span class="mh">0x0804</span><span class="p">,</span> <span class="mh">0xC040</span><span class="p">,</span> <span class="mh">0x7544</span><span class="p">},</span> <span class="cm">/* CELL 5 COEFFS */</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0CD9</span><span class="p">,</span> <span class="mh">0x0CD9</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x370A</span><span class="p">}</span> <span class="cm">/* CELL 6 COEFFS */</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x1285</span><span class="p">,</span> <span class="mh">0xDE47</span><span class="p">,</span> <span class="mh">0x1285</span><span class="p">,</span> <span class="mh">0xCD17</span><span class="p">,</span> <span class="mh">0x6F76</span><span class="p">},</span> <span class="cm">/*25M*/</span>
		<span class="p">{</span><span class="mh">0x234C</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x2348</span><span class="p">,</span> <span class="mh">0xC6DA</span><span class="p">,</span> <span class="mh">0x7206</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x23B4</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x23AC</span><span class="p">,</span> <span class="mh">0xC2DB</span><span class="p">,</span> <span class="mh">0x73B3</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x253D</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x25B6</span><span class="p">,</span> <span class="mh">0xC10B</span><span class="p">,</span> <span class="mh">0x747F</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0721</span><span class="p">,</span> <span class="mh">0xF79C</span><span class="p">,</span> <span class="mh">0x065F</span><span class="p">,</span> <span class="mh">0xC041</span><span class="p">,</span> <span class="mh">0x74EB</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x08FA</span><span class="p">,</span> <span class="mh">0x1162</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x36FF</span><span class="p">}</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span> <span class="cm">/* 30M */</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">CellsCoeffs_6MHz_367cofdm</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">6</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">{</span><span class="mh">0x1699</span><span class="p">,</span> <span class="mh">0xD5B8</span><span class="p">,</span> <span class="mh">0x1699</span><span class="p">,</span> <span class="mh">0xCBC3</span><span class="p">,</span> <span class="mh">0x713B</span><span class="p">},</span> <span class="cm">/* CELL 1 COEFFS 27M*/</span>
		<span class="p">{</span><span class="mh">0x2245</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x2245</span><span class="p">,</span> <span class="mh">0xC568</span><span class="p">,</span> <span class="mh">0x74D5</span><span class="p">},</span> <span class="cm">/* CELL 2 COEFFS */</span>
		<span class="p">{</span><span class="mh">0x227F</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x227F</span><span class="p">,</span> <span class="mh">0xC1FC</span><span class="p">,</span> <span class="mh">0x76C6</span><span class="p">},</span> <span class="cm">/* CELL 3 COEFFS */</span>
		<span class="p">{</span><span class="mh">0x235E</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x235E</span><span class="p">,</span> <span class="mh">0xC0A7</span><span class="p">,</span> <span class="mh">0x778A</span><span class="p">},</span> <span class="cm">/* CELL 4 COEFFS */</span>
		<span class="p">{</span><span class="mh">0x0ECB</span><span class="p">,</span> <span class="mh">0xEA0B</span><span class="p">,</span> <span class="mh">0x0ECB</span><span class="p">,</span> <span class="mh">0xC027</span><span class="p">,</span> <span class="mh">0x77DD</span><span class="p">},</span> <span class="cm">/* CELL 5 COEFFS */</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0B68</span><span class="p">,</span> <span class="mh">0x0B68</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0xC89A</span><span class="p">},</span> <span class="cm">/* CELL 6 COEFFS */</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x1655</span><span class="p">,</span> <span class="mh">0xD64E</span><span class="p">,</span> <span class="mh">0x1658</span><span class="p">,</span> <span class="mh">0xCBEF</span><span class="p">,</span> <span class="mh">0x70FE</span><span class="p">},</span> <span class="cm">/*25M*/</span>
		<span class="p">{</span><span class="mh">0x225E</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x2256</span><span class="p">,</span> <span class="mh">0xC589</span><span class="p">,</span> <span class="mh">0x7489</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x2293</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x2295</span><span class="p">,</span> <span class="mh">0xC209</span><span class="p">,</span> <span class="mh">0x767E</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x2377</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0x23AA</span><span class="p">,</span> <span class="mh">0xC0AB</span><span class="p">,</span> <span class="mh">0x7746</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0DC7</span><span class="p">,</span> <span class="mh">0xEBC8</span><span class="p">,</span> <span class="mh">0x0D07</span><span class="p">,</span> <span class="mh">0xC027</span><span class="p">,</span> <span class="mh">0x7799</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0888</span><span class="p">,</span> <span class="mh">0x0E9C</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x3757</span><span class="p">}</span>

	<span class="p">},</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span> <span class="cm">/* 30M */</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv0367ter_get_mclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ExtClk_Hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mclk_Hz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* master clock frequency (Hz) */</span>
	<span class="n">u32</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_BYPASS_PLLXN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_PLL_NDIV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_PLL_MDIV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_PLL_PDIV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

		<span class="n">mclk_Hz</span> <span class="o">=</span> <span class="p">((</span><span class="n">ExtClk_Hz</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">p</span><span class="p">));</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;N=%d M=%d P=%d mclk_Hz=%d ExtClk_Hz=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mclk_Hz</span><span class="p">,</span> <span class="n">ExtClk_Hz</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mclk_Hz</span> <span class="o">=</span> <span class="n">ExtClk_Hz</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: mclk_Hz=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mclk_Hz</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mclk_Hz</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367ter_filt_coeff_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">CellsCoeffs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">6</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="n">u32</span> <span class="n">DemodXtal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">freq</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">stv0367ter_get_mclk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DemodXtal</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">==</span> <span class="mi">53125000</span><span class="p">)</span>
		<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* equivalent to Xtal 25M on 362*/</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">==</span> <span class="mi">54000000</span><span class="p">)</span>
		<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* equivalent to Xtal 27M on 362*/</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">==</span> <span class="mi">52500000</span><span class="p">)</span>
		<span class="n">k</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* equivalent to Xtal 30M on 362*/</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_IIR_CELL_NB</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
				<span class="p">(</span><span class="n">R367TER_IIRCX_COEFF1_MSB</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
				<span class="n">MSB</span><span class="p">(</span><span class="n">CellsCoeffs</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]));</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
				<span class="p">(</span><span class="n">R367TER_IIRCX_COEFF1_LSB</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
				<span class="n">LSB</span><span class="p">(</span><span class="n">CellsCoeffs</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv0367ter_agc_iir_lock_detect_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LOCK_DETECT_LSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Lock detect 1 */</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LOCK_DETECT_CHOICE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LOCK_DETECT_MSB</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_AUT_AGC_TARGET_LSB</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>

	<span class="cm">/* Lock detect 2 */</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LOCK_DETECT_CHOICE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LOCK_DETECT_MSB</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_AUT_AGC_TARGET_LSB</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>

	<span class="cm">/* Lock detect 3 */</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LOCK_DETECT_CHOICE</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LOCK_DETECT_MSB</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_AUT_AGC_TARGET_LSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Lock detect 4 */</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LOCK_DETECT_CHOICE</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LOCK_DETECT_MSB</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_AUT_AGC_TARGET_LSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367_iir_filt_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">Bandwidth</span><span class="p">,</span>
							<span class="n">u32</span> <span class="n">DemodXtalValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_NRST_IIR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">Bandwidth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stv0367ter_filt_coeff_init</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
				<span class="n">CellsCoeffs_6MHz_367cofdm</span><span class="p">,</span>
				<span class="n">DemodXtalValue</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stv0367ter_filt_coeff_init</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
				<span class="n">CellsCoeffs_7MHz_367cofdm</span><span class="p">,</span>
				<span class="n">DemodXtalValue</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stv0367ter_filt_coeff_init</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
				<span class="n">CellsCoeffs_8MHz_367cofdm</span><span class="p">,</span>
				<span class="n">DemodXtalValue</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_NRST_IIR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv0367ter_agc_iir_rst</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u8</span> <span class="n">com_n</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">com_n</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_COM_N</span><span class="p">);</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_COM_N</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_COM_SOFT_RSTN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_COM_AGC_ON</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_COM_SOFT_RSTN</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_COM_AGC_ON</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_COM_N</span><span class="p">,</span> <span class="n">com_n</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367ter_duration</span><span class="p">(</span><span class="n">s32</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tempo1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tempo2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tempo3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">local_tempo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">local_tempo</span> <span class="o">=</span> <span class="n">tempo1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">local_tempo</span> <span class="o">=</span> <span class="n">tempo2</span><span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">local_tempo</span> <span class="o">=</span> <span class="n">tempo3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*	msleep(local_tempo);  */</span>
	<span class="k">return</span> <span class="n">local_tempo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span>
<span class="n">stv0367_ter_signal_type</span> <span class="nf">stv0367ter_check_syr</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wd</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="n">SYR_var</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">SYRStatus</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">SYR_var</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SYR_LOCK</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">SYR_var</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span>
		<span class="n">wd</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">SYR_var</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SYR_LOCK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SYR_var</span><span class="p">)</span>
		<span class="n">SYRStatus</span> <span class="o">=</span> <span class="n">FE_TER_NOSYMBOL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">SYRStatus</span> <span class="o">=</span>  <span class="n">FE_TER_SYMBOLOK</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;stv0367ter_check_syr SYRStatus %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">SYR_var</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;No Symbol&quot;</span> <span class="o">:</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SYRStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span>
<span class="n">stv0367_ter_signal_type</span> <span class="nf">stv0367ter_check_cpamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
								<span class="n">s32</span> <span class="n">FFTmode</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">s32</span>  <span class="n">CPAMPvalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CPAMPStatus</span><span class="p">,</span> <span class="n">CPAMPMin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">FFTmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/*2k mode*/</span>
		<span class="n">CPAMPMin</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">wd</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/*8k mode*/</span>
		<span class="n">CPAMPMin</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
		<span class="n">wd</span> <span class="o">=</span> <span class="mi">55</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/*4k mode*/</span>
		<span class="n">CPAMPMin</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="n">wd</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">CPAMPMin</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>  <span class="cm">/*drives to NOCPAMP	*/</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: CPAMPMin=%d wd=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">CPAMPMin</span><span class="p">,</span> <span class="n">wd</span><span class="p">);</span>

	<span class="n">CPAMPvalue</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_PPM_CPAMP_DIRECT</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">CPAMPvalue</span> <span class="o">&lt;</span> <span class="n">CPAMPMin</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
		<span class="n">wd</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">CPAMPvalue</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_PPM_CPAMP_DIRECT</span><span class="p">);</span>
		<span class="cm">/*dprintk(&quot;CPAMPvalue= %d at wd=%d\n&quot;,CPAMPvalue,wd); */</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;******last CPAMPvalue= %d at wd=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CPAMPvalue</span><span class="p">,</span> <span class="n">wd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CPAMPvalue</span> <span class="o">&lt;</span> <span class="n">CPAMPMin</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CPAMPStatus</span> <span class="o">=</span> <span class="n">FE_TER_NOCPAMP</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CPAMP failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CPAMP OK !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">CPAMPStatus</span> <span class="o">=</span> <span class="n">FE_TER_CPAMPOK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">CPAMPStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span>
<span class="n">stv0367_ter_signal_type</span> <span class="nf">stv0367ter_lock_algo</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">stv0367_ter_signal_type</span> <span class="n">ret_flag</span><span class="p">;</span>
	<span class="kt">short</span> <span class="kt">int</span> <span class="n">wd</span><span class="p">,</span> <span class="n">tempo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">try</span><span class="p">,</span> <span class="n">u_var1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u_var2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u_var3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u_var4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">guard</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FE_TER_SWNOK</span><span class="p">;</span>

	<span class="n">try</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret_flag</span> <span class="o">=</span> <span class="n">FE_TER_LOCKOK</span><span class="p">;</span>

		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_CORE_ACTIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_iq_mode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_COM_N</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>

		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_GUARD</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span><span class="cm">/* suggest 2k 1/4 */</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SYR_TR_DIS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>

		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_CORE_ACTIVE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">stv0367ter_check_syr</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">FE_TER_NOSYMBOL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">FE_TER_NOSYMBOL</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span> <span class="cm">/*</span>
<span class="cm">			if chip locked on wrong mode first try,</span>
<span class="cm">			it must lock correctly second try */</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SYR_MODE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stv0367ter_check_cpamp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="o">==</span>
							<span class="n">FE_TER_NOCPAMP</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">try</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">ret_flag</span> <span class="o">=</span> <span class="n">FE_TER_NOCPAMP</span><span class="p">;</span>

			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">try</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">try</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret_flag</span> <span class="o">!=</span> <span class="n">FE_TER_LOCKOK</span><span class="p">));</span>

	<span class="n">tmp</span>  <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_SYR_STAT</span><span class="p">);</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_STATUS</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;state=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;LOCK OK! mode=%d SYR_STAT=0x%x R367TER_STATUS=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">mode</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">);</span>

	<span class="n">tmp</span>  <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_PRVIT</span><span class="p">);</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_I2CRPT</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;PRVIT=0x%x I2CRPT=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">);</span>

	<span class="n">tmp</span>  <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_GAIN_SRC1</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;GAIN_SRC1=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FE_TER_SWNOK</span><span class="p">;</span>

	<span class="cm">/*guard=stv0367_readbits(state,F367TER_SYR_GUARD); */</span>

	<span class="cm">/*suppress EPQ auto for SYR_GARD 1/16 or 1/32</span>
<span class="cm">	and set channel predictor in automatic */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	switch (guard) {</span>

<span class="c">	case 0:</span>
<span class="c">	case 1:</span>
<span class="c">		stv0367_writebits(state, F367TER_AUTO_LE_EN, 0);</span>
<span class="c">		stv0367_writereg(state, R367TER_CHC_CTL, 0x01);</span>
<span class="c">		break;</span>
<span class="c">	case 2:</span>
<span class="c">	case 3:</span>
<span class="c">		stv0367_writebits(state, F367TER_AUTO_LE_EN, 1);</span>
<span class="c">		stv0367_writereg(state, R367TER_CHC_CTL, 0x11);</span>
<span class="c">		break;</span>

<span class="c">	default:</span>
<span class="c">		return FE_TER_SWNOK;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="cm">/*reset fec an reedsolo FOR 367 only*/</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_RST_SFEC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_RST_REEDSOLO</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_RST_SFEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_RST_REEDSOLO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">u_var1</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LK</span><span class="p">);</span>
	<span class="n">u_var2</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_PRF</span><span class="p">);</span>
	<span class="n">u_var3</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TPS_LOCK</span><span class="p">);</span>
	<span class="cm">/*	u_var4=stv0367_readbits(state,F367TER_TSFIFO_LINEOK); */</span>

	<span class="n">wd</span> <span class="o">=</span> <span class="n">stv0367ter_duration</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
	<span class="n">tempo</span> <span class="o">=</span> <span class="n">stv0367ter_duration</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/*while ( ((!u_var1)||(!u_var2)||(!u_var3)||(!u_var4))  &amp;&amp; (wd&gt;=0)) */</span>
	<span class="k">while</span> <span class="p">(((</span><span class="o">!</span><span class="n">u_var1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">u_var2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">u_var3</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">tempo</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="n">tempo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">wd</span> <span class="o">-=</span> <span class="n">tempo</span><span class="p">;</span>
		<span class="n">u_var1</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LK</span><span class="p">);</span>
		<span class="n">u_var2</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_PRF</span><span class="p">);</span>
		<span class="n">u_var3</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TPS_LOCK</span><span class="p">);</span>
		<span class="cm">/*u_var4=stv0367_readbits(state, F367TER_TSFIFO_LINEOK); */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">u_var1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FE_TER_NOLOCK</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">u_var2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FE_TER_NOPRFOUND</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">u_var3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FE_TER_NOTPS</span><span class="p">;</span>

	<span class="n">guard</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SYR_GUARD</span><span class="p">);</span>
	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_CHC_CTL</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">guard</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_AUTO_LE_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/*stv0367_writereg(state,R367TER_CHC_CTL, 0x1);*/</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SYR_FILTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_AUTO_LE_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/*stv0367_writereg(state,R367TER_CHC_CTL, 0x11);*/</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SYR_FILTER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">FE_TER_SWNOK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* apply Sfec workaround if 8K 64QAM CR!=1/2*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TPS_CONST</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TPS_HPCODE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_SFDLYSETH</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_SFDLYSETM</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_SFDLYSETL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_SFDLYSETH</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">wd</span> <span class="o">=</span> <span class="n">stv0367ter_duration</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
	<span class="n">u_var4</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TSFIFO_LINEOK</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">u_var4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">tempo</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="n">tempo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">wd</span> <span class="o">-=</span> <span class="n">tempo</span><span class="p">;</span>
		<span class="n">u_var4</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TSFIFO_LINEOK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">u_var4</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FE_TER_NOLOCK</span><span class="p">;</span>

	<span class="cm">/* for 367 leave COM_N at 0x7 for IQ_mode*/</span>
	<span class="cm">/*if(ter_state-&gt;if_iq_mode!=FE_TER_NORMAL_IF_TUNER) {</span>
<span class="cm">		tempo=0;</span>
<span class="cm">		while ((stv0367_readbits(state,F367TER_COM_USEGAINTRK)!=1) &amp;&amp;</span>
<span class="cm">		(stv0367_readbits(state,F367TER_COM_AGCLOCK)!=1)&amp;&amp;(tempo&lt;100)) {</span>
<span class="cm">			ChipWaitOrAbort(state,1);</span>
<span class="cm">			tempo+=1;</span>
<span class="cm">		}</span>

<span class="cm">		stv0367_writebits(state,F367TER_COM_N,0x17);</span>
<span class="cm">	} */</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SYR_TR_DIS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;FE_TER_LOCKOK !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span>	<span class="n">FE_TER_LOCKOK</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv0367ter_set_ts_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">stv0367_ts_mode</span> <span class="n">PathTS</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TS_DIS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">PathTS</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="cm">/*for removing warning :default we can assume in parallel mode*/</span>
	<span class="k">case</span> <span class="n">STV0367_PARALLEL_PUNCT_CLOCK</span>:
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TSFIFO_SERIAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TSFIFO_DVBCI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0367_SERIAL_PUNCT_CLOCK</span>:
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TSFIFO_SERIAL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TSFIFO_DVBCI</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv0367ter_set_clk_pol</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">stv0367_clk_pol</span> <span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clock</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV0367_RISINGEDGE_CLOCK</span>:
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TS_BYTE_CLK_INV</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0367_FALLINGEDGE_CLOCK</span>:
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TS_BYTE_CLK_INV</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*case FE_TER_CLOCK_POLARITY_DEFAULT:*/</span>
	<span class="nl">default:</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TS_BYTE_CLK_INV</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void stv0367ter_core_sw(struct stv0367_state *state)</span>
<span class="c">{</span>

<span class="c">	dprintk(&quot;%s:\n&quot;, __func__);</span>

<span class="c">	stv0367_writebits(state, F367TER_CORE_ACTIVE, 0);</span>
<span class="c">	stv0367_writebits(state, F367TER_CORE_ACTIVE, 1);</span>
<span class="c">	msleep(350);</span>
<span class="c">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367ter_standby</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">standby_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">standby_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_STDBY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_STDBY_FEC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_STDBY_CORE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_STDBY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_STDBY_FEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_STDBY_CORE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367ter_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">stv0367ter_standby</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stv0367ter_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367ter_state</span> <span class="o">*</span><span class="n">ter_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ter_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">pBER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STV0367TER_NBREGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">def0367ter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
					<span class="n">def0367ter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">xtal</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*set internal freq to 53.125MHz */</span>
	<span class="k">case</span> <span class="mi">25000000</span>:
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_PLLMDIV</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_PLLNDIV</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_PLLSETUP</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">27000000</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;FE_STV0367TER_SetCLKgen for 27Mhz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_PLLMDIV</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_PLLNDIV</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_PLLSETUP</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">30000000</span>:
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_PLLMDIV</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_PLLNDIV</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_PLLSETUP</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_I2CRPT</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_ANACTRL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/*Set TS1 and TS2 to serial or parallel mode */</span>
	<span class="n">stv0367ter_set_ts_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts_mode</span><span class="p">);</span>
	<span class="n">stv0367ter_set_clk_pol</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">clk_pol</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_ID</span><span class="p">);</span>
	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">first_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">unlock_counter</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367ter_algo</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367ter_state</span> <span class="o">*</span><span class="n">ter_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ter_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tempo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">u_var</span><span class="p">;</span>
	<span class="n">u8</span> <span class="cm">/*constell,*/</span> <span class="n">counter</span><span class="p">,</span> <span class="n">tps_rcvd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">s8</span> <span class="n">step</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">timing_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">trl_nomrate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">InternalFreq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">=</span> <span class="n">FE_TER_FORCENONE</span>
			<span class="o">+</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_FORCE</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">if_iq_mode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_iq_mode</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_iq_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FE_TER_NORMAL_IF_TUNER</span>:  <span class="cm">/* Normal IF mode */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ALGO: FE_TER_NORMAL_IF_TUNER selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TUNER_BB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LONGPATH_IF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_DEMUX_SWAP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_TER_LONGPATH_IF_TUNER</span>:  <span class="cm">/* Long IF mode */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ALGO: FE_TER_LONGPATH_IF_TUNER selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TUNER_BB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LONGPATH_IF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_DEMUX_SWAP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_TER_IQ_TUNER</span>:  <span class="cm">/* IQ mode */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ALGO: FE_TER_IQ_TUNER selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TUNER_BB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_PPM_INVSEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ALGO: wrong TUNER type selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">7000</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INVERSION_AUTO</span>:
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: inversion AUTO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">if_iq_mode</span> <span class="o">==</span> <span class="n">FE_TER_IQ_TUNER</span><span class="p">)</span>
			<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_IQ_INVERT</span><span class="p">,</span>
						<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_INV_SPECTR</span><span class="p">,</span>
						<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INVERSION_ON</span>:
	<span class="k">case</span> <span class="n">INVERSION_OFF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">if_iq_mode</span> <span class="o">==</span> <span class="n">FE_TER_IQ_TUNER</span><span class="p">)</span>
			<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_IQ_INVERT</span><span class="p">,</span>
						<span class="n">p</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_INV_SPECTR</span><span class="p">,</span>
						<span class="n">p</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">if_iq_mode</span> <span class="o">!=</span> <span class="n">FE_TER_NORMAL_IF_TUNER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">pBW</span> <span class="o">!=</span> <span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">bw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stv0367ter_agc_iir_lock_detect_set</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="cm">/*set fine agc target to 180 for LPIF or IQ mode*/</span>
		<span class="cm">/* set Q_AGCTarget */</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SEL_IQNTAR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_AUT_AGC_TARGET_MSB</span><span class="p">,</span> <span class="mh">0xB</span><span class="p">);</span>
		<span class="cm">/*stv0367_writebits(state,AUT_AGC_TARGET_LSB,0x04); */</span>

		<span class="cm">/* set Q_AGCTarget */</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SEL_IQNTAR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_AUT_AGC_TARGET_MSB</span><span class="p">,</span> <span class="mh">0xB</span><span class="p">);</span>
		<span class="cm">/*stv0367_writebits(state,AUT_AGC_TARGET_LSB,0x04); */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stv0367_iir_filt_init</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">bw</span><span class="p">,</span>
						<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">xtal</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/*set IIR filter once for 6,7 or 8MHz BW*/</span>
		<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">pBW</span> <span class="o">=</span> <span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">bw</span><span class="p">;</span>

		<span class="n">stv0367ter_agc_iir_rst</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">FE_TER_HIER_LOW_PRIO</span><span class="p">)</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_BDI_LPSEL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_BDI_LPSEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">InternalFreq</span> <span class="o">=</span> <span class="n">stv0367ter_get_mclk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">xtal</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span>
		<span class="p">((((</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">bw</span> <span class="o">*</span> <span class="mi">64</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
						<span class="o">/</span> <span class="p">(</span><span class="n">InternalFreq</span><span class="p">))</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TRL_NOMRATE_LSB</span><span class="p">,</span> <span class="n">temp</span> <span class="o">%</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TRL_NOMRATE_HI</span><span class="p">,</span> <span class="n">temp</span> <span class="o">/</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TRL_NOMRATE_LO</span><span class="p">,</span> <span class="n">temp</span> <span class="o">%</span> <span class="mi">256</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TRL_NOMRATE_HI</span><span class="p">)</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">+</span>
			<span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TRL_NOMRATE_LO</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>
			<span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TRL_NOMRATE_LSB</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">*</span> <span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">bw</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">InternalFreq</span><span class="p">)));</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_GAIN_SRC_HI</span><span class="p">,</span> <span class="n">temp</span> <span class="o">/</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_GAIN_SRC_LO</span><span class="p">,</span> <span class="n">temp</span> <span class="o">%</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_GAIN_SRC_HI</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span>
			<span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_GAIN_SRC_LO</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span>
		<span class="p">((</span><span class="n">InternalFreq</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_khz</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
							<span class="o">/</span> <span class="p">(</span><span class="n">InternalFreq</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;DEROT temp=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_INC_DEROT_HI</span><span class="p">,</span> <span class="n">temp</span> <span class="o">/</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_INC_DEROT_LO</span><span class="p">,</span> <span class="n">temp</span> <span class="o">%</span> <span class="mi">256</span><span class="p">);</span>

	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">echo_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">ucblocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* liplianin */</span>
	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">pBER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* liplianin */</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LONG_ECHO</span><span class="p">,</span> <span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">echo_pos</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv0367ter_lock_algo</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FE_TER_LOCKOK</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FE_TER_LOCKOK</span><span class="p">;</span>
	<span class="cm">/* update results */</span>
	<span class="n">tps_rcvd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_TPS_RCVD2</span><span class="p">);</span>
	<span class="n">tps_rcvd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367TER_TPS_RCVD3</span><span class="p">);</span>

	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SYR_MODE</span><span class="p">);</span>
	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">guard</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SYR_GUARD</span><span class="p">);</span>

	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">first_lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* we know sense now :) */</span>

	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">agc_val</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_AGC1_VAL_LO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_AGC1_VAL_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_AGC2_VAL_LO</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_AGC2_VAL_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Carrier offset calculation */</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_FREEZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_CRL_FOFFSET_VHI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_CRL_FOFFSET_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_CRL_FOFFSET_LO</span><span class="p">));</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_FREEZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">8388607</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="mi">16777216</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">16384</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FE_TER_MODE_2K</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">4464</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span><span class="cm">/*** 1 FFT BIN=4.464khz***/</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FE_TER_MODE_4K</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">223</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span><span class="cm">/*** 1 FFT BIN=2.23khz***/</span>
	<span class="k">else</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FE_TER_MODE_8K</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">111</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span><span class="cm">/*** 1 FFT BIN=1.1khz***/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_PPM_INVSEL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_INV_SPECTR</span><span class="p">)</span> <span class="o">==</span>
				<span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					<span class="n">F367TER_STATUS_INV_SPECRUM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)))</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">bw</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">bw</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">tempo</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>  <span class="cm">/* exit even if timing_offset stays null */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">timing_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tempo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span>	<span class="cm">/*was 20ms  */</span>
		<span class="cm">/* fine tuning of timing offset if required */</span>
		<span class="n">timing_offset</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TRL_TOFFSET_LO</span><span class="p">)</span>
				<span class="o">+</span> <span class="mi">256</span> <span class="o">*</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
							<span class="n">F367TER_TRL_TOFFSET_HI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timing_offset</span> <span class="o">&gt;=</span> <span class="mi">32768</span><span class="p">)</span>
			<span class="n">timing_offset</span> <span class="o">-=</span> <span class="mi">65536</span><span class="p">;</span>
		<span class="n">trl_nomrate</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
							<span class="n">F367TER_TRL_NOMRATE_HI</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TRL_NOMRATE_LO</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
			<span class="o">+</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TRL_NOMRATE_LSB</span><span class="p">));</span>

		<span class="n">timing_offset</span> <span class="o">=</span> <span class="p">((</span><span class="kt">signed</span><span class="p">)(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">trl_nomrate</span><span class="p">)</span> <span class="o">*</span>
							<span class="n">timing_offset</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">tempo</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timing_offset</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timing_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">timing_offset</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)</span> <span class="o">/</span> <span class="mi">22</span><span class="p">;</span>
		<span class="n">step</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">timing_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">timing_offset</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span> <span class="o">/</span> <span class="mi">22</span><span class="p">;</span>
		<span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">abs</span><span class="p">(</span><span class="n">timing_offset</span><span class="p">);</span> <span class="n">counter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trl_nomrate</span> <span class="o">+=</span> <span class="n">step</span><span class="p">;</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TRL_NOMRATE_LSB</span><span class="p">,</span>
						<span class="n">trl_nomrate</span> <span class="o">%</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TRL_NOMRATE_LO</span><span class="p">,</span>
						<span class="n">trl_nomrate</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">6000</span><span class="p">);</span>
	<span class="cm">/* unlocks could happen in case of trl centring big step,</span>
<span class="cm">	then a core off/on restarts demod */</span>
	<span class="n">u_var</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">u_var</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_CORE_ACTIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_CORE_ACTIVE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367ter_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367ter_state</span> <span class="o">*</span><span class="n">ter_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ter_state</span><span class="p">;</span>

	<span class="cm">/*u8 trials[2]; */</span>
	<span class="n">s8</span> <span class="n">num_trials</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">SenseTrials</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">INVERSION_ON</span><span class="p">,</span> <span class="n">INVERSION_OFF</span> <span class="p">};</span>

	<span class="n">stv0367ter_init</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_AUTO</span>:
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
		<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">FE_TER_MODE_2K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cm">/*	case TRANSMISSION_MODE_4K:</span>
<span class="cm">		pLook.mode = FE_TER_MODE_4K;</span>
<span class="cm">		break;*/</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
		<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">FE_TER_MODE_8K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">guard_interval</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_32</span>:
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_16</span>:
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_8</span>:
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_4</span>:
		<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">guard</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">guard_interval</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_AUTO</span>:
		<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">guard</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6000000</span>:
		<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">bw</span> <span class="o">=</span> <span class="n">FE_TER_CHAN_BW_6M</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7000000</span>:
		<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">bw</span> <span class="o">=</span> <span class="n">FE_TER_CHAN_BW_7M</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8000000</span>:
	<span class="nl">default:</span>
		<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">bw</span> <span class="o">=</span> <span class="n">FE_TER_CHAN_BW_8M</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">FE_TER_HIER_NONE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INVERSION_OFF</span>:
	<span class="k">case</span> <span class="n">INVERSION_ON</span>:
		<span class="n">num_trials</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">num_trials</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">first_lock</span><span class="p">)</span>
			<span class="n">num_trials</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FE_TER_NOLOCK</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(((</span><span class="n">index</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_trials</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FE_TER_LOCKOK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">first_lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">==</span> <span class="n">INVERSION_AUTO</span><span class="p">)</span>
				<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="n">SenseTrials</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

		<span class="p">}</span>
		<span class="n">stv0367ter_algo</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FE_TER_LOCKOK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">==</span> <span class="n">INVERSION_AUTO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
								<span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* invert spectrum sense */</span>
			<span class="n">SenseTrials</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">SenseTrials</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">SenseTrials</span><span class="p">[(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SenseTrials</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367ter_read_ucblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ucblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367ter_state</span> <span class="o">*</span><span class="n">ter_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ter_state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">errs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*wait for counting completion*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SFERRC_OLDVALUE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errs</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_ERR_CNT1</span><span class="p">)</span>
			<span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span>
			<span class="o">+</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_ERR_CNT1_HI</span><span class="p">)</span>
			<span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span>
			<span class="o">+</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_ERR_CNT1_LO</span><span class="p">));</span>
		<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">ucblocks</span> <span class="o">=</span> <span class="n">errs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="o">*</span><span class="n">ucblocks</span><span class="p">)</span> <span class="o">=</span> <span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">ucblocks</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367ter_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367ter_state</span> <span class="o">*</span><span class="n">ter_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ter_state</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">stv0367_ter_mode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">constell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="cm">/* snr = 0,*/</span> <span class="n">Data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">stv0367_get_tuner_freq</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="o">-</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>

	<span class="n">constell</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TPS_CONST</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">constell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QPSK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">constell</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_64</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_INV_SPECTR</span><span class="p">);</span>

	<span class="cm">/* Get the Hierarchical mode */</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TPS_HIERMODE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">Data</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span> <span class="cm">/* error */</span>
	<span class="p">}</span>

	<span class="cm">/* Get the FEC Rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">FE_TER_HIER_LOW_PRIO</span><span class="p">)</span>
		<span class="n">Data</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TPS_LPCODE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">Data</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_TPS_HPCODE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">Data</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_1_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_5_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_7_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span> <span class="cm">/* error */</span>
	<span class="p">}</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SYR_MODE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FE_TER_MODE_2K</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_2K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cm">/*	case FE_TER_MODE_4K:</span>
<span class="cm">		p-&gt;transmission_mode = TRANSMISSION_MODE_4K;</span>
<span class="cm">		break;*/</span>
	<span class="k">case</span> <span class="n">FE_TER_MODE_8K</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_AUTO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SYR_GUARD</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367ter_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">snru32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cut</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_IDENTIFICATIONREG</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cpt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cut</span> <span class="o">==</span> <span class="mh">0x50</span><span class="p">)</span> <span class="cm">/*cut 1.0 cut 1.1*/</span>
			<span class="n">snru32</span> <span class="o">+=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_CHCSNR</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/*cu2.0*/</span>
			<span class="n">snru32</span> <span class="o">+=</span> <span class="mi">125</span> <span class="o">*</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_CHCSNR</span><span class="p">);</span>

		<span class="n">cpt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snru32</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span><span class="cm">/*average on 10 values*/</span>

	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">snru32</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int stv0367ter_status(struct dvb_frontend *fe)</span>
<span class="c">{</span>

<span class="c">	struct stv0367_state *state = fe-&gt;demodulator_priv;</span>
<span class="c">	struct stv0367ter_state *ter_state = state-&gt;ter_state;</span>
<span class="c">	int locked = FALSE;</span>

<span class="c">	locked = (stv0367_readbits(state, F367TER_LK));</span>
<span class="c">	if (!locked)</span>
<span class="c">		ter_state-&gt;unlock_counter += 1;</span>
<span class="c">	else</span>
<span class="c">		ter_state-&gt;unlock_counter = 0;</span>

<span class="c">	if (ter_state-&gt;unlock_counter &gt; 2) {</span>
<span class="c">		if (!stv0367_readbits(state, F367TER_TPS_LOCK) ||</span>
<span class="c">				(!stv0367_readbits(state, F367TER_LK))) {</span>
<span class="c">			stv0367_writebits(state, F367TER_CORE_ACTIVE, 0);</span>
<span class="c">			usleep_range(2000, 3000);</span>
<span class="c">			stv0367_writebits(state, F367TER_CORE_ACTIVE, 1);</span>
<span class="c">			msleep(350);</span>
<span class="c">			locked = (stv0367_readbits(state, F367TER_TPS_LOCK)) &amp;&amp;</span>
<span class="c">					(stv0367_readbits(state, F367TER_LK));</span>
<span class="c">		}</span>

<span class="c">	}</span>

<span class="c">	return locked;</span>
<span class="c">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367ter_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_LK</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: stv0367 has locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367ter_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367ter_state</span> <span class="o">*</span><span class="n">ter_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ter_state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">Errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">temporary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">abc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">def</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="cm">/*wait for counting completion*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SFERRC_OLDVALUE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">Errors</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SFEC_ERR_CNT</span><span class="p">)</span>
			<span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span>
			<span class="o">+</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SFEC_ERR_CNT_HI</span><span class="p">)</span>
			<span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span>
			<span class="o">+</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
						<span class="n">F367TER_SFEC_ERR_CNT_LO</span><span class="p">));</span>
	<span class="cm">/*measurement not completed, load previous value*/</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">tber</span> <span class="o">=</span> <span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">pBER</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">abc</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SFEC_ERR_SOURCE</span><span class="p">);</span>
	<span class="n">def</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367TER_SFEC_NUM_EVENT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">abc</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temporary</span> <span class="o">=</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">*</span> <span class="mi">1000000000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
			<span class="n">temporary</span> <span class="o">=</span>  <span class="n">temporary</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">&lt;=</span> <span class="mi">42</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temporary</span> <span class="o">=</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">*</span> <span class="mi">100000000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
			<span class="n">temporary</span> <span class="o">=</span> <span class="n">temporary</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">&lt;=</span> <span class="mi">429</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temporary</span> <span class="o">=</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">*</span> <span class="mi">10000000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
			<span class="n">temporary</span> <span class="o">=</span> <span class="n">temporary</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">&lt;=</span> <span class="mi">4294</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temporary</span> <span class="o">=</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
			<span class="n">temporary</span> <span class="o">=</span> <span class="n">temporary</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">&lt;=</span> <span class="mi">42949</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temporary</span> <span class="o">=</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
			<span class="n">temporary</span> <span class="o">=</span> <span class="n">temporary</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">&lt;=</span> <span class="mi">429496</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temporary</span> <span class="o">=</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
			<span class="n">temporary</span> <span class="o">=</span> <span class="n">temporary</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/*if (Errors&lt;4294967) 2^22 max error*/</span>
			<span class="n">temporary</span> <span class="o">=</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
			<span class="n">temporary</span> <span class="o">=</span> <span class="n">temporary</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>	<span class="cm">/* still to *10 */</span>
		<span class="p">}</span>

		<span class="cm">/* Byte error*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">def</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="cm">/*tber=Errors/(8*(1 &lt;&lt;14));*/</span>
			<span class="n">tber</span> <span class="o">=</span> <span class="n">temporary</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">def</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="cm">/*tber=Errors/(8*(1 &lt;&lt;16));*/</span>
			<span class="n">tber</span> <span class="o">=</span> <span class="n">temporary</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">def</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="cm">/*tber=Errors/(8*(1 &lt;&lt;18));*/</span>
			<span class="n">tber</span> <span class="o">=</span> <span class="n">temporary</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">def</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
			<span class="cm">/*tber=Errors/(8*(1 &lt;&lt;20));*/</span>
			<span class="n">tber</span> <span class="o">=</span> <span class="n">temporary</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">def</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
			<span class="cm">/*tber=Errors/(8*(1 &lt;&lt;22));*/</span>
			<span class="n">tber</span> <span class="o">=</span> <span class="n">temporary</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* should not pass here*/</span>
			<span class="n">tber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Errors</span> <span class="o">&lt;</span> <span class="mi">4294967</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Errors</span> <span class="o">&gt;</span> <span class="mi">429496</span><span class="p">))</span>
			<span class="n">tber</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* save actual value */</span>
	<span class="n">ter_state</span><span class="o">-&gt;</span><span class="n">pBER</span> <span class="o">=</span> <span class="n">tber</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">ber</span><span class="p">)</span> <span class="o">=</span> <span class="n">tber</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static u32 stv0367ter_get_per(struct stv0367_state *state)</span>
<span class="c">{</span>
<span class="c">	struct stv0367ter_state *ter_state = state-&gt;ter_state;</span>
<span class="c">	u32 Errors = 0, Per = 0, temporary = 0;</span>
<span class="c">	int abc = 0, def = 0, cpt = 0;</span>

<span class="c">	while (((stv0367_readbits(state, F367TER_SFERRC_OLDVALUE) == 1) &amp;&amp;</span>
<span class="c">			(cpt &lt; 400)) || ((Errors == 0) &amp;&amp; (cpt &lt; 400))) {</span>
<span class="c">		usleep_range(1000, 2000);</span>
<span class="c">		Errors = ((u32)stv0367_readbits(state, F367TER_ERR_CNT1)</span>
<span class="c">			* (1 &lt;&lt; 16))</span>
<span class="c">			+ ((u32)stv0367_readbits(state, F367TER_ERR_CNT1_HI)</span>
<span class="c">			* (1 &lt;&lt; 8))</span>
<span class="c">			+ ((u32)stv0367_readbits(state, F367TER_ERR_CNT1_LO));</span>
<span class="c">		cpt++;</span>
<span class="c">	}</span>
<span class="c">	abc = stv0367_readbits(state, F367TER_ERR_SRC1);</span>
<span class="c">	def = stv0367_readbits(state, F367TER_NUM_EVT1);</span>

<span class="c">	if (Errors == 0)</span>
<span class="c">		Per = 0;</span>
<span class="c">	else if (abc == 0x9) {</span>
<span class="c">		if (Errors &lt;= 4) {</span>
<span class="c">			temporary = (Errors * 1000000000) / (8 * (1 &lt;&lt; 8));</span>
<span class="c">			temporary =  temporary;</span>
<span class="c">		} else if (Errors &lt;= 42) {</span>
<span class="c">			temporary = (Errors * 100000000) / (8 * (1 &lt;&lt; 8));</span>
<span class="c">			temporary = temporary * 10;</span>
<span class="c">		} else if (Errors &lt;= 429) {</span>
<span class="c">			temporary = (Errors * 10000000) / (8 * (1 &lt;&lt; 8));</span>
<span class="c">			temporary = temporary * 100;</span>
<span class="c">		} else if (Errors &lt;= 4294) {</span>
<span class="c">			temporary = (Errors * 1000000) / (8 * (1 &lt;&lt; 8));</span>
<span class="c">			temporary = temporary * 1000;</span>
<span class="c">		} else if (Errors &lt;= 42949) {</span>
<span class="c">			temporary = (Errors * 100000) / (8 * (1 &lt;&lt; 8));</span>
<span class="c">			temporary = temporary * 10000;</span>
<span class="c">		} else { /*if(Errors&lt;=429496)  2^16 errors max*/</span>
<span class="c">			temporary = (Errors * 10000) / (8 * (1 &lt;&lt; 8));</span>
<span class="c">			temporary = temporary * 100000;</span>
<span class="c">		}</span>

<span class="c">		/* pkt error*/</span>
<span class="c">		if (def == 2)</span>
<span class="c">			/*Per=Errors/(1 &lt;&lt; 8);*/</span>
<span class="c">			Per = temporary;</span>
<span class="c">		else if (def == 3)</span>
<span class="c">			/*Per=Errors/(1 &lt;&lt; 10);*/</span>
<span class="c">			Per = temporary / 4;</span>
<span class="c">		else if (def == 4)</span>
<span class="c">			/*Per=Errors/(1 &lt;&lt; 12);*/</span>
<span class="c">			Per = temporary / 16;</span>
<span class="c">		else if (def == 5)</span>
<span class="c">			/*Per=Errors/(1 &lt;&lt; 14);*/</span>
<span class="c">			Per = temporary / 64;</span>
<span class="c">		else if (def == 6)</span>
<span class="c">			/*Per=Errors/(1 &lt;&lt; 16);*/</span>
<span class="c">			Per = temporary / 256;</span>
<span class="c">		else</span>
<span class="c">			Per = 0;</span>

<span class="c">	}</span>
<span class="c">	/* save actual value */</span>
<span class="c">	ter_state-&gt;pPER = Per;</span>

<span class="c">	return Per;</span>
<span class="c">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367_get_tune_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span>
					<span class="o">*</span><span class="n">fe_tune_settings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fe_tune_settings</span><span class="o">-&gt;</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">fe_tune_settings</span><span class="o">-&gt;</span><span class="n">step_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fe_tune_settings</span><span class="o">-&gt;</span><span class="n">max_drift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stv0367_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ter_state</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cab_state</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">stv0367ter_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBT</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;ST STV0367 DVB-T&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span>		<span class="o">=</span> <span class="mi">47000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span>		<span class="o">=</span> <span class="mi">862000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span>	<span class="o">=</span> <span class="mi">15625</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_tolerance</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span>
			<span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span>
			<span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_QPSK</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span>
			<span class="n">FE_CAN_QAM_128</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_256</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_TRANSMISSION_MODE_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_RECOVER</span> <span class="o">|</span>
			<span class="n">FE_CAN_INVERSION_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_MUTE_TS</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">stv0367_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">stv0367ter_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">stv0367ter_sleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">i2c_gate_ctrl</span> <span class="o">=</span> <span class="n">stv0367ter_gate_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">stv0367ter_set_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend</span> <span class="o">=</span> <span class="n">stv0367ter_get_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">=</span> <span class="n">stv0367_get_tune_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">stv0367ter_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">stv0367ter_read_ber</span><span class="p">,</span><span class="cm">/* too slow */</span>
<span class="cm">/*	.read_signal_strength = stv0367_read_signal_strength,*/</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">stv0367ter_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">stv0367ter_read_ucblocks</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">stv0367ter_attach</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">stv0367_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367ter_state</span> <span class="o">*</span><span class="n">ter_state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* allocate memory for the internal state */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ter_state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367ter_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ter_state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* setup the state */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ter_state</span> <span class="o">=</span> <span class="n">ter_state</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">stv0367ter_ops</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xf000</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: chip_id = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>

	<span class="cm">/* check if the demod is there */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">!=</span> <span class="mh">0x50</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">!=</span> <span class="mh">0x60</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ter_state</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">stv0367ter_attach</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367cab_gate_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_I2CT_ON</span><span class="p">,</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv0367cab_get_mclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ExtClk_Hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mclk_Hz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="cm">/* master clock frequency (Hz) */</span>
	<span class="n">u32</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">P</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_BYPASS_PLLXN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_PLL_NDIV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">N</span> <span class="o">=</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">M</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_PLL_MDIV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">M</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_PLL_PDIV</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">P</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">P</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

		<span class="n">mclk_Hz</span> <span class="o">=</span> <span class="p">((</span><span class="n">ExtClk_Hz</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">M</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">P</span><span class="p">));</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;stv0367cab_get_mclk BYPASS_PLLXN mclk_Hz=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">mclk_Hz</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mclk_Hz</span> <span class="o">=</span> <span class="n">ExtClk_Hz</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;stv0367cab_get_mclk final mclk_Hz=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mclk_Hz</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mclk_Hz</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv0367cab_get_adc_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ExtClk_Hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ADCClk_Hz</span> <span class="o">=</span> <span class="n">ExtClk_Hz</span><span class="p">;</span>

	<span class="n">ADCClk_Hz</span> <span class="o">=</span> <span class="n">stv0367cab_get_mclk</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">ExtClk_Hz</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ADCClk_Hz</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">stv0367cab_mod</span> <span class="nf">stv0367cab_SetQamSize</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">SymbolRate</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">stv0367cab_mod</span> <span class="n">QAMSize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set QAM size */</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_QAM_MODE</span><span class="p">,</span> <span class="n">QAMSize</span><span class="p">);</span>

	<span class="cm">/* Set Registers settings specific to the QAM size */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">QAMSize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM4</span>:
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_IQDEM_ADJ_AGC_REF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM16</span>:
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_AGC_PWR_REF_L</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_IQDEM_ADJ_AGC_REF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_FSM_STATE</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CTR_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LD_SEN</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LIMITER</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_PNT_GAIN</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM32</span>:
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_IQDEM_ADJ_AGC_REF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_AGC_PWR_REF_L</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_FSM_STATE</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CTR_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LD_SEN</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LIMITER</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_PNT_GAIN</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM64</span>:
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_IQDEM_ADJ_AGC_REF</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_AGC_PWR_REF_L</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SymbolRate</span> <span class="o">&gt;</span> <span class="mi">45000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_FSM_STATE</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">);</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CTR_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">);</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SymbolRate</span> <span class="o">&gt;</span> <span class="mi">25000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_FSM_STATE</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CTR_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">);</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_FSM_STATE</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CTR_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">);</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LD_SEN</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LIMITER</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_PNT_GAIN</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM128</span>:
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_IQDEM_ADJ_AGC_REF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_AGC_PWR_REF_L</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_FSM_STATE</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CTR_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SymbolRate</span> <span class="o">&gt;</span> <span class="mi">45000000</span><span class="p">)</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SymbolRate</span> <span class="o">&gt;</span> <span class="mi">25000000</span><span class="p">)</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LPF_GAIN</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">);</span>

		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LD_SEN</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LIMITER</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_PNT_GAIN</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM256</span>:
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_IQDEM_ADJ_AGC_REF</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_AGC_PWR_REF_L</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_FSM_STATE</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SymbolRate</span> <span class="o">&gt;</span> <span class="mi">45000000</span><span class="p">)</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CTR_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SymbolRate</span> <span class="o">&gt;</span> <span class="mi">25000000</span><span class="p">)</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CTR_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CTR_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">);</span>

		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LPF_GAIN</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LD_SEN</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_LIMITER</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_PNT_GAIN</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM512</span>:
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_IQDEM_ADJ_AGC_REF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM1024</span>:
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_IQDEM_ADJ_AGC_REF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">QAMSize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv0367cab_set_derot_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">adc_hz</span><span class="p">,</span> <span class="n">s32</span> <span class="n">derot_hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sampled_if</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">adc_khz</span><span class="p">;</span>

	<span class="n">adc_khz</span> <span class="o">=</span> <span class="n">adc_hz</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: adc_hz=%d derot_hz=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">adc_hz</span><span class="p">,</span> <span class="n">derot_hz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adc_khz</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">derot_hz</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">)</span>
			<span class="n">derot_hz</span> <span class="o">=</span> <span class="n">adc_hz</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* ZIF operation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">derot_hz</span> <span class="o">&gt;</span> <span class="n">adc_hz</span><span class="p">)</span>
			<span class="n">derot_hz</span> <span class="o">=</span> <span class="n">derot_hz</span> <span class="o">-</span> <span class="n">adc_hz</span><span class="p">;</span>
		<span class="n">sampled_if</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">derot_hz</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">sampled_if</span> <span class="o">*=</span> <span class="mi">32768</span><span class="p">;</span>
		<span class="n">sampled_if</span> <span class="o">/=</span> <span class="n">adc_khz</span><span class="p">;</span>
		<span class="n">sampled_if</span> <span class="o">*=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sampled_if</span> <span class="o">&gt;</span> <span class="mi">8388607</span><span class="p">)</span>
		<span class="n">sampled_if</span> <span class="o">=</span> <span class="mi">8388607</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: sampled_if=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">sampled_if</span><span class="p">);</span>

	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_MIX_NCO_LL</span><span class="p">,</span> <span class="n">sampled_if</span><span class="p">);</span>
	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_MIX_NCO_HL</span><span class="p">,</span> <span class="p">(</span><span class="n">sampled_if</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_MIX_NCO_INC_HH</span><span class="p">,</span> <span class="p">(</span><span class="n">sampled_if</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">derot_hz</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv0367cab_get_derot_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">adc_hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sampled_if</span><span class="p">;</span>

	<span class="n">sampled_if</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_MIX_NCO_INC_LL</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_MIX_NCO_INC_HL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_MIX_NCO_INC_HH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">sampled_if</span> <span class="o">/=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">sampled_if</span> <span class="o">*=</span> <span class="p">(</span><span class="n">adc_hz</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">sampled_if</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sampled_if</span> <span class="o">/=</span> <span class="mi">32768</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sampled_if</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv0367cab_set_srate</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">adc_hz</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">mclk_hz</span><span class="p">,</span> <span class="n">u32</span> <span class="n">SymbolRate</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">stv0367cab_mod</span> <span class="n">QAMSize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">QamSizeCorr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u32_tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u32_tmp1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">adp_khz</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Set Correction factor of SRC gain */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">QAMSize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM4</span>:
		<span class="n">QamSizeCorr</span> <span class="o">=</span> <span class="mi">1110</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM16</span>:
		<span class="n">QamSizeCorr</span> <span class="o">=</span> <span class="mi">1032</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM32</span>:
		<span class="n">QamSizeCorr</span> <span class="o">=</span>  <span class="mi">954</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM64</span>:
		<span class="n">QamSizeCorr</span> <span class="o">=</span>  <span class="mi">983</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM128</span>:
		<span class="n">QamSizeCorr</span> <span class="o">=</span>  <span class="mi">957</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM256</span>:
		<span class="n">QamSizeCorr</span> <span class="o">=</span>  <span class="mi">948</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM512</span>:
		<span class="n">QamSizeCorr</span> <span class="o">=</span>    <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM1024</span>:
		<span class="n">QamSizeCorr</span> <span class="o">=</span>  <span class="mi">944</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Transfer ratio calculation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adc_hz</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32_tmp</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="n">SymbolRate</span><span class="p">;</span>
		<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">/</span> <span class="n">adc_hz</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_EQU_CRL_TFR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">u32_tmp</span><span class="p">);</span>

	<span class="cm">/* Symbol rate and SRC gain calculation */</span>
	<span class="n">adp_khz</span> <span class="o">=</span> <span class="p">(</span><span class="n">mclk_hz</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span><span class="cm">/* TRL works at half the system clock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adp_khz</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">SymbolRate</span><span class="p">;</span>
		<span class="n">u32_tmp1</span> <span class="o">=</span> <span class="n">SymbolRate</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">u32_tmp</span> <span class="o">&lt;</span> <span class="mi">2097152</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 2097152 = 2^21 */</span>
			<span class="cm">/* Symbol rate calculation */</span>
			<span class="n">u32_tmp</span> <span class="o">*=</span> <span class="mi">2048</span><span class="p">;</span> <span class="cm">/* 2048 = 2^11 */</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">/</span> <span class="n">adp_khz</span><span class="p">;</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">*</span> <span class="mi">16384</span><span class="p">;</span> <span class="cm">/* 16384 = 2^14 */</span>
			<span class="n">u32_tmp</span> <span class="o">/=</span> <span class="mi">125</span> <span class="p">;</span> <span class="cm">/* 125 = 1000/2^3 */</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 8 = 2^3 */</span>

			<span class="cm">/* SRC Gain Calculation */</span>
			<span class="n">u32_tmp1</span> <span class="o">*=</span> <span class="mi">2048</span><span class="p">;</span> <span class="cm">/* *2*2^10 */</span>
			<span class="n">u32_tmp1</span> <span class="o">/=</span> <span class="mi">439</span><span class="p">;</span> <span class="cm">/* *2/878 */</span>
			<span class="n">u32_tmp1</span> <span class="o">*=</span> <span class="mi">256</span><span class="p">;</span> <span class="cm">/* *2^8 */</span>
			<span class="n">u32_tmp1</span> <span class="o">=</span> <span class="n">u32_tmp1</span> <span class="o">/</span> <span class="n">adp_khz</span><span class="p">;</span> <span class="cm">/* /(AdpClk in kHz) */</span>
			<span class="n">u32_tmp1</span> <span class="o">*=</span> <span class="n">QamSizeCorr</span> <span class="o">*</span> <span class="mi">9</span><span class="p">;</span> <span class="cm">/* *1000*corr factor */</span>
			<span class="n">u32_tmp1</span> <span class="o">=</span> <span class="n">u32_tmp1</span> <span class="o">/</span> <span class="mi">10000000</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">u32_tmp</span> <span class="o">&lt;</span> <span class="mi">4194304</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 4194304 = 2**22 */</span>
			<span class="cm">/* Symbol rate calculation */</span>
			<span class="n">u32_tmp</span> <span class="o">*=</span> <span class="mi">1024</span> <span class="p">;</span> <span class="cm">/* 1024 = 2**10 */</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">/</span> <span class="n">adp_khz</span><span class="p">;</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">*</span> <span class="mi">16384</span><span class="p">;</span> <span class="cm">/* 16384 = 2**14 */</span>
			<span class="n">u32_tmp</span> <span class="o">/=</span> <span class="mi">125</span> <span class="p">;</span> <span class="cm">/* 125 = 1000/2**3 */</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span> <span class="cm">/* 16 = 2**4 */</span>

			<span class="cm">/* SRC Gain Calculation */</span>
			<span class="n">u32_tmp1</span> <span class="o">*=</span> <span class="mi">1024</span><span class="p">;</span> <span class="cm">/* *2*2^9 */</span>
			<span class="n">u32_tmp1</span> <span class="o">/=</span> <span class="mi">439</span><span class="p">;</span> <span class="cm">/* *2/878 */</span>
			<span class="n">u32_tmp1</span> <span class="o">*=</span> <span class="mi">256</span><span class="p">;</span> <span class="cm">/* *2^8 */</span>
			<span class="n">u32_tmp1</span> <span class="o">=</span> <span class="n">u32_tmp1</span> <span class="o">/</span> <span class="n">adp_khz</span><span class="p">;</span> <span class="cm">/* /(AdpClk in kHz)*/</span>
			<span class="n">u32_tmp1</span> <span class="o">*=</span> <span class="n">QamSizeCorr</span> <span class="o">*</span> <span class="mi">9</span><span class="p">;</span> <span class="cm">/* *1000*corr factor */</span>
			<span class="n">u32_tmp1</span> <span class="o">=</span> <span class="n">u32_tmp1</span> <span class="o">/</span> <span class="mi">5000000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">u32_tmp</span> <span class="o">&lt;</span> <span class="mi">8388607</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 8388607 = 2**23 */</span>
			<span class="cm">/* Symbol rate calculation */</span>
			<span class="n">u32_tmp</span> <span class="o">*=</span> <span class="mi">512</span> <span class="p">;</span> <span class="cm">/* 512 = 2**9 */</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">/</span> <span class="n">adp_khz</span><span class="p">;</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">*</span> <span class="mi">16384</span><span class="p">;</span> <span class="cm">/* 16384 = 2**14 */</span>
			<span class="n">u32_tmp</span> <span class="o">/=</span> <span class="mi">125</span> <span class="p">;</span> <span class="cm">/* 125 = 1000/2**3 */</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span> <span class="cm">/* 32 = 2**5 */</span>

			<span class="cm">/* SRC Gain Calculation */</span>
			<span class="n">u32_tmp1</span> <span class="o">*=</span> <span class="mi">512</span><span class="p">;</span> <span class="cm">/* *2*2^8 */</span>
			<span class="n">u32_tmp1</span> <span class="o">/=</span> <span class="mi">439</span><span class="p">;</span> <span class="cm">/* *2/878 */</span>
			<span class="n">u32_tmp1</span> <span class="o">*=</span> <span class="mi">256</span><span class="p">;</span> <span class="cm">/* *2^8 */</span>
			<span class="n">u32_tmp1</span> <span class="o">=</span> <span class="n">u32_tmp1</span> <span class="o">/</span> <span class="n">adp_khz</span><span class="p">;</span> <span class="cm">/* /(AdpClk in kHz) */</span>
			<span class="n">u32_tmp1</span> <span class="o">*=</span> <span class="n">QamSizeCorr</span> <span class="o">*</span> <span class="mi">9</span><span class="p">;</span> <span class="cm">/* *1000*corr factor */</span>
			<span class="n">u32_tmp1</span> <span class="o">=</span> <span class="n">u32_tmp1</span> <span class="o">/</span> <span class="mi">2500000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Symbol rate calculation */</span>
			<span class="n">u32_tmp</span> <span class="o">*=</span> <span class="mi">256</span> <span class="p">;</span> <span class="cm">/* 256 = 2**8 */</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">/</span> <span class="n">adp_khz</span><span class="p">;</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">*</span> <span class="mi">16384</span><span class="p">;</span> <span class="cm">/* 16384 = 2**13 */</span>
			<span class="n">u32_tmp</span> <span class="o">/=</span> <span class="mi">125</span> <span class="p">;</span> <span class="cm">/* 125 = 1000/2**3 */</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span> <span class="cm">/* 64 = 2**6 */</span>

			<span class="cm">/* SRC Gain Calculation */</span>
			<span class="n">u32_tmp1</span> <span class="o">*=</span> <span class="mi">256</span><span class="p">;</span> <span class="cm">/* 2*2^7 */</span>
			<span class="n">u32_tmp1</span> <span class="o">/=</span> <span class="mi">439</span><span class="p">;</span> <span class="cm">/* *2/878 */</span>
			<span class="n">u32_tmp1</span> <span class="o">*=</span> <span class="mi">256</span><span class="p">;</span> <span class="cm">/* *2^8 */</span>
			<span class="n">u32_tmp1</span> <span class="o">=</span> <span class="n">u32_tmp1</span> <span class="o">/</span> <span class="n">adp_khz</span><span class="p">;</span> <span class="cm">/* /(AdpClk in kHz) */</span>
			<span class="n">u32_tmp1</span> <span class="o">*=</span> <span class="n">QamSizeCorr</span> <span class="o">*</span> <span class="mi">9</span><span class="p">;</span> <span class="cm">/* *1000*corr factor */</span>
			<span class="n">u32_tmp1</span> <span class="o">=</span> <span class="n">u32_tmp1</span> <span class="o">/</span> <span class="mi">1250000</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Filters&#39; coefficients are calculated and written</span>
<span class="c">	into registers only if the filters are enabled */</span>
<span class="c">	if (stv0367_readbits(state, F367CAB_ADJ_EN)) {</span>
<span class="c">		stv0367cab_SetIirAdjacentcoefficient(state, mclk_hz,</span>
<span class="c">								SymbolRate);</span>
<span class="c">		/* AllPass filter must be enabled</span>
<span class="c">		when the adjacents filter is used */</span>
<span class="c">		stv0367_writebits(state, F367CAB_ALLPASSFILT_EN, 1);</span>
<span class="c">		stv0367cab_SetAllPasscoefficient(state, mclk_hz, SymbolRate);</span>
<span class="c">	} else</span>
<span class="c">		/* AllPass filter must be disabled</span>
<span class="c">		when the adjacents filter is not used */</span>
<span class="cp">#endif</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_ALLPASSFILT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_SRC_NCO_LL</span><span class="p">,</span> <span class="n">u32_tmp</span><span class="p">);</span>
	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_SRC_NCO_LH</span><span class="p">,</span> <span class="p">(</span><span class="n">u32_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_SRC_NCO_HL</span><span class="p">,</span> <span class="p">(</span><span class="n">u32_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_SRC_NCO_HH</span><span class="p">,</span> <span class="p">(</span><span class="n">u32_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">));</span>

	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_IQDEM_GAIN_SRC_L</span><span class="p">,</span> <span class="n">u32_tmp1</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_GAIN_SRC_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">u32_tmp1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SymbolRate</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">stv0367cab_GetSymbolRate</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mclk_hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">regsym</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">adp_khz</span><span class="p">;</span>

	<span class="n">regsym</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_SRC_NCO_LL</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_SRC_NCO_LH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_SRC_NCO_HL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_SRC_NCO_HH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">adp_khz</span> <span class="o">=</span> <span class="p">(</span><span class="n">mclk_hz</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span><span class="cm">/* TRL works at half the system clock */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regsym</span> <span class="o">&lt;</span> <span class="mi">134217728</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* 134217728L = 2**27*/</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">regsym</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>		<span class="cm">/* 32 = 2**5 */</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">regsym</span> <span class="o">/</span> <span class="mi">32768</span><span class="p">;</span>	<span class="cm">/* 32768L = 2**15 */</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">adp_khz</span> <span class="o">*</span> <span class="n">regsym</span><span class="p">;</span>	<span class="cm">/* AdpClk in kHz */</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">regsym</span> <span class="o">/</span> <span class="mi">128</span><span class="p">;</span>		<span class="cm">/* 128 = 2**7 */</span>
		<span class="n">regsym</span> <span class="o">*=</span> <span class="mi">125</span> <span class="p">;</span>			<span class="cm">/* 125 = 1000/2**3 */</span>
		<span class="n">regsym</span> <span class="o">/=</span> <span class="mi">2048</span> <span class="p">;</span>		<span class="cm">/* 2048 = 2**11	*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regsym</span> <span class="o">&lt;</span> <span class="mi">268435456</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 268435456L = 2**28 */</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">regsym</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>		<span class="cm">/* 16 = 2**4 */</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">regsym</span> <span class="o">/</span> <span class="mi">32768</span><span class="p">;</span>	<span class="cm">/* 32768L = 2**15 */</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">adp_khz</span> <span class="o">*</span> <span class="n">regsym</span><span class="p">;</span>	<span class="cm">/* AdpClk in kHz */</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">regsym</span> <span class="o">/</span> <span class="mi">128</span><span class="p">;</span>		<span class="cm">/* 128 = 2**7 */</span>
		<span class="n">regsym</span> <span class="o">*=</span> <span class="mi">125</span> <span class="p">;</span>			<span class="cm">/* 125 = 1000/2**3*/</span>
		<span class="n">regsym</span> <span class="o">/=</span> <span class="mi">1024</span> <span class="p">;</span>		<span class="cm">/* 256 = 2**10*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regsym</span> <span class="o">&lt;</span> <span class="mi">536870912</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 536870912L = 2**29*/</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">regsym</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>		<span class="cm">/* 8 = 2**3 */</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">regsym</span> <span class="o">/</span> <span class="mi">32768</span><span class="p">;</span>	<span class="cm">/* 32768L = 2**15 */</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">adp_khz</span> <span class="o">*</span> <span class="n">regsym</span><span class="p">;</span>	<span class="cm">/* AdpClk in kHz */</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">regsym</span> <span class="o">/</span> <span class="mi">128</span><span class="p">;</span>		<span class="cm">/* 128 = 2**7 */</span>
		<span class="n">regsym</span> <span class="o">*=</span> <span class="mi">125</span> <span class="p">;</span>			<span class="cm">/* 125 = 1000/2**3 */</span>
		<span class="n">regsym</span> <span class="o">/=</span> <span class="mi">512</span> <span class="p">;</span>			<span class="cm">/* 128 = 2**9 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">regsym</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>		<span class="cm">/* 4 = 2**2 */</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">regsym</span> <span class="o">/</span> <span class="mi">32768</span><span class="p">;</span>	<span class="cm">/* 32768L = 2**15 */</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">adp_khz</span> <span class="o">*</span> <span class="n">regsym</span><span class="p">;</span>	<span class="cm">/* AdpClk in kHz */</span>
		<span class="n">regsym</span> <span class="o">=</span> <span class="n">regsym</span> <span class="o">/</span> <span class="mi">128</span><span class="p">;</span>		<span class="cm">/* 128 = 2**7 */</span>
		<span class="n">regsym</span> <span class="o">*=</span> <span class="mi">125</span> <span class="p">;</span>			<span class="cm">/* 125 = 1000/2**3 */</span>
		<span class="n">regsym</span> <span class="o">/=</span> <span class="mi">256</span> <span class="p">;</span>			<span class="cm">/* 64 = 2**8 */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">regsym</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367cab_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_QAMFEC_LOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: stv0367 has locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367cab_standby</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">standby_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">standby_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_BYPASS_PLLXN</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_STDBY_PLLXN</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_STDBY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_STDBY_CORE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_EN_BUFFER_I</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_EN_BUFFER_Q</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_POFFQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_POFFI</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_STDBY_PLLXN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_BYPASS_PLLXN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_STDBY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_STDBY_CORE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_EN_BUFFER_I</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_EN_BUFFER_Q</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_POFFQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_POFFI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367cab_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">stv0367cab_standby</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">stv0367cab_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367cab_state</span> <span class="o">*</span><span class="n">cab_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cab_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STV0367CAB_NBREGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">def0367cab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">def0367cab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV0367_DVBCI_CLOCK</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Setting TSMode = STV0367_DVBCI_CLOCK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_OUTFORMAT</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0367_SERIAL_PUNCT_CLOCK</span>:
	<span class="k">case</span> <span class="n">STV0367_SERIAL_CONT_CLOCK</span>:
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_OUTFORMAT</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0367_PARALLEL_PUNCT_CLOCK</span>:
	<span class="k">case</span> <span class="n">STV0367_OUTPUTMODE_DEFAULT</span>:
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_OUTFORMAT</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">clk_pol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STV0367_RISINGEDGE_CLOCK</span>:
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_CLK_POLARITY</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STV0367_FALLINGEDGE_CLOCK</span>:
	<span class="k">case</span> <span class="n">STV0367_CLOCKPOLARITY_DEFAULT</span>:
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_CLK_POLARITY</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_SYNC_STRIP</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_CT_NBST</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_TS_SWAP</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_FIFO_BYPASS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_ANACTRL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span><span class="cm">/*PLL enabled and used */</span>

	<span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">stv0367cab_get_mclk</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">xtal</span><span class="p">);</span>
	<span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">adc_clk</span> <span class="o">=</span> <span class="n">stv0367cab_get_adc_freq</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">xtal</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span>
<span class="k">enum</span> <span class="n">stv0367_cab_signal_type</span> <span class="nf">stv0367cab_algo</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367cab_state</span> <span class="o">*</span><span class="n">cab_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cab_state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">stv0367_cab_signal_type</span> <span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_NOAGC</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">QAMFEC_Lock</span><span class="p">,</span> <span class="n">QAM_Lock</span><span class="p">,</span> <span class="n">u32_tmp</span><span class="p">,</span>
		<span class="n">LockTime</span><span class="p">,</span> <span class="n">TRLTimeOut</span><span class="p">,</span> <span class="n">AGCTimeOut</span><span class="p">,</span> <span class="n">CRLSymbols</span><span class="p">,</span>
		<span class="n">CRLTimeOut</span><span class="p">,</span> <span class="n">EQLTimeOut</span><span class="p">,</span> <span class="n">DemodTimeOut</span><span class="p">,</span> <span class="n">FECTimeOut</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">TrackAGCAccum</span><span class="p">;</span>
	<span class="n">s32</span>	<span class="n">tmp</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Timeouts calculation */</span>
	<span class="cm">/* A max lock time of 25 ms is allowed for delayed AGC */</span>
	<span class="n">AGCTimeOut</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
	<span class="cm">/* 100000 symbols needed by the TRL as a maximum value */</span>
	<span class="n">TRLTimeOut</span> <span class="o">=</span> <span class="mi">100000000</span> <span class="o">/</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">;</span>
	<span class="cm">/* CRLSymbols is the needed number of symbols to achieve a lock</span>
<span class="cm">	   within [-4%, +4%] of the symbol rate.</span>
<span class="cm">	   CRL timeout is calculated</span>
<span class="cm">	   for a lock within [-search_range, +search_range].</span>
<span class="cm">	   EQL timeout can be changed depending on</span>
<span class="cm">	   the micro-reflections we want to handle.</span>
<span class="cm">	   A characterization must be performed</span>
<span class="cm">	   with these echoes to get new timeout values.</span>
<span class="cm">	*/</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QAM_16</span>:
		<span class="n">CRLSymbols</span> <span class="o">=</span> <span class="mi">150000</span><span class="p">;</span>
		<span class="n">EQLTimeOut</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_32</span>:
		<span class="n">CRLSymbols</span> <span class="o">=</span> <span class="mi">250000</span><span class="p">;</span>
		<span class="n">EQLTimeOut</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_64</span>:
		<span class="n">CRLSymbols</span> <span class="o">=</span> <span class="mi">200000</span><span class="p">;</span>
		<span class="n">EQLTimeOut</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_128</span>:
		<span class="n">CRLSymbols</span> <span class="o">=</span> <span class="mi">250000</span><span class="p">;</span>
		<span class="n">EQLTimeOut</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_256</span>:
		<span class="n">CRLSymbols</span> <span class="o">=</span> <span class="mi">250000</span><span class="p">;</span>
		<span class="n">EQLTimeOut</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">CRLSymbols</span> <span class="o">=</span> <span class="mi">200000</span><span class="p">;</span>
		<span class="n">EQLTimeOut</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (pIntParams-&gt;search_range &lt; 0) {</span>
<span class="c">		CRLTimeOut = (25 * CRLSymbols *</span>
<span class="c">				(-pIntParams-&gt;search_range / 1000)) /</span>
<span class="c">					(pIntParams-&gt;symbol_rate / 1000);</span>
<span class="c">	} else</span>
<span class="cp">#endif</span>
	<span class="n">CRLTimeOut</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span> <span class="o">*</span> <span class="n">CRLSymbols</span> <span class="o">*</span> <span class="p">(</span><span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">/</span>
					<span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="n">CRLTimeOut</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">CRLTimeOut</span><span class="p">)</span> <span class="o">/</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">;</span>
	<span class="cm">/* Timeouts below 50ms are coerced */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CRLTimeOut</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span>
		<span class="n">CRLTimeOut</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="cm">/* A maximum of 100 TS packets is needed to get FEC lock even in case</span>
<span class="cm">	the spectrum inversion needs to be changed.</span>
<span class="cm">	   This is equal to 20 ms in case of the lowest symbol rate of 0.87Msps</span>
<span class="cm">	*/</span>
	<span class="n">FECTimeOut</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">DemodTimeOut</span> <span class="o">=</span> <span class="n">AGCTimeOut</span> <span class="o">+</span> <span class="n">TRLTimeOut</span> <span class="o">+</span> <span class="n">CRLTimeOut</span> <span class="o">+</span> <span class="n">EQLTimeOut</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: DemodTimeOut=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">DemodTimeOut</span><span class="p">);</span>

	<span class="cm">/* Reset the TRL to ensure nothing starts until the</span>
<span class="cm">	   AGC is stable which ensures a better lock time</span>
<span class="cm">	*/</span>
	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_CTRL_1</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="cm">/* Set AGC accumulation time to minimum and lock threshold to maximum</span>
<span class="cm">	in order to speed up the AGC lock */</span>
	<span class="n">TrackAGCAccum</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_AGC_ACCUMRSTSEL</span><span class="p">);</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_AGC_ACCUMRSTSEL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="cm">/* Modulus Mapper is disabled */</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_MODULUSMAP_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Disable the sweep function */</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_SWEEP_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* The sweep function is never used, Sweep rate must be set to 0 */</span>
	<span class="cm">/* Set the derotator frequency in Hz */</span>
	<span class="n">stv0367cab_set_derot_freq</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">adc_clk</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_khz</span> <span class="o">+</span> <span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">derot_offset</span><span class="p">));</span>
	<span class="cm">/* Disable the Allpass Filter when the symbol rate is out of range */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">&gt;</span> <span class="mi">10800000</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">&lt;</span> <span class="mi">1800000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_ADJ_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_ALLPASSFILT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Check if the tuner is locked */</span>
<span class="c">	tuner_lock = stv0367cab_tuner_get_status(fe);</span>
<span class="c">	if (tuner_lock == 0)</span>
<span class="c">		return FE_367CAB_NOTUNER;</span>
<span class="cp">#endif</span>
	<span class="cm">/* Relase the TRL to start demodulator acquisition */</span>
	<span class="cm">/* Wait for QAM lock */</span>
	<span class="n">LockTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stv0367_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_CTRL_1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">QAM_Lock</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_FSM_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">LockTime</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">DemodTimeOut</span> <span class="o">-</span> <span class="n">EQLTimeOut</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
							<span class="p">(</span><span class="n">QAM_Lock</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">))</span>
			<span class="cm">/*</span>
<span class="cm">			 * We don&#39;t wait longer, the frequency/phase offset</span>
<span class="cm">			 * must be too big</span>
<span class="cm">			 */</span>
			<span class="n">LockTime</span> <span class="o">=</span> <span class="n">DemodTimeOut</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">LockTime</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">AGCTimeOut</span> <span class="o">+</span> <span class="n">TRLTimeOut</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
							<span class="p">(</span><span class="n">QAM_Lock</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">))</span>
			<span class="cm">/*</span>
<span class="cm">			 * We don&#39;t wait longer, either there is no signal or</span>
<span class="cm">			 * it is not the right symbol rate or it is an analog</span>
<span class="cm">			 * carrier</span>
<span class="cm">			 */</span>
		<span class="p">{</span>
			<span class="n">LockTime</span> <span class="o">=</span> <span class="n">DemodTimeOut</span><span class="p">;</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
						<span class="n">F367CAB_AGC_PWR_WORD_LO</span><span class="p">)</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
						<span class="n">F367CAB_AGC_PWR_WORD_ME</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
						<span class="n">F367CAB_AGC_PWR_WORD_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u32_tmp</span> <span class="o">&gt;=</span> <span class="mi">131072</span><span class="p">)</span>
				<span class="n">u32_tmp</span> <span class="o">=</span> <span class="mi">262144</span> <span class="o">-</span> <span class="n">u32_tmp</span><span class="p">;</span>
			<span class="n">u32_tmp</span> <span class="o">=</span> <span class="n">u32_tmp</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
							<span class="n">F367CAB_AGC_IF_BWSEL</span><span class="p">)));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">u32_tmp</span> <span class="o">&lt;</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
						<span class="n">F367CAB_AGC_PWRREF_LO</span><span class="p">)</span> <span class="o">+</span>
					<span class="mi">256</span> <span class="o">*</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
						<span class="n">F367CAB_AGC_PWRREF_HI</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
				<span class="n">QAM_Lock</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span>
			<span class="n">LockTime</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;QAM_Lock=0x%x LockTime=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QAM_Lock</span><span class="p">,</span> <span class="n">LockTime</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_IT_STATUS1</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;R367CAB_IT_STATUS1=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(((</span><span class="n">QAM_Lock</span> <span class="o">!=</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">QAM_Lock</span> <span class="o">!=</span> <span class="mh">0x0b</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">LockTime</span> <span class="o">&lt;</span> <span class="n">DemodTimeOut</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;QAM_Lock=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QAM_Lock</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_IT_STATUS1</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;R367CAB_IT_STATUS1=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_IT_STATUS2</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;R367CAB_IT_STATUS2=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span>  <span class="o">=</span> <span class="n">stv0367cab_get_derot_freq</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">adc_clk</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;stv0367cab_get_derot_freq=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">QAM_Lock</span> <span class="o">==</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">QAM_Lock</span> <span class="o">==</span> <span class="mh">0x0b</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Wait for FEC lock */</span>
		<span class="n">LockTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">7000</span><span class="p">);</span>
			<span class="n">LockTime</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">QAMFEC_Lock</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
							<span class="n">F367CAB_QAMFEC_LOCK</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">QAMFEC_Lock</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">LockTime</span> <span class="o">&lt;</span> <span class="n">FECTimeOut</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">QAMFEC_Lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">QAMFEC_Lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_DATAOK</span><span class="p">;</span>
		<span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">;</span>
		<span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">spect_inv</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
							<span class="n">F367CAB_QUAD_INV</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* not clear for me */</span>
<span class="c">		if (state-&gt;config-&gt;if_khz != 0) {</span>
<span class="c">			if (state-&gt;config-&gt;if_khz &gt; cab_state-&gt;adc_clk / 1000) {</span>
<span class="c">				cab_state-&gt;freq_khz =</span>
<span class="c">					FE_Cab_TunerGetFrequency(pIntParams-&gt;hTuner)</span>
<span class="c">				- stv0367cab_get_derot_freq(state, cab_state-&gt;adc_clk)</span>
<span class="c">				- cab_state-&gt;adc_clk / 1000 + state-&gt;config-&gt;if_khz;</span>
<span class="c">			} else {</span>
<span class="c">				cab_state-&gt;freq_khz =</span>
<span class="c">						FE_Cab_TunerGetFrequency(pIntParams-&gt;hTuner)</span>
<span class="c">						- stv0367cab_get_derot_freq(state, cab_state-&gt;adc_clk)</span>
<span class="c">										+ state-&gt;config-&gt;if_khz;</span>
<span class="c">			}</span>
<span class="c">		} else {</span>
<span class="c">			cab_state-&gt;freq_khz =</span>
<span class="c">				FE_Cab_TunerGetFrequency(pIntParams-&gt;hTuner) +</span>
<span class="c">				stv0367cab_get_derot_freq(state,</span>
<span class="c">							cab_state-&gt;adc_clk) -</span>
<span class="c">				cab_state-&gt;adc_clk / 4000;</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
		<span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">=</span> <span class="n">stv0367cab_GetSymbolRate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
							<span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>
		<span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* stv0367_setbits(state, F367CAB_AGC_ACCUMRSTSEL,7);*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">QAM_Lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_NOAGC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_NOTIMING</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_TIMINGOK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_NOCARRIER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_CARRIEROK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_NOBLIND</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_BLINDOK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">10</span>:
			<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_NODEMOD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">11</span>:
			<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_DEMODOK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">12</span>:
			<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_DEMODOK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">13</span>:
			<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_NODEMOD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">14</span>:
			<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_NOBLIND</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">15</span>:
			<span class="n">signalType</span> <span class="o">=</span> <span class="n">FE_CAB_NOSIGNAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* Set the AGC control values to tracking values */</span>
	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_AGC_ACCUMRSTSEL</span><span class="p">,</span> <span class="n">TrackAGCAccum</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">signalType</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367cab_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367cab_state</span> <span class="o">*</span><span class="n">cab_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cab_state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">stv0367cab_mod</span> <span class="n">QAMSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: freq = %d, srate = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">);</span>

	<span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">derot_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QAM_16</span>:
		<span class="n">QAMSize</span> <span class="o">=</span> <span class="n">FE_CAB_MOD_QAM16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_32</span>:
		<span class="n">QAMSize</span> <span class="o">=</span> <span class="n">FE_CAB_MOD_QAM32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_64</span>:
		<span class="n">QAMSize</span> <span class="o">=</span> <span class="n">FE_CAB_MOD_QAM64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_128</span>:
		<span class="n">QAMSize</span> <span class="o">=</span> <span class="n">FE_CAB_MOD_QAM128</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_256</span>:
		<span class="n">QAMSize</span> <span class="o">=</span> <span class="n">FE_CAB_MOD_QAM256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stv0367cab_init</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="cm">/* Tuner Frequency Setting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">stv0367cab_SetQamSize</span><span class="p">(</span>
			<span class="n">state</span><span class="p">,</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">,</span>
			<span class="n">QAMSize</span><span class="p">);</span>

	<span class="n">stv0367cab_set_srate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
			<span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">adc_clk</span><span class="p">,</span>
			<span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">,</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">,</span>
			<span class="n">QAMSize</span><span class="p">);</span>
	<span class="cm">/* Search algorithm launch, [-1.1*RangeOffset, +1.1*RangeOffset] scan */</span>
	<span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">stv0367cab_algo</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367cab_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367cab_state</span> <span class="o">*</span><span class="n">cab_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cab_state</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">stv0367cab_mod</span> <span class="n">QAMSize</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">=</span> <span class="n">stv0367cab_GetSymbolRate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>

	<span class="n">QAMSize</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_QAM_MODE</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">QAMSize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM16</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM32</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM64</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM128</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_128</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_256</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">stv0367_get_tuner_freq</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: tuner frequency = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_khz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+=</span>
			<span class="p">(</span><span class="n">stv0367cab_get_derot_freq</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">adc_clk</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">adc_clk</span> <span class="o">/</span> <span class="mi">4000</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_khz</span> <span class="o">&gt;</span> <span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">adc_clk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_khz</span>
			<span class="o">-</span> <span class="n">stv0367cab_get_derot_freq</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">adc_clk</span><span class="p">)</span>
			<span class="o">-</span> <span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">adc_clk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_khz</span>
			<span class="o">-</span> <span class="n">stv0367cab_get_derot_freq</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">adc_clk</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">void stv0367cab_GetErrorCount(state, enum stv0367cab_mod QAMSize,</span>
<span class="c">			u32 symbol_rate, FE_367qam_Monitor *Monitor_results)</span>
<span class="c">{</span>
<span class="c">	stv0367cab_OptimiseNByteAndGetBER(state, QAMSize, symbol_rate, Monitor_results);</span>
<span class="c">	stv0367cab_GetPacketsCount(state, Monitor_results);</span>

<span class="c">	return;</span>
<span class="c">}</span>

<span class="c">static int stv0367cab_read_ber(struct dvb_frontend *fe, u32 *ber)</span>
<span class="c">{</span>
<span class="c">	struct stv0367_state *state = fe-&gt;demodulator_priv;</span>

<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">stv0367cab_get_rf_lvl</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">rfLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">RfAgcPwm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IfAgcPwm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">stv0367_writebits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_STDBY_ADCGP</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">RfAgcPwm</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_RF_AGC1_LEVEL_LO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_RF_AGC1_LEVEL_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">RfAgcPwm</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">RfAgcPwm</span> <span class="o">/</span> <span class="mi">1023</span><span class="p">;</span>

	<span class="n">IfAgcPwm</span> <span class="o">=</span>
		<span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_AGC_IF_PWMCMD_LO</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_AGC_IF_PWMCMD_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IfAgcPwm</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">)</span>
		<span class="n">IfAgcPwm</span> <span class="o">-=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">IfAgcPwm</span> <span class="o">+=</span> <span class="mi">2048</span><span class="p">;</span>

	<span class="n">IfAgcPwm</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">IfAgcPwm</span> <span class="o">/</span> <span class="mi">4095</span><span class="p">;</span>

	<span class="cm">/* For DTT75467 on NIM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RfAgcPwm</span> <span class="o">&lt;</span> <span class="mi">90</span>  <span class="o">&amp;&amp;</span> <span class="n">IfAgcPwm</span> <span class="o">&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RF_LOOKUP_TABLE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RfAgcPwm</span> <span class="o">&lt;=</span> <span class="n">stv0367cab_RF_LookUp1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">rfLevel</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">stv0367cab_RF_LookUp1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">RF_LOOKUP_TABLE_SIZE</span><span class="p">)</span>
			<span class="n">rfLevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">56</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/*if IF AGC&gt;10*/</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RF_LOOKUP_TABLE2_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IfAgcPwm</span> <span class="o">&lt;=</span> <span class="n">stv0367cab_RF_LookUp2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">rfLevel</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">stv0367cab_RF_LookUp2</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">RF_LOOKUP_TABLE2_SIZE</span><span class="p">)</span>
			<span class="n">rfLevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">72</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rfLevel</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367cab_read_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">s32</span> <span class="n">signal</span> <span class="o">=</span>  <span class="n">stv0367cab_get_rf_lvl</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: signal=%d dBm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">signal</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">72</span><span class="p">)</span>
		<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="p">(</span><span class="mi">22</span> <span class="o">+</span> <span class="n">signal</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1311</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: strength=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">strength</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367cab_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">noisepercentage</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">stv0367cab_mod</span> <span class="n">QAMSize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">power</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">QAMSize</span> <span class="o">=</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_QAM_MODE</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">QAMSize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM4</span>:
		<span class="n">power</span> <span class="o">=</span> <span class="mi">21904</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM16</span>:
		<span class="n">power</span> <span class="o">=</span> <span class="mi">20480</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM32</span>:
		<span class="n">power</span> <span class="o">=</span> <span class="mi">23040</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM64</span>:
		<span class="n">power</span> <span class="o">=</span> <span class="mi">21504</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM128</span>:
		<span class="n">power</span> <span class="o">=</span> <span class="mi">23616</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM256</span>:
		<span class="n">power</span> <span class="o">=</span> <span class="mi">21760</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM512</span>:
		<span class="n">power</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_CAB_MOD_QAM1024</span>:
		<span class="n">power</span> <span class="o">=</span> <span class="mi">21280</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">power</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regval</span> <span class="o">+=</span> <span class="p">(</span><span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_SNR_LO</span><span class="p">)</span>
			<span class="o">+</span> <span class="mi">256</span> <span class="o">*</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_SNR_HI</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">regval</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/*for average over 10 times in for loop above*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">power</span>
			<span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">stv0367_readbits</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F367CAB_SNR_PER</span><span class="p">)));</span>
		<span class="n">temp</span> <span class="o">/=</span> <span class="n">regval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* table values, not needed to calculate logarithms */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">5012</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">3981</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">93</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">3162</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">86</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">2512</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">79</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">1995</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">1585</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">65</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">1259</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">58</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">794</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">43</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">501</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">316</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">29</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">158</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">126</span><span class="p">)</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">noisepercentage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: noisepercentage=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">noisepercentage</span><span class="p">);</span>

	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="p">(</span><span class="n">noisepercentage</span> <span class="o">*</span> <span class="mi">65535</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stv0367cab_read_ucblcks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ucblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">corrected</span><span class="p">,</span> <span class="n">tscount</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ucblocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_RS_COUNTER_5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_RS_COUNTER_4</span><span class="p">);</span>
	<span class="n">corrected</span> <span class="o">=</span> <span class="p">(</span><span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_RS_COUNTER_3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_RS_COUNTER_2</span><span class="p">);</span>
	<span class="n">tscount</span> <span class="o">=</span> <span class="p">(</span><span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_RS_COUNTER_2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">R367CAB_RS_COUNTER_1</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: uncorrected blocks=%d corrected blocks=%d tscount=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">ucblocks</span><span class="p">,</span> <span class="n">corrected</span><span class="p">,</span> <span class="n">tscount</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">stv0367cab_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBC_ANNEX_A</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ST STV0367 DVB-C&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">47000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">862000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">=</span> <span class="mi">62500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">symbol_rate_min</span> <span class="o">=</span> <span class="mi">870000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">symbol_rate_max</span> <span class="o">=</span> <span class="mi">11700000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="mh">0x400</span> <span class="o">|</span><span class="cm">/* FE_CAN_QAM_4 */</span>
			<span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_32</span>  <span class="o">|</span>
			<span class="n">FE_CAN_QAM_64</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_128</span> <span class="o">|</span>
			<span class="n">FE_CAN_QAM_256</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">release</span>				<span class="o">=</span> <span class="n">stv0367_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>					<span class="o">=</span> <span class="n">stv0367cab_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span>					<span class="o">=</span> <span class="n">stv0367cab_sleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">i2c_gate_ctrl</span>				<span class="o">=</span> <span class="n">stv0367cab_gate_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_frontend</span>				<span class="o">=</span> <span class="n">stv0367cab_set_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend</span>				<span class="o">=</span> <span class="n">stv0367cab_get_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>				<span class="o">=</span> <span class="n">stv0367cab_read_status</span><span class="p">,</span>
<span class="cm">/*	.read_ber				= stv0367cab_read_ber, */</span>
	<span class="p">.</span><span class="n">read_signal_strength</span>			<span class="o">=</span> <span class="n">stv0367cab_read_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span>				<span class="o">=</span> <span class="n">stv0367cab_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span>				<span class="o">=</span> <span class="n">stv0367cab_read_ucblcks</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span>			<span class="o">=</span> <span class="n">stv0367_get_tune_settings</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">stv0367cab_attach</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">stv0367_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stv0367_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stv0367cab_state</span> <span class="o">*</span><span class="n">cab_state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* allocate memory for the internal state */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">cab_state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stv0367cab_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cab_state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* setup the state */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">cab_state</span><span class="o">-&gt;</span><span class="n">search_range</span> <span class="o">=</span> <span class="mi">280000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">cab_state</span> <span class="o">=</span> <span class="n">cab_state</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">stv0367cab_ops</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">stv0367_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xf000</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: chip_id = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>

	<span class="cm">/* check if the demod is there */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">!=</span> <span class="mh">0x50</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">!=</span> <span class="mh">0x60</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cab_state</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">stv0367cab_attach</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Set debug&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">i2c_debug</span><span class="p">,</span> <span class="s">&quot;Set i2c debug&quot;</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Igor M. Liplianin&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ST STV0367 DVB-C/T demodulator driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
