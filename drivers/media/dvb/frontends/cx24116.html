<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › cx24116.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cx24116.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    Conexant cx24116/cx24118 - DVBS/S2 Satellite demod/tuner driver</span>

<span class="cm">    Copyright (C) 2006-2008 Steven Toth &lt;stoth@hauppauge.com&gt;</span>
<span class="cm">    Copyright (C) 2006-2007 Georg Acher</span>
<span class="cm">    Copyright (C) 2007-2008 Darron Broad</span>
<span class="cm">	March 2007</span>
<span class="cm">	    Fixed some bugs.</span>
<span class="cm">	    Added diseqc support.</span>
<span class="cm">	    Added corrected signal strength support.</span>
<span class="cm">	August 2007</span>
<span class="cm">	    Sync with legacy version.</span>
<span class="cm">	    Some clean ups.</span>
<span class="cm">    Copyright (C) 2008 Igor Liplianin</span>
<span class="cm">	September, 9th 2008</span>
<span class="cm">	    Fixed locking on high symbol rates (&gt;30000).</span>
<span class="cm">	    Implement MPEG initialization parameter.</span>
<span class="cm">	January, 17th 2009</span>
<span class="cm">	    Fill set_voltage with actually control voltage code.</span>
<span class="cm">	    Correct set tone to not affect voltage.</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>

<span class="cp">#include &quot;dvb_frontend.h&quot;</span>
<span class="cp">#include &quot;cx24116.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Activates frontend debugging (default:0)&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(args...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (debug) \</span>
<span class="cp">			printk(KERN_INFO &quot;cx24116: &quot; args); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define CX24116_DEFAULT_FIRMWARE &quot;dvb-fe-cx24116.fw&quot;</span>
<span class="cp">#define CX24116_SEARCH_RANGE_KHZ 5000</span>

<span class="cm">/* known registers */</span>
<span class="cp">#define CX24116_REG_COMMAND (0x00)      </span><span class="cm">/* command args 0x00..0x1e */</span><span class="cp"></span>
<span class="cp">#define CX24116_REG_EXECUTE (0x1f)      </span><span class="cm">/* execute command */</span><span class="cp"></span>
<span class="cp">#define CX24116_REG_MAILBOX (0x96)      </span><span class="cm">/* FW or multipurpose mailbox? */</span><span class="cp"></span>
<span class="cp">#define CX24116_REG_RESET   (0x20)      </span><span class="cm">/* reset status &gt; 0     */</span><span class="cp"></span>
<span class="cp">#define CX24116_REG_SIGNAL  (0x9e)      </span><span class="cm">/* signal low           */</span><span class="cp"></span>
<span class="cp">#define CX24116_REG_SSTATUS (0x9d)      </span><span class="cm">/* signal high / status */</span><span class="cp"></span>
<span class="cp">#define CX24116_REG_QUALITY8 (0xa3)</span>
<span class="cp">#define CX24116_REG_QSTATUS (0xbc)</span>
<span class="cp">#define CX24116_REG_QUALITY0 (0xd5)</span>
<span class="cp">#define CX24116_REG_BER0    (0xc9)</span>
<span class="cp">#define CX24116_REG_BER8    (0xc8)</span>
<span class="cp">#define CX24116_REG_BER16   (0xc7)</span>
<span class="cp">#define CX24116_REG_BER24   (0xc6)</span>
<span class="cp">#define CX24116_REG_UCB0    (0xcb)</span>
<span class="cp">#define CX24116_REG_UCB8    (0xca)</span>
<span class="cp">#define CX24116_REG_CLKDIV  (0xf3)</span>
<span class="cp">#define CX24116_REG_RATEDIV (0xf9)</span>

<span class="cm">/* configured fec (not tuned) or actual FEC (tuned) 1=1/2 2=2/3 etc */</span>
<span class="cp">#define CX24116_REG_FECSTATUS (0x9c)</span>

<span class="cm">/* FECSTATUS bits */</span>
<span class="cm">/* mask to determine configured fec (not tuned) or actual fec (tuned) */</span>
<span class="cp">#define CX24116_FEC_FECMASK   (0x1f)</span>

<span class="cm">/* Select DVB-S demodulator, else DVB-S2 */</span>
<span class="cp">#define CX24116_FEC_DVBS      (0x20)</span>
<span class="cp">#define CX24116_FEC_UNKNOWN   (0x40)    </span><span class="cm">/* Unknown/unused */</span><span class="cp"></span>

<span class="cm">/* Pilot mode requested when tuning else always reset when tuned */</span>
<span class="cp">#define CX24116_FEC_PILOT     (0x80)</span>

<span class="cm">/* arg buffer size */</span>
<span class="cp">#define CX24116_ARGLEN (0x1e)</span>

<span class="cm">/* rolloff */</span>
<span class="cp">#define CX24116_ROLLOFF_020 (0x00)</span>
<span class="cp">#define CX24116_ROLLOFF_025 (0x01)</span>
<span class="cp">#define CX24116_ROLLOFF_035 (0x02)</span>

<span class="cm">/* pilot bit */</span>
<span class="cp">#define CX24116_PILOT_OFF (0x00)</span>
<span class="cp">#define CX24116_PILOT_ON (0x40)</span>

<span class="cm">/* signal status */</span>
<span class="cp">#define CX24116_HAS_SIGNAL   (0x01)</span>
<span class="cp">#define CX24116_HAS_CARRIER  (0x02)</span>
<span class="cp">#define CX24116_HAS_VITERBI  (0x04)</span>
<span class="cp">#define CX24116_HAS_SYNCLOCK (0x08)</span>
<span class="cp">#define CX24116_HAS_UNKNOWN1 (0x10)</span>
<span class="cp">#define CX24116_HAS_UNKNOWN2 (0x20)</span>
<span class="cp">#define CX24116_STATUS_MASK  (0x0f)</span>
<span class="cp">#define CX24116_SIGNAL_MASK  (0xc0)</span>

<span class="cp">#define CX24116_DISEQC_TONEOFF   (0)    </span><span class="cm">/* toneburst never sent */</span><span class="cp"></span>
<span class="cp">#define CX24116_DISEQC_TONECACHE (1)    </span><span class="cm">/* toneburst cached     */</span><span class="cp"></span>
<span class="cp">#define CX24116_DISEQC_MESGCACHE (2)    </span><span class="cm">/* message cached       */</span><span class="cp"></span>

<span class="cm">/* arg offset for DiSEqC */</span>
<span class="cp">#define CX24116_DISEQC_BURST  (1)</span>
<span class="cp">#define CX24116_DISEQC_ARG2_2 (2)   </span><span class="cm">/* unknown value=2 */</span><span class="cp"></span>
<span class="cp">#define CX24116_DISEQC_ARG3_0 (3)   </span><span class="cm">/* unknown value=0 */</span><span class="cp"></span>
<span class="cp">#define CX24116_DISEQC_ARG4_0 (4)   </span><span class="cm">/* unknown value=0 */</span><span class="cp"></span>
<span class="cp">#define CX24116_DISEQC_MSGLEN (5)</span>
<span class="cp">#define CX24116_DISEQC_MSGOFS (6)</span>

<span class="cm">/* DiSEqC burst */</span>
<span class="cp">#define CX24116_DISEQC_MINI_A (0)</span>
<span class="cp">#define CX24116_DISEQC_MINI_B (1)</span>

<span class="cm">/* DiSEqC tone burst */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">toneburst</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">toneburst</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">toneburst</span><span class="p">,</span> <span class="s">&quot;DiSEqC toneburst 0=OFF, 1=TONE CACHE, &quot;</span>\
	<span class="s">&quot;2=MESSAGE CACHE (default:1)&quot;</span><span class="p">);</span>

<span class="cm">/* SNR measurements */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">esno_snr</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">esno_snr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">esno_snr</span><span class="p">,</span> <span class="s">&quot;SNR return units, 0=PERCENTAGE 0-100, &quot;</span>\
	<span class="s">&quot;1=ESNO(db * 10) (default:0)&quot;</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">cmds</span> <span class="p">{</span>
	<span class="n">CMD_SET_VCO</span>     <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">CMD_TUNEREQUEST</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>
	<span class="n">CMD_MPEGCONFIG</span>  <span class="o">=</span> <span class="mh">0x13</span><span class="p">,</span>
	<span class="n">CMD_TUNERINIT</span>   <span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="n">CMD_BANDWIDTH</span>   <span class="o">=</span> <span class="mh">0x15</span><span class="p">,</span>
	<span class="n">CMD_GETAGC</span>      <span class="o">=</span> <span class="mh">0x19</span><span class="p">,</span>
	<span class="n">CMD_LNBCONFIG</span>   <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">CMD_LNBSEND</span>     <span class="o">=</span> <span class="mh">0x21</span><span class="p">,</span> <span class="cm">/* Formerly CMD_SEND_DISEQC */</span>
	<span class="n">CMD_LNBDCLEVEL</span>  <span class="o">=</span> <span class="mh">0x22</span><span class="p">,</span>
	<span class="n">CMD_SET_TONE</span>    <span class="o">=</span> <span class="mh">0x23</span><span class="p">,</span>
	<span class="n">CMD_UPDFWVERS</span>   <span class="o">=</span> <span class="mh">0x35</span><span class="p">,</span>
	<span class="n">CMD_TUNERSLEEP</span>  <span class="o">=</span> <span class="mh">0x36</span><span class="p">,</span>
	<span class="n">CMD_AGCCONTROL</span>  <span class="o">=</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="cm">/* Unknown */</span>
<span class="p">};</span>

<span class="cm">/* The Demod/Tuner can&#39;t easily provide these, we cache them */</span>
<span class="k">struct</span> <span class="n">cx24116_tuning</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">symbol_rate</span><span class="p">;</span>
	<span class="n">fe_spectral_inversion_t</span> <span class="n">inversion</span><span class="p">;</span>
	<span class="n">fe_code_rate_t</span> <span class="n">fec</span><span class="p">;</span>

	<span class="n">fe_delivery_system_t</span> <span class="n">delsys</span><span class="p">;</span>
	<span class="n">fe_modulation_t</span> <span class="n">modulation</span><span class="p">;</span>
	<span class="n">fe_pilot_t</span> <span class="n">pilot</span><span class="p">;</span>
	<span class="n">fe_rolloff_t</span> <span class="n">rolloff</span><span class="p">;</span>

	<span class="cm">/* Demod values */</span>
	<span class="n">u8</span> <span class="n">fec_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fec_mask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">inversion_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pilot_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rolloff_val</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Basic commands that are sent to the firmware */</span>
<span class="k">struct</span> <span class="n">cx24116_cmd</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">args</span><span class="p">[</span><span class="n">CX24116_ARGLEN</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cx24116_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="n">frontend</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cx24116_tuning</span> <span class="n">dcur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx24116_tuning</span> <span class="n">dnxt</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">skip_fw_load</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">burst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx24116_cmd</span> <span class="n">dsec_cmd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_writereg</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cx24116: %s: write reg 0x%02x, value 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: writereg error(err == %i, reg == 0x%02x,&quot;</span>
			 <span class="s">&quot; value == 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Bulk byte writes to a single I2C address, for 32k firmware load */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_writeregN</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			     <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unable to kmalloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cx24116: %s:  write regN 0x%02x, len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: writereg error(err == %i, reg == 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_readreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">b1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b0</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b1</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: reg=0x%x (error=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cx24116: read reg 0x%02x, value 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">reg</span><span class="p">,</span> <span class="n">b1</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">b1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_set_inversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
	<span class="n">fe_spectral_inversion_t</span> <span class="n">inversion</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">inversion</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">inversion</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INVERSION_OFF</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">inversion_val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INVERSION_ON</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">inversion_val</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INVERSION_AUTO</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">inversion_val</span> <span class="o">=</span> <span class="mh">0x0C</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">inversion</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * modfec (modulation and FEC)</span>
<span class="cm"> * ===========================</span>
<span class="cm"> *</span>
<span class="cm"> * MOD          FEC             mask/val    standard</span>
<span class="cm"> * ----         --------        ----------- --------</span>
<span class="cm"> * QPSK         FEC_1_2         0x02 0x02+X DVB-S</span>
<span class="cm"> * QPSK         FEC_2_3         0x04 0x02+X DVB-S</span>
<span class="cm"> * QPSK         FEC_3_4         0x08 0x02+X DVB-S</span>
<span class="cm"> * QPSK         FEC_4_5         0x10 0x02+X DVB-S (?)</span>
<span class="cm"> * QPSK         FEC_5_6         0x20 0x02+X DVB-S</span>
<span class="cm"> * QPSK         FEC_6_7         0x40 0x02+X DVB-S</span>
<span class="cm"> * QPSK         FEC_7_8         0x80 0x02+X DVB-S</span>
<span class="cm"> * QPSK         FEC_8_9         0x01 0x02+X DVB-S (?) (NOT SUPPORTED?)</span>
<span class="cm"> * QPSK         AUTO            0xff 0x02+X DVB-S</span>
<span class="cm"> *</span>
<span class="cm"> * For DVB-S high byte probably represents FEC</span>
<span class="cm"> * and low byte selects the modulator. The high</span>
<span class="cm"> * byte is search range mask. Bit 5 may turn</span>
<span class="cm"> * on DVB-S and remaining bits represent some</span>
<span class="cm"> * kind of calibration (how/what i do not know).</span>
<span class="cm"> *</span>
<span class="cm"> * Eg.(2/3) szap &quot;Zone Horror&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * mask/val = 0x04, 0x20</span>
<span class="cm"> * status 1f | signal c3c0 | snr a333 | ber 00000098 | unc 0 | FE_HAS_LOCK</span>
<span class="cm"> *</span>
<span class="cm"> * mask/val = 0x04, 0x30</span>
<span class="cm"> * status 1f | signal c3c0 | snr a333 | ber 00000000 | unc 0 | FE_HAS_LOCK</span>
<span class="cm"> *</span>
<span class="cm"> * After tuning FECSTATUS contains actual FEC</span>
<span class="cm"> * in use numbered 1 through to 8 for 1/2 .. 2/3 etc</span>
<span class="cm"> *</span>
<span class="cm"> * NBC=NOT/NON BACKWARD COMPATIBLE WITH DVB-S (DVB-S2 only)</span>
<span class="cm"> *</span>
<span class="cm"> * NBC-QPSK     FEC_1_2         0x00, 0x04      DVB-S2</span>
<span class="cm"> * NBC-QPSK     FEC_3_5         0x00, 0x05      DVB-S2</span>
<span class="cm"> * NBC-QPSK     FEC_2_3         0x00, 0x06      DVB-S2</span>
<span class="cm"> * NBC-QPSK     FEC_3_4         0x00, 0x07      DVB-S2</span>
<span class="cm"> * NBC-QPSK     FEC_4_5         0x00, 0x08      DVB-S2</span>
<span class="cm"> * NBC-QPSK     FEC_5_6         0x00, 0x09      DVB-S2</span>
<span class="cm"> * NBC-QPSK     FEC_8_9         0x00, 0x0a      DVB-S2</span>
<span class="cm"> * NBC-QPSK     FEC_9_10        0x00, 0x0b      DVB-S2</span>
<span class="cm"> *</span>
<span class="cm"> * NBC-8PSK     FEC_3_5         0x00, 0x0c      DVB-S2</span>
<span class="cm"> * NBC-8PSK     FEC_2_3         0x00, 0x0d      DVB-S2</span>
<span class="cm"> * NBC-8PSK     FEC_3_4         0x00, 0x0e      DVB-S2</span>
<span class="cm"> * NBC-8PSK     FEC_5_6         0x00, 0x0f      DVB-S2</span>
<span class="cm"> * NBC-8PSK     FEC_8_9         0x00, 0x10      DVB-S2</span>
<span class="cm"> * NBC-8PSK     FEC_9_10        0x00, 0x11      DVB-S2</span>
<span class="cm"> *</span>
<span class="cm"> * For DVB-S2 low bytes selects both modulator</span>
<span class="cm"> * and FEC. High byte is meaningless here. To</span>
<span class="cm"> * set pilot, bit 6 (0x40) is set. When inspecting</span>
<span class="cm"> * FECSTATUS bit 7 (0x80) represents the pilot</span>
<span class="cm"> * selection whilst not tuned. When tuned, actual FEC</span>
<span class="cm"> * in use is found in FECSTATUS as per above. Pilot</span>
<span class="cm"> * value is reset.</span>
<span class="cm"> */</span>

<span class="cm">/* A table of modulation, fec and configuration bytes for the demod.</span>
<span class="cm"> * Not all S2 mmodulation schemes are support and not all rates with</span>
<span class="cm"> * a scheme are support. Especially, no auto detect when in S2 mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cx24116_modfec</span> <span class="p">{</span>
	<span class="n">fe_delivery_system_t</span> <span class="n">delivery_system</span><span class="p">;</span>
	<span class="n">fe_modulation_t</span> <span class="n">modulation</span><span class="p">;</span>
	<span class="n">fe_code_rate_t</span> <span class="n">fec</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">;</span>	<span class="cm">/* In DVBS mode this is used to autodetect */</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>		<span class="cm">/* Passed to the firmware to indicate mode selection */</span>
<span class="p">}</span> <span class="n">CX24116_MODFEC_MODES</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="cm">/* QPSK. For unknown rates we set hardware to auto detect 0xfe 0x30 */</span>

 <span class="cm">/*mod   fec       mask  val */</span>
 <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_NONE</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x30</span> <span class="p">},</span>
 <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_1_2</span><span class="p">,</span>  <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x2e</span> <span class="p">},</span> <span class="cm">/* 00000010 00101110 */</span>
 <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_2_3</span><span class="p">,</span>  <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x2f</span> <span class="p">},</span> <span class="cm">/* 00000100 00101111 */</span>
 <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_3_4</span><span class="p">,</span>  <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x30</span> <span class="p">},</span> <span class="cm">/* 00001000 00110000 */</span>
 <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_4_5</span><span class="p">,</span>  <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x30</span> <span class="p">},</span> <span class="cm">/* 000?0000 ?        */</span>
 <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_5_6</span><span class="p">,</span>  <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x31</span> <span class="p">},</span> <span class="cm">/* 00100000 00110001 */</span>
 <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_6_7</span><span class="p">,</span>  <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x30</span> <span class="p">},</span> <span class="cm">/* 0?000000 ?        */</span>
 <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_7_8</span><span class="p">,</span>  <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x32</span> <span class="p">},</span> <span class="cm">/* 10000000 00110010 */</span>
 <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_8_9</span><span class="p">,</span>  <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x30</span> <span class="p">},</span> <span class="cm">/* 0000000? ?        */</span>
 <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_AUTO</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x30</span> <span class="p">},</span>
 <span class="cm">/* NBC-QPSK */</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_1_2</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_3_5</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span> <span class="p">},</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_2_3</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x06</span> <span class="p">},</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_3_4</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x07</span> <span class="p">},</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_4_5</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_5_6</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x09</span> <span class="p">},</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_8_9</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">QPSK</span><span class="p">,</span> <span class="n">FEC_9_10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0b</span> <span class="p">},</span>
 <span class="cm">/* 8PSK */</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">PSK_8</span><span class="p">,</span> <span class="n">FEC_3_5</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0c</span> <span class="p">},</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">PSK_8</span><span class="p">,</span> <span class="n">FEC_2_3</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0d</span> <span class="p">},</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">PSK_8</span><span class="p">,</span> <span class="n">FEC_3_4</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0e</span> <span class="p">},</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">PSK_8</span><span class="p">,</span> <span class="n">FEC_5_6</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0f</span> <span class="p">},</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">PSK_8</span><span class="p">,</span> <span class="n">FEC_8_9</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
 <span class="p">{</span> <span class="n">SYS_DVBS2</span><span class="p">,</span> <span class="n">PSK_8</span><span class="p">,</span> <span class="n">FEC_9_10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span> <span class="p">},</span>
 <span class="cm">/*</span>
<span class="cm">  * `val&#39; can be found in the FECSTATUS register when tuning.</span>
<span class="cm">  * FECSTATUS will give the actual FEC in use if tuning was successful.</span>
<span class="cm">  */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_lookup_fecmod</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
	<span class="n">fe_delivery_system_t</span> <span class="n">d</span><span class="p">,</span> <span class="n">fe_modulation_t</span> <span class="n">m</span><span class="p">,</span> <span class="n">fe_code_rate_t</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s(0x%02x,0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">CX24116_MODFEC_MODES</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">d</span> <span class="o">==</span> <span class="n">CX24116_MODFEC_MODES</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">delivery_system</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">CX24116_MODFEC_MODES</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="n">CX24116_MODFEC_MODES</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fec</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_set_fec</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
	<span class="n">fe_delivery_system_t</span> <span class="n">delsys</span><span class="p">,</span> <span class="n">fe_modulation_t</span> <span class="n">mod</span><span class="p">,</span> <span class="n">fe_code_rate_t</span> <span class="n">fec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s(0x%02x,0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">fec</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_lookup_fecmod</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">delsys</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">fec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">fec</span> <span class="o">=</span> <span class="n">fec</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">fec_val</span> <span class="o">=</span> <span class="n">CX24116_MODFEC_MODES</span><span class="p">[</span><span class="n">ret</span><span class="p">].</span><span class="n">val</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">fec_mask</span> <span class="o">=</span> <span class="n">CX24116_MODFEC_MODES</span><span class="p">[</span><span class="n">ret</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() mask/val = 0x%02x/0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">fec_mask</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">fec_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_set_symbolrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="cm">/*  check if symbol rate is within limits */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">symbol_rate_max</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">symbol_rate_min</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() unsupported symbol_rate = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">symbol_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() symbol_rate = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cx24116_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_firmware_ondemand</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">skip_fw_load</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Load firmware */</span>
		<span class="cm">/* request the firmware, this will block until loaded */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Waiting for firmware upload (%s)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">CX24116_DEFAULT_FIRMWARE</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">CX24116_DEFAULT_FIRMWARE</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Waiting for firmware upload(2)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: No firmware uploaded &quot;</span>
				<span class="s">&quot;(timeout or file not found?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Make sure we don&#39;t recurse back through here</span>
<span class="cm">		 * during loading */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">skip_fw_load</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_load_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Writing firmware to device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>

		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Firmware upload %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;complete&quot;</span> <span class="o">:</span> <span class="s">&quot;failed&quot;</span><span class="p">);</span>

		<span class="cm">/* Ensure firmware is always loaded if required */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">skip_fw_load</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Take a basic firmware command structure, format it</span>
<span class="cm"> * and forward it for processing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_cmd_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx24116_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Load the firmware if required */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_firmware_ondemand</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s(): Unable initialise the firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write the command */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: 0x%02x == 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Start execution and wait for cmd to terminate */</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_EXECUTE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_EXECUTE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Avoid looping forever if the firmware does</span>
<span class="cm">				not respond */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s() Firmware not responding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx24116_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">remaining</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vers</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Firmware is %zu bytes (%02x %02x .. %02x %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			<span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
			<span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* Toggle 88x SRST pin to reset demod */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_device</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_device</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="cm">/* Begin the firmware load process */</span>
	<span class="cm">/* Prepare the demod, load the firmware, cleanup after load */</span>

	<span class="cm">/* Init PLL */</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>

	<span class="cm">/* Start PLL */</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Unknown */</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_CLKDIV</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_RATEDIV</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Unknown */</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Split firmware to the max I2C write len and write.</span>
<span class="cm">	 * Writes whole firmware as one write when i2c_wr_max is set to 0. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">i2c_wr_max</span><span class="p">)</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">i2c_wr_max</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span> <span class="cm">/* enough for 32k firmware */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">remaining</span> <span class="o">-=</span> <span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">remaining</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">cx24116_writeregN</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">remaining</span><span class="p">],</span>
			<span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>

	<span class="cm">/* Firmware CMD 10: VCO config */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_SET_VCO</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xdc</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xda</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xae</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x9d</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfc</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_SSTATUS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Firmware CMD 14: Tuner config */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_TUNERINIT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Firmware CMD 13: MPEG config */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_MPEGCONFIG</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x75</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">mpg_clk_pos_pol</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">mpg_clk_pos_pol</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Firmware CMD 35: Get firmware version */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_UPDFWVERS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">vers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_MAILBOX</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: FW version %i.%i.%i.%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">vers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vers</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vers</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_SSTATUS</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">CX24116_STATUS_MASK</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: status = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>

	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="n">CX24116_HAS_SIGNAL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_SIGNAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="n">CX24116_HAS_CARRIER</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_CARRIER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="n">CX24116_HAS_VITERBI</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="n">CX24116_HAS_SYNCLOCK</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_SYNC</span> <span class="o">|</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span>  <span class="p">(</span><span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_BER24</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_BER16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_BER8</span><span class="p">)</span>  <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">|</span>
		 <span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_BER0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TODO Determine function and scale appropriately */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">signal_strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx24116_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sig_reading</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Firmware CMD 19: Get AGC */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_GETAGC</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sig_reading</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
			<span class="n">CX24116_REG_SSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CX24116_SIGNAL_MASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_SIGNAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="o">*</span><span class="n">signal_strength</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">sig_reading</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: raw / cooked = 0x%04x / 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">sig_reading</span><span class="p">,</span> <span class="o">*</span><span class="n">signal_strength</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SNR (0..100)% = (sig &amp; 0xf0) * 10 + (sig &amp; 0x0f) * 10 / 16 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_read_snr_pct</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">snr_reading</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">snr_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="cm">/* 10 x Table (rounded up) */</span>
		<span class="mh">0x00000</span><span class="p">,</span> <span class="mh">0x0199A</span><span class="p">,</span> <span class="mh">0x03333</span><span class="p">,</span> <span class="mh">0x04ccD</span><span class="p">,</span> <span class="mh">0x06667</span><span class="p">,</span>
		<span class="mh">0x08000</span><span class="p">,</span> <span class="mh">0x0999A</span><span class="p">,</span> <span class="mh">0x0b333</span><span class="p">,</span> <span class="mh">0x0cccD</span><span class="p">,</span> <span class="mh">0x0e667</span><span class="p">,</span>
		<span class="mh">0x10000</span><span class="p">,</span> <span class="mh">0x1199A</span><span class="p">,</span> <span class="mh">0x13333</span><span class="p">,</span> <span class="mh">0x14ccD</span><span class="p">,</span> <span class="mh">0x16667</span><span class="p">,</span>
		<span class="mh">0x18000</span> <span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">snr_reading</span> <span class="o">=</span> <span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_QUALITY0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snr_reading</span> <span class="o">&gt;=</span> <span class="mh">0xa0</span> <span class="cm">/* 100% */</span><span class="p">)</span>
		<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">snr_tab</span><span class="p">[(</span><span class="n">snr_reading</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">snr_tab</span><span class="p">[(</span><span class="n">snr_reading</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: raw / cooked = 0x%02x / 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">snr_reading</span><span class="p">,</span> <span class="o">*</span><span class="n">snr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The reelbox patches show the value in the registers represents</span>
<span class="cm"> * ESNO, from 0-&gt;30db (values 0-&gt;300). We provide this value by</span>
<span class="cm"> * default.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_read_snr_esno</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_QUALITY8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
		<span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_QUALITY0</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: raw 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">snr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esno_snr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cx24116_read_snr_esno</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">snr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">cx24116_read_snr_pct</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">snr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_read_ucblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ucblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ucblocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_UCB8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_UCB0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Overwrite the current tuning params, we are about to tune */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx24116_clone_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Wait for LNB */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_wait_for_lnb</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() qstatus = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_QSTATUS</span><span class="p">));</span>

	<span class="cm">/* Wait for up to 300 ms */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_QSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s(): LNB not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span> <span class="cm">/* -EBUSY ? */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_set_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="n">fe_sec_voltage_t</span> <span class="n">voltage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">voltage</span> <span class="o">==</span> <span class="n">SEC_VOLTAGE_13</span> <span class="o">?</span> <span class="s">&quot;SEC_VOLTAGE_13&quot;</span> <span class="o">:</span>
		<span class="n">voltage</span> <span class="o">==</span> <span class="n">SEC_VOLTAGE_18</span> <span class="o">?</span> <span class="s">&quot;SEC_VOLTAGE_18&quot;</span> <span class="o">:</span> <span class="s">&quot;??&quot;</span><span class="p">);</span>

	<span class="cm">/* Wait for LNB ready */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_wait_for_lnb</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Wait for voltage/min repeat delay */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_LNBDCLEVEL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">==</span> <span class="n">SEC_VOLTAGE_18</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>

	<span class="cm">/* Min delay time before DiSEqC send */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_set_tone</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="n">fe_sec_tone_mode_t</span> <span class="n">tone</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">tone</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tone</span> <span class="o">!=</span> <span class="n">SEC_TONE_ON</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tone</span> <span class="o">!=</span> <span class="n">SEC_TONE_OFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid, tone=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">tone</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for LNB ready */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_wait_for_lnb</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Min delay time after DiSEqC send */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span> <span class="cm">/* XXX determine is FW does this, see send_diseqc/burst */</span>

	<span class="cm">/* Now we set the tone */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_SET_TONE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tone</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_TONE_ON</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: setting tone on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_TONE_OFF</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: setting tone off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>

	<span class="cm">/* Min delay time before DiSEqC send */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span> <span class="cm">/* XXX determine is FW does this, see send_diseqc/burst */</span>

	<span class="k">return</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Initialise DiSEqC */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_diseqc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx24116_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Firmware CMD 20: LNB/DiSEqC config */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_LNBCONFIG</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8f</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">toneburst</span> <span class="o">==</span> <span class="n">CX24116_DISEQC_TONEOFF</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Prepare a DiSEqC command */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_LNBSEND</span><span class="p">;</span>

	<span class="cm">/* DiSEqC burst */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_BURST</span><span class="p">]</span>  <span class="o">=</span> <span class="n">CX24116_DISEQC_MINI_A</span><span class="p">;</span>

	<span class="cm">/* Unknown */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_ARG2_2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_ARG3_0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="cm">/* Continuation flag? */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_ARG4_0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="cm">/* DiSEqC message length */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_MSGLEN</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="cm">/* Command length */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">CX24116_DISEQC_MSGOFS</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send DiSEqC message with derived burst (hack) || previous burst */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_send_diseqc_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">dvb_diseqc_master_cmd</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Dump DiSEqC message */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cx24116: %s(&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="p">;)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;0x%02x&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;, &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;) toneburst=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">toneburst</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Validate length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">CX24116_ARGLEN</span> <span class="o">-</span> <span class="n">CX24116_DISEQC_MSGOFS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* DiSEqC message */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_MSGOFS</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* DiSEqC message length */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_MSGLEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">;</span>

	<span class="cm">/* Command length */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">CX24116_DISEQC_MSGOFS</span> <span class="o">+</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_MSGLEN</span><span class="p">];</span>

	<span class="cm">/* DiSEqC toneburst */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">toneburst</span> <span class="o">==</span> <span class="n">CX24116_DISEQC_MESGCACHE</span><span class="p">)</span>
		<span class="cm">/* Message is cached */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">toneburst</span> <span class="o">==</span> <span class="n">CX24116_DISEQC_TONEOFF</span><span class="p">)</span>
		<span class="cm">/* Message is sent without burst */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_BURST</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">toneburst</span> <span class="o">==</span> <span class="n">CX24116_DISEQC_TONECACHE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Message is sent with derived else cached burst</span>
<span class="cm">		 *</span>
<span class="cm">		 * WRITE PORT GROUP COMMAND 38</span>
<span class="cm">		 *</span>
<span class="cm">		 * 0/A/A: E0 10 38 F0..F3</span>
<span class="cm">		 * 1/B/B: E0 10 38 F4..F7</span>
<span class="cm">		 * 2/C/A: E0 10 38 F8..FB</span>
<span class="cm">		 * 3/D/B: E0 10 38 FC..FF</span>
<span class="cm">		 *</span>
<span class="cm">		 * databyte[3]= 8421:8421</span>
<span class="cm">		 *              ABCD:WXYZ</span>
<span class="cm">		 *              CLR :SET</span>
<span class="cm">		 *</span>
<span class="cm">		 *              WX= PORT SELECT 0..3    (X=TONEBURST)</span>
<span class="cm">		 *              Y = VOLTAGE             (0=13V, 1=18V)</span>
<span class="cm">		 *              Z = BAND                (0=LOW, 1=HIGH(22K))</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x38</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_BURST</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s burst=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_BURST</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for LNB ready */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_wait_for_lnb</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Wait for voltage/min repeat delay */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Command */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait for send</span>
<span class="cm">	 *</span>
<span class="cm">	 * Eutelsat spec:</span>
<span class="cm">	 * &gt;15ms delay          + (XXX determine if FW does this, see set_tone)</span>
<span class="cm">	 *  13.5ms per byte     +</span>
<span class="cm">	 * &gt;15ms delay          +</span>
<span class="cm">	 *  12.5ms burst        +</span>
<span class="cm">	 * &gt;15ms delay            (XXX determine if FW does this, see set_tone)</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_MSGLEN</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">toneburst</span> <span class="o">==</span> <span class="n">CX24116_DISEQC_TONEOFF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">30</span> <span class="o">:</span> <span class="mi">60</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send DiSEqC burst */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_diseqc_send_burst</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="n">fe_sec_mini_cmd_t</span> <span class="n">burst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s(%d) toneburst=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">burst</span><span class="p">,</span> <span class="n">toneburst</span><span class="p">);</span>

	<span class="cm">/* DiSEqC burst */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">burst</span> <span class="o">==</span> <span class="n">SEC_MINI_A</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_BURST</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">CX24116_DISEQC_MINI_A</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">burst</span> <span class="o">==</span> <span class="n">SEC_MINI_B</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_BURST</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">CX24116_DISEQC_MINI_B</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* DiSEqC toneburst */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">toneburst</span> <span class="o">!=</span> <span class="n">CX24116_DISEQC_MESGCACHE</span><span class="p">)</span>
		<span class="cm">/* Burst is cached */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Burst is to be sent with cached message */</span>

	<span class="cm">/* Wait for LNB ready */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_wait_for_lnb</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Wait for voltage/min repeat delay */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Command */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for send</span>
<span class="cm">	 *</span>
<span class="cm">	 * Eutelsat spec:</span>
<span class="cm">	 * &gt;15ms delay          + (XXX determine if FW does this, see set_tone)</span>
<span class="cm">	 *  13.5ms per byte     +</span>
<span class="cm">	 * &gt;15ms delay          +</span>
<span class="cm">	 *  12.5ms burst        +</span>
<span class="cm">	 * &gt;15ms delay            (XXX determine if FW does this, see set_tone)</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dsec_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">CX24116_DISEQC_MSGLEN</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">60</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx24116_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">cx24116_ops</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">cx24116_attach</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cx24116_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* allocate memory for the internal state */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx24116_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>

	<span class="cm">/* check if the demod is present */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mh">0x0501</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Invalid probe, probably not a CX24116 device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create dvb_frontend */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx24116_ops</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

<span class="nl">error2:</span> <span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="nl">error1:</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cx24116_attach</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Initialise or wake up device</span>
<span class="cm"> *</span>
<span class="cm"> * Power config will reset and load initial firmware if required</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_initfe</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx24116_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Power on */</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Firmware CMD 36: Power config */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_TUNERSLEEP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_diseqc_init</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* HVR-4000 needs this */</span>
	<span class="k">return</span> <span class="n">cx24116_set_voltage</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SEC_VOLTAGE_13</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Put device to sleep</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx24116_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Firmware CMD 36: Power config */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_TUNERSLEEP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Power off (Shutdown clocks) */</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* dvb-core told us to tune, the tv property cache will be complete,</span>
<span class="cm"> * it&#39;s safe for is to pull values and use them for tuning purposes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx24116_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx24116_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">fe_status_t</span> <span class="n">tunerstat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">retune</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_DVBS</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: DVB-S delivery system selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/* Only QPSK is supported for DVB-S */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">!=</span> <span class="n">QPSK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: unsupported modulation selected (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Pilot doesn&#39;t exist in DVB-S, turn bit off */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">pilot_val</span> <span class="o">=</span> <span class="n">CX24116_PILOT_OFF</span><span class="p">;</span>

		<span class="cm">/* DVB-S only supports 0.35 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">rolloff</span> <span class="o">!=</span> <span class="n">ROLLOFF_35</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: unsupported rolloff selected (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">rolloff_val</span> <span class="o">=</span> <span class="n">CX24116_ROLLOFF_035</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SYS_DVBS2</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: DVB-S2 delivery system selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * NBC 8PSK/QPSK with DVB-S is supported for DVB-S2,</span>
<span class="cm">		 * but not hardware auto detection</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">!=</span> <span class="n">PSK_8</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">!=</span> <span class="n">QPSK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: unsupported modulation selected (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">pilot</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PILOT_AUTO</span>:	<span class="cm">/* Not supported but emulated */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">pilot_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QPSK</span><span class="p">)</span>
				<span class="o">?</span> <span class="n">CX24116_PILOT_OFF</span> <span class="o">:</span> <span class="n">CX24116_PILOT_ON</span><span class="p">;</span>
			<span class="n">retune</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PILOT_OFF</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">pilot_val</span> <span class="o">=</span> <span class="n">CX24116_PILOT_OFF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PILOT_ON</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">pilot_val</span> <span class="o">=</span> <span class="n">CX24116_PILOT_ON</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: unsupported pilot mode selected (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pilot</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ROLLOFF_20</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">rolloff_val</span> <span class="o">=</span> <span class="n">CX24116_ROLLOFF_020</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROLLOFF_25</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">rolloff_val</span> <span class="o">=</span> <span class="n">CX24116_ROLLOFF_025</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROLLOFF_35</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">rolloff_val</span> <span class="o">=</span> <span class="n">CX24116_ROLLOFF_035</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROLLOFF_AUTO</span>:	<span class="cm">/* Rolloff must be explicit */</span>
		<span class="nl">default:</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: unsupported rolloff selected (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: unsupported delivery system selected (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">pilot</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pilot</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dnxt</span><span class="p">.</span><span class="n">rolloff</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_set_inversion</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span>  <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* FEC_NONE/AUTO for DVB-S2 is not supported and detected here */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_set_fec</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">fec_inner</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span>  <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_set_symbolrate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span>  <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* discard the &#39;current&#39; tuning parameters and prepare to tune */</span>
	<span class="n">cx24116_clone_params</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:   delsys      = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">delsys</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:   modulation  = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">modulation</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:   frequency   = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">frequency</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:   pilot       = %d (val = 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">pilot</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">pilot_val</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:   retune      = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">retune</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:   rolloff     = %d (val = 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">rolloff</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">rolloff_val</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:   symbol_rate = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">symbol_rate</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:   FEC         = %d (mask/val = 0x%02x/0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">fec</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">fec_mask</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">fec_val</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s:   Inversion   = %d (val = 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">inversion</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">inversion_val</span><span class="p">);</span>

	<span class="cm">/* This is also done in advise/acquire on HVR4000 but not on LITE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_ts_params</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_ts_params</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set/Reset B/W */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_BANDWIDTH</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Prepare a tune request */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_TUNEREQUEST</span><span class="p">;</span>

	<span class="cm">/* Frequency */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0x00ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0x0000ff</span><span class="p">);</span>

	<span class="cm">/* Symbol Rate */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">symbol_rate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">symbol_rate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>

	<span class="cm">/* Automatic Inversion */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">inversion_val</span><span class="p">;</span>

	<span class="cm">/* Modulation / FEC / Pilot */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">fec_val</span> <span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">pilot_val</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="n">CX24116_SEARCH_RANGE_KHZ</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="n">CX24116_SEARCH_RANGE_KHZ</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">rolloff_val</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">fec_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">symbol_rate</span> <span class="o">&gt;</span> <span class="mi">30000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x77</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x36</span><span class="p">;</span>
		<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_CLKDIV</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
		<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_RATEDIV</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFA</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">;</span>
		<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_CLKDIV</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>
		<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_RATEDIV</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span>

	<span class="cm">/* We need to support pilot and non-pilot tuning in the</span>
<span class="cm">	 * driver automatically. This is a workaround for because</span>
<span class="cm">	 * the demod does not support autodetect.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Reset status register */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cx24116_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_SSTATUS</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">CX24116_SIGNAL_MASK</span><span class="p">;</span>
		<span class="n">cx24116_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CX24116_REG_SSTATUS</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="cm">/* Tune */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Wait for up to 500 ms before retrying</span>
<span class="cm">		 *</span>
<span class="cm">		 * If we are able to tune then generally it occurs within 100ms.</span>
<span class="cm">		 * If it takes longer, try a different toneburst setting.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx24116_read_status</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tunerstat</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">tunerstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FE_HAS_SIGNAL</span> <span class="o">|</span> <span class="n">FE_HAS_SYNC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="n">FE_HAS_SIGNAL</span> <span class="o">|</span> <span class="n">FE_HAS_SYNC</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Tuned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">tuned</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Not tuned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/* Toggle pilot bit when in auto-pilot */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dcur</span><span class="p">.</span><span class="n">pilot</span> <span class="o">==</span> <span class="n">PILOT_AUTO</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">^=</span> <span class="n">CX24116_PILOT_ON</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">retune</span><span class="p">);</span>

<span class="nl">tuned:</span>  <span class="cm">/* Set/Reset B/W */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_BANDWIDTH</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cx24116_cmd_execute</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_tune</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">bool</span> <span class="n">re_tune</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode_flags</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">delay</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * It is safe to discard &quot;params&quot; here, as the DVB core will sync</span>
<span class="cm">	 * fe-&gt;dtv_property_cache with fepriv-&gt;parameters_in, where the</span>
<span class="cm">	 * DVBv3 params are stored. The only practical usage for it indicate</span>
<span class="cm">	 * that re-tuning is needed, e. g. (fepriv-&gt;state &amp; FESTATE_RETUNE) is</span>
<span class="cm">	 * true.</span>
<span class="cm">	 */</span>

	<span class="o">*</span><span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">re_tune</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">cx24116_set_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cx24116_read_status</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx24116_get_algo</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">DVBFE_ALGO_HW</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">cx24116_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBS</span><span class="p">,</span> <span class="n">SYS_DVBS2</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Conexant CX24116/CX24118&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">950000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">2150000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">=</span> <span class="mi">1011</span><span class="p">,</span> <span class="cm">/* kHz for QPSK frontends */</span>
		<span class="p">.</span><span class="n">frequency_tolerance</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">symbol_rate_min</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">symbol_rate_max</span> <span class="o">=</span> <span class="mi">45000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">FE_CAN_INVERSION_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span>
			<span class="n">FE_CAN_FEC_4_5</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_6_7</span> <span class="o">|</span>
			<span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_2G_MODULATION</span> <span class="o">|</span>
			<span class="n">FE_CAN_QPSK</span> <span class="o">|</span> <span class="n">FE_CAN_RECOVER</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">cx24116_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">cx24116_initfe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">cx24116_sleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">cx24116_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">cx24116_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">cx24116_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">cx24116_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">cx24116_read_ucblocks</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tone</span> <span class="o">=</span> <span class="n">cx24116_set_tone</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_voltage</span> <span class="o">=</span> <span class="n">cx24116_set_voltage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">diseqc_send_master_cmd</span> <span class="o">=</span> <span class="n">cx24116_send_diseqc_msg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">diseqc_send_burst</span> <span class="o">=</span> <span class="n">cx24116_diseqc_send_burst</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend_algo</span> <span class="o">=</span> <span class="n">cx24116_get_algo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tune</span> <span class="o">=</span> <span class="n">cx24116_tune</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">cx24116_set_frontend</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;DVB Frontend module for Conexant cx24116/cx24118 hardware&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Steven Toth&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
