<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › dib8000.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dib8000.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux-DVB Driver for DiBcom&#39;s DiB8000 chip (ISDB-T).</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 DiBcom (http://www.dibcom.fr/)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> *  modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *  published by the Free Software Foundation, version 2.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &quot;dvb_math.h&quot;</span>

<span class="cp">#include &quot;dvb_frontend.h&quot;</span>

<span class="cp">#include &quot;dib8000.h&quot;</span>

<span class="cp">#define LAYER_ALL -1</span>
<span class="cp">#define LAYER_A   1</span>
<span class="cp">#define LAYER_B   2</span>
<span class="cp">#define LAYER_C   3</span>

<span class="cp">#define FE_CALLBACK_TIME_NEVER 0xffffffff</span>
<span class="cp">#define MAX_NUMBER_OF_FRONTENDS 6</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;turn on debugging (default: 0)&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(args...) do { if (debug) { printk(KERN_DEBUG &quot;DiB8000: &quot;); printk(args); printk(&quot;\n&quot;); } } while (0)</span>

<span class="cp">#define FE_STATUS_TUNE_FAILED 0</span>

<span class="k">struct</span> <span class="n">i2c_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">i2c_read_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="o">*</span><span class="n">i2c_buffer_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_config</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">i2c_device</span> <span class="n">i2c</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dibx000_i2c_master</span> <span class="n">i2c_master</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">wbd_ref</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">current_band</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">current_bandwidth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dibx000_agc_config</span> <span class="o">*</span><span class="n">current_agc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timf_default</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">div_force_off</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">div_state</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">div_sync_wait</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">agc_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">differential_constellation</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">diversity_onoff</span><span class="p">;</span>

	<span class="n">s16</span> <span class="n">ber_monitored_layer</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gpio_dir</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gpio_val</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">revision</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">isdbt_cfg_loaded</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="n">tune_state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">[</span><span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">];</span>

	<span class="cm">/* for the I2C transfer */</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">i2c_buffer_lock</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">input_mode_mpeg</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">tuner_enable</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="n">dib8096p_tuner_adap</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dib8000_power_mode</span> <span class="p">{</span>
	<span class="n">DIB8000_POWER_ALL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DIB8000_POWER_INTERFACE_ONLY</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dib8000_i2c_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_device</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span>    <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span>    <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;i2c read error on %d&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dib8000_read_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;i2c read error on %d&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dib8000_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">rw</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">rw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">rw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rw</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_i2c_write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_device</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span>    <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">?</span> <span class="o">-</span><span class="n">EREMOTEIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_write_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">?</span>
			<span class="o">-</span><span class="n">EREMOTEIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_2k_sb_1seg_dqpsk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="mi">769</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="p">(</span><span class="mi">745</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">,</span> <span class="p">(</span><span class="mi">595</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="p">(</span><span class="mi">769</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="p">(</span><span class="mi">920</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x09</span><span class="p">,</span> <span class="p">(</span><span class="mi">784</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">,</span> <span class="p">(</span><span class="mi">519</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">920</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x09</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_2k_sb_1seg</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="mi">692</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="p">(</span><span class="mi">683</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">,</span> <span class="p">(</span><span class="mi">519</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x09</span><span class="p">,</span> <span class="p">(</span><span class="mi">692</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mi">0</span> <span class="o">|</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mi">0</span> <span class="o">|</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mi">0</span> <span class="o">|</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mi">0</span> <span class="o">|</span> <span class="mh">0x1f</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_2k_sb_3seg_0dqpsk_1dqpsk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="mi">832</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">,</span> <span class="p">(</span><span class="mi">912</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x05</span><span class="p">,</span> <span class="p">(</span><span class="mi">900</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x12</span><span class="p">,</span> <span class="p">(</span><span class="mi">832</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">931</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="p">(</span><span class="mi">912</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">,</span> <span class="p">(</span><span class="mi">807</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x11</span><span class="p">,</span>
		<span class="p">(</span><span class="o">-</span><span class="mi">931</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0f</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_2k_sb_3seg_0dqpsk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="mi">622</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="p">(</span><span class="mi">941</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">,</span> <span class="p">(</span><span class="mi">796</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">,</span> <span class="p">(</span><span class="mi">622</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="p">(</span><span class="mi">982</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="p">(</span><span class="mi">519</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">,</span> <span class="p">(</span><span class="mi">572</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0e</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">982</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0c</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_2k_sb_3seg_1dqpsk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="mi">699</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span> <span class="p">(</span><span class="mi">607</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">,</span> <span class="p">(</span><span class="mi">944</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x13</span><span class="p">,</span> <span class="p">(</span><span class="mi">699</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">720</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="p">(</span><span class="mi">640</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">,</span> <span class="p">(</span><span class="mi">866</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x12</span><span class="p">,</span>
		<span class="p">(</span><span class="o">-</span><span class="mi">720</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0d</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_2k_sb_3seg</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="mi">664</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="p">(</span><span class="mi">925</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">,</span> <span class="p">(</span><span class="mi">937</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">,</span> <span class="p">(</span><span class="mi">664</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">610</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="p">(</span><span class="mi">697</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">,</span> <span class="p">(</span><span class="mi">836</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0e</span><span class="p">,</span>
		<span class="p">(</span><span class="o">-</span><span class="mi">610</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0a</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_4k_sb_1seg_dqpsk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="o">-</span><span class="mi">955</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="p">(</span><span class="mi">687</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">,</span> <span class="p">(</span><span class="mi">818</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">955</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">922</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="p">(</span><span class="mi">750</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">,</span> <span class="p">(</span><span class="mi">665</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0f</span><span class="p">,</span>
		<span class="p">(</span><span class="o">-</span><span class="mi">922</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0d</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_4k_sb_1seg</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="mi">638</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="p">(</span><span class="mi">683</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">,</span> <span class="p">(</span><span class="mi">638</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="p">(</span><span class="mi">638</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">655</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="p">(</span><span class="mi">517</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="mi">698</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0d</span><span class="p">,</span>
		<span class="p">(</span><span class="o">-</span><span class="mi">655</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0a</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_4k_sb_3seg_0dqpsk_1dqpsk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="o">-</span><span class="mi">707</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span> <span class="p">(</span><span class="mi">910</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x06</span><span class="p">,</span> <span class="p">(</span><span class="mi">889</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x16</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">707</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">958</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x13</span><span class="p">,</span> <span class="p">(</span><span class="mi">993</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x05</span><span class="p">,</span> <span class="p">(</span><span class="mi">523</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span>
		<span class="p">(</span><span class="o">-</span><span class="mi">958</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x13</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_4k_sb_3seg_0dqpsk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="o">-</span><span class="mi">723</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x13</span><span class="p">,</span> <span class="p">(</span><span class="mi">910</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x05</span><span class="p">,</span> <span class="p">(</span><span class="mi">777</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">723</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x13</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">568</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="p">(</span><span class="mi">547</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">,</span> <span class="p">(</span><span class="mi">696</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x12</span><span class="p">,</span>
		<span class="p">(</span><span class="o">-</span><span class="mi">568</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0f</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_4k_sb_3seg_1dqpsk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="o">-</span><span class="mi">940</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x15</span><span class="p">,</span> <span class="p">(</span><span class="mi">607</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x05</span><span class="p">,</span> <span class="p">(</span><span class="mi">915</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x16</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">940</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x15</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">848</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x13</span><span class="p">,</span> <span class="p">(</span><span class="mi">683</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">,</span> <span class="p">(</span><span class="mi">543</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span>
		<span class="p">(</span><span class="o">-</span><span class="mi">848</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x13</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_4k_sb_3seg</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="mi">612</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x12</span><span class="p">,</span> <span class="p">(</span><span class="mi">910</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">,</span> <span class="p">(</span><span class="mi">864</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span> <span class="p">(</span><span class="mi">612</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x12</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">869</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x13</span><span class="p">,</span> <span class="p">(</span><span class="mi">683</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">,</span> <span class="p">(</span><span class="mi">869</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x12</span><span class="p">,</span>
		<span class="p">(</span><span class="o">-</span><span class="mi">869</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x13</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_8k_sb_1seg_dqpsk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="o">-</span><span class="mi">835</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x12</span><span class="p">,</span> <span class="p">(</span><span class="mi">684</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x05</span><span class="p">,</span> <span class="p">(</span><span class="mi">735</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">835</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x12</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">598</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">,</span> <span class="p">(</span><span class="mi">781</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">,</span> <span class="p">(</span><span class="mi">739</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x13</span><span class="p">,</span>
		<span class="p">(</span><span class="o">-</span><span class="mi">598</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_8k_sb_1seg</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="mi">673</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="p">(</span><span class="mi">683</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">,</span> <span class="p">(</span><span class="mi">808</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x12</span><span class="p">,</span> <span class="p">(</span><span class="mi">673</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="p">(</span><span class="mi">585</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="p">(</span><span class="mi">512</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">,</span> <span class="p">(</span><span class="mi">780</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0f</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">585</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0f</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_8k_sb_3seg_0dqpsk_1dqpsk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="mi">863</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x17</span><span class="p">,</span> <span class="p">(</span><span class="mi">930</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x07</span><span class="p">,</span> <span class="p">(</span><span class="mi">878</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x19</span><span class="p">,</span> <span class="p">(</span><span class="mi">863</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x17</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span> <span class="p">(</span><span class="mi">521</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x05</span><span class="p">,</span> <span class="p">(</span><span class="mi">980</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_8k_sb_3seg_0dqpsk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="o">-</span><span class="mi">924</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x17</span><span class="p">,</span> <span class="p">(</span><span class="mi">910</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x06</span><span class="p">,</span> <span class="p">(</span><span class="mi">774</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x17</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">924</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x17</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">877</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x15</span><span class="p">,</span> <span class="p">(</span><span class="mi">565</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">,</span> <span class="p">(</span><span class="mi">553</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x15</span><span class="p">,</span>
		<span class="p">(</span><span class="o">-</span><span class="mi">877</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x15</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_8k_sb_3seg_1dqpsk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="o">-</span><span class="mi">921</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x19</span><span class="p">,</span> <span class="p">(</span><span class="mi">607</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x06</span><span class="p">,</span> <span class="p">(</span><span class="mi">881</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x19</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">921</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x19</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">921</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span> <span class="p">(</span><span class="mi">713</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x05</span><span class="p">,</span> <span class="p">(</span><span class="mi">1018</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">(</span><span class="o">-</span><span class="mi">921</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">coeff_8k_sb_3seg</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="mi">514</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span> <span class="p">(</span><span class="mi">910</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x05</span><span class="p">,</span> <span class="p">(</span><span class="mi">861</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x17</span><span class="p">,</span> <span class="p">(</span><span class="mi">514</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span> <span class="p">(</span><span class="mi">690</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">,</span> <span class="p">(</span><span class="mi">683</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">,</span> <span class="p">(</span><span class="mi">662</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x15</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">690</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x14</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">ana_fe_coeff_3seg</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">81</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1022</span><span class="p">,</span> <span class="mi">1017</span><span class="p">,</span> <span class="mi">1013</span><span class="p">,</span> <span class="mi">1010</span><span class="p">,</span> <span class="mi">1008</span><span class="p">,</span> <span class="mi">1008</span><span class="p">,</span> <span class="mi">1008</span><span class="p">,</span> <span class="mi">1008</span><span class="p">,</span> <span class="mi">1010</span><span class="p">,</span> <span class="mi">1014</span><span class="p">,</span> <span class="mi">1017</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">ana_fe_coeff_1seg</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">249</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">981</span><span class="p">,</span> <span class="mi">970</span><span class="p">,</span> <span class="mi">988</span><span class="p">,</span> <span class="mi">1018</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1012</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1018</span><span class="p">,</span> <span class="mi">1012</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1017</span><span class="p">,</span> <span class="mi">1003</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">ana_fe_coeff_13seg</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">396</span><span class="p">,</span> <span class="mi">305</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="o">-</span><span class="mi">51</span><span class="p">,</span> <span class="o">-</span><span class="mi">77</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">13</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">fft_to_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_AUTO</span>:
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8000_set_acquisition_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">nud</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">298</span><span class="p">);</span>
	<span class="n">nud</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;acquisition mode activated&quot;</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">298</span><span class="p">,</span> <span class="n">nud</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_set_output_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">outreg</span><span class="p">,</span> <span class="n">fifo_threshold</span><span class="p">,</span> <span class="n">smo_mode</span><span class="p">,</span> <span class="n">sram</span> <span class="o">=</span> <span class="mh">0x0205</span><span class="p">;</span>	<span class="cm">/* by default SDRAM deintlv is enabled */</span>

	<span class="n">outreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fifo_threshold</span> <span class="o">=</span> <span class="mi">1792</span><span class="p">;</span>
	<span class="n">smo_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">299</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0050</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;-I-	Setting output mode for demod %p to %d&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_GATED_CLK</span>:	<span class="c1">// STBs with parallel gated clock</span>
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>	<span class="cm">/* 0x0400 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_CONT_CLK</span>:	<span class="c1">// STBs with parallel continues clock</span>
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* 0x0440 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_SERIAL</span>:	<span class="c1">// STBs with serial input</span>
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* 0x0482 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_DIVERSITY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">hostbus_diversity</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* 0x0500 */</span>
			<span class="n">sram</span> <span class="o">&amp;=</span> <span class="mh">0xfdff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sram</span> <span class="o">|=</span> <span class="mh">0x0c00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_FIFO</span>:	<span class="c1">// e.g. USB feeding</span>
		<span class="n">smo_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fifo_threshold</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OUTMODE_HIGH_Z</span>:	<span class="c1">// disable</span>
		<span class="n">outreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OUTMODE_ANALOG_ADC</span>:
		<span class="n">outreg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">dib8000_set_acquisition_mode</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Unhandled output_mode passed to be set for demod %p&quot;</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mpeg2_in_188_bytes</span><span class="p">)</span>
		<span class="n">smo_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="n">smo_mode</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="n">fifo_threshold</span><span class="p">);</span>	<span class="cm">/* synchronous fread */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1286</span><span class="p">,</span> <span class="n">outreg</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1291</span><span class="p">,</span> <span class="n">sram</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_set_diversity_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sync_wait</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">273</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">differential_constellation</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">272</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>	<span class="c1">//dvsy_off_lmod4 = 1</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="n">sync_wait</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">);</span>	<span class="c1">// sync_enable = 1; comb_mode = 2</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">272</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="c1">//dvsy_off_lmod4 = 0</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="n">sync_wait</span><span class="p">);</span>	<span class="c1">// sync_enable = 0; comb_mode = 0</span>
	<span class="p">}</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">diversity_onoff</span> <span class="o">=</span> <span class="n">onoff</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* only use the internal way - not the diversity input */</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">271</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* both ways */</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">271</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/* only the diversity input */</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">271</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8000_set_power_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dib8000_power_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* by default everything is going to be powered off */</span>
	<span class="n">u16</span> <span class="n">reg_774</span> <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">,</span> <span class="n">reg_775</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">reg_776</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="n">reg_900</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">900</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">,</span>
		<span class="n">reg_1280</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">reg_1280</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1280</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xff00</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg_1280</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1280</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x707f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8f80</span><span class="p">;</span>

	<span class="cm">/* now, depending on the requested mode, we power on */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* power up everything in the demod */</span>
	<span class="k">case</span> <span class="n">DIB8000_POWER_ALL</span>:
		<span class="n">reg_774</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">reg_775</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">reg_776</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">reg_900</span> <span class="o">&amp;=</span> <span class="mh">0xfffc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
			<span class="n">reg_1280</span> <span class="o">&amp;=</span> <span class="mh">0x00ff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg_1280</span> <span class="o">&amp;=</span> <span class="mh">0x707f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIB8000_POWER_INTERFACE_ONLY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
			<span class="n">reg_1280</span> <span class="o">&amp;=</span> <span class="mh">0x00ff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg_1280</span> <span class="o">&amp;=</span> <span class="mh">0xfa7b</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;powermode : 774 : %x ; 775 : %x; 776 : %x ; 900 : %x; 1280 : %x&quot;</span><span class="p">,</span> <span class="n">reg_774</span><span class="p">,</span> <span class="n">reg_775</span><span class="p">,</span> <span class="n">reg_776</span><span class="p">,</span> <span class="n">reg_900</span><span class="p">,</span> <span class="n">reg_1280</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">774</span><span class="p">,</span> <span class="n">reg_774</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">775</span><span class="p">,</span> <span class="n">reg_775</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">776</span><span class="p">,</span> <span class="n">reg_776</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="n">reg_900</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="n">reg_1280</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_init_sdram</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Init sdram&quot;</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">274</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xfff0</span><span class="p">;</span>
	<span class="cm">/* P_dintlv_delay_ram = 7 because of MobileSdram */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">274</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1803</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1280</span><span class="p">);</span>
	<span class="cm">/* force restart P_restart_sdram */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span>  <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>

	<span class="cm">/* release restart P_restart_sdram */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span>  <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_set_adc_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dibx000_adc_states</span> <span class="n">no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">reg_907</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">907</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">reg_908</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">908</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">no</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DIBX000_SLOW_ADC_ON</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg_908</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">908</span><span class="p">,</span> <span class="n">reg_908</span><span class="p">);</span>
			<span class="n">reg_908</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1925</span><span class="p">);</span>
			<span class="cm">/* en_slowAdc = 1 &amp; reset_sladc = 1 */</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1925</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span>
					<span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>

			<span class="cm">/* read acces to make it works... strange ... */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1925</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="cm">/* en_slowAdc = 1 &amp; reset_sladc = 0 */</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1925</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">));</span>

			<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">921</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span>
					<span class="o">|</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
			<span class="cm">/* ref = Vin1 =&gt; Vbg ; sel = Vin0 or Vin3 ;</span>
<span class="cm">			   (Vin2 = Vcm) */</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">921</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span>
					<span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIBX000_SLOW_ADC_OFF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x8090</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1925</span><span class="p">);</span>
			<span class="cm">/* reset_sladc = 1 en_slowAdc = 0 */</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1925</span><span class="p">,</span>
					<span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">reg_908</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIBX000_ADC_ON</span>:
		<span class="n">reg_907</span> <span class="o">&amp;=</span> <span class="mh">0x0fff</span><span class="p">;</span>
		<span class="n">reg_908</span> <span class="o">&amp;=</span> <span class="mh">0x0003</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIBX000_ADC_OFF</span>:	<span class="c1">// leave the VBG voltage on</span>
		<span class="n">reg_907</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">reg_908</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIBX000_VBG_ENABLE</span>:
		<span class="n">reg_907</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIBX000_VBG_DISABLE</span>:
		<span class="n">reg_907</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">907</span><span class="p">,</span> <span class="n">reg_907</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">908</span><span class="p">,</span> <span class="n">reg_908</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_set_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bw</span> <span class="o">=</span> <span class="mi">6000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;using default timf&quot;</span><span class="p">);</span>
		<span class="n">timf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">timf_default</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;using updated timf&quot;</span><span class="p">);</span>
		<span class="n">timf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">timf</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">timf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_sad_calib</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x8090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: the sad calibration is not needed for the dib8096P&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* internal */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">923</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">924</span><span class="p">,</span> <span class="mi">776</span><span class="p">);</span>	<span class="c1">// 0.625*3.3 / 4096</span>

	<span class="cm">/* do the calibration */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">923</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">923</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib8000_set_wbd_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">4095</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_set_wbd_ref</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8000_reset_pll_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dibx000_bandwidth_config</span> <span class="o">*</span><span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ifreq: %d %x, inversion: %d&quot;</span><span class="p">,</span> <span class="n">bw</span><span class="o">-&gt;</span><span class="n">ifreq</span><span class="p">,</span> <span class="n">bw</span><span class="o">-&gt;</span><span class="n">ifreq</span><span class="p">,</span> <span class="n">bw</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">internal</span>  <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01ff</span><span class="p">));</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">bw</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">922</span><span class="p">,</span> <span class="n">bw</span><span class="o">-&gt;</span><span class="n">sad_cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8000_reset_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dibx000_bandwidth_config</span> <span class="o">*</span><span class="n">pll</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clk_cfg1</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">901</span><span class="p">,</span>
				<span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_prediv</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_ratio</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>

		<span class="n">clk_cfg1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">IO_CLK_en_core</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">bypclk_div</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">enable_refdiv</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_range</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reset</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">902</span><span class="p">,</span> <span class="n">clk_cfg1</span><span class="p">);</span>
		<span class="n">clk_cfg1</span> <span class="o">=</span> <span class="p">(</span><span class="n">clk_cfg1</span> <span class="o">&amp;</span> <span class="mh">0xfff7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_bypass</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">902</span><span class="p">,</span> <span class="n">clk_cfg1</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;clk_cfg1: 0x%04x&quot;</span><span class="p">,</span> <span class="n">clk_cfg1</span><span class="p">);</span>

		<span class="cm">/* smpl_cfg: P_refclksel=2, P_ensmplsel=1 nodivsmpl=1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ADClkSrc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">904</span><span class="p">,</span>
					<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">modulo</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ADClkSrc</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">refclksel</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">904</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">refclksel</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">modulo</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ADClkSrc</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">904</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">modulo</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ADClkSrc</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1856</span><span class="p">,</span> <span class="p">(</span><span class="o">!</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reset</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_range</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_ratio</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_prediv</span><span class="p">));</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1857</span><span class="p">);</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1857</span><span class="p">,</span> <span class="n">reg</span><span class="o">|</span><span class="p">(</span><span class="o">!</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_bypass</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">));</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1858</span><span class="p">);</span> <span class="cm">/* Force clk out pll /2 */</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1858</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">904</span><span class="p">,</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">modulo</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">dib8000_reset_pll_common</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">pll</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib8000_update_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dibx000_bandwidth_config</span> <span class="o">*</span><span class="n">pll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_1857</span><span class="p">,</span> <span class="n">reg_1856</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1856</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">loopdiv</span><span class="p">,</span> <span class="n">prediv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">internal</span><span class="p">,</span> <span class="n">xtal</span><span class="p">;</span>

	<span class="cm">/* get back old values */</span>
	<span class="n">prediv</span> <span class="o">=</span> <span class="n">reg_1856</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">loopdiv</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg_1856</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pll</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_prediv</span> <span class="o">!=</span> <span class="n">prediv</span> <span class="o">||</span>
				<span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_ratio</span> <span class="o">!=</span> <span class="n">loopdiv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Updating pll (prediv: old =  %d new = %d ; loopdiv : old = %d new = %d)&quot;</span><span class="p">,</span> <span class="n">prediv</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_prediv</span><span class="p">,</span> <span class="n">loopdiv</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_ratio</span><span class="p">);</span>
		<span class="n">reg_1856</span> <span class="o">&amp;=</span> <span class="mh">0xf000</span><span class="p">;</span>
		<span class="n">reg_1857</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1857</span><span class="p">);</span>
		<span class="cm">/* disable PLL */</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1857</span><span class="p">,</span> <span class="n">reg_1857</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">));</span>

		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1856</span><span class="p">,</span> <span class="n">reg_1856</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_ratio</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_prediv</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>

		<span class="cm">/* write new system clk into P_sec_len */</span>
		<span class="n">internal</span> <span class="o">=</span> <span class="n">dib8000_read32</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Old Internal = %d&quot;</span><span class="p">,</span> <span class="n">internal</span><span class="p">);</span>
		<span class="n">xtal</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">internal</span> <span class="o">/</span> <span class="n">loopdiv</span><span class="p">)</span> <span class="o">*</span> <span class="n">prediv</span><span class="p">;</span>
		<span class="n">internal</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="n">xtal</span><span class="o">/</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_prediv</span><span class="p">)</span> <span class="o">*</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_ratio</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Xtal = %d , New Fmem = %d New Fdemod = %d, New Fsampling = %d&quot;</span><span class="p">,</span> <span class="n">xtal</span><span class="p">,</span> <span class="n">internal</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">internal</span><span class="o">/</span><span class="mi">2000</span><span class="p">,</span> <span class="n">internal</span><span class="o">/</span><span class="mi">8000</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;New Internal = %d&quot;</span><span class="p">,</span> <span class="n">internal</span><span class="p">);</span>

		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(((</span><span class="n">internal</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">internal</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
		<span class="cm">/* enable PLL */</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1857</span><span class="p">,</span> <span class="n">reg_1857</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">));</span>

		<span class="k">while</span> <span class="p">(((</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1856</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">15</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Waiting for PLL to lock&quot;</span><span class="p">);</span>

		<span class="cm">/* verify */</span>
		<span class="n">reg_1856</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1856</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;PLL Updated with prediv = %d and loopdiv = %d&quot;</span><span class="p">,</span>
				<span class="n">reg_1856</span><span class="o">&amp;</span><span class="mh">0x3f</span><span class="p">,</span> <span class="p">(</span><span class="n">reg_1856</span><span class="o">&gt;&gt;</span><span class="mi">6</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x3f</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_update_pll</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_reset_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset the GPIOs */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1029</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_dir</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1030</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="cm">/* TODO 782 is P_gpio_od */</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1032</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_pwm_pos</span><span class="p">);</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1037</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pwm_freq_div</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_cfg_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">u8</span> <span class="n">num</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_dir</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1029</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_dir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">);</span>	<span class="cm">/* reset the direction bit */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_dir</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">;</span>	<span class="cm">/* set the new direction */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1029</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_dir</span><span class="p">);</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1030</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">);</span>	<span class="cm">/* reset the direction bit */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">;</span>	<span class="cm">/* set the new value */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">1030</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;gpio dir: %x: gpio val: %x&quot;</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_dir</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpio_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib8000_set_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">num</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dib8000_cfg_gpio</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_set_gpio</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">dib8000_defaults</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* auto search configuration - lock0 by default waiting</span>
<span class="cm">	 * for cpil_lock; lock1 cpil_lock; lock2 tmcc_sync_lock */</span>
	<span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
	<span class="mh">0x0004</span><span class="p">,</span>
	<span class="mh">0x0400</span><span class="p">,</span>
	<span class="mh">0x0814</span><span class="p">,</span>

	<span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>
	<span class="mh">0x001b</span><span class="p">,</span>
	<span class="mh">0x7740</span><span class="p">,</span>
	<span class="mh">0x005b</span><span class="p">,</span>
	<span class="mh">0x8d80</span><span class="p">,</span>
	<span class="mh">0x01c9</span><span class="p">,</span>
	<span class="mh">0xc380</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0080</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0090</span><span class="p">,</span>
	<span class="mh">0x0001</span><span class="p">,</span>
	<span class="mh">0xd4c0</span><span class="p">,</span>

	<span class="cm">/*1, 32,</span>
<span class="cm">		0x6680 // P_corm_thres Lock algorithms configuration */</span>

	<span class="mi">11</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span>			<span class="cm">/* set ADC level to -16 */</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">825</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">837</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">811</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">766</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">737</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">693</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">648</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">619</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">575</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">531</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">501</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>

	<span class="mi">4</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span>
	<span class="mh">0x0410</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span>
	<span class="mi">8192</span><span class="p">,</span>			<span class="c1">// P_fft_nb_to_cut</span>

	<span class="mi">6</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span>
	<span class="mh">0x2800</span><span class="p">,</span>			<span class="c1">// P_coff_corthres_ ( 2k 4k 8k ) 0x2800</span>
	<span class="mh">0x2800</span><span class="p">,</span>
	<span class="mh">0x2800</span><span class="p">,</span>
	<span class="mh">0x2800</span><span class="p">,</span>			<span class="c1">// P_coff_cpilthres_ ( 2k 4k 8k ) 0x2800</span>
	<span class="mh">0x2800</span><span class="p">,</span>
	<span class="mh">0x2800</span><span class="p">,</span>

	<span class="mi">2</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span>
	<span class="mh">0x0666</span><span class="p">,</span>			<span class="c1">// P_pha3_thres</span>
	<span class="mh">0x0000</span><span class="p">,</span>			<span class="c1">// P_cti_use_cpe, P_cti_use_prog</span>

	<span class="mi">2</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span>
	<span class="mh">0x200f</span><span class="p">,</span>			<span class="c1">// P_cspu_regul, P_cspu_win_cut</span>
	<span class="mh">0x000f</span><span class="p">,</span>			<span class="c1">// P_des_shift_work</span>

	<span class="mi">5</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span>
	<span class="mh">0x023d</span><span class="p">,</span>			<span class="c1">// P_adp_regul_cnt</span>
	<span class="mh">0x00a4</span><span class="p">,</span>			<span class="c1">// P_adp_noise_cnt</span>
	<span class="mh">0x00a4</span><span class="p">,</span>			<span class="c1">// P_adp_regul_ext</span>
	<span class="mh">0x7ff0</span><span class="p">,</span>			<span class="c1">// P_adp_noise_ext</span>
	<span class="mh">0x3ccc</span><span class="p">,</span>			<span class="c1">// P_adp_fil</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>			<span class="c1">// P_2d_byp_ti_num</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">263</span><span class="p">,</span>
	<span class="mh">0x800</span><span class="p">,</span>			<span class="c1">//P_equal_thres_wgn</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">268</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="mi">39</span><span class="p">,</span>		<span class="c1">// P_equal_ctrl_synchro, P_equal_speedmode</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span>
	<span class="mh">0x0001</span><span class="p">,</span>			<span class="c1">// P_div_lock0_wait</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">285</span><span class="p">,</span>
	<span class="mh">0x0020</span><span class="p">,</span>			<span class="c1">//p_fec_</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span>
	<span class="mh">0x0062</span><span class="p">,</span>			<span class="cm">/* P_smo_mode, P_smo_rs_discard, P_smo_fifo_flush, P_smo_pid_parse, P_smo_error_discard */</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mi">338</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span>		<span class="c1">// P_ctrl_corm_thres4pre_freq_inh=1</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span>		<span class="cm">/* P_ctrl_pre_freq_inh=0 */</span>
		<span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>		<span class="cm">/* P_ctrl_pre_freq_step=3 */</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>		<span class="cm">/* P_pre_freq_win_len=1 */</span>

	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dib8000_identify</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_device</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>because of glitches sometimes</p></td><td class="code"><div class="highlight"><pre>	<span class="n">value</span> <span class="o">=</span> <span class="n">dib8000_i2c_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">896</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">=</span> <span class="n">dib8000_i2c_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">896</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x01b3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;wrong Vendor ID (read=0x%x)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">dib8000_i2c_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">897</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mh">0x8000</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="mh">0x8001</span> <span class="o">&amp;&amp;</span>
			<span class="n">value</span> <span class="o">!=</span> <span class="mh">0x8002</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;wrong Device ID (%x)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x8000</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found DiB8000A&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x8001</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found DiB8000B&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x8002</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found DiB8000C&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x8090</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found DiB8096P&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">dib8000_identify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* sram lead in, rdy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1287</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x8000</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;error : dib8000 MA not supported&quot;</span><span class="p">);</span>

	<span class="n">dibx000_reset_i2c_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">);</span>

	<span class="n">dib8000_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB8000_POWER_ALL</span><span class="p">);</span>

	<span class="cm">/* always leave the VBG voltage on - it consumes almost nothing but takes a long time to start */</span>
	<span class="n">dib8000_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_VBG_ENABLE</span><span class="p">);</span>

	<span class="cm">/* restart all parts */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">771</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">772</span><span class="p">,</span> <span class="mh">0xfffc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mh">0x0045</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mh">0x004d</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mh">0x000c</span><span class="p">);</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">771</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">772</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">898</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>	<span class="c1">// sad</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* drives */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">drives</span><span class="p">)</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">906</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">drives</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;using standard PAD-drive-settings, please adjust settings in config-struct to be optimal.&quot;</span><span class="p">);</span>
			<span class="cm">/* min drive SDRAM - not optimal - adjust */</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">906</span><span class="p">,</span> <span class="mh">0x2d98</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dib8000_reset_pll</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">898</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib8000_reset_gpio</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;GPIO reset was not successful.&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">dib8000_set_output_mode</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">OUTMODE_HIGH_Z</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;OUTPUT_MODE could not be resetted.&quot;</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>P<em>iqc</em>alpha<em>pha, P</em>iqc<em>alpha</em>amp, P<em>iqc</em>dcc_alpha, ...</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* P_iqc_ca2 = 0; P_iqc_impnc_on = 0; P_iqc_mode = 0; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mh">0x0755</span><span class="p">);</span>	<span class="cm">/* P_iqc_corr_inh = 0 enable IQcorr block */</span>
	<span class="k">else</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mh">0x1f55</span><span class="p">);</span>	<span class="cm">/* P_iqc_corr_inh = 1 disable IQcorr block */</span>

	<span class="p">{</span>
		<span class="n">u16</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">dib8000_defaults</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">n</span><span class="o">++</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="o">++</span><span class="p">);</span>
				<span class="n">r</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">l</span><span class="p">);</span>
			<span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">903</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">isdbt_cfg_loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>div_cfg override for special configs</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">div_cfg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">903</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">div_cfg</span><span class="p">);</span>

	<span class="cm">/* unforce divstr regardless whether i2c enumeration was done or not */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1285</span><span class="p">,</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1285</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">dib8000_set_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">6000</span><span class="p">);</span>

	<span class="n">dib8000_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_SLOW_ADC_ON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib8000_sad_calib</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">dib8000_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_SLOW_ADC_OFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dib8000_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB8000_POWER_INTERFACE_ONLY</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8000_restart_agc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>P<em>restart</em>iqc &amp; P<em>restart</em>agc</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="mh">0x0a00</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_update_lna</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dyn_gain</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">update_lna</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>read dyn_gain here (because it is demod-dependent and not tuner)</p></td><td class="code"><div class="highlight"><pre>		<span class="n">dyn_gain</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">390</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">update_lna</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dyn_gain</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dib8000_restart_agc</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_set_agc_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dibx000_agc_config</span> <span class="o">*</span><span class="n">agc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">band</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_config_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">band_caps</span> <span class="o">&amp;</span> <span class="n">band</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">agc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;no valid AGC configuration found for band 0x%02x&quot;</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span> <span class="o">=</span> <span class="n">agc</span><span class="p">;</span>

	<span class="cm">/* AGC */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">inv_gain</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">time_stabiliz</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">alpha_level</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">thlock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Demod AGC loop configuration</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">alpha_mant</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">alpha_exp</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">beta_mant</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">beta_exp</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;WBD: ref: %d, sel: %d, active: %d, alpha: %d&quot;</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span> <span class="o">:</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_ref</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_sel</span><span class="p">,</span> <span class="o">!</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">perform_agc_softsplit</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_sel</span><span class="p">);</span>

	<span class="cm">/* AGC continued */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_ref</span><span class="p">);</span>
	<span class="k">else</span>			<span class="c1">// use default</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_ref</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x8090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">922</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">922</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_sel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_alpha</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">perform_agc_softsplit</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_max</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_min</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_max</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_min</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_pt1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_pt2</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_slope1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_slope2</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_pt1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_pt2</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_slope1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc2_slope2</span><span class="p">);</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">agc</span><span class="o">-&gt;</span><span class="n">agc1_pt3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">923</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">923</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffe3</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_inv</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">wbd_sel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dib8000_pwm_agc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">dib8000_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_ADC_ON</span><span class="p">);</span>
	<span class="n">dib8000_set_agc_config</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">BAND_OF_FREQUENCY</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_pwm_agc_reset</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_agc_soft_split</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">agc</span><span class="p">,</span> <span class="n">split_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span> <span class="o">||</span> <span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">perform_agc_softsplit</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>n<em>agc</em>global</p></td><td class="code"><div class="highlight"><pre>	<span class="n">agc</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">390</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agc</span> <span class="o">&gt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">min_thres</span><span class="p">)</span>
		<span class="n">split_offset</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">agc</span> <span class="o">&lt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">max_thres</span><span class="p">)</span>
		<span class="n">split_offset</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">split_offset</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">max</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">agc</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">min_thres</span><span class="p">)</span> <span class="o">/</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">max_thres</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_agc</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">.</span><span class="n">min_thres</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;AGC split_offset: %d&quot;</span><span class="p">,</span> <span class="n">split_offset</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>P<em>agc</em>force<em>split and P</em>agc<em>split</em>offset</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">107</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">|</span> <span class="n">split_offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">5000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_agc_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">upd_demod_gain_period</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CT_AGC_START</span>:</pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>set power-up level: interf+analog+AGC</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
			<span class="n">dib8000_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_ADC_ON</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dib8000_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB8000_POWER_ALL</span><span class="p">);</span>

			<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1947</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff00</span><span class="p">;</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1946</span><span class="p">,</span>
					<span class="n">upd_demod_gain_period</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
			<span class="cm">/* bit 14 = enDemodGain */</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1947</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">upd_demod_gain_period</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>

			<span class="cm">/* enable adc i &amp; q */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1920</span><span class="p">);</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dib8000_set_agc_config</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">BAND_OF_FREQUENCY</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_AGC_STOP</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">FE_STATUS_TUNE_FAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_AGC_STEP_0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_AGC_STEP_0</span>:</pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>AGC initialization</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_control</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_control</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">dib8000_restart_agc</span><span class="p">(</span><span class="n">state</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>wait AGC rough lock time</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ret</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_AGC_STEP_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_AGC_STEP_1</span>:</pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>wait AGC accurate lock time</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ret</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dib8000_update_lna</span><span class="p">(</span><span class="n">state</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>wait only AGC rough lock time</p></td><td class="code"><div class="highlight"><pre>			<span class="n">ret</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_AGC_STEP_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_AGC_STEP_2</span>:
		<span class="n">dib8000_agc_soft_split</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_control</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">agc_control</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_AGC_STOP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dib8000_agc_soft_split</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8096p_host_bus_drive</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">drive</span> <span class="o">&amp;=</span> <span class="mh">0x7</span><span class="p">;</span>

	<span class="cm">/* drive host bus 2, 3, 4 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1798</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="mh">0x7</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">drive</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">drive</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">drive</span><span class="p">;</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1798</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* drive host bus 5,6 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1799</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">drive</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">drive</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1799</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* drive host bus 7, 8, 9 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1800</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="mh">0x7</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">drive</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">drive</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">drive</span><span class="p">;</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* drive host bus 10, 11 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1801</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">drive</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">drive</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1801</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* drive host bus 12, 13, 14 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1802</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="mh">0x7</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">drive</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">drive</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">drive</span><span class="p">;</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1802</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dib8096p_calcSyncFreq</span><span class="p">(</span><span class="n">u32</span> <span class="n">P_Kin</span><span class="p">,</span> <span class="n">u32</span> <span class="n">P_Kout</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">insertExtSynchro</span><span class="p">,</span> <span class="n">u32</span> <span class="n">syncSize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">quantif</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nom</span> <span class="o">=</span> <span class="p">(</span><span class="n">insertExtSynchro</span> <span class="o">*</span> <span class="n">P_Kin</span><span class="o">+</span><span class="n">syncSize</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">denom</span> <span class="o">=</span> <span class="n">P_Kout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">syncFreq</span> <span class="o">=</span> <span class="p">((</span><span class="n">nom</span> <span class="o">&lt;&lt;</span> <span class="n">quantif</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">syncFreq</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">quantif</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">syncFreq</span> <span class="o">=</span> <span class="p">(</span><span class="n">syncFreq</span> <span class="o">&gt;&gt;</span> <span class="n">quantif</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">syncFreq</span> <span class="o">=</span> <span class="p">(</span><span class="n">syncFreq</span> <span class="o">&gt;&gt;</span> <span class="n">quantif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">syncFreq</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">syncFreq</span> <span class="o">=</span> <span class="n">syncFreq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">syncFreq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8096p_cfg_DibTx</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">P_Kin</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">P_Kout</span><span class="p">,</span> <span class="n">u32</span> <span class="n">insertExtSynchro</span><span class="p">,</span> <span class="n">u32</span> <span class="n">synchroMode</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">syncWord</span><span class="p">,</span> <span class="n">u32</span> <span class="n">syncSize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Configure DibStream Tx&quot;</span><span class="p">);</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1615</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1603</span><span class="p">,</span> <span class="n">P_Kin</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1605</span><span class="p">,</span> <span class="n">P_Kout</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1606</span><span class="p">,</span> <span class="n">insertExtSynchro</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1608</span><span class="p">,</span> <span class="n">synchroMode</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1609</span><span class="p">,</span> <span class="p">(</span><span class="n">syncWord</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1610</span><span class="p">,</span> <span class="n">syncWord</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1612</span><span class="p">,</span> <span class="n">syncSize</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1615</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8096p_cfg_DibRx</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">P_Kin</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">P_Kout</span><span class="p">,</span> <span class="n">u32</span> <span class="n">synchroMode</span><span class="p">,</span> <span class="n">u32</span> <span class="n">insertExtSynchro</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">syncWord</span><span class="p">,</span> <span class="n">u32</span> <span class="n">syncSize</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dataOutRate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">syncFreq</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Configure DibStream Rx synchroMode = %d&quot;</span><span class="p">,</span> <span class="n">synchroMode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">P_Kin</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">P_Kout</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">syncFreq</span> <span class="o">=</span> <span class="n">dib8096p_calcSyncFreq</span><span class="p">(</span><span class="n">P_Kin</span><span class="p">,</span> <span class="n">P_Kout</span><span class="p">,</span>
				<span class="n">insertExtSynchro</span><span class="p">,</span> <span class="n">syncSize</span><span class="p">);</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1542</span><span class="p">,</span> <span class="n">syncFreq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1554</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1536</span><span class="p">,</span> <span class="n">P_Kin</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1537</span><span class="p">,</span> <span class="n">P_Kout</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1539</span><span class="p">,</span> <span class="n">synchroMode</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1540</span><span class="p">,</span> <span class="p">(</span><span class="n">syncWord</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1541</span><span class="p">,</span> <span class="n">syncWord</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1543</span><span class="p">,</span> <span class="n">syncSize</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1544</span><span class="p">,</span> <span class="n">dataOutRate</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1554</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8096p_enMpegMux</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg_1287</span><span class="p">;</span>

	<span class="n">reg_1287</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1287</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">reg_1287</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">reg_1287</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1287</span><span class="p">,</span> <span class="n">reg_1287</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8096p_configMpegMux</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">pulseWidth</span><span class="p">,</span> <span class="n">u16</span> <span class="n">enSerialMode</span><span class="p">,</span> <span class="n">u16</span> <span class="n">enSerialClkDiv2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg_1287</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Enable Mpeg mux&quot;</span><span class="p">);</span>

	<span class="n">dib8096p_enMpegMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* If the input mode is MPEG do not divide the serial clock */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">enSerialMode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">input_mode_mpeg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">enSerialClkDiv2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg_1287</span> <span class="o">=</span> <span class="p">((</span><span class="n">pulseWidth</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">enSerialMode</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">enSerialClkDiv2</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1287</span><span class="p">,</span> <span class="n">reg_1287</span><span class="p">);</span>

	<span class="n">dib8096p_enMpegMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8096p_setDibTxMux</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg_1288</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1288</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPEG_ON_DIBTX</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SET MPEG ON DIBSTREAM TX&quot;</span><span class="p">);</span>
			<span class="n">dib8096p_cfg_DibTx</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">reg_1288</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIV_ON_DIBTX</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SET DIV_OUT ON DIBSTREAM TX&quot;</span><span class="p">);</span>
			<span class="n">dib8096p_cfg_DibTx</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">reg_1288</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_ON_DIBTX</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SET ADC_OUT ON DIBSTREAM TX&quot;</span><span class="p">);</span>
			<span class="n">dib8096p_cfg_DibTx</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">reg_1288</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1288</span><span class="p">,</span> <span class="n">reg_1288</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8096p_setHostBusMux</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg_1288</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1288</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEMOUT_ON_HOSTBUS</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SET DEM OUT OLD INTERF ON HOST BUS&quot;</span><span class="p">);</span>
			<span class="n">dib8096p_enMpegMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">reg_1288</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIBTX_ON_HOSTBUS</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SET DIBSTREAM TX ON HOST BUS&quot;</span><span class="p">);</span>
			<span class="n">dib8096p_enMpegMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">reg_1288</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPEG_ON_HOSTBUS</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SET MPEG MUX ON HOST BUS&quot;</span><span class="p">);</span>
			<span class="n">reg_1288</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1288</span><span class="p">,</span> <span class="n">reg_1288</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8096p_set_diversity_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_1287</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* only use the internal way - not the diversity input */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s mode OFF : by default Enable Mpeg INPUT&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
			<span class="cm">/* outputRate = 8 */</span>
			<span class="n">dib8096p_cfg_DibRx</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* Do not divide the serial clock of MPEG MUX in</span>
<span class="cm">			   SERIAL MODE in case input mode MPEG is used */</span>
			<span class="n">reg_1287</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1287</span><span class="p">);</span>
			<span class="cm">/* enSerialClkDiv2 == 1 ? */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">reg_1287</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* force enSerialClkDiv2 = 0 */</span>
				<span class="n">reg_1287</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
				<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1287</span><span class="p">,</span> <span class="n">reg_1287</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">input_mode_mpeg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* both ways */</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* only the diversity input */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s ON : Enable diversity INPUT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">dib8096p_cfg_DibRx</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">input_mode_mpeg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dib8000_set_diversity_in</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">onoff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8096p_set_output_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">outreg</span><span class="p">,</span> <span class="n">smo_mode</span><span class="p">,</span> <span class="n">fifo_threshold</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">prefer_mpeg_mux_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dib8096p_host_bus_drive</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">fifo_threshold</span> <span class="o">=</span> <span class="mi">1792</span><span class="p">;</span>
	<span class="n">smo_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">299</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0050</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outreg</span>   <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1286</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OUTMODE_HIGH_Z</span>:
			<span class="n">outreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_SERIAL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">prefer_mpeg_mux_use</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8096P setting output mode TS_SERIAL using Mpeg Mux&quot;</span><span class="p">);</span>
				<span class="n">dib8096p_configMpegMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">dib8096p_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MPEG_ON_HOSTBUS</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="cm">/* Use Smooth block */</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8096P setting output mode TS_SERIAL using Smooth bloc&quot;</span><span class="p">);</span>
				<span class="n">dib8096p_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
						<span class="n">DEMOUT_ON_HOSTBUS</span><span class="p">);</span>
				<span class="n">outreg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_GATED_CLK</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">prefer_mpeg_mux_use</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8096P setting output mode TS_PARALLEL_GATED using Mpeg Mux&quot;</span><span class="p">);</span>
				<span class="n">dib8096p_configMpegMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">dib8096p_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MPEG_ON_HOSTBUS</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Use Smooth block */</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8096P setting output mode TS_PARALLEL_GATED using Smooth block&quot;</span><span class="p">);</span>
				<span class="n">dib8096p_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
						<span class="n">DEMOUT_ON_HOSTBUS</span><span class="p">);</span>
				<span class="n">outreg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_PAR_CONT_CLK</span>: <span class="cm">/* Using Smooth block only */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8096P setting output mode TS_PARALLEL_CONT using Smooth block&quot;</span><span class="p">);</span>
			<span class="n">dib8096p_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOUT_ON_HOSTBUS</span><span class="p">);</span>
			<span class="n">outreg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OUTMODE_MPEG2_FIFO</span>:
			<span class="cm">/* Using Smooth block because not supported</span>
<span class="cm">			   by new Mpeg Mux bloc */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8096P setting output mode TS_FIFO using Smooth block&quot;</span><span class="p">);</span>
			<span class="n">dib8096p_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DEMOUT_ON_HOSTBUS</span><span class="p">);</span>
			<span class="n">outreg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="n">smo_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">fifo_threshold</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OUTMODE_DIVERSITY</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8096P setting output mode MODE_DIVERSITY&quot;</span><span class="p">);</span>
			<span class="n">dib8096p_setDibTxMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIV_ON_DIBTX</span><span class="p">);</span>
			<span class="n">dib8096p_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBTX_ON_HOSTBUS</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OUTMODE_ANALOG_ADC</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8096P setting output mode MODE_ANALOG_ADC&quot;</span><span class="p">);</span>
			<span class="n">dib8096p_setDibTxMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ADC_ON_DIBTX</span><span class="p">);</span>
			<span class="n">dib8096p_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBTX_ON_HOSTBUS</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">OUTMODE_HIGH_Z</span><span class="p">)</span>
		<span class="n">outreg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;output_mpeg2_in_188_bytes = %d&quot;</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mpeg2_in_188_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mpeg2_in_188_bytes</span><span class="p">)</span>
		<span class="n">smo_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="n">smo_mode</span><span class="p">);</span>
	<span class="cm">/* synchronous fread */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">299</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fifo_threshold</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1286</span><span class="p">,</span> <span class="n">outreg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">map_addr_to_serpar_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">17</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">19</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">21</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">28</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">99</span><span class="p">)</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8096p_tuner_write_serpar</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">n_overflow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">serpar_num</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n_overflow</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n_overflow</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1984</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Tuner ITF: write busy (overflow)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1985</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">serpar_num</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1986</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8096p_tuner_read_serpar</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">n_overflow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">serpar_num</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">read_word</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n_overflow</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n_overflow</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1984</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;TunerITF: read busy (overflow)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1985</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">serpar_num</span><span class="o">&amp;</span><span class="mh">0x3f</span><span class="p">));</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n_empty</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n_empty</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1984</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x1</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;TunerITF: read busy (empty)&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">read_word</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1987</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_word</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_word</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8096p_tuner_rw_serpar</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map_addr_to_serpar_number</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* write */</span>
			<span class="k">return</span> <span class="n">dib8096p_tuner_write_serpar</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="cm">/* read */</span>
			<span class="k">return</span> <span class="n">dib8096p_tuner_read_serpar</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8096p_rw_on_apb</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">u16</span> <span class="n">apb_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">word</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* write */</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">apb_address</span><span class="p">,</span>
				<span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">])));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">word</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">apb_address</span><span class="p">);</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8096p_tuner_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">apb_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x12</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1920</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x14</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1921</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x24</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1922</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1a</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1923</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x22</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1924</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x33</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1926</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1927</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x35</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1928</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x36</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1929</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x37</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1930</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x38</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1931</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x39</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1932</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2a</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1935</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2b</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1936</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2c</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1937</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2d</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1938</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2e</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1939</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2f</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1940</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x30</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1941</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x31</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1942</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x32</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1943</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3e</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1944</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3f</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1945</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x40</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">1948</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x25</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">936</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x26</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">937</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x27</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">938</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x28</span>:
			<span class="n">apb_address</span> <span class="o">=</span> <span class="mi">939</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1d</span>:
			<span class="cm">/* get sad sel request */</span>
			<span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">921</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x3</span><span class="p">);</span>
			<span class="n">word</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">924</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
			<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1f</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* write */</span>
				<span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
						<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="cm">/* in the VGAMODE Sel are located on bit 0/1 */</span>
				<span class="n">word</span> <span class="o">&amp;=</span> <span class="mh">0x3</span><span class="p">;</span>
				<span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">921</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="o">~</span><span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">word</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">);</span>
				<span class="cm">/* Set the proper input */</span>
				<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">921</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apb_address</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* R/W acces via APB */</span>
		<span class="k">return</span> <span class="n">dib8096p_rw_on_apb</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">apb_address</span><span class="p">);</span>
	<span class="k">else</span>  <span class="cm">/* R/W access via SERPAR  */</span>
		<span class="k">return</span> <span class="n">dib8096p_tuner_rw_serpar</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dib8096p_i2c_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I2C_FUNC_I2C</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">dib8096p_tuner_xfer_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span> <span class="o">=</span> <span class="n">dib8096p_tuner_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span> <span class="o">=</span> <span class="n">dib8096p_i2c_func</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="nf">dib8096p_get_i2c_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">dib8096p_tuner_adap</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8096p_get_i2c_tuner</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib8096p_tuner_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">en_cur_state</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;sleep dib8096p: %d&quot;</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>

	<span class="n">en_cur_state</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1922</span><span class="p">);</span>

	<span class="cm">/* LNAs and MIX are ON and therefore it is a valid configuration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">en_cur_state</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_enable</span> <span class="o">=</span> <span class="n">en_cur_state</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span>
		<span class="n">en_cur_state</span> <span class="o">&amp;=</span> <span class="mh">0x00ff</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_enable</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">en_cur_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_enable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1922</span><span class="p">,</span> <span class="n">en_cur_state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8096p_tuner_sleep</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s32</span> <span class="n">lut_1000ln_mant</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mi">908</span><span class="p">,</span> <span class="mi">7003</span><span class="p">,</span> <span class="mi">7090</span><span class="p">,</span> <span class="mi">7170</span><span class="p">,</span> <span class="mi">7244</span><span class="p">,</span> <span class="mi">7313</span><span class="p">,</span> <span class="mi">7377</span><span class="p">,</span> <span class="mi">7438</span><span class="p">,</span> <span class="mi">7495</span><span class="p">,</span> <span class="mi">7549</span><span class="p">,</span> <span class="mi">7600</span>
<span class="p">};</span>

<span class="n">s32</span> <span class="nf">dib8000_get_adc_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">exp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mant</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read32</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">384</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tmp_val</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">exp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mant</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">exp</span><span class="p">));</span>
		<span class="n">ix</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">mant</span><span class="o">-</span><span class="mi">1000</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">);</span> <span class="cm">/* index of the LUT */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">lut_1000ln_mant</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">+</span> <span class="mi">693</span><span class="o">*</span><span class="p">(</span><span class="n">exp</span><span class="o">-</span><span class="mi">20</span><span class="p">)</span> <span class="o">-</span> <span class="mi">6908</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="o">*</span><span class="mi">256</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_get_adc_power</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib8090p_get_dc_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">IQ</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">IQ</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">403</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">404</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span>  <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">-=</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8090p_get_dc_power</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8000_update_timf</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">timf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span> <span class="o">=</span> <span class="n">dib8000_read32</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">435</span><span class="p">);</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">timf</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">timf</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Updated timing frequency: %d (default: %d)&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">timf_default</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">dib8000_ctrl_timf</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">op</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">timf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEMOD_TIMF_SET</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span> <span class="o">=</span> <span class="n">timf</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEMOD_TIMF_UPDATE</span>:
			<span class="n">dib8000_update_timf</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEMOD_TIMF_GET</span>:
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dib8000_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6000</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_ctrl_timf</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">adc_target_16dB</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">825</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">837</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">811</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">766</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">737</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">693</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">648</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">619</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">575</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">531</span> <span class="o">-</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">-</span> <span class="mi">501</span> <span class="o">-</span> <span class="mi">117</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">permu_seg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8000_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">seq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">autosearching</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">mode</span><span class="p">,</span> <span class="n">max_constellation</span><span class="p">,</span> <span class="n">seg_diff_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nbseg_diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">guard</span><span class="p">,</span> <span class="n">crate</span><span class="p">,</span> <span class="n">constellation</span><span class="p">,</span> <span class="n">timeI</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">P_cfr_left_edge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">P_cfr_right_edge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">seg_mask13</span> <span class="o">=</span> <span class="mh">0x1fff</span><span class="p">;</span>	<span class="c1">// All 13 segments enabled</span>
	<span class="k">const</span> <span class="n">s16</span> <span class="o">*</span><span class="n">ncoeff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">ana_fe</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmcc_pow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">coff_pow</span> <span class="o">=</span> <span class="mh">0x2800</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0xfff</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ana_gain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">dib8000_init_sdram</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ber_monitored_layer</span> <span class="o">!=</span> <span class="n">LAYER_ALL</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">285</span><span class="p">,</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">285</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ber_monitored_layer</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">285</span><span class="p">,</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">285</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>	<span class="c1">// P_dds_invspec</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span><span class="o">^</span><span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>compute new dds_freq for the seg and adjust prbs</p></td><td class="code"><div class="highlight"><pre>		<span class="kt">int</span> <span class="n">seg_offset</span> <span class="o">=</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_idx</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_count</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_count</span> <span class="o">%</span> <span class="mi">2</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">clk</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">segtodds</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="mi">430</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">/</span> <span class="n">clk</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>	<span class="c1">// segtodds = SegBW / Fclk * pow(2,26)</span>
		<span class="kt">int</span> <span class="n">dds_offset</span> <span class="o">=</span> <span class="n">seg_offset</span> <span class="o">*</span> <span class="n">segtodds</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">new_dds</span><span class="p">,</span> <span class="n">sub_channel</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_count</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dds_offset</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">segtodds</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span> <span class="o">^</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">new_dds</span> <span class="o">=</span> <span class="n">dds_offset</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">new_dds</span> <span class="o">=</span> <span class="n">dds_offset</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>We shift tuning frequency if the wanted segment is :
 - the segment of center frequency with an odd total number of segments
 - the segment to the left of center frequency with an even total number of segments
 - the segment to the right of center frequency with an even total number of segments</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">==</span> <span class="n">SYS_ISDBT</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_count</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
					  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_idx</span> <span class="o">==</span>
				  <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_count</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
					 <span class="o">||</span> <span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_count</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_idx</span> <span class="o">==</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_count</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span>
					 <span class="o">||</span> <span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_count</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_idx</span> <span class="o">==</span>
							 <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_count</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
					<span class="p">))</span> <span class="p">{</span>
				<span class="n">new_dds</span> <span class="o">-=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="mi">850</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">/</span> <span class="n">clk</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>	<span class="c1">// new_dds = 850 (freq shift in KHz) / Fclk * pow(2,26)</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span> <span class="o">^</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">new_dds</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">-</span> <span class="n">dds_offset</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">new_dds</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">+</span> <span class="n">dds_offset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">new_dds</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01ff</span><span class="p">));</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">new_dds</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_segment_count</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">sub_channel</span> <span class="o">=</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_subchannel</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">seg_offset</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">41</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sub_channel</span> <span class="o">=</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_subchannel</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">seg_offset</span><span class="p">))</span> <span class="o">%</span> <span class="mi">41</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">sub_channel</span> <span class="o">-=</span> <span class="mi">6</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">==</span> <span class="n">TRANSMISSION_MODE_2K</span>
				<span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">==</span> <span class="n">TRANSMISSION_MODE_4K</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">219</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">);</span>	<span class="c1">//adp_pass =1</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">190</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>	<span class="c1">//pha3_force_pha_shift = 1</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">219</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffe</span><span class="p">);</span>	<span class="c1">//adp_pass =0</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">190</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xbfff</span><span class="p">);</span>	<span class="c1">//pha3_force_pha_shift = 0</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">sub_channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">6</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 41, 0, 1</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">5</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x423</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 02~04</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">4</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 05~07</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">3</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x5C7</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 08~10</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">2</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x7A6</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 11~13</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x3D8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 14~16</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x527</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 17~19</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x7FF</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 20~22</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x79B</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 23~25</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x3D6</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 26~28</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x3A2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 29~31</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x53B</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 32~34</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x2F4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 35~37</span>
			<span class="nl">default:</span>
			<span class="k">case</span> <span class="mi">7</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x213</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 38~40</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">sub_channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">6</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 41, 0, 1</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">5</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x208</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 02~04</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">4</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0xC3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 05~07</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">3</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x7B9</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 08~10</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">2</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x423</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 11~13</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x5C7</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 14~16</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x3D8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 17~19</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x7FF</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 20~22</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x3D6</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 23~25</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x53B</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 26~28</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x213</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 29~31</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 32~34</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0xD0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 35~37</span>
			<span class="nl">default:</span>
			<span class="k">case</span> <span class="mi">7</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x48E</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 38~40</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">sub_channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">6</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 41, 0, 1</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">5</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x740</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 02~04</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">4</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x069</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 05~07</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">3</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x7DD</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 08~10</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">2</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x208</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 11~13</span>
			<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x7B9</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 14~16</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x5C7</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 17~19</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x7FF</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 20~22</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x53B</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 23~25</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 26~28</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x48E</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 29~31</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x4C4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 32~34</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x367</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 33~37</span>
			<span class="nl">default:</span>
			<span class="k">case</span> <span class="mi">7</span>:
				<span class="n">init_prbs</span> <span class="o">=</span> <span class="mh">0x684</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// 38~40</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01ff</span><span class="p">));</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/*P_mode == ?? */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="n">seq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>dib8000<em>write</em>word(state, 287, (dib8000<em>read</em>word(state, 287) &amp; 0xe000) | 0x1000);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_32</span>:
		<span class="n">guard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_16</span>:
		<span class="n">guard</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_8</span>:
		<span class="n">guard</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_4</span>:
	<span class="nl">default:</span>
		<span class="n">guard</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">init_prbs</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">guard</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">));</span>	<span class="c1">// ADDR 1</span>

	<span class="n">max_constellation</span> <span class="o">=</span> <span class="n">DQPSK</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DQPSK</span>:
			<span class="n">constellation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QPSK</span>:
			<span class="n">constellation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QAM_16</span>:
			<span class="n">constellation</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QAM_64</span>:
		<span class="nl">default:</span>
			<span class="n">constellation</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FEC_1_2</span>:
			<span class="n">crate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_2_3</span>:
			<span class="n">crate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_3_4</span>:
			<span class="n">crate</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_5_6</span>:
			<span class="n">crate</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_7_8</span>:
		<span class="nl">default:</span>
			<span class="n">crate</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interleaving</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interleaving</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span>
				 <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interleaving</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
			<span class="p">)</span>
			<span class="n">timeI</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interleaving</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">timeI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">constellation</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">crate</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">timeI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">max_constellation</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DQPSK</span>:
			<span class="k">case</span> <span class="n">QPSK</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_16</span> <span class="o">||</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_64</span><span class="p">)</span>
					<span class="n">max_constellation</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">QAM_16</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_64</span><span class="p">)</span>
					<span class="n">max_constellation</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">fft_to_mode</span><span class="p">(</span><span class="n">state</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>dib8000<em>write</em>word(state, 5, 13); /<em>p_last_seg = 13</em>/</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">274</span><span class="p">,</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">274</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffcf</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span>
												 <span class="n">isdbt_sb_mode</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;mode = %d ; guard = %d&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span><span class="p">);</span>

	<span class="cm">/* signal optimization parameter */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seg_diff_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">permu_seg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">nbseg_diff</span> <span class="o">+=</span>
				<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_count</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbseg_diff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">seg_diff_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">permu_seg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">nbseg_diff</span> <span class="o">+=</span>
				<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_count</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbseg_diff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">seg_diff_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">permu_seg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nbseg_diff = %X (%d)&quot;</span><span class="p">,</span> <span class="n">seg_diff_mask</span><span class="p">,</span> <span class="n">seg_diff_mask</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">differential_constellation</span> <span class="o">=</span> <span class="p">(</span><span class="n">seg_diff_mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">dib8000_set_diversity_in</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">diversity_onoff</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib8096p_set_diversity_in</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">diversity_onoff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">seg_mask13</span> <span class="o">=</span> <span class="mh">0x00E0</span><span class="p">;</span>
		<span class="k">else</span>		<span class="c1">// 1-segment</span>
			<span class="n">seg_mask13</span> <span class="o">=</span> <span class="mh">0x0040</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">seg_mask13</span> <span class="o">=</span> <span class="mh">0x1fff</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>WRITE: Mode &amp; Diff mask</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">seg_diff_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">seg_diff_mask</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span><span class="p">))</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">268</span><span class="p">,</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">268</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF9FF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0200</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">268</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="mi">39</span><span class="p">);</span>	<span class="c1">//init value</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>---- SMALL ----
P<em>small</em>seg_diff</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">352</span><span class="p">,</span> <span class="n">seg_diff_mask</span><span class="p">);</span>	<span class="c1">// ADDR 352</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">353</span><span class="p">,</span> <span class="n">seg_mask13</span><span class="p">);</span>	<span class="c1">// ADDR 353</span>

<span class="cm">/*	// P_small_narrow_band=0, P_small_last_seg=13, P_small_offset_num_car=5 */</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>---- SMALL ----</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span>
					<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_2k_sb_1seg_dqpsk</span><span class="p">;</span>
				<span class="k">else</span>	<span class="c1">// QPSK or QAM</span>
					<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_2k_sb_1seg</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// 3-segments</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span>
						<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_2k_sb_3seg_0dqpsk_1dqpsk</span><span class="p">;</span>
					<span class="k">else</span>	<span class="c1">// QPSK or QAM on external segments</span>
						<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_2k_sb_3seg_0dqpsk</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// QPSK or QAM on central segment</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span>
						<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_2k_sb_3seg_1dqpsk</span><span class="p">;</span>
					<span class="k">else</span>	<span class="c1">// QPSK or QAM on external segments</span>
						<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_2k_sb_3seg</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span>
					<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_4k_sb_1seg_dqpsk</span><span class="p">;</span>
				<span class="k">else</span>	<span class="c1">// QPSK or QAM</span>
					<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_4k_sb_1seg</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// 3-segments</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_4k_sb_3seg_0dqpsk_1dqpsk</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// QPSK or QAM on external segments</span>
						<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_4k_sb_3seg_0dqpsk</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// QPSK or QAM on central segment</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_4k_sb_3seg_1dqpsk</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>	<span class="c1">// QPSK or QAM on external segments</span>
						<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_4k_sb_3seg</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_AUTO</span>:
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span>
					<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_8k_sb_1seg_dqpsk</span><span class="p">;</span>
				<span class="k">else</span>	<span class="c1">// QPSK or QAM</span>
					<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_8k_sb_1seg</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// 3-segments</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_8k_sb_3seg_0dqpsk_1dqpsk</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// QPSK or QAM on external segments</span>
						<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_8k_sb_3seg_0dqpsk</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// QPSK or QAM on central segment</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_8k_sb_3seg_1dqpsk</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>	<span class="c1">// QPSK or QAM on external segments</span>
						<span class="n">ncoeff</span> <span class="o">=</span> <span class="n">coeff_8k_sb_3seg</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">343</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">ncoeff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>P<em>small</em>coef<em>ext</em>enable=ISDB-Tsb, P<em>small</em>narrow<em>band=ISDB-Tsb, P</em>small<em>last</em>seg=13, P<em>small</em>offset<em>num</em>car=5</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">351</span><span class="p">,</span>
				<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">13</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mi">5</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>---- COFF ----
Carloff, the most robust</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>P<em>coff</em>cpil<em>alpha=4, P</em>coff<em>inh=0, P</em>coff<em>cpil</em>winlen=64
P<em>coff</em>narrow<em>band=1, P</em>coff<em>square</em>val=1, P<em>coff</em>one<em>seg=~partial</em>rcpt, P<em>coff</em>use<em>tmcc=1, P</em>coff<em>use</em>ac=1</p></td><td class="code"><div class="highlight"><pre>		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span>
					<span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">63</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="o">~</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>

<span class="cm">/*		// P_small_coef_ext_enable = 1 */</span>
<span class="cm">/*		dib8000_write_word(state, 351, dib8000_read_word(state, 351) | 0x200); */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>P<em>coff</em>winlen=63, P<em>coff</em>thres<em>lock=15, P</em>coff<em>one</em>seg<em>width= (P</em>mode == 3) , P<em>coff</em>one<em>seg</em>sym= (P_mode-1)</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mh">0x1fcf</span> <span class="o">|</span> <span class="p">((</span><span class="n">mode</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mh">0x0fcf</span> <span class="o">|</span> <span class="p">((</span><span class="n">mode</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>P<em>ctrl</em>corm<em>thres4pre</em>freq<em>inh=1,P</em>ctrl<em>pre</em>freq<em>mode</em>sat=1,
P<em>ctrl</em>pre<em>freq</em>inh=0, P<em>ctrl</em>pre<em>freq</em>step = 5, P<em>pre</em>freq<em>win</em>len=4</p></td><td class="code"><div class="highlight"><pre>			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">338</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>P<em>ctrl</em>pre<em>freq</em>win<em>len=16, P</em>ctrl<em>pre</em>freq<em>thres</em>lockin=8</p></td><td class="code"><div class="highlight"><pre>			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">340</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>P<em>ctrl</em>pre<em>freq</em>thres<em>lockout=6, P</em>small<em>use</em>tmcc/ac/cp=1</p></td><td class="code"><div class="highlight"><pre>			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">341</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>P<em>coff</em>corthres<em>8k, 4k, 2k and P</em>coff<em>cpilthres</em>8k, 4k, 2k</p></td><td class="code"><div class="highlight"><pre>			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">150</span><span class="p">);</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">183</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">150</span><span class="p">);</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// Sound Broadcasting mode 3 seg</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>P<em>coff</em>one<em>seg</em>sym= 1, P<em>coff</em>one<em>seg</em>width= 1, P<em>coff</em>winlen=63, P<em>coff</em>thres_lock=15</p></td><td class="code"><div class="highlight"><pre>			<span class="cm">/*	if (mode == 3) */</span>
			<span class="cm">/*		dib8000_write_word(state, 180, 0x2fca | ((0) &lt;&lt; 14)); */</span>
			<span class="cm">/*	else */</span>
			<span class="cm">/*		dib8000_write_word(state, 180, 0x2fca | ((1) &lt;&lt; 14)); */</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mh">0x1fcf</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>P<em>ctrl</em>corm<em>thres4pre</em>freq<em>inh = 1, P</em>ctrl<em>pre</em>freq<em>mode</em>sat=1,
P<em>ctrl</em>pre<em>freq</em>inh=0, P<em>ctrl</em>pre<em>freq</em>step = 4, P<em>pre</em>freq<em>win</em>len=4</p></td><td class="code"><div class="highlight"><pre>			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">338</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>P<em>ctrl</em>pre<em>freq</em>win<em>len=16, P</em>ctrl<em>pre</em>freq<em>thres</em>lockin=8</p></td><td class="code"><div class="highlight"><pre>			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">340</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>P<em>ctrl</em>pre<em>freq</em>thres<em>lockout=6, P</em>small<em>use</em>tmcc/ac/cp=1</p></td><td class="code"><div class="highlight"><pre>			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">341</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>P<em>coff</em>corthres<em>8k, 4k, 2k and P</em>coff<em>cpilthres</em>8k, 4k, 2k</p></td><td class="code"><div class="highlight"><pre>			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">350</span><span class="p">);</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">183</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">350</span><span class="p">);</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">isdbt_cfg_loaded</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// if not Sound Broadcasting mode : put default values for 13 segments</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>
		<span class="n">coff_pow</span> <span class="o">=</span> <span class="mh">0x2800</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">181</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">coff_pow</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>P<em>ctrl</em>corm<em>thres4pre</em>freq<em>inh=1, P</em>ctrl<em>pre</em>freq<em>mode</em>sat=1,
P<em>ctrl</em>pre<em>freq</em>mode<em>sat=1, P</em>ctrl<em>pre</em>freq<em>inh=0, P</em>ctrl<em>pre</em>freq<em>step = 3, P</em>pre<em>freq</em>win_len=1</p></td><td class="code"><div class="highlight"><pre>		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">338</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>P<em>ctrl</em>pre<em>freq</em>win<em>len=8, P</em>ctrl<em>pre</em>freq<em>thres</em>lockin=6</p></td><td class="code"><div class="highlight"><pre>		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">340</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>P<em>ctrl</em>pre<em>freq</em>thres<em>lockout=4, P</em>small<em>use</em>tmcc/ac/cp=1</p></td><td class="code"><div class="highlight"><pre>		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">341</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>---- FFT ----</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>	<span class="c1">// P_fft_powrange=64</span>
	<span class="k">else</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>	<span class="c1">// P_fft_powrange=32</span>

	<span class="cm">/* make the cpil_coff_lock more robust but slower p_coff_winlen</span>
<span class="cm">	 * 6bits; p_coff_thres_lock 6bits (for coff lock if needed)</span>
<span class="cm">	 */</span>
	<span class="cm">/* if ( ( nbseg_diff&gt;0)&amp;&amp;(nbseg_diff&lt;13))</span>
<span class="cm">		dib8000_write_word(state, 187, (dib8000_read_word(state, 187) &amp; 0xfffb) | (1 &lt;&lt; 3)); */</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">189</span><span class="p">,</span> <span class="o">~</span><span class="n">seg_mask13</span> <span class="o">|</span> <span class="n">seg_diff_mask</span><span class="p">);</span>	<span class="cm">/* P_lmod4_seg_inh       */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="o">~</span><span class="n">seg_mask13</span> <span class="o">|</span> <span class="n">seg_diff_mask</span><span class="p">);</span>	<span class="cm">/* P_pha3_seg_inh        */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="o">~</span><span class="n">seg_mask13</span> <span class="o">|</span> <span class="n">seg_diff_mask</span><span class="p">);</span>	<span class="cm">/* P_tac_seg_inh         */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">ifreq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">266</span><span class="p">,</span> <span class="o">~</span><span class="n">seg_mask13</span> <span class="o">|</span> <span class="n">seg_diff_mask</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* P_equal_noise_seg_inh */</span>
	<span class="k">else</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">266</span><span class="p">,</span> <span class="o">~</span><span class="n">seg_mask13</span> <span class="o">|</span> <span class="n">seg_diff_mask</span><span class="p">);</span>	<span class="cm">/* P_equal_noise_seg_inh */</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">287</span><span class="p">,</span> <span class="o">~</span><span class="n">seg_mask13</span> <span class="o">|</span> <span class="mh">0x1000</span><span class="p">);</span>	<span class="cm">/* P_tmcc_seg_inh        */</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>dib8000<em>write</em>word(state, 288, ~seg<em>mask13 | seg</em>diff<em>mask); /* P</em>tmcc<em>seg</em>eq_inh */</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autosearching</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">288</span><span class="p">,</span> <span class="p">(</span><span class="o">~</span><span class="n">seg_mask13</span> <span class="o">|</span> <span class="n">seg_diff_mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">);</span>	<span class="cm">/* P_tmcc_seg_eq_inh */</span>
	<span class="k">else</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">288</span><span class="p">,</span> <span class="mh">0x1fff</span><span class="p">);</span>	<span class="c1">//disable equalisation of the tmcc when autosearch to be able to find the DQPSK channels.</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;287 = %X (%d)&quot;</span><span class="p">,</span> <span class="o">~</span><span class="n">seg_mask13</span> <span class="o">|</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="o">~</span><span class="n">seg_mask13</span> <span class="o">|</span> <span class="mh">0x1000</span><span class="p">);</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="n">seg_mask13</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">seg_diff_mask</span><span class="p">));</span>	<span class="cm">/* P_des_seg_enabled     */</span>

	<span class="cm">/* offset loop parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* P_timf_alpha = (11-P_mode), P_corm_alpha=6, P_corm_thres=0x80 */</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">((</span><span class="mi">11</span> <span class="o">-</span> <span class="n">mode</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>

		<span class="k">else</span>		<span class="c1">// Sound Broadcasting mode 3 seg</span>
			<span class="cm">/* P_timf_alpha = (10-P_mode), P_corm_alpha=6, P_corm_thres=0x80 */</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">((</span><span class="mi">10</span> <span class="o">-</span> <span class="n">mode</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x60</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>TODO in 13 seg, timf_alpha can always be the same or not ?</p></td><td class="code"><div class="highlight"><pre>		<span class="cm">/* P_timf_alpha = (9-P_mode, P_corm_alpha=6, P_corm_thres=0x80 */</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">((</span><span class="mi">9</span> <span class="o">-</span> <span class="n">mode</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* P_ctrl_pha_off_max=3   P_ctrl_sfreq_inh =0  P_ctrl_sfreq_step = (11-P_mode)  */</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="n">mode</span><span class="p">));</span>

		<span class="k">else</span>		<span class="c1">// Sound Broadcasting mode 3 seg</span>
			<span class="cm">/* P_ctrl_pha_off_max=3   P_ctrl_sfreq_inh =0  P_ctrl_sfreq_step = (10-P_mode)  */</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">9</span> <span class="o">-</span> <span class="n">mode</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* P_ctrl_pha_off_max=3   P_ctrl_sfreq_inh =0  P_ctrl_sfreq_step = 9  */</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">mode</span><span class="p">));</span>

	<span class="cm">/* P_dvsy_sync_wait - reuse mode */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_4K</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">diversity_delay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">guard</span><span class="p">))</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">48</span><span class="p">;</span>	<span class="c1">// add 50% SFN margin + compensate for one DVSY-fifo</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">guard</span><span class="p">))</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">diversity_delay</span><span class="p">;</span>	<span class="c1">// add 50% SFN margin + compensate for DVSY-fifo</span>
	<span class="n">mode</span> <span class="o">&lt;&lt;=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">273</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">)</span> <span class="o">|</span> <span class="n">mode</span><span class="p">);</span>

	<span class="cm">/* channel estimation fine configuration */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">max_constellation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QAM_64</span>:
		<span class="n">ana_gain</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>	<span class="c1">// -1 : avoid def_est saturation when ADC target is -16dB</span>
		<span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0148</span><span class="p">;</span>	<span class="cm">/* P_adp_regul_cnt 0.04 */</span>
		<span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfff0</span><span class="p">;</span>	<span class="cm">/* P_adp_noise_cnt -0.002 */</span>
		<span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00a4</span><span class="p">;</span>	<span class="cm">/* P_adp_regul_ext 0.02 */</span>
		<span class="n">coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfff8</span><span class="p">;</span>	<span class="cm">/* P_adp_noise_ext -0.001 */</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>if (!state->cfg.hostbus<em>diversity) //if diversity, we should prehaps use the configuration of the max</em>constallation -1</p></td><td class="code"><div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_16</span>:
		<span class="n">ana_gain</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>	<span class="c1">// -1 : avoid def_est saturation when ADC target is -16dB</span>
		<span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x023d</span><span class="p">;</span>	<span class="cm">/* P_adp_regul_cnt 0.07 */</span>
		<span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffdf</span><span class="p">;</span>	<span class="cm">/* P_adp_noise_cnt -0.004 */</span>
		<span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00a4</span><span class="p">;</span>	<span class="cm">/* P_adp_regul_ext 0.02 */</span>
		<span class="n">coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfff0</span><span class="p">;</span>	<span class="cm">/* P_adp_noise_ext -0.002 */</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>if (!((state->cfg.hostbus<em>diversity) &amp;&amp; (max</em>constellation == QAM_16)))</p></td><td class="code"><div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ana_gain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">// 0 : goes along with ADC target at -22dB to keep good mobile performance and lock at sensitivity level</span>
		<span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x099a</span><span class="p">;</span>	<span class="cm">/* P_adp_regul_cnt 0.3 */</span>
		<span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffae</span><span class="p">;</span>	<span class="cm">/* P_adp_noise_cnt -0.01 */</span>
		<span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0333</span><span class="p">;</span>	<span class="cm">/* P_adp_regul_ext 0.1 */</span>
		<span class="n">coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfff8</span><span class="p">;</span>	<span class="cm">/* P_adp_noise_ext -0.002 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">mode</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">215</span> <span class="o">+</span> <span class="n">mode</span><span class="p">,</span> <span class="n">coeff</span><span class="p">[</span><span class="n">mode</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>update ana_gain depending on max constellation</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="n">ana_gain</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>update ADC target depending on ana_gain</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ana_gain</span><span class="p">)</span> <span class="p">{</span>		<span class="c1">// set -16dB ADC target for ana_gain=-1</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">80</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">adc_target_16dB</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="c1">// set -22dB ADC target for ana_gain=0</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">80</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">adc_target_16dB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">355</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>---- ANA_FE ----</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ana_fe</span> <span class="o">=</span> <span class="n">ana_fe_coeff_3seg</span><span class="p">;</span>
		<span class="k">else</span>		<span class="c1">// 1-segment</span>
			<span class="n">ana_fe</span> <span class="o">=</span> <span class="n">ana_fe_coeff_1seg</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ana_fe</span> <span class="o">=</span> <span class="n">ana_fe_coeff_13seg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">isdbt_cfg_loaded</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="n">mode</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">117</span> <span class="o">+</span> <span class="n">mode</span><span class="p">,</span> <span class="n">ana_fe</span><span class="p">[</span><span class="n">mode</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>---- CHAN_BLK ----</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((((</span><span class="o">~</span><span class="n">seg_diff_mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">P_cfr_left_edge</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((((</span><span class="n">seg_mask13</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">seg_diff_mask</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">P_cfr_right_edge</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="o">||</span> <span class="p">((((</span><span class="n">seg_mask13</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">seg_diff_mask</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="n">P_cfr_left_edge</span><span class="p">);</span>	<span class="c1">// P_cfr_left_edge</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">223</span><span class="p">,</span> <span class="n">P_cfr_right_edge</span><span class="p">);</span>	<span class="c1">// P_cfr_right_edge</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>"P<em>cspu</em>left<em>edge"  not used => do not care
"P</em>cspu<em>right</em>edge" not used => do not care</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="c1">// P_2d_mode_byp=1</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">205</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff0</span><span class="p">);</span>	<span class="c1">// P_cspu_win_cut = 0</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">==</span> <span class="n">TRANSMISSION_MODE_2K</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>dib8000<em>write</em>word(state, 219, dib8000<em>read</em>word(state, 219) &amp; 0xfffe); // P<em>adp</em>pass = 0</p></td><td class="code"><div class="highlight"><pre>			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">265</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>	<span class="c1">// P_equal_noise_sel = 15</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">isdbt_cfg_loaded</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="c1">// default value</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">265</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>	<span class="c1">// default value</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mh">0x200f</span><span class="p">);</span>	<span class="c1">// init value</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>---- TMCC ----</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tmcc_pow</span> <span class="o">+=</span>
			<span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">DQPSK</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_count</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>Quantif of "P<em>tmcc</em>dec<em>thres</em>?k" is (0, 5+mode, 9);
Threshold is set at 1/4 of max power.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmcc_pow</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">9</span> <span class="o">-</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="n">tmcc_pow</span><span class="p">);</span>	<span class="c1">// P_tmcc_dec_thres_2k</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">291</span><span class="p">,</span> <span class="n">tmcc_pow</span><span class="p">);</span>	<span class="c1">// P_tmcc_dec_thres_4k</span>
	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">292</span><span class="p">,</span> <span class="n">tmcc_pow</span><span class="p">);</span>	<span class="c1">// P_tmcc_dec_thres_8k</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>dib8000<em>write</em>word(state, 287, (1 &lt;&lt; 13) | 0x1000 );
---- PHA3 ----</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">isdbt_cfg_loaded</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">3285</span><span class="p">);</span>	<span class="cm">/*p_2d_hspeed_thr0 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">isdbt_cfg_loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">isdbt_cfg_loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_autosearch_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">factor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">slist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_64</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fec</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">interleaving</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>choose the right list, in sb, always do everything</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_8</span><span class="p">;</span>
		<span class="n">slist</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x9fff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">==</span> <span class="n">GUARD_INTERVAL_AUTO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">==</span> <span class="n">TRANSMISSION_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">slist</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x9fff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">));</span>	<span class="c1">// P_mode = 1 to have autosearch start ok with mode2</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">slist</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">==</span> <span class="n">TRANSMISSION_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">slist</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x9fff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">));</span>	<span class="c1">// P_mode = 1</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">slist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">==</span> <span class="n">TRANSMISSION_MODE_AUTO</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">==</span> <span class="n">GUARD_INTERVAL_AUTO</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_8</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;using list for autosearch : %d&quot;</span><span class="p">,</span> <span class="n">slist</span><span class="p">);</span>
		<span class="n">dib8000_set_channel</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">slist</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>dib8000<em>write</em>word(state, 0, (dib8000<em>read</em>word(state, 0) &amp; 0x9fff) | (1 &lt;&lt; 13));  // P_mode = 1</p></td><td class="code"><div class="highlight"><pre>		<span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>set lock_mask values</p></td><td class="code"><div class="highlight"><pre>		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">);</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>set lock_mask wait time values</p></td><td class="code"><div class="highlight"><pre>		<span class="n">value</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">*</span> <span class="n">factor</span><span class="p">;</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>	<span class="c1">// lock0 wait time</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>	<span class="c1">// lock0 wait time</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">*</span> <span class="n">factor</span><span class="p">;</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>	<span class="c1">// lock1 wait time</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>	<span class="c1">// lock1 wait time</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">*</span> <span class="n">factor</span><span class="p">;</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>	<span class="c1">// lock2 wait time</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>	<span class="c1">// lock2 wait time</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">));</span>
		<span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1284</span><span class="p">);</span>	<span class="c1">// reset the INT. n_irq_pending</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_autosearch_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">irq_pending</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1284</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_pending</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// failed</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_autosearch_irq failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_pending</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// succeeded</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_autosearch_irq succeeded&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="c1">// still pending</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_tune</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lock</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">fft_to_mode</span><span class="p">(</span><span class="n">state</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>we are already tuned - just resuming from suspend</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dib8000_set_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">dib8000_set_channel</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>restart demod</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">45</span><span class="p">);</span>

	<span class="cm">/* P_ctrl_inh_cor=0, P_ctrl_alpha_cor=4, P_ctrl_inh_isi=0, P_ctrl_alpha_isi=3 */</span>
	<span class="cm">/*  ret |= dib8000_write_word(state, 29, (0 &lt;&lt; 9) | (4 &lt;&lt; 5) | (0 &lt;&lt; 4) | (3 &lt;&lt; 0) );  workaround inh_isi stays at 1 */</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>never achieved a lock before - wait for timfreq to update</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">timf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
			<span class="k">else</span>	<span class="c1">// Sound Broadcasting mode 3 seg</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>		<span class="c1">// 13 seg</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* P_timf_alpha = (13-P_mode) , P_corm_alpha=6, P_corm_thres=0x40  alpha to check on board */</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">((</span><span class="mi">13</span> <span class="o">-</span> <span class="n">mode</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>dib8000<em>write</em>word(state, 32, (8 &lt;&lt; 12) | (6 &lt;&lt; 8) | 0x80);</p></td><td class="code"><div class="highlight"><pre>			<span class="cm">/*  P_ctrl_sfreq_step= (12-P_mode)   P_ctrl_sfreq_inh =0     P_ctrl_pha_off_max  */</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="p">(</span><span class="mi">12</span> <span class="o">-</span> <span class="n">mode</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="mi">5</span> <span class="o">+</span> <span class="n">mode</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// Sound Broadcasting mode 3 seg</span>

			<span class="cm">/* P_timf_alpha = (12-P_mode) , P_corm_alpha=6, P_corm_thres=0x60  alpha to check on board */</span>
			<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">((</span><span class="mi">12</span> <span class="o">-</span> <span class="n">mode</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x60</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">mode</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="mi">5</span> <span class="o">+</span> <span class="n">mode</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="c1">// 13 seg</span>
		<span class="cm">/* P_timf_alpha = 8 , P_corm_alpha=6, P_corm_thres=0x80  alpha to check on board */</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">((</span><span class="mi">11</span> <span class="o">-</span> <span class="n">mode</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="n">mode</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="mi">5</span> <span class="o">+</span> <span class="n">mode</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>

	<span class="p">}</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>we achieved a coff<em>cpil</em>lock - it's time to update the timf</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">568</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">570</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lock</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">dib8000_update_timf</span><span class="p">(</span><span class="n">state</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>now that tune is finished, lock0 should lock on fec<em>mpeg to output this lock on MP</em>LOCK. It's changed in autosearch start</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x8002</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">903</span><span class="p">);</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">903</span><span class="p">,</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">903</span><span class="p">,</span> <span class="n">value</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dib8000_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB8000_POWER_ALL</span><span class="p">);</span>
	<span class="n">dib8000_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_ADC_ON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib8000_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_SLOW_ADC_ON</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not start Slow ADC&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">dib8000_sad_calib</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">dib8000_set_output_mode</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">OUTMODE_HIGH_Z</span><span class="p">);</span>
	<span class="n">dib8000_set_power_mode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIB8000_POWER_INTERFACE_ONLY</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dib8000_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_SLOW_ADC_OFF</span><span class="p">)</span> <span class="o">|</span> <span class="n">dib8000_set_adc_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBX000_ADC_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="nf">dib8000_get_tune_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_get_tune_state</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib8000_set_tune_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="n">tune_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">tune_state</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_set_tune_state</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fe_status_t</span> <span class="n">stat</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span><span class="p">,</span> <span class="n">sub_index_frontend</span><span class="p">;</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_status</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">&amp;</span><span class="n">FE_HAS_SYNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;TMCC lock on the slave%i&quot;</span><span class="p">,</span> <span class="n">index_frontend</span><span class="p">);</span>
			<span class="cm">/* synchronize the cache with the other frontends */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_frontend</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">sub_index_frontend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">sub_index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">sub_index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sub_index_frontend</span> <span class="o">!=</span> <span class="n">index_frontend</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span><span class="p">;</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span><span class="p">;</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span><span class="p">;</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span><span class="p">;</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_count</span><span class="p">;</span>
						<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interleaving</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interleaving</span><span class="p">;</span>
						<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fec</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fec</span><span class="p">;</span>
						<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">sub_index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">508</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">572</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">570</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_2K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
	<span class="nl">default:</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_32</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend GI = 1/32 &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_16</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend GI = 1/16 &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend GI = 1/8 &quot;</span><span class="p">);</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend GI = 1/4 &quot;</span><span class="p">);</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">505</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend : partial_reception = %d &quot;</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">493</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend : Layer %d segments = %d &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_count</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">499</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interleaving</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend : Layer %d time_intlv = %d &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interleaving</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">481</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fec</span> <span class="o">=</span> <span class="n">FEC_1_2</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend : Layer %d Code Rate = 1/2 &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fec</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend : Layer %d Code Rate = 2/3 &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fec</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend : Layer %d Code Rate = 3/4 &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fec</span> <span class="o">=</span> <span class="n">FEC_5_6</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend : Layer %d Code Rate = 5/6 &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fec</span> <span class="o">=</span> <span class="n">FEC_7_8</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend : Layer %d Code Rate = 7/8 &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">487</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend : Layer %d DQPSK &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">DQPSK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QPSK</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend : Layer %d QPSK &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_16</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend : Layer %d QAM16 &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
		<span class="nl">default:</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_get_frontend : Layer %d QAM64 &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_64</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* synchronize the cache with the other frontends */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_count</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interleaving</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interleaving</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fec</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fec</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nbr_pending</span><span class="p">,</span> <span class="n">exit_condition</span><span class="p">,</span> <span class="n">index_frontend</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">index_frontend_success</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">time</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">time_slave</span> <span class="o">=</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000: must at least specify frequency &quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000: no bandwidth specified, set to default &quot;</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* synchronization of the cache */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">=</span> <span class="n">SYS_ISDBT</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dtv_frontend_properties</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
			<span class="n">dib8000_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span>
					<span class="n">OUTMODE_HIGH_Z</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dib8096p_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span>
					<span class="n">OUTMODE_HIGH_Z</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>

		<span class="n">dib8000_set_tune_state</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="n">CT_AGC_START</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* start up the AGC */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">time</span> <span class="o">=</span> <span class="n">dib8000_agc_startup</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">time_slave</span> <span class="o">=</span> <span class="n">dib8000_agc_startup</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">==</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">)</span>
				<span class="n">time</span> <span class="o">=</span> <span class="n">time_slave</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">time_slave</span> <span class="o">!=</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">time_slave</span> <span class="o">&gt;</span> <span class="n">time</span><span class="p">))</span>
				<span class="n">time</span> <span class="o">=</span> <span class="n">time_slave</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">!=</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">time</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">exit_condition</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dib8000_get_tune_state</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">])</span> <span class="o">!=</span> <span class="n">CT_AGC_STOP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">exit_condition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exit_condition</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dib8000_set_tune_state</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="n">CT_DEMOD_START</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">!=</span> <span class="n">SYS_ISDBT</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">inversion</span> <span class="o">==</span> <span class="n">INVERSION_AUTO</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">==</span> <span class="n">TRANSMISSION_MODE_AUTO</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">==</span> <span class="n">GUARD_INTERVAL_AUTO</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_layer_enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_AUTO</span><span class="p">)</span> <span class="o">||</span>
			  <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fec</span> <span class="o">==</span> <span class="n">FEC_AUTO</span><span class="p">)))</span> <span class="o">||</span>
			<span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_layer_enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_AUTO</span><span class="p">)</span> <span class="o">||</span>
			  <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fec</span> <span class="o">==</span> <span class="n">FEC_AUTO</span><span class="p">)))</span> <span class="o">||</span>
			<span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_layer_enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_AUTO</span><span class="p">)</span> <span class="o">||</span>
			  <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">fec</span> <span class="o">==</span> <span class="n">FEC_AUTO</span><span class="p">)))</span> <span class="o">||</span>
			<span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			  <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_layer_enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			 <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			  <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_layer_enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			 <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_layer_enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">tune_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dib8000_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="n">dib8000_autosearch_start</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="n">nbr_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">exit_condition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* 0: tune pending; 1: tune failed; 2:tune success */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">tune_failed</span> <span class="o">&gt;&gt;</span> <span class="n">index_frontend</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">found</span> <span class="o">=</span> <span class="n">dib8000_autosearch_irq</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* tune pending */</span>
						 <span class="n">nbr_pending</span><span class="o">++</span><span class="p">;</span>
						 <span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mi">2</span>:
						 <span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;autosearch succeed on the frontend%i&quot;</span><span class="p">,</span> <span class="n">index_frontend</span><span class="p">);</span>
						 <span class="n">exit_condition</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
						 <span class="n">index_frontend_success</span> <span class="o">=</span> <span class="n">index_frontend</span><span class="p">;</span>
						 <span class="k">break</span><span class="p">;</span>
					<span class="nl">default:</span>
						 <span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;unhandled autosearch result&quot;</span><span class="p">);</span>
					<span class="k">case</span> <span class="mi">1</span>:
						 <span class="n">tune_failed</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index_frontend</span><span class="p">);</span>
						 <span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;autosearch failed for the frontend%i&quot;</span><span class="p">,</span> <span class="n">index_frontend</span><span class="p">);</span>
						 <span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* if all tune are done and no success, exit: tune failed */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">nbr_pending</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">exit_condition</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">exit_condition</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">exit_condition</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">--</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">exit_condition</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* tune failed */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;tune failed&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;tune success on frontend%i&quot;</span><span class="p">,</span> <span class="n">index_frontend_success</span><span class="p">);</span>

		<span class="n">dib8000_get_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dib8000_tune</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>

	<span class="cm">/* set output mode and diversity input */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib8000_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dib8000_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span>
					<span class="n">OUTMODE_DIVERSITY</span><span class="p">);</span>
			<span class="n">dib8000_set_diversity_in</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* turn off the diversity of the last chip */</span>
		<span class="n">dib8000_set_diversity_in</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dib8096p_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">enMpegOutput</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dib8096p_setDibTxMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">MPEG_ON_DIBTX</span><span class="p">);</span>
			<span class="n">dib8096p_setHostBusMux</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DIBTX_ON_HOSTBUS</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dib8096p_set_output_mode</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span>
					<span class="n">OUTMODE_DIVERSITY</span><span class="p">);</span>
			<span class="n">dib8096p_set_diversity_in</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* turn off the diversity of the last chip */</span>
		<span class="n">dib8096p_set_diversity_in</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dib8000_read_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">570</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">568</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lock_slave</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lock</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">570</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">568</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lock_slave</span> <span class="o">|=</span> <span class="n">dib8000_read_lock</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>

	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">lock</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">lock_slave</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_SIGNAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">lock</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">lock_slave</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="cm">/* Equal */</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_CARRIER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((((</span><span class="n">lock</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">||</span> <span class="p">(((</span><span class="n">lock_slave</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf</span><span class="p">))</span> <span class="cm">/* TMCC_SYNC */</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_SYNC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((((</span><span class="n">lock</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">lock_slave</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">lock</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span> <span class="cm">/* FEC MPEG */</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">lock</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">lock_slave</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">554</span><span class="p">);</span> <span class="cm">/* Viterbi Layer A */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>

		<span class="n">lock</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">555</span><span class="p">);</span> <span class="cm">/* Viterbi Layer B */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>

		<span class="n">lock</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">556</span><span class="p">);</span> <span class="cm">/* Viterbi Layer C */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="cm">/* 13 segments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">562</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">563</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">560</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">561</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_read_unc_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">unc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="cm">/* packet error on 13 seg */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="o">*</span><span class="n">unc</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">567</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">unc</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">565</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_signal_strength</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">65535</span> <span class="o">-</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
			<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">strength</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">65535</span> <span class="o">-</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">390</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">65535</span> <span class="o">-</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
		<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">strength</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dib8000_get_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">exp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">542</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">544</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">exp</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">exp</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">exp</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">&lt;&lt;=</span> <span class="n">exp</span><span class="o">+</span><span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="mh">0x8090</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">543</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">545</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">exp</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">exp</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">exp</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">&lt;&lt;=</span> <span class="n">exp</span><span class="o">+</span><span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">n</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">t</span> <span class="o">+</span> <span class="p">((</span><span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mh">0xffffffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">snr_master</span><span class="p">;</span>

	<span class="n">snr_master</span> <span class="o">=</span> <span class="n">dib8000_get_snr</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snr_master</span> <span class="o">+=</span> <span class="n">dib8000_get_snr</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">snr_master</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snr_master</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">intlog10</span><span class="p">(</span><span class="n">snr_master</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">);</span>
		<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">snr_master</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib8000_set_slave_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe_slave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">index_frontend</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;set slave fe %p to index %i&quot;</span><span class="p">,</span> <span class="n">fe_slave</span><span class="p">,</span> <span class="n">index_frontend</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe_slave</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;too many slave frontend&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_set_slave_frontend</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib8000_remove_slave_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">index_frontend</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;remove slave fe %p (index %i)&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">index_frontend</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;no frontend to be removed&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_remove_slave_frontend</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">dib8000_get_slave_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slave_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slave_index</span> <span class="o">&gt;=</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">slave_index</span><span class="p">];</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_get_slave_frontend</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">dib8000_i2c_enumeration</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">no_of_demods</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">default_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">first_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">is_dib8096p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">new_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_device</span> <span class="n">client</span> <span class="o">=</span> <span class="p">{.</span><span class="n">adap</span> <span class="o">=</span> <span class="n">host</span> <span class="p">};</span>

	<span class="n">client</span><span class="p">.</span><span class="n">i2c_write_buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">i2c_write_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: not enough memory&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">client</span><span class="p">.</span><span class="n">i2c_read_buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">i2c_read_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: not enough memory&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_memory_read</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">client</span><span class="p">.</span><span class="n">i2c_buffer_lock</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mutex</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">i2c_buffer_lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: not enough memory&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_memory_lock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">no_of_demods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* designated i2c address */</span>
		<span class="n">new_addr</span> <span class="o">=</span> <span class="n">first_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">client</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">new_addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_dib8096p</span><span class="p">)</span>
			<span class="n">dib8000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1287</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>	<span class="cm">/* sram lead in, rdy */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dib8000_identify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* sram lead in, rdy */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_dib8096p</span><span class="p">)</span>
				<span class="n">dib8000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1287</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
			<span class="n">client</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">default_addr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dib8000_identify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;#%d: not identified&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
				<span class="n">ret</span>  <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* start diversity to pull_down div_str - just for i2c-enumeration */</span>
		<span class="n">dib8000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1286</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>

		<span class="cm">/* set new i2c address and force divstart */</span>
		<span class="n">dib8000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1285</span><span class="p">,</span> <span class="p">(</span><span class="n">new_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>
		<span class="n">client</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">new_addr</span><span class="p">;</span>
		<span class="n">dib8000_identify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;IC %d initialized (to i2c_address 0x%x)&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">new_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">no_of_demods</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_addr</span> <span class="o">=</span> <span class="n">first_addr</span> <span class="o">|</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">client</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">new_addr</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>unforce divstr</p></td><td class="code"><div class="highlight"><pre>		<span class="n">dib8000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1285</span><span class="p">,</span> <span class="n">new_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

		<span class="cm">/* deactivate div - it was just for i2c-enumeration */</span>
		<span class="n">dib8000_i2c_write16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="mi">1286</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>
<span class="nl">error_memory_lock:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">i2c_read_buffer</span><span class="p">);</span>
<span class="nl">error_memory_read:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">i2c_write_buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_i2c_enumeration</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib8000_fe_get_tune_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span> <span class="o">*</span><span class="n">tune</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tune</span><span class="o">-&gt;</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tune</span><span class="o">-&gt;</span><span class="n">step_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tune</span><span class="o">-&gt;</span><span class="n">max_drift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib8000_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index_frontend</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">index_frontend</span> <span class="o">&lt;</span> <span class="n">MAX_NUMBER_OF_FRONTENDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">index_frontend</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="n">index_frontend</span><span class="p">]);</span>

	<span class="n">dibx000_exit_i2c_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">);</span>
	<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">dib8096p_tuner_adap</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="nf">dib8000_get_i2c_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dibx000_i2c_interface</span> <span class="n">intf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gating</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dibx000_get_i2c_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">gating</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_get_i2c_master</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib8000_pid_filter_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">299</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffef</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">onoff</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;pid filter enabled %d&quot;</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_pid_filter_ctrl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib8000_pid_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Index %x, PID %d, OnOff %d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">305</span> <span class="o">+</span> <span class="n">id</span><span class="p">,</span> <span class="n">onoff</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_pid_filter</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">dib8000_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_ISDBT</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DiBcom 8000 ISDB-T&quot;</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">44250000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">867250000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">=</span> <span class="mi">62500</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">FE_CAN_INVERSION_AUTO</span> <span class="o">|</span>
		 <span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span>
		 <span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
		 <span class="n">FE_CAN_QPSK</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_AUTO</span> <span class="o">|</span>
		 <span class="n">FE_CAN_TRANSMISSION_MODE_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_GUARD_INTERVAL_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_RECOVER</span> <span class="o">|</span> <span class="n">FE_CAN_HIERARCHY_AUTO</span><span class="p">,</span>
		 <span class="p">},</span>

	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">dib8000_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">dib8000_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">dib8000_sleep</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">dib8000_set_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">=</span> <span class="n">dib8000_fe_get_tune_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend</span> <span class="o">=</span> <span class="n">dib8000_get_frontend</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">dib8000_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">dib8000_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">dib8000_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">dib8000_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">dib8000_read_unc_blocks</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">dib8000_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">u8</span> <span class="n">i2c_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dib8000_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib8000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dib8000_attach&quot;</span><span class="p">);</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fe</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib8000_config</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">adap</span> <span class="o">=</span> <span class="n">i2c_adap</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">i2c_addr</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_write_buffer</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_read_buffer</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">i2c_buffer_lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">gpio_dir</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">gpio_dir</span><span class="p">;</span>

	<span class="cm">/* Ensure the output mode remains at the previous default if it&#39;s</span>
<span class="cm">	 * not specifically set by the caller.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span> <span class="o">!=</span> <span class="n">OUTMODE_MPEG2_SERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span> <span class="o">!=</span> <span class="n">OUTMODE_MPEG2_PAR_GATED_CLK</span><span class="p">))</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">output_mode</span> <span class="o">=</span> <span class="n">OUTMODE_MPEG2_FIFO</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe</span><span class="p">;</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dib8000_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">timf_default</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">timf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib8000_identify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dibx000_init_i2c_master</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_master</span><span class="p">,</span> <span class="n">DIB8000</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">adap</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* init 8096p tuner adapter */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dib8096p_tuner_adap</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;DiB8096P tuner interface&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dib8096p_tuner_adap</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dib8096p_tuner_adap</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dib8096p_tuner_xfer_algo</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dib8096p_tuner_adap</span><span class="p">.</span><span class="n">algo_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dib8096p_tuner_adap</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">.</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">i2c_set_adapdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dib8096p_tuner_adap</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">i2c_add_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dib8096p_tuner_adap</span><span class="p">);</span>

	<span class="n">dib8000_reset</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="n">dib8000_write_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">285</span><span class="p">,</span> <span class="p">(</span><span class="n">dib8000_read_word</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">285</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x60</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>	<span class="cm">/* ber_rs_len = 3 */</span>

	<span class="k">return</span> <span class="n">fe</span><span class="p">;</span>

 <span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib8000_attach</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Olivier Grenie &lt;Olivier.Grenie@dibcom.fr, &quot;</span> <span class="s">&quot;Patrick Boettcher &lt;pboettcher@dibcom.fr&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for the DiBcom 8000 ISDB-T demodulator&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
