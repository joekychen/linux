<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › tda10048.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tda10048.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    NXP TDA10048HN DVB OFDM demodulator driver</span>

<span class="cm">    Copyright (C) 2009 Steven Toth &lt;stoth@kernellabs.com&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">*/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/math64.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>
<span class="cp">#include &quot;dvb_frontend.h&quot;</span>
<span class="cp">#include &quot;dvb_math.h&quot;</span>
<span class="cp">#include &quot;tda10048.h&quot;</span>

<span class="cp">#define TDA10048_DEFAULT_FIRMWARE &quot;dvb-fe-tda10048-1.0.fw&quot;</span>
<span class="cp">#define TDA10048_DEFAULT_FIRMWARE_SIZE 24878</span>

<span class="cm">/* Register name definitions */</span>
<span class="cp">#define TDA10048_IDENTITY          0x00</span>
<span class="cp">#define TDA10048_VERSION           0x01</span>
<span class="cp">#define TDA10048_DSP_CODE_CPT      0x0C</span>
<span class="cp">#define TDA10048_DSP_CODE_IN       0x0E</span>
<span class="cp">#define TDA10048_IN_CONF1          0x10</span>
<span class="cp">#define TDA10048_IN_CONF2          0x11</span>
<span class="cp">#define TDA10048_IN_CONF3          0x12</span>
<span class="cp">#define TDA10048_OUT_CONF1         0x14</span>
<span class="cp">#define TDA10048_OUT_CONF2         0x15</span>
<span class="cp">#define TDA10048_OUT_CONF3         0x16</span>
<span class="cp">#define TDA10048_AUTO              0x18</span>
<span class="cp">#define TDA10048_SYNC_STATUS       0x1A</span>
<span class="cp">#define TDA10048_CONF_C4_1         0x1E</span>
<span class="cp">#define TDA10048_CONF_C4_2         0x1F</span>
<span class="cp">#define TDA10048_CODE_IN_RAM       0x20</span>
<span class="cp">#define TDA10048_CHANNEL_INFO1_R   0x22</span>
<span class="cp">#define TDA10048_CHANNEL_INFO2_R   0x23</span>
<span class="cp">#define TDA10048_CHANNEL_INFO1     0x24</span>
<span class="cp">#define TDA10048_CHANNEL_INFO2     0x25</span>
<span class="cp">#define TDA10048_TIME_ERROR_R      0x26</span>
<span class="cp">#define TDA10048_TIME_ERROR        0x27</span>
<span class="cp">#define TDA10048_FREQ_ERROR_LSB_R  0x28</span>
<span class="cp">#define TDA10048_FREQ_ERROR_MSB_R  0x29</span>
<span class="cp">#define TDA10048_FREQ_ERROR_LSB    0x2A</span>
<span class="cp">#define TDA10048_FREQ_ERROR_MSB    0x2B</span>
<span class="cp">#define TDA10048_IT_SEL            0x30</span>
<span class="cp">#define TDA10048_IT_STAT           0x32</span>
<span class="cp">#define TDA10048_DSP_AD_LSB        0x3C</span>
<span class="cp">#define TDA10048_DSP_AD_MSB        0x3D</span>
<span class="cp">#define TDA10048_DSP_REG_LSB       0x3E</span>
<span class="cp">#define TDA10048_DSP_REG_MSB       0x3F</span>
<span class="cp">#define TDA10048_CONF_TRISTATE1    0x44</span>
<span class="cp">#define TDA10048_CONF_TRISTATE2    0x45</span>
<span class="cp">#define TDA10048_CONF_POLARITY     0x46</span>
<span class="cp">#define TDA10048_GPIO_SP_DS0       0x48</span>
<span class="cp">#define TDA10048_GPIO_SP_DS1       0x49</span>
<span class="cp">#define TDA10048_GPIO_SP_DS2       0x4A</span>
<span class="cp">#define TDA10048_GPIO_SP_DS3       0x4B</span>
<span class="cp">#define TDA10048_GPIO_OUT_SEL      0x4C</span>
<span class="cp">#define TDA10048_GPIO_SELECT       0x4D</span>
<span class="cp">#define TDA10048_IC_MODE           0x4E</span>
<span class="cp">#define TDA10048_CONF_XO           0x50</span>
<span class="cp">#define TDA10048_CONF_PLL1         0x51</span>
<span class="cp">#define TDA10048_CONF_PLL2         0x52</span>
<span class="cp">#define TDA10048_CONF_PLL3         0x53</span>
<span class="cp">#define TDA10048_CONF_ADC          0x54</span>
<span class="cp">#define TDA10048_CONF_ADC_2        0x55</span>
<span class="cp">#define TDA10048_CONF_C1_1         0x60</span>
<span class="cp">#define TDA10048_CONF_C1_3         0x62</span>
<span class="cp">#define TDA10048_AGC_CONF          0x70</span>
<span class="cp">#define TDA10048_AGC_THRESHOLD_LSB 0x72</span>
<span class="cp">#define TDA10048_AGC_THRESHOLD_MSB 0x73</span>
<span class="cp">#define TDA10048_AGC_RENORM        0x74</span>
<span class="cp">#define TDA10048_AGC_GAINS         0x76</span>
<span class="cp">#define TDA10048_AGC_TUN_MIN       0x78</span>
<span class="cp">#define TDA10048_AGC_TUN_MAX       0x79</span>
<span class="cp">#define TDA10048_AGC_IF_MIN        0x7A</span>
<span class="cp">#define TDA10048_AGC_IF_MAX        0x7B</span>
<span class="cp">#define TDA10048_AGC_TUN_LEVEL     0x7E</span>
<span class="cp">#define TDA10048_AGC_IF_LEVEL      0x7F</span>
<span class="cp">#define TDA10048_DIG_AGC_LEVEL     0x81</span>
<span class="cp">#define TDA10048_FREQ_PHY2_LSB     0x86</span>
<span class="cp">#define TDA10048_FREQ_PHY2_MSB     0x87</span>
<span class="cp">#define TDA10048_TIME_INVWREF_LSB  0x88</span>
<span class="cp">#define TDA10048_TIME_INVWREF_MSB  0x89</span>
<span class="cp">#define TDA10048_TIME_WREF_LSB     0x8A</span>
<span class="cp">#define TDA10048_TIME_WREF_MID1    0x8B</span>
<span class="cp">#define TDA10048_TIME_WREF_MID2    0x8C</span>
<span class="cp">#define TDA10048_TIME_WREF_MSB     0x8D</span>
<span class="cp">#define TDA10048_NP_OUT            0xA2</span>
<span class="cp">#define TDA10048_CELL_ID_LSB       0xA4</span>
<span class="cp">#define TDA10048_CELL_ID_MSB       0xA5</span>
<span class="cp">#define TDA10048_EXTTPS_ODD        0xAA</span>
<span class="cp">#define TDA10048_EXTTPS_EVEN       0xAB</span>
<span class="cp">#define TDA10048_TPS_LENGTH        0xAC</span>
<span class="cp">#define TDA10048_FREE_REG_1        0xB2</span>
<span class="cp">#define TDA10048_FREE_REG_2        0xB3</span>
<span class="cp">#define TDA10048_CONF_C3_1         0xC0</span>
<span class="cp">#define TDA10048_CVBER_CTRL        0xC2</span>
<span class="cp">#define TDA10048_CBER_NMAX_LSB     0xC4</span>
<span class="cp">#define TDA10048_CBER_NMAX_MSB     0xC5</span>
<span class="cp">#define TDA10048_CBER_LSB          0xC6</span>
<span class="cp">#define TDA10048_CBER_MSB          0xC7</span>
<span class="cp">#define TDA10048_VBER_LSB          0xC8</span>
<span class="cp">#define TDA10048_VBER_MID          0xC9</span>
<span class="cp">#define TDA10048_VBER_MSB          0xCA</span>
<span class="cp">#define TDA10048_CVBER_LUT         0xCC</span>
<span class="cp">#define TDA10048_UNCOR_CTRL        0xCD</span>
<span class="cp">#define TDA10048_UNCOR_CPT_LSB     0xCE</span>
<span class="cp">#define TDA10048_UNCOR_CPT_MSB     0xCF</span>
<span class="cp">#define TDA10048_SOFT_IT_C3        0xD6</span>
<span class="cp">#define TDA10048_CONF_TS2          0xE0</span>
<span class="cp">#define TDA10048_CONF_TS1          0xE1</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>

<span class="cp">#define dprintk(level, fmt, arg...)\</span>
<span class="cp">	do { if (debug &gt;= level)\</span>
<span class="cp">		printk(KERN_DEBUG &quot;tda10048: &quot; fmt, ## arg);\</span>
<span class="cp">	} while (0)</span>

<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="p">{</span>

	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">;</span>

	<span class="cm">/* We&#39;ll cache and update the attach config settings */</span>
	<span class="k">struct</span> <span class="n">tda10048_config</span> <span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="n">frontend</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">fwloaded</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">freq_if_hz</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xtal_hz</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pll_mfactor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pll_nfactor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pll_pfactor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sample_freq</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">bandwidth</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">init_tab</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">data</span><span class="p">;</span>
<span class="p">}</span> <span class="n">init_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_PLL1</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_ADC_2</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_C4_1</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_PLL1</span><span class="p">,</span> <span class="mh">0x0f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_PLL2</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_PLL3</span><span class="p">,</span> <span class="mh">0x43</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_FREQ_PHY2_LSB</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_FREQ_PHY2_MSB</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_TIME_WREF_LSB</span><span class="p">,</span> <span class="mh">0xbd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_TIME_WREF_MID1</span><span class="p">,</span> <span class="mh">0xe4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_TIME_WREF_MID2</span><span class="p">,</span> <span class="mh">0xa8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_TIME_WREF_MSB</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_TIME_INVWREF_LSB</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_TIME_INVWREF_MSB</span><span class="p">,</span> <span class="mh">0x06</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_C4_1</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_C1_1</span><span class="p">,</span> <span class="mh">0xa8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_AGC_CONF</span><span class="p">,</span> <span class="mh">0x16</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_C1_3</span><span class="p">,</span> <span class="mh">0x0b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_AGC_TUN_MIN</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_AGC_TUN_MAX</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_AGC_IF_MIN</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_AGC_IF_MAX</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_AGC_THRESHOLD_MSB</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_AGC_THRESHOLD_LSB</span><span class="p">,</span> <span class="mh">0x70</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CVBER_CTRL</span><span class="p">,</span> <span class="mh">0x38</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_AGC_GAINS</span><span class="p">,</span> <span class="mh">0x12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_XO</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_TS1</span><span class="p">,</span> <span class="mh">0x07</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_IC_MODE</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_TS2</span><span class="p">,</span> <span class="mh">0xc0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_TRISTATE1</span><span class="p">,</span> <span class="mh">0x21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_TRISTATE2</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_POLARITY</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_C4_2</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_ADC</span><span class="p">,</span> <span class="mh">0x60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_ADC_2</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_ADC</span><span class="p">,</span> <span class="mh">0x60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_ADC_2</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_C1_1</span><span class="p">,</span> <span class="mh">0xa8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_UNCOR_CTRL</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CONF_C4_2</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pll_tab</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">clk_freq_khz</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">if_freq_khz</span><span class="p">;</span>
<span class="p">}</span> <span class="n">pll_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TDA10048_CLK_4000</span><span class="p">,</span>  <span class="n">TDA10048_IF_36130</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CLK_16000</span><span class="p">,</span> <span class="n">TDA10048_IF_3300</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CLK_16000</span><span class="p">,</span> <span class="n">TDA10048_IF_3500</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CLK_16000</span><span class="p">,</span> <span class="n">TDA10048_IF_3800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CLK_16000</span><span class="p">,</span> <span class="n">TDA10048_IF_4000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CLK_16000</span><span class="p">,</span> <span class="n">TDA10048_IF_4300</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CLK_16000</span><span class="p">,</span> <span class="n">TDA10048_IF_4500</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CLK_16000</span><span class="p">,</span> <span class="n">TDA10048_IF_5000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TDA10048_CLK_16000</span><span class="p">,</span> <span class="n">TDA10048_IF_36130</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_writereg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(reg = 0x%02x, data = 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: writereg error (ret == %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">tda10048_readreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">b1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b0</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b1</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(reg = 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: readreg error (ret == %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">b1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_writeregbulk</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span>
				 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(%d, ?, len = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s():  write len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s(): writereg error err %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_set_phy2</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sample_freq_hz</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">if_hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sample_freq_hz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">if_hz</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sample_freq_hz</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* PHY2 = (if2/fs) * 2^15 */</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">if_hz</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">*=</span> <span class="mi">32768</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sample_freq_hz</span><span class="p">);</span>
		<span class="n">t</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* PHY2 = ((IF1-fs)/fs) * 2^15 */</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">sample_freq_hz</span> <span class="o">-</span> <span class="n">if_hz</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">*=</span> <span class="mi">32768</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sample_freq_hz</span><span class="p">);</span>
		<span class="n">t</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">t</span> <span class="o">=</span> <span class="o">~</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_FREQ_PHY2_LSB</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">t</span><span class="p">);</span>
	<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_FREQ_PHY2_MSB</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">t</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_set_wref</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sample_freq_hz</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sample_freq_hz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* WREF = (B / (7 * fs)) * 2^31 */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">bw</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
	<span class="cm">/* avoid warning: this decimal constant is unsigned only in ISO C90 */</span>
	<span class="cm">/* t *= 2147483648 on 32bit platforms */</span>
	<span class="n">t</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">2048</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">*=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">z</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">sample_freq_hz</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_TIME_WREF_LSB</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">t</span><span class="p">);</span>
	<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_TIME_WREF_MID1</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">t</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_TIME_WREF_MID2</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">t</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_TIME_WREF_MSB</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">t</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_set_invwref</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sample_freq_hz</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sample_freq_hz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* INVWREF = ((7 * fs) / B) * 2^5 */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">sample_freq_hz</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">*=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">*=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">bw</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_TIME_INVWREF_LSB</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">t</span><span class="p">);</span>
	<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_TIME_INVWREF_MSB</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">t</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_set_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(bw=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bw</span><span class="p">);</span>

	<span class="cm">/* Bandwidth setting may need to be adjusted */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bw</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6000000</span>:
	<span class="k">case</span> <span class="mi">7000000</span>:
	<span class="k">case</span> <span class="mi">8000000</span>:
		<span class="n">tda10048_set_wref</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">sample_freq</span><span class="p">,</span> <span class="n">bw</span><span class="p">);</span>
		<span class="n">tda10048_set_invwref</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">sample_freq</span><span class="p">,</span> <span class="n">bw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() invalid bandwidth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">bw</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_set_if</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tda10048_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">if_freq_khz</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(bw = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bw</span><span class="p">);</span>

	<span class="cm">/* based on target bandwidth and clk we calculate pll factors */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bw</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6000000</span>:
		<span class="n">if_freq_khz</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dtv6_if_freq_khz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7000000</span>:
		<span class="n">if_freq_khz</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dtv7_if_freq_khz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8000000</span>:
		<span class="n">if_freq_khz</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dtv8_if_freq_khz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() no default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pll_tab</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pll_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clk_freq_khz</span> <span class="o">==</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">clk_freq_khz</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">pll_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">if_freq_khz</span> <span class="o">==</span> <span class="n">if_freq_khz</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">state</span><span class="o">-&gt;</span><span class="n">freq_if_hz</span> <span class="o">=</span> <span class="n">pll_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">if_freq_khz</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">xtal_hz</span> <span class="o">=</span> <span class="n">pll_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clk_freq_khz</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pll_tab</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() Incorrect attach settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;- freq_if_hz = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">freq_if_hz</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;- xtal_hz = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">xtal_hz</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;- pll_mfactor = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_mfactor</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;- pll_nfactor = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_nfactor</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;- pll_pfactor = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_pfactor</span><span class="p">);</span>

	<span class="cm">/* Calculate the sample frequency */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">sample_freq</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">xtal_hz</span> <span class="o">*</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_mfactor</span> <span class="o">+</span> <span class="mi">45</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">sample_freq</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_nfactor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">sample_freq</span> <span class="o">/=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_pfactor</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;- sample_freq = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">sample_freq</span><span class="p">);</span>

	<span class="cm">/* Update the I/F */</span>
	<span class="n">tda10048_set_phy2</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">sample_freq</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">freq_if_hz</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_firmware_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tda10048_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wlen</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">fwbulkwritelen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wlen</span> <span class="o">!=</span> <span class="n">TDA10048_BULKWRITE_200</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wlen</span> <span class="o">!=</span> <span class="n">TDA10048_BULKWRITE_50</span><span class="p">))</span>
		<span class="n">wlen</span> <span class="o">=</span> <span class="n">TDA10048_BULKWRITE_200</span><span class="p">;</span>

	<span class="cm">/* request the firmware, this will block and timeout */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: waiting for firmware upload (%s)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">TDA10048_DEFAULT_FIRMWARE</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">TDA10048_DEFAULT_FIRMWARE</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Upload failed. (file not found?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: firmware read %Zu bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="n">TDA10048_DEFAULT_FIRMWARE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: firmware incorrect size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: firmware uploading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/* Soft reset */</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_TRISTATE1</span><span class="p">,</span>
			<span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_TRISTATE1</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">);</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_TRISTATE1</span><span class="p">,</span>
			<span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_TRISTATE1</span><span class="p">)</span>
				<span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>

		<span class="cm">/* Put the demod into host download mode */</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_C4_1</span><span class="p">,</span>
			<span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_C4_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf9</span><span class="p">);</span>

		<span class="cm">/* Boot the DSP */</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_C4_1</span><span class="p">,</span>
			<span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_C4_1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">);</span>

		<span class="cm">/* Prepare for download */</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_DSP_CODE_CPT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Download the firmware payload */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">wlen</span><span class="p">)</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="n">wlen</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">pos</span><span class="p">;</span>

			<span class="n">tda10048_writeregbulk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_DSP_CODE_IN</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">cnt</span><span class="p">);</span>

			<span class="n">pos</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="cm">/* Wait up to 250ms for the DSP to boot */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">250</span> <span class="p">;</span> <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_SYNC_STATUS</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: firmware uploaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fwloaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: firmware upload failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_set_inversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inversion</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">inversion</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inversion</span> <span class="o">==</span> <span class="n">TDA10048_INVERSION_ON</span><span class="p">)</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_C1_1</span><span class="p">,</span>
			<span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_C1_1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_C1_1</span><span class="p">,</span>
			<span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_C1_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xdf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Retrieve the demod settings */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_get_tps</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Make sure the TPS regs are valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_AUTO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_OUT_CONF2</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QPSK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_1_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_5_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_7_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_OUT_CONF3</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_1_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_5_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_7_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_OUT_CONF1</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span>  <span class="n">GUARD_INTERVAL_1_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span>  <span class="n">GUARD_INTERVAL_1_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_2K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_i2c_gate_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tda10048_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">disable_gate_access</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_C4_1</span><span class="p">,</span>
			<span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_C4_1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_C4_1</span><span class="p">,</span>
			<span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_C4_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_output_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">serial</span><span class="p">);</span>

	<span class="cm">/* Ensure pins are out of tri-state */</span>
	<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_TRISTATE1</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
	<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_TRISTATE2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_IC_MODE</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_TS2</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_IC_MODE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_TS2</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Talk to the demod, set the FEC, GUARD, QAM settings etc */</span>
<span class="cm">/* TODO: Support manual tuning with specific params */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(frequency=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>

	<span class="cm">/* Update the I/F pll&#39;s if the bandwidth changes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">bandwidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tda10048_set_if</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">);</span>
		<span class="n">tda10048_set_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable demod TPS auto detection and begin acquisition */</span>
	<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_AUTO</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">);</span>
	<span class="cm">/* trigger cber and vber acquisition */</span>
	<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CVBER_CTRL</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Establish sane defaults and load firmware. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tda10048_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* PLL */</span>
	<span class="n">init_tab</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_mfactor</span><span class="p">);</span>
	<span class="n">init_tab</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_nfactor</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="cm">/* Apply register defaults */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">init_tab</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">init_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="n">init_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fwloaded</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tda10048_firmware_upload</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="cm">/* Set either serial or parallel */</span>
	<span class="n">tda10048_output_mode</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">output_mode</span><span class="p">);</span>

	<span class="cm">/* Set inversion */</span>
	<span class="n">tda10048_set_inversion</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">);</span>

	<span class="cm">/* Establish default RF values */</span>
	<span class="n">tda10048_set_if</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">8000000</span><span class="p">);</span>
	<span class="n">tda10048_set_bandwidth</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">8000000</span><span class="p">);</span>

	<span class="cm">/* Ensure we leave the gate closed */</span>
	<span class="n">tda10048_i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_SYNC_STATUS</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() status =0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_CARRIER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_SIGNAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_SYNC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">cber_current</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cber_nmax</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cber_tmp</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* update cber on interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_SOFT_IT_C3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cber_tmp</span> <span class="o">=</span> <span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CBER_MSB</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CBER_LSB</span><span class="p">);</span>
		<span class="n">cber_nmax</span> <span class="o">=</span> <span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CBER_NMAX_MSB</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CBER_NMAX_LSB</span><span class="p">);</span>
		<span class="n">cber_tmp</span> <span class="o">*=</span> <span class="mi">100000000</span><span class="p">;</span>
		<span class="n">cber_tmp</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">cber_tmp</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">cber_tmp</span><span class="p">,</span> <span class="p">(</span><span class="n">cber_nmax</span> <span class="o">*</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cber_current</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cber_tmp</span><span class="p">;</span>
		<span class="cm">/* retrigger cber acquisition */</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CVBER_CTRL</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* actual cber is (*ber)/1e8 */</span>
	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="n">cber_current</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">signal_strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="o">*</span><span class="n">signal_strength</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_NP_OUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">signal_strength</span> <span class="o">-=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SNR lookup table */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snr_tab</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span> <span class="n">snr_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">246</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">2</span><span class="p">,</span> <span class="mi">215</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">3</span><span class="p">,</span> <span class="mi">198</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">4</span><span class="p">,</span> <span class="mi">185</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">5</span><span class="p">,</span> <span class="mi">176</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">6</span><span class="p">,</span> <span class="mi">168</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">7</span><span class="p">,</span> <span class="mi">161</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">8</span><span class="p">,</span> <span class="mi">155</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">9</span><span class="p">,</span> <span class="mi">150</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">10</span><span class="p">,</span> <span class="mi">146</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">11</span><span class="p">,</span> <span class="mi">141</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">12</span><span class="p">,</span> <span class="mi">138</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">13</span><span class="p">,</span> <span class="mi">134</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">14</span><span class="p">,</span> <span class="mi">131</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">15</span><span class="p">,</span> <span class="mi">128</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">16</span><span class="p">,</span> <span class="mi">125</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">17</span><span class="p">,</span> <span class="mi">122</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">18</span><span class="p">,</span> <span class="mi">120</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">19</span><span class="p">,</span> <span class="mi">118</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">20</span><span class="p">,</span> <span class="mi">115</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">21</span><span class="p">,</span> <span class="mi">113</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">22</span><span class="p">,</span> <span class="mi">111</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">23</span><span class="p">,</span> <span class="mi">109</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">24</span><span class="p">,</span> <span class="mi">107</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">25</span><span class="p">,</span> <span class="mi">106</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">26</span><span class="p">,</span> <span class="mi">104</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">27</span><span class="p">,</span> <span class="mi">102</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">28</span><span class="p">,</span> <span class="mi">101</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">29</span><span class="p">,</span>  <span class="mi">99</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">98</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">31</span><span class="p">,</span>  <span class="mi">96</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">32</span><span class="p">,</span>  <span class="mi">95</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">33</span><span class="p">,</span>  <span class="mi">94</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">34</span><span class="p">,</span>  <span class="mi">92</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">35</span><span class="p">,</span>  <span class="mi">91</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">36</span><span class="p">,</span>  <span class="mi">90</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">37</span><span class="p">,</span>  <span class="mi">89</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">38</span><span class="p">,</span>  <span class="mi">88</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">39</span><span class="p">,</span>  <span class="mi">86</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">40</span><span class="p">,</span>  <span class="mi">85</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">41</span><span class="p">,</span>  <span class="mi">84</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">42</span><span class="p">,</span>  <span class="mi">83</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">43</span><span class="p">,</span>  <span class="mi">82</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">44</span><span class="p">,</span>  <span class="mi">81</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">45</span><span class="p">,</span>  <span class="mi">80</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">46</span><span class="p">,</span>  <span class="mi">79</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">47</span><span class="p">,</span>  <span class="mi">78</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">48</span><span class="p">,</span>  <span class="mi">77</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">49</span><span class="p">,</span>  <span class="mi">76</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">50</span><span class="p">,</span>  <span class="mi">76</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">51</span><span class="p">,</span>  <span class="mi">75</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">52</span><span class="p">,</span>  <span class="mi">74</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">53</span><span class="p">,</span>  <span class="mi">73</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">54</span><span class="p">,</span>  <span class="mi">72</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">56</span><span class="p">,</span>  <span class="mi">71</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">57</span><span class="p">,</span>  <span class="mi">70</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">58</span><span class="p">,</span>  <span class="mi">69</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">60</span><span class="p">,</span>  <span class="mi">68</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">61</span><span class="p">,</span>  <span class="mi">67</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">63</span><span class="p">,</span>  <span class="mi">66</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">64</span><span class="p">,</span>  <span class="mi">65</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">66</span><span class="p">,</span>  <span class="mi">64</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">67</span><span class="p">,</span>  <span class="mi">63</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">68</span><span class="p">,</span>  <span class="mi">62</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">69</span><span class="p">,</span>  <span class="mi">62</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">70</span><span class="p">,</span>  <span class="mi">61</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">72</span><span class="p">,</span>  <span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">74</span><span class="p">,</span>  <span class="mi">59</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">75</span><span class="p">,</span>  <span class="mi">58</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">77</span><span class="p">,</span>  <span class="mi">57</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">79</span><span class="p">,</span>  <span class="mi">56</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">81</span><span class="p">,</span>  <span class="mi">55</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">83</span><span class="p">,</span>  <span class="mi">54</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">85</span><span class="p">,</span>  <span class="mi">53</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">87</span><span class="p">,</span>  <span class="mi">52</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">89</span><span class="p">,</span>  <span class="mi">51</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">91</span><span class="p">,</span>  <span class="mi">50</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">93</span><span class="p">,</span>  <span class="mi">49</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">95</span><span class="p">,</span>  <span class="mi">48</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">97</span><span class="p">,</span>  <span class="mi">47</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">100</span><span class="p">,</span>  <span class="mi">46</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">102</span><span class="p">,</span>  <span class="mi">45</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">104</span><span class="p">,</span>  <span class="mi">44</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">107</span><span class="p">,</span>  <span class="mi">43</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">109</span><span class="p">,</span>  <span class="mi">42</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">112</span><span class="p">,</span>  <span class="mi">41</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">114</span><span class="p">,</span>  <span class="mi">40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">117</span><span class="p">,</span>  <span class="mi">39</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">120</span><span class="p">,</span>  <span class="mi">38</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">123</span><span class="p">,</span>  <span class="mi">37</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">125</span><span class="p">,</span>  <span class="mi">36</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">128</span><span class="p">,</span>  <span class="mi">35</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">131</span><span class="p">,</span>  <span class="mi">34</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">134</span><span class="p">,</span>  <span class="mi">33</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">138</span><span class="p">,</span>  <span class="mi">32</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">141</span><span class="p">,</span>  <span class="mi">31</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">144</span><span class="p">,</span>  <span class="mi">30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">147</span><span class="p">,</span>  <span class="mi">29</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">151</span><span class="p">,</span>  <span class="mi">28</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">154</span><span class="p">,</span>  <span class="mi">27</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">158</span><span class="p">,</span>  <span class="mi">26</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">162</span><span class="p">,</span>  <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">165</span><span class="p">,</span>  <span class="mi">24</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">169</span><span class="p">,</span>  <span class="mi">23</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">173</span><span class="p">,</span>  <span class="mi">22</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">177</span><span class="p">,</span>  <span class="mi">21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">181</span><span class="p">,</span>  <span class="mi">20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">186</span><span class="p">,</span>  <span class="mi">19</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">190</span><span class="p">,</span>  <span class="mi">18</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">194</span><span class="p">,</span>  <span class="mi">17</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">199</span><span class="p">,</span>  <span class="mi">16</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">204</span><span class="p">,</span>  <span class="mi">15</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">208</span><span class="p">,</span>  <span class="mi">14</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">213</span><span class="p">,</span>  <span class="mi">13</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">218</span><span class="p">,</span>  <span class="mi">12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">223</span><span class="p">,</span>  <span class="mi">11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">229</span><span class="p">,</span>  <span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">234</span><span class="p">,</span>   <span class="mi">9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">239</span><span class="p">,</span>   <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">245</span><span class="p">,</span>   <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">251</span><span class="p">,</span>   <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">255</span><span class="p">,</span>   <span class="mi">5</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_NP_OUT</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snr_tab</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;=</span> <span class="n">snr_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">snr_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_read_ucblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ucblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ucblocks</span> <span class="o">=</span> <span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_UNCOR_CPT_MSB</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
		<span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_UNCOR_CPT_LSB</span><span class="p">);</span>
	<span class="cm">/* clear the uncorrected TS packets counter when saturated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ucblocks</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="n">tda10048_writereg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_UNCOR_CTRL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_CONF_C1_1</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="mh">0x20</span> <span class="o">?</span> <span class="n">INVERSION_ON</span> <span class="o">:</span> <span class="n">INVERSION_OFF</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tda10048_get_tps</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10048_get_tune_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span> <span class="o">*</span><span class="n">tune</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tune</span><span class="o">-&gt;</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda10048_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda10048_establish_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tda10048_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="cm">/* Validate/default the config */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">dtv6_if_freq_khz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">dtv6_if_freq_khz</span> <span class="o">=</span> <span class="n">TDA10048_IF_4300</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s() tda10048_config.dtv6_if_freq_khz &quot;</span>
			<span class="s">&quot;is not set (defaulting to %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">dtv6_if_freq_khz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">dtv7_if_freq_khz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">dtv7_if_freq_khz</span> <span class="o">=</span> <span class="n">TDA10048_IF_4300</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s() tda10048_config.dtv7_if_freq_khz &quot;</span>
			<span class="s">&quot;is not set (defaulting to %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">dtv7_if_freq_khz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">dtv8_if_freq_khz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">dtv8_if_freq_khz</span> <span class="o">=</span> <span class="n">TDA10048_IF_4300</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s() tda10048_config.dtv8_if_freq_khz &quot;</span>
			<span class="s">&quot;is not set (defaulting to %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">dtv8_if_freq_khz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">clk_freq_khz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">clk_freq_khz</span> <span class="o">=</span> <span class="n">TDA10048_CLK_16000</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s() tda10048_config.clk_freq_khz &quot;</span>
			<span class="s">&quot;is not set (defaulting to %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">clk_freq_khz</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">tda10048_ops</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">tda10048_attach</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tda10048_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda10048_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* allocate memory for the internal state */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda10048_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* setup the state and clone the config */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">fwloaded</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">no_firmware</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="mi">8000000</span><span class="p">;</span>

	<span class="cm">/* check if the demod is present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tda10048_readreg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10048_IDENTITY</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x048</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* create dvb_frontend */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tda10048_ops</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="cm">/* set pll */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_pll</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_mfactor</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">pll_m</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_nfactor</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">pll_n</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_pfactor</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">pll_p</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_mfactor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_nfactor</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pll_pfactor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Establish any defaults the the user didn&#39;t pass */</span>
	<span class="n">tda10048_establish_defaults</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">);</span>

	<span class="cm">/* Set the xtal and freq defaults */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tda10048_set_if</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">8000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Default bandwidth */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tda10048_set_bandwidth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">8000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Leave the gate closed */</span>
	<span class="n">tda10048_i2c_gate_ctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tda10048_attach</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">tda10048_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBT</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;NXP TDA10048HN DVB-T&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span>		<span class="o">=</span> <span class="mi">177000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span>		<span class="o">=</span> <span class="mi">858000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span>	<span class="o">=</span> <span class="mi">166666</span><span class="p">,</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span>
		<span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
		<span class="n">FE_CAN_QPSK</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_AUTO</span> <span class="o">|</span>
		<span class="n">FE_CAN_HIERARCHY_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_GUARD_INTERVAL_AUTO</span> <span class="o">|</span>
		<span class="n">FE_CAN_TRANSMISSION_MODE_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_RECOVER</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">tda10048_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">tda10048_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">i2c_gate_ctrl</span> <span class="o">=</span> <span class="n">tda10048_i2c_gate_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">tda10048_set_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend</span> <span class="o">=</span> <span class="n">tda10048_get_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">=</span> <span class="n">tda10048_get_tune_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">tda10048_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">tda10048_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">tda10048_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">tda10048_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">tda10048_read_ucblocks</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Enable verbose debug messages&quot;</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;NXP TDA10048HN DVB-T Demodulator driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Steven Toth&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
