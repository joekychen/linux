<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › dib3000mb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dib3000mb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Frontend driver for mobile DVB-T demodulator DiBcom 3000M-B</span>
<span class="cm"> * DiBcom (http://www.dibcom.fr/)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004-5 Patrick Boettcher (patrick.boettcher@desy.de)</span>
<span class="cm"> *</span>
<span class="cm"> * based on GPL code from DibCom, which has</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Amaury Demol for DiBcom (ademol@dibcom.fr)</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *	published by the Free Software Foundation, version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * Acknowledgements</span>
<span class="cm"> *</span>
<span class="cm"> *  Amaury Demol (ademol@dibcom.fr) from DiBcom for providing specs and driver</span>
<span class="cm"> *  sources, on which this driver (and the dvb-dibusb) are based.</span>
<span class="cm"> *</span>
<span class="cm"> * see Documentation/dvb/README.dvb-usb for more information</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;dvb_frontend.h&quot;</span>

<span class="cp">#include &quot;dib3000.h&quot;</span>
<span class="cp">#include &quot;dib3000mb_priv.h&quot;</span>

<span class="cm">/* Version information */</span>
<span class="cp">#define DRIVER_VERSION &quot;0.1&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;DiBcom 3000M-B DVB-T demodulator&quot;</span>
<span class="cp">#define DRIVER_AUTHOR &quot;Patrick Boettcher, patrick.boettcher@desy.de&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;set debugging level (1=info,2=xfer,4=setfe,8=getfe (|-able)).&quot;</span><span class="p">);</span>

<span class="cp">#define deb_info(args...) dprintk(0x01,args)</span>
<span class="cp">#define deb_i2c(args...)  dprintk(0x02,args)</span>
<span class="cp">#define deb_srch(args...) dprintk(0x04,args)</span>
<span class="cp">#define deb_info(args...) dprintk(0x01,args)</span>
<span class="cp">#define deb_xfer(args...) dprintk(0x02,args)</span>
<span class="cp">#define deb_setf(args...) dprintk(0x04,args)</span>
<span class="cp">#define deb_getf(args...) dprintk(0x08,args)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib3000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">wb</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">rb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">demod_address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>        <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">wb</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">demod_address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">rb</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">deb_i2c</span><span class="p">(</span><span class="s">&quot;i2c read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">deb_i2c</span><span class="p">(</span><span class="s">&quot;reading i2c bus (reg: %5d 0x%04x, val: %5d 0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span>
			<span class="p">(</span><span class="n">rb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rb</span><span class="p">[</span><span class="mi">1</span><span class="p">],(</span><span class="n">rb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib3000_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">demod_address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="n">deb_i2c</span><span class="p">(</span><span class="s">&quot;writing i2c bus (reg: %5d 0x%04x, val: %5d 0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">?</span> <span class="o">-</span><span class="n">EREMOTEIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000_search_status</span><span class="p">(</span><span class="n">u16</span> <span class="n">irq</span><span class="p">,</span><span class="n">u16</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">deb_srch</span><span class="p">(</span><span class="s">&quot;auto search succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// auto search succeeded</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">deb_srch</span><span class="p">(</span><span class="s">&quot;auto search not successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// auto search failed</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">deb_srch</span><span class="p">(</span><span class="s">&quot;auto search failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// auto search failed</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// try again</span>
<span class="p">}</span>

<span class="cm">/* for auto search */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">dib3000_seq</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>     <span class="cm">/* fft,gua,   inv   */</span>
	<span class="p">{</span> <span class="cm">/* fft */</span>
		<span class="p">{</span> <span class="cm">/* gua */</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>                   <span class="cm">/*  0   0   { 0,1 } */</span>
			<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span> <span class="p">},</span>                   <span class="cm">/*  0   1   { 0,1 } */</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span>                   <span class="cm">/*  1   0   { 0,1 } */</span>
			<span class="p">{</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>                  <span class="cm">/*  1   1   { 0,1 } */</span>
		<span class="p">}</span>
	<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dib3000mb_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tuner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="n">fe_code_rate_t</span> <span class="n">fe_cr</span> <span class="o">=</span> <span class="n">FEC_NONE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">search_state</span><span class="p">,</span> <span class="n">seq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tuner</span> <span class="o">&amp;&amp;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;bandwidth: &quot;</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">8000000</span>:
				<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;8 MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_timing_freq</span><span class="p">,</span> <span class="n">dib3000mb_timing_freq</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_bandwidth</span><span class="p">,</span> <span class="n">dib3000mb_bandwidth_8mhz</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">7000000</span>:
				<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;7 MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_timing_freq</span><span class="p">,</span> <span class="n">dib3000mb_timing_freq</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_bandwidth</span><span class="p">,</span> <span class="n">dib3000mb_bandwidth_7mhz</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6000000</span>:
				<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;6 MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_timing_freq</span><span class="p">,</span> <span class="n">dib3000mb_timing_freq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_bandwidth</span><span class="p">,</span> <span class="n">dib3000mb_bandwidth_6mhz</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">err</span><span class="p">(</span><span class="s">&quot;unknown bandwidth value.&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_LOCK1_MASK</span><span class="p">,</span> <span class="n">DIB3000MB_LOCK1_SEARCH_4</span><span class="p">);</span>

	<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;transmission mode: &quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;2k</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_FFT</span><span class="p">,</span> <span class="n">DIB3000_TRANSMISSION_MODE_2K</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;8k</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_FFT</span><span class="p">,</span> <span class="n">DIB3000_TRANSMISSION_MODE_8K</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_AUTO</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;auto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;guard: &quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">guard_interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_32</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;1_32</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_GUARD_TIME</span><span class="p">,</span> <span class="n">DIB3000_GUARD_TIME_1_32</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_16</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;1_16</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_GUARD_TIME</span><span class="p">,</span> <span class="n">DIB3000_GUARD_TIME_1_16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_8</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;1_8</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_GUARD_TIME</span><span class="p">,</span> <span class="n">DIB3000_GUARD_TIME_1_8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_4</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;1_4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_GUARD_TIME</span><span class="p">,</span> <span class="n">DIB3000_GUARD_TIME_1_4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_AUTO</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;auto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;inversion: &quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INVERSION_OFF</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_DDS_INV</span><span class="p">,</span> <span class="n">DIB3000_DDS_INVERSION_OFF</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INVERSION_AUTO</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;auto &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INVERSION_ON</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_DDS_INV</span><span class="p">,</span> <span class="n">DIB3000_DDS_INVERSION_ON</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;modulation: &quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QPSK</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;qpsk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_QAM</span><span class="p">,</span> <span class="n">DIB3000_CONSTELLATION_QPSK</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QAM_16</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;qam16</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_QAM</span><span class="p">,</span> <span class="n">DIB3000_CONSTELLATION_16QAM</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QAM_64</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;qam64</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_QAM</span><span class="p">,</span> <span class="n">DIB3000_CONSTELLATION_64QAM</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QAM_AUTO</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;hierarchy: &quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HIERARCHY_NONE</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;none &quot;</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">HIERARCHY_1</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;alpha=1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_VIT_ALPHA</span><span class="p">,</span> <span class="n">DIB3000_ALPHA_1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HIERARCHY_2</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;alpha=2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_VIT_ALPHA</span><span class="p">,</span> <span class="n">DIB3000_ALPHA_2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HIERARCHY_4</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;alpha=4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_VIT_ALPHA</span><span class="p">,</span> <span class="n">DIB3000_ALPHA_4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HIERARCHY_AUTO</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;alpha=auto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;hierarchy: &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">HIERARCHY_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_VIT_HRCH</span><span class="p">,</span> <span class="n">DIB3000_HRCH_OFF</span><span class="p">);</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_VIT_HP</span><span class="p">,</span> <span class="n">DIB3000_SELECT_HP</span><span class="p">);</span>
		<span class="n">fe_cr</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">!=</span> <span class="n">HIERARCHY_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_VIT_HRCH</span><span class="p">,</span> <span class="n">DIB3000_HRCH_ON</span><span class="p">);</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_VIT_HP</span><span class="p">,</span> <span class="n">DIB3000_SELECT_LP</span><span class="p">);</span>
		<span class="n">fe_cr</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;fec: &quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fe_cr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FEC_1_2</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;1_2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_VIT_CODE_RATE</span><span class="p">,</span> <span class="n">DIB3000_FEC_1_2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_2_3</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;2_3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_VIT_CODE_RATE</span><span class="p">,</span> <span class="n">DIB3000_FEC_2_3</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_3_4</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;3_4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_VIT_CODE_RATE</span><span class="p">,</span> <span class="n">DIB3000_FEC_3_4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_5_6</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;5_6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_VIT_CODE_RATE</span><span class="p">,</span> <span class="n">DIB3000_FEC_5_6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_7_8</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;7_8</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_VIT_CODE_RATE</span><span class="p">,</span> <span class="n">DIB3000_FEC_7_8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_NONE</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;none &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_AUTO</span>:
			<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;auto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seq</span> <span class="o">=</span> <span class="n">dib3000_seq</span>
		<span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">==</span> <span class="n">TRANSMISSION_MODE_AUTO</span><span class="p">]</span>
		<span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">==</span> <span class="n">GUARD_INTERVAL_AUTO</span><span class="p">]</span>
		<span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">==</span> <span class="n">INVERSION_AUTO</span><span class="p">];</span>

	<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;seq? %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_SEQ</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_ISI</span><span class="p">,</span> <span class="n">seq</span> <span class="o">?</span> <span class="n">DIB3000MB_ISI_INHIBIT</span> <span class="o">:</span> <span class="n">DIB3000MB_ISI_ACTIVATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">==</span> <span class="n">TRANSMISSION_MODE_2K</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">==</span> <span class="n">GUARD_INTERVAL_1_8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_SYNC_IMPROVEMENT</span><span class="p">,</span> <span class="n">DIB3000MB_SYNC_IMPROVE_2K_1_8</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_SYNC_IMPROVEMENT</span><span class="p">,</span> <span class="n">DIB3000MB_SYNC_IMPROVE_DEFAULT</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_121</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_121_2K</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_121</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_121_DEFAULT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_MOBILE_ALGO</span><span class="p">,</span> <span class="n">DIB3000MB_MOBILE_ALGO_OFF</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_MOBILE_MODE_QAM</span><span class="p">,</span> <span class="n">DIB3000MB_MOBILE_MODE_QAM_OFF</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_MOBILE_MODE</span><span class="p">,</span> <span class="n">DIB3000MB_MOBILE_MODE_OFF</span><span class="p">);</span>

	<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_agc_bandwidth</span><span class="p">,</span> <span class="n">dib3000mb_agc_bandwidth_high</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_ISI</span><span class="p">,</span> <span class="n">DIB3000MB_ISI_ACTIVATE</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_RESTART</span><span class="p">,</span> <span class="n">DIB3000MB_RESTART_AGC</span> <span class="o">+</span> <span class="n">DIB3000MB_RESTART_CTRL</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_RESTART</span><span class="p">,</span> <span class="n">DIB3000MB_RESTART_OFF</span><span class="p">);</span>

	<span class="cm">/* wait for AGC lock */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">70</span><span class="p">);</span>

	<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_agc_bandwidth</span><span class="p">,</span> <span class="n">dib3000mb_agc_bandwidth_low</span><span class="p">);</span>

	<span class="cm">/* something has to be auto searched */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_AUTO</span> <span class="o">||</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">HIERARCHY_AUTO</span> <span class="o">||</span>
		<span class="n">fe_cr</span> <span class="o">==</span> <span class="n">FEC_AUTO</span> <span class="o">||</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">==</span> <span class="n">INVERSION_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">as_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

		<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;autosearch enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_ISI</span><span class="p">,</span> <span class="n">DIB3000MB_ISI_INHIBIT</span><span class="p">);</span>

		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_RESTART</span><span class="p">,</span> <span class="n">DIB3000MB_RESTART_AUTO_SEARCH</span><span class="p">);</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_RESTART</span><span class="p">,</span> <span class="n">DIB3000MB_RESTART_OFF</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">search_state</span> <span class="o">=</span>
				<span class="n">dib3000_search_status</span><span class="p">(</span>
					<span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_AS_IRQ_PENDING</span><span class="p">),</span>
					<span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_LOCK2_VALUE</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">as_count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;search_state after autosearch %d after %d checks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">search_state</span><span class="p">,</span><span class="n">as_count</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">search_state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dib3000mb_get_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">deb_setf</span><span class="p">(</span><span class="s">&quot;reading tuning data from frontend succeeded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">dib3000mb_set_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_RESTART</span><span class="p">,</span> <span class="n">DIB3000MB_RESTART_CTRL</span><span class="p">);</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_RESTART</span><span class="p">,</span> <span class="n">DIB3000MB_RESTART_OFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_fe_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mobile_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;dib3000mb is getting up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_POWER_CONTROL</span><span class="p">,</span> <span class="n">DIB3000MB_POWER_UP</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_RESTART</span><span class="p">,</span> <span class="n">DIB3000MB_RESTART_AGC</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_RESET_DEVICE</span><span class="p">,</span> <span class="n">DIB3000MB_RESET_DEVICE</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_RESET_DEVICE</span><span class="p">,</span> <span class="n">DIB3000MB_RESET_DEVICE_RST</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_CLOCK</span><span class="p">,</span> <span class="n">DIB3000MB_CLOCK_DEFAULT</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_ELECT_OUT_MODE</span><span class="p">,</span> <span class="n">DIB3000MB_ELECT_OUT_MODE_ON</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_DDS_FREQ_MSB</span><span class="p">,</span> <span class="n">DIB3000MB_DDS_FREQ_MSB</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_DDS_FREQ_LSB</span><span class="p">,</span> <span class="n">DIB3000MB_DDS_FREQ_LSB</span><span class="p">);</span>

	<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_timing_freq</span><span class="p">,</span> <span class="n">dib3000mb_timing_freq</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_impulse_noise</span><span class="p">,</span>
			<span class="n">dib3000mb_impulse_noise_values</span><span class="p">[</span><span class="n">DIB3000MB_IMPNOISE_OFF</span><span class="p">]);</span>

	<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_agc_gain</span><span class="p">,</span> <span class="n">dib3000mb_default_agc_gain</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_PHASE_NOISE</span><span class="p">,</span> <span class="n">DIB3000MB_PHASE_NOISE_DEFAULT</span><span class="p">);</span>

	<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_phase_noise</span><span class="p">,</span> <span class="n">dib3000mb_default_noise_phase</span><span class="p">);</span>

	<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_lock_duration</span><span class="p">,</span> <span class="n">dib3000mb_default_lock_duration</span><span class="p">);</span>

	<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_agc_bandwidth</span><span class="p">,</span> <span class="n">dib3000mb_agc_bandwidth_low</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_LOCK0_MASK</span><span class="p">,</span> <span class="n">DIB3000MB_LOCK0_DEFAULT</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_LOCK1_MASK</span><span class="p">,</span> <span class="n">DIB3000MB_LOCK1_SEARCH_4</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_LOCK2_MASK</span><span class="p">,</span> <span class="n">DIB3000MB_LOCK2_DEFAULT</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_SEQ</span><span class="p">,</span> <span class="n">dib3000_seq</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_bandwidth</span><span class="p">,</span> <span class="n">dib3000mb_bandwidth_8mhz</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_68</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_68</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_69</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_69</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_71</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_71</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_77</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_77</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_78</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_78</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_ISI</span><span class="p">,</span> <span class="n">DIB3000MB_ISI_INHIBIT</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_92</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_92</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_96</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_96</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_97</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_97</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_106</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_106</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_107</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_107</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_108</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_108</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_UNK_122</span><span class="p">,</span> <span class="n">DIB3000MB_UNK_122</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_MOBILE_MODE_QAM</span><span class="p">,</span> <span class="n">DIB3000MB_MOBILE_MODE_QAM_OFF</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_BERLEN</span><span class="p">,</span> <span class="n">DIB3000MB_BERLEN_DEFAULT</span><span class="p">);</span>

	<span class="n">wr_foreach</span><span class="p">(</span><span class="n">dib3000mb_reg_filter_coeffs</span><span class="p">,</span> <span class="n">dib3000mb_filter_coeffs</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_MOBILE_ALGO</span><span class="p">,</span> <span class="n">DIB3000MB_MOBILE_ALGO_ON</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_MULTI_DEMOD_MSB</span><span class="p">,</span> <span class="n">DIB3000MB_MULTI_DEMOD_MSB</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_MULTI_DEMOD_LSB</span><span class="p">,</span> <span class="n">DIB3000MB_MULTI_DEMOD_LSB</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_OUTPUT_MODE</span><span class="p">,</span> <span class="n">DIB3000MB_OUTPUT_MODE_SLAVE</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_FIFO_142</span><span class="p">,</span> <span class="n">DIB3000MB_FIFO_142</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_MPEG2_OUT_MODE</span><span class="p">,</span> <span class="n">DIB3000MB_MPEG2_OUT_MODE_188</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_PID_PARSE</span><span class="p">,</span> <span class="n">DIB3000MB_PID_PARSE_ACTIVATE</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_FIFO</span><span class="p">,</span> <span class="n">DIB3000MB_FIFO_INHIBIT</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_FIFO_146</span><span class="p">,</span> <span class="n">DIB3000MB_FIFO_146</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_FIFO_147</span><span class="p">,</span> <span class="n">DIB3000MB_FIFO_147</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_DATA_IN_DIVERSITY</span><span class="p">,</span> <span class="n">DIB3000MB_DATA_DIVERSITY_IN_OFF</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">fe_code_rate_t</span> <span class="o">*</span><span class="n">cr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tps_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inv_test1</span><span class="p">,</span><span class="n">inv_test2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dds_val</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mh">0x800000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_LOCK</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dds_val</span> <span class="o">=</span> <span class="p">((</span><span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_DDS_VALUE_MSB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_DDS_VALUE_LSB</span><span class="p">);</span>
	<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;DDS_VAL: %x %x %x&quot;</span><span class="p">,</span><span class="n">dds_val</span><span class="p">,</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_DDS_VALUE_MSB</span><span class="p">),</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_DDS_VALUE_LSB</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dds_val</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
		<span class="n">inv_test1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dds_val</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">)</span>
		<span class="n">inv_test1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">inv_test1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">dds_val</span> <span class="o">=</span> <span class="p">((</span><span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_DDS_FREQ_MSB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_DDS_FREQ_LSB</span><span class="p">);</span>
	<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;DDS_FREQ: %x %x %x&quot;</span><span class="p">,</span><span class="n">dds_val</span><span class="p">,</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_DDS_FREQ_MSB</span><span class="p">),</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_DDS_FREQ_LSB</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dds_val</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
		<span class="n">inv_test2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dds_val</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">)</span>
		<span class="n">inv_test2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">inv_test2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">inv_test2</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">inv_test1</span><span class="o">==</span><span class="mi">1</span> <span class="o">||</span> <span class="n">inv_test1</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">inv_test2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">inv_test1</span><span class="o">==</span><span class="mi">1</span> <span class="o">||</span> <span class="n">inv_test1</span><span class="o">==</span><span class="mi">2</span><span class="p">))</span> <span class="o">?</span>
		<span class="n">INVERSION_ON</span> <span class="o">:</span> <span class="n">INVERSION_OFF</span><span class="p">;</span>

	<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;inversion %d %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inv_test2</span><span class="p">,</span> <span class="n">inv_test1</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">tps_val</span> <span class="o">=</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_QAM</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DIB3000_CONSTELLATION_QPSK</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;QPSK &quot;</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QPSK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DIB3000_CONSTELLATION_16QAM</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;QAM16 &quot;</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DIB3000_CONSTELLATION_64QAM</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;QAM64 &quot;</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_64</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;Unexpected constellation returned by TPS (%d)&quot;</span><span class="p">,</span> <span class="n">tps_val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;TPS: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tps_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_HRCH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;HRCH ON</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_NONE</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">tps_val</span> <span class="o">=</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_VIT_ALPHA</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DIB3000_ALPHA_0</span>:
				<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;HIERARCHY_NONE &quot;</span><span class="p">);</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_NONE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DIB3000_ALPHA_1</span>:
				<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;HIERARCHY_1 &quot;</span><span class="p">);</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DIB3000_ALPHA_2</span>:
				<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;HIERARCHY_2 &quot;</span><span class="p">);</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DIB3000_ALPHA_4</span>:
				<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;HIERARCHY_4 &quot;</span><span class="p">);</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">err</span><span class="p">(</span><span class="s">&quot;Unexpected ALPHA value returned by TPS (%d)&quot;</span><span class="p">,</span> <span class="n">tps_val</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;TPS: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tps_val</span><span class="p">);</span>

		<span class="n">tps_val</span> <span class="o">=</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_CODE_RATE_LP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;HRCH OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_NONE</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_NONE</span><span class="p">;</span>

		<span class="n">tps_val</span> <span class="o">=</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_CODE_RATE_HP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tps_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DIB3000_FEC_1_2</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;FEC_1_2 &quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">cr</span> <span class="o">=</span> <span class="n">FEC_1_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DIB3000_FEC_2_3</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;FEC_2_3 &quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">cr</span> <span class="o">=</span> <span class="n">FEC_2_3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DIB3000_FEC_3_4</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;FEC_3_4 &quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">cr</span> <span class="o">=</span> <span class="n">FEC_3_4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DIB3000_FEC_5_6</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;FEC_5_6 &quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">cr</span> <span class="o">=</span> <span class="n">FEC_4_5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DIB3000_FEC_7_8</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;FEC_7_8 &quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">cr</span> <span class="o">=</span> <span class="n">FEC_7_8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;Unexpected FEC returned by TPS (%d)&quot;</span><span class="p">,</span> <span class="n">tps_val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;TPS: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">tps_val</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">tps_val</span> <span class="o">=</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_GUARD_TIME</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DIB3000_GUARD_TIME_1_32</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;GUARD_INTERVAL_1_32 &quot;</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_32</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DIB3000_GUARD_TIME_1_16</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;GUARD_INTERVAL_1_16 &quot;</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DIB3000_GUARD_TIME_1_8</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;GUARD_INTERVAL_1_8 &quot;</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DIB3000_GUARD_TIME_1_4</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;GUARD_INTERVAL_1_4 &quot;</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;Unexpected Guard Time returned by TPS (%d)&quot;</span><span class="p">,</span> <span class="n">tps_val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;TPS: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tps_val</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">tps_val</span> <span class="o">=</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_FFT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DIB3000_TRANSMISSION_MODE_2K</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;TRANSMISSION_MODE_2K &quot;</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_2K</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DIB3000_TRANSMISSION_MODE_8K</span>:
			<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;TRANSMISSION_MODE_8K &quot;</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;unexpected transmission mode return by TPS (%d)&quot;</span><span class="p">,</span> <span class="n">tps_val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;TPS: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tps_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span><span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_AGC_LOCK</span><span class="p">))</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_SIGNAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_CARRIER_LOCK</span><span class="p">))</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_CARRIER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_VIT_LCK</span><span class="p">))</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TS_SYNC_LOCK</span><span class="p">))</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FE_HAS_SYNC</span> <span class="o">|</span> <span class="n">FE_HAS_LOCK</span><span class="p">);</span>

	<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;actual status is %2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">stat</span><span class="p">);</span>

	<span class="n">deb_getf</span><span class="p">(</span><span class="s">&quot;autoval: tps: %d, qam: %d, hrch: %d, alpha: %d, hp: %d, lp: %d, guard: %d, fft: %d cell: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_LOCK</span><span class="p">),</span>
			<span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_QAM</span><span class="p">),</span>
			<span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_HRCH</span><span class="p">),</span>
			<span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_VIT_ALPHA</span><span class="p">),</span>
			<span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_CODE_RATE_HP</span><span class="p">),</span>
			<span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_CODE_RATE_LP</span><span class="p">),</span>
			<span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_GUARD_TIME</span><span class="p">),</span>
			<span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_FFT</span><span class="p">),</span>
			<span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_TPS_CELL_ID</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>*stat = FE<em>HAS</em>SIGNAL | FE<em>HAS</em>CARRIER | FE<em>HAS</em>VITERBI | FE<em>HAS</em>SYNC | FE<em>HAS</em>LOCK;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="p">((</span><span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_BER_MSB</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_BER_LSB</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* see dib3000-watch dvb-apps for exact calcuations of signal_strength and snr */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_SIGNAL_POWER</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0xffff</span> <span class="o">/</span> <span class="mh">0x170</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">sigpow</span> <span class="o">=</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_SIGNAL_POWER</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">icipow</span> <span class="o">=</span> <span class="p">((</span><span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_NOISE_POWER_MSB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_NOISE_POWER_LSB</span><span class="p">);</span>
	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigpow</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">icipow</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">icipow</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_read_unc_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">unc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">unc</span> <span class="o">=</span> <span class="n">rd</span><span class="p">(</span><span class="n">DIB3000MB_REG_PACKET_ERROR_RATE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;dib3000mb is going to bed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_POWER_CONTROL</span><span class="p">,</span> <span class="n">DIB3000MB_POWER_DOWN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_fe_get_tune_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span> <span class="o">*</span><span class="n">tune</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tune</span><span class="o">-&gt;</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_fe_init_nonmobile</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dib3000mb_fe_init</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_set_frontend_and_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dib3000mb_set_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib3000mb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* pid filter and transfer stuff */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_pid_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pid</span><span class="p">,</span><span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="p">(</span><span class="n">onoff</span> <span class="o">?</span> <span class="n">pid</span> <span class="o">|</span> <span class="n">DIB3000_ACTIVATE_PID_FILTERING</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="n">DIB3000MB_REG_FIRST_PID</span><span class="p">,</span><span class="n">pid</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_fifo_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">deb_xfer</span><span class="p">(</span><span class="s">&quot;%s fifo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">onoff</span> <span class="o">?</span> <span class="s">&quot;enabling&quot;</span> <span class="o">:</span> <span class="s">&quot;disabling&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_FIFO</span><span class="p">,</span> <span class="n">DIB3000MB_FIFO_ACTIVATE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_FIFO</span><span class="p">,</span> <span class="n">DIB3000MB_FIFO_INHIBIT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_pid_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">deb_xfer</span><span class="p">(</span><span class="s">&quot;%s pid parsing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">onoff</span> <span class="o">?</span> <span class="s">&quot;enabling&quot;</span> <span class="o">:</span> <span class="s">&quot;disabling&quot;</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_PID_PARSE</span><span class="p">,</span><span class="n">onoff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib3000mb_tuner_pass_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pll_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_TUNER</span><span class="p">,</span> <span class="n">DIB3000_TUNER_WRITE_ENABLE</span><span class="p">(</span><span class="n">pll_addr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">DIB3000MB_REG_TUNER</span><span class="p">,</span> <span class="n">DIB3000_TUNER_WRITE_DISABLE</span><span class="p">(</span><span class="n">pll_addr</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">dib3000mb_ops</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="nf">dib3000mb_attach</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dib3000_config</span><span class="o">*</span> <span class="n">config</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">i2c_adapter</span><span class="o">*</span> <span class="n">i2c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dib_fe_xfer_ops</span> <span class="o">*</span><span class="n">xfer_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib3000_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* allocate memory for the internal state */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib3000_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* setup the state */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib3000_config</span><span class="p">));</span>

	<span class="cm">/* check for the correct demod */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="p">(</span><span class="n">DIB3000_REG_MANUFACTOR_ID</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DIB3000_I2C_ID_DIBCOM</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="p">(</span><span class="n">DIB3000_REG_DEVICE_ID</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DIB3000MB_DEVICE_ID</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* create dvb_frontend */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dib3000mb_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="cm">/* set the xfer operations */</span>
	<span class="n">xfer_ops</span><span class="o">-&gt;</span><span class="n">pid_parse</span> <span class="o">=</span> <span class="n">dib3000mb_pid_parse</span><span class="p">;</span>
	<span class="n">xfer_ops</span><span class="o">-&gt;</span><span class="n">fifo_ctrl</span> <span class="o">=</span> <span class="n">dib3000mb_fifo_control</span><span class="p">;</span>
	<span class="n">xfer_ops</span><span class="o">-&gt;</span><span class="n">pid_ctrl</span> <span class="o">=</span> <span class="n">dib3000mb_pid_control</span><span class="p">;</span>
	<span class="n">xfer_ops</span><span class="o">-&gt;</span><span class="n">tuner_pass_ctrl</span> <span class="o">=</span> <span class="n">dib3000mb_tuner_pass_ctrl</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">dib3000mb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBT</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;DiBcom 3000M-B DVB-T&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span>		<span class="o">=</span> <span class="mi">44250000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span>		<span class="o">=</span> <span class="mi">867250000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span>	<span class="o">=</span> <span class="mi">62500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">FE_CAN_INVERSION_AUTO</span> <span class="o">|</span>
				<span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span>
				<span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
				<span class="n">FE_CAN_QPSK</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_AUTO</span> <span class="o">|</span>
				<span class="n">FE_CAN_TRANSMISSION_MODE_AUTO</span> <span class="o">|</span>
				<span class="n">FE_CAN_GUARD_INTERVAL_AUTO</span> <span class="o">|</span>
				<span class="n">FE_CAN_RECOVER</span> <span class="o">|</span>
				<span class="n">FE_CAN_HIERARCHY_AUTO</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">dib3000mb_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">dib3000mb_fe_init_nonmobile</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">dib3000mb_sleep</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">dib3000mb_set_frontend_and_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend</span> <span class="o">=</span> <span class="n">dib3000mb_get_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">=</span> <span class="n">dib3000mb_fe_get_tune_settings</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">dib3000mb_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">dib3000mb_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">dib3000mb_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">dib3000mb_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">dib3000mb_read_unc_blocks</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib3000mb_attach</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
