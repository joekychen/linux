<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › stb0899_algo.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>stb0899_algo.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	STB0899 Multistandard Frontend driver</span>
<span class="cm">	Copyright (C) Manu Abraham (abraham.manu@gmail.com)</span>

<span class="cm">	Copyright (C) ST Microelectronics</span>

<span class="cm">	This program is free software; you can redistribute it and/or modify</span>
<span class="cm">	it under the terms of the GNU General Public License as published by</span>
<span class="cm">	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">	(at your option) any later version.</span>

<span class="cm">	This program is distributed in the hope that it will be useful,</span>
<span class="cm">	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">	GNU General Public License for more details.</span>

<span class="cm">	You should have received a copy of the GNU General Public License</span>
<span class="cm">	along with this program; if not, write to the Free Software</span>
<span class="cm">	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm">*/</span>

<span class="cp">#include &quot;stb0899_drv.h&quot;</span>
<span class="cp">#include &quot;stb0899_priv.h&quot;</span>
<span class="cp">#include &quot;stb0899_reg.h&quot;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">stb0899_do_div</span><span class="p">(</span><span class="n">u64</span> <span class="n">n</span><span class="p">,</span> <span class="n">u32</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* wrap do_div() for ease of use */</span>

	<span class="n">do_div</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* These functions are currently unused */</span>
<span class="c">/*</span>
<span class="c"> * stb0899_calc_srate</span>
<span class="c"> * Compute symbol rate</span>
<span class="c"> */</span>
<span class="c">static u32 stb0899_calc_srate(u32 master_clk, u8 *sfr)</span>
<span class="c">{</span>
<span class="c">	u64 tmp;</span>

<span class="c">	/* srate = (SFR * master_clk) &gt;&gt; 20 */</span>

<span class="c">	/* sfr is of size 20 bit, stored with an offset of 4 bit */</span>
<span class="c">	tmp = (((u32)sfr[0]) &lt;&lt; 16) | (((u32)sfr[1]) &lt;&lt; 8) | sfr[2];</span>
<span class="c">	tmp &amp;= ~0xf;</span>
<span class="c">	tmp *= master_clk;</span>
<span class="c">	tmp &gt;&gt;= 24;</span>

<span class="c">	return tmp;</span>
<span class="c">}</span>

<span class="c">/*</span>
<span class="c"> * stb0899_get_srate</span>
<span class="c"> * Get the current symbol rate</span>
<span class="c"> */</span>
<span class="c">static u32 stb0899_get_srate(struct stb0899_state *state)</span>
<span class="c">{</span>
<span class="c">	struct stb0899_internal *internal = &amp;state-&gt;internal;</span>
<span class="c">	u8 sfr[3];</span>

<span class="c">	stb0899_read_regs(state, STB0899_SFRH, sfr, 3);</span>

<span class="c">	return stb0899_calc_srate(internal-&gt;master_clk, sfr);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_set_srate</span>
<span class="cm"> * Set symbol frequency</span>
<span class="cm"> * MasterClock: master clock frequency (hz)</span>
<span class="cm"> * SymbolRate: symbol rate (bauds)</span>
<span class="cm"> * return symbol frequency</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">stb0899_set_srate</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">master_clk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">srate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sfr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;--&gt;&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * in order to have the maximum precision, the symbol rate entered into</span>
<span class="cm">	 * the chip is computed as the closest value of the &quot;true value&quot;.</span>
<span class="cm">	 * In this purpose, the symbol rate value is rounded (1 is added on the bit</span>
<span class="cm">	 * below the LSB )</span>
<span class="cm">	 *</span>
<span class="cm">	 * srate = (SFR * master_clk) &gt;&gt; 20</span>
<span class="cm">	 *      &lt;=&gt;</span>
<span class="cm">	 *   SFR = srate &lt;&lt; 20 / master_clk</span>
<span class="cm">	 *</span>
<span class="cm">	 * rounded:</span>
<span class="cm">	 *   SFR = (srate &lt;&lt; 21 + master_clk) / (2 * master_clk)</span>
<span class="cm">	 *</span>
<span class="cm">	 * stored as 20 bit number with an offset of 4 bit:</span>
<span class="cm">	 *   sfr = SFR &lt;&lt; 4;</span>
<span class="cm">	 */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">stb0899_do_div</span><span class="p">((((</span><span class="n">u64</span><span class="p">)</span><span class="n">srate</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">+</span> <span class="n">master_clk</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">master_clk</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&lt;&lt;=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">sfr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">sfr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">;</span>
	<span class="n">sfr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">stb0899_write_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_SFRH</span><span class="p">,</span> <span class="n">sfr</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">srate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_calc_derot_time</span>
<span class="cm"> * Compute the amount of time needed by the derotator to lock</span>
<span class="cm"> * SymbolRate: Symbol rate</span>
<span class="cm"> * return: derotator time constant (ms)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">stb0899_calc_derot_time</span><span class="p">(</span><span class="kt">long</span> <span class="n">srate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">100000</span> <span class="o">/</span> <span class="p">(</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_carr_width</span>
<span class="cm"> * Compute the width of the carrier</span>
<span class="cm"> * return: width of carrier (kHz or Mhz)</span>
<span class="cm"> */</span>
<span class="kt">long</span> <span class="nf">stb0899_carr_width</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">+</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_first_subrange</span>
<span class="cm"> * Compute the first subrange of the search</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_first_subrange</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_params</span> <span class="o">*</span><span class="n">params</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_config</span> <span class="o">*</span><span class="n">config</span>		<span class="o">=</span>  <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">range</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bandwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_bandwidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stb0899_i2c_gate_ctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_bandwidth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bandwidth</span><span class="p">);</span>
		<span class="n">stb0899_i2c_gate_ctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">bandwidth</span> <span class="o">-</span> <span class="n">stb0899_carr_width</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">range</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_range</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srch_range</span><span class="p">,</span> <span class="n">range</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_range</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">;</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">tuner_offst</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_check_tmg</span>
<span class="cm"> * check for timing lock</span>
<span class="cm"> * internal.Ttiming: time to wait for loop lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">stb0899_status</span> <span class="nf">stb0899_check_tmg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lock</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">timing</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">t_derot</span><span class="p">);</span>

	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_RTF</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TLIR</span><span class="p">);</span>
	<span class="n">lock</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">TLIR_TMG_LOCK_IND</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">timing</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_RTF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&gt;=</span> <span class="mi">42</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lock</span> <span class="o">&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">timing</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">110</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ANALOGCARRIER</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;--&gt;ANALOG Carrier !&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">TIMINGOK</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;-------&gt;TIMING OK !&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">NOTIMING</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;--&gt;NO TIMING !&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_search_tmg</span>
<span class="cm"> * perform a fs/2 zig-zag to find timing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">stb0899_status</span> <span class="nf">stb0899_search_tmg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_params</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">;</span>

	<span class="kt">short</span> <span class="kt">int</span> <span class="n">derot_step</span><span class="p">,</span> <span class="n">derot_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">derot_limit</span><span class="p">,</span> <span class="n">next_loop</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">NOTIMING</span><span class="p">;</span>

	<span class="cm">/* timing loop computation &amp; symbol rate optimisation	*/</span>
	<span class="n">derot_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_range</span> <span class="o">/</span> <span class="mi">2L</span><span class="p">)</span> <span class="o">/</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">;</span>
	<span class="n">derot_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">2L</span><span class="p">)</span> <span class="o">/</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">stb0899_check_tmg</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TIMINGOK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">next_loop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="n">derot_freq</span> <span class="o">+=</span> <span class="n">index</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">*</span> <span class="n">derot_step</span><span class="p">;</span>	<span class="cm">/* next derot zig zag position	*/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">derot_freq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">derot_limit</span><span class="p">)</span>
			<span class="n">next_loop</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">next_loop</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CFRM</span><span class="p">,</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MSB</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">*</span> <span class="n">derot_freq</span><span class="p">));</span>
			<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CFRL</span><span class="p">,</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">LSB</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">*</span> <span class="n">derot_freq</span><span class="p">));</span>
			<span class="n">stb0899_write_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFRM</span><span class="p">,</span> <span class="n">cfr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* derotator frequency		*/</span>
		<span class="p">}</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">;</span>	<span class="cm">/* Change zigzag direction		*/</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">TIMINGOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stb0899_read_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFRM</span><span class="p">,</span> <span class="n">cfr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* get derotator frequency		*/</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">*</span> <span class="n">MAKEWORD16</span><span class="p">(</span><span class="n">cfr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;-------&gt;TIMING OK ! Derot Freq = %d&quot;</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_check_carrier</span>
<span class="cm"> * Check for carrier found</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">stb0899_status</span> <span class="nf">stb0899_check_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">t_derot</span><span class="p">);</span> <span class="cm">/* wait for derotator ok	*/</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CFD_ON</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DSTATUS</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;--------------------&gt; STB0899_DSTATUS=[0x%02x]&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">CARRIER_FOUND</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">CARRIEROK</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;-------------&gt; CARRIEROK !&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">NOCARRIER</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;-------------&gt; NOCARRIER !&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_search_carrier</span>
<span class="cm"> * Search for a QPSK carrier with the derotator</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">stb0899_status</span> <span class="nf">stb0899_search_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>

	<span class="kt">short</span> <span class="kt">int</span> <span class="n">derot_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">last_derot_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">derot_limit</span><span class="p">,</span> <span class="n">next_loop</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">NOCARRIER</span><span class="p">;</span>
	<span class="n">derot_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_range</span> <span class="o">/</span> <span class="mi">2L</span><span class="p">)</span> <span class="o">/</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">;</span>
	<span class="n">derot_freq</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CFD_ON</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Derot Freq=%d, mclk=%d&quot;</span><span class="p">,</span> <span class="n">derot_freq</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_check_carrier</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOCARRIER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="n">last_derot_freq</span> <span class="o">=</span> <span class="n">derot_freq</span><span class="p">;</span>
			<span class="n">derot_freq</span> <span class="o">+=</span> <span class="n">index</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_step</span><span class="p">;</span> <span class="cm">/* next zig zag derotator position */</span>

			<span class="k">if</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">derot_freq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">derot_limit</span><span class="p">)</span>
				<span class="n">next_loop</span><span class="o">--</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">next_loop</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">);</span>
				<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CFD_ON</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

				<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CFRM</span><span class="p">,</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MSB</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">*</span> <span class="n">derot_freq</span><span class="p">));</span>
				<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CFRL</span><span class="p">,</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">LSB</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">*</span> <span class="n">derot_freq</span><span class="p">));</span>
				<span class="n">stb0899_write_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFRM</span><span class="p">,</span> <span class="n">cfr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* derotator frequency	*/</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">;</span> <span class="cm">/* Change zigzag direction */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CARRIEROK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">next_loop</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">CARRIEROK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stb0899_read_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFRM</span><span class="p">,</span> <span class="n">cfr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* get derotator frequency */</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">*</span> <span class="n">MAKEWORD16</span><span class="p">(</span><span class="n">cfr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;----&gt; CARRIER OK !, Derot Freq=%d&quot;</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span> <span class="o">=</span> <span class="n">last_derot_freq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_check_data</span>
<span class="cm"> * Check for data found</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">stb0899_status</span> <span class="nf">stb0899_check_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_params</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dataTime</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">loop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">NODATA</span><span class="p">;</span>

	<span class="cm">/* RESET FEC	*/</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FRESACS</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FRESACS</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">2000000</span><span class="p">)</span>
		<span class="n">dataTime</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">5000000</span><span class="p">)</span>
		<span class="n">dataTime</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span>
		<span class="n">dataTime</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dataTime</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>

	<span class="cm">/* clear previous failed END_LOOPVIT */</span>
	<span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_VSTATUS</span><span class="p">);</span>

	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DSTATUS2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* force search loop	*/</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* WARNING! VIT LOCKED has to be tested before VIT_END_LOOOP	*/</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_VSTATUS</span><span class="p">);</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">VSTATUS_LOCKEDVIT</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">loop</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">VSTATUS_END_LOOPVIT</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">||</span> <span class="n">loop</span> <span class="o">||</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">dataTime</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* DATA LOCK indicator	*/</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DATAOK</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;-----------------&gt; DATA OK !&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_search_data</span>
<span class="cm"> * Search for a QPSK carrier with the derotator</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">stb0899_status</span> <span class="nf">stb0899_search_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="kt">int</span> <span class="n">derot_freq</span><span class="p">,</span> <span class="n">derot_step</span><span class="p">,</span> <span class="n">derot_limit</span><span class="p">,</span> <span class="n">next_loop</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_params</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">;</span>

	<span class="n">derot_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">4L</span><span class="p">)</span> <span class="o">/</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">;</span>
	<span class="n">derot_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_range</span> <span class="o">/</span> <span class="mi">2L</span><span class="p">)</span> <span class="o">/</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">;</span>
	<span class="n">derot_freq</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CARRIEROK</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">stb0899_check_data</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DATAOK</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">derot_freq</span> <span class="o">+=</span> <span class="n">index</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">*</span> <span class="n">derot_step</span><span class="p">;</span>	<span class="cm">/* next zig zag derotator position */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">derot_freq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">derot_limit</span><span class="p">)</span>
				<span class="n">next_loop</span><span class="o">--</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">next_loop</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Derot freq=%d, mclk=%d&quot;</span><span class="p">,</span> <span class="n">derot_freq</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">);</span>
				<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CFD_ON</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

				<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CFRM</span><span class="p">,</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MSB</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">*</span> <span class="n">derot_freq</span><span class="p">));</span>
				<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CFRL</span><span class="p">,</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">LSB</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">*</span> <span class="n">derot_freq</span><span class="p">));</span>
				<span class="n">stb0899_write_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFRM</span><span class="p">,</span> <span class="n">cfr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* derotator frequency	*/</span>

				<span class="n">stb0899_check_carrier</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
				<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">;</span> <span class="cm">/* change zig zag direction */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DATAOK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">next_loop</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DATAOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stb0899_read_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFRM</span><span class="p">,</span> <span class="n">cfr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* get derotator frequency */</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">*</span> <span class="n">MAKEWORD16</span><span class="p">(</span><span class="n">cfr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;------&gt; DATAOK ! Derot Freq=%d&quot;</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_check_range</span>
<span class="cm"> * check if the found frequency is in the correct range</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">stb0899_status</span> <span class="nf">stb0899_check_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_params</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">range_offst</span><span class="p">,</span> <span class="n">tp_freq</span><span class="p">;</span>

	<span class="n">range_offst</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">srch_range</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">;</span>
	<span class="n">tp_freq</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">+</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp_freq</span> <span class="o">&gt;=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">-</span> <span class="n">range_offst</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tp_freq</span> <span class="o">&lt;=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">+</span> <span class="n">range_offst</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">RANGEOK</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;----&gt; RANGEOK !&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">OUTOFRANGE</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;----&gt; OUT OF RANGE !&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NextSubRange</span>
<span class="cm"> * Compute the next subrange of the search</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">next_sub_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_params</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">;</span>

	<span class="kt">long</span> <span class="n">old_sub_range</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_dir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_sub_range</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_range</span><span class="p">;</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_range</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srch_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span>
					  <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">tuner_offst</span> <span class="o">+</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
					   <span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_range</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_range</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_range</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">tuner_offst</span> <span class="o">+=</span> <span class="p">(</span><span class="n">old_sub_range</span> <span class="o">+</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_range</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">+</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_dir</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">tuner_offst</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_dir</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs_algo</span>
<span class="cm"> * Search for a signal, timing, carrier and data for a</span>
<span class="cm"> * given frequency in a given range</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">stb0899_status</span> <span class="nf">stb0899_dvbs_algo</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_params</span> <span class="o">*</span><span class="n">params</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_config</span> <span class="o">*</span><span class="n">config</span>		<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">bclc</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">eq_const</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">s32</span> <span class="n">clnI</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bandwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* BETA values rated @ 99MHz	*/</span>
	<span class="n">s32</span> <span class="n">betaTab</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	       <span class="cm">/*  5   10   20   30MBps */</span>
		<span class="p">{</span> <span class="mi">37</span><span class="p">,</span>  <span class="mi">34</span><span class="p">,</span>  <span class="mi">32</span><span class="p">,</span>  <span class="mi">31</span> <span class="p">},</span> <span class="cm">/* QPSK 1/2	*/</span>
		<span class="p">{</span> <span class="mi">37</span><span class="p">,</span>  <span class="mi">35</span><span class="p">,</span>  <span class="mi">33</span><span class="p">,</span>  <span class="mi">31</span> <span class="p">},</span> <span class="cm">/* QPSK 2/3	*/</span>
		<span class="p">{</span> <span class="mi">37</span><span class="p">,</span>  <span class="mi">35</span><span class="p">,</span>  <span class="mi">33</span><span class="p">,</span>  <span class="mi">31</span> <span class="p">},</span> <span class="cm">/* QPSK 3/4	*/</span>
		<span class="p">{</span> <span class="mi">37</span><span class="p">,</span>  <span class="mi">36</span><span class="p">,</span>  <span class="mi">33</span><span class="p">,</span>	 <span class="mi">32</span> <span class="p">},</span> <span class="cm">/* QPSK 5/6	*/</span>
		<span class="p">{</span> <span class="mi">37</span><span class="p">,</span>  <span class="mi">36</span><span class="p">,</span>  <span class="mi">33</span><span class="p">,</span>	 <span class="mi">32</span> <span class="p">}</span>  <span class="cm">/* QPSK 7/8	*/</span>
	<span class="p">};</span>

	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">stb0899_set_srate</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">);</span>
	<span class="cm">/* Carrier loop optimization versus symbol rate for acquisition*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">5000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_ACLC</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">);</span>
		<span class="n">bclc</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">BETA</span><span class="p">,</span> <span class="n">bclc</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">,</span> <span class="n">bclc</span><span class="p">);</span>
		<span class="n">clnI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_ACLC</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">);</span>
		<span class="n">bclc</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">BETA</span><span class="p">,</span> <span class="n">bclc</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">,</span> <span class="n">bclc</span><span class="p">);</span>
		<span class="n">clnI</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_ACLC</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">);</span>
		<span class="n">bclc</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">BETA</span><span class="p">,</span> <span class="n">bclc</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">,</span> <span class="n">bclc</span><span class="p">);</span>
		<span class="n">clnI</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_ACLC</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">);</span>
		<span class="n">bclc</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">BETA</span><span class="p">,</span> <span class="n">bclc</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">,</span> <span class="n">bclc</span><span class="p">);</span>
		<span class="n">clnI</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Set the timing loop to acquisition&quot;</span><span class="p">);</span>
	<span class="cm">/* Set the timing loop to acquisition	*/</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_RTC</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">);</span>

	<span class="cm">/* !! WARNING !!</span>
<span class="cm">	 * Do not read any status variables while acquisition,</span>
<span class="cm">	 * If any needed, read before the acquisition starts</span>
<span class="cm">	 * querying status while acquiring causes the</span>
<span class="cm">	 * acquisition to go bad and hence no locks.</span>
<span class="cm">	 */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Derot Percent=%d Srate=%d mclk=%d&quot;</span><span class="p">,</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_percent</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>

	<span class="cm">/* Initial calculations	*/</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_step</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_percent</span> <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">1000L</span><span class="p">)</span> <span class="o">/</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">;</span> <span class="cm">/* DerotStep/1000 * Fsymbol	*/</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">t_derot</span> <span class="o">=</span> <span class="n">stb0899_calc_derot_time</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">);</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">t_data</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RESET stream merger&quot;</span><span class="p">);</span>
	<span class="cm">/* RESET Stream merger	*/</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FRESRS</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set KDIVIDER to an intermediate value between</span>
<span class="cm">	 * 1/2 and 7/8 for acquisition</span>
<span class="cm">	 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DEMAPVIT</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">DEMAPVIT_KDIVIDER</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DEMAPVIT</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_EQON</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span> <span class="cm">/* Equalizer OFF while acquiring */</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_VITSYNC</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">);</span>

	<span class="n">stb0899_first_subrange</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Initialisations */</span>
		<span class="n">cfr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">stb0899_write_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFRM</span><span class="p">,</span> <span class="n">cfr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* RESET derotator frequency	*/</span>

		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_RTF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CFD_ON</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">NOAGC1</span><span class="p">;</span>

		<span class="cm">/* enable tuner I/O */</span>
		<span class="n">stb0899_i2c_gate_ctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Move tuner to frequency */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Tuner set frequency&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_frequency</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_frequency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_frequency</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_frequency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">);</span>

		<span class="n">msleep</span><span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">t_agc1</span> <span class="o">+</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">t_agc2</span> <span class="o">+</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">t_derot</span><span class="p">);</span> <span class="cm">/* AGC1, AGC2 and timing loop	*/</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;current derot freq=%d&quot;</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span><span class="p">);</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">AGC1OK</span><span class="p">;</span>

		<span class="cm">/* There is signal in the band	*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_bandwidth</span><span class="p">)</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_bandwidth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bandwidth</span><span class="p">);</span>

		<span class="cm">/* disable tuner I/O */</span>
		<span class="n">stb0899_i2c_gate_ctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="n">bandwidth</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">stb0899_search_tmg</span><span class="p">(</span><span class="n">state</span><span class="p">);</span> <span class="cm">/* For low rates (SCPC)	*/</span>
		<span class="k">else</span>
			<span class="n">stb0899_check_tmg</span><span class="p">(</span><span class="n">state</span><span class="p">);</span> <span class="cm">/* For high rates (MCPC)	*/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">TIMINGOK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="s">&quot;TIMING OK ! Derot freq=%d, mclk=%d&quot;</span><span class="p">,</span>
				<span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_search_carrier</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">CARRIEROK</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Search for carrier	*/</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					<span class="s">&quot;CARRIER OK ! Derot freq=%d, mclk=%d&quot;</span><span class="p">,</span>
					<span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_search_data</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">DATAOK</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Check for data	*/</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						<span class="s">&quot;DATA OK ! Derot freq=%d, mclk=%d&quot;</span><span class="p">,</span>
						<span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">stb0899_check_range</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">RANGEOK</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
							<span class="s">&quot;RANGE OK ! derot freq=%d, mclk=%d&quot;</span><span class="p">,</span>
							<span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>

						<span class="n">internal</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">+</span> <span class="p">((</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">derot_freq</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
						<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_PLPARM</span><span class="p">);</span>
						<span class="n">internal</span><span class="o">-&gt;</span><span class="n">fecrate</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">VITCURPUN</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
						<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
							<span class="s">&quot;freq=%d, internal resultant freq=%d&quot;</span><span class="p">,</span>
							<span class="n">params</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">);</span>

						<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
							<span class="s">&quot;internal puncture rate=%d&quot;</span><span class="p">,</span>
							<span class="n">internal</span><span class="o">-&gt;</span><span class="n">fecrate</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">RANGEOK</span><span class="p">)</span>
			<span class="n">next_sub_range</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">sub_range</span> <span class="o">&amp;&amp;</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">RANGEOK</span><span class="p">);</span>

	<span class="cm">/* Set the timing loop to tracking	*/</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_RTC</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">);</span>
	<span class="cm">/* if locked and range ok, set Kdiv	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">RANGEOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Locked &amp; Range OK !&quot;</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_EQON</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>		<span class="cm">/* Equalizer OFF while acquiring	*/</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_VITSYNC</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>	<span class="cm">/* SN to b&#39;11 for acquisition		*/</span>

		<span class="cm">/*</span>
<span class="cm">		 * Carrier loop optimization versus</span>
<span class="cm">		 * symbol Rate/Puncture Rate for Tracking</span>
<span class="cm">		 */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">fecrate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STB0899_FEC_1_2</span>:		<span class="cm">/* 13	*/</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DEMAPVIT</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">);</span>
			<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">BETA</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">betaTab</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">clnI</span><span class="p">]);</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STB0899_FEC_2_3</span>:		<span class="cm">/* 18	*/</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DEMAPVIT</span><span class="p">,</span> <span class="mi">44</span><span class="p">);</span>
			<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">BETA</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">betaTab</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">clnI</span><span class="p">]);</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STB0899_FEC_3_4</span>:		<span class="cm">/* 21	*/</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DEMAPVIT</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
			<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">BETA</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">betaTab</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">clnI</span><span class="p">]);</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STB0899_FEC_5_6</span>:		<span class="cm">/* 24	*/</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DEMAPVIT</span><span class="p">,</span> <span class="mi">75</span><span class="p">);</span>
			<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">BETA</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">betaTab</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">clnI</span><span class="p">]);</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STB0899_FEC_6_7</span>:		<span class="cm">/* 25	*/</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DEMAPVIT</span><span class="p">,</span> <span class="mi">88</span><span class="p">);</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_ACLC</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STB0899_FEC_7_8</span>:		<span class="cm">/* 26	*/</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_DEMAPVIT</span><span class="p">,</span> <span class="mi">94</span><span class="p">);</span>
			<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">BETA</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">betaTab</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">clnI</span><span class="p">]);</span>
			<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_BCLC</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unsupported Puncture Rate&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* release stream merger RESET	*/</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FRESRS</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* disable carrier detector	*/</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CFD_ON</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFD</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">stb0899_read_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_EQUAI1</span><span class="p">,</span> <span class="n">eq_const</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_config_uwp</span>
<span class="cm"> * Configure UWP state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_dvbs2_config_uwp</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">uwp1</span><span class="p">,</span> <span class="n">uwp2</span><span class="p">,</span> <span class="n">uwp3</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">uwp1</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">UWP_CNTRL1</span><span class="p">);</span>
	<span class="n">uwp2</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">UWP_CNTRL2</span><span class="p">);</span>
	<span class="n">uwp3</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">UWP_CNTRL3</span><span class="p">);</span>

	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">UWP_ESN0_AVE</span><span class="p">,</span> <span class="n">uwp1</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">esno_ave</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">UWP_ESN0_QUANT</span><span class="p">,</span> <span class="n">uwp1</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">esno_quant</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">UWP_TH_SOF</span><span class="p">,</span> <span class="n">uwp1</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">uwp_threshold_sof</span><span class="p">);</span>

	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FE_COARSE_TRK</span><span class="p">,</span> <span class="n">uwp2</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">av_frame_coarse</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FE_FINE_TRK</span><span class="p">,</span> <span class="n">uwp2</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">av_frame_fine</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">UWP_MISS_TH</span><span class="p">,</span> <span class="n">uwp2</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">miss_threshold</span><span class="p">);</span>

	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">UWP_TH_ACQ</span><span class="p">,</span> <span class="n">uwp3</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">uwp_threshold_acq</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">UWP_TH_TRACK</span><span class="p">,</span> <span class="n">uwp3</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">uwp_threshold_track</span><span class="p">);</span>

	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_UWP_CNTRL1</span><span class="p">,</span> <span class="n">STB0899_OFF0_UWP_CNTRL1</span><span class="p">,</span> <span class="n">uwp1</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_UWP_CNTRL2</span><span class="p">,</span> <span class="n">STB0899_OFF0_UWP_CNTRL2</span><span class="p">,</span> <span class="n">uwp2</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_UWP_CNTRL3</span><span class="p">,</span> <span class="n">STB0899_OFF0_UWP_CNTRL3</span><span class="p">,</span> <span class="n">uwp3</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">SOF_SRCH_TO</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">SOF_SEARCH_TIMEOUT</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">sof_search_timeout</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_SOF_SRCH_TO</span><span class="p">,</span> <span class="n">STB0899_OFF0_SOF_SRCH_TO</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_config_csm_auto</span>
<span class="cm"> * Set CSM to AUTO mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_dvbs2_config_csm_auto</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CSM_CNTRL1</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_AUTO_PARAM</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CSM_CNTRL1</span><span class="p">,</span> <span class="n">STB0899_OFF0_CSM_CNTRL1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">Log2Int</span><span class="p">(</span><span class="kt">int</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">abs</span><span class="p">(</span><span class="n">number</span><span class="p">))</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_calc_srate</span>
<span class="cm"> * compute BTR_NOM_FREQ for the symbol rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">stb0899_dvbs2_calc_srate</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_config</span> <span class="o">*</span><span class="n">config</span>		<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">dec_ratio</span><span class="p">,</span> <span class="n">dec_rate</span><span class="p">,</span> <span class="n">decim</span><span class="p">,</span> <span class="n">remain</span><span class="p">,</span> <span class="n">intval</span><span class="p">,</span> <span class="n">btr_nom_freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">master_clk</span><span class="p">,</span> <span class="n">srate</span><span class="p">;</span>

	<span class="n">dec_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">);</span>
	<span class="n">dec_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">dec_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">dec_ratio</span><span class="p">;</span>
	<span class="n">dec_rate</span> <span class="o">=</span> <span class="n">Log2Int</span><span class="p">(</span><span class="n">dec_ratio</span><span class="p">);</span>
	<span class="n">decim</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dec_rate</span><span class="p">;</span>
	<span class="n">master_clk</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">srate</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">decim</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intval</span> <span class="o">=</span> <span class="p">(</span><span class="n">decim</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">btr_nco_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">/</span> <span class="n">master_clk</span><span class="p">;</span>
		<span class="n">remain</span> <span class="o">=</span> <span class="p">(</span><span class="n">decim</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">btr_nco_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">%</span> <span class="n">master_clk</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">intval</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">btr_nco_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">master_clk</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">decim</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">remain</span> <span class="o">=</span> <span class="p">(</span><span class="n">decim</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">btr_nco_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">%</span> <span class="n">master_clk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">btr_nom_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">intval</span> <span class="o">*</span> <span class="n">srate</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">remain</span> <span class="o">*</span> <span class="n">srate</span><span class="p">)</span> <span class="o">/</span> <span class="n">master_clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">btr_nom_freq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_calc_dev</span>
<span class="cm"> * compute the correction to be applied to symbol rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">stb0899_dvbs2_calc_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dec_ratio</span><span class="p">,</span> <span class="n">correction</span><span class="p">,</span> <span class="n">master_clk</span><span class="p">,</span> <span class="n">srate</span><span class="p">;</span>

	<span class="n">dec_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">);</span>
	<span class="n">dec_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">dec_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">dec_ratio</span><span class="p">;</span>

	<span class="n">master_clk</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* for integer Caculation*/</span>
	<span class="n">srate</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* for integer Caculation*/</span>
	<span class="n">correction</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="n">master_clk</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dec_ratio</span> <span class="o">*</span> <span class="n">srate</span><span class="p">);</span>

	<span class="k">return</span>	<span class="n">correction</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_set_srate</span>
<span class="cm"> * Set DVBS2 symbol rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_dvbs2_set_srate</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">dec_ratio</span><span class="p">,</span> <span class="n">dec_rate</span><span class="p">,</span> <span class="n">win_sel</span><span class="p">,</span> <span class="n">decim</span><span class="p">,</span> <span class="n">f_sym</span><span class="p">,</span> <span class="n">btr_nom_freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">correction</span><span class="p">,</span> <span class="n">freq_adj</span><span class="p">,</span> <span class="n">band_lim</span><span class="p">,</span> <span class="n">decim_cntrl</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">anti_alias</span><span class="p">;</span>

	<span class="cm">/*set decimation to 1*/</span>
	<span class="n">dec_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">);</span>
	<span class="n">dec_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">dec_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">dec_ratio</span><span class="p">;</span>
	<span class="n">dec_rate</span> <span class="o">=</span> <span class="n">Log2Int</span><span class="p">(</span><span class="n">dec_ratio</span><span class="p">);</span>

	<span class="n">win_sel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dec_rate</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">win_sel</span> <span class="o">=</span> <span class="n">dec_rate</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">decim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dec_rate</span><span class="p">);</span>
	<span class="cm">/* (FSamp/Fsymbol *100) for integer Caculation */</span>
	<span class="n">f_sym</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">/</span> <span class="p">((</span><span class="n">decim</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f_sym</span> <span class="o">&lt;=</span> <span class="mi">2250</span><span class="p">)</span>	<span class="cm">/* don&#39;t band limit signal going into btr block*/</span>
		<span class="n">band_lim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">band_lim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* band limit signal going into btr block*/</span>

	<span class="n">decim_cntrl</span> <span class="o">=</span> <span class="p">((</span><span class="n">win_sel</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">band_lim</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dec_rate</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_DECIM_CNTRL</span><span class="p">,</span> <span class="n">STB0899_OFF0_DECIM_CNTRL</span><span class="p">,</span> <span class="n">decim_cntrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f_sym</span> <span class="o">&lt;=</span> <span class="mi">3450</span><span class="p">)</span>
		<span class="n">anti_alias</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f_sym</span> <span class="o">&lt;=</span> <span class="mi">4250</span><span class="p">)</span>
		<span class="n">anti_alias</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">anti_alias</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_ANTI_ALIAS_SEL</span><span class="p">,</span> <span class="n">STB0899_OFF0_ANTI_ALIAS_SEL</span><span class="p">,</span> <span class="n">anti_alias</span><span class="p">);</span>
	<span class="n">btr_nom_freq</span> <span class="o">=</span> <span class="n">stb0899_dvbs2_calc_srate</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_BTR_NOM_FREQ</span><span class="p">,</span> <span class="n">STB0899_OFF0_BTR_NOM_FREQ</span><span class="p">,</span> <span class="n">btr_nom_freq</span><span class="p">);</span>

	<span class="n">correction</span> <span class="o">=</span> <span class="n">stb0899_dvbs2_calc_dev</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">BTR_CNTRL</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">BTR_FREQ_CORR</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">correction</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_BTR_CNTRL</span><span class="p">,</span> <span class="n">STB0899_OFF0_BTR_CNTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* scale UWP+CSM frequency to sample rate*/</span>
	<span class="n">freq_adj</span> <span class="o">=</span>  <span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">/</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_FREQ_ADJ_SCALE</span><span class="p">,</span> <span class="n">STB0899_OFF0_FREQ_ADJ_SCALE</span><span class="p">,</span> <span class="n">freq_adj</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_set_btr_loopbw</span>
<span class="cm"> * set bit timing loop bandwidth as a percentage of the symbol rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_dvbs2_set_btr_loopbw</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_config</span> <span class="o">*</span><span class="n">config</span>		<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">sym_peak</span> <span class="o">=</span> <span class="mi">23</span><span class="p">,</span> <span class="n">zeta</span> <span class="o">=</span> <span class="mi">707</span><span class="p">,</span> <span class="n">loopbw_percent</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">dec_ratio</span><span class="p">,</span> <span class="n">dec_rate</span><span class="p">,</span> <span class="n">k_btr1_rshft</span><span class="p">,</span> <span class="n">k_btr1</span><span class="p">,</span> <span class="n">k_btr0_rshft</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">k_btr0</span><span class="p">,</span> <span class="n">k_btr2_rshft</span><span class="p">,</span> <span class="n">k_direct_shift</span><span class="p">,</span> <span class="n">k_indirect_shift</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">decim</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">wn</span><span class="p">,</span> <span class="n">k_direct</span><span class="p">,</span> <span class="n">k_indirect</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">dec_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">);</span>
	<span class="n">dec_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">dec_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">dec_ratio</span><span class="p">;</span>
	<span class="n">dec_rate</span> <span class="o">=</span> <span class="n">Log2Int</span><span class="p">(</span><span class="n">dec_ratio</span><span class="p">);</span>
	<span class="n">decim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dec_rate</span><span class="p">);</span>

	<span class="n">sym_peak</span> <span class="o">*=</span> <span class="mi">576000</span><span class="p">;</span>
	<span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">btr_nco_bits</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">K</span> <span class="o">*=</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">*</span> <span class="n">decim</span><span class="p">;</span> <span class="cm">/*k=k 10^-8*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">K</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">K</span> <span class="o">=</span> <span class="n">sym_peak</span> <span class="o">/</span> <span class="n">K</span><span class="p">;</span>
		<span class="n">wn</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">zeta</span> <span class="o">*</span> <span class="n">zeta</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="n">wn</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">loopbw_percent</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">*</span> <span class="n">zeta</span><span class="p">)</span> <span class="o">/</span><span class="n">wn</span><span class="p">;</span>  <span class="cm">/*wn =wn 10^-8*/</span>

		<span class="n">k_indirect</span> <span class="o">=</span> <span class="p">(</span><span class="n">wn</span> <span class="o">*</span> <span class="n">wn</span><span class="p">)</span> <span class="o">/</span> <span class="n">K</span><span class="p">;</span>
		<span class="n">k_indirect</span> <span class="o">=</span> <span class="n">k_indirect</span><span class="p">;</span>	  <span class="cm">/*kindirect = kindirect 10^-6*/</span>
		<span class="n">k_direct</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">wn</span> <span class="o">*</span> <span class="n">zeta</span><span class="p">)</span> <span class="o">/</span> <span class="n">K</span><span class="p">;</span>	<span class="cm">/*kDirect = kDirect 10^-2*/</span>
		<span class="n">k_direct</span>  <span class="o">*=</span> <span class="mi">100</span><span class="p">;</span>

		<span class="n">k_direct_shift</span> <span class="o">=</span> <span class="n">Log2Int</span><span class="p">(</span><span class="n">k_direct</span><span class="p">)</span> <span class="o">-</span> <span class="n">Log2Int</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">k_btr1_rshft</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">k_direct_shift</span><span class="p">)</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">btr_gain_shift_offset</span><span class="p">;</span>
		<span class="n">k_btr1</span> <span class="o">=</span> <span class="n">k_direct</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k_direct_shift</span><span class="p">);</span>
		<span class="n">k_btr1</span> <span class="o">/=</span> <span class="mi">10000</span><span class="p">;</span>

		<span class="n">k_indirect_shift</span> <span class="o">=</span> <span class="n">Log2Int</span><span class="p">(</span><span class="n">k_indirect</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">-</span> <span class="mi">20</span> <span class="cm">/*- 2*/</span><span class="p">;</span>
		<span class="n">k_btr0_rshft</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">k_indirect_shift</span><span class="p">)</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">btr_gain_shift_offset</span><span class="p">;</span>
		<span class="n">k_btr0</span> <span class="o">=</span> <span class="n">k_indirect</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="o">-</span><span class="n">k_indirect_shift</span><span class="p">));</span>
		<span class="n">k_btr0</span> <span class="o">/=</span> <span class="mi">1000000</span><span class="p">;</span>

		<span class="n">k_btr2_rshft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k_btr0_rshft</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">k_btr2_rshft</span> <span class="o">=</span> <span class="n">k_btr0_rshft</span> <span class="o">-</span> <span class="mi">15</span><span class="p">;</span>
			<span class="n">k_btr0_rshft</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">BTR_LOOP_GAIN</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">KBTR0_RSHFT</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">k_btr0_rshft</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">KBTR0</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">k_btr0</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">KBTR1_RSHFT</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">k_btr1_rshft</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">KBTR1</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">k_btr1</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">KBTR2_RSHFT</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">k_btr2_rshft</span><span class="p">);</span>
		<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_BTR_LOOP_GAIN</span><span class="p">,</span> <span class="n">STB0899_OFF0_BTR_LOOP_GAIN</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_BTR_LOOP_GAIN</span><span class="p">,</span> <span class="n">STB0899_OFF0_BTR_LOOP_GAIN</span><span class="p">,</span> <span class="mh">0xc4c4f</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_set_carr_freq</span>
<span class="cm"> * set nominal frequency for carrier search</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_dvbs2_set_carr_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">s32</span> <span class="n">carr_freq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">master_clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">crl_nom_freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">crl_nom_freq</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">crl_nco_bits</span><span class="p">)</span> <span class="o">/</span> <span class="n">master_clk</span><span class="p">;</span>
	<span class="n">crl_nom_freq</span> <span class="o">*=</span> <span class="n">carr_freq</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CRL_NOM_FREQ</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CRL_NOM_FREQ</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">crl_nom_freq</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CRL_NOM_FREQ</span><span class="p">,</span> <span class="n">STB0899_OFF0_CRL_NOM_FREQ</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_init_calc</span>
<span class="cm"> * Initialize DVBS2 UWP, CSM, carrier and timing loops</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_dvbs2_init_calc</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">steps</span><span class="p">,</span> <span class="n">step_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">range</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* config uwp and csm */</span>
	<span class="n">stb0899_dvbs2_config_uwp</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">stb0899_dvbs2_config_csm_auto</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* initialize BTR	*/</span>
	<span class="n">stb0899_dvbs2_set_srate</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">stb0899_dvbs2_set_btr_loopbw</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">1000000</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">step_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">1000000</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">step_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">1000000</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">step_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">step_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">range</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">srch_range</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="n">steps</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">range</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">step_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">));</span>
	<span class="n">steps</span> <span class="o">=</span> <span class="p">(</span><span class="n">steps</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">steps</span> <span class="o">=</span> <span class="p">(</span><span class="n">steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">steps</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">steps</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">stb0899_dvbs2_set_carr_freq</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">center_freq</span> <span class="o">-</span>
					   <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">step_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">20000000</span><span class="p">)),</span>
					   <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">stb0899_dvbs2_set_carr_freq</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">,</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">);</span>

	<span class="cm">/*Set Carrier Search params (zigzag, num steps and freq step size*/</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">ACQ_CNTRL2</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">ZIGZAG</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">NUM_STEPS</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">steps</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FREQ_STEPSIZE</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">step_size</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_ACQ_CNTRL2</span><span class="p">,</span> <span class="n">STB0899_OFF0_ACQ_CNTRL2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_btr_init</span>
<span class="cm"> * initialize the timing loop</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_dvbs2_btr_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* set enable BTR loopback	*/</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">BTR_CNTRL</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">INTRP_PHS_SENSE</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">BTR_ERR_ENA</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_BTR_CNTRL</span><span class="p">,</span> <span class="n">STB0899_OFF0_BTR_CNTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* fix btr freq accum at 0	*/</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_BTR_FREQ_INIT</span><span class="p">,</span> <span class="n">STB0899_OFF0_BTR_FREQ_INIT</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_BTR_FREQ_INIT</span><span class="p">,</span> <span class="n">STB0899_OFF0_BTR_FREQ_INIT</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="cm">/* fix btr freq accum at 0	*/</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_BTR_PHS_INIT</span><span class="p">,</span> <span class="n">STB0899_OFF0_BTR_PHS_INIT</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_BTR_PHS_INIT</span><span class="p">,</span> <span class="n">STB0899_OFF0_BTR_PHS_INIT</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_reacquire</span>
<span class="cm"> * trigger a DVB-S2 acquisition</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_dvbs2_reacquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* demod soft reset	*/</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">DVBS2_RESET</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_RESET_CNTRL</span><span class="p">,</span> <span class="n">STB0899_OFF0_RESET_CNTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/*Reset Timing Loop	*/</span>
	<span class="n">stb0899_dvbs2_btr_init</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* reset Carrier loop	*/</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CRL_FREQ_INIT</span><span class="p">,</span> <span class="n">STB0899_OFF0_CRL_FREQ_INIT</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">));</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CRL_FREQ_INIT</span><span class="p">,</span> <span class="n">STB0899_OFF0_CRL_FREQ_INIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CRL_LOOP_GAIN</span><span class="p">,</span> <span class="n">STB0899_OFF0_CRL_LOOP_GAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CRL_PHS_INIT</span><span class="p">,</span> <span class="n">STB0899_OFF0_CRL_PHS_INIT</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">));</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CRL_PHS_INIT</span><span class="p">,</span> <span class="n">STB0899_OFF0_CRL_PHS_INIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*release demod soft reset	*/</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">DVBS2_RESET</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_RESET_CNTRL</span><span class="p">,</span> <span class="n">STB0899_OFF0_RESET_CNTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* start acquisition process	*/</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_ACQUIRE_TRIG</span><span class="p">,</span> <span class="n">STB0899_OFF0_ACQUIRE_TRIG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_LOCK_LOST</span><span class="p">,</span> <span class="n">STB0899_OFF0_LOCK_LOST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* equalizer Init	*/</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_EQUALIZER_INIT</span><span class="p">,</span> <span class="n">STB0899_OFF0_EQUALIZER_INIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*Start equilizer	*/</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_EQUALIZER_INIT</span><span class="p">,</span> <span class="n">STB0899_OFF0_EQUALIZER_INIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">EQ_CNTRL</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">EQ_SHIFT</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">EQ_DISABLE_UPDATE</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">EQ_DELAY</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">EQ_ADAPT_MODE</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_EQ_CNTRL</span><span class="p">,</span> <span class="n">STB0899_OFF0_EQ_CNTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* RESET Packet delineator	*/</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_PDELCTRL</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_get_dmd_status</span>
<span class="cm"> * get DVB-S2 Demod LOCK status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">stb0899_status</span> <span class="nf">stb0899_dvbs2_get_dmd_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uwp</span><span class="p">,</span> <span class="n">csm</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">DMD_STATUS</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;DMD_STATUS=[0x%02x]&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">IF_AGC_LOCK</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;-------------&gt;IF AGC LOCKED !&quot;</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">DMD_STAT2</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;-----------&gt;DMD STAT2=[0x%02x]&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">uwp</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">UWP_LOCK</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">csm</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">CSM_LOCK</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uwp</span> <span class="o">&amp;&amp;</span> <span class="n">csm</span><span class="p">)</span>
			<span class="n">lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">time</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;=</span> <span class="n">timeout</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;----------------&gt; DVB-S2 LOCK !&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">DVBS2_DEMOD_LOCK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">DVBS2_DEMOD_NOLOCK</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_get_data_lock</span>
<span class="cm"> * get FEC status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stb0899_dvbs2_get_data_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_CFGPDELSTATUS1</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;---------&gt; CFGPDELSTATUS=[0x%02x]&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">CFGPDELSTATUS_LOCK</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">time</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_get_fec_status</span>
<span class="cm"> * get DVB-S2 FEC LOCK status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">stb0899_status</span> <span class="nf">stb0899_dvbs2_get_fec_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Locked</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">Locked</span> <span class="o">=</span> <span class="n">stb0899_dvbs2_get_data_lock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">time</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">Locked</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Locked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;----------&gt;DVB-S2 FEC LOCK !&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">DVBS2_FEC_LOCK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">DVBS2_FEC_NOLOCK</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_init_csm</span>
<span class="cm"> * set parameters for manual mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stb0899_dvbs2_init_csm</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pilots</span><span class="p">,</span> <span class="k">enum</span> <span class="n">stb0899_modcod</span> <span class="n">modcod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>

	<span class="n">s32</span> <span class="n">dvt_tbl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">two_pass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">agc_gain</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">agc_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">loop_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phs_diff_thr</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">gamma_acq</span><span class="p">,</span> <span class="n">gamma_rho_acq</span><span class="p">,</span> <span class="n">gamma_trk</span><span class="p">,</span> <span class="n">gamma_rho_trk</span><span class="p">,</span> <span class="n">lock_count_thr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csm1</span><span class="p">,</span> <span class="n">csm2</span><span class="p">,</span> <span class="n">csm3</span><span class="p">,</span> <span class="n">csm4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">/</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">modcod</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pilots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">modcod</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STB0899_QPSK_12</span>:
			<span class="n">gamma_acq</span>		<span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
			<span class="n">gamma_rho_acq</span>		<span class="o">=</span> <span class="mi">2700</span><span class="p">;</span>
			<span class="n">gamma_trk</span>		<span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">gamma_rho_trk</span>		<span class="o">=</span> <span class="mi">180</span><span class="p">;</span>
			<span class="n">lock_count_thr</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STB0899_QPSK_35</span>:
			<span class="n">gamma_acq</span>		<span class="o">=</span> <span class="mi">38</span><span class="p">;</span>
			<span class="n">gamma_rho_acq</span>		<span class="o">=</span> <span class="mi">7182</span><span class="p">;</span>
			<span class="n">gamma_trk</span>		<span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
			<span class="n">gamma_rho_trk</span>		<span class="o">=</span> <span class="mi">308</span><span class="p">;</span>
			<span class="n">lock_count_thr</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STB0899_QPSK_23</span>:
			<span class="n">gamma_acq</span>		<span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
			<span class="n">gamma_rho_acq</span>		<span class="o">=</span> <span class="mi">9408</span><span class="p">;</span>
			<span class="n">gamma_trk</span>		<span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
			<span class="n">gamma_rho_trk</span>		<span class="o">=</span> <span class="mi">476</span><span class="p">;</span>
			<span class="n">lock_count_thr</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STB0899_QPSK_34</span>:
			<span class="n">gamma_acq</span>		<span class="o">=</span> <span class="mi">53</span><span class="p">;</span>
			<span class="n">gamma_rho_acq</span>		<span class="o">=</span> <span class="mi">16642</span><span class="p">;</span>
			<span class="n">gamma_trk</span>		<span class="o">=</span> <span class="mi">19</span><span class="p">;</span>
			<span class="n">gamma_rho_trk</span>		<span class="o">=</span> <span class="mi">646</span><span class="p">;</span>
			<span class="n">lock_count_thr</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STB0899_QPSK_45</span>:
			<span class="n">gamma_acq</span>		<span class="o">=</span> <span class="mi">53</span><span class="p">;</span>
			<span class="n">gamma_rho_acq</span>		<span class="o">=</span> <span class="mi">17119</span><span class="p">;</span>
			<span class="n">gamma_trk</span>		<span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
			<span class="n">gamma_rho_trk</span>		<span class="o">=</span> <span class="mi">880</span><span class="p">;</span>
			<span class="n">lock_count_thr</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STB0899_QPSK_56</span>:
			<span class="n">gamma_acq</span>		<span class="o">=</span> <span class="mi">55</span><span class="p">;</span>
			<span class="n">gamma_rho_acq</span>		<span class="o">=</span> <span class="mi">19250</span><span class="p">;</span>
			<span class="n">gamma_trk</span>		<span class="o">=</span> <span class="mi">23</span><span class="p">;</span>
			<span class="n">gamma_rho_trk</span>		<span class="o">=</span> <span class="mi">989</span><span class="p">;</span>
			<span class="n">lock_count_thr</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STB0899_QPSK_89</span>:
			<span class="n">gamma_acq</span>		<span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
			<span class="n">gamma_rho_acq</span>		<span class="o">=</span> <span class="mi">24240</span><span class="p">;</span>
			<span class="n">gamma_trk</span>		<span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">gamma_rho_trk</span>		<span class="o">=</span> <span class="mi">1176</span><span class="p">;</span>
			<span class="n">lock_count_thr</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STB0899_QPSK_910</span>:
			<span class="n">gamma_acq</span>		<span class="o">=</span> <span class="mi">66</span><span class="p">;</span>
			<span class="n">gamma_rho_acq</span>		<span class="o">=</span> <span class="mi">29634</span><span class="p">;</span>
			<span class="n">gamma_trk</span>		<span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">gamma_rho_trk</span>		<span class="o">=</span> <span class="mi">1176</span><span class="p">;</span>
			<span class="n">lock_count_thr</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">gamma_acq</span>		<span class="o">=</span> <span class="mi">66</span><span class="p">;</span>
			<span class="n">gamma_rho_acq</span>		<span class="o">=</span> <span class="mi">29634</span><span class="p">;</span>
			<span class="n">gamma_trk</span>		<span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">gamma_rho_trk</span>		<span class="o">=</span> <span class="mi">1176</span><span class="p">;</span>
			<span class="n">lock_count_thr</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">csm1</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CSM_CNTRL1</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_AUTO_PARAM</span><span class="p">,</span> <span class="n">csm1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CSM_CNTRL1</span><span class="p">,</span> <span class="n">STB0899_OFF0_CSM_CNTRL1</span><span class="p">,</span> <span class="n">csm1</span><span class="p">);</span>

		<span class="n">csm1</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CSM_CNTRL1</span><span class="p">);</span>
		<span class="n">csm2</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CSM_CNTRL2</span><span class="p">);</span>
		<span class="n">csm3</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CSM_CNTRL3</span><span class="p">);</span>
		<span class="n">csm4</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CSM_CNTRL4</span><span class="p">);</span>

		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_DVT_TABLE</span><span class="p">,</span> <span class="n">csm1</span><span class="p">,</span> <span class="n">dvt_tbl</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_TWO_PASS</span><span class="p">,</span> <span class="n">csm1</span><span class="p">,</span> <span class="n">two_pass</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_AGC_GAIN</span><span class="p">,</span> <span class="n">csm1</span><span class="p">,</span> <span class="n">agc_gain</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_AGC_SHIFT</span><span class="p">,</span> <span class="n">csm1</span><span class="p">,</span> <span class="n">agc_shift</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FE_LOOP_SHIFT</span><span class="p">,</span> <span class="n">csm1</span><span class="p">,</span> <span class="n">loop_shift</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_GAMMA_ACQ</span><span class="p">,</span> <span class="n">csm2</span><span class="p">,</span> <span class="n">gamma_acq</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_GAMMA_RHOACQ</span><span class="p">,</span> <span class="n">csm2</span><span class="p">,</span> <span class="n">gamma_rho_acq</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_GAMMA_TRACK</span><span class="p">,</span> <span class="n">csm3</span><span class="p">,</span> <span class="n">gamma_trk</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_GAMMA_RHOTRACK</span><span class="p">,</span> <span class="n">csm3</span><span class="p">,</span> <span class="n">gamma_rho_trk</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_LOCKCOUNT_THRESH</span><span class="p">,</span> <span class="n">csm4</span><span class="p">,</span> <span class="n">lock_count_thr</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_PHASEDIFF_THRESH</span><span class="p">,</span> <span class="n">csm4</span><span class="p">,</span> <span class="n">phs_diff_thr</span><span class="p">);</span>

		<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CSM_CNTRL1</span><span class="p">,</span> <span class="n">STB0899_OFF0_CSM_CNTRL1</span><span class="p">,</span> <span class="n">csm1</span><span class="p">);</span>
		<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CSM_CNTRL2</span><span class="p">,</span> <span class="n">STB0899_OFF0_CSM_CNTRL2</span><span class="p">,</span> <span class="n">csm2</span><span class="p">);</span>
		<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CSM_CNTRL3</span><span class="p">,</span> <span class="n">STB0899_OFF0_CSM_CNTRL3</span><span class="p">,</span> <span class="n">csm3</span><span class="p">);</span>
		<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CSM_CNTRL4</span><span class="p">,</span> <span class="n">STB0899_OFF0_CSM_CNTRL4</span><span class="p">,</span> <span class="n">csm4</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_get_srate</span>
<span class="cm"> * get DVB-S2 Symbol Rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">stb0899_dvbs2_get_srate</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stb0899_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">bTrNomFreq</span><span class="p">,</span> <span class="n">srate</span><span class="p">,</span> <span class="n">decimRate</span><span class="p">,</span> <span class="n">intval1</span><span class="p">,</span> <span class="n">intval2</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">div1</span><span class="p">,</span> <span class="n">div2</span><span class="p">,</span> <span class="n">rem1</span><span class="p">,</span> <span class="n">rem2</span><span class="p">;</span>

	<span class="n">div1</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">btr_nco_bits</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">div2</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">btr_nco_bits</span> <span class="o">-</span> <span class="n">div1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">bTrNomFreq</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">BTR_NOM_FREQ</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">DECIM_CNTRL</span><span class="p">);</span>
	<span class="n">decimRate</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">DECIM_RATE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">decimRate</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">decimRate</span><span class="p">);</span>

	<span class="n">intval1</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">div1</span><span class="p">);</span>
	<span class="n">intval2</span> <span class="o">=</span> <span class="n">bTrNomFreq</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">div2</span><span class="p">);</span>

	<span class="n">rem1</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">div1</span><span class="p">);</span>
	<span class="n">rem2</span> <span class="o">=</span> <span class="n">bTrNomFreq</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">div2</span><span class="p">);</span>
	<span class="cm">/* only for integer calculation	*/</span>
	<span class="n">srate</span> <span class="o">=</span> <span class="p">(</span><span class="n">intval1</span> <span class="o">*</span> <span class="n">intval2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">intval1</span> <span class="o">*</span> <span class="n">rem2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">div2</span><span class="p">))</span> <span class="o">+</span> <span class="p">((</span><span class="n">intval2</span> <span class="o">*</span> <span class="n">rem1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">div1</span><span class="p">));</span>
	<span class="n">srate</span> <span class="o">/=</span> <span class="n">decimRate</span><span class="p">;</span>	<span class="cm">/*symbrate = (btrnomfreq_register_val*MasterClock)/2^(27+decim_rate_field) */</span>

	<span class="k">return</span>	<span class="n">srate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stb0899_dvbs2_algo</span>
<span class="cm"> * Search for signal, timing, carrier and data for a given</span>
<span class="cm"> * frequency in a given range</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">stb0899_status</span> <span class="nf">stb0899_dvbs2_algo</span><span class="p">(</span><span class="k">struct</span> <span class="n">stb0899_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stb0899_internal</span> <span class="o">*</span><span class="n">internal</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">stb0899_modcod</span> <span class="n">modcod</span><span class="p">;</span>

	<span class="n">s32</span> <span class="n">offsetfreq</span><span class="p">,</span> <span class="n">searchTime</span><span class="p">,</span> <span class="n">FecLockTime</span><span class="p">,</span> <span class="n">pilots</span><span class="p">,</span> <span class="n">iqSpectrum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">csm1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">2000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">searchTime</span>	<span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>	<span class="cm">/* 5000 ms max time to lock UWP and CSM, SYMB &lt;= 2Mbs		*/</span>
		<span class="n">FecLockTime</span>	<span class="o">=</span> <span class="mi">350</span><span class="p">;</span>	<span class="cm">/* 350  ms max time to lock FEC, SYMB &lt;= 2Mbs			*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">5000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">searchTime</span>	<span class="o">=</span> <span class="mi">2500</span><span class="p">;</span>	<span class="cm">/* 2500 ms max time to lock UWP and CSM, 2Mbs &lt; SYMB &lt;= 5Mbs	*/</span>
		<span class="n">FecLockTime</span>	<span class="o">=</span> <span class="mi">170</span><span class="p">;</span>	<span class="cm">/* 170  ms max time to lock FEC, 2Mbs&lt; SYMB &lt;= 5Mbs		*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">10000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">searchTime</span>	<span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>	<span class="cm">/* 1500 ms max time to lock UWP and CSM, 5Mbs &lt;SYMB &lt;= 10Mbs	*/</span>
		<span class="n">FecLockTime</span>	<span class="o">=</span> <span class="mi">80</span><span class="p">;</span>	<span class="cm">/* 80  ms max time to lock FEC, 5Mbs&lt; SYMB &lt;= 10Mbs		*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">15000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">searchTime</span>	<span class="o">=</span> <span class="mi">500</span><span class="p">;</span>	<span class="cm">/* 500 ms max time to lock UWP and CSM, 10Mbs &lt;SYMB &lt;= 15Mbs	*/</span>
		<span class="n">FecLockTime</span>	<span class="o">=</span> <span class="mi">50</span><span class="p">;</span>	<span class="cm">/* 50  ms max time to lock FEC, 10Mbs&lt; SYMB &lt;= 15Mbs		*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">20000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">searchTime</span>	<span class="o">=</span> <span class="mi">300</span><span class="p">;</span>	<span class="cm">/* 300 ms max time to lock UWP and CSM, 15Mbs &lt; SYMB &lt;= 20Mbs	*/</span>
		<span class="n">FecLockTime</span>	<span class="o">=</span> <span class="mi">30</span><span class="p">;</span>	<span class="cm">/* 50  ms max time to lock FEC, 15Mbs&lt; SYMB &lt;= 20Mbs		*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">&lt;=</span> <span class="mi">25000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">searchTime</span>	<span class="o">=</span> <span class="mi">250</span><span class="p">;</span>	<span class="cm">/* 250 ms max time to lock UWP and CSM, 20 Mbs &lt; SYMB &lt;= 25Mbs	*/</span>
		<span class="n">FecLockTime</span>	<span class="o">=</span> <span class="mi">25</span><span class="p">;</span>	<span class="cm">/* 25 ms max time to lock FEC, 20Mbs&lt; SYMB &lt;= 25Mbs		*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">searchTime</span>	<span class="o">=</span> <span class="mi">150</span><span class="p">;</span>	<span class="cm">/* 150 ms max time to lock UWP and CSM, SYMB &gt; 25Mbs		*/</span>
		<span class="n">FecLockTime</span>	<span class="o">=</span> <span class="mi">20</span><span class="p">;</span>	<span class="cm">/* 20 ms max time to lock FEC, 20Mbs&lt; SYMB &lt;= 25Mbs		*/</span>
	<span class="p">}</span>

	<span class="cm">/* Maintain Stream Merger in reset during acquisition	*/</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FRESRS</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* enable tuner I/O */</span>
	<span class="n">stb0899_i2c_gate_ctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Move tuner to frequency	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_frequency</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_set_frequency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_frequency</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tuner_get_frequency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">);</span>

	<span class="cm">/* disable tuner I/O */</span>
	<span class="n">stb0899_i2c_gate_ctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set IF AGC to acquisition	*/</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">IF_AGC_CNTRL</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">IF_LOOP_GAIN</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>  <span class="mi">4</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">IF_AGC_REF</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_IF_AGC_CNTRL</span><span class="p">,</span> <span class="n">STB0899_OFF0_IF_AGC_CNTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">IF_AGC_CNTRL2</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">IF_AGC_DUMP_PER</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_IF_AGC_CNTRL2</span><span class="p">,</span> <span class="n">STB0899_OFF0_IF_AGC_CNTRL2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Initialisation	*/</span>
	<span class="n">stb0899_dvbs2_init_calc</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">DMD_CNTRL2</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IQ_SWAP_OFF</span>:
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">SPECTRUM_INVERT</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IQ_SWAP_ON</span>:
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">SPECTRUM_INVERT</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IQ_SWAP_AUTO</span>:	<span class="cm">/* use last successful search first	*/</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">SPECTRUM_INVERT</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_DMD_CNTRL2</span><span class="p">,</span> <span class="n">STB0899_OFF0_DMD_CNTRL2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">stb0899_dvbs2_reacquire</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* Wait for demod lock (UWP and CSM)	*/</span>
	<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">stb0899_dvbs2_get_dmd_status</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">searchTime</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DVBS2_DEMOD_LOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;------------&gt; DVB-S2 DEMOD LOCK !&quot;</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Demod Locked, check FEC status	*/</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">stb0899_dvbs2_get_fec_status</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FecLockTime</span><span class="p">);</span>

		<span class="cm">/*If false lock (UWP and CSM Locked but no FEC) try 3 time max*/</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DVBS2_FEC_LOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*	Read the frequency offset*/</span>
			<span class="n">offsetfreq</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CRL_FREQ</span><span class="p">);</span>

			<span class="cm">/* Set the Nominal frequency to the found frequency offset for the next reacquire*/</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CRL_NOM_FREQ</span><span class="p">);</span>
			<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CRL_NOM_FREQ</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">offsetfreq</span><span class="p">);</span>
			<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CRL_NOM_FREQ</span><span class="p">,</span> <span class="n">STB0899_OFF0_CRL_NOM_FREQ</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="n">stb0899_dvbs2_reacquire</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">stb0899_dvbs2_get_fec_status</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">searchTime</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DVBS2_FEC_LOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">==</span> <span class="n">IQ_SWAP_AUTO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">DMD_CNTRL2</span><span class="p">);</span>
			<span class="n">iqSpectrum</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">SPECTRUM_INVERT</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="cm">/* IQ Spectrum Inversion	*/</span>
			<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">SPECTRUM_INVERT</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">!</span><span class="n">iqSpectrum</span><span class="p">);</span>
			<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_DMD_CNTRL2</span><span class="p">,</span> <span class="n">STB0899_OFF0_DMD_CNTRL2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="cm">/* start acquistion process	*/</span>
			<span class="n">stb0899_dvbs2_reacquire</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

			<span class="cm">/* Wait for demod lock (UWP and CSM)	*/</span>
			<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">stb0899_dvbs2_get_dmd_status</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">searchTime</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DVBS2_DEMOD_LOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* Demod Locked, check FEC	*/</span>
				<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">stb0899_dvbs2_get_fec_status</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FecLockTime</span><span class="p">);</span>
				<span class="cm">/*try thrice for false locks, (UWP and CSM Locked but no FEC)	*/</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DVBS2_FEC_LOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/*	Read the frequency offset*/</span>
					<span class="n">offsetfreq</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CRL_FREQ</span><span class="p">);</span>

					<span class="cm">/* Set the Nominal frequency to the found frequency offset for the next reacquire*/</span>
					<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CRL_NOM_FREQ</span><span class="p">);</span>
					<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CRL_NOM_FREQ</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">offsetfreq</span><span class="p">);</span>
					<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CRL_NOM_FREQ</span><span class="p">,</span> <span class="n">STB0899_OFF0_CRL_NOM_FREQ</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

					<span class="n">stb0899_dvbs2_reacquire</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
					<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">stb0899_dvbs2_get_fec_status</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">searchTime</span><span class="p">);</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">			if (pParams-&gt;DVBS2State == FE_DVBS2_FEC_LOCKED)</span>
<span class="cm">				pParams-&gt;IQLocked = !iqSpectrum;</span>
<span class="cm">*/</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DVBS2_FEC_LOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">verbose</span><span class="p">,</span> <span class="n">FE_DEBUG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;----------------&gt; DVB-S2 FEC Lock !&quot;</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">UWP_STAT2</span><span class="p">);</span>
		<span class="n">modcod</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">UWP_DECODE_MOD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">pilots</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">UWP_DECODE_MOD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((((</span><span class="mi">10</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">410</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="n">INRANGE</span><span class="p">(</span><span class="n">STB0899_QPSK_23</span><span class="p">,</span> <span class="n">modcod</span><span class="p">,</span> <span class="n">STB0899_QPSK_910</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="n">pilots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">stb0899_dvbs2_init_csm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">pilots</span><span class="p">,</span> <span class="n">modcod</span><span class="p">);</span>
			<span class="cm">/* Wait for UWP,CSM and data LOCK 20ms max	*/</span>
			<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">stb0899_dvbs2_get_fec_status</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FecLockTime</span><span class="p">);</span>

			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DVBS2_FEC_LOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">csm1</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CSM_CNTRL1</span><span class="p">);</span>
				<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_TWO_PASS</span><span class="p">,</span> <span class="n">csm1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CSM_CNTRL1</span><span class="p">,</span> <span class="n">STB0899_OFF0_CSM_CNTRL1</span><span class="p">,</span> <span class="n">csm1</span><span class="p">);</span>
				<span class="n">csm1</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CSM_CNTRL1</span><span class="p">);</span>
				<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">CSM_TWO_PASS</span><span class="p">,</span> <span class="n">csm1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_CSM_CNTRL1</span><span class="p">,</span> <span class="n">STB0899_OFF0_CSM_CNTRL1</span><span class="p">,</span> <span class="n">csm1</span><span class="p">);</span>

				<span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">stb0899_dvbs2_get_fec_status</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FecLockTime</span><span class="p">);</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((((</span><span class="mi">10</span> <span class="o">*</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">410</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="n">INRANGE</span><span class="p">(</span><span class="n">STB0899_QPSK_12</span><span class="p">,</span> <span class="n">modcod</span><span class="p">,</span> <span class="n">STB0899_QPSK_35</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="n">pilots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* Equalizer Disable update	 */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">EQ_CNTRL</span><span class="p">);</span>
			<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">EQ_DISABLE_UPDATE</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_EQ_CNTRL</span><span class="p">,</span> <span class="n">STB0899_OFF0_EQ_CNTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* slow down the Equalizer once locked	*/</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">EQ_CNTRL</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">EQ_SHIFT</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_EQ_CNTRL</span><span class="p">,</span> <span class="n">STB0899_OFF0_EQ_CNTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* Store signal parameters	*/</span>
		<span class="n">offsetfreq</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">CRL_FREQ</span><span class="p">);</span>

		<span class="n">offsetfreq</span> <span class="o">=</span> <span class="n">offsetfreq</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">offsetfreq</span> <span class="o">*=</span> <span class="p">(</span><span class="n">internal</span><span class="o">-&gt;</span><span class="n">master_clk</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">DMD_CNTRL2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">SPECTRUM_INVERT</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
			<span class="n">offsetfreq</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">-</span> <span class="n">offsetfreq</span><span class="p">;</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">srate</span> <span class="o">=</span> <span class="n">stb0899_dvbs2_get_srate</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">UWP_STAT2</span><span class="p">);</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">modcod</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">UWP_DECODE_MOD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">pilots</span> <span class="o">=</span> <span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">UWP_DECODE_MOD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">internal</span><span class="o">-&gt;</span><span class="n">frame_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">STB0899_GETFIELD</span><span class="p">(</span><span class="n">UWP_DECODE_MOD</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

		 <span class="cm">/* Set IF AGC to tracking	*/</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">IF_AGC_CNTRL</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">IF_LOOP_GAIN</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>  <span class="mi">3</span><span class="p">);</span>

		<span class="cm">/* if QPSK 1/2,QPSK 3/5 or QPSK 2/3 set IF AGC reference to 16 otherwise 32*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INRANGE</span><span class="p">(</span><span class="n">STB0899_QPSK_12</span><span class="p">,</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">modcod</span><span class="p">,</span> <span class="n">STB0899_QPSK_23</span><span class="p">))</span>
			<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">IF_AGC_REF</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_IF_AGC_CNTRL</span><span class="p">,</span> <span class="n">STB0899_OFF0_IF_AGC_CNTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">STB0899_READ_S2REG</span><span class="p">(</span><span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">IF_AGC_CNTRL2</span><span class="p">);</span>
		<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">IF_AGC_DUMP_PER</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">stb0899_write_s2reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_S2DEMOD</span><span class="p">,</span> <span class="n">STB0899_BASE_IF_AGC_CNTRL2</span><span class="p">,</span> <span class="n">STB0899_OFF0_IF_AGC_CNTRL2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Release Stream Merger Reset		*/</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">stb0899_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">);</span>
	<span class="n">STB0899_SETFIELD_VAL</span><span class="p">(</span><span class="n">FRESRS</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stb0899_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">STB0899_TSTRES</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">internal</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
