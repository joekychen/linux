<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › nxt200x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>nxt200x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *    Support for NXT2002 and NXT2004 - VSB/QAM</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright (C) 2005 Kirk Lapray &lt;kirk.lapray@gmail.com&gt;</span>
<span class="cm"> *    Copyright (C) 2006 Michael Krufky &lt;mkrufky@m1k.net&gt;</span>
<span class="cm"> *    based on nxt2002 by Taylor Jacob &lt;rtjacob@earthlink.net&gt;</span>
<span class="cm"> *    and nxt2004 by Jean-Francois Thibert &lt;jeanfrancois@sagetv.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *    it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *    (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *    GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *    You should have received a copy of the GNU General Public License</span>
<span class="cm"> *    along with this program; if not, write to the Free Software</span>
<span class="cm"> *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm"> *                      NOTES ABOUT THIS DRIVER</span>
<span class="cm"> *</span>
<span class="cm"> * This Linux driver supports:</span>
<span class="cm"> *   B2C2/BBTI Technisat Air2PC - ATSC (NXT2002)</span>
<span class="cm"> *   AverTVHD MCE A180 (NXT2004)</span>
<span class="cm"> *   ATI HDTV Wonder (NXT2004)</span>
<span class="cm"> *</span>
<span class="cm"> * This driver needs external firmware. Please use the command</span>
<span class="cm"> * &quot;&lt;kerneldir&gt;/Documentation/dvb/get_dvb_firmware nxt2002&quot; or</span>
<span class="cm"> * &quot;&lt;kerneldir&gt;/Documentation/dvb/get_dvb_firmware nxt2004&quot; to</span>
<span class="cm"> * download/extract the appropriate firmware, and then copy it to</span>
<span class="cm"> * /usr/lib/hotplug/firmware/ or /lib/firmware/</span>
<span class="cm"> * (depending on configuration of firmware hotplug).</span>
<span class="cm"> */</span>
<span class="cp">#define NXT2002_DEFAULT_FIRMWARE &quot;dvb-fe-nxt2002.fw&quot;</span>
<span class="cp">#define NXT2004_DEFAULT_FIRMWARE &quot;dvb-fe-nxt2004.fw&quot;</span>
<span class="cp">#define CRC_CCIT_MASK 0x1021</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>

<span class="cp">#include &quot;dvb_frontend.h&quot;</span>
<span class="cp">#include &quot;nxt200x.h&quot;</span>

<span class="k">struct</span> <span class="n">nxt200x_state</span> <span class="p">{</span>

	<span class="k">struct</span> <span class="n">i2c_adapter</span><span class="o">*</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nxt200x_config</span><span class="o">*</span> <span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="n">frontend</span><span class="p">;</span>

	<span class="cm">/* demodulator private data */</span>
	<span class="n">nxt_chip_type</span> <span class="n">demod_chip</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">initialised</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="cp">#define dprintk(args...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (debug) printk(KERN_DEBUG &quot;nxt200x: &quot; args); \</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_writebytes</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">i2c_transfer</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;nxt200x: %s: i2c write error (addr 0x%02x, err == %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_readbytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">nxt200x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">i2c_transfer</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;nxt200x: %s: i2c read error (addr 0x%02x, err == %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_writebytes</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf2</span> <span class="p">[</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf2</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">};</span>

	<span class="n">buf2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">i2c_transfer</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;nxt200x: %s: i2c write error (addr 0x%02x, err == %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_readbytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">nxt200x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg2</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="p">};</span>

	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">reg2</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
			<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="p">}</span> <span class="p">};</span>

	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">i2c_transfer</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;nxt200x: %s: i2c read error (addr 0x%02x, err == %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">nxt200x_crc</span><span class="p">(</span><span class="n">u16</span> <span class="n">crc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">input</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">input</span><span class="o">&lt;&lt;=</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">crc</span><span class="o">^</span><span class="n">input</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
			<span class="n">crc</span><span class="o">=</span><span class="p">(</span><span class="n">crc</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">^</span><span class="n">CRC_CCIT_MASK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">crc</span><span class="o">&lt;&lt;=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">input</span><span class="o">&lt;&lt;=</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_writereg_multibyte</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">attr</span><span class="p">,</span> <span class="n">len2</span><span class="p">,</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* set mutli register register */</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* send the actual data */</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NXT2002</span>:
			<span class="n">len2</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NXT2004</span>:
			<span class="cm">/* probably not right, but gives correct values */</span>
			<span class="n">attr</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
					<span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* set write bit */</span>
			<span class="n">len2</span> <span class="o">=</span> <span class="p">((</span><span class="n">attr</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">|</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set multi register length */</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* toggle the multireg write bit */</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NXT2002</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NXT2004</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;nxt200x: Error writing multireg register 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_readreg_multibyte</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len2</span><span class="p">,</span> <span class="n">attr</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* set mutli register register */</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NXT2002</span>:
			<span class="cm">/* set multi register length */</span>
			<span class="n">len2</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* read the actual data */</span>
			<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NXT2004</span>:
			<span class="cm">/* probably not right, but gives correct values */</span>
			<span class="n">attr</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
					<span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* set multi register length */</span>
			<span class="n">len2</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* toggle the multireg bit*/</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* read the actual data */</span>
			<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x36</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nxt200x_microcontroller_stop</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">,</span> <span class="n">stopval</span><span class="p">,</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* set correct stop value */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NXT2002</span>:
			<span class="n">stopval</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NXT2004</span>:
			<span class="n">stopval</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">stopval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">counter</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="n">stopval</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">counter</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;nxt200x: Timeout waiting for nxt200x to stop. This is ok after firmware upload.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nxt200x_microcontroller_start</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nxt2004_microcontroller_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x23</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x45</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x67</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x89</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAB</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xCD</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xEF</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">counter</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">counter</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;nxt200x: Timeout waiting for nxt2004 to init.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_writetuner</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Tuner Bytes: %02X %02X %02X %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="cm">/* if NXT2004, write directly to tuner. if NXT2002, write through NXT chip.</span>
<span class="cm">	 * direct write is required for Philips TUV1236D and ALPS TDHU2 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NXT2004</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">i2c_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;nxt200x: error writing to tuner</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* wait until we have a lock */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">i2c_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
				<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt2004: timeout waiting for tuner lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NXT2002</span>:
			<span class="cm">/* set the i2c transfer speed to the tuner */</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* setup to transfer 4 bytes via i2c */</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* write actual tuner bytes */</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="n">data</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

			<span class="cm">/* set tuner i2c address */</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* write UC Opmode to begin transfer */</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span><span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
				<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt2002: timeout error writing tuner</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nxt200x_agc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NXT2002</span>:
			<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NXT2004</span>:
			<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt2002_load_firmware</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chunkpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rambase</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Firmware is %zu bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="cm">/* Get the RAM base for this nxt2002 */</span>
	<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">rambase</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rambase</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;rambase on this nxt2002 is %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rambase</span><span class="p">);</span>

	<span class="cm">/* Hold the micro in reset while loading firmware */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">position</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">chunkpos</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">rambase</span> <span class="o">+</span> <span class="n">position</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rambase</span> <span class="o">+</span> <span class="n">position</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>
			<span class="cm">/* write starting address */</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">written</span><span class="o">++</span><span class="p">;</span>
		<span class="n">chunkpos</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">written</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">chunkpos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">position</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">crc</span> <span class="o">=</span> <span class="n">nxt200x_crc</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">position</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">written</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">position</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* write remaining bytes of firmware */</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">chunkpos</span><span class="o">+</span><span class="mi">4</span><span class="o">-</span><span class="p">(</span><span class="n">written</span> <span class="o">%</span><span class="mi">4</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">position</span><span class="o">-</span><span class="p">(</span><span class="n">written</span> <span class="o">%</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
				<span class="n">written</span> <span class="o">%</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

			<span class="cm">/* write crc */</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

			<span class="cm">/* do a read to stop things */</span>
			<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* set transfer mode to complete */</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt2004_load_firmware</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">rambase</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">crc</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Firmware is %zu bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="cm">/* set rambase */</span>
	<span class="n">rambase</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>

	<span class="cm">/* hold the micro in reset while loading firmware */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* calculate firmware CRC */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">position</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">nxt200x_crc</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">position</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rambase</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rambase</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>
	<span class="cm">/* write starting address */</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="mh">0x29</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">position</span><span class="p">],</span>
			<span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">-</span><span class="n">position</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">-</span><span class="n">position</span><span class="p">);</span>
		<span class="n">position</span> <span class="o">+=</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">-</span><span class="n">position</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">-</span><span class="n">position</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;firmware crc is 0x%02X 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* write crc */</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* do a read to stop things */</span>
	<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* set transfer mode to complete */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_setup_frontend_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="cm">/* stop the micro first */</span>
	<span class="n">nxt200x_microcontroller_stop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span> <span class="o">==</span> <span class="n">NXT2004</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* make sure demod is set to digital */</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set additional params */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QAM_64</span>:
		<span class="k">case</span> <span class="n">QAM_256</span>:
			<span class="cm">/* Set punctured clock for QAM */</span>
			<span class="cm">/* This is just a guess since I am unable to test it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_ts_params</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_ts_params</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VSB_8</span>:
			<span class="cm">/* Set non-punctured clock for VSB */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_ts_params</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">set_ts_params</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">calc_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get tuning information */</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">calc_regs</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

		<span class="cm">/* write frequency information */</span>
		<span class="n">nxt200x_writetuner</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* reset the agc now that tuning has been completed */</span>
	<span class="n">nxt200x_agc_reset</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* set target power level */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QAM_64</span>:
		<span class="k">case</span> <span class="n">QAM_256</span>:
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x74</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VSB_8</span>:
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* configure sdm */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NXT2002</span>:
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x87</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NXT2004</span>:
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* write sdm1 input */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NXT2002</span>:
			<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NXT2004</span>:
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write sdmx input */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QAM_64</span>:
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QAM_256</span>:
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x64</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VSB_8</span>:
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NXT2002</span>:
			<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NXT2004</span>:
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write adc power lpf fc */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span> <span class="o">==</span> <span class="n">NXT2004</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* write ??? */</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* write accumulator2 input */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NXT2002</span>:
			<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NXT2004</span>:
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write kg1 */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* write sdm12 lpf fc */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* write agc control reg */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span> <span class="o">==</span> <span class="n">NXT2004</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">;</span>
		<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* soft reset? */</span>
		<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
		<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
		<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* write agc ucgp0 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QAM_64</span>:
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QAM_256</span>:
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VSB_8</span>:
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* write agc control reg */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* write accumulator2 input */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NXT2002</span>:
			<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NXT2004</span>:
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write agc control reg */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">nxt200x_microcontroller_start</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span> <span class="o">==</span> <span class="n">NXT2004</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nxt2004_microcontroller_init</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="cm">/* ???? */</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF0</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* adjacent channel detection should be done here, but I don&#39;t</span>
<span class="cm">	have any stations with this need so I cannot test it */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span><span class="o">*</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lock</span><span class="p">;</span>
	<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_SIGNAL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_CARRIER</span><span class="p">;</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_SYNC</span><span class="p">;</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u32</span><span class="o">*</span> <span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u16</span><span class="o">*</span> <span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* setup to read cluster variance */</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* get multreg val */</span>
	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xA6</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0x7FFF</span> <span class="o">-</span> <span class="n">temp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0FFF</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u16</span><span class="o">*</span> <span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">temp2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">snrdb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* setup to read cluster variance */</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* get multreg val from 0xA6 */</span>
	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xA6</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">temp2</span> <span class="o">=</span> <span class="mh">0x7FFF</span> <span class="o">-</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* snr will be in db */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp2</span> <span class="o">&gt;</span> <span class="mh">0x7F00</span><span class="p">)</span>
		<span class="n">snrdb</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">24</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="mi">30</span><span class="o">-</span><span class="mi">24</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">temp2</span> <span class="o">-</span> <span class="mh">0x7F00</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mh">0x7FFF</span> <span class="o">-</span> <span class="mh">0x7F00</span> <span class="p">)</span> <span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp2</span> <span class="o">&gt;</span> <span class="mh">0x7EC0</span><span class="p">)</span>
		<span class="n">snrdb</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">18</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="mi">18</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">temp2</span> <span class="o">-</span> <span class="mh">0x7EC0</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mh">0x7F00</span> <span class="o">-</span> <span class="mh">0x7EC0</span> <span class="p">)</span> <span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp2</span> <span class="o">&gt;</span> <span class="mh">0x7C00</span><span class="p">)</span>
		<span class="n">snrdb</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">12</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="mi">18</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">temp2</span> <span class="o">-</span> <span class="mh">0x7C00</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mh">0x7EC0</span> <span class="o">-</span> <span class="mh">0x7C00</span> <span class="p">)</span> <span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snrdb</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">0</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="mi">12</span><span class="o">-</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">temp2</span> <span class="o">-</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mh">0x7C00</span> <span class="o">-</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">);</span>

	<span class="cm">/* the value reported back from the frontend will be FFFF=32db 0000=0db */</span>
	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">snrdb</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0xFFFF</span><span class="o">/</span><span class="mi">32000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_read_ucblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u32</span><span class="o">*</span> <span class="n">ucblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ucblocks</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt2002_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* request the firmware, this will block until someone uploads it */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt2002: Waiting for firmware upload (%s)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">NXT2002_DEFAULT_FIRMWARE</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">NXT2002_DEFAULT_FIRMWARE</span><span class="p">,</span>
			       <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt2002: Waiting for firmware upload(2)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt2002: No firmware uploaded (timeout or file not found?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nxt2002_load_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt2002: Writing firmware to device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt2002: Firmware upload complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Put the micro into reset */</span>
	<span class="n">nxt200x_microcontroller_stop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* ensure transfer is complete */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Put the micro into reset for real this time */</span>
	<span class="n">nxt200x_microcontroller_stop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* soft reset everything (agc,frontend,eq,fec)*/</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* write agc sdm configure */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF1</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* write mod output format */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* write fec mpeg mode */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7E</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* write mux selection */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt2004_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* ??? */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* request the firmware, this will block until someone uploads it */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt2004: Waiting for firmware upload (%s)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">NXT2004_DEFAULT_FIRMWARE</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">NXT2004_DEFAULT_FIRMWARE</span><span class="p">,</span>
			       <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt2004: Waiting for firmware upload(2)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt2004: No firmware uploaded (timeout or file not found?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nxt2004_load_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt2004: Writing firmware to device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt2004: Firmware upload complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* ensure transfer is complete */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">nxt2004_microcontroller_init</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">nxt200x_microcontroller_stop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">nxt200x_microcontroller_stop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">nxt2004_microcontroller_init</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">nxt200x_microcontroller_stop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* soft reset everything (agc,frontend,eq,fec)*/</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* write agc sdm configure */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xD7</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* ???*/</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* ???*/</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* ???*/</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* write fec mpeg mode */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7E</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* write mux selection */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* ???*/</span>
	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* soft reset? */</span>
	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* ???*/</span>
	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x31</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5E</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x66</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">nxt2004_microcontroller_init</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7E</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* soft reset? */</span>
	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">nxt200x_readreg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
	<span class="n">nxt200x_writereg_multibyte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* initialize tuner */</span>
	<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">nxt200x_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">initialised</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">NXT2002</span>:
				<span class="n">ret</span> <span class="o">=</span> <span class="n">nxt2002_init</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">NXT2004</span>:
				<span class="n">ret</span> <span class="o">=</span> <span class="n">nxt2004_init</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">initialised</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nxt200x_get_tune_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span><span class="o">*</span> <span class="n">fesettings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fesettings</span><span class="o">-&gt;</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="n">fesettings</span><span class="o">-&gt;</span><span class="n">step_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fesettings</span><span class="o">-&gt;</span><span class="n">max_drift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nxt200x_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">nxt200x_ops</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="nf">nxt200x_attach</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nxt200x_config</span><span class="o">*</span> <span class="n">config</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">i2c_adapter</span><span class="o">*</span> <span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nxt200x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>

	<span class="cm">/* allocate memory for the internal state */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nxt200x_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* setup the state */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">initialised</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* read card id */</span>
	<span class="n">nxt200x_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NXT info: %02X %02X %02X %02X %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="cm">/* set demod chip */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span> <span class="o">=</span> <span class="n">NXT2002</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt200x: NXT2002 Detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x05</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span> <span class="o">=</span> <span class="n">NXT2004</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nxt200x: NXT2004 Detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure demod chip is supported */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NXT2002</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x04</span><span class="p">)</span> <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>		<span class="cm">/* device id */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span> <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>		<span class="cm">/* fab id */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x11</span><span class="p">)</span> <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>		<span class="cm">/* month */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>		<span class="cm">/* year msb */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>		<span class="cm">/* year lsb */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NXT2004</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x05</span><span class="p">)</span> <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>		<span class="cm">/* device id */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create dvb_frontend */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nxt200x_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown/Unsupported NXT chip: %02X %02X %02X %02X %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">nxt200x_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_ATSC</span><span class="p">,</span> <span class="n">SYS_DVBC_ANNEX_B</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Nextwave NXT200X VSB/QAM frontend&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span>  <span class="mi">54000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">860000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">=</span> <span class="mi">166666</span><span class="p">,</span>	<span class="cm">/* stepsize is just a guess */</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span>
			<span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_8VSB</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_256</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">nxt200x_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">nxt200x_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">nxt200x_sleep</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">nxt200x_setup_frontend_parameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">=</span> <span class="n">nxt200x_get_tune_settings</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">nxt200x_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">nxt200x_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">nxt200x_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">nxt200x_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">nxt200x_read_ucblocks</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Turn on/off frontend debugging (default:off).&quot;</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;NXT200X (ATSC 8VSB &amp; ITU-T J.83 AnnexB 64/256 QAM) Demodulator Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kirk Lapray, Michael Krufky, Jean-Francois Thibert, and Taylor Jacob&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nxt200x_attach</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
