<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › dvb-pll.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dvb-pll.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * descriptions + helper functions for simple dvb plls.</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 2004 Gerd Knorr &lt;kraxel@bytesex.org&gt; [SuSE Labs]</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/dvb/frontend.h&gt;</span>
<span class="cp">#include &lt;asm/types.h&gt;</span>

<span class="cp">#include &quot;dvb-pll.h&quot;</span>

<span class="k">struct</span> <span class="n">dvb_pll_priv</span> <span class="p">{</span>
	<span class="cm">/* pll number */</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>

	<span class="cm">/* i2c details */</span>
	<span class="kt">int</span> <span class="n">pll_i2c_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">;</span>

	<span class="cm">/* the PLL descriptor */</span>
	<span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="o">*</span><span class="n">pll_desc</span><span class="p">;</span>

	<span class="cm">/* cached frequency/bandwidth */</span>
	<span class="n">u32</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bandwidth</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define DVB_PLL_MAX 64</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dvb_pll_devcount</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;enable verbose debug messages&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">[</span><span class="n">DVB_PLL_MAX</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">DVB_PLL_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">DVB_PLL_UNDEFINED</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;force pll id to use (DEBUG ONLY)&quot;</span><span class="p">);</span>

<span class="cm">/* ----------------------------------------------------------- */</span>

<span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">min</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">max</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">iffreq</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">set</span><span class="p">)(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">u8</span>   <span class="o">*</span><span class="n">initdata</span><span class="p">;</span>
	<span class="n">u8</span>   <span class="o">*</span><span class="n">initdata2</span><span class="p">;</span>
	<span class="n">u8</span>   <span class="o">*</span><span class="n">sleepdata</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">limit</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">stepsize</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">config</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">cb</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">entries</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* ----------------------------------------------------------- */</span>
<span class="cm">/* descriptions                                                */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_thomson_dtt7579</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;Thomson dtt7579&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>   <span class="o">=</span> <span class="mi">177000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>   <span class="o">=</span> <span class="mi">858000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span><span class="o">=</span> <span class="mi">36166667</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleepdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">[]){</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>  <span class="mi">443250000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">542000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">771000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">999999999</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">thomson_dtt759x_bw</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bw</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bw</span> <span class="o">==</span> <span class="mi">7000000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_thomson_dtt759x</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;Thomson dtt759x&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>   <span class="o">=</span> <span class="mi">177000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>   <span class="o">=</span> <span class="mi">896000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set</span>   <span class="o">=</span> <span class="n">thomson_dtt759x_bw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span><span class="o">=</span> <span class="mi">36166667</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleepdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">[]){</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>  <span class="mi">264000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">470000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">735000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">835000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">999999999</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_lg_z201</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;LG z201&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>   <span class="o">=</span> <span class="mi">174000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>   <span class="o">=</span> <span class="mi">862000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span><span class="o">=</span> <span class="mi">36166667</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleepdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">[]){</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>  <span class="mi">157500000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">443250000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">542000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">830000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">999999999</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_unknown_1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;unknown 1&quot;</span><span class="p">,</span> <span class="cm">/* used by dntv live dvb-t */</span>
	<span class="p">.</span><span class="n">min</span>   <span class="o">=</span> <span class="mi">174000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>   <span class="o">=</span> <span class="mi">862000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span><span class="o">=</span> <span class="mi">36166667</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>  <span class="mi">150000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">173000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">250000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">400000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">420000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">470000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">600000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">730000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">999999999</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Infineon TUA6010XS</span>
<span class="cm"> * used in Thomson Cable Tuner</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_tua6010xs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;Infineon TUA6010XS&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>   <span class="o">=</span>  <span class="mi">44250000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>   <span class="o">=</span> <span class="mi">858000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span><span class="o">=</span> <span class="mi">36125000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>  <span class="mi">115750000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">403250000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x06</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">999999999</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x85</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Panasonic env57h1xd5 (some Philips PLL ?) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_env57h1xd5</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;Panasonic ENV57H1XD5&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>   <span class="o">=</span>  <span class="mi">44250000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>   <span class="o">=</span> <span class="mi">858000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span><span class="o">=</span> <span class="mi">36125000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>  <span class="mi">153000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x41</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">470000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x42</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">526000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x84</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">999999999</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xa4</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Philips TDA6650/TDA6651</span>
<span class="cm"> * used in Panasonic ENV77H11D5</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda665x_bw</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bw</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bw</span> <span class="o">==</span> <span class="mi">8000000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_tda665x</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;Philips TDA6650/TDA6651&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>   <span class="o">=</span>  <span class="mi">44250000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>   <span class="o">=</span> <span class="mi">858000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set</span>   <span class="o">=</span> <span class="n">tda665x_bw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span><span class="o">=</span> <span class="mi">36166667</span><span class="p">,</span>
	<span class="p">.</span><span class="n">initdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">[]){</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xab</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>   <span class="mi">93834000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x61</span> <span class="cm">/* 011 0 0 0  01 */</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">123834000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xa1</span> <span class="cm">/* 101 0 0 0  01 */</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">161000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xa1</span> <span class="cm">/* 101 0 0 0  01 */</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">163834000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xc2</span> <span class="cm">/* 110 0 0 0  10 */</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">253834000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x62</span> <span class="cm">/* 011 0 0 0  10 */</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">383834000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xa2</span> <span class="cm">/* 101 0 0 0  10 */</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">443834000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xc2</span> <span class="cm">/* 110 0 0 0  10 */</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">444000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xc4</span> <span class="cm">/* 110 0 0 1  00 */</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">583834000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x64</span> <span class="cm">/* 011 0 0 1  00 */</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">793834000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xa4</span> <span class="cm">/* 101 0 0 1  00 */</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">444834000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xc4</span> <span class="cm">/* 110 0 0 1  00 */</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">861000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xe4</span> <span class="cm">/* 111 0 0 1  00 */</span> <span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Infineon TUA6034</span>
<span class="cm"> * used in LG TDTP E102P</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tua6034_bw</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bw</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bw</span> <span class="o">==</span> <span class="mi">7000000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_tua6034</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;Infineon TUA6034&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>   <span class="o">=</span>  <span class="mi">44250000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>   <span class="o">=</span> <span class="mi">858000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span><span class="o">=</span> <span class="mi">36166667</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set</span>   <span class="o">=</span> <span class="n">tua6034_bw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>  <span class="mi">174500000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">230000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="mi">999999999</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* ALPS TDED4</span>
<span class="cm"> * used in Nebula-Cards and USB boxes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tded4_bw</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bw</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bw</span> <span class="o">==</span> <span class="mi">8000000</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_tded4</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ALPS TDED4&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">47000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">863000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span><span class="o">=</span> <span class="mi">36166667</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set</span>   <span class="o">=</span> <span class="n">tded4_bw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">153000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">470000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">823000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">999999999</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* ALPS TDHU2</span>
<span class="cm"> * used in AverTVHD MCE A180</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_tdhu2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ALPS TDHU2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">54000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">864000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span><span class="o">=</span> <span class="mi">44000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">162000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">426000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">782000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">999999999</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Samsung TBMV30111IN / TBMV30712IN1</span>
<span class="cm"> * used in Air2PC ATSC - 2nd generation (nxt2002)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_samsung_tbmv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Samsung TBMV30111IN / TBMV30712IN1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">54000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">860000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span><span class="o">=</span> <span class="mi">44000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">172000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">214000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">467000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">721000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">841000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">999999999</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Philips SD1878 Tuner.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_philips_sd1878_tda8261</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;Philips SD1878&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>   <span class="o">=</span>  <span class="mi">950000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>   <span class="o">=</span> <span class="mi">2150000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span><span class="o">=</span> <span class="mi">249</span><span class="p">,</span> <span class="cm">/* zero-IF, offset 249 is to round up */</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">1250000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span> <span class="mi">1450000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">},</span>
		<span class="p">{</span> <span class="mi">2050000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">},</span>
		<span class="p">{</span> <span class="mi">2150000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">opera1_bw</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_pll_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">b_w</span>  <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">*</span> <span class="mi">27</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32000</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_i2c_address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lpf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: i2c_transfer failed:%d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_w</span> <span class="o">&lt;=</span> <span class="mi">10000</span><span class="p">)</span>
		<span class="n">lpf</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b_w</span> <span class="o">&lt;=</span> <span class="mi">12000</span><span class="p">)</span>
		<span class="n">lpf</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b_w</span> <span class="o">&lt;=</span> <span class="mi">14000</span><span class="p">)</span>
		<span class="n">lpf</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b_w</span> <span class="o">&lt;=</span> <span class="mi">16000</span><span class="p">)</span>
		<span class="n">lpf</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b_w</span> <span class="o">&lt;=</span> <span class="mi">18000</span><span class="p">)</span>
		<span class="n">lpf</span> <span class="o">=</span> <span class="mh">0xe</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b_w</span> <span class="o">&lt;=</span> <span class="mi">20000</span><span class="p">)</span>
		<span class="n">lpf</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b_w</span> <span class="o">&lt;=</span> <span class="mi">22000</span><span class="p">)</span>
		<span class="n">lpf</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b_w</span> <span class="o">&lt;=</span> <span class="mi">24000</span><span class="p">)</span>
		<span class="n">lpf</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b_w</span> <span class="o">&lt;=</span> <span class="mi">26000</span><span class="p">)</span>
		<span class="n">lpf</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b_w</span> <span class="o">&lt;=</span> <span class="mi">28000</span><span class="p">)</span>
		<span class="n">lpf</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">else</span>
		<span class="n">lpf</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0x1c</span><span class="p">;</span> <span class="cm">/* Flip bits 3-5 */</span>
	<span class="cm">/* Set lpf */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">lpf</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">lpf</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_opera1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;Opera Tuner&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>   <span class="o">=</span>  <span class="mi">900000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>   <span class="o">=</span> <span class="mi">2250000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">initdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">[]){</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">initdata2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">[]){</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">iffreq</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set</span>   <span class="o">=</span> <span class="n">opera1_bw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">1064000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xc2</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1169000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xe2</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1299000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1444000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1606000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x60</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1777000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1941000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">2250000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xc0</span> <span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">samsung_dtos403ih102a_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_pll_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_i2c_address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: i2c_transfer failed:%d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x9e</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* unknown pll used in Samsung DTOS403IH102A DVB-C tuner */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_samsung_dtos403ih102a</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;Samsung DTOS403IH102A&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>    <span class="o">=</span>  <span class="mi">44250000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>    <span class="o">=</span> <span class="mi">858000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span> <span class="o">=</span>  <span class="mi">36125000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set</span>    <span class="o">=</span> <span class="n">samsung_dtos403ih102a_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">135000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">177000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">370000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">450000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">466000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">538000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">826000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">999999999</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Samsung TDTC9251DH0 DVB-T NIM, as used on AirStar 2 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_samsung_tdtc9251dh0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;Samsung TDTC9251DH0&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>	<span class="o">=</span>  <span class="mi">48000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>	<span class="o">=</span> <span class="mi">863000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span>	<span class="o">=</span>  <span class="mi">36166667</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">157500000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0x09</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">443000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">863000000</span><span class="p">,</span> <span class="mi">166667</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Samsung TBDU18132 DVB-S NIM with TSA5059 PLL, used in SkyStar2 DVB-S 2.3 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_samsung_tbdu18132</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Samsung TBDU18132&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>	<span class="o">=</span>  <span class="mi">950000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>	<span class="o">=</span> <span class="mi">2150000</span><span class="p">,</span> <span class="cm">/* guesses */</span>
	<span class="p">.</span><span class="n">iffreq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">1550000</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4095937</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">}</span>
	<span class="cm">/* TSA5059 PLL has a 17 bit divisor rather than the 15 bits supported</span>
<span class="cm">	 * by this driver.  The two extra bits are 0x60 in the third byte.  15</span>
<span class="cm">	 * bits is enough for over 4 GHz, which is enough to cover the range</span>
<span class="cm">	 * of this tuner.  We could use the additional divisor bits by adding</span>
<span class="cm">	 * more entries, e.g.</span>
<span class="cm">	 { 0x0ffff * 125 + 125/2, 125, 0x84 | 0x20, },</span>
<span class="cm">	 { 0x17fff * 125 + 125/2, 125, 0x84 | 0x40, },</span>
<span class="cm">	 { 0x1ffff * 125 + 125/2, 125, 0x84 | 0x60, }, */</span>
<span class="p">};</span>

<span class="cm">/* Samsung TBMU24112 DVB-S NIM with SL1935 zero-IF tuner */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_samsung_tbmu24112</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Samsung TBMU24112&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>	<span class="o">=</span>  <span class="mi">950000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>	<span class="o">=</span> <span class="mi">2150000</span><span class="p">,</span> <span class="cm">/* guesses */</span>
	<span class="p">.</span><span class="n">iffreq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">1500000</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x18</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">9999999</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Alps TDEE4 DVB-C NIM, used on Cablestar 2 */</span>
<span class="cm">/* byte 4 : 1  *   *   AGD R3  R2  R1  R0</span>
<span class="cm"> * byte 5 : C1 *   RE  RTS BS4 BS3 BS2 BS1</span>
<span class="cm"> * AGD = 1, R3 R2 R1 R0 = 0 1 0 1 =&gt; byte 4 = 1**10101 = 0x95</span>
<span class="cm"> * Range(MHz)  C1 *  RE RTS BS4 BS3 BS2 BS1  Byte 5</span>
<span class="cm"> *  47 - 153   0  *  0   0   0   0   0   1   0x01</span>
<span class="cm"> * 153 - 430   0  *  0   0   0   0   1   0   0x02</span>
<span class="cm"> * 430 - 822   0  *  0   0   1   0   0   0   0x08</span>
<span class="cm"> * 822 - 862   1  *  0   0   1   0   0   0   0x88 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="n">dvb_pll_alps_tdee4</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ALPS TDEE4&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min</span>	<span class="o">=</span>  <span class="mi">47000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max</span>	<span class="o">=</span> <span class="mi">862000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iffreq</span>	<span class="o">=</span>  <span class="mi">36125000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">153000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">430000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">822000000</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">999999999</span><span class="p">,</span> <span class="mi">62500</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* ----------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="o">*</span><span class="n">pll_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DVB_PLL_UNDEFINED</span><span class="p">]</span>              <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_THOMSON_DTT7579</span><span class="p">]</span>        <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_thomson_dtt7579</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_THOMSON_DTT759X</span><span class="p">]</span>        <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_thomson_dtt759x</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_LG_Z201</span><span class="p">]</span>                <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_lg_z201</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_UNKNOWN_1</span><span class="p">]</span>              <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_unknown_1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_TUA6010XS</span><span class="p">]</span>              <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_tua6010xs</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_ENV57H1XD5</span><span class="p">]</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_env57h1xd5</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_TUA6034</span><span class="p">]</span>                <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_tua6034</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_TDA665X</span><span class="p">]</span>                <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_tda665x</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_TDED4</span><span class="p">]</span>                  <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_tded4</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_TDEE4</span><span class="p">]</span>                  <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_alps_tdee4</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_TDHU2</span><span class="p">]</span>                  <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_tdhu2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_SAMSUNG_TBMV</span><span class="p">]</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_samsung_tbmv</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_PHILIPS_SD1878_TDA8261</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_philips_sd1878_tda8261</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_OPERA1</span><span class="p">]</span>                 <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_opera1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_SAMSUNG_DTOS403IH102A</span><span class="p">]</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_samsung_dtos403ih102a</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_SAMSUNG_TDTC9251DH0</span><span class="p">]</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_samsung_tdtc9251dh0</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_SAMSUNG_TBDU18132</span><span class="p">]</span>	 <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_samsung_tbdu18132</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DVB_PLL_SAMSUNG_TBMU24112</span><span class="p">]</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_pll_samsung_tbmu24112</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ----------------------------------------------------------- */</span>
<span class="cm">/* code                                                        */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_pll_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			     <span class="k">const</span> <span class="n">u32</span> <span class="n">frequency</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_pll_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">||</span> <span class="n">frequency</span> <span class="o">&gt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">limit</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pll: %s: freq=%d | i=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">frequency</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">+</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">iffreq</span> <span class="o">+</span>
	       <span class="n">desc</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stepsize</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stepsize</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pll: %s: div=%d | buf=0x%02x,0x%02x,0x%02x,0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>calculate the frequency we set it to</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="p">(</span><span class="n">div</span> <span class="o">*</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stepsize</span><span class="p">)</span> <span class="o">-</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">iffreq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_pll_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_pll_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_pll_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_desc</span><span class="o">-&gt;</span><span class="n">sleepdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_i2c_address</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_desc</span><span class="o">-&gt;</span><span class="n">sleepdata</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_desc</span><span class="o">-&gt;</span><span class="n">sleepdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">};</span>

		<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Shouldn&#39;t be called when initdata is NULL, maybe BUG()? */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_pll_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_pll_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_i2c_address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frequency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">dvb_pll_configure</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">frequency</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_pll_calc_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_pll_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frequency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">dvb_pll_configure</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">frequency</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_i2c_address</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_pll_get_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">frequency</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_pll_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="o">*</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_pll_get_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bandwidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_pll_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bandwidth</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_pll_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_pll_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_desc</span><span class="o">-&gt;</span><span class="n">initdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_i2c_address</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_desc</span><span class="o">-&gt;</span><span class="n">initdata</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_desc</span><span class="o">-&gt;</span><span class="n">initdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">};</span>

		<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_desc</span><span class="o">-&gt;</span><span class="n">initdata2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_desc</span><span class="o">-&gt;</span><span class="n">initdata2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_desc</span><span class="o">-&gt;</span><span class="n">initdata2</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Shouldn&#39;t be called when initdata is NULL, maybe BUG()? */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="n">dvb_pll_tuner_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">dvb_pll_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">dvb_pll_sleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">dvb_pll_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">dvb_pll_set_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_regs</span> <span class="o">=</span> <span class="n">dvb_pll_calc_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frequency</span> <span class="o">=</span> <span class="n">dvb_pll_get_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_bandwidth</span> <span class="o">=</span> <span class="n">dvb_pll_get_bandwidth</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">dvb_pll_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pll_addr</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pll_desc_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b1</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">pll_addr</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			       <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b1</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">dvb_pll_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_pll_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">dvb_pll_devcount</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">DVB_PLL_UNDEFINED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">dvb_pll_devcount</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pll_list</span><span class="p">)))</span>
		<span class="n">pll_desc_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">dvb_pll_devcount</span><span class="p">];</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pll_desc_id</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">pll_desc_id</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pll_list</span><span class="p">));</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">pll_list</span><span class="p">[</span><span class="n">pll_desc_id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span> <span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			     <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_pll_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_i2c_address</span> <span class="o">=</span> <span class="n">pll_addr</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pll_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">dvb_pll_devcount</span><span class="o">++</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvb_pll_tuner_ops</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_tuner_ops</span><span class="p">));</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">initdata</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">sleepdata</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">debug</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">==</span> <span class="n">pll_desc_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb-pll[%d]&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %d-%04x&quot;</span><span class="p">,</span> <span class="n">i2c_adapter_id</span><span class="p">(</span><span class="n">i2c</span><span class="p">),</span> <span class="n">pll_addr</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;: id# %d (%s) attached, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll_desc_id</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">id</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">==</span> <span class="n">pll_desc_id</span> <span class="o">?</span>
				<span class="s">&quot;insmod option&quot;</span> <span class="o">:</span> <span class="s">&quot;autodetected&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fe</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dvb_pll_attach</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;dvb pll library&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Gerd Knorr&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
