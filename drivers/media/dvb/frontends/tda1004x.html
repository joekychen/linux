<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › tda1004x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tda1004x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre>  <span class="cm">/*</span>
<span class="cm">     Driver for Philips tda1004xh OFDM Demodulator</span>

<span class="cm">     (c) 2003, 2004 Andrew de Quincey &amp; Robert Schlabbach</span>

<span class="cm">     This program is free software; you can redistribute it and/or modify</span>
<span class="cm">     it under the terms of the GNU General Public License as published by</span>
<span class="cm">     the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">     (at your option) any later version.</span>

<span class="cm">     This program is distributed in the hope that it will be useful,</span>
<span class="cm">     but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>

<span class="cm">     GNU General Public License for more details.</span>

<span class="cm">     You should have received a copy of the GNU General Public License</span>
<span class="cm">     along with this program; if not, write to the Free Software</span>
<span class="cm">     Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">   */</span>
<span class="cm">/*</span>
<span class="cm"> * This driver needs external firmware. Please use the commands</span>
<span class="cm"> * &quot;&lt;kerneldir&gt;/Documentation/dvb/get_dvb_firmware tda10045&quot;,</span>
<span class="cm"> * &quot;&lt;kerneldir&gt;/Documentation/dvb/get_dvb_firmware tda10046&quot; to</span>
<span class="cm"> * download/extract them, and then copy them to /usr/lib/hotplug/firmware</span>
<span class="cm"> * or /lib/firmware (depending on configuration of firmware hotplug).</span>
<span class="cm"> */</span>
<span class="cp">#define TDA10045_DEFAULT_FIRMWARE &quot;dvb-fe-tda10045.fw&quot;</span>
<span class="cp">#define TDA10046_DEFAULT_FIRMWARE &quot;dvb-fe-tda10046.fw&quot;</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;dvb_frontend.h&quot;</span>
<span class="cp">#include &quot;tda1004x.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="cp">#define dprintk(args...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (debug) printk(KERN_DEBUG &quot;tda1004x: &quot; args); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define TDA1004X_CHIPID		 0x00</span>
<span class="cp">#define TDA1004X_AUTO		 0x01</span>
<span class="cp">#define TDA1004X_IN_CONF1	 0x02</span>
<span class="cp">#define TDA1004X_IN_CONF2	 0x03</span>
<span class="cp">#define TDA1004X_OUT_CONF1	 0x04</span>
<span class="cp">#define TDA1004X_OUT_CONF2	 0x05</span>
<span class="cp">#define TDA1004X_STATUS_CD	 0x06</span>
<span class="cp">#define TDA1004X_CONFC4		 0x07</span>
<span class="cp">#define TDA1004X_DSSPARE2	 0x0C</span>
<span class="cp">#define TDA10045H_CODE_IN	 0x0D</span>
<span class="cp">#define TDA10045H_FWPAGE	 0x0E</span>
<span class="cp">#define TDA1004X_SCAN_CPT	 0x10</span>
<span class="cp">#define TDA1004X_DSP_CMD	 0x11</span>
<span class="cp">#define TDA1004X_DSP_ARG	 0x12</span>
<span class="cp">#define TDA1004X_DSP_DATA1	 0x13</span>
<span class="cp">#define TDA1004X_DSP_DATA2	 0x14</span>
<span class="cp">#define TDA1004X_CONFADC1	 0x15</span>
<span class="cp">#define TDA1004X_CONFC1		 0x16</span>
<span class="cp">#define TDA10045H_S_AGC		 0x1a</span>
<span class="cp">#define TDA10046H_AGC_TUN_LEVEL	 0x1a</span>
<span class="cp">#define TDA1004X_SNR		 0x1c</span>
<span class="cp">#define TDA1004X_CONF_TS1	 0x1e</span>
<span class="cp">#define TDA1004X_CONF_TS2	 0x1f</span>
<span class="cp">#define TDA1004X_CBER_RESET	 0x20</span>
<span class="cp">#define TDA1004X_CBER_MSB	 0x21</span>
<span class="cp">#define TDA1004X_CBER_LSB	 0x22</span>
<span class="cp">#define TDA1004X_CVBER_LUT	 0x23</span>
<span class="cp">#define TDA1004X_VBER_MSB	 0x24</span>
<span class="cp">#define TDA1004X_VBER_MID	 0x25</span>
<span class="cp">#define TDA1004X_VBER_LSB	 0x26</span>
<span class="cp">#define TDA1004X_UNCOR		 0x27</span>

<span class="cp">#define TDA10045H_CONFPLL_P	 0x2D</span>
<span class="cp">#define TDA10045H_CONFPLL_M_MSB	 0x2E</span>
<span class="cp">#define TDA10045H_CONFPLL_M_LSB	 0x2F</span>
<span class="cp">#define TDA10045H_CONFPLL_N	 0x30</span>

<span class="cp">#define TDA10046H_CONFPLL1	 0x2D</span>
<span class="cp">#define TDA10046H_CONFPLL2	 0x2F</span>
<span class="cp">#define TDA10046H_CONFPLL3	 0x30</span>
<span class="cp">#define TDA10046H_TIME_WREF1	 0x31</span>
<span class="cp">#define TDA10046H_TIME_WREF2	 0x32</span>
<span class="cp">#define TDA10046H_TIME_WREF3	 0x33</span>
<span class="cp">#define TDA10046H_TIME_WREF4	 0x34</span>
<span class="cp">#define TDA10046H_TIME_WREF5	 0x35</span>

<span class="cp">#define TDA10045H_UNSURW_MSB	 0x31</span>
<span class="cp">#define TDA10045H_UNSURW_LSB	 0x32</span>
<span class="cp">#define TDA10045H_WREF_MSB	 0x33</span>
<span class="cp">#define TDA10045H_WREF_MID	 0x34</span>
<span class="cp">#define TDA10045H_WREF_LSB	 0x35</span>
<span class="cp">#define TDA10045H_MUXOUT	 0x36</span>
<span class="cp">#define TDA1004X_CONFADC2	 0x37</span>

<span class="cp">#define TDA10045H_IOFFSET	 0x38</span>

<span class="cp">#define TDA10046H_CONF_TRISTATE1 0x3B</span>
<span class="cp">#define TDA10046H_CONF_TRISTATE2 0x3C</span>
<span class="cp">#define TDA10046H_CONF_POLARITY	 0x3D</span>
<span class="cp">#define TDA10046H_FREQ_OFFSET	 0x3E</span>
<span class="cp">#define TDA10046H_GPIO_OUT_SEL	 0x41</span>
<span class="cp">#define TDA10046H_GPIO_SELECT	 0x42</span>
<span class="cp">#define TDA10046H_AGC_CONF	 0x43</span>
<span class="cp">#define TDA10046H_AGC_THR	 0x44</span>
<span class="cp">#define TDA10046H_AGC_RENORM	 0x45</span>
<span class="cp">#define TDA10046H_AGC_GAINS	 0x46</span>
<span class="cp">#define TDA10046H_AGC_TUN_MIN	 0x47</span>
<span class="cp">#define TDA10046H_AGC_TUN_MAX	 0x48</span>
<span class="cp">#define TDA10046H_AGC_IF_MIN	 0x49</span>
<span class="cp">#define TDA10046H_AGC_IF_MAX	 0x4A</span>

<span class="cp">#define TDA10046H_FREQ_PHY2_MSB	 0x4D</span>
<span class="cp">#define TDA10046H_FREQ_PHY2_LSB	 0x4E</span>

<span class="cp">#define TDA10046H_CVBER_CTRL	 0x4F</span>
<span class="cp">#define TDA10046H_AGC_IF_LEVEL	 0x52</span>
<span class="cp">#define TDA10046H_CODE_CPT	 0x57</span>
<span class="cp">#define TDA10046H_CODE_IN	 0x58</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_write_byteI</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda1004x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: reg=0x%x, data=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: error reg=0x%x, data=0x%x, ret=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: success reg=0x%x, data=0x%x, ret=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda1004x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">b1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{{</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b0</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
				<span class="p">{</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b1</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">}};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: reg=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: error reg=0x%x, ret=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: success reg=0x%x, data=0x%x, ret=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">reg</span><span class="p">,</span> <span class="n">b1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">b1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_write_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda1004x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: reg=0x%x, mask=0x%x, data=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
		<span class="n">mask</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>read a byte and check</p></td><td class="code"><div class="highlight"><pre>	<span class="n">val</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>mask if off</p></td><td class="code"><div class="highlight"><pre>	<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>write it out again</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_write_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda1004x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: reg=0x%x, len=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_enable_tuner_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda1004x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_disable_tuner_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda1004x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10045h_set_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda1004x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">bandwidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">bandwidth_6mhz</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x4f</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">bandwidth_7mhz</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xdb</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">bandwidth_8mhz</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x14</span> <span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bandwidth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6000000</span>:
		<span class="n">tda1004x_write_buf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10045H_CONFPLL_P</span><span class="p">,</span> <span class="n">bandwidth_6mhz</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bandwidth_6mhz</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">7000000</span>:
		<span class="n">tda1004x_write_buf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10045H_CONFPLL_P</span><span class="p">,</span> <span class="n">bandwidth_7mhz</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bandwidth_7mhz</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8000000</span>:
		<span class="n">tda1004x_write_buf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10045H_CONFPLL_P</span><span class="p">,</span> <span class="n">bandwidth_8mhz</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bandwidth_8mhz</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10045H_IOFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10046h_set_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda1004x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">bandwidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">bandwidth_6mhz_53M</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xd2</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">bandwidth_7mhz_53M</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x9f</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">bandwidth_8mhz_53M</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x6d</span> <span class="p">};</span>

	<span class="k">static</span> <span class="n">u8</span> <span class="n">bandwidth_6mhz_48M</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x92</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">bandwidth_7mhz_48M</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xab</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">bandwidth_8mhz_48M</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xc3</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">tda10046_clk53m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_freq</span> <span class="o">==</span> <span class="n">TDA10046_FREQ_045</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_freq</span> <span class="o">==</span> <span class="n">TDA10046_FREQ_052</span><span class="p">))</span>
		<span class="n">tda10046_clk53m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tda10046_clk53m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bandwidth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6000000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tda10046_clk53m</span><span class="p">)</span>
			<span class="n">tda1004x_write_buf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_TIME_WREF1</span><span class="p">,</span> <span class="n">bandwidth_6mhz_53M</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="n">bandwidth_6mhz_53M</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">tda1004x_write_buf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_TIME_WREF1</span><span class="p">,</span> <span class="n">bandwidth_6mhz_48M</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="n">bandwidth_6mhz_48M</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_freq</span> <span class="o">==</span> <span class="n">TDA10046_FREQ_045</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_MSB</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>
			<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_LSB</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">7000000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tda10046_clk53m</span><span class="p">)</span>
			<span class="n">tda1004x_write_buf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_TIME_WREF1</span><span class="p">,</span> <span class="n">bandwidth_7mhz_53M</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="n">bandwidth_7mhz_53M</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">tda1004x_write_buf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_TIME_WREF1</span><span class="p">,</span> <span class="n">bandwidth_7mhz_48M</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="n">bandwidth_7mhz_48M</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_freq</span> <span class="o">==</span> <span class="n">TDA10046_FREQ_045</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_MSB</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
			<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_LSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8000000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tda10046_clk53m</span><span class="p">)</span>
			<span class="n">tda1004x_write_buf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_TIME_WREF1</span><span class="p">,</span> <span class="n">bandwidth_8mhz_53M</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="n">bandwidth_8mhz_53M</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">tda1004x_write_buf</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_TIME_WREF1</span><span class="p">,</span> <span class="n">bandwidth_8mhz_48M</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="n">bandwidth_8mhz_48M</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_freq</span> <span class="o">==</span> <span class="n">TDA10046_FREQ_045</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_MSB</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">);</span>
			<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_LSB</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_do_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda1004x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">dspCodeCounterReg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dspCodeInReg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">65</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">fw_msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">tx_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* clear code counter */</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dspCodeCounterReg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fw_msg</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dspCodeInReg</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>work out how much to send this time</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tx_size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">pos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_size</span> <span class="o">&gt;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">tx_size</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>send the chunk</p></td><td class="code"><div class="highlight"><pre>		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mem</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">tx_size</span><span class="p">);</span>
		<span class="n">fw_msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">tx_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tda1004x: Error during firmware upload</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">tx_size</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: fw_pos=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>give the DSP a chance to settle 03/10/05 Hac</p></td><td class="code"><div class="highlight"><pre>	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_check_upload_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda1004x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_type</span> <span class="o">==</span> <span class="n">TDA1004X_DEMOD_TDA10046</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_STATUS_CD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tda1004x: timeout waiting for DSP ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>check upload was OK</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// we want to read from the DSP</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_DSP_CMD</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">);</span>

	<span class="n">data1</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_DSP_DATA1</span><span class="p">);</span>
	<span class="n">data2</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_DSP_DATA2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data1</span> <span class="o">!=</span> <span class="mh">0x67</span> <span class="o">||</span> <span class="n">data2</span> <span class="o">&lt;</span> <span class="mh">0x20</span> <span class="o">||</span> <span class="n">data2</span> <span class="o">&gt;</span> <span class="mh">0x2e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tda1004x: found firmware revision %x -- invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data2</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tda1004x: found firmware revision %x -- ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10045_fwupload</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>

	<span class="cm">/* don&#39;t re-upload unless necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tda1004x_check_upload_ok</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* request the firmware, this will block until someone uploads it */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tda1004x: waiting for firmware upload (%s)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TDA10045_DEFAULT_FIRMWARE</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">request_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">TDA10045_DEFAULT_FIRMWARE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tda1004x: no firmware upload (timeout or file not found?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset chip */</span>
	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* set parameters */</span>
	<span class="n">tda10045h_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">8000000</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tda1004x_do_upload</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">TDA10045H_FWPAGE</span><span class="p">,</span> <span class="n">TDA10045H_CODE_IN</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tda1004x: firmware upload complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* wait for DSP to initialise */</span>
	<span class="cm">/* DSPREADY doesn&#39;t seem to work on the TDA10045H */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tda1004x_check_upload_ok</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda10046_init_plls</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tda10046_clk53m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_freq</span> <span class="o">==</span> <span class="n">TDA10046_FREQ_045</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_freq</span> <span class="o">==</span> <span class="n">TDA10046_FREQ_052</span><span class="p">))</span>
		<span class="n">tda10046_clk53m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tda10046_clk53m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONFPLL1</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tda10046_clk53m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tda1004x: setting up plls for 53MHz sampling clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONFPLL2</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span> <span class="c1">// PLL M = 8</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tda1004x: setting up plls for 48MHz sampling clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONFPLL2</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span> <span class="c1">// PLL M = 3</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">xtal_freq</span> <span class="o">==</span> <span class="n">TDA10046_XTAL_4M</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: setting up PLLs for a 4 MHz Xtal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONFPLL3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// PLL P = N = 0</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: setting up PLLs for a 16 MHz Xtal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONFPLL3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="c1">// PLL P = 0, N = 3</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tda10046_clk53m</span><span class="p">)</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_OFFSET</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_OFFSET</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">);</span>
	<span class="cm">/* Note clock frequency is handled implicitly */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">if_freq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TDA10046_FREQ_045</span>:
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_MSB</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_LSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TDA10046_FREQ_052</span>:
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_MSB</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">);</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_LSB</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TDA10046_FREQ_3617</span>:
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_MSB</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">);</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_LSB</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TDA10046_FREQ_3613</span>:
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_MSB</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">);</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_FREQ_PHY2_LSB</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tda10046h_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">8000000</span><span class="p">);</span> <span class="cm">/* default bandwidth 8 MHz */</span>
	<span class="cm">/* let the PLLs settle */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">120</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10046_fwupload</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">confc4</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>

	<span class="cm">/* reset + wake up chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">xtal_freq</span> <span class="o">==</span> <span class="n">TDA10046_XTAL_4M</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">confc4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: 16MHz Xtal, reducing I2C speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">confc4</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="n">confc4</span><span class="p">);</span>

	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONF_TRISTATE1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* set GPIO 1 and 3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">gpio_config</span> <span class="o">!=</span> <span class="n">TDA10046_GPTRI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONF_TRISTATE2</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONF_POLARITY</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">gpio_config</span> <span class="o">&amp;</span><span class="mh">0x0f</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* let the clocks recover from sleep */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* The PLLs need to be reprogrammed after sleep */</span>
	<span class="n">tda10046_init_plls</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFADC2</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* don&#39;t re-upload unless necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tda1004x_check_upload_ok</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	   For i2c normal work, we need to slow down the bus speed.</span>
<span class="cm">	   However, the slow down breaks the eeprom firmware load.</span>
<span class="cm">	   So, use normal speed for eeprom booting and then restore the</span>
<span class="cm">	   i2c speed after that. Tested with MSI TV @nyware A/D board,</span>
<span class="cm">	   that comes with firmware version 29 inside their eeprom.</span>

<span class="cm">	   It should also be noticed that no other I2C transfer should</span>
<span class="cm">	   be in course while booting from eeprom, otherwise, tda10046</span>
<span class="cm">	   goes into an instable state. So, proper locking are needed</span>
<span class="cm">	   at the i2c bus master.</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tda1004x: trying to boot from eeprom</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="n">confc4</span><span class="p">);</span>

	<span class="cm">/* Checks if eeprom firmware went without troubles */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tda1004x_check_upload_ok</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* eeprom firmware didn&#39;t work. Load one manually. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">request_firmware</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* request the firmware, this will block until someone uploads it */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tda1004x: waiting for firmware upload...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">request_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">TDA10046_DEFAULT_FIRMWARE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* remain compatible to old bug: try to load with tda10045 image name */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">request_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">TDA10045_DEFAULT_FIRMWARE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tda1004x: no firmware upload (timeout or file not found?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tda1004x: please rename the firmware file to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">TDA10046_DEFAULT_FIRMWARE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tda1004x: no request function defined, can&#39;t upload from file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span> <span class="c1">// going to boot from HOST</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">tda1004x_do_upload</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">TDA10046H_CODE_CPT</span><span class="p">,</span> <span class="n">TDA10046H_CODE_IN</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tda1004x_check_upload_ok</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_encode_fec</span><span class="p">(</span><span class="kt">int</span> <span class="n">fec</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>convert known FEC values</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">fec</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FEC_1_2</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_2_3</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_3_4</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_5_6</span>:
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_7_8</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>unsupported</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_decode_fec</span><span class="p">(</span><span class="kt">int</span> <span class="n">tdafec</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>convert known FEC values</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">tdafec</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">FEC_1_2</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">FEC_2_3</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">FEC_3_4</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="n">FEC_5_6</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">return</span> <span class="n">FEC_7_8</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>unsupported</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10045_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tda10045_fwupload</span><span class="p">(</span><span class="n">fe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tda1004x: firmware upload failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFADC1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// wake up the ADC</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>tda setup</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// disable DSP watchdog timer</span>
	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// select HP stream</span>
	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC1</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// set polarity of VAGC signal</span>
	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span> <span class="c1">// enable pulse killer</span>
	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span> <span class="c1">// enable auto offset</span>
	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF2</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span> <span class="c1">// no frequency offset</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONF_TS1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// setup MPEG2 TS interface</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONF_TS2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// setup MPEG2 TS interface</span>
	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_VBER_MSB</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span> <span class="c1">// 10^6 VBER measurement bits</span>
	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// VAGC polarity</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFADC1</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>

	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">invert_oclk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda10046_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tda10046_fwupload</span><span class="p">(</span><span class="n">fe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tda1004x: firmware upload failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>tda setup</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// disable DSP watchdog timer</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">);</span>    <span class="c1">// 100 ppm crystal, select HP stream</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC1</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>      <span class="c1">// enable pulse killer</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">agc_config</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TDA10046_AGC_DEFAULT</span>:
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_AGC_CONF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="c1">// AGC setup</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONF_POLARITY</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>  <span class="c1">// set AGC polarities</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TDA10046_AGC_IFO_AUTO_NEG</span>:
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_AGC_CONF</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span> <span class="c1">// AGC setup</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONF_POLARITY</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>  <span class="c1">// set AGC polarities</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TDA10046_AGC_IFO_AUTO_POS</span>:
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_AGC_CONF</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span> <span class="c1">// AGC setup</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONF_POLARITY</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>  <span class="c1">// set AGC polarities</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TDA10046_AGC_TDA827X</span>:
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_AGC_CONF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>   <span class="c1">// AGC setup</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_AGC_THR</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">);</span>    <span class="c1">// AGC Threshold</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_AGC_RENORM</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span> <span class="c1">// Gain Renormalize</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONF_POLARITY</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>  <span class="c1">// set AGC polarities</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ts_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONF_TRISTATE1</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">invert_oclk</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONF_TRISTATE1</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONF_POLARITY</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>
							<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">invert_oclk</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFADC2</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
	<span class="n">tda1004x_write_mask</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONF_TRISTATE1</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span> <span class="c1">// Turn IF AGC output on</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_AGC_TUN_MIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	  <span class="c1">// }</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_AGC_TUN_MAX</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span> <span class="c1">// } AGC min/max values</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_AGC_IF_MIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	  <span class="c1">// }</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_AGC_IF_MAX</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>  <span class="c1">// }</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_AGC_GAINS</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span> <span class="c1">// IF gain 2, TUN gain 1</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CVBER_CTRL</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">);</span> <span class="c1">// 10^6 VBER measurement bits</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONF_TS1</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span> <span class="c1">// MPEG2 interface config</span>
	<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONF_TS2</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span> <span class="c1">// MPEG2 interface config</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>tda1004x<em>write</em>mask(state, 0x50, 0x80, 0x80);         // handle out of guard echoes</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_set_fe</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">fe_params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inversion</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_type</span> <span class="o">==</span> <span class="n">TDA1004X_DEMOD_TDA10046</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>setup auto offset</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF2</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>disable agc_conf[2]</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_AGC_CONF</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>set frequency</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Hardcoded to use auto as much as possible on the TDA10045 as it
is very unreliable if AUTO mode is <em>not</em> used.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_type</span> <span class="o">==</span> <span class="n">TDA1004X_DEMOD_TDA10045</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_AUTO</span><span class="p">;</span>
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_AUTO</span><span class="p">;</span>
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_AUTO</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Set standard params.. or put them to auto</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">==</span> <span class="n">FEC_AUTO</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">==</span> <span class="n">FEC_AUTO</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_AUTO</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">HIERARCHY_AUTO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="c1">// enable auto</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* turn off modulation bits */</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="c1">// turn off hierarchy bits</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF2</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="c1">// turn off FEC bits</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="c1">// disable auto</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>set HP FEC</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tda1004x_encode_fec</span><span class="p">(</span><span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>set LP FEC</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tda1004x_encode_fec</span><span class="p">(</span><span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF2</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

		<span class="cm">/* set modulation */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QPSK</span>:
			<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">QAM_16</span>:
			<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">QAM_64</span>:
			<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>set hierarchy</p></td><td class="code"><div class="highlight"><pre>		<span class="k">switch</span> <span class="p">(</span><span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">hierarchy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HIERARCHY_NONE</span>:
			<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HIERARCHY_1</span>:
			<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HIERARCHY_2</span>:
			<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HIERARCHY_4</span>:
			<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>set bandwidth</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TDA1004X_DEMOD_TDA10045</span>:
		<span class="n">tda10045h_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TDA1004X_DEMOD_TDA10046</span>:
		<span class="n">tda10046h_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>set inversion</p></td><td class="code"><div class="highlight"><pre>	<span class="n">inversion</span> <span class="o">=</span> <span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">inversion</span> <span class="o">=</span> <span class="n">inversion</span> <span class="o">?</span> <span class="n">INVERSION_OFF</span> <span class="o">:</span> <span class="n">INVERSION_ON</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">inversion</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INVERSION_OFF</span>:
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC1</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">INVERSION_ON</span>:
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC1</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>set guard interval</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">guard_interval</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_32</span>:
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_16</span>:
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_8</span>:
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_4</span>:
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GUARD_INTERVAL_AUTO</span>:
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>set transmission mode</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_AUTO</span>:
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_IN_CONF1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>start the lock</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TDA1004X_DEMOD_TDA10045</span>:
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TDA1004X_DEMOD_TDA10046</span>:
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_AUTO</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_AGC_CONF</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_get_fe</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">fe_params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>inversion status</p></td><td class="code"><div class="highlight"><pre>	<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">INVERSION_OFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">INVERSION_ON</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">?</span> <span class="n">INVERSION_OFF</span> <span class="o">:</span> <span class="n">INVERSION_ON</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>bandwidth</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TDA1004X_DEMOD_TDA10045</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10045H_WREF_LSB</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x14</span>:
			<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">8000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xdb</span>:
			<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">7000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x4f</span>:
			<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TDA1004X_DEMOD_TDA10046</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_TIME_WREF1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x5c</span>:
		<span class="k">case</span> <span class="mh">0x54</span>:
			<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">8000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x6a</span>:
		<span class="k">case</span> <span class="mh">0x60</span>:
			<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">7000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x7b</span>:
		<span class="k">case</span> <span class="mh">0x70</span>:
			<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>FEC</p></td><td class="code"><div class="highlight"><pre>	<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span>
	    <span class="n">tda1004x_decode_fec</span><span class="p">(</span><span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_OUT_CONF2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span>
	    <span class="n">tda1004x_decode_fec</span><span class="p">((</span><span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_OUT_CONF2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>

	<span class="cm">/* modulation */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_OUT_CONF1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QPSK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>transmission mode</p></td><td class="code"><div class="highlight"><pre>	<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_2K</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_OUT_CONF1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_8K</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>guard interval</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">((</span><span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_OUT_CONF1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_1_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>hierarchy</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">((</span><span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_OUT_CONF1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">fe_params</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span> <span class="n">fe_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cber</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vber</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>read status</p></td><td class="code"><div class="highlight"><pre>	<span class="n">status</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_STATUS_CD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>decode</p></td><td class="code"><div class="highlight"><pre>	<span class="o">*</span><span class="n">fe_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">*</span><span class="n">fe_status</span> <span class="o">|=</span> <span class="n">FE_HAS_SIGNAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="o">*</span><span class="n">fe_status</span> <span class="o">|=</span> <span class="n">FE_HAS_CARRIER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="o">*</span><span class="n">fe_status</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span> <span class="o">|</span> <span class="n">FE_HAS_SYNC</span> <span class="o">|</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>if we don't already have VITERBI (i.e. not LOCKED), see if the viterbi
is getting anything valid</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">fe_status</span> <span class="o">&amp;</span> <span class="n">FE_HAS_VITERBI</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>read the CBER</p></td><td class="code"><div class="highlight"><pre>		<span class="n">cber</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CBER_LSB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cber</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CBER_MSB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">cber</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>The address 0x20 should be read to cope with a TDA10046 bug</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CBER_RESET</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cber</span> <span class="o">!=</span> <span class="mi">65535</span><span class="p">)</span>
			<span class="o">*</span><span class="n">fe_status</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>if we DO have some valid VITERBI output, but don't already have SYNC
bytes (i.e. not LOCKED), see if the RS decoder is getting anything valid.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">fe_status</span> <span class="o">&amp;</span> <span class="n">FE_HAS_VITERBI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">fe_status</span> <span class="o">&amp;</span> <span class="n">FE_HAS_SYNC</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>read the VBER</p></td><td class="code"><div class="highlight"><pre>		<span class="n">vber</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_VBER_LSB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vber</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_VBER_MID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">vber</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_VBER_MSB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">vber</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>The CVBER_LUT should be read to cope with TDA10046 hardware bug</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CVBER_LUT</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>if RS has passed some valid TS packets, then we must be
getting some SYNC bytes</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">vber</span> <span class="o">&lt;</span> <span class="mi">16632</span><span class="p">)</span>
			<span class="o">*</span><span class="n">fe_status</span> <span class="o">|=</span> <span class="n">FE_HAS_SYNC</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>success</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: fe_status=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">fe_status</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">signal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>determine the register to use</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TDA1004X_DEMOD_TDA10045</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">TDA10045H_S_AGC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TDA1004X_DEMOD_TDA10046</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">TDA10046H_AGC_IF_LEVEL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>read it</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="o">*</span><span class="n">signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: signal=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">signal</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>read it</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_SNR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: snr=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">snr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_read_ucblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u32</span><span class="o">*</span> <span class="n">ucblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">counter</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>read the UCBLOCKS and reset</p></td><td class="code"><div class="highlight"><pre>	<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_UNCOR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">counter</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_UNCOR</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_UNCOR</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_UNCOR</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">tmp2</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_UNCOR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">tmp2</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp2</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tmp2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="mh">0x7f</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ucblocks</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">ucblocks</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: ucblocks=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">ucblocks</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u32</span><span class="o">*</span> <span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>read it in</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CBER_LSB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CBER_MSB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ber</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>The address 0x20 should be read to cope with a TDA10046 bug</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CBER_RESET</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: ber=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">ber</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpio_conf</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TDA1004X_DEMOD_TDA10045</span>:
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFADC1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TDA1004X_DEMOD_TDA10046</span>:
		<span class="cm">/* set outputs to tristate */</span>
		<span class="n">tda1004x_write_byteI</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONF_TRISTATE1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="cm">/* invert GPIO 1 and 3 if desired*/</span>
		<span class="n">gpio_conf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">gpio_config</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_conf</span> <span class="o">&gt;=</span> <span class="n">TDA10046_GP00_I</span><span class="p">)</span>
			<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA10046H_CONF_POLARITY</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span>
							<span class="p">(</span><span class="n">gpio_conf</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x0a</span><span class="p">);</span>

		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFADC2</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
		<span class="n">tda1004x_write_mask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CONFC4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_i2c_gate_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">tda1004x_enable_tuner_i2c</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">tda1004x_disable_tuner_i2c</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda1004x_get_tune_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span><span class="o">*</span> <span class="n">fesettings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fesettings</span><span class="o">-&gt;</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
	<span class="cm">/* Drift compensation makes no sense for DVB-T */</span>
	<span class="n">fesettings</span><span class="o">-&gt;</span><span class="n">step_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fesettings</span><span class="o">-&gt;</span><span class="n">max_drift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda1004x_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">tda10045_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBT</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Philips TDA10045H DVB-T&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">51000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">858000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">=</span> <span class="mi">166667</span><span class="p">,</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span>
		    <span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span>
		    <span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
		    <span class="n">FE_CAN_QPSK</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_AUTO</span> <span class="o">|</span>
		    <span class="n">FE_CAN_TRANSMISSION_MODE_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_GUARD_INTERVAL_AUTO</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">tda1004x_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">tda10045_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">tda1004x_sleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">tda1004x_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">i2c_gate_ctrl</span> <span class="o">=</span> <span class="n">tda1004x_i2c_gate_ctrl</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">tda1004x_set_fe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend</span> <span class="o">=</span> <span class="n">tda1004x_get_fe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">=</span> <span class="n">tda1004x_get_tune_settings</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">tda1004x_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">tda1004x_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">tda1004x_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">tda1004x_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">tda1004x_read_ucblocks</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="nf">tda10045_attach</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tda1004x_config</span><span class="o">*</span> <span class="n">config</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">i2c_adapter</span><span class="o">*</span> <span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

	<span class="cm">/* allocate memory for the internal state */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda1004x_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Can&#39;t allocate memory for tda10045 state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* setup the state */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_type</span> <span class="o">=</span> <span class="n">TDA1004X_DEMOD_TDA10045</span><span class="p">;</span>

	<span class="cm">/* check if the demod is there */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CHIPID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tda10045: chip is not answering. Giving up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mh">0x25</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid tda1004x ID = 0x%02x. Can&#39;t proceed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create dvb_frontend */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tda10045_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">tda10046_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBT</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Philips TDA10046H DVB-T&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">51000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">858000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">=</span> <span class="mi">166667</span><span class="p">,</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span>
		    <span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span>
		    <span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
		    <span class="n">FE_CAN_QPSK</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_AUTO</span> <span class="o">|</span>
		    <span class="n">FE_CAN_TRANSMISSION_MODE_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_GUARD_INTERVAL_AUTO</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">tda1004x_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">tda10046_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">tda1004x_sleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">tda1004x_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">i2c_gate_ctrl</span> <span class="o">=</span> <span class="n">tda1004x_i2c_gate_ctrl</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">tda1004x_set_fe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frontend</span> <span class="o">=</span> <span class="n">tda1004x_get_fe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">=</span> <span class="n">tda1004x_get_tune_settings</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">tda1004x_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">tda1004x_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">tda1004x_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">tda1004x_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">tda1004x_read_ucblocks</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="nf">tda10046_attach</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tda1004x_config</span><span class="o">*</span> <span class="n">config</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">i2c_adapter</span><span class="o">*</span> <span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tda1004x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

	<span class="cm">/* allocate memory for the internal state */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tda1004x_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Can&#39;t allocate memory for tda10046 state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* setup the state */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">demod_type</span> <span class="o">=</span> <span class="n">TDA1004X_DEMOD_TDA10046</span><span class="p">;</span>

	<span class="cm">/* check if the demod is there */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">tda1004x_read_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">TDA1004X_CHIPID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tda10046: chip is not answering. Giving up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mh">0x46</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid tda1004x ID = 0x%02x. Can&#39;t proceed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create dvb_frontend */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tda10046_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Turn on/off frontend debugging (default:off).&quot;</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Philips TDA10045H &amp; TDA10046H DVB-T Demodulator&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andrew de Quincey &amp; Robert Schlabbach&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tda10045_attach</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tda10046_attach</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
